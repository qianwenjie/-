# 混合题型识别功能

**实现日期**: 2026-02-03
**功能状态**: ✅ 已完成

## 功能概述

支持在一次请求中生成多种题型的题目,例如:"生成单选10题、多选10题、判断5题、简答2题"。

## 核心特性

### 1. 智能识别

**支持的输入格式**:
- `数字 + 题型`: "10道单选题、5道判断题"
- `题型 + 数字`: "单选题10道、判断题5道"
- 混合格式: "单选10题、多选题5道、判断3个"

**识别规则**:
- 至少识别到2种题型才触发混合模式
- 单种题型自动降级为普通单题型生成
- 支持的题型: 单选、多选、判断、填空、简答

### 2. 对话流程

```
用户输入混合题型请求
    ↓
系统识别并显示题目清单
    ↓
询问是否有参考文档
    ↓
[有] → 上传文档 → 确认生成
[没有] → 直接确认生成
[确认] → 跳过文档直接生成
    ↓
为每种题型分别生成题目
    ↓
显示详细生成结果
```

### 3. 生成逻辑

**分题型处理**:
- 为每种题型单独筛选题库
- 随机选择指定数量的题目
- 记录每种题型的用户偏好

**结果统计**:
- 显示每种题型的生成情况
- 标记成功/失败状态
- 提示题库不足的题型

## 技术实现

### 核心方法

#### 1. extractMixedTypes(input)
**功能**: 从用户输入中提取所有题型和数量组合

**返回值**:
```javascript
{
  isMixed: true,
  types: [
    { type: 'single', typeName: '单选题', count: 10 },
    { type: 'multiple', typeName: '多选题', count: 10 },
    { type: 'judge', typeName: '判断题', count: 5 },
    { type: 'essay', typeName: '简答题', count: 2 }
  ],
  totalCount: 27,
  confidence: 1.0
}
```

#### 2. handleMixedTypeGeneration(mixedTypes)
**功能**: 处理混合题型生成请求,启动对话流程

**流程**:
1. 显示题目清单
2. 询问参考文档
3. 保存混合题型信息到任务参数

#### 3. showMixedTypeConfirmation(params)
**功能**: 显示混合题型确认信息

**内容**:
- 题目清单(每种题型的数量)
- 总计题目数
- 参考文档状态

#### 4. generateMixedTypeQuestions(params)
**功能**: 生成混合题型题目

**流程**:
1. 加载题库数据
2. 为每种题型筛选题目
3. 随机选择指定数量
4. 记录用户偏好
5. 显示生成结果

### 对话状态

新增3个对话状态:

| 状态 | 说明 | 下一步 |
|------|------|--------|
| `mixed_document` | 询问是否有参考文档 | mixed_waiting_document / mixed_confirm |
| `mixed_waiting_document` | 等待文档上传 | mixed_confirm |
| `mixed_confirm` | 确认并生成 | 生成完成 |

## 使用示例

### 示例1: 基础混合题型

**输入**:
```
生成单选10题、多选5题、判断3题
```

**系统响应**:
```
好的,我将为您生成:

1. 单选题 10道
2. 多选题 5道
3. 判断题 3道

共 18 道题目。

📄 **参考文档**(可选)

您有参考文档或教材吗?如果有,我可以基于文档内容生成更贴合的题目。

请回复:
• "有"(然后上传文档或粘贴内容)
• "没有"(直接从题库中选择)
• "确认"(直接开始生成)
```

### 示例2: 带文档的混合题型

**对话流程**:
```
用户: 帮我根据这份文档生成单选10题、多选10题、判断5题、简答2题
系统: [显示题目清单,询问文档]
用户: 有
系统: [请求上传文档]
用户: [粘贴文档内容]
系统: [显示确认信息]
用户: 确认
系统: [生成题目并显示结果]
```

### 示例3: 快速生成

**输入**:
```
单选5题、判断5题,确认
```

**系统行为**:
- 识别混合题型
- 检测到"确认"关键词
- 跳过文档询问
- 直接显示确认信息

## 错误处理

### 题库不足

**场景**: 某种题型的题库数量不足

**处理**:
- 生成该题型的所有可用题目
- 在结果中标记为警告状态
- 提示实际生成数量

**示例**:
```
✅ **生成完成**

📊 **生成结果**:
1. ✓ 成功生成10道单选题
2. ⚠ 题库中只有3道多选题
3. ✓ 成功生成5道判断题

📈 **总计**: 成功生成18/20道题目
```

### 题库为空

**场景**: 某种题型完全没有题目

**处理**:
- 跳过该题型
- 在结果中标记为失败
- 提示题库中没有该题型

### 全部失败

**场景**: 所有题型都无法生成

**处理**:
- 返回友好错误提示
- 建议用户添加题目到题库

## 用户偏好记录

**记录策略**:
- 为每种题型单独记录一次行为
- 保持原有的偏好学习机制
- 支持混合题型的统计分析

**记录内容**:
```javascript
// 为每种题型记录
{
  type: 'single',      // 题型
  count: 10,           // 数量
  difficulty: 2,       // 难度(如果指定)
  knowledgePoint: '', // 知识点(如果指定)
  timestamp: Date.now()
}
```

## 兼容性

### 向后兼容

- 单题型请求仍使用原有流程
- 不影响现有功能
- 平滑降级机制

### 与其他功能集成

- ✅ 用户偏好管理系统
- ✅ 智能推荐引擎
- ✅ 题目预览功能
- ✅ 题目导出功能

## 测试建议

### 功能测试

1. **基础混合题型**
   - 输入: "单选5题、判断5题"
   - 验证: 正确识别2种题型

2. **多种题型**
   - 输入: "单选10题、多选10题、判断5题、简答2题"
   - 验证: 正确识别4种题型

3. **不同格式**
   - 输入: "10道单选、判断题5道、3个填空"
   - 验证: 正确解析不同格式

4. **带文档生成**
   - 上传文档后生成
   - 验证: 文档信息正确传递

5. **快速确认**
   - 输入: "单选5题、判断5题,确认"
   - 验证: 跳过文档询问

### 边界测试

1. **单题型降级**
   - 输入: "单选10题"
   - 验证: 使用普通流程

2. **题库不足**
   - 清空某种题型的题库
   - 验证: 正确提示并生成其他题型

3. **题库为空**
   - 清空所有题库
   - 验证: 友好错误提示

4. **取消操作**
   - 在确认步骤回复"取消"
   - 验证: 正确重置状态

## 未来优化

### 短期优化

- [ ] 支持难度和知识点的混合指定
- [ ] 支持每种题型单独指定难度
- [ ] 优化生成结果的展示格式

### 长期优化

- [ ] 支持更复杂的题型组合规则
- [ ] 智能推荐题型组合
- [ ] 基于历史数据的题型比例建议

## 相关文档

- [Phase 2 完成报告](./phase2-completion-report.md)
- [用户偏好系统指南](./user-preference-system-guide.md)
- [AI助手使用指南](../prototypes/admin/ai-assistant.html)

---

**文档版本**: v1.0
**最后更新**: 2026-02-03
**维护者**: AI Assistant Development Team
