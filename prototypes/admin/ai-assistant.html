<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIæ™ºèƒ½åŠ©æ‰‹ - è€ƒè¯•ç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#E6F9F0', 500: '#00B96B', 600: '#00A35C' },
            success: { 50: '#E8FFEA', 500: '#00B42A' },
            warning: { 50: '#FFF7E8', 500: '#FF7D00' },
            error: { 50: '#FFECE8', 500: '#F53F3F' },
            info: { 50: '#E8F7FF', 500: '#14C9C9' }
          }
        }
      }
    }
  </script>
  <style>
    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f9fafb;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    /* ä»»åŠ¡å¡ç‰‡åŠ¨ç”» */
    .task-card {
      transition: all 0.2s ease;
    }
    .task-card:hover {
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0, 185, 107, 0.15);
    }

    /* æ¶ˆæ¯åŠ¨ç”» */
    .message-enter {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* AIæŒ‰é’®é—ªçƒåŠ¨ç”» */
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
    .ai-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    /* å‚æ•°å¡ç‰‡æµ®åŠ¨ */
    .params-card {
      position: sticky;
      top: 20px;
      z-index: 10;
    }

    /* æ¸å˜èƒŒæ™¯ */
    .gradient-bg {
      background: linear-gradient(135deg, #00B96B 0%, #14C9C9 100%);
    }

    /* å“åº”å¼è®¾è®¡ */
    /* ç§»åŠ¨ç«¯åº•éƒ¨Tabæ  */
    .mobile-tab-bar {
      display: none;
    }

    /* ç§»åŠ¨ç«¯ï¼ˆ<768pxï¼‰*/
    @media (max-width: 767px) {
      /* æ˜¾ç¤ºåº•éƒ¨Tabæ  */
      .mobile-tab-bar {
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #e5e7eb;
        z-index: 50;
        height: 60px;
      }

      /* ä¸»å†…å®¹åŒºåº•éƒ¨ç•™å‡ºTabæ ç©ºé—´ */
      .main-content {
        padding-bottom: 60px;
      }

      /* é»˜è®¤éšè—æ‰€æœ‰é¢æ¿ */
      .panel {
        display: none !important;
      }

      /* æ¿€æ´»çš„é¢æ¿æ˜¾ç¤º */
      .panel.active {
        display: flex !important;
        width: 100% !important;
      }

      /* ç§»åŠ¨ç«¯æ¶ˆæ¯è¾“å…¥åŒºè°ƒæ•´ */
      #messageInput {
        font-size: 16px; /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
      }
    }

    /* å¹³æ¿ç«¯ï¼ˆ768px-1023pxï¼‰*/
    @media (min-width: 768px) and (max-width: 1023px) {
      /* å·¦æ æŠ˜å ä¸ºä¾§è¾¹æ  */
      aside {
        position: fixed;
        left: -100%;
        top: 64px;
        bottom: 0;
        width: 280px;
        z-index: 40;
        transition: left 0.3s ease;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
      }

      aside.open {
        left: 0;
      }

      /* ä¸­æ å’Œå³æ è°ƒæ•´ */
      main {
        width: 50% !important;
      }

      section {
        width: 50% !important;
      }

      /* æ·»åŠ ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® */
      .sidebar-toggle {
        display: block;
      }
    }

    /* æ¡Œé¢ç«¯ï¼ˆ>=1024pxï¼‰*/
    @media (min-width: 1024px) {
      .sidebar-toggle {
        display: none;
      }
    }

    /* TabæŒ‰é’®æ ·å¼ */
    .tab-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #9ca3af;
      transition: all 0.2s;
      border-top: 2px solid transparent;
    }

    .tab-btn.active {
      color: #00B96B;
      border-top-color: #00B96B;
    }

    .tab-btn i {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .tab-btn span {
      font-size: 12px;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <header class="h-16 bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
    <div class="flex items-center justify-between h-full px-6">
      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-2">
          <div class="w-8 h-8 bg-primary-500 rounded flex items-center justify-center">
            <i class="fas fa-graduation-cap text-white"></i>
          </div>
          <span class="text-xl font-semibold text-gray-900">è€ƒè¯•ç³»ç»Ÿ</span>
        </div>
        <nav class="hidden md:flex items-center space-x-2 text-sm text-gray-600">
          <a href="dashboard.html" class="hover:text-primary-500">é¦–é¡µ</a>
          <i class="fas fa-chevron-right text-xs text-gray-400"></i>
          <span class="text-gray-900 font-medium">AIæ™ºèƒ½åŠ©æ‰‹</span>
        </nav>
      </div>
      <div class="flex items-center space-x-4">
        <!-- AIåŠ©æ‰‹æŒ‰é’®ï¼ˆå½“å‰é¡µé¢ï¼‰ -->
        <div class="px-4 py-2 bg-gradient-to-r from-primary-500 to-info-500 text-white rounded-lg flex items-center space-x-2">
          <i class="fas fa-robot"></i>
          <span class="text-sm font-medium">AIåŠ©æ‰‹</span>
        </div>
        <button class="px-4 py-2 text-sm text-gray-700 hover:text-primary-500 transition-colors">
          <i class="fas fa-question-circle mr-1"></i>
          å¸®åŠ©
        </button>
        <img src="https://via.placeholder.com/32" alt="ç”¨æˆ·" class="w-8 h-8 rounded-full">
        <span class="text-sm text-gray-700 font-medium">ç®¡ç†å‘˜</span>
      </div>
    </div>
  </header>

  <!-- ä¸»å†…å®¹åŒº -->
  <div class="pt-16 h-screen flex main-content">
    <!-- å·¦ä¾§ï¼šä»»åŠ¡å¡ç‰‡åˆ—è¡¨ (é»˜è®¤éšè—) -->
    <aside class="panel w-1/5 bg-white border-r border-gray-200 flex flex-col transition-all duration-300" id="taskPanel" style="margin-left: -20%; opacity: 0;">
      <!-- ä»»åŠ¡åˆ—è¡¨æ ‡é¢˜ -->
      <div class="p-4 border-b border-gray-200 flex-shrink-0">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold text-gray-900">å¯¹è¯åˆ—è¡¨</h3>
          <button id="closeTaskPanel" class="p-1 text-gray-400 hover:text-gray-600 transition-colors" title="æ”¶èµ·">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <!-- ä»»åŠ¡åˆ—è¡¨ï¼ˆå¯æ»šåŠ¨åŒºåŸŸï¼‰-->
      <div id="taskList" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-3">
        <!-- ç©ºçŠ¶æ€ -->
        <div id="emptyState" class="flex flex-col items-center justify-center h-full text-center text-gray-400">
          <i class="fas fa-inbox text-5xl mb-4"></i>
          <p class="text-sm">æš‚æ— ä»»åŠ¡</p>
          <p class="text-xs mt-2 max-w-[200px]">åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ç›´æ¥å‘Šè¯‰æˆ‘æ‚¨æƒ³åšä»€ä¹ˆ</p>
        </div>
      </div>

      <!-- åº•éƒ¨æ–°å»ºä»»åŠ¡æŒ‰é’®ï¼ˆå›ºå®šï¼‰-->
      <div class="p-4 border-t border-gray-200 bg-white flex-shrink-0">
        <button id="newTaskBtn" class="w-full px-4 py-3 gradient-bg text-white rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center space-x-2 shadow-lg">
          <i class="fas fa-plus"></i>
          <span class="font-medium">æ–°å»ºä»»åŠ¡</span>
        </button>
      </div>
    </aside>

    <!-- ä¸­é—´ï¼šå¯¹è¯åŒºåŸŸ (é»˜è®¤å æ®æ›´å¤šç©ºé—´) -->
    <main class="panel active flex-1 bg-white flex flex-col transition-all duration-300" id="chatPanel">
      <!-- å¯¹è¯æ ‡é¢˜æ  -->
      <div class="h-14 px-6 border-b border-gray-200 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <!-- å±•å¼€ä»»åŠ¡åˆ—è¡¨æŒ‰é’® -->
          <button id="toggleTaskPanel" class="p-2 text-gray-500 hover:text-primary-500 hover:bg-primary-50 rounded transition-colors" title="æ˜¾ç¤ºå¯¹è¯åˆ—è¡¨">
            <i class="fas fa-bars"></i>
          </button>
          <div>
            <h2 id="chatTitle" class="text-lg font-semibold text-gray-900">AIæ™ºèƒ½åŠ©æ‰‹</h2>
            <p id="chatSubtitle" class="text-xs text-gray-500">é€‰æ‹©ä¸€ä¸ªä»»åŠ¡å¼€å§‹å¯¹è¯</p>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <button class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded" title="æ¸…ç©ºå¯¹è¯">
            <i class="fas fa-trash-alt"></i>
          </button>
          <button class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded" title="è®¾ç½®">
            <i class="fas fa-cog"></i>
          </button>
        </div>
      </div>

      <!-- å¯¹è¯æ¶ˆæ¯åŒº -->
      <div id="messageContainer" class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-4">
        <!-- æ¬¢è¿æ¶ˆæ¯ -->
        <div class="flex items-start space-x-3">
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary-500 to-info-500 flex items-center justify-center flex-shrink-0">
            <i class="fas fa-robot text-white text-sm"></i>
          </div>
          <div class="flex-1">
            <div class="bg-gray-100 rounded-lg rounded-tl-none p-4">
              <p class="text-gray-800 text-sm leading-relaxed">æ‚¨å¥½ï¼æˆ‘æ˜¯AIæ™ºèƒ½åŠ©æ‰‹ ğŸ¤–</p>
              <p class="text-gray-800 text-sm leading-relaxed mt-2">æˆ‘å¯ä»¥å¸®æ‚¨ï¼š</p>
              <ul class="mt-2 space-y-1 text-sm text-gray-700">
                <li class="flex items-center">
                  <i class="fas fa-check text-primary-500 mr-2 text-xs"></i>
                  ç”Ÿæˆé¢˜ç›®å’Œè¯•å·
                </li>
                <li class="flex items-center">
                  <i class="fas fa-check text-primary-500 mr-2 text-xs"></i>
                  åˆ›å»ºå’Œç®¡ç†è€ƒè¯•
                </li>
                <li class="flex items-center">
                  <i class="fas fa-check text-primary-500 mr-2 text-xs"></i>
                  å‘å¸ƒåˆ·é¢˜ä»»åŠ¡
                </li>
                <li class="flex items-center">
                  <i class="fas fa-check text-primary-500 mr-2 text-xs"></i>
                  è§£ç­”æ‚¨çš„é—®é¢˜
                </li>
              </ul>
              <p class="text-gray-600 text-xs mt-3 pt-3 border-t border-gray-200">
                ğŸ’¡ ç›´æ¥å‘Šè¯‰æˆ‘æ‚¨æƒ³åšä»€ä¹ˆï¼Œæˆ‘ä¼šå°½åŠ›å¸®åŠ©æ‚¨ï¼
              </p>
            </div>
            <p class="text-xs text-gray-400 mt-1">åˆšåˆš</p>
          </div>
        </div>
      </div>

      <!-- å¿«æ·æç¤ºè¯ -->
      <div id="quickActions" class="px-6 py-3 border-t border-gray-100">
        <div class="flex items-center space-x-2 overflow-x-auto custom-scrollbar">
          <button class="quick-action px-3 py-1.5 bg-primary-50 text-primary-600 rounded-full text-sm whitespace-nowrap hover:bg-primary-100 transition-colors" data-action="generate">
            ğŸ“ ç”Ÿæˆé¢˜ç›®
          </button>
          <button class="quick-action px-3 py-1.5 bg-info-50 text-info-600 rounded-full text-sm whitespace-nowrap hover:bg-info-100 transition-colors" data-action="paper">
            ğŸ“‹ æ™ºèƒ½ç»„å·
          </button>
          <button class="quick-action px-3 py-1.5 bg-warning-50 text-warning-600 rounded-full text-sm whitespace-nowrap hover:bg-warning-100 transition-colors" data-action="exam">
            ğŸ¯ åˆ›å»ºè€ƒè¯•
          </button>
          <button class="quick-action px-3 py-1.5 bg-purple-50 text-purple-600 rounded-full text-sm whitespace-nowrap hover:bg-purple-100 transition-colors" data-action="practice">
            ğŸ’ª åˆ·é¢˜ä»»åŠ¡
          </button>
        </div>
      </div>

      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="px-6 py-4 border-t border-gray-200">
        <div class="flex items-center space-x-2 mb-3">
          <button id="uploadBtn" class="p-2 text-gray-500 hover:text-primary-500 hover:bg-primary-50 rounded transition-colors" title="ä¸Šä¼ æ–‡æ¡£">
            <i class="fas fa-paperclip"></i>
          </button>
          <button class="p-2 text-gray-500 hover:text-primary-500 hover:bg-primary-50 rounded transition-colors" title="æç¤ºè¯æ¨¡æ¿">
            <i class="fas fa-lightbulb"></i>
          </button>
          <button class="p-2 text-gray-500 hover:text-primary-500 hover:bg-primary-50 rounded transition-colors" title="å‚æ•°è®¾ç½®">
            <i class="fas fa-sliders-h"></i>
          </button>
        </div>
        <div class="flex items-end space-x-2">
          <div class="flex-1 relative">
            <textarea
              id="messageInput"
              rows="1"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
              placeholder="è¾“å…¥æ‚¨çš„éœ€æ±‚... æ”¯æŒæ‹–æ‹½æ–‡æ¡£åˆ°æ­¤å¤„ä¸Šä¼ "
            ></textarea>
          </div>
          <button id="sendBtn" class="px-6 py-3 gradient-bg text-white rounded-lg hover:opacity-90 transition-opacity flex items-center space-x-2">
            <i class="fas fa-paper-plane"></i>
            <span>å‘é€</span>
          </button>
        </div>
        <p class="text-xs text-gray-400 mt-2">æŒ‰ Enter å‘é€ï¼ŒShift + Enter æ¢è¡Œ</p>
      </div>
    </main>

    <!-- å³ä¾§ï¼šé¢„è§ˆ/ç¼–è¾‘åŒº (è‡ªé€‚åº”å®½åº¦) -->
    <section class="panel flex-1 bg-gray-50 border-l border-gray-200 flex flex-col overflow-hidden transition-all duration-300" id="previewPanel">
      <!-- é¢„è§ˆåŒºæ ‡é¢˜æ  -->
      <div class="h-14 px-6 bg-white border-b border-gray-200 flex items-center justify-between">
        <h3 id="previewTitle" class="text-lg font-semibold text-gray-900">é¢„è§ˆåŒº</h3>
        <div class="flex items-center space-x-2">
          <button class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded" title="åˆ·æ–°">
            <i class="fas fa-sync-alt"></i>
          </button>
          <button class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded" title="å…¨å±">
            <i class="fas fa-expand"></i>
          </button>
        </div>
      </div>

      <!-- é¢„è§ˆå†…å®¹åŒº -->
      <div id="previewContainer" class="flex-1 overflow-y-auto custom-scrollbar p-6">
        <!-- å‚æ•°å¡ç‰‡ï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨ï¼Œä¿ç•™ä»£ç ä»¥å¤‡åç”¨ï¼‰-->
        <div id="paramsCard" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 mb-6" style="display: none !important;">
          <div class="p-4 border-b border-gray-200">
            <h4 class="text-sm font-semibold text-gray-900 flex items-center">
              <i class="fas fa-sliders-h text-primary-500 mr-2"></i>
              ä»»åŠ¡å‚æ•°
            </h4>
          </div>
          <div class="p-4">
            <!-- å‚æ•°åˆ—è¡¨ -->
            <div id="paramsList" class="space-y-3">
              <!-- åŠ¨æ€ç”Ÿæˆå‚æ•°é¡¹ -->
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div class="mt-4 pt-4 border-t border-gray-200">
              <div class="flex items-center justify-between text-xs text-gray-600 mb-2">
                <span>å‚æ•°å®Œæ•´åº¦</span>
                <span id="paramsProgress" class="font-medium">0%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="paramsProgressBar" class="bg-primary-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div id="previewEmpty" class="flex flex-col items-center justify-center h-full text-center text-gray-400">
          <i class="fas fa-eye-slash text-6xl mb-4"></i>
          <p class="text-sm">ç­‰å¾…AIç”Ÿæˆå†…å®¹...</p>
          <p class="text-xs mt-2 max-w-xs">ç”Ÿæˆçš„é¢˜ç›®ã€è¯•å·ç­‰å†…å®¹å°†åœ¨è¿™é‡Œå®æ—¶æ˜¾ç¤º</p>
        </div>
      </div>
    </section>
  </div>

  <!-- ç§»åŠ¨ç«¯åº•éƒ¨Tabæ  -->
  <nav class="mobile-tab-bar">
    <button class="tab-btn active" data-panel="chatPanel">
      <i class="fas fa-comments"></i>
      <span>å¯¹è¯</span>
    </button>
    <button class="tab-btn" data-panel="previewPanel">
      <i class="fas fa-eye"></i>
      <span>é¢„è§ˆ</span>
    </button>
    <button class="tab-btn" data-panel="taskPanel">
      <i class="fas fa-list"></i>
      <span>ä»»åŠ¡</span>
    </button>
  </nav>

  <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ input -->
  <input type="file" id="fileInput" accept=".doc,.docx,.pdf,.txt,.jpg,.png" class="hidden">

  <script>
    // ========== å…¨å±€å˜é‡ ==========
    const STORAGE_VERSION = '1.0';
    let currentTask = null;
    let tasks = [];
    let messages = [];

    // é¢˜åº“æ•°æ®ç¼“å­˜
    let questionsCache = null;
    let knowledgeTreeCache = null;

    // ========== å¸¸é‡å®šä¹‰ ==========

    // ä»»åŠ¡ç±»å‹ï¼ˆç®€åŒ–ä¸ºé€šç”¨å¯¹è¯ï¼‰
    const TASK_TYPES = {
      CONVERSATION: {
        id: 'conversation',
        name: 'æ–°å¯¹è¯',
        icon: 'ğŸ’¬',
        color: 'primary',
        description: 'é€šç”¨å¯¹è¯ä»»åŠ¡'
      }
    };

    // ä»»åŠ¡çŠ¶æ€ï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨çŠ¶æ€ç®¡ç†ï¼‰
    // const TASK_STATUS = { ... }

    // æ¶ˆæ¯ç±»å‹
    const MESSAGE_TYPES = {
      TEXT: 'text',               // æ–‡æœ¬æ¶ˆæ¯
      OPTIONS: 'options',         // é€‰é¡¹æ¶ˆæ¯
      CONFIRM: 'confirm',         // ç¡®è®¤æ¶ˆæ¯
      PROGRESS: 'progress'        // è¿›åº¦æ¶ˆæ¯
    };

    // ========== è¾…åŠ©å‡½æ•° ==========

    // åˆ›å»ºä»»åŠ¡æ¨¡æ¿
    function createTaskTemplate(taskType) {
      const type = Object.values(TASK_TYPES).find(t => t.id === taskType);
      if (!type) return null;

      const now = new Date();
      const taskId = `task_${now.getTime()}`;

      return {
        id: taskId,
        title: type.name,
        type: taskType,
        // status: TASK_STATUS.PENDING, // ChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨çŠ¶æ€
        createTime: now.toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        }),
        updateTime: now.toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        }),
        params: {},
        messages: [],
        progress: null,
        results: []
      };
    }

    // è·å–ä»»åŠ¡ç±»å‹ä¿¡æ¯
    function getTaskTypeInfo(taskType) {
      return Object.values(TASK_TYPES).find(t => t.id === taskType);
    }

    // è·å–çŠ¶æ€å›¾æ ‡ï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨ï¼‰
    // function getStatusIcon(status) { ... }

    // è·å–çŠ¶æ€é¢œè‰²ï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨ï¼‰
    // function getStatusColor(status) { ... }

    // ========== æ ‡é¢˜ç”Ÿæˆ ==========

    // ä»ç”¨æˆ·ç¬¬ä¸€å¥è¯ç”Ÿæˆä»»åŠ¡æ ‡é¢˜
    function generateTaskTitle(firstMessage) {
      // ç®€å•æˆªå–å‰20ä¸ªå­—ç¬¦ä½œä¸ºæ ‡é¢˜
      let title = firstMessage.trim();

      // å¦‚æœå¤ªé•¿ï¼Œæˆªå–å¹¶æ·»åŠ çœç•¥å·
      if (title.length > 20) {
        title = title.substring(0, 20) + '...';
      }

      return title || 'æ–°å¯¹è¯';
    }

    // ============================================
    // æ™ºèƒ½å‚æ•°æå–å™¨
    // ============================================
    class SmartParamExtractor {
      constructor() {
        this.synonyms = {
          type: {
            'single': ['å•é€‰', 'å•é€‰é¢˜', 'é€‰æ‹©é¢˜', 'å•é¡¹é€‰æ‹©', 'å•é€‰é¢˜ç›®'],
            'multiple': ['å¤šé€‰', 'å¤šé€‰é¢˜', 'å¤šé¡¹é€‰æ‹©', 'å¤šé€‰é¢˜ç›®'],
            'judge': ['åˆ¤æ–­', 'åˆ¤æ–­é¢˜', 'å¯¹é”™é¢˜', 'æ˜¯éé¢˜'],
            'fill': ['å¡«ç©º', 'å¡«ç©ºé¢˜', 'å¡«å†™é¢˜'],
            'essay': ['ç®€ç­”', 'ç®€ç­”é¢˜', 'é—®ç­”é¢˜', 'ä¸»è§‚é¢˜'],
            'all': ['æ‰€æœ‰', 'å…¨éƒ¨', 'æ‰€æœ‰é¢˜å‹', 'å…¨éƒ¨é¢˜å‹', 'æ··åˆ', 'éšæœºé¢˜å‹', 'å„ç§é¢˜å‹', 'ä»»æ„é¢˜å‹']
          },
          quantity: {
            'å¤š': ['å¤šç‚¹', 'å¤šæ¥ç‚¹', 'å¤šä¸€äº›', 'å¤šå‡ é“', 'å¤šä¸ª'],
            'å°‘': ['å°‘ç‚¹', 'å°‘æ¥ç‚¹', 'å‡ é“', 'å°‘ä¸€äº›', 'å°‘ä¸ª']
          },
          difficulty: {
            '1': ['ç®€å•', 'å®¹æ˜“', 'åŸºç¡€', 'å…¥é—¨', 'åˆçº§', 'ä¸€çº§'],
            '2': ['ä¸­ç­‰', 'ä¸­çº§', 'æ™®é€š', 'äºŒçº§'],
            '3': ['å›°éš¾', 'éš¾', 'é«˜çº§', 'ä¸‰çº§'],
            '4': ['å¾ˆéš¾', 'è¶…éš¾', 'å››çº§'],
            '5': ['æéš¾', 'æœ€éš¾', 'äº”çº§']
          }
        };
        this.patterns = {
          'æ¥ç‚¹': { action: 'generate', quantity: 'default', confidence: 0.7 },
          'éšä¾¿': { confidence: 0.3, needConfirm: true },
          'å’Œä¸Šæ¬¡ä¸€æ ·': { useHistory: true, confidence: 0.9 },
          'æŒ‰ä¹ æƒ¯æ¥': { usePreference: true, confidence: 0.8 }
        };
      }

      // æå–é¢˜å‹
      extractType(input) {
        const lowerInput = input.toLowerCase();

        // éå†æ‰€æœ‰é¢˜å‹åŠå…¶åŒä¹‰è¯
        for (const [typeKey, synonymList] of Object.entries(this.synonyms.type)) {
          for (const synonym of synonymList) {
            if (lowerInput.includes(synonym)) {
              // è·å–é¢˜å‹ä¸­æ–‡å
              const typeNames = {
                'single': 'å•é€‰é¢˜',
                'multiple': 'å¤šé€‰é¢˜',
                'judge': 'åˆ¤æ–­é¢˜',
                'fill': 'å¡«ç©ºé¢˜',
                'essay': 'ç®€ç­”é¢˜',
                'all': 'æ‰€æœ‰é¢˜å‹'
              };

              return {
                value: typeKey,
                name: typeNames[typeKey],
                confidence: 1.0  // ç²¾ç¡®åŒ¹é…ï¼Œé«˜ç½®ä¿¡åº¦
              };
            }
          }
        }

        return null;
      }

      // æå–æ•°é‡
      extractCount(input) {
        // 1. ç²¾ç¡®æ•°å­—åŒ¹é…ï¼ˆå¦‚"10é“"ã€"5ä¸ª"ã€"20é¢˜"ï¼‰
        const exactMatch = input.match(/(\d+)\s*[é“ä¸ªé¢˜]/);
        if (exactMatch) {
          return {
            value: parseInt(exactMatch[1]),
            confidence: 1.0  // ç²¾ç¡®åŒ¹é…
          };
        }

        // 2. çº¯æ•°å­—åŒ¹é…ï¼ˆå¦‚"10"ã€"5"ï¼‰
        const numberMatch = input.match(/\b(\d+)\b/);
        if (numberMatch) {
          const num = parseInt(numberMatch[1]);
          // åˆç†èŒƒå›´å†…çš„æ•°å­—ï¼ˆ1-100ï¼‰
          if (num >= 1 && num <= 100) {
            return {
              value: num,
              confidence: 0.8  // æ¨æ–­ï¼Œä¸­é«˜ç½®ä¿¡åº¦
            };
          }
        }

        // 3. æ¨¡ç³Šè¡¨è¾¾ï¼ˆ"å¤šç‚¹"ã€"å°‘ç‚¹"ï¼‰
        const lowerInput = input.toLowerCase();
        if (this.synonyms.quantity['å¤š'].some(syn => lowerInput.includes(syn))) {
          return {
            value: 15,  // é»˜è®¤"å¤š"ä¸º15é“
            confidence: 0.5  // æ¨¡ç³Šè¡¨è¾¾ï¼Œä¸­ç½®ä¿¡åº¦
          };
        }
        if (this.synonyms.quantity['å°‘'].some(syn => lowerInput.includes(syn))) {
          return {
            value: 5,  // é»˜è®¤"å°‘"ä¸º5é“
            confidence: 0.5
          };
        }

        return null;
      }

      // æå–éš¾åº¦
      extractDifficulty(input) {
        const lowerInput = input.toLowerCase();

        // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœåŒ…å«"ä¸­ç­‰"ï¼Œç›´æ¥è¿”å›ä¸­ç­‰éš¾åº¦
        if (lowerInput.includes('ä¸­ç­‰') || lowerInput.includes('ä¸­çº§') || lowerInput.includes('æ™®é€š')) {
          return {
            value: 2,
            name: 'ä¸­ç­‰',
            confidence: 1.0
          };
        }

        // æŒ‰éš¾åº¦ç­‰çº§ä»é«˜åˆ°ä½éå†ï¼Œä¼˜å…ˆåŒ¹é…æ›´å…·ä½“çš„è¡¨è¾¾
        const difficultyLevels = ['5', '4', '3', '1'];  // è·³è¿‡2ï¼Œå› ä¸ºå·²ç»ç‰¹æ®Šå¤„ç†

        for (const diffKey of difficultyLevels) {
          const synonymList = this.synonyms.difficulty[diffKey];
          // æŒ‰åŒä¹‰è¯é•¿åº¦ä»é•¿åˆ°çŸ­æ’åºï¼Œä¼˜å…ˆåŒ¹é…æ›´é•¿çš„è¯
          const sortedSynonyms = [...synonymList].sort((a, b) => b.length - a.length);

          for (const synonym of sortedSynonyms) {
            if (lowerInput.includes(synonym)) {
              const diffNames = {
                '1': 'ç®€å•',
                '2': 'ä¸­ç­‰',
                '3': 'å›°éš¾',
                '4': 'å¾ˆéš¾',
                '5': 'æéš¾'
              };

              return {
                value: parseInt(diffKey),
                name: diffNames[diffKey],
                confidence: 1.0
              };
            }
          }
        }

        return null;
      }

      // æå–çŸ¥è¯†ç‚¹
      extractKnowledgePoint(input) {
        // åŒ¹é…"å…³äºXXçš„"ã€"XXç›¸å…³"ã€"XXçŸ¥è¯†ç‚¹"ç­‰æ¨¡å¼
        const patterns = [
          /å…³äº["\""]?([^"\""\\sï¼Œã€‚ï¼ï¼Ÿ]{2,10})["\""]?çš„/,
          /([^ï¼Œã€‚ï¼ï¼Ÿ\\s]{2,10})ç›¸å…³/,
          /([^ï¼Œã€‚ï¼ï¼Ÿ\\s]{2,10})çŸ¥è¯†ç‚¹/,
          /([^ï¼Œã€‚ï¼ï¼Ÿ\\s]{2,10})æ–¹é¢/
        ];

        for (const pattern of patterns) {
          const match = input.match(pattern);
          if (match) {
            return {
              value: match[1],
              confidence: 0.9  // æ¨¡å¼åŒ¹é…ï¼Œé«˜ç½®ä¿¡åº¦
            };
          }
        }

        return null;
      }

      // åŒ¹é…å£è¯­åŒ–æ¨¡å¼
      matchPatterns(input) {
        const lowerInput = input.toLowerCase();
        const result = {
          params: {},
          ambiguous: []
        };

        for (const [pattern, config] of Object.entries(this.patterns)) {
          if (lowerInput.includes(pattern)) {
            // å¦‚æœæ˜¯"æ¥ç‚¹"ï¼Œè®¾ç½®é»˜è®¤æ•°é‡
            if (pattern === 'æ¥ç‚¹' && !result.params.count) {
              result.params.count = 10;
              result.params._countSource = 'pattern';
            }

            // å¦‚æœæ˜¯"éšä¾¿"ï¼Œæ ‡è®°ä¸ºéœ€è¦ç¡®è®¤
            if (pattern === 'éšä¾¿') {
              result.ambiguous.push('ç”¨æˆ·è¡¨è¾¾æ¨¡ç³Šï¼Œå»ºè®®ç¡®è®¤');
            }

            // å¦‚æœæ˜¯"å’Œä¸Šæ¬¡ä¸€æ ·"æˆ–"æŒ‰ä¹ æƒ¯æ¥"ï¼Œæ ‡è®°ä½¿ç”¨å†å²/åå¥½
            if (config.useHistory) {
              result.params._useHistory = true;
            }
            if (config.usePreference) {
              result.params._usePreference = true;
            }
          }
        }

        return result;
      }

      // ä¸»æå–æ–¹æ³•
      extract(input, context = {}) {
        const params = {};
        const confidence = {};
        const ambiguous = [];

        // 1. é¢˜å‹è¯†åˆ«
        const typeResult = this.extractType(input);
        if (typeResult) {
          params.type = typeResult.value;
          params.typeName = typeResult.name;
          confidence.type = typeResult.confidence;
        }

        // 2. æ•°é‡è¯†åˆ«
        const countResult = this.extractCount(input);
        if (countResult) {
          params.count = countResult.value;
          confidence.count = countResult.confidence;
        }

        // 3. éš¾åº¦è¯†åˆ«
        const diffResult = this.extractDifficulty(input);
        if (diffResult) {
          params.difficulty = diffResult.value;
          params.difficultyName = diffResult.name;
          confidence.difficulty = diffResult.confidence;
        }

        // 4. çŸ¥è¯†ç‚¹è¯†åˆ«
        const kpResult = this.extractKnowledgePoint(input);
        if (kpResult) {
          params.knowledgePoint = kpResult.value;
          confidence.knowledgePoint = kpResult.confidence;
        }

        // 5. ç‰¹æ®Šæ¨¡å¼è¯†åˆ«
        const patternResult = this.matchPatterns(input);
        if (patternResult) {
          Object.assign(params, patternResult.params);
          ambiguous.push(...patternResult.ambiguous);
        }

        return { params, confidence, ambiguous };
      }
    }

    // ============================================
    // ç”¨æˆ·åå¥½ç®¡ç†å™¨
    // ============================================
    class UserPreferenceManager {
      constructor() {
        this.storageKey = 'ai_assistant_user_preferences';
        this.preferences = this.loadPreferences();
      }

      // è·å–é»˜è®¤åå¥½æ•°æ®ç»“æ„
      getDefaultPreferences() {
        return {
          userId: 'default_user',
          version: '1.0',

          // 1. åŸºç¡€åå¥½ç»Ÿè®¡
          basicPreferences: {
            questionType: {
              'single': { count: 0, percentage: 0 },
              'multiple': { count: 0, percentage: 0 },
              'judge': { count: 0, percentage: 0 },
              'fill': { count: 0, percentage: 0 },
              'essay': { count: 0, percentage: 0 },
              'all': { count: 0, percentage: 0 }
            },
            difficulty: {
              '1': { count: 0, percentage: 0 },
              '2': { count: 0, percentage: 0 },
              '3': { count: 0, percentage: 0 },
              '4': { count: 0, percentage: 0 },
              '5': { count: 0, percentage: 0 }
            },
            quantity: {
              total: 0,
              average: 10,
              mostCommon: 10,
              distribution: {}
            },
            knowledgePoints: {}
          },

          // 2. åœºæ™¯åå¥½
          scenarioPreferences: {
            'generate_questions': {
              lastUsed: null,
              frequency: 0,
              lastParams: null,
              commonConfig: null
            }
          },

          // 3. è¡Œä¸ºæ¨¡å¼
          behaviorPatterns: {
            timePatterns: {
              weekday: { samples: 0, avgDifficulty: 0, avgCount: 0, commonType: null },
              weekend: { samples: 0, avgDifficulty: 0, avgCount: 0, commonType: null }
            },
            knowledgePointFocus: {
              recent: [],
              trending: null
            },
            commonCombinations: []
          },

          // 4. å¯¹è¯é£æ ¼åå¥½
          conversationStyle: {
            verbosity: 'normal',
            confirmationNeeded: true,
            preferQuickActions: false
          },

          // 5. å…ƒæ•°æ®
          metadata: {
            totalActions: 0,
            firstActionDate: null,
            lastActionDate: null,
            totalQuestionsGenerated: 0
          }
        };
      }

      // åŠ è½½åå¥½æ•°æ®
      loadPreferences() {
        try {
          const stored = localStorage.getItem(this.storageKey);
          if (stored) {
            return JSON.parse(stored);
          }
        } catch (error) {
          console.error('åŠ è½½åå¥½æ•°æ®å¤±è´¥:', error);
        }
        return this.getDefaultPreferences();
      }

      // ä¿å­˜åå¥½æ•°æ®
      savePreferences() {
        try {
          localStorage.setItem(this.storageKey, JSON.stringify(this.preferences));
          return true;
        } catch (error) {
          console.error('ä¿å­˜åå¥½æ•°æ®å¤±è´¥:', error);
          return false;
        }
      }

      // ============================================
      // åå¥½è®°å½•åŠŸèƒ½
      // ============================================

      /**
       * è®°å½•ç”¨æˆ·æ“ä½œè¡Œä¸º
       * @param {Object} params - æ“ä½œå‚æ•°
       * @param {string} params.type - é¢˜å‹ (single/multiple/judge/fill/essay/all)
       * @param {number} params.count - ç”Ÿæˆæ•°é‡
       * @param {number} params.difficulty - éš¾åº¦ (1-5)
       * @param {string} params.knowledgePoint - çŸ¥è¯†ç‚¹
       * @param {Date} params.timestamp - æ—¶é—´æˆ³
       */
      recordAction(params) {
        // éªŒè¯å‚æ•°
        if (!params || typeof params !== 'object') {
          console.error('recordAction: å‚æ•°æ— æ•ˆ');
          return false;
        }

        // è®¾ç½®é»˜è®¤æ—¶é—´æˆ³
        if (!params.timestamp) {
          params.timestamp = new Date();
        }

        // æ›´æ–°å…ƒæ•°æ®
        const metadata = this.preferences.metadata;
        metadata.totalActions++;
        if (!metadata.firstActionDate) {
          metadata.firstActionDate = params.timestamp.toISOString();
        }
        metadata.lastActionDate = params.timestamp.toISOString();

        // æ›´æ–°ç”Ÿæˆé¢˜ç›®æ€»æ•°
        if (params.count && typeof params.count === 'number') {
          metadata.totalQuestionsGenerated += params.count;
        }

        // æ›´æ–°å„ç±»åå¥½
        this.updateBasicPreferences(params);
        this.updateScenarioPreferences(params);
        this.updateBehaviorPatterns(params);

        // é‡æ–°è®¡ç®—ç™¾åˆ†æ¯”
        this.calculatePercentages();

        // ä¿å­˜åˆ° LocalStorage
        return this.savePreferences();
      }

      /**
       * æ›´æ–°åŸºç¡€åå¥½ç»Ÿè®¡
       * @param {Object} params - æ“ä½œå‚æ•°
       */
      updateBasicPreferences(params) {
        const basic = this.preferences.basicPreferences;

        // 1. æ›´æ–°é¢˜å‹ç»Ÿè®¡
        if (params.type) {
          const typeKey = params.type;
          if (basic.questionType[typeKey]) {
            basic.questionType[typeKey].count++;
          }
        }

        // 2. æ›´æ–°éš¾åº¦ç»Ÿè®¡
        if (params.difficulty) {
          const diffKey = String(params.difficulty);
          if (basic.difficulty[diffKey]) {
            basic.difficulty[diffKey].count++;
          }
        }

        // 3. æ›´æ–°æ•°é‡ç»Ÿè®¡
        if (params.count && typeof params.count === 'number') {
          const quantity = basic.quantity;

          // æ›´æ–°æ€»æ•°
          quantity.total += params.count;

          // æ›´æ–°åˆ†å¸ƒ
          const countKey = String(params.count);
          if (!quantity.distribution[countKey]) {
            quantity.distribution[countKey] = 0;
          }
          quantity.distribution[countKey]++;

          // è®¡ç®—å¹³å‡å€¼
          const totalSamples = Object.values(quantity.distribution).reduce((sum, val) => sum + val, 0);
          const weightedSum = Object.entries(quantity.distribution).reduce((sum, [count, freq]) => {
            return sum + (parseInt(count) * freq);
          }, 0);
          quantity.average = totalSamples > 0 ? Math.round(weightedSum / totalSamples) : 10;

          // æ‰¾å‡ºæœ€å¸¸ç”¨çš„æ•°é‡
          let maxFreq = 0;
          let mostCommonCount = 10;
          for (const [count, freq] of Object.entries(quantity.distribution)) {
            if (freq > maxFreq) {
              maxFreq = freq;
              mostCommonCount = parseInt(count);
            }
          }
          quantity.mostCommon = mostCommonCount;
        }

        // 4. æ›´æ–°çŸ¥è¯†ç‚¹ç»Ÿè®¡
        if (params.knowledgePoint) {
          const kpKey = params.knowledgePoint;
          if (!basic.knowledgePoints[kpKey]) {
            basic.knowledgePoints[kpKey] = { count: 0, percentage: 0 };
          }
          basic.knowledgePoints[kpKey].count++;
        }
      }

      /**
       * æ›´æ–°åœºæ™¯åå¥½
       * @param {Object} params - æ“ä½œå‚æ•°
       */
      updateScenarioPreferences(params) {
        const scenario = this.preferences.scenarioPreferences.generate_questions;

        // æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´
        scenario.lastUsed = params.timestamp ? params.timestamp.toISOString() : new Date().toISOString();

        // æ›´æ–°ä½¿ç”¨é¢‘ç‡
        scenario.frequency++;

        // æ›´æ–°æœ€åä½¿ç”¨çš„å‚æ•°
        scenario.lastParams = {
          type: params.type || null,
          count: params.count || null,
          difficulty: params.difficulty || null,
          knowledgePoint: params.knowledgePoint || null
        };

        // æ›´æ–°å¸¸ç”¨é…ç½®ï¼ˆä½¿ç”¨æœ€åä¸€æ¬¡çš„å‚æ•°ä½œä¸ºå¸¸ç”¨é…ç½®ï¼‰
        scenario.commonConfig = {
          type: params.type || 'single',
          count: params.count || 10,
          difficulty: params.difficulty || 2,
          knowledgePoint: params.knowledgePoint || null
        };
      }

      /**
       * æ›´æ–°è¡Œä¸ºæ¨¡å¼
       * @param {Object} params - æ“ä½œå‚æ•°
       */
      updateBehaviorPatterns(params) {
        const patterns = this.preferences.behaviorPatterns;
        const timestamp = params.timestamp || new Date();

        // 1. æ›´æ–°æ—¶é—´æ¨¡å¼ï¼ˆå·¥ä½œæ—¥/å‘¨æœ«ï¼‰
        const timeKey = this.getTimePattern(timestamp);
        const timePattern = patterns.timePatterns[timeKey];

        timePattern.samples++;

        // æ›´æ–°å¹³å‡éš¾åº¦
        if (params.difficulty) {
          const currentAvg = timePattern.avgDifficulty || 0;
          const currentSamples = timePattern.samples;
          timePattern.avgDifficulty = ((currentAvg * (currentSamples - 1)) + params.difficulty) / currentSamples;
        }

        // æ›´æ–°å¹³å‡æ•°é‡
        if (params.count) {
          const currentAvg = timePattern.avgCount || 0;
          const currentSamples = timePattern.samples;
          timePattern.avgCount = ((currentAvg * (currentSamples - 1)) + params.count) / currentSamples;
        }

        // æ›´æ–°å¸¸ç”¨é¢˜å‹
        if (params.type) {
          timePattern.commonType = params.type;
        }

        // 2. æ›´æ–°çŸ¥è¯†ç‚¹å…³æ³¨åº¦ï¼ˆæ»‘åŠ¨çª—å£ï¼Œæœ€å¤šä¿ç•™10æ¡ï¼‰
        if (params.knowledgePoint) {
          const recent = patterns.knowledgePointFocus.recent;
          recent.push({
            knowledgePoint: params.knowledgePoint,
            timestamp: timestamp.toISOString()
          });

          // ä¿æŒæœ€å¤š10æ¡è®°å½•
          if (recent.length > 10) {
            recent.shift();
          }

          // è®¡ç®—è¶‹åŠ¿ï¼ˆæœ€è¿‘ä½¿ç”¨æœ€å¤šçš„çŸ¥è¯†ç‚¹ï¼‰
          patterns.knowledgePointFocus.trending = this.getTrendingKnowledgePoint();
        }

        // 3. æ›´æ–°å¸¸ç”¨ç»„åˆ
        this.updateCommonCombinations(params);
      }

      /**
       * é‡æ–°è®¡ç®—æ‰€æœ‰ç™¾åˆ†æ¯”
       */
      calculatePercentages() {
        const basic = this.preferences.basicPreferences;

        // 1. è®¡ç®—é¢˜å‹ç™¾åˆ†æ¯”
        const typeTotal = Object.values(basic.questionType).reduce((sum, item) => sum + item.count, 0);
        if (typeTotal > 0) {
          for (const key in basic.questionType) {
            const count = basic.questionType[key].count;
            basic.questionType[key].percentage = Math.round((count / typeTotal) * 100 * 100) / 100;
          }
        }

        // 2. è®¡ç®—éš¾åº¦ç™¾åˆ†æ¯”
        const diffTotal = Object.values(basic.difficulty).reduce((sum, item) => sum + item.count, 0);
        if (diffTotal > 0) {
          for (const key in basic.difficulty) {
            const count = basic.difficulty[key].count;
            basic.difficulty[key].percentage = Math.round((count / diffTotal) * 100 * 100) / 100;
          }
        }

        // 3. è®¡ç®—çŸ¥è¯†ç‚¹ç™¾åˆ†æ¯”
        const kpTotal = Object.values(basic.knowledgePoints).reduce((sum, item) => sum + item.count, 0);
        if (kpTotal > 0) {
          for (const key in basic.knowledgePoints) {
            const count = basic.knowledgePoints[key].count;
            basic.knowledgePoints[key].percentage = Math.round((count / kpTotal) * 100 * 100) / 100;
          }
        }
      }

      /**
       * åˆ¤æ–­æ˜¯å¦ä¸ºå‘¨æœ«
       * @param {number} dayOfWeek - æ˜ŸæœŸå‡  (0=å‘¨æ—¥, 6=å‘¨å…­)
       * @returns {boolean} æ˜¯å¦ä¸ºå‘¨æœ«
       */
      isWeekend(dayOfWeek) {
        return dayOfWeek === 0 || dayOfWeek === 6;
      }

      /**
       * æ›´æ–°å¸¸ç”¨å‚æ•°ç»„åˆ
       * @param {Object} params - å‚æ•°å¯¹è±¡ {type, difficulty, count}
       */
      updateCommonCombinations(params) {
        const patterns = this.preferences.behaviorPatterns;

        if (params.type && params.difficulty && params.count) {
          const combination = {
            type: params.type,
            difficulty: params.difficulty,
            count: params.count,
            frequency: 1
          };

          // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨ç›¸åŒç»„åˆ
          const existingIndex = patterns.commonCombinations.findIndex(c =>
            c.type === combination.type &&
            c.difficulty === combination.difficulty &&
            c.count === combination.count
          );

          if (existingIndex >= 0) {
            // å·²å­˜åœ¨ï¼Œå¢åŠ é¢‘ç‡
            patterns.commonCombinations[existingIndex].frequency++;
          } else {
            // ä¸å­˜åœ¨ï¼Œæ·»åŠ æ–°ç»„åˆ
            patterns.commonCombinations.push(combination);
          }

          // æŒ‰é¢‘ç‡æ’åºï¼Œä¿ç•™å‰5ä¸ª
          patterns.commonCombinations.sort((a, b) => b.frequency - a.frequency);
          if (patterns.commonCombinations.length > 5) {
            patterns.commonCombinations = patterns.commonCombinations.slice(0, 5);
          }
        }
      }

      /**
       * è·å–æœ€è¿‘æœ€å¸¸ç”¨çš„çŸ¥è¯†ç‚¹
       * @returns {string|null} çŸ¥è¯†ç‚¹åç§°ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›null
       */
      getTrendingKnowledgePoint() {
        const recent = this.preferences.behaviorPatterns.knowledgePointFocus.recent;

        if (recent.length === 0) {
          return null;
        }

        // ç»Ÿè®¡æ¯ä¸ªçŸ¥è¯†ç‚¹çš„é¢‘ç‡
        const kpCounts = {};
        recent.forEach(item => {
          kpCounts[item.knowledgePoint] = (kpCounts[item.knowledgePoint] || 0) + 1;
        });

        // æ‰¾å‡ºé¢‘ç‡æœ€é«˜çš„çŸ¥è¯†ç‚¹
        let maxCount = 0;
        let trendingKp = null;
        for (const [kp, count] of Object.entries(kpCounts)) {
          if (count > maxCount) {
            maxCount = count;
            trendingKp = kp;
          }
        }

        return trendingKp;
      }

      /**
       * è·å–å½“å‰æ—¶é—´æ¨¡å¼
       * @param {Date} timestamp - æ—¶é—´æˆ³
       * @returns {string} 'weekday' æˆ– 'weekend'
       */
      getTimePattern(timestamp) {
        const dayOfWeek = timestamp.getDay();
        return this.isWeekend(dayOfWeek) ? 'weekend' : 'weekday';
      }
    }

    // ========== å¯¹è¯æµç¨‹ç®¡ç†å™¨ ==========
    class ConversationManager {
      constructor(task) {
        this.task = task;
        // æ–°å¢ï¼šæ™ºèƒ½å‚æ•°æå–å™¨
        this.smartExtractor = new SmartParamExtractor();
      }

      // å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œç”ŸæˆAIå“åº”
      processUserInput(userInput) {
        // é€šç”¨å¯¹è¯å¤„ç†
        return this.generateResponse(userInput);
      }

      // ç”ŸæˆAIå“åº”
      generateResponse(input) {
        // å¦‚æœä»»åŠ¡å·²ç»åœ¨ç”Ÿæˆé¢˜ç›®çš„æµç¨‹ä¸­ï¼Œç›´æ¥ç»§ç»­å¤„ç†
        if (this.task.generateParams && this.task.generateParams.step && this.task.generateParams.step !== 'init') {
          return this.handleGenerateQuestions(input);
        }

        // è¯†åˆ«ç”¨æˆ·æ„å›¾å¹¶ç»™å‡ºç›¸åº”å›å¤
        const intent = this.recognizeIntent(input);

        switch (intent) {
          case 'generate_questions':
            return this.handleGenerateQuestions(input);
          case 'create_paper':
            return this.handleCreatePaper(input);
          case 'create_exam':
            return this.handleCreateExam(input);
          case 'create_practice':
            return this.handleCreatePractice(input);
          case 'greeting':
            return 'æ‚¨å¥½ï¼æˆ‘å¯ä»¥å¸®æ‚¨ç”Ÿæˆé¢˜ç›®ã€åˆ›å»ºè¯•å·ã€ç»„ç»‡è€ƒè¯•ã€å‘å¸ƒåˆ·é¢˜ä»»åŠ¡ç­‰ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ';
          default:
            return 'æˆ‘ç†è§£äº†ã€‚è¯·ç»§ç»­å‘Šè¯‰æˆ‘æ›´å¤šä¿¡æ¯ï¼Œæˆ–è€…å‘Šè¯‰æˆ‘æ‚¨æƒ³åšä»€ä¹ˆï¼Ÿ';
        }
      }

      // è¯†åˆ«ç”¨æˆ·æ„å›¾
      recognizeIntent(input) {
        const lower = input.toLowerCase();

        // é—®å€™è¯­
        if (/^(ä½ å¥½|æ‚¨å¥½|hi|hello|å—¨)/.test(lower)) {
          return 'greeting';
        }

        // ç”Ÿæˆé¢˜ç›®
        if (lower.includes('ç”Ÿæˆé¢˜ç›®') || lower.includes('å‡ºé¢˜') || lower.includes('ç”Ÿæˆ') && lower.includes('é¢˜')) {
          return 'generate_questions';
        }

        // åˆ›å»ºè¯•å·
        if (lower.includes('ç»„å·') || lower.includes('è¯•å·') || lower.includes('å‡ºå·')) {
          return 'create_paper';
        }

        // åˆ›å»ºè€ƒè¯•
        if (lower.includes('è€ƒè¯•') && (lower.includes('åˆ›å»º') || lower.includes('å‘å¸ƒ') || lower.includes('ç»„ç»‡'))) {
          return 'create_exam';
        }

        // åˆ·é¢˜ä»»åŠ¡
        if (lower.includes('åˆ·é¢˜') || lower.includes('ç»ƒä¹ ')) {
          return 'create_practice';
        }

        return 'general';
      }

      // å¤„ç†ç”Ÿæˆé¢˜ç›®
      handleGenerateQuestions(input) {
        // åˆå§‹åŒ–å‚æ•°å¯¹è±¡
        if (!this.task.generateParams) {
          this.task.generateParams = {
            step: 'init' // å½“å‰æ­¥éª¤ï¼šinit, type, count, difficulty, knowledge, document, confirm
          };
        }

        const params = this.task.generateParams;
        const currentStep = params.step || 'init';

        // ä½¿ç”¨æ™ºèƒ½æå–å™¨ï¼ˆæ›¿ä»£åŸæœ‰çš„extractQuestionParamsï¼‰
        const extractResult = this.smartExtractor.extract(input, this.getContext());
        const extracted = extractResult.params;
        const confidence = extractResult.confidence;

        // æ ¹æ®å½“å‰æ­¥éª¤å¤„ç†
        switch (currentStep) {
          case 'init':
            // åˆå§‹é˜¶æ®µï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æä¾›äº†å®Œæ•´ä¿¡æ¯
            if (extracted.type) {
              params.type = extracted.type;
              params.typeName = extracted.typeName;
            }
            if (extracted.count) {
              params.count = extracted.count;
            }
            if (extracted.difficulty) {
              params.difficulty = extracted.difficulty;
              params.difficultyName = extracted.difficultyName;
            }
            if (extracted.knowledgePoint) {
              params.knowledgePoint = extracted.knowledgePoint;
            }

            // å¼€å§‹å¼•å¯¼æµç¨‹
            if (!params.type) {
              params.step = 'type';
              return 'å¥½çš„ï¼Œæˆ‘æ¥å¸®æ‚¨ç”Ÿæˆé¢˜ç›®ã€‚\n\nğŸ“ **ç¬¬1æ­¥ï¼šé€‰æ‹©é¢˜å‹**\n\nè¯·é—®éœ€è¦ç”Ÿæˆä»€ä¹ˆé¢˜å‹ï¼Ÿ\nâ€¢ å•é€‰é¢˜\nâ€¢ å¤šé€‰é¢˜\nâ€¢ åˆ¤æ–­é¢˜\nâ€¢ å¡«ç©ºé¢˜\nâ€¢ ç®€ç­”é¢˜\nâ€¢ å¤åˆé¢˜\nâ€¢ æ‰€æœ‰é¢˜å‹ï¼ˆéšæœºæ··åˆï¼‰\n\næ‚¨å¯ä»¥é€‰æ‹©ä¸€ç§é¢˜å‹ï¼Œæˆ–è€…é€‰æ‹©"æ‰€æœ‰é¢˜å‹"ã€‚';
            } else if (!params.count) {
              params.step = 'count';
              return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆ${params.typeName}ã€‚\n\nğŸ”¢ **ç¬¬2æ­¥ï¼šè®¾ç½®æ•°é‡**\n\nè¯·é—®éœ€è¦ç”Ÿæˆå¤šå°‘é“é¢˜ï¼Ÿ`;
            } else if (params.hasDocument === undefined) {
              // è¯¢é—®æ˜¯å¦æœ‰å‚è€ƒæ–‡æ¡£
              params.step = 'document';
              return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆ${params.count}é“${params.typeName}ã€‚\n\nğŸ“„ **ç¬¬3æ­¥ï¼šå‚è€ƒæ–‡æ¡£**ï¼ˆå¯é€‰ï¼‰\n\næ‚¨æœ‰å‚è€ƒæ–‡æ¡£æˆ–æ•™æå—ï¼Ÿå¦‚æœæœ‰ï¼Œæˆ‘å¯ä»¥åŸºäºæ–‡æ¡£å†…å®¹ç”Ÿæˆæ›´è´´åˆçš„é¢˜ç›®ã€‚\n\nè¯·å›å¤ï¼š\nâ€¢ "æœ‰"ï¼ˆç„¶åä¸Šä¼ æ–‡æ¡£æˆ–ç²˜è´´å†…å®¹ï¼‰\nâ€¢ "æ²¡æœ‰"ï¼ˆç›´æ¥ä»é¢˜åº“ä¸­é€‰æ‹©ï¼‰`;
            } else if (!params.hasDocument && params.difficulty === undefined) {
              // å¦‚æœæ²¡æœ‰æ–‡æ¡£ï¼Œè¯¢é—®éš¾åº¦
              params.step = 'difficulty';
              return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆ${params.count}é“${params.typeName}ã€‚\n\nâ­ **ç¬¬4æ­¥ï¼šé€‰æ‹©éš¾åº¦**ï¼ˆå¯é€‰ï¼‰\n\nè¯·é—®éœ€è¦ä»€ä¹ˆéš¾åº¦çš„é¢˜ç›®ï¼Ÿ\nâ€¢ ç®€å•\nâ€¢ ä¸­ç­‰\nâ€¢ å›°éš¾\nâ€¢ å¾ˆéš¾\nâ€¢ æéš¾\n\nå¦‚æœä¸æŒ‡å®šéš¾åº¦ï¼Œæˆ‘å°†éšæœºé€‰æ‹©å„ç§éš¾åº¦çš„é¢˜ç›®ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"ã€‚`;
            } else {
              // å¦‚æœé¢˜å‹ã€æ•°é‡ã€æ–‡æ¡£çŠ¶æ€éƒ½æœ‰äº†ï¼Œè·³åˆ°éš¾åº¦æ­¥éª¤
              params.step = 'difficulty';
              return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆ${params.count}é“${params.typeName}ã€‚\n\nâ­ **ç¬¬${params.hasDocument ? '4' : '3'}æ­¥ï¼šé€‰æ‹©éš¾åº¦**ï¼ˆå¯é€‰ï¼‰\n\nè¯·é—®éœ€è¦ä»€ä¹ˆéš¾åº¦çš„é¢˜ç›®ï¼Ÿ\nâ€¢ ç®€å•\nâ€¢ ä¸­ç­‰\nâ€¢ å›°éš¾\nâ€¢ å¾ˆéš¾\nâ€¢ æéš¾\n\nå¦‚æœä¸æŒ‡å®šéš¾åº¦ï¼Œæˆ‘å°†éšæœºé€‰æ‹©å„ç§éš¾åº¦çš„é¢˜ç›®ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"ã€‚`;
            }

          case 'type':
            // æ”¶é›†é¢˜å‹
            if (extracted.type) {
              params.type = extracted.type;
              params.typeName = extracted.typeName;
              params.step = 'count';
              return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆ${params.typeName}ã€‚\n\nğŸ”¢ **ç¬¬2æ­¥ï¼šè®¾ç½®æ•°é‡**\n\nè¯·é—®éœ€è¦ç”Ÿæˆå¤šå°‘é“é¢˜ï¼Ÿ`;
            } else {
              return 'è¯·é€‰æ‹©ä¸€ä¸ªé¢˜å‹ï¼šå•é€‰é¢˜ã€å¤šé€‰é¢˜ã€åˆ¤æ–­é¢˜ã€å¡«ç©ºé¢˜ã€ç®€ç­”é¢˜æˆ–å¤åˆé¢˜ã€‚';
            }

          case 'count':
            // æ”¶é›†æ•°é‡
            if (extracted.count) {
              params.count = extracted.count;
              params.step = 'document'; // æ”¹ä¸ºè·³è½¬åˆ°æ–‡æ¡£æ­¥éª¤
              return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆ${params.count}é“${params.typeName}ã€‚\n\nğŸ“„ **ç¬¬3æ­¥ï¼šå‚è€ƒæ–‡æ¡£**ï¼ˆå¯é€‰ï¼‰\n\næ‚¨æœ‰å‚è€ƒæ–‡æ¡£æˆ–æ•™æå—ï¼Ÿå¦‚æœæœ‰ï¼Œæˆ‘å¯ä»¥åŸºäºæ–‡æ¡£å†…å®¹ç”Ÿæˆæ›´è´´åˆçš„é¢˜ç›®ã€‚\n\nè¯·å›å¤ï¼š\nâ€¢ "æœ‰"ï¼ˆç„¶åä¸Šä¼ æ–‡æ¡£æˆ–ç²˜è´´å†…å®¹ï¼‰\nâ€¢ "æ²¡æœ‰"ï¼ˆç›´æ¥ä»é¢˜åº“ä¸­é€‰æ‹©ï¼‰`;
            } else {
              return 'è¯·å‘Šè¯‰æˆ‘éœ€è¦ç”Ÿæˆå¤šå°‘é“é¢˜ï¼Œä¾‹å¦‚ï¼š"5é“"ã€"10ä¸ª"ç­‰ã€‚';
            }

          case 'document':
            // æ”¶é›†å‚è€ƒæ–‡æ¡£ï¼ˆå¯é€‰ï¼‰
            const hasDocument = input.includes('æœ‰') && !input.includes('æ²¡æœ‰');
            const noDocument = input.includes('æ²¡æœ‰') || input.includes('æ²¡') || input.includes('è·³è¿‡');

            if (hasDocument) {
              params.hasDocument = true;
              params.step = 'waiting_document';
              return 'å¥½çš„ï¼Œè¯·ä¸Šä¼ æ‚¨çš„å‚è€ƒæ–‡æ¡£ï¼Œæˆ–è€…ç›´æ¥ç²˜è´´æ–‡æ¡£å†…å®¹ã€‚\n\næ”¯æŒçš„æ ¼å¼ï¼š\nâ€¢ æ–‡æœ¬å†…å®¹ï¼ˆç›´æ¥ç²˜è´´ï¼‰\nâ€¢ Wordæ–‡æ¡£ï¼ˆ.docxï¼‰\nâ€¢ PDFæ–‡æ¡£ï¼ˆ.pdfï¼‰\nâ€¢ Markdownæ–‡æ¡£ï¼ˆ.mdï¼‰';
            } else if (noDocument) {
              params.hasDocument = false;
              params.step = 'difficulty';
              return `å¥½çš„ï¼Œæˆ‘å°†ä»é¢˜åº“ä¸­ä¸ºæ‚¨é€‰æ‹©é¢˜ç›®ã€‚\n\nâ­ **ç¬¬4æ­¥ï¼šé€‰æ‹©éš¾åº¦**ï¼ˆå¯é€‰ï¼‰\n\nè¯·é—®éœ€è¦ä»€ä¹ˆéš¾åº¦çš„é¢˜ç›®ï¼Ÿ\nâ€¢ ç®€å•\nâ€¢ ä¸­ç­‰\nâ€¢ å›°éš¾\nâ€¢ å¾ˆéš¾\nâ€¢ æéš¾\n\nå¦‚æœä¸æŒ‡å®šéš¾åº¦ï¼Œæˆ‘å°†éšæœºé€‰æ‹©å„ç§éš¾åº¦çš„é¢˜ç›®ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"ã€‚`;
            } else {
              return 'è¯·å›å¤"æœ‰"æˆ–"æ²¡æœ‰"ã€‚';
            }

          case 'waiting_document':
            // ç­‰å¾…æ–‡æ¡£ä¸Šä¼ 
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå‡è®¾ç”¨æˆ·ç²˜è´´äº†æ–‡æ¡£å†…å®¹
            if (input.length > 50) {
              params.documentContent = input;
              params.step = 'difficulty';
              return `å¥½çš„ï¼Œæˆ‘å·²æ”¶åˆ°æ‚¨çš„å‚è€ƒæ–‡æ¡£ï¼ˆ${input.length}å­—ï¼‰ã€‚\n\nâ­ **ç¬¬4æ­¥ï¼šé€‰æ‹©éš¾åº¦**ï¼ˆå¯é€‰ï¼‰\n\nè¯·é—®éœ€è¦ä»€ä¹ˆéš¾åº¦çš„é¢˜ç›®ï¼Ÿ\nâ€¢ ç®€å•\nâ€¢ ä¸­ç­‰\nâ€¢ å›°éš¾\nâ€¢ å¾ˆéš¾\nâ€¢ æéš¾\n\nå¦‚æœä¸æŒ‡å®šéš¾åº¦ï¼Œæˆ‘å°†éšæœºé€‰æ‹©å„ç§éš¾åº¦çš„é¢˜ç›®ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"ã€‚`;
            } else {
              return 'æ–‡æ¡£å†…å®¹ä¼¼ä¹å¤ªçŸ­äº†ã€‚è¯·ç²˜è´´å®Œæ•´çš„æ–‡æ¡£å†…å®¹ï¼Œæˆ–è€…å›å¤"è·³è¿‡"ç›´æ¥ä»é¢˜åº“ç”Ÿæˆã€‚';
            }

          case 'difficulty':
            // æ”¶é›†éš¾åº¦ï¼ˆå¯é€‰ï¼‰
            const skipKeywords = ['è·³è¿‡', 'ä¸éœ€è¦', 'éšæœº', 'ä¸ç”¨', 'ç®—äº†'];
            const shouldSkip = skipKeywords.some(keyword => input.includes(keyword));

            if (extracted.difficulty) {
              params.difficulty = extracted.difficulty;
              params.difficultyName = extracted.difficultyName;
            } else if (!shouldSkip) {
              // ç”¨æˆ·è¾“å…¥äº†å†…å®¹ä½†æ²¡æœ‰è¯†åˆ«åˆ°éš¾åº¦ï¼Œæç¤ºé‡æ–°è¾“å…¥
              if (input.trim().length > 0 && !skipKeywords.some(k => input.includes(k))) {
                return 'è¯·é€‰æ‹©ä¸€ä¸ªéš¾åº¦ï¼šç®€å•ã€ä¸­ç­‰ã€å›°éš¾ã€å¾ˆéš¾æˆ–æéš¾ã€‚æ‚¨ä¹Ÿå¯ä»¥å›å¤"è·³è¿‡"æ¥éšæœºé€‰æ‹©ã€‚';
              }
            }

            // è¿›å…¥ä¸‹ä¸€æ­¥ï¼šçŸ¥è¯†ç‚¹
            params.step = 'knowledge';
            const difficultyInfo = params.difficultyName ? `éš¾åº¦ä¸º${params.difficultyName}çš„` : '';
            return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆ${params.count}é“${difficultyInfo}${params.typeName}ã€‚\n\nğŸ“š **ç¬¬5æ­¥ï¼šé€‰æ‹©çŸ¥è¯†ç‚¹**ï¼ˆå¯é€‰ï¼‰\n\nè¯·é—®éœ€è¦å“ªä¸ªçŸ¥è¯†ç‚¹çš„é¢˜ç›®ï¼Ÿä¾‹å¦‚ï¼š\nâ€¢ æ•°æ®ç»“æ„\nâ€¢ ç®—æ³•\nâ€¢ æ“ä½œç³»ç»Ÿ\nâ€¢ è®¡ç®—æœºç½‘ç»œ\n\nå¦‚æœä¸æŒ‡å®šçŸ¥è¯†ç‚¹ï¼Œæˆ‘å°†ä»æ‰€æœ‰çŸ¥è¯†ç‚¹ä¸­éšæœºé€‰æ‹©ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"ã€‚`;

          case 'knowledge':
            // æ”¶é›†çŸ¥è¯†ç‚¹ï¼ˆå¯é€‰ï¼‰
            const skipKnowledge = ['è·³è¿‡', 'ä¸éœ€è¦', 'éšæœº', 'ä¸ç”¨', 'ç®—äº†'];
            const shouldSkipKnowledge = skipKnowledge.some(keyword => input.includes(keyword));

            if (extracted.knowledgePoint) {
              params.knowledgePoint = extracted.knowledgePoint;
            }

            // è¿›å…¥ç¡®è®¤æ­¥éª¤
            params.step = 'confirm';
            return this.showGenerateConfirmation(params);

          case 'confirm':
            // ç¡®è®¤å¹¶ç”Ÿæˆ
            const confirmKeywords = ['ç¡®è®¤', 'å¼€å§‹', 'ç”Ÿæˆ', 'å¥½çš„', 'æ˜¯çš„', 'yes', 'ok'];
            const cancelKeywords = ['å–æ¶ˆ', 'é‡æ–°', 'ä¿®æ”¹', 'ä¸'];

            if (confirmKeywords.some(keyword => input.includes(keyword))) {
              // å¼€å§‹ç”Ÿæˆé¢˜ç›®
              return this.generateQuestionsNow(params);
            } else if (cancelKeywords.some(keyword => input.includes(keyword))) {
              // å–æ¶ˆæˆ–é‡æ–°å¼€å§‹
              this.task.generateParams = { step: 'init' };
              return 'å¥½çš„ï¼Œå·²å–æ¶ˆã€‚å¦‚æœæ‚¨æƒ³é‡æ–°ç”Ÿæˆé¢˜ç›®ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚';
            } else {
              return 'è¯·å›å¤"ç¡®è®¤"å¼€å§‹ç”Ÿæˆï¼Œæˆ–å›å¤"å–æ¶ˆ"é‡æ–°è®¾ç½®ã€‚';
            }

          default:
            params.step = 'init';
            return 'å¥½çš„ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨ç”Ÿæˆé¢˜ç›®ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆé¢˜å‹çš„é¢˜ç›®ï¼Ÿ';
        }
      }

      // æ˜¾ç¤ºç”Ÿæˆç¡®è®¤ä¿¡æ¯
      showGenerateConfirmation(params) {
        let summary = 'ğŸ“‹ **ç”Ÿæˆé¢˜ç›®ç¡®è®¤**\n\n';
        summary += `â€¢ é¢˜å‹ï¼š${params.typeName}\n`;
        summary += `â€¢ æ•°é‡ï¼š${params.count}é“\n`;

        if (params.difficultyName) {
          summary += `â€¢ éš¾åº¦ï¼š${params.difficultyName}\n`;
        } else {
          summary += `â€¢ éš¾åº¦ï¼šéšæœº\n`;
        }

        if (params.knowledgePoint) {
          summary += `â€¢ çŸ¥è¯†ç‚¹ï¼š${params.knowledgePoint}\n`;
        } else {
          summary += `â€¢ çŸ¥è¯†ç‚¹ï¼šéšæœº\n`;
        }

        if (params.hasDocument) {
          summary += `â€¢ å‚è€ƒæ–‡æ¡£ï¼šå·²æä¾›\n`;
        } else {
          summary += `â€¢ å‚è€ƒæ–‡æ¡£ï¼šä»é¢˜åº“é€‰æ‹©\n`;
        }

        summary += '\nè¯·ç¡®è®¤ä»¥ä¸Šä¿¡æ¯ï¼Œå›å¤"ç¡®è®¤"å¼€å§‹ç”Ÿæˆé¢˜ç›®ã€‚';

        return summary;
      }

      // ç«‹å³ç”Ÿæˆé¢˜ç›®
      generateQuestionsNow(params) {
        try {
          // ä»é¢˜åº“ä¸­ç­›é€‰é¢˜ç›®
          const allQuestions = loadQuestionsData();

          if (!allQuestions || allQuestions.length === 0) {
            return 'æŠ±æ­‰ï¼Œé¢˜åº“ä¸­æš‚æ— é¢˜ç›®ã€‚è¯·å…ˆåœ¨é¢˜åº“ç®¡ç†ä¸­æ·»åŠ é¢˜ç›®ã€‚';
          }

          // ç­›é€‰ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®
          let filteredQuestions = allQuestions.filter(q => {
            // é¢˜å‹åŒ¹é…ï¼ˆå¦‚æœé€‰æ‹©äº†"æ‰€æœ‰é¢˜å‹"ï¼Œåˆ™ä¸ç­›é€‰é¢˜å‹ï¼‰
            if (params.type && params.type !== 'all' && q.type !== params.type) {
              return false;
            }

            // éš¾åº¦åŒ¹é…ï¼ˆå¦‚æœæŒ‡å®šäº†éš¾åº¦ï¼‰
            if (params.difficulty && q.difficulty !== params.difficulty) {
              return false;
            }

            // çŸ¥è¯†ç‚¹åŒ¹é…ï¼ˆå¦‚æœæŒ‡å®šäº†çŸ¥è¯†ç‚¹ï¼‰
            if (params.knowledgePoint && q.knowledgePath &&
                !q.knowledgePath.includes(params.knowledgePoint)) {
              return false;
            }

            return true;
          });

          if (filteredQuestions.length === 0) {
            return `æŠ±æ­‰ï¼Œé¢˜åº“ä¸­æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„${params.typeName}ã€‚\n\nå»ºè®®ï¼š\nâ€¢ å°è¯•å…¶ä»–é¢˜å‹\nâ€¢ é™ä½ç­›é€‰æ¡ä»¶\nâ€¢ åœ¨é¢˜åº“ç®¡ç†ä¸­æ·»åŠ æ›´å¤šé¢˜ç›®`;
          }

          // éšæœºé€‰æ‹©é¢˜ç›®
          const selectedQuestions = this.randomSelectQuestions(filteredQuestions, params.count);

          // æ˜¾ç¤ºç”Ÿæˆç»“æœ
          displayGeneratedQuestions(selectedQuestions, params);

          // é‡ç½®æ­¥éª¤çŠ¶æ€ï¼Œå…è®¸ç”¨æˆ·ç»§ç»­ç”Ÿæˆ
          this.task.generateParams = { step: 'init' };

          // è¿”å›æˆåŠŸæ¶ˆæ¯
          const difficultyText = params.difficultyName ? `ï¼ˆéš¾åº¦ï¼š${params.difficultyName}ï¼‰` : '';
          const knowledgeText = params.knowledgePoint ? `ï¼ˆçŸ¥è¯†ç‚¹ï¼š${params.knowledgePoint}ï¼‰` : '';
          const documentText = params.hasDocument ? 'ï¼ˆåŸºäºå‚è€ƒæ–‡æ¡£ï¼‰' : '';

          return `âœ… å·²æˆåŠŸç”Ÿæˆ${selectedQuestions.length}é“${params.typeName}${difficultyText}${knowledgeText}${documentText}\n\né¢˜ç›®å·²æ˜¾ç¤ºåœ¨å³ä¾§é¢„è§ˆåŒºã€‚\n\næ‚¨å¯ä»¥ï¼š\nâ€¢ ç»§ç»­ç”Ÿæˆæ›´å¤šé¢˜ç›®ï¼ˆç›´æ¥å‘Šè¯‰æˆ‘éœ€æ±‚ï¼‰\nâ€¢ å°†è¿™äº›é¢˜ç›®åŠ å…¥è¯•å·ï¼ˆç‚¹å‡»"åŠ å…¥è¯•å·"æŒ‰é’®ï¼‰\nâ€¢ å¯¼å‡ºé¢˜ç›®ï¼ˆç‚¹å‡»"å¯¼å‡º"æŒ‰é’®ï¼‰`;
        } catch (error) {
          console.error('ç”Ÿæˆé¢˜ç›®å¤±è´¥:', error);
          return `æŠ±æ­‰ï¼Œç”Ÿæˆé¢˜ç›®æ—¶å‡ºç°é”™è¯¯ï¼š${error.message}\n\nè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚`;
        }
      }

      // éšæœºé€‰æ‹©é¢˜ç›®
      randomSelectQuestions(questions, count) {
        // å¦‚æœé¢˜ç›®æ•°é‡ä¸è¶³ï¼Œè¿”å›æ‰€æœ‰é¢˜ç›®
        if (questions.length <= count) {
          return questions;
        }

        // éšæœºæ‰“ä¹±æ•°ç»„
        const shuffled = [...questions].sort(() => Math.random() - 0.5);

        // è¿”å›å‰countä¸ª
        return shuffled.slice(0, count);
      }

      // å¤„ç†åˆ›å»ºè¯•å·
      handleCreatePaper(input) {
        const nameMatch = input.match(/[ã€Šã€Œã€](.+?)[ã€‹ã€ã€]/);
        const scoreMatch = input.match(/(\d+)\s*åˆ†/);

        if (nameMatch && scoreMatch) {
          return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ›å»ºè¯•å·ã€Š${nameMatch[1]}ã€‹ï¼Œæ€»åˆ†${scoreMatch[1]}åˆ†ã€‚\n\nè¯·ç¨ç­‰ï¼Œæ­£åœ¨å‡†å¤‡è¯•å·...`;
        } else if (nameMatch) {
          return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ›å»ºè¯•å·ã€Š${nameMatch[1]}ã€‹ã€‚è¯·é—®æ€»åˆ†æ˜¯å¤šå°‘ï¼Ÿ`;
        } else if (scoreMatch) {
          return `å¥½çš„ï¼Œæ€»åˆ†${scoreMatch[1]}åˆ†ã€‚è¯·é—®è¯•å·åç§°æ˜¯ä»€ä¹ˆï¼Ÿ`;
        } else {
          return 'å¥½çš„ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨åˆ›å»ºè¯•å·ã€‚è¯·å‘Šè¯‰æˆ‘ï¼š\n1. è¯•å·åç§°ï¼ˆä¾‹å¦‚ï¼šã€ŠæœŸæœ«è€ƒè¯•ã€‹ï¼‰\n2. æ€»åˆ†ï¼ˆä¾‹å¦‚ï¼š100åˆ†ï¼‰';
        }
      }

      // å¤„ç†åˆ›å»ºè€ƒè¯•
      handleCreateExam(input) {
        const nameMatch = input.match(/[ã€Šã€Œã€](.+?)[ã€‹ã€ã€]/);
        const durationMatch = input.match(/(\d+)\s*åˆ†é’Ÿ/);

        if (nameMatch && durationMatch) {
          return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ›å»ºè€ƒè¯•ã€Š${nameMatch[1]}ã€‹ï¼Œæ—¶é•¿${durationMatch[1]}åˆ†é’Ÿã€‚\n\nè¯·ç¨ç­‰ï¼Œæ­£åœ¨é…ç½®è€ƒè¯•...`;
        } else if (nameMatch) {
          return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ›å»ºè€ƒè¯•ã€Š${nameMatch[1]}ã€‹ã€‚è¯·é—®è€ƒè¯•æ—¶é•¿æ˜¯å¤šå°‘åˆ†é’Ÿï¼Ÿ`;
        } else if (durationMatch) {
          return `å¥½çš„ï¼Œè€ƒè¯•æ—¶é•¿${durationMatch[1]}åˆ†é’Ÿã€‚è¯·é—®è€ƒè¯•åç§°æ˜¯ä»€ä¹ˆï¼Ÿ`;
        } else {
          return 'å¥½çš„ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨åˆ›å»ºè€ƒè¯•ã€‚è¯·å‘Šè¯‰æˆ‘ï¼š\n1. è€ƒè¯•åç§°ï¼ˆä¾‹å¦‚ï¼šã€ŠæœŸæœ«è€ƒè¯•ã€‹ï¼‰\n2. è€ƒè¯•æ—¶é•¿ï¼ˆä¾‹å¦‚ï¼š120åˆ†é’Ÿï¼‰';
        }
      }

      // å¤„ç†åˆ·é¢˜ä»»åŠ¡
      handleCreatePractice(input) {
        const nameMatch = input.match(/[ã€Šã€Œã€](.+?)[ã€‹ã€ã€]/);
        const countMatch = input.match(/(\d+)\s*[é“ä¸ªé¢˜]/);

        if (nameMatch && countMatch) {
          return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ›å»ºåˆ·é¢˜ä»»åŠ¡ã€Š${nameMatch[1]}ã€‹ï¼ŒåŒ…å«${countMatch[1]}é“é¢˜ç›®ã€‚\n\nè¯·ç¨ç­‰ï¼Œæ­£åœ¨å‡†å¤‡ä»»åŠ¡...`;
        } else if (nameMatch) {
          return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ›å»ºåˆ·é¢˜ä»»åŠ¡ã€Š${nameMatch[1]}ã€‹ã€‚è¯·é—®éœ€è¦å¤šå°‘é“é¢˜ï¼Ÿ`;
        } else if (countMatch) {
          return `å¥½çš„ï¼ŒåŒ…å«${countMatch[1]}é“é¢˜ç›®ã€‚è¯·é—®ä»»åŠ¡åç§°æ˜¯ä»€ä¹ˆï¼Ÿ`;
        } else {
          return 'å¥½çš„ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨åˆ›å»ºåˆ·é¢˜ä»»åŠ¡ã€‚è¯·å‘Šè¯‰æˆ‘ï¼š\n1. ä»»åŠ¡åç§°ï¼ˆä¾‹å¦‚ï¼šã€Šæ¯æ—¥ç»ƒä¹ ã€‹ï¼‰\n2. é¢˜ç›®æ•°é‡ï¼ˆä¾‹å¦‚ï¼š20é“é¢˜ï¼‰';
        }
      }

      // è·å–å¯¹è¯ä¸Šä¸‹æ–‡
      getContext() {
        return {
          history: this.task.messages || [],
          lastParams: this.task.generateParams || {},
          timestamp: new Date()
        };
      }

      // æå–é¢˜ç›®å‚æ•°
      extractQuestionParams(input) {
        const params = {};

        // æ£€æŸ¥æ˜¯å¦é€‰æ‹©æ‰€æœ‰é¢˜å‹
        if (input.includes('æ‰€æœ‰') || input.includes('å…¨éƒ¨') || input.includes('æ‰€æœ‰é¢˜å‹') || input.includes('å…¨éƒ¨é¢˜å‹')) {
          params.type = 'all';
          params.typeName = 'æ‰€æœ‰é¢˜å‹';
          return params; // ç›´æ¥è¿”å›ï¼Œä¸å†æ£€æŸ¥å…·ä½“é¢˜å‹
        }

        // é¢˜å‹æå–
        const typeMap = {
          'å•é€‰': { type: 'single', name: 'å•é€‰é¢˜' },
          'å¤šé€‰': { type: 'multiple', name: 'å¤šé€‰é¢˜' },
          'åˆ¤æ–­': { type: 'judge', name: 'åˆ¤æ–­é¢˜' },
          'å¡«ç©º': { type: 'blank', name: 'å¡«ç©ºé¢˜' },
          'ç®€ç­”': { type: 'shortAnswer', name: 'ç®€ç­”é¢˜' },
          'å¤åˆ': { type: 'composite', name: 'å¤åˆé¢˜' }
        };

        for (const [key, value] of Object.entries(typeMap)) {
          if (input.includes(key)) {
            params.type = value.type;
            params.typeName = value.name;
            break;
          }
        }

        // æ•°é‡æå–
        const countMatch = input.match(/(\d+)\s*[é“ä¸ªé¢˜]/);
        if (countMatch) {
          params.count = parseInt(countMatch[1]);
        }

        // éš¾åº¦æå–
        const difficultyMap = {
          'ç®€å•': { level: 1, name: 'ç®€å•' },
          'å®¹æ˜“': { level: 1, name: 'ç®€å•' },
          'ä¸€çº§': { level: 1, name: 'ä¸€çº§' },
          'ä¸­ç­‰': { level: 2, name: 'ä¸­ç­‰' },
          'äºŒçº§': { level: 2, name: 'äºŒçº§' },
          'å›°éš¾': { level: 3, name: 'å›°éš¾' },
          'éš¾': { level: 3, name: 'å›°éš¾' },
          'ä¸‰çº§': { level: 3, name: 'ä¸‰çº§' },
          'å¾ˆéš¾': { level: 4, name: 'å¾ˆéš¾' },
          'å››çº§': { level: 4, name: 'å››çº§' },
          'æéš¾': { level: 5, name: 'æéš¾' },
          'äº”çº§': { level: 5, name: 'äº”çº§' }
        };

        for (const [key, value] of Object.entries(difficultyMap)) {
          if (input.includes(key)) {
            params.difficulty = value.level;
            params.difficultyName = value.name;
            break;
          }
        }

        // çŸ¥è¯†ç‚¹æå–ï¼ˆç®€å•åŒ¹é…ï¼‰
        const knowledgeMatch = input.match(/å…³äº(.+?)çš„|(.+?)ç›¸å…³|(.+?)çŸ¥è¯†ç‚¹/);
        if (knowledgeMatch) {
          params.knowledgePoint = knowledgeMatch[1] || knowledgeMatch[2] || knowledgeMatch[3];
        }

        return params;
      }
    }

    // ========== é¢˜åº“æ•°æ®åŠ è½½ ==========

    // åŠ è½½é¢˜åº“æ•°æ®
    function loadQuestionsData() {
      if (questionsCache) {
        return questionsCache;
      }

      try {
        const data = localStorage.getItem('allQuestions');
        if (data) {
          questionsCache = JSON.parse(data);
          console.log('é¢˜åº“æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', questionsCache.length, 'é“é¢˜ç›®');
          return questionsCache;
        }
      } catch (error) {
        console.error('åŠ è½½é¢˜åº“æ•°æ®å¤±è´¥:', error);
      }

      console.warn('é¢˜åº“ä¸ºç©ºï¼Œè¯·å…ˆåœ¨é¢˜åº“ç®¡ç†ä¸­æ·»åŠ é¢˜ç›®');
      return [];
    }

    // åŠ è½½çŸ¥è¯†ç‚¹æ ‘æ•°æ®
    function loadKnowledgeTreeData() {
      if (knowledgeTreeCache) {
        return knowledgeTreeCache;
      }

      try {
        const data = localStorage.getItem('knowledgePoints');
        if (data) {
          knowledgeTreeCache = JSON.parse(data);
          console.log('çŸ¥è¯†ç‚¹æ•°æ®åŠ è½½æˆåŠŸ');
          return knowledgeTreeCache;
        }
      } catch (error) {
        console.error('åŠ è½½çŸ¥è¯†ç‚¹æ•°æ®å¤±è´¥:', error);
      }

      console.warn('çŸ¥è¯†ç‚¹æ ‘ä¸ºç©º');
      return [];
    }

    // æœç´¢é¢˜ç›®
    function searchQuestions(params) {
      const questions = loadQuestionsData();

      if (questions.length === 0) {
        return {
          success: false,
          message: 'é¢˜åº“ä¸ºç©ºï¼Œè¯·å…ˆåœ¨é¢˜åº“ç®¡ç†ä¸­æ·»åŠ é¢˜ç›®ã€‚',
          total: 0,
          returned: 0,
          results: []
        };
      }

      let filtered = questions;

      // æŒ‰é¢˜å‹ç­›é€‰
      if (params.questionType) {
        filtered = filtered.filter(q => q.type === params.questionType);
      }

      // æŒ‰éš¾åº¦ç­›é€‰
      if (params.difficulty) {
        filtered = filtered.filter(q => q.difficulty === params.difficulty);
      }

      // æŒ‰çŸ¥è¯†ç‚¹ç­›é€‰
      if (params.knowledge) {
        filtered = filtered.filter(q => {
          return q.knowledgePath && q.knowledgePath.includes(params.knowledge);
        });
      }

      // é™åˆ¶æ•°é‡
      const count = params.count || filtered.length;
      const results = filtered.slice(0, count);

      if (filtered.length === 0) {
        return {
          success: false,
          message: 'æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®ï¼Œè¯·è°ƒæ•´æœç´¢æ¡ä»¶ã€‚',
          total: 0,
          returned: 0,
          results: []
        };
      }

      return {
        success: true,
        message: `æ‰¾åˆ° ${filtered.length} é“ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®ï¼Œè¿”å›å‰ ${results.length} é“ã€‚`,
        total: filtered.length,
        returned: results.length,
        results: results
      };
    }

    // æ˜¾ç¤ºç”Ÿæˆçš„é¢˜ç›®åˆ°é¢„è§ˆåŒº
    function displayGeneratedQuestions(questions, params) {
      const previewContainer = document.getElementById('previewContainer');
      const previewEmpty = document.getElementById('previewEmpty');
      const previewTitle = document.getElementById('previewTitle');

      // éšè—ç©ºçŠ¶æ€
      if (previewEmpty) {
        previewEmpty.classList.add('hidden');
      }

      // æ›´æ–°æ ‡é¢˜
      if (previewTitle) {
        const difficultyText = params.difficultyName ? ` - ${params.difficultyName}` : '';
        previewTitle.textContent = `ç”Ÿæˆçš„${params.typeName}${difficultyText}`;
      }

      // æ¸…é™¤æ—§å†…å®¹ï¼ˆä¿ç•™å‚æ•°å¡ç‰‡ï¼‰
      const existingResults = previewContainer.querySelectorAll('.generated-questions-container');
      existingResults.forEach(el => el.remove());

      // åˆ›å»ºé¢˜ç›®å®¹å™¨
      const container = document.createElement('div');
      container.className = 'generated-questions-container space-y-4';

      // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
      const statsDiv = document.createElement('div');
      statsDiv.className = 'bg-primary-50 border border-primary-200 rounded-lg p-4 mb-4';
      statsDiv.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <i class="fas fa-check-circle text-primary-500"></i>
            <span class="text-sm font-medium text-gray-900">å·²ç”Ÿæˆ ${questions.length} é“é¢˜ç›®</span>
          </div>
          <div class="flex items-center space-x-2">
            <button onclick="exportGeneratedQuestions()" class="px-3 py-1 bg-white border border-primary-300 text-primary-600 rounded hover:bg-primary-50 text-sm">
              <i class="fas fa-download mr-1"></i>å¯¼å‡º
            </button>
            <button onclick="addToExam()" class="px-3 py-1 bg-primary-500 text-white rounded hover:bg-primary-600 text-sm">
              <i class="fas fa-plus mr-1"></i>åŠ å…¥è¯•å·
            </button>
          </div>
        </div>
      `;
      container.appendChild(statsDiv);

      // æ¸²æŸ“æ¯é“é¢˜ç›®
      questions.forEach((question, index) => {
        const questionCard = createQuestionCard(question, index + 1);
        container.appendChild(questionCard);
      });

      // æ·»åŠ åˆ°é¢„è§ˆåŒº
      previewContainer.appendChild(container);

      // ä¿å­˜ç”Ÿæˆçš„é¢˜ç›®åˆ°å½“å‰ä»»åŠ¡ï¼ˆç”¨äºå¯¼å‡ºå’ŒåŠ å…¥è¯•å·ï¼‰
      if (currentTask) {
        currentTask.generatedQuestions = questions;
        saveTasksToStorage();
      }

      // æ»šåŠ¨åˆ°é¡¶éƒ¨
      previewContainer.scrollTop = 0;
    }

    // æ¸²æŸ“æœç´¢ç»“æœåˆ°é¢„è§ˆåŒº
    function renderSearchResults(searchResult) {
      const previewContainer = document.getElementById('previewContainer');
      const previewEmpty = document.getElementById('previewEmpty');

      // ç§»é™¤æ—§çš„æœç´¢ç»“æœ
      const oldResults = document.getElementById('searchResults');
      if (oldResults) {
        oldResults.remove();
      }

      // å¦‚æœæœç´¢å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
      if (!searchResult.success) {
        const errorDiv = document.createElement('div');
        errorDiv.id = 'searchResults';
        errorDiv.className = 'bg-white rounded-xl shadow-sm border border-red-200 p-6';
        errorDiv.innerHTML = `
          <div class="flex items-start space-x-3">
            <div class="flex-shrink-0 w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
              <i class="fas fa-exclamation-circle text-red-600"></i>
            </div>
            <div class="flex-1">
              <h4 class="text-sm font-semibold text-gray-900 mb-1">æœç´¢å¤±è´¥</h4>
              <p class="text-sm text-gray-600">${searchResult.message}</p>
              ${searchResult.total === 0 && searchResult.message.includes('é¢˜åº“ä¸ºç©º') ? `
                <div class="mt-3 pt-3 border-t border-gray-200">
                  <p class="text-xs text-gray-500 mb-2">æ‚¨å¯ä»¥ï¼š</p>
                  <a href="question-bank/add.html" class="inline-flex items-center text-xs text-primary-500 hover:text-primary-600">
                    <i class="fas fa-plus-circle mr-1"></i>
                    å‰å¾€é¢˜åº“ç®¡ç†æ·»åŠ é¢˜ç›®
                  </a>
                </div>
              ` : ''}
            </div>
          </div>
        `;

        // æ·»åŠ åˆ°å‚æ•°å¡ç‰‡ä¹‹å
        const paramsCard = document.getElementById('paramsCard');
        if (paramsCard.nextSibling) {
          previewContainer.insertBefore(errorDiv, paramsCard.nextSibling);
        } else {
          previewContainer.appendChild(errorDiv);
        }
        return;
      }

      // éšè—ç©ºçŠ¶æ€
      previewEmpty.classList.add('hidden');

      // åˆ›å»ºç»“æœå®¹å™¨
      const resultsDiv = document.createElement('div');
      resultsDiv.id = 'searchResults';
      resultsDiv.className = 'space-y-4';

      // ç»“æœç»Ÿè®¡
      const statsDiv = document.createElement('div');
      statsDiv.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-4';
      statsDiv.innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <h4 class="text-sm font-semibold text-gray-900 mb-1">æœç´¢ç»“æœ</h4>
            <p class="text-xs text-gray-500">${searchResult.message}</p>
          </div>
          <div class="text-right">
            <div class="text-2xl font-bold text-primary-500">${searchResult.returned}</div>
            <div class="text-xs text-gray-500">é“é¢˜ç›®</div>
          </div>
        </div>
      `;
      resultsDiv.appendChild(statsDiv);

      // é¢˜ç›®åˆ—è¡¨
      if (searchResult.results.length > 0) {
        searchResult.results.forEach((question, index) => {
          const questionCard = createQuestionCard(question, index + 1);
          resultsDiv.appendChild(questionCard);
        });
      }

      // æ·»åŠ æ–°ç»“æœï¼ˆåœ¨å‚æ•°å¡ç‰‡ä¹‹åï¼‰
      const paramsCard = document.getElementById('paramsCard');
      if (paramsCard.nextSibling) {
        previewContainer.insertBefore(resultsDiv, paramsCard.nextSibling);
      } else {
        previewContainer.appendChild(resultsDiv);
      }
    }

    // åˆ›å»ºé¢˜ç›®å¡ç‰‡
    function createQuestionCard(question, index) {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow';

      // é¢˜å‹é¢œè‰²æ˜ å°„
      const typeColors = {
        'single': 'info',
        'multiple': 'purple',
        'judge': 'success',
        'blank': 'warning',
        'shortAnswer': 'primary'
      };
      const color = typeColors[question.type] || 'gray';

      // éš¾åº¦æ˜Ÿçº§
      const difficultyStars = 'â˜…'.repeat(question.difficulty || 1) + 'â˜†'.repeat(5 - (question.difficulty || 1));

      card.innerHTML = `
        <div class="flex items-start justify-between mb-3">
          <div class="flex items-center space-x-2">
            <span class="px-2 py-1 bg-${color}-100 text-${color}-600 text-xs font-medium rounded">${question.typeName || question.type}</span>
            <span class="text-xs text-gray-500">${question.id}</span>
          </div>
          <div class="flex items-center space-x-2">
            <span class="text-xs text-warning-500" title="éš¾åº¦">${difficultyStars}</span>
            <span class="text-xs text-gray-500">${question.score || 2}åˆ†</span>
          </div>
        </div>

        <div class="mb-3">
          <div class="flex items-start">
            <span class="text-sm font-medium text-gray-700 mr-2">${index}.</span>
            <div class="flex-1">
              <p class="text-sm text-gray-800 leading-relaxed">${question.content}</p>
            </div>
          </div>
        </div>

        ${question.options && question.options.length > 0 ? `
          <div class="space-y-1 mb-3">
            ${question.options.map(opt => `
              <div class="flex items-start text-xs text-gray-600">
                <span class="font-medium mr-2">${opt.label}.</span>
                <span>${opt.text}</span>
              </div>
            `).join('')}
          </div>
        ` : ''}

        <div class="flex items-center justify-between pt-3 border-t border-gray-100">
          <div class="flex items-center space-x-3 text-xs text-gray-500">
            <span><i class="fas fa-check-circle text-success-500 mr-1"></i>ç­”æ¡ˆ: ${Array.isArray(question.correctAnswers) ? question.correctAnswers.join(', ') : question.correctAnswers}</span>
            ${question.knowledgePath ? `<span><i class="fas fa-folder text-primary-500 mr-1"></i>${question.knowledgePath}</span>` : ''}
          </div>
          <button class="text-xs text-primary-500 hover:text-primary-600" onclick="alert('æŸ¥çœ‹è¯¦æƒ…åŠŸèƒ½å¾…å®ç°')">
            æŸ¥çœ‹è¯¦æƒ… <i class="fas fa-arrow-right ml-1"></i>
          </button>
        </div>
      `;

      return card;
    }

    // å¯¼å‡ºç”Ÿæˆçš„é¢˜ç›®
    function exportGeneratedQuestions() {
      const container = document.querySelector('.generated-questions-container');
      if (!container) {
        alert('æ²¡æœ‰å¯å¯¼å‡ºçš„é¢˜ç›®');
        return;
      }

      // è·å–å½“å‰ä»»åŠ¡ä¸­ä¿å­˜çš„ç”Ÿæˆå‚æ•°
      if (!currentTask || !currentTask.generatedQuestions) {
        alert('æ²¡æœ‰æ‰¾åˆ°ç”Ÿæˆçš„é¢˜ç›®æ•°æ®');
        return;
      }

      const questions = currentTask.generatedQuestions;
      const params = currentTask.generateParams;

      // æ„å»ºå¯¼å‡ºå†…å®¹
      let content = `# ç”Ÿæˆçš„${params.typeName}\n\n`;
      content += `ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}\n`;
      content += `é¢˜ç›®æ•°é‡ï¼š${questions.length}é“\n`;
      if (params.difficultyName) {
        content += `éš¾åº¦ï¼š${params.difficultyName}\n`;
      }
      if (params.knowledgePoint) {
        content += `çŸ¥è¯†ç‚¹ï¼š${params.knowledgePoint}\n`;
      }
      content += `\n---\n\n`;

      questions.forEach((q, index) => {
        content += `## é¢˜ç›® ${index + 1}\n\n`;
        content += `**é¢˜å‹**ï¼š${q.typeName}\n`;
        content += `**éš¾åº¦**ï¼š${q.difficultyName || 'æœªè®¾ç½®'}\n`;
        content += `**åˆ†å€¼**ï¼š${q.score || 2}åˆ†\n`;
        if (q.knowledgePath) {
          content += `**çŸ¥è¯†ç‚¹**ï¼š${q.knowledgePath}\n`;
        }
        content += `\n**é¢˜å¹²**ï¼š\n${q.content}\n\n`;

        if (q.options && q.options.length > 0) {
          content += `**é€‰é¡¹**ï¼š\n`;
          q.options.forEach(opt => {
            content += `${opt.label}. ${opt.text}\n`;
          });
          content += `\n`;
        }

        content += `**æ­£ç¡®ç­”æ¡ˆ**ï¼š${Array.isArray(q.correctAnswers) ? q.correctAnswers.join(', ') : q.correctAnswers}\n`;

        if (q.explanation) {
          content += `\n**è§£æ**ï¼š\n${q.explanation}\n`;
        }

        content += `\n---\n\n`;
      });

      // åˆ›å»ºä¸‹è½½
      const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ç”Ÿæˆçš„${params.typeName}_${new Date().getTime()}.md`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // æ·»åŠ AIæ¶ˆæ¯æç¤º
      addAIMessage(`âœ… å·²å¯¼å‡º${questions.length}é“${params.typeName}åˆ°Markdownæ–‡ä»¶`);
    }

    // å°†ç”Ÿæˆçš„é¢˜ç›®åŠ å…¥è¯•å·
    function addToExam() {
      if (!currentTask || !currentTask.generatedQuestions) {
        alert('æ²¡æœ‰æ‰¾åˆ°ç”Ÿæˆçš„é¢˜ç›®æ•°æ®');
        return;
      }

      const questions = currentTask.generatedQuestions;
      const params = currentTask.generateParams;

      // æ¨¡æ‹ŸåŠ å…¥è¯•å·çš„æ“ä½œ
      addAIMessage(`âœ… å·²å°†${questions.length}é“${params.typeName}åŠ å…¥è¯•å·è‰ç¨¿\n\næ‚¨å¯ä»¥ï¼š\nâ€¢ å‰å¾€"è¯•å·ç®¡ç†"æŸ¥çœ‹å’Œç¼–è¾‘\nâ€¢ ç»§ç»­ç”Ÿæˆæ›´å¤šé¢˜ç›®\nâ€¢ è°ƒæ•´é¢˜ç›®é¡ºåºå’Œåˆ†å€¼`);

      // è¿™é‡Œå¯ä»¥å°†é¢˜ç›®ä¿å­˜åˆ°LocalStorageçš„è¯•å·è‰ç¨¿ä¸­
      // å®é™…å®ç°æ—¶éœ€è¦ä¸è¯•å·æ¨¡å—é›†æˆ
      console.log('åŠ å…¥è¯•å·çš„é¢˜ç›®:', questions);
    }

    // ========== åˆå§‹åŒ– ==========
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
      setupEventListeners();
      loadTasksFromStorage();
      setupMobileTabs();
      setupTaskPanelToggle(); // è®¾ç½®ä»»åŠ¡é¢æ¿å±•å¼€/æ”¶èµ·
    });

    function initializeApp() {
      console.log('AIæ™ºèƒ½åŠ©æ‰‹åˆå§‹åŒ–...');

      // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
      const messageInput = document.getElementById('messageInput');
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });

      // æ‹–æ‹½ä¸Šä¼ 
      setupDragAndDrop();
    }

    // è®¾ç½®ä»»åŠ¡é¢æ¿å±•å¼€/æ”¶èµ·åŠŸèƒ½
    function setupTaskPanelToggle() {
      const taskPanel = document.getElementById('taskPanel');
      const toggleBtn = document.getElementById('toggleTaskPanel');
      const closeBtn = document.getElementById('closeTaskPanel');

      // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
      if (!taskPanel || !toggleBtn || !closeBtn) {
        console.error('ä»»åŠ¡é¢æ¿å…ƒç´ æœªæ‰¾åˆ°:', { taskPanel, toggleBtn, closeBtn });
        return;
      }

      let isTaskPanelVisible = false;

      // å±•å¼€/æ”¶èµ·ä»»åŠ¡é¢æ¿
      function toggleTaskPanel() {
        isTaskPanelVisible = !isTaskPanelVisible;

        if (isTaskPanelVisible) {
          // æ˜¾ç¤ºä»»åŠ¡é¢æ¿
          taskPanel.style.marginLeft = '0';
          taskPanel.style.opacity = '1';
          toggleBtn.title = 'éšè—å¯¹è¯åˆ—è¡¨';
        } else {
          // éšè—ä»»åŠ¡é¢æ¿
          taskPanel.style.marginLeft = '-20%';
          taskPanel.style.opacity = '0';
          toggleBtn.title = 'æ˜¾ç¤ºå¯¹è¯åˆ—è¡¨';
        }
      }

      // ç»‘å®šäº‹ä»¶
      toggleBtn.addEventListener('click', function(e) {
        e.preventDefault();
        toggleTaskPanel();
      });

      closeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        toggleTaskPanel();
      });

      console.log('ä»»åŠ¡é¢æ¿å±•å¼€/æ”¶èµ·åŠŸèƒ½å·²åˆå§‹åŒ–');
    }

    // ========== äº‹ä»¶ç›‘å¬ ==========
    function setupEventListeners() {
      // æ–°å»ºä»»åŠ¡
      const newTaskBtn = document.getElementById('newTaskBtn');
      if (newTaskBtn) {
        newTaskBtn.addEventListener('click', createNewTask);
      }

      // å‘é€æ¶ˆæ¯
      const sendBtn = document.getElementById('sendBtn');
      const messageInput = document.getElementById('messageInput');

      if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
      }

      if (messageInput) {
        messageInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
        console.log('æ¶ˆæ¯è¾“å…¥æ¡†äº‹ä»¶å·²ç»‘å®š');
      } else {
        console.error('messageInputå…ƒç´ æœªæ‰¾åˆ°');
      }

      // ä¸Šä¼ æ–‡æ¡£
      const uploadBtn = document.getElementById('uploadBtn');
      const fileInput = document.getElementById('fileInput');

      if (uploadBtn && fileInput) {
        uploadBtn.addEventListener('click', function() {
          fileInput.click();
        });
        fileInput.addEventListener('change', handleFileSelect);
      }

      // å¿«æ·æ“ä½œ
      document.querySelectorAll('.quick-action').forEach(btn => {
        btn.addEventListener('click', function() {
          const action = this.dataset.action;
          handleQuickAction(action);
        });
      });

      // ä»»åŠ¡ç­›é€‰ï¼ˆChatGPTæ¨¡å¼ä¸‹å·²ç§»é™¤ï¼‰
      // document.querySelectorAll('.filter-btn').forEach(btn => { ... });
    }

    // ========== æ‹–æ‹½ä¸Šä¼  ==========
    function setupDragAndDrop() {
      const messageInput = document.getElementById('messageInput');

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        messageInput.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        messageInput.addEventListener(eventName, function() {
          this.classList.add('border-primary-500', 'bg-primary-50');
        });
      });

      ['dragleave', 'drop'].forEach(eventName => {
        messageInput.addEventListener(eventName, function() {
          this.classList.remove('border-primary-500', 'bg-primary-50');
        });
      });

      messageInput.addEventListener('drop', function(e) {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFiles(files);
        }
      });
    }

    // ========== ä»»åŠ¡ç®¡ç† ==========
    function createNewTask() {
      // ç›´æ¥åˆ›å»ºé€šç”¨å¯¹è¯ä»»åŠ¡
      createTask('conversation');
    }

    // åˆ›å»ºä»»åŠ¡
    function createTask(taskType, skipWelcome = false) {
      const task = createTaskTemplate(taskType);

      if (!task) {
        console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼šæœªçŸ¥çš„ä»»åŠ¡ç±»å‹', taskType);
        return;
      }

      // æ·»åŠ åˆ°ä»»åŠ¡åˆ—è¡¨
      tasks.unshift(task); // æ–°ä»»åŠ¡æ”¾åœ¨æœ€å‰é¢

      // ä¿å­˜åˆ° LocalStorage
      saveTasksToStorage();

      // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
      renderTaskList();

      // åˆ‡æ¢åˆ°è¯¥ä»»åŠ¡
      loadTask(task);

      // å¦‚æœä¸è·³è¿‡æ¬¢è¿æ¶ˆæ¯ï¼Œåˆ™å‘é€æ¬¢è¿æ¶ˆæ¯
      if (!skipWelcome) {
        const typeInfo = getTaskTypeInfo(taskType);
        let welcomeMessage = `å¥½çš„ï¼æˆ‘å°†å¸®æ‚¨${typeInfo.name}ã€‚\n\n`;

        // æ ¹æ®ä»»åŠ¡ç±»å‹æä¾›å…·ä½“å¼•å¯¼
        switch (taskType) {
          case 'generate_questions':
            welcomeMessage += 'è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ç”Ÿæˆçš„é¢˜ç›®ä¿¡æ¯ï¼š\nâ€¢ é¢˜å‹ï¼ˆå•é€‰ã€å¤šé€‰ã€åˆ¤æ–­ã€å¡«ç©ºã€ç®€ç­”ï¼‰\nâ€¢ æ•°é‡ï¼ˆä¾‹å¦‚ï¼š10é“é¢˜ï¼‰\nâ€¢ éš¾åº¦ï¼ˆå¯é€‰ï¼‰\nâ€¢ çŸ¥è¯†ç‚¹ï¼ˆå¯é€‰ï¼‰';
            break;
          case 'create_paper':
            welcomeMessage += 'è¯·å‘Šè¯‰æˆ‘è¯•å·çš„åŸºæœ¬ä¿¡æ¯ï¼š\nâ€¢ è¯•å·åç§°ï¼ˆä¾‹å¦‚ï¼šã€ŠæœŸæœ«è€ƒè¯•ã€‹ï¼‰\nâ€¢ æ€»åˆ†ï¼ˆä¾‹å¦‚ï¼š100åˆ†ï¼‰';
            break;
          case 'create_exam':
            welcomeMessage += 'è¯·å‘Šè¯‰æˆ‘è€ƒè¯•çš„åŸºæœ¬ä¿¡æ¯ï¼š\nâ€¢ è€ƒè¯•åç§°ï¼ˆä¾‹å¦‚ï¼šã€ŠæœŸæœ«è€ƒè¯•ã€‹ï¼‰\nâ€¢ è€ƒè¯•æ—¶é•¿ï¼ˆä¾‹å¦‚ï¼š120åˆ†é’Ÿï¼‰';
            break;
          case 'create_practice':
            welcomeMessage += 'è¯·å‘Šè¯‰æˆ‘åˆ·é¢˜ä»»åŠ¡çš„åŸºæœ¬ä¿¡æ¯ï¼š\nâ€¢ ä»»åŠ¡åç§°ï¼ˆä¾‹å¦‚ï¼šã€Šæ¯æ—¥ç»ƒä¹ ã€‹ï¼‰\nâ€¢ é¢˜ç›®æ•°é‡ï¼ˆä¾‹å¦‚ï¼š20é“é¢˜ï¼‰';
            break;
          default:
            welcomeMessage += 'è¯·å‘Šè¯‰æˆ‘æ‚¨çš„å…·ä½“éœ€æ±‚ï¼Œæˆ‘ä¼šä¸€æ­¥æ­¥å¼•å¯¼æ‚¨å®Œæˆã€‚';
        }

        addAIMessage(welcomeMessage);
      }

      // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºè¿›è¡Œä¸­ï¼ˆå¦‚æœçŠ¶æ€ç³»ç»Ÿè¿˜åœ¨ä½¿ç”¨ï¼‰
      // updateTaskStatus(task.id, TASK_STATUS.IN_PROGRESS);
    }

    function loadTasksFromStorage() {
      try {
        const stored = localStorage.getItem('aiAssistantTasks');
        if (!stored) {
          console.log('æš‚æ— ä»»åŠ¡æ•°æ®');
          return;
        }

        const data = JSON.parse(stored);

        // ç‰ˆæœ¬æ£€æŸ¥
        if (data.version !== STORAGE_VERSION) {
          console.warn(`æ•°æ®ç‰ˆæœ¬ä¸åŒ¹é…ï¼ˆå½“å‰: ${STORAGE_VERSION}, å­˜å‚¨: ${data.version || 'æœªçŸ¥'}ï¼‰ï¼Œæ¸…ç©ºæ—§æ•°æ®`);
          localStorage.removeItem('aiAssistantTasks');
          return;
        }

        // æ•°æ®æ ¡éªŒ
        if (Array.isArray(data.tasks)) {
          tasks = data.tasks;
          renderTaskList();
          console.log(`æˆåŠŸåŠ è½½ ${tasks.length} ä¸ªä»»åŠ¡`);
        } else {
          console.error('ä»»åŠ¡æ•°æ®æ ¼å¼é”™è¯¯');
          localStorage.removeItem('aiAssistantTasks');
        }
      } catch (error) {
        console.error('åŠ è½½ä»»åŠ¡æ•°æ®å¤±è´¥:', error);
        localStorage.removeItem('aiAssistantTasks');
      }
    }

    function saveTasksToStorage() {
      try {
        const data = {
          version: STORAGE_VERSION,
          tasks: tasks,
          lastUpdate: new Date().toISOString()
        };
        localStorage.setItem('aiAssistantTasks', JSON.stringify(data));
        console.log('ä»»åŠ¡æ•°æ®å·²ä¿å­˜');
      } catch (error) {
        console.error('ä¿å­˜ä»»åŠ¡æ•°æ®å¤±è´¥:', error);
        // å¯èƒ½æ˜¯å­˜å‚¨ç©ºé—´ä¸è¶³
        if (error.name === 'QuotaExceededError') {
          alert('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†æµè§ˆå™¨æ•°æ®');
        }
      }
    }

    // æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨ï¼‰
    // function updateTaskStatus(taskId, status) { ... }

    // æ›´æ–°ä»»åŠ¡è¿›åº¦
    function updateTaskProgress(taskId, current, total) {
      const task = tasks.find(t => t.id === taskId);
      if (task) {
        task.progress = {
          current: current,
          total: total,
          percentage: Math.round((current / total) * 100)
        };
        saveTasksToStorage();
        renderTaskList();
      }
    }

    // åˆ é™¤ä»»åŠ¡
    function deleteTask(taskId) {
      showDeleteConfirmDialog(taskId);
    }

    // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
    function showDeleteConfirmDialog(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;

      const dialogHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="deleteConfirmDialog">
          <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4">
            <div class="p-6">
              <div class="flex items-start space-x-4">
                <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                  <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-gray-900">ç¡®è®¤åˆ é™¤ä»»åŠ¡</h3>
                  <p class="text-sm text-gray-600 mt-2">
                    ç¡®å®šè¦åˆ é™¤ä»»åŠ¡ <span class="font-medium text-gray-900">"${task.title}"</span> å—ï¼Ÿ
                  </p>
                  <p class="text-sm text-red-600 mt-2">
                    <i class="fas fa-info-circle"></i> å¯¹è¯å†å²å°†æ— æ³•æ¢å¤
                  </p>
                </div>
              </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 rounded-b-2xl flex justify-end space-x-3">
              <button
                class="px-4 py-2 text-gray-700 hover:text-gray-900 font-medium rounded-lg hover:bg-gray-200 transition-colors"
                onclick="closeDeleteConfirmDialog()"
              >
                å–æ¶ˆ
              </button>
              <button
                class="px-4 py-2 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600 transition-colors"
                onclick="confirmDeleteTask('${taskId}')"
              >
                ç¡®è®¤åˆ é™¤
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', dialogHTML);
    }

    // å…³é—­åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
    function closeDeleteConfirmDialog() {
      const dialog = document.getElementById('deleteConfirmDialog');
      if (dialog) {
        dialog.remove();
      }
    }

    // ç¡®è®¤åˆ é™¤ä»»åŠ¡
    function confirmDeleteTask(taskId) {
      closeDeleteConfirmDialog();

      tasks = tasks.filter(t => t.id !== taskId);
      saveTasksToStorage();
      renderTaskList();

      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä»»åŠ¡ï¼Œé‡ç½®å¯¹è¯é¢æ¿
      if (currentTask && currentTask.id === taskId) {
        currentTask = null;
        resetChatPanel();
      }
    }

    // é‡ç½®å¯¹è¯é¢æ¿
    function resetChatPanel() {
      document.getElementById('chatTitle').textContent = 'AIæ™ºèƒ½åŠ©æ‰‹';
      document.getElementById('chatSubtitle').textContent = 'é€‰æ‹©ä¸€ä¸ªä»»åŠ¡å¼€å§‹å¯¹è¯';

      // æ¸…ç©ºæ¶ˆæ¯ï¼ˆä¿ç•™æ¬¢è¿æ¶ˆæ¯ï¼‰
      const container = document.getElementById('messageContainer');
      while (container.children.length > 1) {
        container.removeChild(container.lastChild);
      }

      // éšè—å‚æ•°å¡ç‰‡
      const paramsCard = document.getElementById('paramsCard');
      if (paramsCard) {
        paramsCard.classList.add('hidden');
      }
    }

    // æ›´æ–°å‚æ•°å¡ç‰‡
    function updateParamsCard() {
      if (!currentTask) return;

      const paramsCard = document.getElementById('paramsCard');
      const paramsList = document.getElementById('paramsList');
      const paramsProgress = document.getElementById('paramsProgress');
      const paramsProgressBar = document.getElementById('paramsProgressBar');

      // æ˜¾ç¤ºå¡ç‰‡
      paramsCard.classList.remove('hidden');

      // è·å–å‚æ•°å®Œæ•´åº¦
      const manager = new ConversationManager(currentTask);
      const completeness = manager.getParamsCompleteness();

      // æ›´æ–°è¿›åº¦
      paramsProgress.textContent = `${completeness.percentage}%`;
      paramsProgressBar.style.width = `${completeness.percentage}%`;

      // æ¸²æŸ“å‚æ•°åˆ—è¡¨
      const params = currentTask.params || {};
      const paramLabels = {
        'questionType': 'é¢˜å‹',
        'questionTypeName': 'é¢˜å‹åç§°',
        'count': 'æ•°é‡',
        'difficulty': 'éš¾åº¦',
        'difficultyName': 'éš¾åº¦åç§°',
        'knowledge': 'çŸ¥è¯†ç‚¹',
        'paperName': 'è¯•å·åç§°',
        'totalScore': 'æ€»åˆ†',
        'examName': 'è€ƒè¯•åç§°',
        'duration': 'æ—¶é•¿',
        'practiceName': 'ä»»åŠ¡åç§°'
      };

      paramsList.innerHTML = '';

      Object.entries(params).forEach(([key, value]) => {
        // è·³è¿‡å†…éƒ¨å­—æ®µ
        if (key.endsWith('Name') && params[key.replace('Name', '')]) return;

        const label = paramLabels[key] || key;
        const displayValue = params[key + 'Name'] || value;

        const paramItem = document.createElement('div');
        paramItem.className = 'flex items-center justify-between text-sm';
        paramItem.innerHTML = `
          <span class="text-gray-600">${label}</span>
          <span class="font-medium text-gray-900">${displayValue}</span>
        `;
        paramsList.appendChild(paramItem);
      });

      // å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œæ˜¾ç¤ºæç¤º
      if (Object.keys(params).length === 0) {
        paramsList.innerHTML = '<p class="text-sm text-gray-400 text-center py-2">æš‚æ— å‚æ•°</p>';
      }
    }

    function renderTaskList() {
      const taskList = document.getElementById('taskList');
      const emptyState = document.getElementById('emptyState');

      if (tasks.length === 0) {
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');

      // æ¸…ç©ºç°æœ‰ä»»åŠ¡ï¼ˆä¿ç•™ç©ºçŠ¶æ€å…ƒç´ ï¼‰
      Array.from(taskList.children).forEach(child => {
        if (child.id !== 'emptyState') {
          child.remove();
        }
      });

      // æ¸²æŸ“ä»»åŠ¡å¡ç‰‡
      tasks.forEach(task => {
        const card = createTaskCard(task);
        taskList.appendChild(card);
      });
    }

    function createTaskCard(task) {
      const card = document.createElement('div');
      card.className = 'task-card p-3 bg-white border border-gray-200 rounded-lg cursor-pointer relative group';
      card.dataset.taskId = task.id;

      // é«˜äº®å½“å‰ä»»åŠ¡
      if (currentTask && currentTask.id === task.id) {
        card.classList.add('border-primary-500', 'bg-primary-50');
      }

      // const statusIcon = getStatusIcon(task.status); // ä¸å†æ˜¾ç¤ºçŠ¶æ€å›¾æ ‡
      const typeInfo = getTaskTypeInfo(task.type);
      const typeIcon = typeInfo ? typeInfo.icon : 'ğŸ’¬';

      card.innerHTML = `
        <div class="flex items-start space-x-2">
          <span class="text-lg flex-shrink-0">${typeIcon}</span>
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between">
              <h4 class="text-sm font-medium text-gray-900 truncate">${task.title}</h4>
            </div>
            <p class="text-xs text-gray-500 mt-1">${task.createTime}</p>
          </div>
        </div>
        <!-- åˆ é™¤æŒ‰é’®ï¼ˆæ‚¬åœæ˜¾ç¤ºï¼‰-->
        <button
          class="absolute top-2 right-2 w-6 h-6 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center hover:bg-red-600"
          onclick="event.stopPropagation(); deleteTask('${task.id}')"
          title="åˆ é™¤ä»»åŠ¡"
        >
          <i class="fas fa-times text-xs"></i>
        </button>
      `;

      card.addEventListener('click', function() {
        loadTask(task);
      });

      return card;
    }

    // getStatusIcon å’Œ getStatusColor å·²åœ¨å‰é¢æ³¨é‡Šï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨ï¼‰

    function loadTask(task) {
      currentTask = task;
      document.getElementById('chatTitle').textContent = task.title;
      document.getElementById('chatSubtitle').textContent = `åˆ›å»ºäº ${task.createTime}`;

      // åŠ è½½å¯¹è¯å†å²
      messages = task.messages || [];
      renderMessages();

      // æ›´æ–°å‚æ•°å¡ç‰‡ï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨ï¼‰
      // updateParamsCard();
    }

    // filterTasks å‡½æ•°å·²ç§»é™¤ï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†éœ€è¦çŠ¶æ€ç­›é€‰ï¼‰

    // ========== æ¶ˆæ¯å¤„ç† ==========
    function sendMessage() {
      const input = document.getElementById('messageInput');
      const content = input.value.trim();

      if (!content) return;

      // å¦‚æœæ²¡æœ‰å½“å‰ä»»åŠ¡ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°å¯¹è¯ï¼ˆè·³è¿‡æ¬¢è¿æ¶ˆæ¯ï¼‰
      if (!currentTask) {
        createTask('conversation', true); // ç¬¬äºŒä¸ªå‚æ•°ä¸ºtrueï¼Œè·³è¿‡æ¬¢è¿æ¶ˆæ¯
      }

      // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰ä»»åŠ¡çš„ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
      const isFirstMessage = !currentTask.messages || currentTask.messages.filter(m => m.role === 'user').length === 0;

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      addUserMessage(content);
      input.value = '';
      input.style.height = 'auto';

      // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ›´æ–°ä»»åŠ¡æ ‡é¢˜
      if (isFirstMessage) {
        const newTitle = generateTaskTitle(content);
        currentTask.title = newTitle;
        saveTasksToStorage();
        renderTaskList();

        // æ›´æ–°å¯¹è¯åŒºæ ‡é¢˜
        document.getElementById('chatTitle').textContent = newTitle;
      }

      // ç«‹å³å¤„ç†AIå“åº”ï¼ˆä¸å»¶è¿Ÿï¼‰
      setTimeout(() => {
        handleAIResponse(content);
      }, 500);
    }

    function addUserMessage(content) {
      const messageDiv = createMessageElement('user', content);
      document.getElementById('messageContainer').appendChild(messageDiv);
      scrollToBottom();

      // ä¿å­˜åˆ°å†å²
      messages.push({
        role: 'user',
        content: content,
        time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
      });
    }

    function addAIMessage(content) {
      const messageDiv = createMessageElement('ai', content);
      document.getElementById('messageContainer').appendChild(messageDiv);
      scrollToBottom();

      // ä¿å­˜åˆ°å†å²
      messages.push({
        role: 'ai',
        content: content,
        time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
      });
    }

    function createMessageElement(role, content) {
      const div = document.createElement('div');
      div.className = 'flex items-start space-x-3 message-enter';

      if (role === 'ai') {
        div.innerHTML = `
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary-500 to-info-500 flex items-center justify-center flex-shrink-0">
            <i class="fas fa-robot text-white text-sm"></i>
          </div>
          <div class="flex-1">
            <div class="bg-gray-100 rounded-lg rounded-tl-none p-4">
              <p class="text-gray-800 text-sm leading-relaxed whitespace-pre-wrap">${content}</p>
            </div>
            <p class="text-xs text-gray-400 mt-1">åˆšåˆš</p>
          </div>
        `;
      } else {
        div.innerHTML = `
          <div class="flex-1"></div>
          <div class="max-w-md">
            <div class="gradient-bg text-white rounded-lg rounded-tr-none p-4">
              <p class="text-sm leading-relaxed whitespace-pre-wrap">${content}</p>
            </div>
            <p class="text-xs text-gray-400 mt-1 text-right">åˆšåˆš</p>
          </div>
          <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center flex-shrink-0">
            <i class="fas fa-user text-white text-sm"></i>
          </div>
        `;
      }

      return div;
    }

    // åˆ›å»ºé€‰é¡¹æ¶ˆæ¯ï¼ˆAIæä¾›å¤šä¸ªé€‰é¡¹ä¾›ç”¨æˆ·é€‰æ‹©ï¼‰
    function createOptionsMessage(content, options, onSelect) {
      const div = document.createElement('div');
      div.className = 'flex items-start space-x-3 message-enter';

      const optionsHTML = options.map((option, index) => `
        <button
          class="option-btn w-full text-left px-4 py-3 border-2 border-gray-200 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-all"
          data-index="${index}"
        >
          <div class="flex items-center justify-between">
            <span class="text-sm text-gray-800">${option.label}</span>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
          </div>
          ${option.description ? `<p class="text-xs text-gray-500 mt-1">${option.description}</p>` : ''}
        </button>
      `).join('');

      div.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary-500 to-info-500 flex items-center justify-center flex-shrink-0">
          <i class="fas fa-robot text-white text-sm"></i>
        </div>
        <div class="flex-1">
          <div class="bg-gray-100 rounded-lg rounded-tl-none p-4">
            <p class="text-gray-800 text-sm leading-relaxed mb-3">${content}</p>
            <div class="space-y-2">
              ${optionsHTML}
            </div>
          </div>
          <p class="text-xs text-gray-400 mt-1">åˆšåˆš</p>
        </div>
      `;

      // ç»‘å®šé€‰é¡¹ç‚¹å‡»äº‹ä»¶
      div.querySelectorAll('.option-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.dataset.index);
          onSelect(options[index], index);
        });
      });

      return div;
    }

    // åˆ›å»ºç¡®è®¤æ¶ˆæ¯ï¼ˆAIè¯·æ±‚ç”¨æˆ·ç¡®è®¤ï¼‰
    function createConfirmMessage(content, onConfirm, onCancel) {
      const div = document.createElement('div');
      div.className = 'flex items-start space-x-3 message-enter';

      div.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary-500 to-info-500 flex items-center justify-center flex-shrink-0">
          <i class="fas fa-robot text-white text-sm"></i>
        </div>
        <div class="flex-1">
          <div class="bg-gray-100 rounded-lg rounded-tl-none p-4">
            <p class="text-gray-800 text-sm leading-relaxed mb-3">${content}</p>
            <div class="flex space-x-2">
              <button class="confirm-btn flex-1 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors text-sm font-medium">
                ç¡®è®¤
              </button>
              <button class="cancel-btn flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm font-medium">
                å–æ¶ˆ
              </button>
            </div>
          </div>
          <p class="text-xs text-gray-400 mt-1">åˆšåˆš</p>
        </div>
      `;

      // ç»‘å®šæŒ‰é’®äº‹ä»¶
      div.querySelector('.confirm-btn').addEventListener('click', onConfirm);
      div.querySelector('.cancel-btn').addEventListener('click', onCancel);

      return div;
    }

    // åˆ›å»ºè¿›åº¦æ¶ˆæ¯ï¼ˆæ˜¾ç¤ºä»»åŠ¡è¿›åº¦ï¼‰
    function createProgressMessage(content, progress) {
      const div = document.createElement('div');
      div.className = 'flex items-start space-x-3 message-enter';

      const percentage = progress.total > 0 ? Math.round((progress.current / progress.total) * 100) : 0;

      div.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary-500 to-info-500 flex items-center justify-center flex-shrink-0">
          <i class="fas fa-robot text-white text-sm"></i>
        </div>
        <div class="flex-1">
          <div class="bg-gray-100 rounded-lg rounded-tl-none p-4">
            <p class="text-gray-800 text-sm leading-relaxed mb-3">${content}</p>
            <div class="space-y-2">
              <div class="flex items-center justify-between text-xs text-gray-600">
                <span>${progress.label || 'è¿›åº¦'}</span>
                <span class="font-medium">${progress.current}/${progress.total} (${percentage}%)</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-primary-500 h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
              </div>
            </div>
          </div>
          <p class="text-xs text-gray-400 mt-1">åˆšåˆš</p>
        </div>
      `;

      return div;
    }

    function renderMessages() {
      const container = document.getElementById('messageContainer');
      // æ¸…ç©ºï¼ˆä¿ç•™æ¬¢è¿æ¶ˆæ¯ï¼‰
      while (container.children.length > 1) {
        container.removeChild(container.lastChild);
      }

      messages.forEach(msg => {
        const messageDiv = createMessageElement(msg.role, msg.content);
        container.appendChild(messageDiv);
      });

      scrollToBottom();
    }

    function scrollToBottom() {
      const container = document.getElementById('messageContainer');
      container.scrollTop = container.scrollHeight;
    }

    function handleAIResponse(userMessage) {
      // ä½¿ç”¨å¯¹è¯ç®¡ç†å™¨å¤„ç†ç”¨æˆ·è¾“å…¥
      const manager = new ConversationManager(currentTask);
      const response = manager.processUserInput(userMessage);

      // æ·»åŠ AIå“åº”
      addAIMessage(response);

      // æ›´æ–°å‚æ•°å¡ç‰‡ï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨ï¼‰
      // updateParamsCard();

      // ä¿å­˜å¯¹è¯å†å²
      saveTasksToStorage();
    }

    // ========== å¿«æ·æ“ä½œ ==========
    function handleQuickAction(action) {
      const actions = {
        'generate': 'æˆ‘æƒ³ç”Ÿæˆé¢˜ç›®',
        'paper': 'å¸®æˆ‘æ™ºèƒ½ç»„å·',
        'exam': 'åˆ›å»ºä¸€åœºè€ƒè¯•',
        'practice': 'åˆ›å»ºåˆ·é¢˜ä»»åŠ¡'
      };

      const message = actions[action];
      if (message) {
        document.getElementById('messageInput').value = message;
        sendMessage();
      }
    }

    // ========== æ–‡ä»¶å¤„ç† ==========
    function handleFileSelect(e) {
      const files = e.target.files;
      if (files.length > 0) {
        handleFiles(files);
      }
    }

    function handleFiles(files) {
      Array.from(files).forEach(file => {
        const fileName = file.name;
        const fileSize = (file.size / 1024).toFixed(2) + ' KB';

        addUserMessage(`ğŸ“ ä¸Šä¼ æ–‡æ¡£ï¼š${fileName} (${fileSize})`);

        setTimeout(() => {
          addAIMessage(`âœ… æ–‡æ¡£ "${fileName}" ä¸Šä¼ æˆåŠŸï¼\n\næ­£åœ¨è§£ææ–‡æ¡£å†…å®¹...`);
        }, 500);
      });
    }

    // ========== ç§»åŠ¨ç«¯Tabåˆ‡æ¢ ==========
    function setupMobileTabs() {
      const tabButtons = document.querySelectorAll('.tab-btn');
      const panels = document.querySelectorAll('.panel');

      // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
      if (tabButtons.length === 0 || panels.length === 0) {
        console.warn('ç§»åŠ¨ç«¯Tabå…ƒç´ æœªæ‰¾åˆ°ï¼Œå¯èƒ½åœ¨æ¡Œé¢ç«¯è¿è¡Œ');
        return;
      }

      tabButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          const targetPanel = this.dataset.panel;
          const targetElement = document.getElementById(targetPanel);

          // æ£€æŸ¥ç›®æ ‡é¢æ¿æ˜¯å¦å­˜åœ¨
          if (!targetElement) {
            console.error(`é¢æ¿ ${targetPanel} æœªæ‰¾åˆ°`);
            return;
          }

          // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
          tabButtons.forEach(b => b.classList.remove('active'));
          panels.forEach(p => p.classList.remove('active'));

          // æ¿€æ´»å½“å‰Tabå’Œé¢æ¿
          this.classList.add('active');
          targetElement.classList.add('active');
        });
      });
    }

    // ============================================
    // SmartParamExtractor æµ‹è¯•
    // ============================================
    function testSmartParamExtractor() {
      const extractor = new SmartParamExtractor();
      const tests = [
        {
          input: 'ç”Ÿæˆ10é“å•é€‰é¢˜',
          expected: { type: 'single', count: 10 }
        },
        {
          input: 'æ¥ç‚¹æ‰€æœ‰é¢˜å‹',
          expected: { type: 'all', count: 10 }
        },
        {
          input: '5é“ä¸­ç­‰éš¾åº¦çš„åˆ¤æ–­é¢˜',
          expected: { type: 'judge', count: 5, difficulty: 2 }
        },
        {
          input: 'ç”Ÿæˆå…³äºæ•°æ®ç»“æ„çš„ç®€å•é¢˜ç›®',
          expected: { knowledgePoint: 'æ•°æ®ç»“æ„', difficulty: 1 }
        },
        {
          input: 'æ¥ç‚¹å¤šé€‰é¢˜ï¼Œå¤šä¸€äº›',
          expected: { type: 'multiple', count: 15 }
        }
      ];

      console.log('=== SmartParamExtractor æµ‹è¯•å¼€å§‹ ===');
      let passed = 0;
      let failed = 0;

      tests.forEach((test, index) => {
        const result = extractor.extract(test.input);
        let testPassed = true;

        for (const [key, value] of Object.entries(test.expected)) {
          if (result.params[key] !== value) {
            testPassed = false;
            console.error(`æµ‹è¯• ${index + 1} å¤±è´¥:`, test.input);
            console.error(`  æœŸæœ› ${key}=${value}, å®é™… ${key}=${result.params[key]}`);
          }
        }

        if (testPassed) {
          passed++;
          console.log(`âœ“ æµ‹è¯• ${index + 1} é€šè¿‡:`, test.input);
        } else {
          failed++;
        }
      });

      console.log(`=== æµ‹è¯•å®Œæˆ: ${passed} é€šè¿‡, ${failed} å¤±è´¥ ===`);
      return { passed, failed };
    }

    // ============================================
    // UserPreferenceManager è¾…åŠ©æ–¹æ³•æµ‹è¯•
    // ============================================
    function testUserPreferenceHelperMethods() {
      console.log('\n=== UserPreferenceManager è¾…åŠ©æ–¹æ³•æµ‹è¯•å¼€å§‹ ===');
      const manager = new UserPreferenceManager();
      let passed = 0;
      let failed = 0;

      // æµ‹è¯•1: isWeekend() - å‘¨æœ«æ£€æµ‹
      console.log('\n--- æµ‹è¯• isWeekend() ---');
      const weekendTests = [
        { day: 0, expected: true, name: 'å‘¨æ—¥' },
        { day: 1, expected: false, name: 'å‘¨ä¸€' },
        { day: 5, expected: false, name: 'å‘¨äº”' },
        { day: 6, expected: true, name: 'å‘¨å…­' }
      ];

      weekendTests.forEach(test => {
        const result = manager.isWeekend(test.day);
        if (result === test.expected) {
          console.log(`âœ“ ${test.name} (${test.day}): ${result}`);
          passed++;
        } else {
          console.error(`âœ— ${test.name} (${test.day}): æœŸæœ› ${test.expected}, å®é™… ${result}`);
          failed++;
        }
      });

      // æµ‹è¯•2: getTimePattern() - æ—¶é—´æ¨¡å¼è·å–
      console.log('\n--- æµ‹è¯• getTimePattern() ---');
      const timePatternTests = [
        { date: new Date('2026-02-01'), expected: 'weekend', name: 'å‘¨å…­' },
        { date: new Date('2026-02-02'), expected: 'weekend', name: 'å‘¨æ—¥' },
        { date: new Date('2026-02-03'), expected: 'weekday', name: 'å‘¨ä¸€' },
        { date: new Date('2026-02-05'), expected: 'weekday', name: 'å‘¨ä¸‰' }
      ];

      timePatternTests.forEach(test => {
        const result = manager.getTimePattern(test.date);
        if (result === test.expected) {
          console.log(`âœ“ ${test.name}: ${result}`);
          passed++;
        } else {
          console.error(`âœ— ${test.name}: æœŸæœ› ${test.expected}, å®é™… ${result}`);
          failed++;
        }
      });

      // æµ‹è¯•3: getTrendingKnowledgePoint() - çƒ­é—¨çŸ¥è¯†ç‚¹
      console.log('\n--- æµ‹è¯• getTrendingKnowledgePoint() ---');

      // 3.1 ç©ºæ•°ç»„æµ‹è¯•
      let trending = manager.getTrendingKnowledgePoint();
      if (trending === null) {
        console.log('âœ“ ç©ºæ•°ç»„è¿”å› null');
        passed++;
      } else {
        console.error(`âœ— ç©ºæ•°ç»„: æœŸæœ› null, å®é™… ${trending}`);
        failed++;
      }

      // 3.2 æ·»åŠ æ•°æ®åæµ‹è¯•
      manager.preferences.behaviorPatterns.knowledgePointFocus.recent = [
        { knowledgePoint: 'æ•°æ®ç»“æ„', timestamp: '2026-02-01T10:00:00' },
        { knowledgePoint: 'ç®—æ³•', timestamp: '2026-02-01T11:00:00' },
        { knowledgePoint: 'æ•°æ®ç»“æ„', timestamp: '2026-02-01T12:00:00' },
        { knowledgePoint: 'æ•°æ®ç»“æ„', timestamp: '2026-02-01T13:00:00' },
        { knowledgePoint: 'ç®—æ³•', timestamp: '2026-02-01T14:00:00' }
      ];

      trending = manager.getTrendingKnowledgePoint();
      if (trending === 'æ•°æ®ç»“æ„') {
        console.log('âœ“ æ­£ç¡®è¯†åˆ«æœ€é¢‘ç¹çŸ¥è¯†ç‚¹: æ•°æ®ç»“æ„');
        passed++;
      } else {
        console.error(`âœ— æœŸæœ› "æ•°æ®ç»“æ„", å®é™… "${trending}"`);
        failed++;
      }

      // æµ‹è¯•4: updateCommonCombinations() - æ›´æ–°å¸¸ç”¨ç»„åˆ
      console.log('\n--- æµ‹è¯• updateCommonCombinations() ---');

      // 4.1 æ·»åŠ æ–°ç»„åˆ
      manager.updateCommonCombinations({ type: 'single', difficulty: 2, count: 10 });
      const combinations = manager.preferences.behaviorPatterns.commonCombinations;
      if (combinations.length === 1 && combinations[0].frequency === 1) {
        console.log('âœ“ æˆåŠŸæ·»åŠ æ–°ç»„åˆ');
        passed++;
      } else {
        console.error('âœ— æ·»åŠ æ–°ç»„åˆå¤±è´¥');
        failed++;
      }

      // 4.2 å¢åŠ å·²å­˜åœ¨ç»„åˆçš„é¢‘ç‡
      manager.updateCommonCombinations({ type: 'single', difficulty: 2, count: 10 });
      if (combinations.length === 1 && combinations[0].frequency === 2) {
        console.log('âœ“ æˆåŠŸå¢åŠ ç»„åˆé¢‘ç‡');
        passed++;
      } else {
        console.error(`âœ— å¢åŠ é¢‘ç‡å¤±è´¥: æœŸæœ› frequency=2, å®é™… ${combinations[0].frequency}`);
        failed++;
      }

      // 4.3 æ·»åŠ å¤šä¸ªç»„åˆå¹¶æµ‹è¯•æ’åº
      manager.updateCommonCombinations({ type: 'multiple', difficulty: 3, count: 5 });
      manager.updateCommonCombinations({ type: 'judge', difficulty: 1, count: 20 });
      manager.updateCommonCombinations({ type: 'judge', difficulty: 1, count: 20 });
      manager.updateCommonCombinations({ type: 'judge', difficulty: 1, count: 20 });

      if (combinations[0].type === 'judge' && combinations[0].frequency === 3) {
        console.log('âœ“ ç»„åˆæŒ‰é¢‘ç‡æ­£ç¡®æ’åº');
        passed++;
      } else {
        console.error('âœ— ç»„åˆæ’åºå¤±è´¥');
        failed++;
      }

      // 4.4 æµ‹è¯•æœ€å¤šä¿ç•™5ä¸ªç»„åˆ
      manager.updateCommonCombinations({ type: 'fill', difficulty: 2, count: 8 });
      manager.updateCommonCombinations({ type: 'essay', difficulty: 4, count: 3 });
      manager.updateCommonCombinations({ type: 'cloze', difficulty: 3, count: 12 });

      if (combinations.length <= 5) {
        console.log(`âœ“ æ­£ç¡®é™åˆ¶ç»„åˆæ•°é‡: ${combinations.length} <= 5`);
        passed++;
      } else {
        console.error(`âœ— ç»„åˆæ•°é‡è¶…é™: ${combinations.length} > 5`);
        failed++;
      }

      // æµ‹è¯•5: updateBehaviorPatterns() é‡æ„éªŒè¯
      console.log('\n--- æµ‹è¯• updateBehaviorPatterns() é‡æ„ ---');

      // é‡ç½®æ•°æ®
      manager.preferences.behaviorPatterns.knowledgePointFocus.recent = [];
      manager.preferences.behaviorPatterns.commonCombinations = [];

      // è°ƒç”¨é‡æ„åçš„æ–¹æ³•
      manager.updateBehaviorPatterns({
        type: 'single',
        difficulty: 2,
        count: 10,
        knowledgePoint: 'æ“ä½œç³»ç»Ÿ',
        timestamp: new Date('2026-02-03T10:00:00') // å‘¨ä¸€
      });

      const patterns = manager.preferences.behaviorPatterns;

      // éªŒè¯æ—¶é—´æ¨¡å¼æ›´æ–°
      if (patterns.timePatterns.weekday.samples === 1) {
        console.log('âœ“ å·¥ä½œæ—¥æ ·æœ¬æ•°æ­£ç¡®æ›´æ–°');
        passed++;
      } else {
        console.error('âœ— å·¥ä½œæ—¥æ ·æœ¬æ•°æ›´æ–°å¤±è´¥');
        failed++;
      }

      // éªŒè¯çŸ¥è¯†ç‚¹è®°å½•
      if (patterns.knowledgePointFocus.recent.length === 1 &&
          patterns.knowledgePointFocus.recent[0].knowledgePoint === 'æ“ä½œç³»ç»Ÿ') {
        console.log('âœ“ çŸ¥è¯†ç‚¹æ­£ç¡®è®°å½•');
        passed++;
      } else {
        console.error('âœ— çŸ¥è¯†ç‚¹è®°å½•å¤±è´¥');
        failed++;
      }

      // éªŒè¯trendingæ›´æ–°
      if (patterns.knowledgePointFocus.trending === 'æ“ä½œç³»ç»Ÿ') {
        console.log('âœ“ trendingçŸ¥è¯†ç‚¹æ­£ç¡®æ›´æ–°');
        passed++;
      } else {
        console.error('âœ— trendingçŸ¥è¯†ç‚¹æ›´æ–°å¤±è´¥');
        failed++;
      }

      // éªŒè¯ç»„åˆæ›´æ–°
      if (patterns.commonCombinations.length === 1 &&
          patterns.commonCombinations[0].type === 'single') {
        console.log('âœ“ å¸¸ç”¨ç»„åˆæ­£ç¡®æ›´æ–°');
        passed++;
      } else {
        console.error('âœ— å¸¸ç”¨ç»„åˆæ›´æ–°å¤±è´¥');
        failed++;
      }

      console.log(`\n=== æµ‹è¯•å®Œæˆ: ${passed} é€šè¿‡, ${failed} å¤±è´¥ ===`);
      return { passed, failed };
    }

    // è‡ªåŠ¨è¿è¡Œæµ‹è¯•ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
    if (window.location.search.includes('test=true')) {
      window.addEventListener('DOMContentLoaded', () => {
        testSmartParamExtractor();
        testUserPreferenceHelperMethods();
      });
    }
  </script>
</body>
</html>
