<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è€ƒè¯•åŠ©æ‰‹ - è€ƒè¯•ç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#E6F9F0', 500: '#00B96B', 600: '#00A35C' },
            success: { 50: '#E8FFEA', 500: '#00B42A' },
            warning: { 50: '#FFF7E8', 500: '#FF7D00' },
            error: { 50: '#FFECE8', 500: '#F53F3F' },
            info: { 50: '#E8F7FF', 500: '#14C9C9' }
          }
        }
      }
    }
  </script>
  <style>
    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f9fafb;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    /* ä»»åŠ¡å¡ç‰‡åŠ¨ç”» */
    .task-card {
      transition: all 0.2s ease;
    }
    .task-card:hover {
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0, 185, 107, 0.15);
    }

    /* æ¶ˆæ¯åŠ¨ç”» */
    .message-enter {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* AIæŒ‰é’®é—ªçƒåŠ¨ç”» */
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
    .ai-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    /* å‚æ•°å¡ç‰‡æµ®åŠ¨ */
    .params-card {
      position: sticky;
      top: 20px;
      z-index: 10;
    }

    /* æ¸å˜èƒŒæ™¯ */
    .gradient-bg {
      background: linear-gradient(135deg, #00B96B 0%, #14C9C9 100%);
    }

    /* å“åº”å¼è®¾è®¡ */
    /* ç§»åŠ¨ç«¯åº•éƒ¨Tabæ  */
    .mobile-tab-bar {
      display: none;
    }

    /* ç§»åŠ¨ç«¯ï¼ˆ<768pxï¼‰*/
    @media (max-width: 767px) {
      /* æ˜¾ç¤ºåº•éƒ¨Tabæ  */
      .mobile-tab-bar {
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #e5e7eb;
        z-index: 50;
        height: 60px;
      }

      /* ä¸»å†…å®¹åŒºåº•éƒ¨ç•™å‡ºTabæ ç©ºé—´ */
      .main-content {
        padding-bottom: 60px;
      }

      /* é»˜è®¤éšè—æ‰€æœ‰é¢æ¿ */
      .panel {
        display: none !important;
      }

      /* æ¿€æ´»çš„é¢æ¿æ˜¾ç¤º */
      .panel.active {
        display: flex !important;
        width: 100% !important;
      }

      /* ç§»åŠ¨ç«¯æ¶ˆæ¯è¾“å…¥åŒºè°ƒæ•´ */
      #messageInput {
        font-size: 16px; /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
      }
    }

    /* å¹³æ¿ç«¯ï¼ˆ768px-1023pxï¼‰*/
    @media (min-width: 768px) and (max-width: 1023px) {
      /* å·¦æ æŠ˜å ä¸ºä¾§è¾¹æ  */
      aside {
        position: fixed;
        left: -100%;
        top: 64px;
        bottom: 0;
        width: 280px;
        z-index: 40;
        transition: left 0.3s ease;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
      }

      aside.open {
        left: 0;
      }

      /* ä¸­æ å’Œå³æ è°ƒæ•´ */
      main {
        width: 50% !important;
      }

      section {
        width: 50% !important;
      }

      /* æ·»åŠ ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® */
      .sidebar-toggle {
        display: block;
      }
    }

    /* æ¡Œé¢ç«¯ï¼ˆ>=1024pxï¼‰*/
    @media (min-width: 1024px) {
      .sidebar-toggle {
        display: none;
      }
    }

    /* TabæŒ‰é’®æ ·å¼ */
    .tab-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #9ca3af;
      transition: all 0.2s;
      border-top: 2px solid transparent;
    }

    .tab-btn.active {
      color: #00B96B;
      border-top-color: #00B96B;
    }

    .tab-btn i {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .tab-btn span {
      font-size: 12px;
    }

    /* ========== æ–‡æ¡£å¡ç‰‡æ ·å¼ ========== */
    .document-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }

    .document-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border-color: #00B96B;
    }

    .document-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #6b7280;
    }

    .document-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .document-status.parsing {
      background: #FFF7E8;
      color: #FF7D00;
    }

    .document-status.success {
      background: #E8FFEA;
      color: #00B42A;
    }

    .document-status.error {
      background: #FFECE8;
      color: #F53F3F;
    }

    .document-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f3f4f6;
    }

    .doc-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 13px;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .doc-action-btn:hover {
      background: #ffffff;
      border-color: #00B96B;
      color: #00B96B;
      transform: translateY(-1px);
    }

    .doc-action-btn i {
      font-size: 12px;
    }

    /* æ–‡ä»¶ä¸Šä¼ æ‹–æ‹½åŒºåŸŸ */
    .drag-over {
      border-color: #00B96B !important;
      background-color: rgba(0, 185, 107, 0.05) !important;
    }

    /* éšè—çš„æ–‡ä»¶è¾“å…¥ */
    #fileInput {
      display: none;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <header class="h-16 bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
    <div class="flex items-center justify-between h-full px-6">
      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-2">
          <div class="w-8 h-8 bg-primary-500 rounded flex items-center justify-center">
            <i class="fas fa-graduation-cap text-white"></i>
          </div>
          <span class="text-xl font-semibold text-gray-900">è€ƒè¯•ç³»ç»Ÿ</span>
        </div>
        <nav class="hidden md:flex items-center space-x-2 text-sm text-gray-600">
          <a href="dashboard.html" class="hover:text-primary-500">é¦–é¡µ</a>
          <i class="fas fa-chevron-right text-xs text-gray-400"></i>
          <span class="text-gray-900 font-medium">è€ƒè¯•åŠ©æ‰‹</span>
        </nav>
      </div>
      <div class="flex items-center space-x-4">
        <!-- AIåŠ©æ‰‹æŒ‰é’®ï¼ˆå½“å‰é¡µé¢ï¼‰ -->
        <div class="px-4 py-2 bg-gradient-to-r from-primary-500 to-info-500 text-white rounded-lg flex items-center space-x-2">
          <i class="fas fa-robot"></i>
          <span class="text-sm font-medium">AIåŠ©æ‰‹</span>
        </div>
        <button class="px-4 py-2 text-sm text-gray-700 hover:text-primary-500 transition-colors">
          <i class="fas fa-question-circle mr-1"></i>
          å¸®åŠ©
        </button>
        <img src="https://via.placeholder.com/32" alt="ç”¨æˆ·" class="w-8 h-8 rounded-full">
        <span class="text-sm text-gray-700 font-medium">ç®¡ç†å‘˜</span>
      </div>
    </div>
  </header>

  <!-- ä¸»å†…å®¹åŒº -->
  <div class="pt-16 h-screen flex main-content">
    <!-- å·¦ä¾§ï¼šä»»åŠ¡å¡ç‰‡åˆ—è¡¨ (é»˜è®¤éšè—) -->
    <aside class="panel w-1/5 bg-white border-r border-gray-200 flex flex-col transition-all duration-300" id="taskPanel" style="margin-left: -20%; opacity: 0;">
      <!-- ä»»åŠ¡åˆ—è¡¨æ ‡é¢˜ -->
      <div class="p-4 border-b border-gray-200 flex-shrink-0">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-semibold text-gray-900">å¯¹è¯åˆ—è¡¨</h3>
          <button id="closeTaskPanel" class="p-1 text-gray-400 hover:text-gray-600 transition-colors" title="æ”¶èµ·">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="flex items-center space-x-2">
          <button id="batchDeleteBtn" class="flex-1 px-3 py-1.5 bg-red-50 text-red-600 rounded text-xs hover:bg-red-100 transition-colors">
            <i class="fas fa-trash-alt mr-1"></i>æ‰¹é‡åˆ é™¤
          </button>
          <button id="cancelBatchBtn" class="hidden flex-1 px-3 py-1.5 bg-gray-100 text-gray-600 rounded text-xs hover:bg-gray-200 transition-colors">
            å–æ¶ˆ
          </button>
        </div>
      </div>

      <!-- ä»»åŠ¡åˆ—è¡¨ï¼ˆå¯æ»šåŠ¨åŒºåŸŸï¼‰-->
      <div id="taskList" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-3">
        <!-- ç©ºçŠ¶æ€ -->
        <div id="emptyState" class="flex flex-col items-center justify-center h-full text-center text-gray-400">
          <i class="fas fa-inbox text-5xl mb-4"></i>
          <p class="text-sm">æš‚æ— ä»»åŠ¡</p>
          <p class="text-xs mt-2 max-w-[200px]">åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ç›´æ¥å‘Šè¯‰æˆ‘æ‚¨æƒ³åšä»€ä¹ˆ</p>
        </div>
      </div>

      <!-- åº•éƒ¨æ–°å»ºä»»åŠ¡æŒ‰é’®ï¼ˆå›ºå®šï¼‰-->
      <div class="p-4 border-t border-gray-200 bg-white flex-shrink-0">
        <button id="newTaskBtn" class="w-full px-4 py-3 gradient-bg text-white rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center space-x-2 shadow-lg">
          <i class="fas fa-plus"></i>
          <span class="font-medium">æ–°å»ºä»»åŠ¡</span>
        </button>
      </div>
    </aside>

    <!-- ä¸­é—´ï¼šå¯¹è¯åŒºåŸŸ (é»˜è®¤å æ®æ›´å¤šç©ºé—´) -->
    <main class="panel active flex-1 bg-white flex flex-col transition-all duration-300" id="chatPanel">
      <!-- å¯¹è¯æ ‡é¢˜æ  -->
      <div class="h-14 px-6 border-b border-gray-200 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <!-- å±•å¼€ä»»åŠ¡åˆ—è¡¨æŒ‰é’® -->
          <button id="toggleTaskPanel" class="p-2 text-gray-500 hover:text-primary-500 hover:bg-primary-50 rounded transition-colors" title="æ˜¾ç¤ºå¯¹è¯åˆ—è¡¨">
            <i class="fas fa-bars"></i>
          </button>
          <div>
            <h2 id="chatTitle" class="text-lg font-semibold text-gray-900">è€ƒè¯•åŠ©æ‰‹</h2>
            <p id="chatSubtitle" class="text-xs text-gray-500">é€‰æ‹©ä¸€ä¸ªä»»åŠ¡å¼€å§‹å¯¹è¯</p>
          </div>
        </div>
      </div>

      <!-- å¯¹è¯æ¶ˆæ¯åŒº -->
      <div id="messageContainer" class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-4">
        <!-- æ¬¢è¿æ¶ˆæ¯ -->
        <div class="flex items-start space-x-3">
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary-500 to-info-500 flex items-center justify-center flex-shrink-0">
            <i class="fas fa-robot text-white text-sm"></i>
          </div>
          <div class="flex-1">
            <div class="bg-gray-100 rounded-lg rounded-tl-none p-4">
              <p class="text-gray-800 text-sm leading-relaxed">æ‚¨å¥½ï¼æˆ‘æ˜¯è€ƒè¯•åŠ©æ‰‹ ğŸ¤–</p>
              <p class="text-gray-800 text-sm leading-relaxed mt-2">æˆ‘å¯ä»¥å¸®æ‚¨ï¼š</p>
              <ul class="mt-2 space-y-1 text-sm text-gray-700">
                <li class="flex items-center">
                  <i class="fas fa-check text-primary-500 mr-2 text-xs"></i>
                  ç”Ÿæˆé¢˜ç›®å’Œè¯•å·
                </li>
                <li class="flex items-center">
                  <i class="fas fa-check text-primary-500 mr-2 text-xs"></i>
                  åˆ›å»ºå’Œç®¡ç†è€ƒè¯•
                </li>
                <li class="flex items-center">
                  <i class="fas fa-check text-primary-500 mr-2 text-xs"></i>
                  å‘å¸ƒåˆ·é¢˜ä»»åŠ¡
                </li>
                <li class="flex items-center">
                  <i class="fas fa-check text-primary-500 mr-2 text-xs"></i>
                  è§£ç­”æ‚¨çš„é—®é¢˜
                </li>
              </ul>
              <p class="text-gray-600 text-xs mt-3 pt-3 border-t border-gray-200">
                ğŸ’¡ ç›´æ¥å‘Šè¯‰æˆ‘æ‚¨æƒ³åšä»€ä¹ˆï¼Œæˆ‘ä¼šå°½åŠ›å¸®åŠ©æ‚¨ï¼
              </p>
            </div>
            <p class="text-xs text-gray-400 mt-1">åˆšåˆš</p>
          </div>
        </div>
      </div>

      <!-- å¿«æ·æç¤ºè¯ -->
      <div id="quickActions" class="px-6 py-3 border-t border-gray-100">
        <div class="flex items-center space-x-2 overflow-x-auto custom-scrollbar">
          <button class="quick-action px-3 py-1.5 bg-primary-50 text-primary-600 rounded-full text-sm whitespace-nowrap hover:bg-primary-100 transition-colors" data-action="generate">
            <i class="far fa-file-alt mr-1"></i>ç”Ÿæˆé¢˜ç›®
          </button>
          <button class="quick-action px-3 py-1.5 bg-info-50 text-info-600 rounded-full text-sm whitespace-nowrap hover:bg-info-100 transition-colors" data-action="paper">
            <i class="far fa-copy mr-1"></i>æ™ºèƒ½ç»„å·
          </button>
          <button class="quick-action px-3 py-1.5 bg-warning-50 text-warning-600 rounded-full text-sm whitespace-nowrap hover:bg-warning-100 transition-colors" data-action="exam">
            <i class="far fa-calendar-check mr-1"></i>åˆ›å»ºè€ƒè¯•
          </button>
          <button class="quick-action px-3 py-1.5 bg-purple-50 text-purple-600 rounded-full text-sm whitespace-nowrap hover:bg-purple-100 transition-colors" data-action="practice">
            <i class="far fa-edit mr-1"></i>åˆ·é¢˜ä»»åŠ¡
          </button>
        </div>
      </div>

      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="px-6 py-4 border-t border-gray-200">
        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
        <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt,.md" />

        <div class="flex items-center space-x-2 mb-3">
          <button id="uploadBtn" class="p-2 text-gray-500 hover:text-primary-500 hover:bg-primary-50 rounded transition-colors" title="ä¸Šä¼ æ–‡æ¡£">
            <i class="fas fa-paperclip"></i>
          </button>
          <button class="p-2 text-gray-500 hover:text-primary-500 hover:bg-primary-50 rounded transition-colors" title="æç¤ºè¯æ¨¡æ¿">
            <i class="fas fa-lightbulb"></i>
          </button>
        </div>
        <div class="flex items-end space-x-2">
          <div class="flex-1 relative">
            <textarea
              id="messageInput"
              rows="1"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
              placeholder="è¾“å…¥æ‚¨çš„éœ€æ±‚... æ”¯æŒæ‹–æ‹½æ–‡æ¡£åˆ°æ­¤å¤„ä¸Šä¼ "
            ></textarea>
          </div>
          <button id="sendBtn" class="px-6 py-3 gradient-bg text-white rounded-lg hover:opacity-90 transition-opacity flex items-center space-x-2">
            <i class="fas fa-paper-plane"></i>
            <span>å‘é€</span>
          </button>
        </div>
        <p class="text-xs text-gray-400 mt-2">æŒ‰ Enter å‘é€ï¼ŒShift + Enter æ¢è¡Œ</p>
      </div>
    </main>

    <!-- å³ä¾§ï¼šé¢„è§ˆ/ç¼–è¾‘åŒº (è‡ªé€‚åº”å®½åº¦) -->
    <section class="panel flex-1 bg-gray-50 border-l border-gray-200 flex flex-col overflow-hidden transition-all duration-300" id="previewPanel">
      <!-- é¢„è§ˆåŒºæ ‡é¢˜æ  -->
      <div class="h-14 px-6 bg-white border-b border-gray-200 flex items-center justify-between">
        <h3 id="previewTitle" class="text-lg font-semibold text-gray-900">é¢„è§ˆåŒº</h3>
        <div id="previewActions" class="hidden flex items-center space-x-2">
          <button onclick="exportGeneratedQuestions()" class="px-3 py-1.5 bg-white border border-primary-300 text-primary-600 rounded hover:bg-primary-50 text-sm">
            <i class="fas fa-download mr-1"></i>å¯¼å‡º
          </button>
          <button onclick="addToSimpleInput()" class="px-3 py-1.5 bg-primary-500 text-white rounded hover:bg-primary-600 text-sm">
            <i class="fas fa-edit mr-1"></i>å½•å…¥è‡³ç®€ä¾¿å½•å…¥åŒºå†ç¡®è®¤
          </button>
        </div>
      </div>

      <!-- é¢„è§ˆå†…å®¹åŒº -->
      <div id="previewContainer" class="flex-1 overflow-y-auto custom-scrollbar p-6">
        <!-- å‚æ•°å¡ç‰‡ï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨ï¼Œä¿ç•™ä»£ç ä»¥å¤‡åç”¨ï¼‰-->
        <div id="paramsCard" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 mb-6" style="display: none !important;">
          <div class="p-4 border-b border-gray-200">
            <h4 class="text-sm font-semibold text-gray-900 flex items-center">
              <i class="fas fa-sliders-h text-primary-500 mr-2"></i>
              ä»»åŠ¡å‚æ•°
            </h4>
          </div>
          <div class="p-4">
            <!-- å‚æ•°åˆ—è¡¨ -->
            <div id="paramsList" class="space-y-3">
              <!-- åŠ¨æ€ç”Ÿæˆå‚æ•°é¡¹ -->
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div class="mt-4 pt-4 border-t border-gray-200">
              <div class="flex items-center justify-between text-xs text-gray-600 mb-2">
                <span>å‚æ•°å®Œæ•´åº¦</span>
                <span id="paramsProgress" class="font-medium">0%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="paramsProgressBar" class="bg-primary-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div id="previewEmpty" class="flex flex-col items-center justify-center h-full text-center text-gray-400">
          <i class="fas fa-eye-slash text-6xl mb-4"></i>
          <p class="text-sm">ç­‰å¾…AIç”Ÿæˆå†…å®¹...</p>
          <p class="text-xs mt-2 max-w-xs">ç”Ÿæˆçš„é¢˜ç›®ã€è¯•å·ç­‰å†…å®¹å°†åœ¨è¿™é‡Œå®æ—¶æ˜¾ç¤º</p>
        </div>
      </div>
    </section>
  </div>

  <!-- ç§»åŠ¨ç«¯åº•éƒ¨Tabæ  -->
  <nav class="mobile-tab-bar">
    <button class="tab-btn active" data-panel="chatPanel">
      <i class="fas fa-comments"></i>
      <span>å¯¹è¯</span>
    </button>
    <button class="tab-btn" data-panel="previewPanel">
      <i class="fas fa-eye"></i>
      <span>é¢„è§ˆ</span>
    </button>
    <button class="tab-btn" data-panel="taskPanel">
      <i class="fas fa-list"></i>
      <span>ä»»åŠ¡</span>
    </button>
  </nav>

  <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ input -->
  <input type="file" id="fileInput" accept=".doc,.docx,.pdf,.txt,.jpg,.png" class="hidden">

  <script>
    // ========== å…¨å±€å˜é‡ ==========
    const STORAGE_VERSION = '1.0';
    let currentTask = null;
    let tasks = [];
    let messages = [];

    // é¢˜åº“æ•°æ®ç¼“å­˜
    let questionsCache = null;
    let knowledgeTreeCache = null;

    // æ–‡æ¡£ä¸Šä¼ ç›¸å…³
    let uploadedDocument = null; // å½“å‰ä¸Šä¼ çš„æ–‡æ¡£ä¿¡æ¯

    // ========== å¸¸é‡å®šä¹‰ ==========

    // ä»»åŠ¡ç±»å‹ï¼ˆç®€åŒ–ä¸ºé€šç”¨å¯¹è¯ï¼‰
    const TASK_TYPES = {
      CONVERSATION: {
        id: 'conversation',
        name: 'æ–°å¯¹è¯',
        icon: 'ğŸ’¬',
        color: 'primary',
        description: 'é€šç”¨å¯¹è¯ä»»åŠ¡'
      }
    };

    // ä»»åŠ¡çŠ¶æ€ï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨çŠ¶æ€ç®¡ç†ï¼‰
    // const TASK_STATUS = { ... }

    // æ¶ˆæ¯ç±»å‹
    const MESSAGE_TYPES = {
      TEXT: 'text',               // æ–‡æœ¬æ¶ˆæ¯
      OPTIONS: 'options',         // é€‰é¡¹æ¶ˆæ¯
      CONFIRM: 'confirm',         // ç¡®è®¤æ¶ˆæ¯
      PROGRESS: 'progress'        // è¿›åº¦æ¶ˆæ¯
    };

    // ========== è¾…åŠ©å‡½æ•° ==========

    // åˆ›å»ºä»»åŠ¡æ¨¡æ¿
    function createTaskTemplate(taskType) {
      const type = Object.values(TASK_TYPES).find(t => t.id === taskType);
      if (!type) return null;

      const now = new Date();
      const taskId = `task_${now.getTime()}`;

      return {
        id: taskId,
        title: type.name,
        type: taskType,
        // status: TASK_STATUS.PENDING, // ChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨çŠ¶æ€
        createTime: now.toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        }),
        updateTime: now.toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        }),
        params: {},
        messages: [],
        progress: null,
        results: []
      };
    }

    // è·å–ä»»åŠ¡ç±»å‹ä¿¡æ¯
    function getTaskTypeInfo(taskType) {
      return Object.values(TASK_TYPES).find(t => t.id === taskType);
    }

    // è·å–çŠ¶æ€å›¾æ ‡ï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨ï¼‰
    // function getStatusIcon(status) { ... }

    // è·å–çŠ¶æ€é¢œè‰²ï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨ï¼‰
    // function getStatusColor(status) { ... }

    // ========== æ ‡é¢˜ç”Ÿæˆ ==========

    // ä»ç”¨æˆ·ç¬¬ä¸€å¥è¯ç”Ÿæˆä»»åŠ¡æ ‡é¢˜
    function generateTaskTitle(firstMessage) {
      // ç®€å•æˆªå–å‰20ä¸ªå­—ç¬¦ä½œä¸ºæ ‡é¢˜
      let title = firstMessage.trim();

      // å¦‚æœå¤ªé•¿ï¼Œæˆªå–å¹¶æ·»åŠ çœç•¥å·
      if (title.length > 20) {
        title = title.substring(0, 20) + '...';
      }

      return title || 'æ–°å¯¹è¯';
    }

    // ============================================
    // æ™ºèƒ½å‚æ•°æå–å™¨
    // ============================================
    class SmartParamExtractor {
      constructor() {
        this.synonyms = {
          type: {
            'single': ['å•é€‰', 'å•é€‰é¢˜', 'é€‰æ‹©é¢˜', 'å•é¡¹é€‰æ‹©', 'å•é€‰é¢˜ç›®'],
            'multiple': ['å¤šé€‰', 'å¤šé€‰é¢˜', 'å¤šé¡¹é€‰æ‹©', 'å¤šé€‰é¢˜ç›®'],
            'judge': ['åˆ¤æ–­', 'åˆ¤æ–­é¢˜', 'å¯¹é”™é¢˜', 'æ˜¯éé¢˜'],
            'blank': ['å¡«ç©º', 'å¡«ç©ºé¢˜', 'å¡«å†™é¢˜'],
            'shortAnswer': ['ç®€ç­”', 'ç®€ç­”é¢˜', 'é—®ç­”é¢˜', 'ä¸»è§‚é¢˜'],
            'all': ['æ‰€æœ‰', 'å…¨éƒ¨', 'æ‰€æœ‰é¢˜å‹', 'å…¨éƒ¨é¢˜å‹', 'æ··åˆ', 'éšæœºé¢˜å‹', 'å„ç§é¢˜å‹', 'ä»»æ„é¢˜å‹']
          },
          quantity: {
            'å¤š': ['å¤šç‚¹', 'å¤šæ¥ç‚¹', 'å¤šä¸€äº›', 'å¤šå‡ é“', 'å¤šä¸ª'],
            'å°‘': ['å°‘ç‚¹', 'å°‘æ¥ç‚¹', 'å‡ é“', 'å°‘ä¸€äº›', 'å°‘ä¸ª']
          },
          difficulty: {
            '1': ['ç®€å•', 'å®¹æ˜“', 'åŸºç¡€', 'å…¥é—¨', 'åˆçº§', 'ä¸€çº§'],
            '2': ['ä¸­ç­‰', 'ä¸­çº§', 'æ™®é€š', 'äºŒçº§'],
            '3': ['å›°éš¾', 'éš¾', 'é«˜çº§', 'ä¸‰çº§'],
            '4': ['å¾ˆéš¾', 'è¶…éš¾', 'å››çº§'],
            '5': ['æéš¾', 'æœ€éš¾', 'äº”çº§']
          }
        };
        this.patterns = {
          'æ¥ç‚¹': { action: 'generate', quantity: 'default', confidence: 0.7 },
          'éšä¾¿': { confidence: 0.3, needConfirm: true },
          'å’Œä¸Šæ¬¡ä¸€æ ·': { useHistory: true, confidence: 0.9 },
          'æŒ‰ä¹ æƒ¯æ¥': { usePreference: true, confidence: 0.8 }
        };
      }

      // æå–é¢˜å‹
      extractType(input) {
        const lowerInput = input.toLowerCase();

        // éå†æ‰€æœ‰é¢˜å‹åŠå…¶åŒä¹‰è¯
        for (const [typeKey, synonymList] of Object.entries(this.synonyms.type)) {
          for (const synonym of synonymList) {
            if (lowerInput.includes(synonym)) {
              // è·å–é¢˜å‹ä¸­æ–‡å
              const typeNames = {
                'single': 'å•é€‰é¢˜',
                'multiple': 'å¤šé€‰é¢˜',
                'judge': 'åˆ¤æ–­é¢˜',
                'blank': 'å¡«ç©ºé¢˜',
                'shortAnswer': 'ç®€ç­”é¢˜',
                'all': 'æ‰€æœ‰é¢˜å‹'
              };

              return {
                value: typeKey,
                name: typeNames[typeKey],
                confidence: 1.0  // ç²¾ç¡®åŒ¹é…ï¼Œé«˜ç½®ä¿¡åº¦
              };
            }
          }
        }

        return null;
      }

      // æå–æ•°é‡
      extractCount(input) {
        // 0. æ£€æµ‹"å„Xé¢˜"æ¨¡å¼ï¼ˆè¡¨ç¤ºæ¯ä¸ªé¢˜å‹å„Xé¢˜ï¼‰
        const eachPattern = input.match(/å„\s*(\d+)\s*[é“ä¸ªé¢˜]/);
        if (eachPattern) {
          return {
            value: parseInt(eachPattern[1]),
            isEach: true,  // æ ‡è®°ä¸º"æ¯ä¸ªé¢˜å‹å„Xé¢˜"
            confidence: 1.0
          };
        }

        // 1. ç²¾ç¡®æ•°å­—åŒ¹é…ï¼ˆå¦‚"10é“"ã€"5ä¸ª"ã€"20é¢˜"ï¼‰
        const exactMatch = input.match(/(\d+)\s*[é“ä¸ªé¢˜]/);
        if (exactMatch) {
          return {
            value: parseInt(exactMatch[1]),
            confidence: 1.0  // ç²¾ç¡®åŒ¹é…
          };
        }

        // 2. çº¯æ•°å­—åŒ¹é…ï¼ˆå¦‚"10"ã€"5"ï¼‰
        const numberMatch = input.match(/\b(\d+)\b/);
        if (numberMatch) {
          const num = parseInt(numberMatch[1]);
          // åˆç†èŒƒå›´å†…çš„æ•°å­—ï¼ˆ1-100ï¼‰
          if (num >= 1 && num <= 100) {
            return {
              value: num,
              confidence: 0.8  // æ¨æ–­ï¼Œä¸­é«˜ç½®ä¿¡åº¦
            };
          }
        }

        // 3. æ¨¡ç³Šè¡¨è¾¾ï¼ˆ"å¤šç‚¹"ã€"å°‘ç‚¹"ï¼‰
        const lowerInput = input.toLowerCase();
        if (this.synonyms.quantity['å¤š'].some(syn => lowerInput.includes(syn))) {
          return {
            value: 15,  // é»˜è®¤"å¤š"ä¸º15é“
            confidence: 0.5  // æ¨¡ç³Šè¡¨è¾¾ï¼Œä¸­ç½®ä¿¡åº¦
          };
        }
        if (this.synonyms.quantity['å°‘'].some(syn => lowerInput.includes(syn))) {
          return {
            value: 5,  // é»˜è®¤"å°‘"ä¸º5é“
            confidence: 0.5
          };
        }

        return null;
      }

      // æå–éš¾åº¦
      extractDifficulty(input) {
        const lowerInput = input.toLowerCase();

        // æ£€æµ‹"æ‰€æœ‰éš¾åº¦"/"å…¨éƒ¨éš¾åº¦"å…³é”®è¯
        const allDifficultyKeywords = ['æ‰€æœ‰éš¾åº¦', 'å…¨éƒ¨éš¾åº¦', 'å„ç§éš¾åº¦', 'æ‰€æœ‰çº§åˆ«', 'å…¨éƒ¨çº§åˆ«'];
        for (const keyword of allDifficultyKeywords) {
          if (lowerInput.includes(keyword)) {
            return {
              value: 'all',
              name: 'æ‰€æœ‰éš¾åº¦',
              confidence: 1.0
            };
          }
        }

        // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœåŒ…å«"ä¸­ç­‰"æˆ–"äºŒçº§"ï¼Œç›´æ¥è¿”å›äºŒçº§éš¾åº¦
        if (lowerInput.includes('ä¸­ç­‰') || lowerInput.includes('ä¸­çº§') || lowerInput.includes('æ™®é€š') || lowerInput.includes('äºŒçº§')) {
          return {
            value: 2,
            name: 'äºŒçº§',
            confidence: 1.0
          };
        }

        // æŒ‰éš¾åº¦ç­‰çº§ä»é«˜åˆ°ä½éå†ï¼Œä¼˜å…ˆåŒ¹é…æ›´å…·ä½“çš„è¡¨è¾¾
        const difficultyLevels = ['5', '4', '3', '1'];  // è·³è¿‡2ï¼Œå› ä¸ºå·²ç»ç‰¹æ®Šå¤„ç†

        for (const diffKey of difficultyLevels) {
          const synonymList = this.synonyms.difficulty[diffKey];
          // æŒ‰åŒä¹‰è¯é•¿åº¦ä»é•¿åˆ°çŸ­æ’åºï¼Œä¼˜å…ˆåŒ¹é…æ›´é•¿çš„è¯
          const sortedSynonyms = [...synonymList].sort((a, b) => b.length - a.length);

          for (const synonym of sortedSynonyms) {
            if (lowerInput.includes(synonym)) {
              const diffNames = {
                '1': 'ä¸€çº§',
                '2': 'äºŒçº§',
                '3': 'ä¸‰çº§',
                '4': 'å››çº§',
                '5': 'äº”çº§'
              };

              return {
                value: parseInt(diffKey),
                name: diffNames[diffKey],
                confidence: 1.0
              };
            }
          }
        }

        return null;
      }

      // æå–çŸ¥è¯†ç‚¹
      extractKnowledgePoint(input) {
        // æ£€æµ‹"æ‰€æœ‰çŸ¥è¯†ç‚¹"/"å…¨éƒ¨çŸ¥è¯†ç‚¹"å…³é”®è¯
        const allKnowledgeKeywords = ['æ‰€æœ‰çŸ¥è¯†ç‚¹', 'å…¨éƒ¨çŸ¥è¯†ç‚¹', 'å„ç§çŸ¥è¯†ç‚¹', 'æ‰€æœ‰çŸ¥è¯†', 'å…¨éƒ¨çŸ¥è¯†'];
        for (const keyword of allKnowledgeKeywords) {
          if (input.includes(keyword)) {
            return {
              value: 'all',
              confidence: 1.0
            };
          }
        }

        // åŒ¹é…"å…³äºXXçš„"ã€"XXç›¸å…³"ã€"XXçŸ¥è¯†ç‚¹"ç­‰æ¨¡å¼
        const patterns = [
          /å…³äº["\""]?([^"\""\\sï¼Œã€‚ï¼ï¼Ÿ]{2,10})["\""]?çš„/,
          /([^ï¼Œã€‚ï¼ï¼Ÿ\\s]{2,10})ç›¸å…³/,
          /([^ï¼Œã€‚ï¼ï¼Ÿ\\s]{2,10})çŸ¥è¯†ç‚¹/,
          /([^ï¼Œã€‚ï¼ï¼Ÿ\\s]{2,10})æ–¹é¢/
        ];

        for (const pattern of patterns) {
          const match = input.match(pattern);
          if (match) {
            return {
              value: match[1],
              confidence: 0.9  // æ¨¡å¼åŒ¹é…ï¼Œé«˜ç½®ä¿¡åº¦
            };
          }
        }

        return null;
      }

      // åŒ¹é…å£è¯­åŒ–æ¨¡å¼
      matchPatterns(input) {
        const lowerInput = input.toLowerCase();
        const result = {
          params: {},
          ambiguous: []
        };

        for (const [pattern, config] of Object.entries(this.patterns)) {
          if (lowerInput.includes(pattern)) {
            // å¦‚æœæ˜¯"æ¥ç‚¹"ï¼Œè®¾ç½®é»˜è®¤æ•°é‡
            if (pattern === 'æ¥ç‚¹' && !result.params.count) {
              result.params.count = 10;
              result.params._countSource = 'pattern';
            }

            // å¦‚æœæ˜¯"éšä¾¿"ï¼Œæ ‡è®°ä¸ºéœ€è¦ç¡®è®¤
            if (pattern === 'éšä¾¿') {
              result.ambiguous.push('ç”¨æˆ·è¡¨è¾¾æ¨¡ç³Šï¼Œå»ºè®®ç¡®è®¤');
            }

            // å¦‚æœæ˜¯"å’Œä¸Šæ¬¡ä¸€æ ·"æˆ–"æŒ‰ä¹ æƒ¯æ¥"ï¼Œæ ‡è®°ä½¿ç”¨å†å²/åå¥½
            if (config.useHistory) {
              result.params._useHistory = true;
            }
            if (config.usePreference) {
              result.params._usePreference = true;
            }
          }
        }

        return result;
      }

      /**
       * æå–æ··åˆé¢˜å‹ï¼ˆå¤šä¸ªé¢˜å‹+æ•°é‡ç»„åˆï¼‰
       * ä¾‹å¦‚ï¼š"ç”Ÿæˆå•é€‰10é¢˜ã€å¤šé€‰10é¢˜ã€åˆ¤æ–­5é¢˜ã€ç®€ç­”2é¢˜"
       * @param {string} input - ç”¨æˆ·è¾“å…¥
       * @returns {Object|null} æ··åˆé¢˜å‹æ•°æ®æˆ–null
       */
      extractMixedTypes(input) {
        // æ˜ å°„é¢˜å‹åç§°åˆ°type key
        const typeMap = {
          'å•é€‰': 'single', 'å•é€‰é¢˜': 'single',
          'å¤šé€‰': 'multiple', 'å¤šé€‰é¢˜': 'multiple',
          'åˆ¤æ–­': 'judge', 'åˆ¤æ–­é¢˜': 'judge',
          'å¡«ç©º': 'blank', 'å¡«ç©ºé¢˜': 'blank',
          'ç®€ç­”': 'shortAnswer', 'ç®€ç­”é¢˜': 'shortAnswer',
          'å®Œå½¢å¡«ç©º': 'cloze', 'å®Œå½¢å¡«ç©ºé¢˜': 'cloze',
          'å¤åˆ': 'composite', 'å¤åˆé¢˜': 'composite'
        };

        const typeNames = {
          'single': 'å•é€‰é¢˜',
          'multiple': 'å¤šé€‰é¢˜',
          'judge': 'åˆ¤æ–­é¢˜',
          'blank': 'å¡«ç©ºé¢˜',
          'shortAnswer': 'ç®€ç­”é¢˜',
          'cloze': 'å®Œå½¢å¡«ç©ºé¢˜',
          'composite': 'å¤åˆé¢˜'
        };

        // æ‰€æœ‰é¢˜å‹åˆ—è¡¨
        const allTypes = ['single', 'multiple', 'judge', 'blank', 'shortAnswer', 'cloze', 'composite'];

        // åŒ¹é…æ¨¡å¼ï¼šæ•°å­— + é¢˜å‹åç§°
        // æ”¯æŒï¼š"10é“å•é€‰é¢˜"ã€"5ä¸ªåˆ¤æ–­é¢˜"ã€"å•é€‰10é¢˜"ç­‰å¤šç§è¡¨è¾¾
        const patterns = [
          /(\d+)\s*é“?\s*(å•é€‰é¢˜?|å¤šé€‰é¢˜?|åˆ¤æ–­é¢˜?|å¡«ç©ºé¢˜?|ç®€ç­”é¢˜?|å®Œå½¢å¡«ç©ºé¢˜?|å¤åˆé¢˜?)/g,
          /(å•é€‰é¢˜?|å¤šé€‰é¢˜?|åˆ¤æ–­é¢˜?|å¡«ç©ºé¢˜?|ç®€ç­”é¢˜?|å®Œå½¢å¡«ç©ºé¢˜?|å¤åˆé¢˜?)\s*(\d+)\s*[é“é¢˜ä¸ª]?/g
        ];

        const allMatches = [];

        // å°è¯•æ‰€æœ‰æ¨¡å¼
        for (const pattern of patterns) {
          const matches = [...input.matchAll(pattern)];
          for (const match of matches) {
            // æ ¹æ®ä¸åŒæ¨¡å¼æå–æ•°é‡å’Œé¢˜å‹
            let count, typeName;
            if (match[1] && /^\d+$/.test(match[1])) {
              // æ¨¡å¼1: æ•°å­—åœ¨å‰
              count = parseInt(match[1]);
              typeName = match[2];
            } else {
              // æ¨¡å¼2: é¢˜å‹åœ¨å‰
              typeName = match[1];
              count = parseInt(match[2]);
            }

            allMatches.push({ count, typeName, index: match.index });
          }
        }

        // å»é‡ï¼ˆåŒä¸€ä½ç½®å¯èƒ½è¢«å¤šä¸ªæ¨¡å¼åŒ¹é…ï¼‰
        const uniqueMatches = [];
        const seenIndices = new Set();

        for (const match of allMatches) {
          if (!seenIndices.has(match.index)) {
            seenIndices.add(match.index);
            uniqueMatches.push(match);
          }
        }

        // æ£€æµ‹"å…¶ä»–çš„/å…¶ä½™çš„/å‰©ä¸‹çš„" + æ•°é‡æ¨¡å¼
        const othersPattern = /(å…¶ä»–|å…¶ä½™|å‰©ä¸‹)çš„?[å„æ¯]\s*(\d+)\s*[é“é¢˜ä¸ª]/;
        const othersMatch = input.match(othersPattern);

        // å¦‚æœæœ‰"å…¶ä»–çš„"æ¨¡å¼ï¼Œæˆ–è€…åŒ¹é…åˆ°2ä¸ªæˆ–ä»¥ä¸Šæ˜¾å¼é¢˜å‹
        if (othersMatch || uniqueMatches.length >= 2) {
          const explicitTypes = new Set();
          const types = [];

          // å¤„ç†æ˜¾å¼æåˆ°çš„é¢˜å‹
          for (const match of uniqueMatches) {
            const typeKey = typeMap[match.typeName];
            explicitTypes.add(typeKey);
            types.push({
              type: typeKey,
              typeName: typeNames[typeKey],
              count: match.count
            });
          }

          // å¦‚æœæœ‰"å…¶ä»–çš„"æ¨¡å¼ï¼Œæ‰©å±•ä¸ºæ‰€æœ‰æœªæåˆ°çš„é¢˜å‹
          if (othersMatch) {
            const othersCount = parseInt(othersMatch[2]);
            const remainingTypes = allTypes.filter(t => !explicitTypes.has(t));

            for (const typeKey of remainingTypes) {
              types.push({
                type: typeKey,
                typeName: typeNames[typeKey],
                count: othersCount
              });
            }
          }

          // åªæœ‰å½“æœ€ç»ˆæœ‰2ä¸ªæˆ–ä»¥ä¸Šé¢˜å‹æ—¶æ‰è¿”å›æ··åˆé¢˜å‹
          if (types.length >= 2) {
            return {
              isMixed: true,
              types: types,
              totalCount: types.reduce((sum, t) => sum + t.count, 0),
              confidence: 1.0
            };
          }
        }

        return null;
      }

      // ä¸»æå–æ–¹æ³•
      extract(input, context = {}) {
        const params = {};
        const confidence = {};
        const ambiguous = [];

        // 0. ä¼˜å…ˆæ£€æµ‹æ··åˆé¢˜å‹
        const mixedTypes = this.extractMixedTypes(input);
        if (mixedTypes && mixedTypes.isMixed) {
          // è¿”å›æ··åˆé¢˜å‹æ ‡è®°
          params._mixedTypes = mixedTypes;
          confidence.mixedTypes = mixedTypes.confidence;
          return { params, confidence, ambiguous };
        }

        // 1. é¢˜å‹è¯†åˆ«
        const typeResult = this.extractType(input);
        if (typeResult) {
          params.type = typeResult.value;
          params.typeName = typeResult.name;
          confidence.type = typeResult.confidence;
        }

        // 2. æ•°é‡è¯†åˆ«
        const countResult = this.extractCount(input);
        if (countResult) {
          params.count = countResult.value;
          confidence.count = countResult.confidence;
        }

        // 3. éš¾åº¦è¯†åˆ«
        const diffResult = this.extractDifficulty(input);
        if (diffResult) {
          params.difficulty = diffResult.value;
          params.difficultyName = diffResult.name;
          confidence.difficulty = diffResult.confidence;
        }

        // 4. çŸ¥è¯†ç‚¹è¯†åˆ«
        const kpResult = this.extractKnowledgePoint(input);
        if (kpResult) {
          params.knowledgePoint = kpResult.value;
          confidence.knowledgePoint = kpResult.confidence;
        }

        // 5. ç‰¹æ®Šæ¨¡å¼è¯†åˆ«
        const patternResult = this.matchPatterns(input);
        if (patternResult) {
          Object.assign(params, patternResult.params);
          ambiguous.push(...patternResult.ambiguous);
        }

        return { params, confidence, ambiguous };
      }
    }

    // ============================================
    // ç”¨æˆ·åå¥½ç®¡ç†å™¨
    // ============================================
    class UserPreferenceManager {
      constructor() {
        this.storageKey = 'ai_assistant_user_preferences';
        this.preferences = this.loadPreferences();
      }

      // è·å–é»˜è®¤åå¥½æ•°æ®ç»“æ„
      getDefaultPreferences() {
        return {
          userId: 'default_user',
          version: '1.0',

          // 1. åŸºç¡€åå¥½ç»Ÿè®¡
          basicPreferences: {
            questionType: {
              'single': { count: 0, percentage: 0 },
              'multiple': { count: 0, percentage: 0 },
              'judge': { count: 0, percentage: 0 },
              'blank': { count: 0, percentage: 0 },
              'shortAnswer': { count: 0, percentage: 0 },
              'all': { count: 0, percentage: 0 }
            },
            difficulty: {
              '1': { count: 0, percentage: 0 },
              '2': { count: 0, percentage: 0 },
              '3': { count: 0, percentage: 0 },
              '4': { count: 0, percentage: 0 },
              '5': { count: 0, percentage: 0 }
            },
            quantity: {
              total: 0,
              average: 10,
              mostCommon: 10,
              distribution: {}
            },
            knowledgePoints: {}
          },

          // 2. åœºæ™¯åå¥½
          scenarioPreferences: {
            'generate_questions': {
              lastUsed: null,
              frequency: 0,
              lastParams: null,
              commonConfig: null
            }
          },

          // 3. è¡Œä¸ºæ¨¡å¼
          behaviorPatterns: {
            timePatterns: {
              weekday: { samples: 0, avgDifficulty: 0, avgCount: 0, commonType: null },
              weekend: { samples: 0, avgDifficulty: 0, avgCount: 0, commonType: null }
            },
            knowledgePointFocus: {
              recent: [],
              trending: null
            },
            commonCombinations: []
          },

          // 4. å¯¹è¯é£æ ¼åå¥½
          conversationStyle: {
            verbosity: 'normal',
            confirmationNeeded: true,
            preferQuickActions: false
          },

          // 5. å…ƒæ•°æ®
          metadata: {
            totalActions: 0,
            firstActionDate: null,
            lastActionDate: null,
            totalQuestionsGenerated: 0
          }
        };
      }

      // åŠ è½½åå¥½æ•°æ®
      loadPreferences() {
        try {
          const stored = localStorage.getItem(this.storageKey);
          if (!stored) {
            console.log('æœªæ‰¾åˆ°åå¥½æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
            return this.getDefaultPreferences();
          }

          // è§£æå­˜å‚¨çš„æ•°æ®
          let data;
          try {
            data = JSON.parse(stored);
          } catch (parseError) {
            console.error('åå¥½æ•°æ®è§£æå¤±è´¥ï¼Œæ•°æ®å¯èƒ½å·²æŸå:', parseError);
            this.backupCorruptedData(stored);
            return this.getDefaultPreferences();
          }

          // éªŒè¯æ•°æ®ç»“æ„
          if (!this.validatePreferencesData(data)) {
            console.warn('åå¥½æ•°æ®éªŒè¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
            this.backupCorruptedData(stored);
            return this.getDefaultPreferences();
          }

          // æ£€æŸ¥ç‰ˆæœ¬å¹¶æ‰§è¡Œè¿ç§»
          const migratedData = this.migratePreferences(data);

          // å¦‚æœæ•°æ®è¢«è¿ç§»ï¼Œä¿å­˜æ–°ç‰ˆæœ¬
          if (migratedData !== data) {
            console.log('åå¥½æ•°æ®å·²è¿ç§»åˆ°æ–°ç‰ˆæœ¬');
            this.preferences = migratedData;
            this.savePreferences();
          }

          return migratedData;
        } catch (error) {
          console.error('åŠ è½½åå¥½æ•°æ®æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯:', error);
          return this.getDefaultPreferences();
        }
      }

      // éªŒè¯åå¥½æ•°æ®ç»“æ„
      validatePreferencesData(data) {
        if (!data || typeof data !== 'object') {
          console.error('éªŒè¯å¤±è´¥: æ•°æ®ä¸æ˜¯æœ‰æ•ˆå¯¹è±¡');
          return false;
        }

        // æ£€æŸ¥å¿…éœ€çš„é¡¶çº§å­—æ®µ
        const requiredFields = ['userId', 'version', 'basicPreferences', 'metadata'];
        for (const field of requiredFields) {
          if (!(field in data)) {
            console.error(`éªŒè¯å¤±è´¥: ç¼ºå°‘å¿…éœ€å­—æ®µ "${field}"`);
            return false;
          }
        }

        // éªŒè¯ basicPreferences ç»“æ„
        if (!data.basicPreferences || typeof data.basicPreferences !== 'object') {
          console.error('éªŒè¯å¤±è´¥: basicPreferences æ— æ•ˆ');
          return false;
        }

        const requiredBasicFields = ['questionType', 'difficulty', 'quantity'];
        for (const field of requiredBasicFields) {
          if (!(field in data.basicPreferences)) {
            console.error(`éªŒè¯å¤±è´¥: basicPreferences ç¼ºå°‘å­—æ®µ "${field}"`);
            return false;
          }
        }

        // éªŒè¯ metadata ç»“æ„
        if (!data.metadata || typeof data.metadata !== 'object') {
          console.error('éªŒè¯å¤±è´¥: metadata æ— æ•ˆ');
          return false;
        }

        const requiredMetadataFields = ['totalActions', 'firstActionDate', 'lastActionDate'];
        for (const field of requiredMetadataFields) {
          if (!(field in data.metadata)) {
            console.error(`éªŒè¯å¤±è´¥: metadata ç¼ºå°‘å­—æ®µ "${field}"`);
            return false;
          }
        }

        return true;
      }

      // æ•°æ®è¿ç§»é€»è¾‘
      migratePreferences(data) {
        const currentVersion = '1.0';
        const dataVersion = data.version || '0.0';

        // å¦‚æœç‰ˆæœ¬ç›¸åŒï¼Œæ— éœ€è¿ç§»
        if (dataVersion === currentVersion) {
          return data;
        }

        console.log(`å¼€å§‹æ•°æ®è¿ç§»: ${dataVersion} -> ${currentVersion}`);

        // åˆ›å»ºè¿ç§»åçš„æ•°æ®å‰¯æœ¬
        let migratedData = JSON.parse(JSON.stringify(data));

        // ç‰ˆæœ¬è¿ç§»é€»è¾‘
        if (this.compareVersions(dataVersion, '1.0') < 0) {
          migratedData = this.migrateToV1_0(migratedData);
        }

        // æœªæ¥ç‰ˆæœ¬è¿ç§»å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
        // if (this.compareVersions(dataVersion, '1.1') < 0) {
        //   migratedData = this.migrateToV1_1(migratedData);
        // }

        // æ›´æ–°ç‰ˆæœ¬å·
        migratedData.version = currentVersion;

        return migratedData;
      }

      // è¿ç§»åˆ° v1.0
      migrateToV1_0(data) {
        console.log('æ‰§è¡Œ v1.0 è¿ç§»');

        // ç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µå­˜åœ¨
        const defaultPrefs = this.getDefaultPreferences();

        // åˆå¹¶é»˜è®¤å€¼ï¼ˆä¿ç•™ç°æœ‰æ•°æ®ï¼‰
        const merged = {
          ...defaultPrefs,
          ...data,
          basicPreferences: {
            ...defaultPrefs.basicPreferences,
            ...data.basicPreferences
          },
          scenarioPreferences: {
            ...defaultPrefs.scenarioPreferences,
            ...data.scenarioPreferences
          },
          behaviorPatterns: {
            ...defaultPrefs.behaviorPatterns,
            ...data.behaviorPatterns
          },
          conversationStyle: {
            ...defaultPrefs.conversationStyle,
            ...data.conversationStyle
          },
          metadata: {
            ...defaultPrefs.metadata,
            ...data.metadata
          }
        };

        return merged;
      }

      // ç‰ˆæœ¬æ¯”è¾ƒå·¥å…·
      compareVersions(v1, v2) {
        const parts1 = v1.split('.').map(Number);
        const parts2 = v2.split('.').map(Number);

        for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
          const part1 = parts1[i] || 0;
          const part2 = parts2[i] || 0;

          if (part1 < part2) return -1;
          if (part1 > part2) return 1;
        }

        return 0;
      }

      // å¤‡ä»½æŸåçš„æ•°æ®
      backupCorruptedData(corruptedData) {
        try {
          const backupKey = `${this.storageKey}_corrupted_${Date.now()}`;
          localStorage.setItem(backupKey, corruptedData);
          console.log(`æŸåçš„æ•°æ®å·²å¤‡ä»½åˆ°: ${backupKey}`);
        } catch (error) {
          console.error('å¤‡ä»½æŸåæ•°æ®å¤±è´¥:', error);
        }
      }

      // ä¿å­˜åå¥½æ•°æ®
      savePreferences() {
        try {
          // éªŒè¯æ•°æ®å†ä¿å­˜
          if (!this.validatePreferencesData(this.preferences)) {
            console.error('ä¿å­˜å¤±è´¥: æ•°æ®éªŒè¯æœªé€šè¿‡');
            return false;
          }

          localStorage.setItem(this.storageKey, JSON.stringify(this.preferences));
          return true;
        } catch (error) {
          console.error('ä¿å­˜åå¥½æ•°æ®å¤±è´¥:', error);

          // å¦‚æœæ˜¯é…é¢è¶…å‡ºé”™è¯¯ï¼Œå°è¯•æ¸…ç†æ—§å¤‡ä»½
          if (error.name === 'QuotaExceededError') {
            console.warn('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå°è¯•æ¸…ç†æ—§å¤‡ä»½...');
            this.cleanupOldBackups();

            // é‡è¯•ä¿å­˜
            try {
              localStorage.setItem(this.storageKey, JSON.stringify(this.preferences));
              return true;
            } catch (retryError) {
              console.error('é‡è¯•ä¿å­˜å¤±è´¥:', retryError);
            }
          }

          return false;
        }
      }

      // æ¸…ç†æ—§å¤‡ä»½æ•°æ®
      cleanupOldBackups() {
        try {
          const backupPrefix = `${this.storageKey}_corrupted_`;
          const keysToRemove = [];

          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith(backupPrefix)) {
              keysToRemove.push(key);
            }
          }

          // åˆ é™¤æ—§å¤‡ä»½
          keysToRemove.forEach(key => {
            localStorage.removeItem(key);
            console.log(`å·²åˆ é™¤æ—§å¤‡ä»½: ${key}`);
          });

          console.log(`æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† ${keysToRemove.length} ä¸ªæ—§å¤‡ä»½`);
        } catch (error) {
          console.error('æ¸…ç†æ—§å¤‡ä»½å¤±è´¥:', error);
        }
      }

      // ============================================
      // åå¥½è®°å½•åŠŸèƒ½
      // ============================================

      /**
       * è®°å½•ç”¨æˆ·æ“ä½œè¡Œä¸º
       * @param {Object} params - æ“ä½œå‚æ•°
       * @param {string} params.type - é¢˜å‹ (single/multiple/judge/fill/essay/all)
       * @param {number} params.count - ç”Ÿæˆæ•°é‡
       * @param {number} params.difficulty - éš¾åº¦ (1-5)
       * @param {string} params.knowledgePoint - çŸ¥è¯†ç‚¹
       * @param {Date} params.timestamp - æ—¶é—´æˆ³
       */
      recordAction(params) {
        // éªŒè¯å‚æ•°
        if (!params || typeof params !== 'object') {
          console.error('recordAction: å‚æ•°æ— æ•ˆ');
          return false;
        }

        // è®¾ç½®é»˜è®¤æ—¶é—´æˆ³
        if (!params.timestamp) {
          params.timestamp = new Date();
        }

        // æ›´æ–°å…ƒæ•°æ®
        const metadata = this.preferences.metadata;
        metadata.totalActions++;
        if (!metadata.firstActionDate) {
          metadata.firstActionDate = params.timestamp.toISOString();
        }
        metadata.lastActionDate = params.timestamp.toISOString();

        // æ›´æ–°ç”Ÿæˆé¢˜ç›®æ€»æ•°
        if (params.count && typeof params.count === 'number') {
          metadata.totalQuestionsGenerated += params.count;
        }

        // æ›´æ–°å„ç±»åå¥½
        this.updateBasicPreferences(params);
        this.updateScenarioPreferences(params);
        this.updateBehaviorPatterns(params);

        // é‡æ–°è®¡ç®—ç™¾åˆ†æ¯”
        this.calculatePercentages();

        // ä¿å­˜åˆ° LocalStorage
        return this.savePreferences();
      }

      /**
       * æ›´æ–°åŸºç¡€åå¥½ç»Ÿè®¡
       * @param {Object} params - æ“ä½œå‚æ•°
       */
      updateBasicPreferences(params) {
        const basic = this.preferences.basicPreferences;

        // 1. æ›´æ–°é¢˜å‹ç»Ÿè®¡
        if (params.type) {
          const typeKey = params.type;
          if (basic.questionType[typeKey]) {
            basic.questionType[typeKey].count++;
          }
        }

        // 2. æ›´æ–°éš¾åº¦ç»Ÿè®¡
        if (params.difficulty) {
          const diffKey = String(params.difficulty);
          if (basic.difficulty[diffKey]) {
            basic.difficulty[diffKey].count++;
          }
        }

        // 3. æ›´æ–°æ•°é‡ç»Ÿè®¡
        if (params.count && typeof params.count === 'number') {
          const quantity = basic.quantity;

          // æ›´æ–°æ€»æ•°
          quantity.total += params.count;

          // æ›´æ–°åˆ†å¸ƒ
          const countKey = String(params.count);
          if (!quantity.distribution[countKey]) {
            quantity.distribution[countKey] = 0;
          }
          quantity.distribution[countKey]++;

          // è®¡ç®—å¹³å‡å€¼
          const totalSamples = Object.values(quantity.distribution).reduce((sum, val) => sum + val, 0);
          const weightedSum = Object.entries(quantity.distribution).reduce((sum, [count, freq]) => {
            return sum + (parseInt(count) * freq);
          }, 0);
          quantity.average = totalSamples > 0 ? Math.round(weightedSum / totalSamples) : 10;

          // æ‰¾å‡ºæœ€å¸¸ç”¨çš„æ•°é‡
          let maxFreq = 0;
          let mostCommonCount = 10;
          for (const [count, freq] of Object.entries(quantity.distribution)) {
            if (freq > maxFreq) {
              maxFreq = freq;
              mostCommonCount = parseInt(count);
            }
          }
          quantity.mostCommon = mostCommonCount;
        }

        // 4. æ›´æ–°çŸ¥è¯†ç‚¹ç»Ÿè®¡
        if (params.knowledgePoint) {
          const kpKey = params.knowledgePoint;
          if (!basic.knowledgePoints[kpKey]) {
            basic.knowledgePoints[kpKey] = { count: 0, percentage: 0 };
          }
          basic.knowledgePoints[kpKey].count++;
        }
      }

      /**
       * æ›´æ–°åœºæ™¯åå¥½
       * @param {Object} params - æ“ä½œå‚æ•°
       */
      updateScenarioPreferences(params) {
        const scenario = this.preferences.scenarioPreferences.generate_questions;

        // æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´
        scenario.lastUsed = params.timestamp ? params.timestamp.toISOString() : new Date().toISOString();

        // æ›´æ–°ä½¿ç”¨é¢‘ç‡
        scenario.frequency++;

        // æ›´æ–°æœ€åä½¿ç”¨çš„å‚æ•°
        scenario.lastParams = {
          type: params.type || null,
          count: params.count || null,
          difficulty: params.difficulty || null,
          knowledgePoint: params.knowledgePoint || null
        };

        // æ›´æ–°å¸¸ç”¨é…ç½®ï¼ˆä½¿ç”¨æœ€åä¸€æ¬¡çš„å‚æ•°ä½œä¸ºå¸¸ç”¨é…ç½®ï¼‰
        scenario.commonConfig = {
          type: params.type || 'single',
          count: params.count || 10,
          difficulty: params.difficulty || 2,
          knowledgePoint: params.knowledgePoint || null
        };
      }

      /**
       * æ›´æ–°è¡Œä¸ºæ¨¡å¼
       * @param {Object} params - æ“ä½œå‚æ•°
       */
      updateBehaviorPatterns(params) {
        const patterns = this.preferences.behaviorPatterns;
        const timestamp = params.timestamp || new Date();

        // 1. æ›´æ–°æ—¶é—´æ¨¡å¼ï¼ˆå·¥ä½œæ—¥/å‘¨æœ«ï¼‰
        const timeKey = this.getTimePattern(timestamp);
        const timePattern = patterns.timePatterns[timeKey];

        timePattern.samples++;

        // æ›´æ–°å¹³å‡éš¾åº¦
        if (params.difficulty) {
          const currentAvg = timePattern.avgDifficulty || 0;
          const currentSamples = timePattern.samples;
          timePattern.avgDifficulty = ((currentAvg * (currentSamples - 1)) + params.difficulty) / currentSamples;
        }

        // æ›´æ–°å¹³å‡æ•°é‡
        if (params.count) {
          const currentAvg = timePattern.avgCount || 0;
          const currentSamples = timePattern.samples;
          timePattern.avgCount = ((currentAvg * (currentSamples - 1)) + params.count) / currentSamples;
        }

        // æ›´æ–°å¸¸ç”¨é¢˜å‹
        if (params.type) {
          timePattern.commonType = params.type;
        }

        // 2. æ›´æ–°çŸ¥è¯†ç‚¹å…³æ³¨åº¦ï¼ˆæ»‘åŠ¨çª—å£ï¼Œæœ€å¤šä¿ç•™10æ¡ï¼‰
        if (params.knowledgePoint) {
          const recent = patterns.knowledgePointFocus.recent;
          recent.push({
            knowledgePoint: params.knowledgePoint,
            timestamp: timestamp.toISOString()
          });

          // ä¿æŒæœ€å¤š10æ¡è®°å½•
          if (recent.length > 10) {
            recent.shift();
          }

          // è®¡ç®—è¶‹åŠ¿ï¼ˆæœ€è¿‘ä½¿ç”¨æœ€å¤šçš„çŸ¥è¯†ç‚¹ï¼‰
          patterns.knowledgePointFocus.trending = this.getTrendingKnowledgePoint();
        }

        // 3. æ›´æ–°å¸¸ç”¨ç»„åˆ
        this.updateCommonCombinations(params);
      }

      /**
       * é‡æ–°è®¡ç®—æ‰€æœ‰ç™¾åˆ†æ¯”
       */
      calculatePercentages() {
        const basic = this.preferences.basicPreferences;

        // 1. è®¡ç®—é¢˜å‹ç™¾åˆ†æ¯”
        const typeTotal = Object.values(basic.questionType).reduce((sum, item) => sum + item.count, 0);
        if (typeTotal > 0) {
          for (const key in basic.questionType) {
            const count = basic.questionType[key].count;
            basic.questionType[key].percentage = Math.round((count / typeTotal) * 100 * 100) / 100;
          }
        }

        // 2. è®¡ç®—éš¾åº¦ç™¾åˆ†æ¯”
        const diffTotal = Object.values(basic.difficulty).reduce((sum, item) => sum + item.count, 0);
        if (diffTotal > 0) {
          for (const key in basic.difficulty) {
            const count = basic.difficulty[key].count;
            basic.difficulty[key].percentage = Math.round((count / diffTotal) * 100 * 100) / 100;
          }
        }

        // 3. è®¡ç®—çŸ¥è¯†ç‚¹ç™¾åˆ†æ¯”
        const kpTotal = Object.values(basic.knowledgePoints).reduce((sum, item) => sum + item.count, 0);
        if (kpTotal > 0) {
          for (const key in basic.knowledgePoints) {
            const count = basic.knowledgePoints[key].count;
            basic.knowledgePoints[key].percentage = Math.round((count / kpTotal) * 100 * 100) / 100;
          }
        }
      }

      /**
       * åˆ¤æ–­æ˜¯å¦ä¸ºå‘¨æœ«
       * @param {number} dayOfWeek - æ˜ŸæœŸå‡  (0=å‘¨æ—¥, 6=å‘¨å…­)
       * @returns {boolean} æ˜¯å¦ä¸ºå‘¨æœ«
       */
      isWeekend(dayOfWeek) {
        return dayOfWeek === 0 || dayOfWeek === 6;
      }

      /**
       * æ›´æ–°å¸¸ç”¨å‚æ•°ç»„åˆ
       * @param {Object} params - å‚æ•°å¯¹è±¡ {type, difficulty, count}
       */
      updateCommonCombinations(params) {
        const patterns = this.preferences.behaviorPatterns;

        if (params.type && params.difficulty && params.count) {
          const combination = {
            type: params.type,
            difficulty: params.difficulty,
            count: params.count,
            frequency: 1
          };

          // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨ç›¸åŒç»„åˆ
          const existingIndex = patterns.commonCombinations.findIndex(c =>
            c.type === combination.type &&
            c.difficulty === combination.difficulty &&
            c.count === combination.count
          );

          if (existingIndex >= 0) {
            // å·²å­˜åœ¨ï¼Œå¢åŠ é¢‘ç‡
            patterns.commonCombinations[existingIndex].frequency++;
          } else {
            // ä¸å­˜åœ¨ï¼Œæ·»åŠ æ–°ç»„åˆ
            patterns.commonCombinations.push(combination);
          }

          // æŒ‰é¢‘ç‡æ’åºï¼Œä¿ç•™å‰5ä¸ª
          patterns.commonCombinations.sort((a, b) => b.frequency - a.frequency);
          if (patterns.commonCombinations.length > 5) {
            patterns.commonCombinations = patterns.commonCombinations.slice(0, 5);
          }
        }
      }

      /**
       * è·å–æœ€è¿‘æœ€å¸¸ç”¨çš„çŸ¥è¯†ç‚¹
       * @returns {string|null} çŸ¥è¯†ç‚¹åç§°ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›null
       */
      getTrendingKnowledgePoint() {
        const recent = this.preferences.behaviorPatterns.knowledgePointFocus.recent;

        if (recent.length === 0) {
          return null;
        }

        // ç»Ÿè®¡æ¯ä¸ªçŸ¥è¯†ç‚¹çš„é¢‘ç‡
        const kpCounts = {};
        recent.forEach(item => {
          kpCounts[item.knowledgePoint] = (kpCounts[item.knowledgePoint] || 0) + 1;
        });

        // æ‰¾å‡ºé¢‘ç‡æœ€é«˜çš„çŸ¥è¯†ç‚¹
        let maxCount = 0;
        let trendingKp = null;
        for (const [kp, count] of Object.entries(kpCounts)) {
          if (count > maxCount) {
            maxCount = count;
            trendingKp = kp;
          }
        }

        return trendingKp;
      }

      /**
       * è·å–å½“å‰æ—¶é—´æ¨¡å¼
       * @param {Date} timestamp - æ—¶é—´æˆ³
       * @returns {string} 'weekday' æˆ– 'weekend'
       */
      getTimePattern(timestamp) {
        const dayOfWeek = timestamp.getDay();
        return this.isWeekend(dayOfWeek) ? 'weekend' : 'weekday';
      }

      // ========== åå¥½æŸ¥è¯¢æ–¹æ³• ==========

      /**
       * è·å–ä¸Šæ¬¡ä½¿ç”¨çš„å‚æ•°
       * @returns {Object|null} ä¸Šæ¬¡ä½¿ç”¨çš„å‚æ•°å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å†å²è®°å½•åˆ™è¿”å› null
       */
      getLastUsedParams() {
        const lastParams = this.preferences.scenarioPreferences['generate_questions'].lastParams;
        return lastParams || null;
      }

      /**
       * è·å–æœ€å¸¸ç”¨çš„é¢˜å‹
       * @returns {string|null} é¢˜å‹é”®åï¼ˆå¦‚ 'single'ï¼‰ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åˆ™è¿”å› null
       */
      getMostCommonType() {
        const typeStats = this.preferences.basicPreferences.questionType;
        let maxCount = 0;
        let mostCommonType = null;

        for (const [type, stats] of Object.entries(typeStats)) {
          // è·³è¿‡ 'all' ç±»å‹
          if (type === 'all') continue;

          if (stats.count > maxCount) {
            maxCount = stats.count;
            mostCommonType = type;
          }
        }

        return mostCommonType;
      }

      /**
       * è·å–æœ€å¸¸ç”¨çš„éš¾åº¦
       * @returns {number|null} éš¾åº¦å€¼ï¼ˆ1-5ï¼‰ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åˆ™è¿”å› null
       */
      getMostCommonDifficulty() {
        const difficultyStats = this.preferences.basicPreferences.difficulty;
        let maxCount = 0;
        let mostCommonDifficulty = null;

        for (const [difficulty, stats] of Object.entries(difficultyStats)) {
          if (stats.count > maxCount) {
            maxCount = stats.count;
            mostCommonDifficulty = parseInt(difficulty);
          }
        }

        return mostCommonDifficulty;
      }

      /**
       * è·å–å¹³å‡é¢˜ç›®æ•°é‡
       * @returns {number} å¹³å‡é¢˜ç›®æ•°é‡ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åˆ™è¿”å›é»˜è®¤å€¼ 10
       */
      getAverageQuantity() {
        const average = this.preferences.basicPreferences.quantity.average;
        return average || 10;
      }

      /**
       * è·å–æœ€è¿‘ä½¿ç”¨çš„çŸ¥è¯†ç‚¹åˆ—è¡¨
       * @returns {Array<string>} çŸ¥è¯†ç‚¹åç§°æ•°ç»„ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åˆ™è¿”å›ç©ºæ•°ç»„
       */
      getRecentKnowledgePoints() {
        const recent = this.preferences.behaviorPatterns.knowledgePointFocus.recent;
        if (!recent || recent.length === 0) {
          return [];
        }

        // æå–çŸ¥è¯†ç‚¹åç§°
        return recent.map(item => item.knowledgePoint);
      }

      /**
       * è·å–æœ€å¸¸ç”¨çš„å‚æ•°ç»„åˆ
       * @returns {Object} åŒ…å«æœ€å¸¸ç”¨å‚æ•°çš„å¯¹è±¡
       */
      getMostCommonParams() {
        return {
          type: this.getMostCommonType(),
          difficulty: this.getMostCommonDifficulty(),
          count: this.getAverageQuantity(),
          knowledgePoint: this.getRecentKnowledgePoints()[0] || null
        };
      }

      /**
       * æ™ºèƒ½æ¨èå‚æ•° - æ ¸å¿ƒæ–¹æ³•
       * @param {Object} partial - éƒ¨åˆ†å‚æ•°å¯¹è±¡ï¼Œå¯èƒ½åŒ…å«ç‰¹æ®Šæ ‡å¿—
       * @returns {Object} å®Œæ•´çš„æ¨èå‚æ•°å¯¹è±¡
       */
      getRecommendedParams(partial = {}) {
        // 1. å¤„ç†ç‰¹æ®Šæ ‡å¿—ï¼šä½¿ç”¨ä¸Šæ¬¡å‚æ•°
        if (partial._useHistory === true) {
          const lastParams = this.getLastUsedParams();
          // ç§»é™¤ç‰¹æ®Šæ ‡å¿—
          const { _useHistory, _usePreference, ...cleanParams } = lastParams;
          return cleanParams;
        }

        // 2. å¤„ç†ç‰¹æ®Šæ ‡å¿—ï¼šä½¿ç”¨åå¥½å‚æ•°
        if (partial._usePreference === true) {
          const preferredParams = this.getMostCommonParams();
          // ç§»é™¤ç‰¹æ®Šæ ‡å¿—
          const { _useHistory, _usePreference, ...cleanParams } = preferredParams;
          return cleanParams;
        }

        // 3. æ™ºèƒ½å¡«å……ç¼ºå¤±å‚æ•°
        const recommended = { ...partial };

        // ç§»é™¤ç‰¹æ®Šæ ‡å¿—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        delete recommended._useHistory;
        delete recommended._usePreference;

        // å¦‚æœ type ç¼ºå¤±ï¼Œä½¿ç”¨æœ€å¸¸ç”¨é¢˜å‹
        if (!recommended.type) {
          recommended.type = this.getMostCommonType();
        }

        // å¦‚æœ difficulty ç¼ºå¤±ï¼Œä½¿ç”¨æœ€å¸¸ç”¨éš¾åº¦
        if (!recommended.difficulty) {
          recommended.difficulty = this.getMostCommonDifficulty();
        }

        // å¦‚æœ count ç¼ºå¤±ï¼Œä½¿ç”¨å¹³å‡æ•°é‡
        if (!recommended.count) {
          recommended.count = this.getAverageQuantity();
        }

        // å¦‚æœ knowledgePoint ç¼ºå¤±ï¼Œä½¿ç”¨æœ€è¿‘çš„çŸ¥è¯†ç‚¹
        if (!recommended.knowledgePoint) {
          const recentKps = this.getRecentKnowledgePoints();
          if (recentKps.length > 0) {
            recommended.knowledgePoint = recentKps[0];
          }
        }

        return recommended;
      }
    }

    // ========== å¯¹è¯æµç¨‹ç®¡ç†å™¨ ==========
    class ConversationManager {
      constructor(task) {
        this.task = task;
        // æ–°å¢ï¼šæ™ºèƒ½å‚æ•°æå–å™¨
        this.smartExtractor = new SmartParamExtractor();
        // æ–°å¢ï¼šç”¨æˆ·åå¥½ç®¡ç†å™¨
        this.preferenceManager = new UserPreferenceManager();
      }

      // å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œç”ŸæˆAIå“åº”
      processUserInput(userInput) {
        // é€šç”¨å¯¹è¯å¤„ç†
        return this.generateResponse(userInput);
      }

      // ç”ŸæˆAIå“åº”
      generateResponse(input) {
        // æ£€æµ‹æ˜¯å¦è¦é‡æ–°å¼€å§‹æµç¨‹
        const restartKeywords = ['é‡æ–°ç”Ÿæˆé¢˜ç›®', 'é‡æ–°ç”Ÿæˆ', 'é‡æ–°å¼€å§‹', 'å†ç”Ÿæˆ', 'é‡æ¥', 'é‡æ–°å‡ºé¢˜'];
        const shouldRestart = restartKeywords.some(keyword => input.includes(keyword));

        if (shouldRestart) {
          // é‡ç½®ä»»åŠ¡å‚æ•°ï¼Œæ¸…é™¤æ‰€æœ‰çŠ¶æ€
          this.task.generateParams = {
            step: 'init'
          };
          // æ¸…é™¤ç”Ÿæˆçš„é¢˜ç›®
          this.task.generatedQuestions = null;

          return 'å¥½çš„ï¼Œè®©æˆ‘ä»¬é‡æ–°å¼€å§‹ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ç”Ÿæˆä»€ä¹ˆç±»å‹çš„é¢˜ç›®ï¼Ÿ\n\nğŸ’¡ **æç¤º**ï¼š\nâ€¢ æ‚¨å¯ä»¥è¯´"ç”Ÿæˆ10é“å•é€‰é¢˜"\nâ€¢ æˆ–è€…"å•é€‰10é¢˜ã€å¤šé€‰5é¢˜ã€åˆ¤æ–­3é¢˜"ï¼ˆæ··åˆé¢˜å‹ï¼‰\nâ€¢ ä¹Ÿå¯ä»¥ä¸Šä¼ æ–‡æ¡£ï¼Œæˆ‘ä¼šæ ¹æ®æ–‡æ¡£å†…å®¹ç”Ÿæˆé¢˜ç›®';
        }

        // å¦‚æœä»»åŠ¡å·²ç»åœ¨ç”Ÿæˆé¢˜ç›®çš„æµç¨‹ä¸­ï¼Œç›´æ¥ç»§ç»­å¤„ç†
        if (this.task.generateParams && this.task.generateParams.step && this.task.generateParams.step !== 'init') {
          return this.handleGenerateQuestions(input);
        }

        // è¯†åˆ«ç”¨æˆ·æ„å›¾å¹¶ç»™å‡ºç›¸åº”å›å¤
        const intent = this.recognizeIntent(input);

        switch (intent) {
          case 'generate_questions':
            return this.handleGenerateQuestions(input);
          case 'create_paper':
            return this.handleCreatePaper(input);
          case 'create_exam':
            return this.handleCreateExam(input);
          case 'create_practice':
            return this.handleCreatePractice(input);
          case 'greeting':
            return 'æ‚¨å¥½ï¼æˆ‘å¯ä»¥å¸®æ‚¨ç”Ÿæˆé¢˜ç›®ã€åˆ›å»ºè¯•å·ã€ç»„ç»‡è€ƒè¯•ã€å‘å¸ƒåˆ·é¢˜ä»»åŠ¡ç­‰ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ';
          default:
            return 'æˆ‘ç†è§£äº†ã€‚è¯·ç»§ç»­å‘Šè¯‰æˆ‘æ›´å¤šä¿¡æ¯ï¼Œæˆ–è€…å‘Šè¯‰æˆ‘æ‚¨æƒ³åšä»€ä¹ˆï¼Ÿ';
        }
      }

      // è¯†åˆ«ç”¨æˆ·æ„å›¾
      recognizeIntent(input) {
        const lower = input.toLowerCase();

        // é—®å€™è¯­
        if (/^(ä½ å¥½|æ‚¨å¥½|hi|hello|å—¨)/.test(lower)) {
          return 'greeting';
        }

        // ç”Ÿæˆé¢˜ç›®ï¼ˆåŒ…æ‹¬æ ¹æ®æ–‡æ¡£å‡ºé¢˜ã€æ··åˆé¢˜å‹ï¼‰
        // æ£€æµ‹é¢˜å‹å…³é”®è¯ï¼šå•é€‰ã€å¤šé€‰ã€åˆ¤æ–­ã€å¡«ç©ºã€ç®€ç­”ã€å®Œå½¢å¡«ç©ºã€å¤åˆ
        const hasQuestionType = /(å•é€‰|å¤šé€‰|åˆ¤æ–­|å¡«ç©º|ç®€ç­”|å®Œå½¢å¡«ç©º|å¤åˆ)/.test(lower);
        const hasQuantity = /\d+\s*[é“é¢˜ä¸ª]/.test(lower);

        if (lower.includes('ç”Ÿæˆé¢˜ç›®') ||
            /å‡º.*é¢˜/.test(lower) ||  // åŒ¹é…"å‡ºé¢˜"ã€"å‡ºä¸€äº›é¢˜"ã€"å‡ºå‡ é“é¢˜"ç­‰
            (lower.includes('ç”Ÿæˆ') && lower.includes('é¢˜')) ||
            (lower.includes('æ ¹æ®') && (lower.includes('æ–‡æ¡£') || lower.includes('æ–‡ä»¶')) && lower.includes('é¢˜')) ||
            (hasQuestionType && hasQuantity)) {
          return 'generate_questions';
        }

        // åˆ›å»ºè¯•å·
        if (lower.includes('ç»„å·') || lower.includes('è¯•å·') || lower.includes('å‡ºå·')) {
          return 'create_paper';
        }

        // åˆ›å»ºè€ƒè¯•
        if (lower.includes('è€ƒè¯•') && (lower.includes('åˆ›å»º') || lower.includes('å‘å¸ƒ') || lower.includes('ç»„ç»‡'))) {
          return 'create_exam';
        }

        // åˆ·é¢˜ä»»åŠ¡
        if (lower.includes('åˆ·é¢˜') || lower.includes('ç»ƒä¹ ')) {
          return 'create_practice';
        }

        return 'general';
      }

      // å¤„ç†ç”Ÿæˆé¢˜ç›®
      handleGenerateQuestions(input) {
        // åˆå§‹åŒ–å‚æ•°å¯¹è±¡
        if (!this.task.generateParams) {
          this.task.generateParams = {
            step: 'init' // å½“å‰æ­¥éª¤ï¼šinit, type, count, difficulty, knowledge, document, confirm
          };
        }

        const params = this.task.generateParams;
        const currentStep = params.step || 'init';

        // ä½¿ç”¨æ™ºèƒ½æå–å™¨ï¼ˆæ›¿ä»£åŸæœ‰çš„extractQuestionParamsï¼‰
        const extractResult = this.smartExtractor.extract(input, this.getContext());
        const extracted = extractResult.params;
        const confidence = extractResult.confidence;

        // æ£€æŸ¥æ˜¯å¦ä¸ºæ··åˆé¢˜å‹è¯·æ±‚
        if (extracted._mixedTypes) {
          return this.handleMixedTypeGeneration(extracted._mixedTypes);
        }

        // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœç”¨æˆ·è¯´"æ‰€æœ‰é¢˜å‹"ï¼Œè½¬æ¢ä¸ºæ··åˆé¢˜å‹
        if (extracted.type === 'all' && extracted.count) {
          // åˆ›å»ºæ‰€æœ‰é¢˜å‹çš„æ··åˆé…ç½®ï¼Œæ¯ç§é¢˜å‹éƒ½æ˜¯æŒ‡å®šçš„æ•°é‡
          const allTypesMixed = {
            isMixed: true,
            types: [
              { type: 'single', typeName: 'å•é€‰é¢˜', count: extracted.count },
              { type: 'multiple', typeName: 'å¤šé€‰é¢˜', count: extracted.count },
              { type: 'judge', typeName: 'åˆ¤æ–­é¢˜', count: extracted.count },
              { type: 'blank', typeName: 'å¡«ç©ºé¢˜', count: extracted.count },
              { type: 'shortAnswer', typeName: 'ç®€ç­”é¢˜', count: extracted.count },
              { type: 'cloze', typeName: 'å®Œå½¢å¡«ç©ºé¢˜', count: extracted.count },
              { type: 'composite', typeName: 'å¤åˆé¢˜', count: extracted.count }
            ],
            totalCount: extracted.count * 7,
            confidence: 1.0
          };
          return this.handleMixedTypeGeneration(allTypesMixed);
        }

        // æ ¹æ®å½“å‰æ­¥éª¤å¤„ç†
        switch (currentStep) {
          case 'init':
            // åˆå§‹é˜¶æ®µï¼Œä¸åº”ç”¨åå¥½æ¨èï¼Œè®©ç”¨æˆ·é€æ­¥è¾“å…¥
            // åªä½¿ç”¨ç”¨æˆ·æ˜ç¡®æä¾›çš„å‚æ•°
            if (extracted.type) {
              params.type = extracted.type;
              params.typeName = extracted.typeName;
            }
            if (extracted.count) {
              params.count = extracted.count;
            }
            if (extracted.difficulty) {
              params.difficulty = extracted.difficulty;
              params.difficultyName = extracted.difficultyName;
            }
            if (extracted.knowledgePoint) {
              params.knowledgePoint = extracted.knowledgePoint;
            }

            // å¼€å§‹å¼•å¯¼æµç¨‹
            if (!params.type) {
              params.step = 'type';
              return 'å¥½çš„ï¼Œæˆ‘æ¥å¸®æ‚¨ç”Ÿæˆé¢˜ç›®ã€‚\n\nğŸ“ **é€‰æ‹©é¢˜å‹**\n\nè¯·é—®éœ€è¦ç”Ÿæˆä»€ä¹ˆé¢˜å‹ï¼Ÿ\nâ€¢ å•é€‰é¢˜\nâ€¢ å¤šé€‰é¢˜\nâ€¢ åˆ¤æ–­é¢˜\nâ€¢ å¡«ç©ºé¢˜\nâ€¢ ç®€ç­”é¢˜\nâ€¢ å¤åˆé¢˜\nâ€¢ æ‰€æœ‰é¢˜å‹ï¼ˆéšæœºæ··åˆï¼‰\n\næ‚¨å¯ä»¥é€‰æ‹©ä¸€ç§é¢˜å‹ï¼Œæˆ–è€…é€‰æ‹©"æ‰€æœ‰é¢˜å‹"ã€‚';
            } else if (!params.count) {
              params.step = 'count';
              return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆ${params.typeName}ã€‚\n\nğŸ”¢ **è®¾ç½®æ•°é‡**\n\nè¯·é—®éœ€è¦ç”Ÿæˆå¤šå°‘é“é¢˜ï¼Ÿ`;
            } else if (params.hasDocument === undefined) {
              // æ£€æŸ¥æ˜¯å¦å·²ç»ä¸Šä¼ äº†æ–‡æ¡£
              if (uploadedDocument && uploadedDocument.status === 'success') {
                // å·²æœ‰æ–‡æ¡£ï¼Œç›´æ¥ä½¿ç”¨
                params.hasDocument = true;
                params.documentName = uploadedDocument.name;
                params.documentContent = uploadedDocument.content;
                params.step = 'difficulty';
                return `å¥½çš„ï¼Œæˆ‘å°†åŸºäºæ‚¨ä¸Šä¼ çš„æ–‡æ¡£ã€Š${uploadedDocument.name}ã€‹ç”Ÿæˆ${params.count}é“${params.typeName}ã€‚\n\nâ­ **é€‰æ‹©éš¾åº¦**\n\nè¯·é—®éœ€è¦ä»€ä¹ˆéš¾åº¦çš„é¢˜ç›®ï¼Ÿ\nâ€¢ ä¸€çº§ï¼ˆç®€å•ï¼‰\nâ€¢ äºŒçº§ï¼ˆä¸­ç­‰ï¼‰\nâ€¢ ä¸‰çº§ï¼ˆå›°éš¾ï¼‰\nâ€¢ å››çº§ï¼ˆå¾ˆéš¾ï¼‰\nâ€¢ äº”çº§ï¼ˆæéš¾ï¼‰\n\nå¦‚æœä¸æŒ‡å®šéš¾åº¦ï¼Œæˆ‘å°†æ ¹æ®æ–‡æ¡£å†…å®¹è‡ªåŠ¨è°ƒæ•´éš¾åº¦ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"æˆ–"ç¡®è®¤"å¼€å§‹ç”Ÿæˆã€‚`;
              } else {
                // è¯¢é—®æ˜¯å¦æœ‰å‚è€ƒæ–‡æ¡£
                params.step = 'document';
                return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆ${params.count}é“${params.typeName}ã€‚\n\nğŸ“„ **å‚è€ƒæ–‡æ¡£**\n\næ‚¨æœ‰å‚è€ƒæ–‡æ¡£æˆ–æ•™æå—ï¼Ÿå¦‚æœæœ‰ï¼Œæˆ‘å¯ä»¥åŸºäºæ–‡æ¡£å†…å®¹ç”Ÿæˆæ›´è´´åˆçš„é¢˜ç›®ã€‚\n\nè¯·å›å¤ï¼š\nâ€¢ "æœ‰"ï¼ˆç„¶åä¸Šä¼ æ–‡æ¡£æˆ–ç²˜è´´å†…å®¹ï¼‰\nâ€¢ "æ²¡æœ‰"ï¼ˆç›´æ¥ä»é¢˜åº“ä¸­é€‰æ‹©ï¼‰\nâ€¢ "è·³è¿‡"ï¼ˆè·³è¿‡æ­¤æ­¥éª¤ï¼‰`;
              }
            } else if (!params.hasDocument && params.difficulty === undefined) {
              // å¦‚æœæ²¡æœ‰æ–‡æ¡£ï¼Œè¯¢é—®éš¾åº¦
              params.step = 'difficulty';
              return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆ${params.count}é“${params.typeName}ã€‚\n\nâ­ **é€‰æ‹©éš¾åº¦**\n\nè¯·é—®éœ€è¦ä»€ä¹ˆéš¾åº¦çš„é¢˜ç›®ï¼Ÿ\nâ€¢ ä¸€çº§ï¼ˆç®€å•ï¼‰\nâ€¢ äºŒçº§ï¼ˆä¸­ç­‰ï¼‰\nâ€¢ ä¸‰çº§ï¼ˆå›°éš¾ï¼‰\nâ€¢ å››çº§ï¼ˆå¾ˆéš¾ï¼‰\nâ€¢ äº”çº§ï¼ˆæéš¾ï¼‰\n\nå¦‚æœä¸æŒ‡å®šéš¾åº¦ï¼Œæˆ‘å°†éšæœºé€‰æ‹©å„ç§éš¾åº¦çš„é¢˜ç›®ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"ã€‚`;
            } else {
              // å¦‚æœé¢˜å‹ã€æ•°é‡ã€æ–‡æ¡£çŠ¶æ€éƒ½æœ‰äº†ï¼Œè·³åˆ°éš¾åº¦æ­¥éª¤
              params.step = 'difficulty';
              return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆ${params.count}é“${params.typeName}ã€‚\n\nâ­ **ç¬¬${params.hasDocument ? '4' : '3'}æ­¥ï¼šé€‰æ‹©éš¾åº¦**ï¼ˆå¯é€‰ï¼‰\n\nè¯·é—®éœ€è¦ä»€ä¹ˆéš¾åº¦çš„é¢˜ç›®ï¼Ÿ\nâ€¢ ä¸€çº§ï¼ˆç®€å•ï¼‰\nâ€¢ äºŒçº§ï¼ˆä¸­ç­‰ï¼‰\nâ€¢ ä¸‰çº§ï¼ˆå›°éš¾ï¼‰\nâ€¢ å››çº§ï¼ˆå¾ˆéš¾ï¼‰\nâ€¢ äº”çº§ï¼ˆæéš¾ï¼‰\n\nå¦‚æœä¸æŒ‡å®šéš¾åº¦ï¼Œæˆ‘å°†éšæœºé€‰æ‹©å„ç§éš¾åº¦çš„é¢˜ç›®ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"ã€‚`;
            }

          case 'type':
            // æ”¶é›†é¢˜å‹
            if (extracted.type) {
              params.type = extracted.type;
              params.typeName = extracted.typeName;
              params.step = 'count';
              return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆ${params.typeName}ã€‚\n\nğŸ”¢ **è®¾ç½®æ•°é‡**\n\nè¯·é—®éœ€è¦ç”Ÿæˆå¤šå°‘é“é¢˜ï¼Ÿ`;
            } else {
              return 'è¯·é€‰æ‹©ä¸€ä¸ªé¢˜å‹ï¼šå•é€‰é¢˜ã€å¤šé€‰é¢˜ã€åˆ¤æ–­é¢˜ã€å¡«ç©ºé¢˜ã€ç®€ç­”é¢˜æˆ–å¤åˆé¢˜ã€‚';
            }

          case 'count':
            // æ”¶é›†æ•°é‡
            if (extracted.count) {
              // æ£€æŸ¥æ˜¯å¦ä¸º"å„Xé¢˜"æ¨¡å¼
              const countResult = this.smartExtractor.extractCount(input);
              if (countResult && countResult.isEach) {
                // "å„Xé¢˜"è¡¨ç¤ºæ¯ä¸ªé¢˜å‹å„Xé¢˜
                // å¦‚æœä¹‹å‰é€‰æ‹©äº†"æ‰€æœ‰é¢˜å‹"ï¼Œç›´æ¥ç”Ÿæˆæ‰€æœ‰é¢˜å‹çš„æ··åˆé…ç½®
                if (params.type === 'all') {
                  const allTypes = [
                    { type: 'single', typeName: 'å•é€‰é¢˜', count: extracted.count },
                    { type: 'multiple', typeName: 'å¤šé€‰é¢˜', count: extracted.count },
                    { type: 'judge', typeName: 'åˆ¤æ–­é¢˜', count: extracted.count },
                    { type: 'blank', typeName: 'å¡«ç©ºé¢˜', count: extracted.count },
                    { type: 'shortAnswer', typeName: 'ç®€ç­”é¢˜', count: extracted.count },
                    { type: 'cloze', typeName: 'å®Œå½¢å¡«ç©ºé¢˜', count: extracted.count },
                    { type: 'composite', typeName: 'å¤åˆé¢˜', count: extracted.count }
                  ];

                  const mixedTypesData = {
                    isMixed: true,
                    types: allTypes,
                    totalCount: allTypes.length * extracted.count,
                    confidence: 1.0
                  };

                  return this.handleMixedTypeGeneration(mixedTypesData);
                }

                // å¦‚æœä¹‹å‰æ²¡æœ‰é€‰æ‹©é¢˜å‹ï¼Œéœ€è¦è¯¢é—®ç”¨æˆ·æƒ³è¦å“ªäº›é¢˜å‹
                params.eachCount = extracted.count;
                params.step = 'type_selection';
                return `å¥½çš„ï¼Œæˆ‘ç†è§£æ‚¨æƒ³è¦æ¯ä¸ªé¢˜å‹å„${extracted.count}é“é¢˜ã€‚\n\nğŸ“ **è¯·é€‰æ‹©é¢˜å‹**\n\nè¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³è¦å“ªäº›é¢˜å‹ï¼Ÿä¾‹å¦‚ï¼š\nâ€¢ "æ‰€æœ‰é¢˜å‹"ï¼ˆå•é€‰ã€å¤šé€‰ã€åˆ¤æ–­ã€å¡«ç©ºã€ç®€ç­”ã€å®Œå½¢å¡«ç©ºã€å¤åˆï¼‰\nâ€¢ "å•é€‰ã€å¤šé€‰ã€åˆ¤æ–­"ï¼ˆæŒ‡å®šå‡ ç§é¢˜å‹ï¼‰\nâ€¢ "é™¤äº†å¤åˆé¢˜"ï¼ˆæ’é™¤æŸäº›é¢˜å‹ï¼‰\n\næˆ–è€…æ‚¨å¯ä»¥ç›´æ¥è¯´"å•é€‰10é¢˜ã€å¤šé€‰5é¢˜"è¿™æ ·çš„å…·ä½“ç»„åˆã€‚`;
              }

              params.count = extracted.count;
              params.step = 'document'; // è·³è½¬åˆ°æ–‡æ¡£æ­¥éª¤
              return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆ${params.count}é“${params.typeName}ã€‚\n\nğŸ“„ **å‚è€ƒæ–‡æ¡£**\n\næ‚¨æœ‰å‚è€ƒæ–‡æ¡£æˆ–æ•™æå—ï¼Ÿå¦‚æœæœ‰ï¼Œæˆ‘å¯ä»¥åŸºäºæ–‡æ¡£å†…å®¹ç”Ÿæˆæ›´è´´åˆçš„é¢˜ç›®ã€‚\n\nè¯·å›å¤ï¼š\nâ€¢ "æœ‰"ï¼ˆç„¶åä¸Šä¼ æ–‡æ¡£æˆ–ç²˜è´´å†…å®¹ï¼‰\nâ€¢ "æ²¡æœ‰"ï¼ˆç›´æ¥ä»é¢˜åº“ä¸­é€‰æ‹©ï¼‰\nâ€¢ "è·³è¿‡"ï¼ˆè·³è¿‡æ­¤æ­¥éª¤ï¼‰`;
            } else {
              return 'è¯·å‘Šè¯‰æˆ‘éœ€è¦ç”Ÿæˆå¤šå°‘é“é¢˜ï¼Œä¾‹å¦‚ï¼š"5é“"ã€"10ä¸ª"ã€"å„10é¢˜"ç­‰ã€‚';
            }

          case 'document':
            // æ”¶é›†å‚è€ƒæ–‡æ¡£ï¼ˆå¯é€‰ï¼‰
            const hasDocument = input.includes('æœ‰') && !input.includes('æ²¡æœ‰');
            const noDocument = input.includes('æ²¡æœ‰') || input.includes('æ²¡') || input.includes('è·³è¿‡');

            if (hasDocument) {
              params.hasDocument = true;
              params.step = 'waiting_document';
              return 'å¥½çš„ï¼Œè¯·ä¸Šä¼ æ‚¨çš„å‚è€ƒæ–‡æ¡£ï¼Œæˆ–è€…ç›´æ¥ç²˜è´´æ–‡æ¡£å†…å®¹ã€‚\n\næ”¯æŒçš„æ ¼å¼ï¼š\nâ€¢ æ–‡æœ¬å†…å®¹ï¼ˆç›´æ¥ç²˜è´´ï¼‰\nâ€¢ Wordæ–‡æ¡£ï¼ˆ.docxï¼‰\nâ€¢ PDFæ–‡æ¡£ï¼ˆ.pdfï¼‰\nâ€¢ Markdownæ–‡æ¡£ï¼ˆ.mdï¼‰';
            } else if (noDocument) {
              params.hasDocument = false;
              params.step = 'difficulty';
              return `å¥½çš„ï¼Œæˆ‘å°†ä»é¢˜åº“ä¸­ä¸ºæ‚¨é€‰æ‹©é¢˜ç›®ã€‚\n\nâ­ **é€‰æ‹©éš¾åº¦**\n\nè¯·é—®éœ€è¦ä»€ä¹ˆéš¾åº¦çš„é¢˜ç›®ï¼Ÿ\nâ€¢ ä¸€çº§ï¼ˆç®€å•ï¼‰\nâ€¢ äºŒçº§ï¼ˆä¸­ç­‰ï¼‰\nâ€¢ ä¸‰çº§ï¼ˆå›°éš¾ï¼‰\nâ€¢ å››çº§ï¼ˆå¾ˆéš¾ï¼‰\nâ€¢ äº”çº§ï¼ˆæéš¾ï¼‰\n\nå¦‚æœä¸æŒ‡å®šéš¾åº¦ï¼Œæˆ‘å°†éšæœºé€‰æ‹©å„ç§éš¾åº¦çš„é¢˜ç›®ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"ã€‚`;
            } else {
              return 'è¯·å›å¤"æœ‰"æˆ–"æ²¡æœ‰"ã€‚';
            }

          case 'waiting_document':
            // ç­‰å¾…æ–‡æ¡£ä¸Šä¼ 
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå‡è®¾ç”¨æˆ·ç²˜è´´äº†æ–‡æ¡£å†…å®¹
            if (input.length > 50) {
              params.documentContent = input;
              params.step = 'difficulty';
              return `å¥½çš„ï¼Œæˆ‘å·²æ”¶åˆ°æ‚¨çš„å‚è€ƒæ–‡æ¡£ï¼ˆ${input.length}å­—ï¼‰ã€‚\n\nâ­ **é€‰æ‹©éš¾åº¦**\n\nè¯·é—®éœ€è¦ä»€ä¹ˆéš¾åº¦çš„é¢˜ç›®ï¼Ÿ\nâ€¢ ä¸€çº§ï¼ˆç®€å•ï¼‰\nâ€¢ äºŒçº§ï¼ˆä¸­ç­‰ï¼‰\nâ€¢ ä¸‰çº§ï¼ˆå›°éš¾ï¼‰\nâ€¢ å››çº§ï¼ˆå¾ˆéš¾ï¼‰\nâ€¢ äº”çº§ï¼ˆæéš¾ï¼‰\n\nå¦‚æœä¸æŒ‡å®šéš¾åº¦ï¼Œæˆ‘å°†éšæœºé€‰æ‹©å„ç§éš¾åº¦çš„é¢˜ç›®ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"ã€‚`;
            } else {
              return 'æ–‡æ¡£å†…å®¹ä¼¼ä¹å¤ªçŸ­äº†ã€‚è¯·ç²˜è´´å®Œæ•´çš„æ–‡æ¡£å†…å®¹ï¼Œæˆ–è€…å›å¤"è·³è¿‡"ç›´æ¥ä»é¢˜åº“ç”Ÿæˆã€‚';
            }

          case 'difficulty':
            // æ”¶é›†éš¾åº¦ï¼ˆå¯é€‰ï¼‰
            const skipKeywords = ['è·³è¿‡', 'ä¸éœ€è¦', 'éšæœº', 'ä¸ç”¨', 'ç®—äº†'];
            const shouldSkip = skipKeywords.some(keyword => input.includes(keyword));

            if (extracted.difficulty) {
              params.difficulty = extracted.difficulty;
              params.difficultyName = extracted.difficultyName;
            } else if (!shouldSkip) {
              // ç”¨æˆ·è¾“å…¥äº†å†…å®¹ä½†æ²¡æœ‰è¯†åˆ«åˆ°éš¾åº¦ï¼Œæç¤ºé‡æ–°è¾“å…¥
              if (input.trim().length > 0 && !skipKeywords.some(k => input.includes(k))) {
                return 'è¯·é€‰æ‹©ä¸€ä¸ªéš¾åº¦ï¼šä¸€çº§ã€äºŒçº§ã€ä¸‰çº§ã€å››çº§æˆ–äº”çº§ã€‚æ‚¨ä¹Ÿå¯ä»¥å›å¤"è·³è¿‡"æ¥éšæœºé€‰æ‹©ã€‚';
              }
            }

            // è¿›å…¥ä¸‹ä¸€æ­¥ï¼šçŸ¥è¯†ç‚¹
            params.step = 'knowledge';
            const difficultyInfo = params.difficultyName ? `éš¾åº¦ä¸º${params.difficultyName}çš„` : '';
            return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆ${params.count}é“${difficultyInfo}${params.typeName}ã€‚\n\nğŸ“š **é€‰æ‹©çŸ¥è¯†ç‚¹**\n\nè¯·é—®éœ€è¦å“ªä¸ªçŸ¥è¯†ç‚¹çš„é¢˜ç›®ï¼Ÿä¾‹å¦‚ï¼š\nâ€¢ æ•°æ®ç»“æ„\nâ€¢ ç®—æ³•\nâ€¢ æ“ä½œç³»ç»Ÿ\nâ€¢ è®¡ç®—æœºç½‘ç»œ\n\nå¦‚æœä¸æŒ‡å®šçŸ¥è¯†ç‚¹ï¼Œæˆ‘å°†ä»æ‰€æœ‰çŸ¥è¯†ç‚¹ä¸­éšæœºé€‰æ‹©ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"ã€‚`;

          case 'type_selection':
            // å¤„ç†"å„Xé¢˜"åçš„é¢˜å‹é€‰æ‹©
            const lower = input.toLowerCase();

            // æ£€æŸ¥æ˜¯å¦ä¸ºå…·ä½“çš„æ··åˆé¢˜å‹ç»„åˆï¼ˆå¦‚"å•é€‰10é¢˜ã€å¤šé€‰5é¢˜"ï¼‰
            const mixedTypes = this.smartExtractor.extractMixedTypes(input);
            if (mixedTypes && mixedTypes.isMixed) {
              return this.handleMixedTypeGeneration(mixedTypes);
            }

            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©"æ‰€æœ‰é¢˜å‹"
            if (lower.includes('æ‰€æœ‰') || lower.includes('å…¨éƒ¨')) {
              // ç”Ÿæˆæ‰€æœ‰é¢˜å‹çš„æ··åˆé¢˜å‹é…ç½®
              const allTypes = [
                { type: 'single', typeName: 'å•é€‰é¢˜', count: params.eachCount },
                { type: 'multiple', typeName: 'å¤šé€‰é¢˜', count: params.eachCount },
                { type: 'judge', typeName: 'åˆ¤æ–­é¢˜', count: params.eachCount },
                { type: 'blank', typeName: 'å¡«ç©ºé¢˜', count: params.eachCount },
                { type: 'shortAnswer', typeName: 'ç®€ç­”é¢˜', count: params.eachCount },
                { type: 'cloze', typeName: 'å®Œå½¢å¡«ç©ºé¢˜', count: params.eachCount },
                { type: 'composite', typeName: 'å¤åˆé¢˜', count: params.eachCount }
              ];

              const mixedTypesData = {
                isMixed: true,
                types: allTypes,
                totalCount: allTypes.length * params.eachCount,
                confidence: 1.0
              };

              return this.handleMixedTypeGeneration(mixedTypesData);
            }

            // æ£€æŸ¥æ˜¯å¦æŒ‡å®šäº†éƒ¨åˆ†é¢˜å‹
            const typePatterns = {
              'single': /(å•é€‰)/,
              'multiple': /(å¤šé€‰)/,
              'judge': /(åˆ¤æ–­)/,
              'blank': /(å¡«ç©º)/,
              'shortAnswer': /(ç®€ç­”)/,
              'cloze': /(å®Œå½¢å¡«ç©º)/,
              'composite': /(å¤åˆ)/
            };

            const typeNames = {
              'single': 'å•é€‰é¢˜',
              'multiple': 'å¤šé€‰é¢˜',
              'judge': 'åˆ¤æ–­é¢˜',
              'blank': 'å¡«ç©ºé¢˜',
              'shortAnswer': 'ç®€ç­”é¢˜',
              'cloze': 'å®Œå½¢å¡«ç©ºé¢˜',
              'composite': 'å¤åˆé¢˜'
            };

            const selectedTypes = [];
            for (const [typeKey, pattern] of Object.entries(typePatterns)) {
              if (pattern.test(input)) {
                selectedTypes.push({
                  type: typeKey,
                  typeName: typeNames[typeKey],
                  count: params.eachCount
                });
              }
            }

            if (selectedTypes.length >= 2) {
              // ç”¨æˆ·æŒ‡å®šäº†å¤šä¸ªé¢˜å‹
              const mixedTypesData = {
                isMixed: true,
                types: selectedTypes,
                totalCount: selectedTypes.length * params.eachCount,
                confidence: 1.0
              };

              return this.handleMixedTypeGeneration(mixedTypesData);
            } else if (selectedTypes.length === 1) {
              // åªé€‰æ‹©äº†ä¸€ä¸ªé¢˜å‹ï¼Œè½¬ä¸ºå•é¢˜å‹æµç¨‹
              params.type = selectedTypes[0].type;
              params.typeName = selectedTypes[0].typeName;
              params.count = params.eachCount;
              delete params.eachCount;
              params.step = 'document';
              return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆ${params.count}é“${params.typeName}ã€‚\n\nğŸ“„ **ç¬¬3æ­¥ï¼šå‚è€ƒæ–‡æ¡£**ï¼ˆå¯é€‰ï¼‰\n\næ‚¨æœ‰å‚è€ƒæ–‡æ¡£æˆ–æ•™æå—ï¼Ÿå¦‚æœæœ‰ï¼Œæˆ‘å¯ä»¥åŸºäºæ–‡æ¡£å†…å®¹ç”Ÿæˆæ›´è´´åˆçš„é¢˜ç›®ã€‚\n\nè¯·å›å¤ï¼š\nâ€¢ "æœ‰"ï¼ˆç„¶åä¸Šä¼ æ–‡æ¡£æˆ–ç²˜è´´å†…å®¹ï¼‰\nâ€¢ "æ²¡æœ‰"ï¼ˆç›´æ¥ä»é¢˜åº“ä¸­é€‰æ‹©ï¼‰\nâ€¢ "è·³è¿‡"ï¼ˆè·³è¿‡æ­¤æ­¥éª¤ï¼‰`;
            } else {
              return 'è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³è¦å“ªäº›é¢˜å‹ã€‚ä¾‹å¦‚ï¼š\nâ€¢ "æ‰€æœ‰é¢˜å‹"\nâ€¢ "å•é€‰ã€å¤šé€‰ã€åˆ¤æ–­"\nâ€¢ "å•é€‰10é¢˜ã€å¤šé€‰5é¢˜"ï¼ˆå…·ä½“ç»„åˆï¼‰';
            }

          case 'knowledge':
            // æ”¶é›†çŸ¥è¯†ç‚¹ï¼ˆå¯é€‰ï¼‰
            const skipKnowledge = ['è·³è¿‡', 'ä¸éœ€è¦', 'éšæœº', 'ä¸ç”¨', 'ç®—äº†'];
            const shouldSkipKnowledge = skipKnowledge.some(keyword => input.includes(keyword));

            if (extracted.knowledgePoint) {
              params.knowledgePoint = extracted.knowledgePoint;
            }

            // è¿›å…¥ç¡®è®¤æ­¥éª¤
            params.step = 'confirm';
            return this.showGenerateConfirmation(params);

          case 'mixed_document':
            // æ··åˆé¢˜å‹çš„æ–‡æ¡£è¯¢é—®æ­¥éª¤
            const hasDoc = input.includes('æœ‰') && !input.includes('æ²¡æœ‰');
            const noDoc = input.includes('æ²¡æœ‰') || input.includes('æ²¡') || input.includes('è·³è¿‡');
            const confirmNow = input.includes('ç¡®è®¤') || input.includes('å¼€å§‹') || input.includes('ç”Ÿæˆ');

            if (confirmNow) {
              // ç›´æ¥è·³è¿‡æ–‡æ¡£ï¼Œè¿›å…¥éš¾åº¦é€‰æ‹©
              params.hasDocument = false;
              params.step = 'mixed_difficulty';
              return `å¥½çš„ï¼Œæˆ‘å°†ä»é¢˜åº“ä¸­ä¸ºæ‚¨é€‰æ‹©é¢˜ç›®ã€‚\n\nâ­ **é€‰æ‹©éš¾åº¦**\n\nè¯·é—®éœ€è¦ä»€ä¹ˆéš¾åº¦çš„é¢˜ç›®ï¼Ÿ\nâ€¢ ä¸€çº§ï¼ˆç®€å•ï¼‰\nâ€¢ äºŒçº§ï¼ˆä¸­ç­‰ï¼‰\nâ€¢ ä¸‰çº§ï¼ˆå›°éš¾ï¼‰\nâ€¢ å››çº§ï¼ˆå¾ˆéš¾ï¼‰\nâ€¢ äº”çº§ï¼ˆæéš¾ï¼‰\n\nå¦‚æœä¸æŒ‡å®šéš¾åº¦ï¼Œæˆ‘å°†éšæœºé€‰æ‹©å„ç§éš¾åº¦çš„é¢˜ç›®ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"ã€‚`;
            } else if (hasDoc) {
              params.hasDocument = true;
              params.step = 'mixed_waiting_document';
              return 'å¥½çš„ï¼Œè¯·ä¸Šä¼ æ‚¨çš„å‚è€ƒæ–‡æ¡£ï¼Œæˆ–è€…ç›´æ¥ç²˜è´´æ–‡æ¡£å†…å®¹ã€‚\n\næ”¯æŒçš„æ ¼å¼ï¼š\nâ€¢ æ–‡æœ¬å†…å®¹ï¼ˆç›´æ¥ç²˜è´´ï¼‰\nâ€¢ Wordæ–‡æ¡£ï¼ˆ.docxï¼‰\nâ€¢ PDFæ–‡æ¡£ï¼ˆ.pdfï¼‰\nâ€¢ Markdownæ–‡æ¡£ï¼ˆ.mdï¼‰';
            } else if (noDoc) {
              params.hasDocument = false;
              params.step = 'mixed_difficulty';
              return `å¥½çš„ï¼Œæˆ‘å°†ä»é¢˜åº“ä¸­ä¸ºæ‚¨é€‰æ‹©é¢˜ç›®ã€‚\n\nâ­ **é€‰æ‹©éš¾åº¦**\n\nè¯·é—®éœ€è¦ä»€ä¹ˆéš¾åº¦çš„é¢˜ç›®ï¼Ÿ\nâ€¢ ä¸€çº§ï¼ˆç®€å•ï¼‰\nâ€¢ äºŒçº§ï¼ˆä¸­ç­‰ï¼‰\nâ€¢ ä¸‰çº§ï¼ˆå›°éš¾ï¼‰\nâ€¢ å››çº§ï¼ˆå¾ˆéš¾ï¼‰\nâ€¢ äº”çº§ï¼ˆæéš¾ï¼‰\n\nå¦‚æœä¸æŒ‡å®šéš¾åº¦ï¼Œæˆ‘å°†éšæœºé€‰æ‹©å„ç§éš¾åº¦çš„é¢˜ç›®ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"ã€‚`;
            } else {
              return 'è¯·å›å¤"æœ‰"ã€"æ²¡æœ‰"æˆ–"è·³è¿‡"ã€‚';
            }

          case 'mixed_waiting_document':
            // ç­‰å¾…æ··åˆé¢˜å‹çš„æ–‡æ¡£ä¸Šä¼ 
            if (input.length > 50) {
              params.documentContent = input;
              params.step = 'mixed_difficulty';
              return `å¥½çš„ï¼Œæˆ‘å·²æ”¶åˆ°æ‚¨çš„å‚è€ƒæ–‡æ¡£ï¼ˆ${input.length}å­—ï¼‰ã€‚\n\nâ­ **é€‰æ‹©éš¾åº¦**\n\nè¯·é—®éœ€è¦ä»€ä¹ˆéš¾åº¦çš„é¢˜ç›®ï¼Ÿ\nâ€¢ ä¸€çº§ï¼ˆç®€å•ï¼‰\nâ€¢ äºŒçº§ï¼ˆä¸­ç­‰ï¼‰\nâ€¢ ä¸‰çº§ï¼ˆå›°éš¾ï¼‰\nâ€¢ å››çº§ï¼ˆå¾ˆéš¾ï¼‰\nâ€¢ äº”çº§ï¼ˆæéš¾ï¼‰\n\nå¦‚æœä¸æŒ‡å®šéš¾åº¦ï¼Œæˆ‘å°†éšæœºé€‰æ‹©å„ç§éš¾åº¦çš„é¢˜ç›®ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"ã€‚`;
            } else {
              return 'è¯·ä¸Šä¼ æ–‡æ¡£æˆ–ç²˜è´´æ–‡æ¡£å†…å®¹ã€‚å¦‚æœä¸éœ€è¦å‚è€ƒæ–‡æ¡£ï¼Œè¯·å›å¤"è·³è¿‡"ã€‚';
            }

          case 'mixed_difficulty':
            // æ··åˆé¢˜å‹çš„éš¾åº¦é€‰æ‹©æ­¥éª¤
            const skipDifficultyMixed = ['è·³è¿‡', 'ä¸éœ€è¦', 'éšæœº', 'ä¸ç”¨', 'ç®—äº†'];
            const shouldSkipDifficultyMixed = skipDifficultyMixed.some(keyword => input.includes(keyword));

            if (extracted.difficulty) {
              params.difficulty = extracted.difficulty;
              params.difficultyName = extracted.difficultyName;
            } else if (!shouldSkipDifficultyMixed) {
              // ç”¨æˆ·è¾“å…¥äº†å†…å®¹ä½†æ²¡æœ‰è¯†åˆ«åˆ°éš¾åº¦ï¼Œæç¤ºé‡æ–°è¾“å…¥
              if (input.trim().length > 0 && !skipDifficultyMixed.some(k => input.includes(k))) {
                return 'è¯·é€‰æ‹©ä¸€ä¸ªéš¾åº¦ï¼šä¸€çº§ã€äºŒçº§ã€ä¸‰çº§ã€å››çº§æˆ–äº”çº§ã€‚æ‚¨ä¹Ÿå¯ä»¥å›å¤"è·³è¿‡"æ¥éšæœºé€‰æ‹©ã€‚';
              }
            }

            // è¿›å…¥çŸ¥è¯†ç‚¹é€‰æ‹©æ­¥éª¤
            params.step = 'mixed_knowledge';
            const difficultyInfoMixed = params.difficultyName ? `éš¾åº¦ä¸º${params.difficultyName}çš„` : '';
            return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆ${difficultyInfoMixed}é¢˜ç›®ã€‚\n\nğŸ“š **é€‰æ‹©çŸ¥è¯†ç‚¹**\n\nè¯·é—®éœ€è¦å“ªä¸ªçŸ¥è¯†ç‚¹çš„é¢˜ç›®ï¼Ÿä¾‹å¦‚ï¼š\nâ€¢ æ•°æ®ç»“æ„\nâ€¢ ç®—æ³•\nâ€¢ æ“ä½œç³»ç»Ÿ\nâ€¢ è®¡ç®—æœºç½‘ç»œ\n\nå¦‚æœä¸æŒ‡å®šçŸ¥è¯†ç‚¹ï¼Œæˆ‘å°†ä»æ‰€æœ‰çŸ¥è¯†ç‚¹ä¸­éšæœºé€‰æ‹©ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"ã€‚`;

          case 'mixed_knowledge':
            // æ··åˆé¢˜å‹çš„çŸ¥è¯†ç‚¹é€‰æ‹©æ­¥éª¤
            const skipKnowledgeMixed = ['è·³è¿‡', 'ä¸éœ€è¦', 'éšæœº', 'ä¸ç”¨', 'ç®—äº†'];
            const shouldSkipKnowledgeMixed = skipKnowledgeMixed.some(keyword => input.includes(keyword));

            if (extracted.knowledgePoint) {
              params.knowledgePoint = extracted.knowledgePoint;
            }

            // è¿›å…¥ç¡®è®¤æ­¥éª¤
            params.step = 'mixed_confirm';
            return this.showMixedTypeConfirmation(params);

          case 'mixed_confirm':
            // æ··åˆé¢˜å‹ç¡®è®¤å¹¶ç”Ÿæˆ
            const inputLowerMixed = input.toLowerCase();

            // ä¼˜å…ˆæ£€æŸ¥å®Œæ•´çŸ­è¯­ï¼Œé¿å…è¯¯åˆ¤
            if (inputLowerMixed.includes('é‡æ–°ç”Ÿæˆ') || inputLowerMixed.includes('å¼€å§‹ç”Ÿæˆ') || inputLowerMixed.includes('ç»§ç»­ç”Ÿæˆ')) {
              // "é‡æ–°ç”Ÿæˆ"ç­‰çŸ­è¯­åº”è¯¥è¢«è¯†åˆ«ä¸ºç¡®è®¤ç”Ÿæˆ
              return this.generateMixedTypeQuestions(params);
            }

            const confirmMixed = ['ç¡®è®¤', 'å¼€å§‹', 'ç”Ÿæˆ', 'å¥½çš„', 'æ˜¯çš„', 'yes', 'ok'];
            const cancelMixed = ['å–æ¶ˆ', 'ä¸è¦', 'ä¸è¡Œ', 'ç®—äº†'];

            if (confirmMixed.some(keyword => inputLowerMixed.includes(keyword))) {
              return this.generateMixedTypeQuestions(params);
            } else if (cancelMixed.some(keyword => inputLowerMixed.includes(keyword))) {
              this.task.generateParams = { step: 'init' };
              return 'å¥½çš„ï¼Œå·²å–æ¶ˆã€‚å¦‚æœæ‚¨æƒ³é‡æ–°ç”Ÿæˆé¢˜ç›®ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚';
            } else {
              return 'è¯·å›å¤"ç¡®è®¤"å¼€å§‹ç”Ÿæˆï¼Œæˆ–å›å¤"å–æ¶ˆ"é‡æ–°è®¾ç½®ã€‚';
            }

          case 'confirm':
            // ç¡®è®¤å¹¶ç”Ÿæˆ
            const inputLowerConfirm = input.toLowerCase();

            // ä¼˜å…ˆæ£€æŸ¥å®Œæ•´çŸ­è¯­ï¼Œé¿å…è¯¯åˆ¤
            if (inputLowerConfirm.includes('é‡æ–°ç”Ÿæˆ') || inputLowerConfirm.includes('å¼€å§‹ç”Ÿæˆ') || inputLowerConfirm.includes('ç»§ç»­ç”Ÿæˆ')) {
              // "é‡æ–°ç”Ÿæˆ"ç­‰çŸ­è¯­åº”è¯¥è¢«è¯†åˆ«ä¸ºç¡®è®¤ç”Ÿæˆ
              return this.generateQuestionsNow(params);
            }

            const confirmKeywords = ['ç¡®è®¤', 'å¼€å§‹', 'ç”Ÿæˆ', 'å¥½çš„', 'æ˜¯çš„', 'yes', 'ok'];
            const cancelKeywords = ['å–æ¶ˆ', 'ä¸è¦', 'ä¸è¡Œ', 'ç®—äº†'];

            if (confirmKeywords.some(keyword => inputLowerConfirm.includes(keyword))) {
              // å¼€å§‹ç”Ÿæˆé¢˜ç›®
              return this.generateQuestionsNow(params);
            } else if (cancelKeywords.some(keyword => inputLowerConfirm.includes(keyword))) {
              // å–æ¶ˆæˆ–é‡æ–°å¼€å§‹
              this.task.generateParams = { step: 'init' };
              return 'å¥½çš„ï¼Œå·²å–æ¶ˆã€‚å¦‚æœæ‚¨æƒ³é‡æ–°ç”Ÿæˆé¢˜ç›®ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚';
            } else {
              return 'è¯·å›å¤"ç¡®è®¤"å¼€å§‹ç”Ÿæˆï¼Œæˆ–å›å¤"å–æ¶ˆ"é‡æ–°è®¾ç½®ã€‚';
            }

          default:
            params.step = 'init';
            return 'å¥½çš„ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨ç”Ÿæˆé¢˜ç›®ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆé¢˜å‹çš„é¢˜ç›®ï¼Ÿ';
        }
      }

      // æ˜¾ç¤ºç”Ÿæˆç¡®è®¤ä¿¡æ¯
      showGenerateConfirmation(params) {
        let summary = 'ğŸ“‹ **ç”Ÿæˆé¢˜ç›®ç¡®è®¤**\n\n';
        summary += `â€¢ é¢˜å‹ï¼š${params.typeName}\n`;
        summary += `â€¢ æ•°é‡ï¼š${params.count}é“\n`;

        if (params.difficultyName) {
          summary += `â€¢ éš¾åº¦ï¼š${params.difficultyName}\n`;
        } else {
          summary += `â€¢ éš¾åº¦ï¼šéšæœº\n`;
        }

        if (params.knowledgePoint) {
          summary += `â€¢ çŸ¥è¯†ç‚¹ï¼š${params.knowledgePoint}\n`;
        } else {
          summary += `â€¢ çŸ¥è¯†ç‚¹ï¼šéšæœº\n`;
        }

        if (params.hasDocument) {
          summary += `â€¢ å‚è€ƒæ–‡æ¡£ï¼šå·²æä¾›\n`;
        } else {
          summary += `â€¢ å‚è€ƒæ–‡æ¡£ï¼šä»é¢˜åº“é€‰æ‹©\n`;
        }

        summary += '\nè¯·ç¡®è®¤ä»¥ä¸Šä¿¡æ¯ï¼Œå›å¤"ç¡®è®¤"å¼€å§‹ç”Ÿæˆé¢˜ç›®ã€‚';

        return summary;
      }

      /**
       * å¤„ç†æ··åˆé¢˜å‹ç”Ÿæˆè¯·æ±‚
       * @param {Object} mixedTypes - æ··åˆé¢˜å‹æ•°æ®
       * @returns {string} å›å¤æ¶ˆæ¯
       */
      handleMixedTypeGeneration(mixedTypes) {
        // æ„å»ºç¡®è®¤æ¶ˆæ¯
        let message = 'å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆï¼š\n\n';

        mixedTypes.types.forEach((typeInfo, index) => {
          message += `${index + 1}. ${typeInfo.typeName} ${typeInfo.count}é“\n`;
        });

        message += `\nå…± ${mixedTypes.totalCount} é“é¢˜ç›®ã€‚\n\n`;

        // æ£€æŸ¥æ˜¯å¦å·²ç»ä¸Šä¼ äº†æ–‡æ¡£
        if (uploadedDocument && uploadedDocument.status === 'success') {
          // å·²æœ‰æ–‡æ¡£ï¼Œè¯¢é—®éš¾åº¦
          message += `ğŸ“„ **å‚è€ƒæ–‡æ¡£**ï¼šå·²ä½¿ç”¨æ‚¨ä¸Šä¼ çš„æ–‡æ¡£ã€Š${uploadedDocument.name}ã€‹\n\n`;
          message += 'â­ **é€‰æ‹©éš¾åº¦**\n\n';
          message += 'è¯·é—®éœ€è¦ä»€ä¹ˆéš¾åº¦çš„é¢˜ç›®ï¼Ÿ\n';
          message += 'â€¢ ä¸€çº§ï¼ˆç®€å•ï¼‰\n';
          message += 'â€¢ äºŒçº§ï¼ˆä¸­ç­‰ï¼‰\n';
          message += 'â€¢ ä¸‰çº§ï¼ˆå›°éš¾ï¼‰\n';
          message += 'â€¢ å››çº§ï¼ˆå¾ˆéš¾ï¼‰\n';
          message += 'â€¢ äº”çº§ï¼ˆæéš¾ï¼‰\n\n';
          message += 'å¦‚æœä¸æŒ‡å®šéš¾åº¦ï¼Œæˆ‘å°†éšæœºé€‰æ‹©å„ç§éš¾åº¦çš„é¢˜ç›®ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"ã€‚';

          // ä¿å­˜æ··åˆé¢˜å‹ä¿¡æ¯åˆ°ä»»åŠ¡å‚æ•°ï¼ˆåŒ…å«æ–‡æ¡£ä¿¡æ¯ï¼‰
          this.task.generateParams = {
            step: 'mixed_difficulty',
            mixedTypes: mixedTypes,
            isMixed: true,
            hasDocument: true,
            documentName: uploadedDocument.name,
            documentContent: uploadedDocument.content
          };
        } else {
          // æ²¡æœ‰æ–‡æ¡£ï¼Œè¯¢é—®æ˜¯å¦éœ€è¦
          message += 'ğŸ“„ **å‚è€ƒæ–‡æ¡£**\n\n';
          message += 'æ‚¨æœ‰å‚è€ƒæ–‡æ¡£æˆ–æ•™æå—ï¼Ÿå¦‚æœæœ‰ï¼Œæˆ‘å¯ä»¥åŸºäºæ–‡æ¡£å†…å®¹ç”Ÿæˆæ›´è´´åˆçš„é¢˜ç›®ã€‚\n\n';
          message += 'è¯·å›å¤ï¼š\n';
          message += 'â€¢ "æœ‰"ï¼ˆç„¶åä¸Šä¼ æ–‡æ¡£æˆ–ç²˜è´´å†…å®¹ï¼‰\n';
          message += 'â€¢ "æ²¡æœ‰"ï¼ˆç›´æ¥ä»é¢˜åº“ä¸­é€‰æ‹©ï¼‰\n';
          message += 'â€¢ "è·³è¿‡"ï¼ˆè·³è¿‡æ­¤æ­¥éª¤ï¼‰';

          // ä¿å­˜æ··åˆé¢˜å‹ä¿¡æ¯åˆ°ä»»åŠ¡å‚æ•°
          this.task.generateParams = {
            step: 'mixed_document',
            mixedTypes: mixedTypes,
            isMixed: true
          };
        }

        return message;
      }

      /**
       * æ˜¾ç¤ºæ··åˆé¢˜å‹ç¡®è®¤ä¿¡æ¯
       * @param {Object} params - ç”Ÿæˆå‚æ•°
       * @returns {string} ç¡®è®¤æ¶ˆæ¯
       */
      showMixedTypeConfirmation(params) {
        let message = 'âœ… **ç¡®è®¤ç”Ÿæˆå‚æ•°**\n\n';

        // æ˜¾ç¤ºæ¯ç§é¢˜å‹çš„ä¿¡æ¯
        message += 'ğŸ“ **é¢˜ç›®æ¸…å•**ï¼š\n';
        params.mixedTypes.types.forEach((typeInfo, index) => {
          message += `${index + 1}. ${typeInfo.typeName} Ã— ${typeInfo.count}é“\n`;
        });

        message += `\nğŸ“Š **æ€»è®¡**ï¼š${params.mixedTypes.totalCount}é“é¢˜ç›®\n`;

        // æ˜¾ç¤ºéš¾åº¦ä¿¡æ¯
        if (params.difficulty === 'all') {
          message += 'â­ **éš¾åº¦**ï¼šè¦†ç›–æ‰€æœ‰éš¾åº¦ï¼ˆä¸€çº§è‡³äº”çº§ï¼‰\n';
        } else if (params.difficulty && params.difficultyName) {
          message += `â­ **éš¾åº¦**ï¼š${params.difficultyName}\n`;
        } else {
          message += 'â­ **éš¾åº¦**ï¼šéšæœº\n';
        }

        // æ˜¾ç¤ºçŸ¥è¯†ç‚¹ä¿¡æ¯
        if (params.knowledgePoint === 'all') {
          message += 'ğŸ“š **çŸ¥è¯†ç‚¹**ï¼šè¦†ç›–æ‰€æœ‰çŸ¥è¯†ç‚¹\n';
        } else if (params.knowledgePoint) {
          message += `ğŸ“š **çŸ¥è¯†ç‚¹**ï¼š${params.knowledgePoint}\n`;
        } else {
          message += 'ğŸ“š **çŸ¥è¯†ç‚¹**ï¼šéšæœº\n';
        }

        // æ˜¾ç¤ºæ–‡æ¡£ä¿¡æ¯
        if (params.hasDocument && params.documentContent) {
          message += `ğŸ“„ **å‚è€ƒæ–‡æ¡£**ï¼šå·²æä¾›ï¼ˆ${params.documentContent.length}å­—ï¼‰\n`;
        } else {
          message += 'ğŸ“„ **å‚è€ƒæ–‡æ¡£**ï¼šæ— ï¼ˆä»é¢˜åº“éšæœºé€‰æ‹©ï¼‰\n';
        }

        message += '\nè¯·å›å¤"ç¡®è®¤"å¼€å§‹ç”Ÿæˆï¼Œæˆ–å›å¤"å–æ¶ˆ"é‡æ–°è®¾ç½®ã€‚';

        return message;
      }

      /**
       * ç”Ÿæˆæ··åˆé¢˜å‹é¢˜ç›®
       * @param {Object} params - ç”Ÿæˆå‚æ•°
       * @returns {string} ç”Ÿæˆç»“æœæ¶ˆæ¯
       */
      generateMixedTypeQuestions(params) {
        try {
          // ä¸ºæ¯ç§é¢˜å‹ç”Ÿæˆé¢˜ç›®
          const allSelectedQuestions = [];
          const generationResults = [];

          // å¦‚æœç”¨æˆ·ä¸Šä¼ äº†æ–‡æ¡£ï¼Œæ¨¡æ‹ŸåŸºäºæ–‡æ¡£ç”Ÿæˆé¢˜ç›®
          if (params.hasDocument) {
            params.mixedTypes.types.forEach(typeInfo => {
              const questions = this.generateQuestionsFromDocument({
                type: typeInfo.type,
                typeName: typeInfo.typeName,
                count: typeInfo.count,
                difficulty: params.difficulty,
                difficultyName: params.difficultyName,
                knowledgePoint: params.knowledgePoint,
                hasDocument: true
              });

              allSelectedQuestions.push(...questions);

              generationResults.push({
                type: typeInfo.typeName,
                count: questions.length,
                requested: typeInfo.count,
                success: true,
                message: `æˆåŠŸç”Ÿæˆ${questions.length}é“${typeInfo.typeName}`
              });

              // è®°å½•æ¯ç§é¢˜å‹çš„ç”¨æˆ·è¡Œä¸º
              this.preferenceManager.recordAction({
                type: typeInfo.type,
                count: questions.length,
                difficulty: params.difficulty,
                knowledgePoint: params.knowledgePoint,
                timestamp: new Date()
              });
            });
          } else {
            // ä»é¢˜åº“ä¸­åŠ è½½æ‰€æœ‰é¢˜ç›®
            const allQuestions = loadQuestionsData();

            if (!allQuestions || allQuestions.length === 0) {
              return 'æŠ±æ­‰ï¼Œé¢˜åº“ä¸­æš‚æ— é¢˜ç›®ã€‚è¯·å…ˆåœ¨é¢˜åº“ç®¡ç†ä¸­æ·»åŠ é¢˜ç›®ã€‚';
            }

            params.mixedTypes.types.forEach(typeInfo => {
              // å¤„ç†"æ‰€æœ‰éš¾åº¦"çš„æƒ…å†µ
              if (params.difficulty === 'all') {
                // æŒ‰éš¾åº¦åˆ†ç»„
                const questionsByDifficulty = {
                  1: [], 2: [], 3: [], 4: [], 5: []
                };

                allQuestions.forEach(q => {
                  if (q.type !== typeInfo.type) return;

                  // çŸ¥è¯†ç‚¹åŒ¹é…ï¼ˆå¦‚æœæŒ‡å®šäº†çŸ¥è¯†ç‚¹ï¼‰
                  if (params.knowledgePoint && params.knowledgePoint !== 'all' &&
                      q.knowledgePath && !q.knowledgePath.includes(params.knowledgePoint)) {
                    return;
                  }

                  if (q.difficulty >= 1 && q.difficulty <= 5) {
                    questionsByDifficulty[q.difficulty].push(q);
                  }
                });

                // ä»æ¯ä¸ªéš¾åº¦çº§åˆ«éšæœºé€‰æ‹©é¢˜ç›®
                const selectedQuestions = [];
                const questionsPerDifficulty = Math.ceil(typeInfo.count / 5);

                for (let diff = 1; diff <= 5; diff++) {
                  const diffQuestions = questionsByDifficulty[diff];
                  if (diffQuestions.length > 0) {
                    const selected = this.randomSelectQuestions(diffQuestions, questionsPerDifficulty);
                    selectedQuestions.push(...selected);
                  }
                }

                // å¦‚æœæ€»æ•°è¶…è¿‡è¦æ±‚ï¼Œéšæœºåˆ é™¤å¤šä½™çš„
                let finalQuestions = selectedQuestions;
                if (selectedQuestions.length > typeInfo.count) {
                  finalQuestions = this.randomSelectQuestions(selectedQuestions, typeInfo.count);
                }

                allSelectedQuestions.push(...finalQuestions);

                generationResults.push({
                  type: typeInfo.typeName,
                  count: finalQuestions.length,
                  requested: typeInfo.count,
                  success: finalQuestions.length === typeInfo.count,
                  message: finalQuestions.length < typeInfo.count ?
                    `é¢˜åº“ä¸­åªæœ‰${finalQuestions.length}é“${typeInfo.typeName}` :
                    `æˆåŠŸç”Ÿæˆ${finalQuestions.length}é“${typeInfo.typeName}`
                });

                // è®°å½•æ¯ç§é¢˜å‹çš„ç”¨æˆ·è¡Œä¸º
                this.preferenceManager.recordAction({
                  type: typeInfo.type,
                  count: finalQuestions.length,
                  difficulty: params.difficulty,
                  knowledgePoint: params.knowledgePoint,
                  timestamp: new Date()
                });
              }
              // å¤„ç†"æ‰€æœ‰çŸ¥è¯†ç‚¹"çš„æƒ…å†µ
              else if (params.knowledgePoint === 'all') {
                // ç­›é€‰ç¬¦åˆé¢˜å‹å’Œéš¾åº¦çš„é¢˜ç›®
                let filteredQuestions = allQuestions.filter(q => {
                  if (q.type !== typeInfo.type) return false;

                  // éš¾åº¦åŒ¹é…ï¼ˆå¦‚æœæŒ‡å®šäº†éš¾åº¦ï¼‰
                  if (params.difficulty && q.difficulty !== params.difficulty) {
                    return false;
                  }

                  return true;
                });

                // æŒ‰çŸ¥è¯†ç‚¹åˆ†ç»„
                const questionsByKnowledge = {};
                filteredQuestions.forEach(q => {
                  const kp = q.knowledgePath || 'æœªåˆ†ç±»';
                  if (!questionsByKnowledge[kp]) {
                    questionsByKnowledge[kp] = [];
                  }
                  questionsByKnowledge[kp].push(q);
                });

                // ä»æ¯ä¸ªçŸ¥è¯†ç‚¹éšæœºé€‰æ‹©é¢˜ç›®
                const selectedQuestions = [];
                const knowledgePoints = Object.keys(questionsByKnowledge);
                const questionsPerKnowledge = Math.ceil(typeInfo.count / knowledgePoints.length);

                knowledgePoints.forEach(kp => {
                  const kpQuestions = questionsByKnowledge[kp];
                  const selected = this.randomSelectQuestions(kpQuestions, questionsPerKnowledge);
                  selectedQuestions.push(...selected);
                });

                // å¦‚æœæ€»æ•°è¶…è¿‡è¦æ±‚ï¼Œéšæœºåˆ é™¤å¤šä½™çš„
                let finalQuestions = selectedQuestions;
                if (selectedQuestions.length > typeInfo.count) {
                  finalQuestions = this.randomSelectQuestions(selectedQuestions, typeInfo.count);
                }

                allSelectedQuestions.push(...finalQuestions);

                generationResults.push({
                  type: typeInfo.typeName,
                  count: finalQuestions.length,
                  requested: typeInfo.count,
                  success: finalQuestions.length === typeInfo.count,
                  message: finalQuestions.length < typeInfo.count ?
                    `é¢˜åº“ä¸­åªæœ‰${finalQuestions.length}é“${typeInfo.typeName}` :
                    `æˆåŠŸç”Ÿæˆ${finalQuestions.length}é“${typeInfo.typeName}`
                });

                // è®°å½•æ¯ç§é¢˜å‹çš„ç”¨æˆ·è¡Œä¸º
                this.preferenceManager.recordAction({
                  type: typeInfo.type,
                  count: finalQuestions.length,
                  difficulty: params.difficulty,
                  knowledgePoint: params.knowledgePoint,
                  timestamp: new Date()
                });
              }
              // æ™®é€šæƒ…å†µï¼šæŒ‰æ¡ä»¶ç­›é€‰
              else {
                // ç­›é€‰ç¬¦åˆè¯¥é¢˜å‹çš„é¢˜ç›®
                let filteredQuestions = allQuestions.filter(q => {
                  if (q.type !== typeInfo.type) return false;

                  // éš¾åº¦åŒ¹é…ï¼ˆå¦‚æœæŒ‡å®šäº†éš¾åº¦ï¼‰
                  if (params.difficulty && q.difficulty !== params.difficulty) {
                    return false;
                  }

                  // çŸ¥è¯†ç‚¹åŒ¹é…ï¼ˆå¦‚æœæŒ‡å®šäº†çŸ¥è¯†ç‚¹ï¼‰
                  if (params.knowledgePoint && q.knowledgePath &&
                      !q.knowledgePath.includes(params.knowledgePoint)) {
                    return false;
                  }

                  return true;
                });

                if (filteredQuestions.length === 0) {
                  generationResults.push({
                    type: typeInfo.typeName,
                    count: 0,
                    requested: typeInfo.count,
                    success: false,
                    message: `é¢˜åº“ä¸­æ²¡æœ‰${typeInfo.typeName}`
                  });
                  return;
                }

                // éšæœºé€‰æ‹©é¢˜ç›®
                const selectedCount = Math.min(typeInfo.count, filteredQuestions.length);
                const selectedQuestions = this.randomSelectQuestions(filteredQuestions, selectedCount);

                allSelectedQuestions.push(...selectedQuestions);

                generationResults.push({
                  type: typeInfo.typeName,
                  count: selectedCount,
                  requested: typeInfo.count,
                  success: selectedCount === typeInfo.count,
                  message: selectedCount < typeInfo.count ?
                    `é¢˜åº“ä¸­åªæœ‰${selectedCount}é“${typeInfo.typeName}` :
                    `æˆåŠŸç”Ÿæˆ${selectedCount}é“${typeInfo.typeName}`
                });

                // è®°å½•æ¯ç§é¢˜å‹çš„ç”¨æˆ·è¡Œä¸º
                this.preferenceManager.recordAction({
                  type: typeInfo.type,
                  count: selectedCount,
                  difficulty: params.difficulty,
                  knowledgePoint: params.knowledgePoint,
                  timestamp: new Date()
                });
              }
            });
          }

          // æ˜¾ç¤ºç”Ÿæˆçš„é¢˜ç›®
          if (allSelectedQuestions.length > 0) {
            displayGeneratedQuestions(allSelectedQuestions, {
              ...params,
              typeName: 'æ··åˆé¢˜å‹',
              count: allSelectedQuestions.length
            });
          }

          // é‡ç½®æ­¥éª¤çŠ¶æ€
          this.task.generateParams = { step: 'init' };

          // æ„å»ºç»“æœæ¶ˆæ¯
          let message = 'âœ… **ç”Ÿæˆå®Œæˆ**\n\n';
          message += 'ğŸ“Š **ç”Ÿæˆç»“æœ**ï¼š\n';

          generationResults.forEach((result, index) => {
            const icon = result.success ? 'âœ“' : 'âš ';
            message += `${index + 1}. ${icon} ${result.message}\n`;
          });

          const totalGenerated = allSelectedQuestions.length;
          const totalRequested = params.mixedTypes.totalCount;

          message += `\nğŸ“ˆ **æ€»è®¡**ï¼šæˆåŠŸç”Ÿæˆ${totalGenerated}/${totalRequested}é“é¢˜ç›®\n`;

          if (params.hasDocument && params.documentContent) {
            message += 'ğŸ“„ **åŸºäº**ï¼šæ‚¨æä¾›çš„å‚è€ƒæ–‡æ¡£\n';
          }

          message += '\né¢˜ç›®å·²æ˜¾ç¤ºåœ¨å³ä¾§é¢„è§ˆåŒºã€‚\n\n';
          message += 'æ‚¨å¯ä»¥ï¼š\n';
          message += 'â€¢ ç»§ç»­ç”Ÿæˆæ›´å¤šé¢˜ç›®ï¼ˆç›´æ¥å‘Šè¯‰æˆ‘éœ€æ±‚ï¼‰\n';
          message += 'â€¢ å½•å…¥è‡³ç®€ä¾¿å½•å…¥åŒºå†ç¡®è®¤ï¼ˆç‚¹å‡»"å½•å…¥è‡³ç®€ä¾¿å½•å…¥åŒºå†ç¡®è®¤"æŒ‰é’®ï¼‰\n';
          message += 'â€¢ å¯¼å‡ºé¢˜ç›®ï¼ˆç‚¹å‡»"å¯¼å‡º"æŒ‰é’®ï¼‰';

          return message;

        } catch (error) {
          console.error('ç”Ÿæˆæ··åˆé¢˜å‹é¢˜ç›®å¤±è´¥:', error);
          return `æŠ±æ­‰ï¼Œç”Ÿæˆé¢˜ç›®æ—¶å‡ºç°é”™è¯¯ï¼š${error.message}\n\nè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚`;
        }
      }

      // ç«‹å³ç”Ÿæˆé¢˜ç›®
      generateQuestionsNow(params) {
        try {
          let selectedQuestions;

          // å¦‚æœç”¨æˆ·ä¸Šä¼ äº†æ–‡æ¡£ï¼Œæ¨¡æ‹ŸåŸºäºæ–‡æ¡£ç”Ÿæˆé¢˜ç›®
          if (params.hasDocument) {
            selectedQuestions = this.generateQuestionsFromDocument(params);
          } else {
            // ä»é¢˜åº“ä¸­ç­›é€‰é¢˜ç›®
            const allQuestions = loadQuestionsData();

            if (!allQuestions || allQuestions.length === 0) {
              return 'æŠ±æ­‰ï¼Œé¢˜åº“ä¸­æš‚æ— é¢˜ç›®ã€‚è¯·å…ˆåœ¨é¢˜åº“ç®¡ç†ä¸­æ·»åŠ é¢˜ç›®ã€‚';
            }

            // å¤„ç†"æ‰€æœ‰éš¾åº¦"çš„æƒ…å†µ
            if (params.difficulty === 'all') {
              // å°†é¢˜ç›®æŒ‰éš¾åº¦åˆ†ç»„
              const questionsByDifficulty = {
                1: [], 2: [], 3: [], 4: [], 5: []
              };

              allQuestions.forEach(q => {
                // é¢˜å‹åŒ¹é…
                if (params.type && params.type !== 'all' && q.type !== params.type) {
                  return;
                }

                // çŸ¥è¯†ç‚¹åŒ¹é…ï¼ˆå¦‚æœæŒ‡å®šäº†çŸ¥è¯†ç‚¹ï¼‰
                if (params.knowledgePoint && params.knowledgePoint !== 'all' &&
                    q.knowledgePath && !q.knowledgePath.includes(params.knowledgePoint)) {
                  return;
                }

                // æŒ‰éš¾åº¦åˆ†ç»„
                if (q.difficulty >= 1 && q.difficulty <= 5) {
                  questionsByDifficulty[q.difficulty].push(q);
                }
              });

              // ä»æ¯ä¸ªéš¾åº¦çº§åˆ«éšæœºé€‰æ‹©é¢˜ç›®
              selectedQuestions = [];
              const questionsPerDifficulty = Math.ceil(params.count / 5);

              for (let diff = 1; diff <= 5; diff++) {
                const diffQuestions = questionsByDifficulty[diff];
                if (diffQuestions.length > 0) {
                  const selected = this.randomSelectQuestions(diffQuestions, questionsPerDifficulty);
                  selectedQuestions.push(...selected);
                }
              }

              // å¦‚æœæ€»æ•°è¶…è¿‡è¦æ±‚ï¼Œéšæœºåˆ é™¤å¤šä½™çš„
              if (selectedQuestions.length > params.count) {
                selectedQuestions = this.randomSelectQuestions(selectedQuestions, params.count);
              }
            }
            // å¤„ç†"æ‰€æœ‰çŸ¥è¯†ç‚¹"çš„æƒ…å†µ
            else if (params.knowledgePoint === 'all') {
              // ç­›é€‰ç¬¦åˆé¢˜å‹å’Œéš¾åº¦çš„é¢˜ç›®
              let filteredQuestions = allQuestions.filter(q => {
                // é¢˜å‹åŒ¹é…
                if (params.type && params.type !== 'all' && q.type !== params.type) {
                  return false;
                }

                // éš¾åº¦åŒ¹é…ï¼ˆå¦‚æœæŒ‡å®šäº†éš¾åº¦ï¼‰
                if (params.difficulty && q.difficulty !== params.difficulty) {
                  return false;
                }

                return true;
              });

              // æŒ‰çŸ¥è¯†ç‚¹åˆ†ç»„
              const questionsByKnowledge = {};
              filteredQuestions.forEach(q => {
                const kp = q.knowledgePath || 'æœªåˆ†ç±»';
                if (!questionsByKnowledge[kp]) {
                  questionsByKnowledge[kp] = [];
                }
                questionsByKnowledge[kp].push(q);
              });

              // ä»æ¯ä¸ªçŸ¥è¯†ç‚¹éšæœºé€‰æ‹©é¢˜ç›®
              selectedQuestions = [];
              const knowledgePoints = Object.keys(questionsByKnowledge);
              const questionsPerKnowledge = Math.ceil(params.count / knowledgePoints.length);

              knowledgePoints.forEach(kp => {
                const kpQuestions = questionsByKnowledge[kp];
                const selected = this.randomSelectQuestions(kpQuestions, questionsPerKnowledge);
                selectedQuestions.push(...selected);
              });

              // å¦‚æœæ€»æ•°è¶…è¿‡è¦æ±‚ï¼Œéšæœºåˆ é™¤å¤šä½™çš„
              if (selectedQuestions.length > params.count) {
                selectedQuestions = this.randomSelectQuestions(selectedQuestions, params.count);
              }
            }
            // å¤„ç†åŒæ—¶æŒ‡å®š"æ‰€æœ‰éš¾åº¦"å’Œ"æ‰€æœ‰çŸ¥è¯†ç‚¹"çš„æƒ…å†µ
            else if (params.difficulty === 'all' && params.knowledgePoint === 'all') {
              // ç­›é€‰ç¬¦åˆé¢˜å‹çš„é¢˜ç›®
              let filteredQuestions = allQuestions.filter(q => {
                if (params.type && params.type !== 'all' && q.type !== params.type) {
                  return false;
                }
                return true;
              });

              // æŒ‰éš¾åº¦å’ŒçŸ¥è¯†ç‚¹åŒé‡åˆ†ç»„
              const questionsByDiffAndKnowledge = {};
              filteredQuestions.forEach(q => {
                const diff = q.difficulty || 3;
                const kp = q.knowledgePath || 'æœªåˆ†ç±»';
                const key = `${diff}-${kp}`;

                if (!questionsByDiffAndKnowledge[key]) {
                  questionsByDiffAndKnowledge[key] = [];
                }
                questionsByDiffAndKnowledge[key].push(q);
              });

              // ä»æ¯ä¸ªç»„åˆä¸­éšæœºé€‰æ‹©é¢˜ç›®
              selectedQuestions = [];
              const groups = Object.keys(questionsByDiffAndKnowledge);
              const questionsPerGroup = Math.ceil(params.count / groups.length);

              groups.forEach(key => {
                const groupQuestions = questionsByDiffAndKnowledge[key];
                const selected = this.randomSelectQuestions(groupQuestions, questionsPerGroup);
                selectedQuestions.push(...selected);
              });

              // å¦‚æœæ€»æ•°è¶…è¿‡è¦æ±‚ï¼Œéšæœºåˆ é™¤å¤šä½™çš„
              if (selectedQuestions.length > params.count) {
                selectedQuestions = this.randomSelectQuestions(selectedQuestions, params.count);
              }
            }
            // æ™®é€šæƒ…å†µï¼šæŒ‰æ¡ä»¶ç­›é€‰
            else {
              // ç­›é€‰ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®
              let filteredQuestions = allQuestions.filter(q => {
                // é¢˜å‹åŒ¹é…ï¼ˆå¦‚æœé€‰æ‹©äº†"æ‰€æœ‰é¢˜å‹"ï¼Œåˆ™ä¸ç­›é€‰é¢˜å‹ï¼‰
                if (params.type && params.type !== 'all' && q.type !== params.type) {
                  return false;
                }

                // éš¾åº¦åŒ¹é…ï¼ˆå¦‚æœæŒ‡å®šäº†éš¾åº¦ï¼‰
                if (params.difficulty && q.difficulty !== params.difficulty) {
                  return false;
                }

                // çŸ¥è¯†ç‚¹åŒ¹é…ï¼ˆå¦‚æœæŒ‡å®šäº†çŸ¥è¯†ç‚¹ï¼‰
                if (params.knowledgePoint && q.knowledgePath &&
                    !q.knowledgePath.includes(params.knowledgePoint)) {
                  return false;
                }

                return true;
              });

              if (filteredQuestions.length === 0) {
                return `æŠ±æ­‰ï¼Œé¢˜åº“ä¸­æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„${params.typeName}ã€‚\n\nå»ºè®®ï¼š\nâ€¢ å°è¯•å…¶ä»–é¢˜å‹\nâ€¢ é™ä½ç­›é€‰æ¡ä»¶\nâ€¢ åœ¨é¢˜åº“ç®¡ç†ä¸­æ·»åŠ æ›´å¤šé¢˜ç›®`;
              }

              // éšæœºé€‰æ‹©é¢˜ç›®
              selectedQuestions = this.randomSelectQuestions(filteredQuestions, params.count);
            }
          }

          // æ˜¾ç¤ºç”Ÿæˆç»“æœ
          displayGeneratedQuestions(selectedQuestions, params);

          // è®°å½•ç”¨æˆ·è¡Œä¸ºï¼ˆç”¨äºå­¦ä¹ åå¥½ï¼‰
          this.preferenceManager.recordAction({
            type: params.type,
            count: params.count,
            difficulty: params.difficulty,
            knowledgePoint: params.knowledgePoint,
            timestamp: new Date()
          });

          // é‡ç½®æ­¥éª¤çŠ¶æ€ï¼Œå…è®¸ç”¨æˆ·ç»§ç»­ç”Ÿæˆ
          this.task.generateParams = { step: 'init' };

          // è¿”å›æˆåŠŸæ¶ˆæ¯
          const difficultyText = params.difficultyName ? `ï¼ˆéš¾åº¦ï¼š${params.difficultyName}ï¼‰` : '';
          const knowledgeText = params.knowledgePoint && params.knowledgePoint !== 'all' ? `ï¼ˆçŸ¥è¯†ç‚¹ï¼š${params.knowledgePoint}ï¼‰` :
                                params.knowledgePoint === 'all' ? 'ï¼ˆçŸ¥è¯†ç‚¹ï¼šè¦†ç›–æ‰€æœ‰çŸ¥è¯†ç‚¹ï¼‰' : '';
          const documentText = params.hasDocument ? 'ï¼ˆåŸºäºå‚è€ƒæ–‡æ¡£ï¼‰' : '';

          return `âœ… å·²æˆåŠŸç”Ÿæˆ${selectedQuestions.length}é“${params.typeName}${difficultyText}${knowledgeText}${documentText}\n\né¢˜ç›®å·²æ˜¾ç¤ºåœ¨å³ä¾§é¢„è§ˆåŒºã€‚\n\næ‚¨å¯ä»¥ï¼š\nâ€¢ ç»§ç»­ç”Ÿæˆæ›´å¤šé¢˜ç›®ï¼ˆç›´æ¥å‘Šè¯‰æˆ‘éœ€æ±‚ï¼‰\nâ€¢ å½•å…¥è‡³ç®€ä¾¿å½•å…¥åŒºå†ç¡®è®¤ï¼ˆç‚¹å‡»"å½•å…¥è‡³ç®€ä¾¿å½•å…¥åŒºå†ç¡®è®¤"æŒ‰é’®ï¼‰\nâ€¢ å¯¼å‡ºé¢˜ç›®ï¼ˆç‚¹å‡»"å¯¼å‡º"æŒ‰é’®ï¼‰`;
        } catch (error) {
          console.error('ç”Ÿæˆé¢˜ç›®å¤±è´¥:', error);
          return `æŠ±æ­‰ï¼Œç”Ÿæˆé¢˜ç›®æ—¶å‡ºç°é”™è¯¯ï¼š${error.message}\n\nè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚`;
        }
      }

      // éšæœºé€‰æ‹©é¢˜ç›®
      randomSelectQuestions(questions, count) {
        // å¦‚æœé¢˜ç›®æ•°é‡ä¸è¶³ï¼Œè¿”å›æ‰€æœ‰é¢˜ç›®
        if (questions.length <= count) {
          return questions;
        }

        // éšæœºæ‰“ä¹±æ•°ç»„
        const shuffled = [...questions].sort(() => Math.random() - 0.5);

        // è¿”å›å‰countä¸ª
        return shuffled.slice(0, count);
      }

      // åŸºäºæ–‡æ¡£æ¨¡æ‹Ÿç”Ÿæˆé¢˜ç›®
      generateQuestionsFromDocument(params) {
        const questions = [];
        const typeNames = {
          'single': 'å•é€‰é¢˜',
          'multiple': 'å¤šé€‰é¢˜',
          'judge': 'åˆ¤æ–­é¢˜',
          'blank': 'å¡«ç©ºé¢˜',
          'shortAnswer': 'ç®€ç­”é¢˜',
          'cloze': 'å®Œå½¢å¡«ç©ºé¢˜',
          'composite': 'å¤åˆé¢˜'
        };

        // çœŸå®é¢˜ç›®å†…å®¹æ¨¡æ¿
        const contentTemplates = {
          'single': [
            'åœ¨è®¡ç®—æœºç½‘ç»œä¸­ï¼ŒTCPåè®®å±äºå“ªä¸€å±‚ï¼Ÿ',
            'ä»¥ä¸‹å“ªä¸ªä¸æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹çš„ç‰¹æ€§ï¼Ÿ',
            'HTTPåè®®é»˜è®¤ä½¿ç”¨çš„ç«¯å£å·æ˜¯å¤šå°‘ï¼Ÿ',
            'åœ¨æ•°æ®åº“ä¸­ï¼Œç”¨äºæŸ¥è¯¢æ•°æ®çš„SQLè¯­å¥æ˜¯ï¼Ÿ',
            'ä»¥ä¸‹å“ªä¸ªæ˜¯Pythonçš„æ•°æ®ç±»å‹ï¼Ÿ'
          ],
          'multiple': [
            'ä»¥ä¸‹å“ªäº›æ˜¯å¸¸è§çš„æ’åºç®—æ³•ï¼Ÿ',
            'å…³äºJavaScriptçš„è¯´æ³•ï¼Œæ­£ç¡®çš„æœ‰å“ªäº›ï¼Ÿ',
            'HTML5æ–°å¢çš„è¯­ä¹‰åŒ–æ ‡ç­¾åŒ…æ‹¬å“ªäº›ï¼Ÿ',
            'ä»¥ä¸‹å“ªäº›å±äºå…³ç³»å‹æ•°æ®åº“ï¼Ÿ',
            'CSSä¸­å¯ä»¥è®¾ç½®å…ƒç´ ä½ç½®çš„å±æ€§æœ‰å“ªäº›ï¼Ÿ'
          ],
          'judge': [
            'Javaæ˜¯ä¸€ç§è§£é‡Šå‹è¯­è¨€',
            'HTTPæ˜¯ä¸€ç§æ— çŠ¶æ€åè®®',
            'æ•°ç»„çš„ä¸‹æ ‡ä»1å¼€å§‹',
            'CSSå¯ä»¥ç”¨æ¥æ§åˆ¶ç½‘é¡µçš„å¸ƒå±€',
            'Gitæ˜¯ä¸€ç§é›†ä¸­å¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ'
          ],
          'blank': [
            'åœ¨Pythonä¸­ï¼Œç”¨äºå®šä¹‰å‡½æ•°çš„å…³é”®å­—æ˜¯____ã€‚',
            'SQLä¸­ç”¨äºåˆ é™¤è¡¨ä¸­æ•°æ®çš„å‘½ä»¤æ˜¯____ã€‚',
            'HTMLæ–‡æ¡£çš„æ ¹å…ƒç´ æ˜¯____æ ‡ç­¾ã€‚',
            'åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œ____æ˜¯æŒ‡ä»å·²æœ‰ç±»åˆ›å»ºæ–°ç±»çš„è¿‡ç¨‹ã€‚',
            'TCP/IPæ¨¡å‹å…±åˆ†ä¸º____å±‚ã€‚'
          ],
          'shortAnswer': [
            'è¯·ç®€è¿°HTTPå’ŒHTTPSçš„åŒºåˆ«ã€‚',
            'ä»€ä¹ˆæ˜¯æ•°æ®åº“çš„ä¸‰èŒƒå¼ï¼Ÿè¯·ç®€è¦è¯´æ˜ã€‚',
            'è¯·è§£é‡Šä»€ä¹ˆæ˜¯é—­åŒ…ï¼Œå¹¶ä¸¾ä¾‹è¯´æ˜å…¶åº”ç”¨åœºæ™¯ã€‚',
            'ç®€è¿°Gitä¸­mergeå’Œrebaseçš„åŒºåˆ«ã€‚',
            'ä»€ä¹ˆæ˜¯RESTful APIï¼Ÿå®ƒæœ‰å“ªäº›ç‰¹ç‚¹ï¼Ÿ'
          ],
          'cloze': [
            'è®¡ç®—æœºç½‘ç»œæ˜¯æŒ‡å°†åœ°ç†ä½ç½®ä¸åŒçš„å…·æœ‰ç‹¬ç«‹åŠŸèƒ½çš„å¤šå°è®¡ç®—æœºåŠå…¶å¤–éƒ¨è®¾å¤‡ï¼Œé€šè¿‡____å’Œ____è¿æ¥èµ·æ¥ï¼Œåœ¨____çš„ç®¡ç†ä¸‹ï¼Œå®ç°____å’Œ____çš„ç³»ç»Ÿã€‚',
            'æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆDBMSï¼‰æ˜¯ä½äº____ä¸____ä¹‹é—´çš„ä¸€å±‚æ•°æ®ç®¡ç†è½¯ä»¶ï¼Œå®ƒä¸ºç”¨æˆ·æˆ–åº”ç”¨ç¨‹åºæä¾›è®¿é—®____çš„æ–¹æ³•ã€‚'
          ],
          'composite': [
            'é˜…è¯»ä»¥ä¸‹ä»£ç ç‰‡æ®µï¼š\n```javascript\nfunction add(a, b) {\n  return a + b;\n}\nconst result = add(5, 3);\nconsole.log(result);\n```',
            'æŸå…¬å¸çš„å‘˜å·¥ä¿¡æ¯è¡¨åŒ…å«ä»¥ä¸‹å­—æ®µï¼šå‘˜å·¥ç¼–å·ã€å§“åã€éƒ¨é—¨ã€å·¥èµ„ã€å…¥èŒæ—¥æœŸã€‚'
          ]
        };

        const optionsTemplates = {
          'single': [
            [
              { label: 'A', text: 'åº”ç”¨å±‚' },
              { label: 'B', text: 'ä¼ è¾“å±‚' },
              { label: 'C', text: 'ç½‘ç»œå±‚' },
              { label: 'D', text: 'æ•°æ®é“¾è·¯å±‚' }
            ],
            [
              { label: 'A', text: 'å°è£…' },
              { label: 'B', text: 'ç»§æ‰¿' },
              { label: 'C', text: 'å¤šæ€' },
              { label: 'D', text: 'ç¼–è¯‘' }
            ],
            [
              { label: 'A', text: '80' },
              { label: 'B', text: '443' },
              { label: 'C', text: '8080' },
              { label: 'D', text: '3306' }
            ],
            [
              { label: 'A', text: 'SELECT' },
              { label: 'B', text: 'INSERT' },
              { label: 'C', text: 'UPDATE' },
              { label: 'D', text: 'DELETE' }
            ],
            [
              { label: 'A', text: 'list' },
              { label: 'B', text: 'array' },
              { label: 'C', text: 'vector' },
              { label: 'D', text: 'collection' }
            ]
          ],
          'multiple': [
            [
              { label: 'A', text: 'å†’æ³¡æ’åº' },
              { label: 'B', text: 'å¿«é€Ÿæ’åº' },
              { label: 'C', text: 'å½’å¹¶æ’åº' },
              { label: 'D', text: 'çº¿æ€§æŸ¥æ‰¾' }
            ],
            [
              { label: 'A', text: 'æ˜¯ä¸€ç§è„šæœ¬è¯­è¨€' },
              { label: 'B', text: 'å¯ä»¥æ“ä½œDOM' },
              { label: 'C', text: 'æ˜¯å¼ºç±»å‹è¯­è¨€' },
              { label: 'D', text: 'æ”¯æŒå¼‚æ­¥ç¼–ç¨‹' }
            ],
            [
              { label: 'A', text: 'header' },
              { label: 'B', text: 'nav' },
              { label: 'C', text: 'section' },
              { label: 'D', text: 'div' }
            ],
            [
              { label: 'A', text: 'MySQL' },
              { label: 'B', text: 'MongoDB' },
              { label: 'C', text: 'PostgreSQL' },
              { label: 'D', text: 'Oracle' }
            ],
            [
              { label: 'A', text: 'position' },
              { label: 'B', text: 'float' },
              { label: 'C', text: 'display' },
              { label: 'D', text: 'color' }
            ]
          ]
        };

        const answersTemplates = {
          'single': ['B', 'D', 'A', 'A', 'A'],
          'multiple': [['A', 'B', 'C'], ['A', 'B', 'D'], ['A', 'B', 'C'], ['A', 'C', 'D'], ['A', 'B', 'C']],
          'judge': ['é”™è¯¯', 'æ­£ç¡®', 'é”™è¯¯', 'æ­£ç¡®', 'é”™è¯¯'],
          'blank': [['def'], ['DELETE'], ['html'], ['ç»§æ‰¿'], ['å››']],
          'cloze': ['BDCA', 'ACB']
        };

        // æ¨¡æ‹Ÿç”ŸæˆæŒ‡å®šæ•°é‡çš„é¢˜ç›®
        for (let i = 0; i < params.count; i++) {
          const questionId = `DOC_${Date.now()}_${i + 1}`;
          const templateIndex = i % 5; // å¾ªç¯ä½¿ç”¨æ¨¡æ¿

          // å¤„ç†"æ‰€æœ‰éš¾åº¦"çš„æƒ…å†µï¼šä¸ºæ¯é“é¢˜ç›®éšæœºåˆ†é…éš¾åº¦
          let questionDifficulty = params.difficulty;
          let questionDifficultyName = params.difficultyName;
          if (params.difficulty === 'all') {
            // å¾ªç¯ä½¿ç”¨1-5çš„éš¾åº¦
            questionDifficulty = (i % 5) + 1;
            const diffNames = { 1: 'ä¸€çº§', 2: 'äºŒçº§', 3: 'ä¸‰çº§', 4: 'å››çº§', 5: 'äº”çº§' };
            questionDifficultyName = diffNames[questionDifficulty];
          }

          // å¤„ç†"æ‰€æœ‰çŸ¥è¯†ç‚¹"çš„æƒ…å†µï¼šä¸ºæ¯é“é¢˜ç›®åˆ†é…ä¸åŒçš„çŸ¥è¯†ç‚¹
          let questionKnowledgePoint = params.knowledgePoint;
          if (params.knowledgePoint === 'all') {
            // æ¨¡æ‹Ÿå¤šä¸ªçŸ¥è¯†ç‚¹
            const knowledgePoints = ['æ•°æ®ç»“æ„', 'ç®—æ³•', 'æ•°æ®åº“', 'ç½‘ç»œåè®®', 'æ“ä½œç³»ç»Ÿ', 'ç¼–ç¨‹è¯­è¨€', 'Webå¼€å‘', 'è½¯ä»¶å·¥ç¨‹'];
            questionKnowledgePoint = knowledgePoints[i % knowledgePoints.length];
          }

          const question = {
            id: questionId,
            type: params.type,
            typeName: typeNames[params.type] || params.typeName,
            content: contentTemplates[params.type] ? contentTemplates[params.type][templateIndex] : `é¢˜ç›®å†…å®¹ ${i + 1}`,
            difficulty: questionDifficulty || 2,
            difficultyName: questionDifficultyName || 'äºŒçº§',
            knowledgePoint: questionKnowledgePoint || '',
            knowledgePath: questionKnowledgePoint || '',
            createTime: new Date().toLocaleString('zh-CN'),
            author: 'AIåŠ©æ‰‹',
            useCount: 0
          };

          // æ ¹æ®é¢˜å‹æ·»åŠ é€‰é¡¹å’Œç­”æ¡ˆ
          if (params.type === 'single') {
            question.options = optionsTemplates.single[templateIndex];
            question.correctAnswers = [answersTemplates.single[templateIndex]];
            question.explanation = 'æ ¹æ®ç›¸å…³çŸ¥è¯†ç‚¹ï¼Œæ­¤é€‰é¡¹æ­£ç¡®ã€‚';
          } else if (params.type === 'multiple') {
            question.options = optionsTemplates.multiple[templateIndex];
            question.correctAnswers = answersTemplates.multiple[templateIndex];
            question.explanation = 'æ ¹æ®ç›¸å…³çŸ¥è¯†ç‚¹ï¼Œè¿™äº›é€‰é¡¹æ­£ç¡®ã€‚';
          } else if (params.type === 'judge') {
            question.options = [
              { label: 'A', text: 'æ­£ç¡®' },
              { label: 'B', text: 'é”™è¯¯' }
            ];
            question.correctAnswers = [answersTemplates.judge[templateIndex]];
            question.explanation = `æ­¤è¯´æ³•${answersTemplates.judge[templateIndex]}ã€‚`;
          } else if (params.type === 'blank') {
            question.correctAnswers = answersTemplates.blank[templateIndex];
            question.explanation = 'æ ¹æ®ç›¸å…³çŸ¥è¯†ç‚¹ï¼Œå¡«ç©ºç­”æ¡ˆå¦‚ä¸Šã€‚';
          } else if (params.type === 'shortAnswer') {
            // ç®€ç­”é¢˜æ²¡æœ‰ç­”æ¡ˆ
            question.explanation = 'è¯„åˆ†è¦ç‚¹ï¼šç†è§£æ ¸å¿ƒæ¦‚å¿µï¼Œè¡¨è¾¾æ¸…æ™°å‡†ç¡®ã€‚';
          } else if (params.type === 'cloze') {
            // å®Œå½¢å¡«ç©ºï¼šæŒ‰ç®€ä¾¿å½•å…¥è§„åˆ™ï¼Œç­”æ¡ˆä¸ºå•ä¸ªå­—ç¬¦ä¸²å¦‚"BDCA"
            const clozeIndex = i % 2;
            question.content = contentTemplates.cloze[clozeIndex];
            question.correctAnswers = answersTemplates.cloze[clozeIndex]; // å•ä¸ªå­—ç¬¦ä¸²
            question.explanation = 'æ ¹æ®ä¸Šä¸‹æ–‡ï¼Œé€‰æ‹©æœ€åˆé€‚çš„é€‰é¡¹ã€‚';
            // å®Œå½¢å¡«ç©ºçš„é€‰é¡¹ç»“æ„
            question.blanks = [
              { options: [
                { label: 'A', text: 'é€šä¿¡çº¿è·¯' },
                { label: 'B', text: 'é€šä¿¡è®¾å¤‡' },
                { label: 'C', text: 'ç½‘ç»œåè®®' },
                { label: 'D', text: 'æ“ä½œç³»ç»Ÿ' }
              ]},
              { options: [
                { label: 'A', text: 'è½¯ä»¶' },
                { label: 'B', text: 'ç¡¬ä»¶' },
                { label: 'C', text: 'æ•°æ®' },
                { label: 'D', text: 'ä¿¡æ¯' }
              ]}
            ];
          } else if (params.type === 'composite') {
            // å¤åˆé¢˜ï¼šæŒ‰ç®€ä¾¿å½•å…¥è§„åˆ™ï¼ŒåŒ…å«ææ–™å’Œå­é¢˜
            const compositeIndex = i % 2;
            question.content = contentTemplates.composite[compositeIndex];
            question.subQuestions = [
              {
                id: `${questionId}_1`,
                type: 'single',
                typeName: 'å•é€‰é¢˜',
                content: 'è¿™æ®µä»£ç çš„è¾“å‡ºç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ',
                options: [
                  { label: 'A', text: '5' },
                  { label: 'B', text: '8' },
                  { label: 'C', text: '3' },
                  { label: 'D', text: 'undefined' }
                ],
                correctAnswers: ['B']
              },
              {
                id: `${questionId}_2`,
                type: 'judge',
                typeName: 'åˆ¤æ–­é¢˜',
                content: 'è¿™æ®µä»£ç ä½¿ç”¨äº†ç®­å¤´å‡½æ•°',
                options: [
                  { label: 'A', text: 'æ­£ç¡®' },
                  { label: 'B', text: 'é”™è¯¯' }
                ],
                correctAnswers: ['é”™è¯¯']
              }
            ];
            question.explanation = 'ç»¼åˆåˆ†æææ–™å†…å®¹ï¼Œç†è§£å„ä¸ªçŸ¥è¯†ç‚¹ã€‚';
          }

          questions.push(question);
        }

        return questions;
      }

      // å¤„ç†åˆ›å»ºè¯•å·
      handleCreatePaper(input) {
        const nameMatch = input.match(/[ã€Šã€Œã€](.+?)[ã€‹ã€ã€]/);
        const scoreMatch = input.match(/(\d+)\s*åˆ†/);

        if (nameMatch && scoreMatch) {
          return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ›å»ºè¯•å·ã€Š${nameMatch[1]}ã€‹ï¼Œæ€»åˆ†${scoreMatch[1]}åˆ†ã€‚\n\nè¯·ç¨ç­‰ï¼Œæ­£åœ¨å‡†å¤‡è¯•å·...`;
        } else if (nameMatch) {
          return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ›å»ºè¯•å·ã€Š${nameMatch[1]}ã€‹ã€‚è¯·é—®æ€»åˆ†æ˜¯å¤šå°‘ï¼Ÿ`;
        } else if (scoreMatch) {
          return `å¥½çš„ï¼Œæ€»åˆ†${scoreMatch[1]}åˆ†ã€‚è¯·é—®è¯•å·åç§°æ˜¯ä»€ä¹ˆï¼Ÿ`;
        } else {
          return 'å¥½çš„ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨åˆ›å»ºè¯•å·ã€‚è¯·å‘Šè¯‰æˆ‘ï¼š\n1. è¯•å·åç§°ï¼ˆä¾‹å¦‚ï¼šã€ŠæœŸæœ«è€ƒè¯•ã€‹ï¼‰\n2. æ€»åˆ†ï¼ˆä¾‹å¦‚ï¼š100åˆ†ï¼‰';
        }
      }

      // å¤„ç†åˆ›å»ºè€ƒè¯•
      handleCreateExam(input) {
        const nameMatch = input.match(/[ã€Šã€Œã€](.+?)[ã€‹ã€ã€]/);
        const durationMatch = input.match(/(\d+)\s*åˆ†é’Ÿ/);

        if (nameMatch && durationMatch) {
          return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ›å»ºè€ƒè¯•ã€Š${nameMatch[1]}ã€‹ï¼Œæ—¶é•¿${durationMatch[1]}åˆ†é’Ÿã€‚\n\nè¯·ç¨ç­‰ï¼Œæ­£åœ¨é…ç½®è€ƒè¯•...`;
        } else if (nameMatch) {
          return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ›å»ºè€ƒè¯•ã€Š${nameMatch[1]}ã€‹ã€‚è¯·é—®è€ƒè¯•æ—¶é•¿æ˜¯å¤šå°‘åˆ†é’Ÿï¼Ÿ`;
        } else if (durationMatch) {
          return `å¥½çš„ï¼Œè€ƒè¯•æ—¶é•¿${durationMatch[1]}åˆ†é’Ÿã€‚è¯·é—®è€ƒè¯•åç§°æ˜¯ä»€ä¹ˆï¼Ÿ`;
        } else {
          return 'å¥½çš„ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨åˆ›å»ºè€ƒè¯•ã€‚è¯·å‘Šè¯‰æˆ‘ï¼š\n1. è€ƒè¯•åç§°ï¼ˆä¾‹å¦‚ï¼šã€ŠæœŸæœ«è€ƒè¯•ã€‹ï¼‰\n2. è€ƒè¯•æ—¶é•¿ï¼ˆä¾‹å¦‚ï¼š120åˆ†é’Ÿï¼‰';
        }
      }

      // å¤„ç†åˆ·é¢˜ä»»åŠ¡
      handleCreatePractice(input) {
        const nameMatch = input.match(/[ã€Šã€Œã€](.+?)[ã€‹ã€ã€]/);
        const countMatch = input.match(/(\d+)\s*[é“ä¸ªé¢˜]/);

        if (nameMatch && countMatch) {
          return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ›å»ºåˆ·é¢˜ä»»åŠ¡ã€Š${nameMatch[1]}ã€‹ï¼ŒåŒ…å«${countMatch[1]}é“é¢˜ç›®ã€‚\n\nè¯·ç¨ç­‰ï¼Œæ­£åœ¨å‡†å¤‡ä»»åŠ¡...`;
        } else if (nameMatch) {
          return `å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ›å»ºåˆ·é¢˜ä»»åŠ¡ã€Š${nameMatch[1]}ã€‹ã€‚è¯·é—®éœ€è¦å¤šå°‘é“é¢˜ï¼Ÿ`;
        } else if (countMatch) {
          return `å¥½çš„ï¼ŒåŒ…å«${countMatch[1]}é“é¢˜ç›®ã€‚è¯·é—®ä»»åŠ¡åç§°æ˜¯ä»€ä¹ˆï¼Ÿ`;
        } else {
          return 'å¥½çš„ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨åˆ›å»ºåˆ·é¢˜ä»»åŠ¡ã€‚è¯·å‘Šè¯‰æˆ‘ï¼š\n1. ä»»åŠ¡åç§°ï¼ˆä¾‹å¦‚ï¼šã€Šæ¯æ—¥ç»ƒä¹ ã€‹ï¼‰\n2. é¢˜ç›®æ•°é‡ï¼ˆä¾‹å¦‚ï¼š20é“é¢˜ï¼‰';
        }
      }

      // è·å–å¯¹è¯ä¸Šä¸‹æ–‡
      getContext() {
        return {
          history: this.task.messages || [],
          lastParams: this.task.generateParams || {},
          timestamp: new Date()
        };
      }

      // æå–é¢˜ç›®å‚æ•°
      extractQuestionParams(input) {
        const params = {};

        // æ£€æŸ¥æ˜¯å¦é€‰æ‹©æ‰€æœ‰é¢˜å‹
        if (input.includes('æ‰€æœ‰') || input.includes('å…¨éƒ¨') || input.includes('æ‰€æœ‰é¢˜å‹') || input.includes('å…¨éƒ¨é¢˜å‹')) {
          params.type = 'all';
          params.typeName = 'æ‰€æœ‰é¢˜å‹';
          return params; // ç›´æ¥è¿”å›ï¼Œä¸å†æ£€æŸ¥å…·ä½“é¢˜å‹
        }

        // é¢˜å‹æå–
        const typeMap = {
          'å•é€‰': { type: 'single', name: 'å•é€‰é¢˜' },
          'å¤šé€‰': { type: 'multiple', name: 'å¤šé€‰é¢˜' },
          'åˆ¤æ–­': { type: 'judge', name: 'åˆ¤æ–­é¢˜' },
          'å¡«ç©º': { type: 'blank', name: 'å¡«ç©ºé¢˜' },
          'ç®€ç­”': { type: 'shortAnswer', name: 'ç®€ç­”é¢˜' },
          'å¤åˆ': { type: 'composite', name: 'å¤åˆé¢˜' }
        };

        for (const [key, value] of Object.entries(typeMap)) {
          if (input.includes(key)) {
            params.type = value.type;
            params.typeName = value.name;
            break;
          }
        }

        // æ•°é‡æå–
        const countMatch = input.match(/(\d+)\s*[é“ä¸ªé¢˜]/);
        if (countMatch) {
          params.count = parseInt(countMatch[1]);
        }

        // éš¾åº¦æå–
        const difficultyMap = {
          'ç®€å•': { level: 1, name: 'ä¸€çº§' },
          'å®¹æ˜“': { level: 1, name: 'ä¸€çº§' },
          'ä¸€çº§': { level: 1, name: 'ä¸€çº§' },
          'ä¸­ç­‰': { level: 2, name: 'äºŒçº§' },
          'äºŒçº§': { level: 2, name: 'äºŒçº§' },
          'å›°éš¾': { level: 3, name: 'ä¸‰çº§' },
          'éš¾': { level: 3, name: 'ä¸‰çº§' },
          'ä¸‰çº§': { level: 3, name: 'ä¸‰çº§' },
          'å¾ˆéš¾': { level: 4, name: 'å››çº§' },
          'å››çº§': { level: 4, name: 'å››çº§' },
          'æéš¾': { level: 5, name: 'äº”çº§' },
          'äº”çº§': { level: 5, name: 'äº”çº§' }
        };

        for (const [key, value] of Object.entries(difficultyMap)) {
          if (input.includes(key)) {
            params.difficulty = value.level;
            params.difficultyName = value.name;
            break;
          }
        }

        // çŸ¥è¯†ç‚¹æå–ï¼ˆç®€å•åŒ¹é…ï¼‰
        const knowledgeMatch = input.match(/å…³äº(.+?)çš„|(.+?)ç›¸å…³|(.+?)çŸ¥è¯†ç‚¹/);
        if (knowledgeMatch) {
          params.knowledgePoint = knowledgeMatch[1] || knowledgeMatch[2] || knowledgeMatch[3];
        }

        return params;
      }
    }

    // ========== é¢˜åº“æ•°æ®åŠ è½½ ==========

    // åŠ è½½é¢˜åº“æ•°æ®
    function loadQuestionsData() {
      if (questionsCache) {
        return questionsCache;
      }

      try {
        const data = localStorage.getItem('allQuestions');
        if (data) {
          questionsCache = JSON.parse(data);
          console.log('é¢˜åº“æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', questionsCache.length, 'é“é¢˜ç›®');
          return questionsCache;
        }
      } catch (error) {
        console.error('åŠ è½½é¢˜åº“æ•°æ®å¤±è´¥:', error);
      }

      console.warn('é¢˜åº“ä¸ºç©ºï¼Œè¯·å…ˆåœ¨é¢˜åº“ç®¡ç†ä¸­æ·»åŠ é¢˜ç›®');
      return [];
    }

    // åŠ è½½çŸ¥è¯†ç‚¹æ ‘æ•°æ®
    function loadKnowledgeTreeData() {
      if (knowledgeTreeCache) {
        return knowledgeTreeCache;
      }

      try {
        const data = localStorage.getItem('knowledgePoints');
        if (data) {
          knowledgeTreeCache = JSON.parse(data);
          console.log('çŸ¥è¯†ç‚¹æ•°æ®åŠ è½½æˆåŠŸ');
          return knowledgeTreeCache;
        }
      } catch (error) {
        console.error('åŠ è½½çŸ¥è¯†ç‚¹æ•°æ®å¤±è´¥:', error);
      }

      console.warn('çŸ¥è¯†ç‚¹æ ‘ä¸ºç©º');
      return [];
    }

    // æœç´¢é¢˜ç›®
    function searchQuestions(params) {
      const questions = loadQuestionsData();

      if (questions.length === 0) {
        return {
          success: false,
          message: 'é¢˜åº“ä¸ºç©ºï¼Œè¯·å…ˆåœ¨é¢˜åº“ç®¡ç†ä¸­æ·»åŠ é¢˜ç›®ã€‚',
          total: 0,
          returned: 0,
          results: []
        };
      }

      let filtered = questions;

      // æŒ‰é¢˜å‹ç­›é€‰
      if (params.questionType) {
        filtered = filtered.filter(q => q.type === params.questionType);
      }

      // æŒ‰éš¾åº¦ç­›é€‰
      if (params.difficulty) {
        filtered = filtered.filter(q => q.difficulty === params.difficulty);
      }

      // æŒ‰çŸ¥è¯†ç‚¹ç­›é€‰
      if (params.knowledge) {
        filtered = filtered.filter(q => {
          return q.knowledgePath && q.knowledgePath.includes(params.knowledge);
        });
      }

      // é™åˆ¶æ•°é‡
      const count = params.count || filtered.length;
      const results = filtered.slice(0, count);

      if (filtered.length === 0) {
        return {
          success: false,
          message: 'æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®ï¼Œè¯·è°ƒæ•´æœç´¢æ¡ä»¶ã€‚',
          total: 0,
          returned: 0,
          results: []
        };
      }

      return {
        success: true,
        message: `æ‰¾åˆ° ${filtered.length} é“ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®ï¼Œè¿”å›å‰ ${results.length} é“ã€‚`,
        total: filtered.length,
        returned: results.length,
        results: results
      };
    }

    // æ˜¾ç¤ºç”Ÿæˆçš„é¢˜ç›®åˆ°é¢„è§ˆåŒº
    function displayGeneratedQuestions(questions, params) {
      const previewContainer = document.getElementById('previewContainer');
      const previewEmpty = document.getElementById('previewEmpty');
      const previewTitle = document.getElementById('previewTitle');
      const previewActions = document.getElementById('previewActions');

      // éšè—ç©ºçŠ¶æ€
      if (previewEmpty) {
        previewEmpty.classList.add('hidden');
      }

      // æ›´æ–°æ ‡é¢˜å’Œæ˜¾ç¤ºæ“ä½œæŒ‰é’®
      if (previewTitle) {
        const difficultyText = params.difficultyName ? ` - ${params.difficultyName}` : '';
        previewTitle.innerHTML = `
          <div>
            <div class="text-lg font-semibold text-gray-900">ç”Ÿæˆçš„${params.typeName}${difficultyText}</div>
            <div class="text-xs text-gray-500 mt-0.5">å·²ç”Ÿæˆ ${questions.length} é“é¢˜ç›®</div>
          </div>
        `;
      }

      // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
      if (previewActions) {
        previewActions.classList.remove('hidden');
      }

      // æ¸…é™¤æ—§å†…å®¹ï¼ˆä¿ç•™å‚æ•°å¡ç‰‡ï¼‰
      const existingResults = previewContainer.querySelectorAll('.generated-questions-container');
      existingResults.forEach(el => el.remove());

      // åˆ›å»ºé¢˜ç›®å®¹å™¨
      const container = document.createElement('div');
      container.className = 'generated-questions-container space-y-4';

      // æ¸²æŸ“æ¯é“é¢˜ç›®
      questions.forEach((question, index) => {
        const questionCard = createQuestionCard(question, index + 1);
        container.appendChild(questionCard);
      });

      // æ·»åŠ åˆ°é¢„è§ˆåŒº
      previewContainer.appendChild(container);

      // ä¿å­˜ç”Ÿæˆçš„é¢˜ç›®åˆ°å½“å‰ä»»åŠ¡ï¼ˆç”¨äºå¯¼å‡ºå’ŒåŠ å…¥è¯•å·ï¼‰
      if (currentTask) {
        currentTask.generatedQuestions = questions;
        saveTasksToStorage();
      }

      // æ»šåŠ¨åˆ°é¡¶éƒ¨
      previewContainer.scrollTop = 0;
    }

    // æ¸²æŸ“æœç´¢ç»“æœåˆ°é¢„è§ˆåŒº
    function renderSearchResults(searchResult) {
      const previewContainer = document.getElementById('previewContainer');
      const previewEmpty = document.getElementById('previewEmpty');

      // ç§»é™¤æ—§çš„æœç´¢ç»“æœ
      const oldResults = document.getElementById('searchResults');
      if (oldResults) {
        oldResults.remove();
      }

      // å¦‚æœæœç´¢å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
      if (!searchResult.success) {
        const errorDiv = document.createElement('div');
        errorDiv.id = 'searchResults';
        errorDiv.className = 'bg-white rounded-xl shadow-sm border border-red-200 p-6';
        errorDiv.innerHTML = `
          <div class="flex items-start space-x-3">
            <div class="flex-shrink-0 w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
              <i class="fas fa-exclamation-circle text-red-600"></i>
            </div>
            <div class="flex-1">
              <h4 class="text-sm font-semibold text-gray-900 mb-1">æœç´¢å¤±è´¥</h4>
              <p class="text-sm text-gray-600">${searchResult.message}</p>
              ${searchResult.total === 0 && searchResult.message.includes('é¢˜åº“ä¸ºç©º') ? `
                <div class="mt-3 pt-3 border-t border-gray-200">
                  <p class="text-xs text-gray-500 mb-2">æ‚¨å¯ä»¥ï¼š</p>
                  <a href="question-bank/add.html" class="inline-flex items-center text-xs text-primary-500 hover:text-primary-600">
                    <i class="fas fa-plus-circle mr-1"></i>
                    å‰å¾€é¢˜åº“ç®¡ç†æ·»åŠ é¢˜ç›®
                  </a>
                </div>
              ` : ''}
            </div>
          </div>
        `;

        // æ·»åŠ åˆ°å‚æ•°å¡ç‰‡ä¹‹å
        const paramsCard = document.getElementById('paramsCard');
        if (paramsCard.nextSibling) {
          previewContainer.insertBefore(errorDiv, paramsCard.nextSibling);
        } else {
          previewContainer.appendChild(errorDiv);
        }
        return;
      }

      // éšè—ç©ºçŠ¶æ€
      previewEmpty.classList.add('hidden');

      // åˆ›å»ºç»“æœå®¹å™¨
      const resultsDiv = document.createElement('div');
      resultsDiv.id = 'searchResults';
      resultsDiv.className = 'space-y-4';

      // ç»“æœç»Ÿè®¡
      const statsDiv = document.createElement('div');
      statsDiv.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-4';
      statsDiv.innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <h4 class="text-sm font-semibold text-gray-900 mb-1">æœç´¢ç»“æœ</h4>
            <p class="text-xs text-gray-500">${searchResult.message}</p>
          </div>
          <div class="text-right">
            <div class="text-2xl font-bold text-primary-500">${searchResult.returned}</div>
            <div class="text-xs text-gray-500">é“é¢˜ç›®</div>
          </div>
        </div>
      `;
      resultsDiv.appendChild(statsDiv);

      // é¢˜ç›®åˆ—è¡¨
      if (searchResult.results.length > 0) {
        searchResult.results.forEach((question, index) => {
          const questionCard = createQuestionCard(question, index + 1);
          resultsDiv.appendChild(questionCard);
        });
      }

      // æ·»åŠ æ–°ç»“æœï¼ˆåœ¨å‚æ•°å¡ç‰‡ä¹‹åï¼‰
      const paramsCard = document.getElementById('paramsCard');
      if (paramsCard.nextSibling) {
        previewContainer.insertBefore(resultsDiv, paramsCard.nextSibling);
      } else {
        previewContainer.appendChild(resultsDiv);
      }
    }

    // åˆ›å»ºé¢˜ç›®å¡ç‰‡
    function createQuestionCard(question, index) {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow';

      // é¢˜å‹é¢œè‰²æ˜ å°„
      const typeColors = {
        'single': 'info',
        'multiple': 'purple',
        'judge': 'success',
        'blank': 'warning',
        'shortAnswer': 'primary',
        'cloze': 'amber',
        'composite': 'indigo'
      };
      const color = typeColors[question.type] || 'gray';

      // éš¾åº¦æ–‡å­—
      const difficultyNames = ['', 'ä¸€çº§', 'äºŒçº§', 'ä¸‰çº§', 'å››çº§', 'äº”çº§'];
      const difficultyText = difficultyNames[question.difficulty || 1];

      // æ„å»ºé¢˜ç›®HTML - å‚è€ƒç®€ä¾¿å½•å…¥æ ¼å¼
      let contentHTML = `
        <div class="flex items-start justify-between mb-3">
          <div class="flex items-center space-x-2">
            <span class="px-2 py-1 bg-${color}-100 text-${color}-600 text-xs font-medium rounded">${question.typeName || question.type}</span>
          </div>
          <div class="flex items-center space-x-2">
            <span class="text-xs text-gray-600" title="éš¾åº¦">${difficultyText}</span>
          </div>
        </div>

        <div class="mb-3">
          <div class="flex items-start">
            <span class="text-sm font-medium text-gray-700 mr-2">${index}.</span>
            <div class="flex-1">
              <p class="text-sm text-gray-800 leading-relaxed whitespace-pre-wrap">${question.content}</p>
            </div>
          </div>
        </div>
      `;

      // æ ¹æ®é¢˜å‹æ˜¾ç¤ºé€‰é¡¹å’Œç­”æ¡ˆ
      if (question.type === 'single' || question.type === 'multiple' || question.type === 'judge') {
        // å•é€‰ã€å¤šé€‰ã€åˆ¤æ–­é¢˜ï¼šæ˜¾ç¤ºé€‰é¡¹
        if (question.options && question.options.length > 0) {
          contentHTML += `<div class="space-y-1 mb-3 ml-6">`;
          question.options.forEach(opt => {
            contentHTML += `
              <div class="flex items-start text-xs text-gray-600">
                <span class="font-medium mr-2">${opt.label}.</span>
                <span>${opt.text}</span>
              </div>
            `;
          });
          contentHTML += `</div>`;
        }
        // æ˜¾ç¤ºç­”æ¡ˆ
        const answerText = Array.isArray(question.correctAnswers) ? question.correctAnswers.join('ã€') : question.correctAnswers;
        contentHTML += `
          <div class="ml-6 mb-2">
            <span class="text-xs text-gray-700"><strong>ç­”æ¡ˆï¼š</strong>${answerText}</span>
          </div>
        `;
      } else if (question.type === 'blank') {
        // å¡«ç©ºé¢˜ï¼šæ˜¾ç¤ºç­”æ¡ˆï¼ˆå¤šä¸ªç­”æ¡ˆç”¨åˆ†å·åˆ†éš”ï¼‰
        const answerText = Array.isArray(question.correctAnswers) ? question.correctAnswers.join('ï¼›') : question.correctAnswers;
        contentHTML += `
          <div class="ml-6 mb-2">
            <span class="text-xs text-gray-700"><strong>ç­”æ¡ˆï¼š</strong>${answerText}</span>
          </div>
        `;
      } else if (question.type === 'shortAnswer') {
        // ç®€ç­”é¢˜ï¼šä¸æ˜¾ç¤ºç­”æ¡ˆï¼ˆæˆ–æ˜¾ç¤º"æ— "ï¼‰
        contentHTML += `
          <div class="ml-6 mb-2">
            <span class="text-xs text-gray-500"><strong>ç­”æ¡ˆï¼š</strong>ï¼ˆä¸»è§‚é¢˜ï¼Œæ— æ ‡å‡†ç­”æ¡ˆï¼‰</span>
          </div>
        `;
      } else if (question.type === 'cloze') {
        // å®Œå½¢å¡«ç©ºï¼šæ˜¾ç¤ºé€‰é¡¹å’Œç­”æ¡ˆ
        if (question.blanks && question.blanks.length > 0) {
          contentHTML += `<div class="space-y-2 mb-3 ml-6">`;
          question.blanks.forEach((blank, blankIndex) => {
            contentHTML += `<div class="text-xs text-gray-600">`;
            contentHTML += `<div class="font-medium mb-1">${blankIndex + 1})</div>`;
            if (blank.options && blank.options.length > 0) {
              blank.options.forEach(opt => {
                contentHTML += `<span class="mr-3">${opt.label}. ${opt.text}</span>`;
              });
            }
            contentHTML += `</div>`;
          });
          contentHTML += `</div>`;
        }
        // æ˜¾ç¤ºç­”æ¡ˆï¼ˆå¦‚"BDCA"ï¼‰
        contentHTML += `
          <div class="ml-6 mb-2">
            <span class="text-xs text-gray-700"><strong>ç­”æ¡ˆï¼š</strong>${question.correctAnswers || ''}</span>
          </div>
        `;
      } else if (question.type === 'composite') {
        // å¤åˆé¢˜ï¼šæ˜¾ç¤ºå­é¢˜
        if (question.subQuestions && question.subQuestions.length > 0) {
          contentHTML += `<div class="space-y-3 mb-3 ml-6 border-l-2 border-gray-200 pl-4">`;
          question.subQuestions.forEach((subQ, subIndex) => {
            contentHTML += `
              <div class="text-xs">
                <div class="font-medium text-gray-700 mb-1">${subIndex + 1}ï¼‰ã€${subQ.typeName}ã€‘${subQ.content}</div>
            `;
            // å­é¢˜é€‰é¡¹
            if (subQ.options && subQ.options.length > 0) {
              subQ.options.forEach(opt => {
                contentHTML += `<div class="text-gray-600 ml-4">${opt.label}. ${opt.text}</div>`;
              });
            }
            // å­é¢˜ç­”æ¡ˆ
            const subAnswerText = Array.isArray(subQ.correctAnswers) ? subQ.correctAnswers.join('ã€') : subQ.correctAnswers;
            contentHTML += `<div class="text-gray-700 ml-4 mt-1"><strong>ç­”æ¡ˆï¼š</strong>${subAnswerText}</div>`;
            contentHTML += `</div>`;
          });
          contentHTML += `</div>`;
        }
      }

      // æ˜¾ç¤ºçŸ¥è¯†ç‚¹ï¼ˆå¦‚æœæœ‰ï¼‰
      if (question.knowledgePath) {
        contentHTML += `
          <div class="pt-3 border-t border-gray-100">
            <div class="flex items-center text-xs text-gray-500">
              <i class="fas fa-folder text-primary-500 mr-1"></i>
              <span>çŸ¥è¯†ç‚¹ï¼š${question.knowledgePath}</span>
            </div>
          </div>
        `;
      }

      card.innerHTML = contentHTML;
      return card;
    }

    // å¯¼å‡ºç”Ÿæˆçš„é¢˜ç›®
    function exportGeneratedQuestions() {
      const container = document.querySelector('.generated-questions-container');
      if (!container) {
        alert('æ²¡æœ‰å¯å¯¼å‡ºçš„é¢˜ç›®');
        return;
      }

      // è·å–å½“å‰ä»»åŠ¡ä¸­ä¿å­˜çš„ç”Ÿæˆå‚æ•°
      if (!currentTask || !currentTask.generatedQuestions) {
        alert('æ²¡æœ‰æ‰¾åˆ°ç”Ÿæˆçš„é¢˜ç›®æ•°æ®');
        return;
      }

      const questions = currentTask.generatedQuestions;
      const params = currentTask.generateParams;

      // æ„å»ºå¯¼å‡ºå†…å®¹
      let content = `# ç”Ÿæˆçš„${params.typeName}\n\n`;
      content += `ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}\n`;
      content += `é¢˜ç›®æ•°é‡ï¼š${questions.length}é“\n`;
      if (params.difficultyName) {
        content += `éš¾åº¦ï¼š${params.difficultyName}\n`;
      }
      if (params.knowledgePoint) {
        content += `çŸ¥è¯†ç‚¹ï¼š${params.knowledgePoint}\n`;
      }
      content += `\n---\n\n`;

      questions.forEach((q, index) => {
        content += `## é¢˜ç›® ${index + 1}\n\n`;
        content += `**é¢˜å‹**ï¼š${q.typeName}\n`;
        content += `**éš¾åº¦**ï¼š${q.difficultyName || 'æœªè®¾ç½®'}\n`;
        content += `**åˆ†å€¼**ï¼š${q.score || 2}åˆ†\n`;
        if (q.knowledgePath) {
          content += `**çŸ¥è¯†ç‚¹**ï¼š${q.knowledgePath}\n`;
        }
        content += `\n**é¢˜å¹²**ï¼š\n${q.content}\n\n`;

        if (q.options && q.options.length > 0) {
          content += `**é€‰é¡¹**ï¼š\n`;
          q.options.forEach(opt => {
            content += `${opt.label}. ${opt.text}\n`;
          });
          content += `\n`;
        }

        content += `**æ­£ç¡®ç­”æ¡ˆ**ï¼š${Array.isArray(q.correctAnswers) ? q.correctAnswers.join(', ') : q.correctAnswers}\n`;

        if (q.explanation) {
          content += `\n**è§£æ**ï¼š\n${q.explanation}\n`;
        }

        content += `\n---\n\n`;
      });

      // åˆ›å»ºä¸‹è½½
      const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ç”Ÿæˆçš„${params.typeName}_${new Date().getTime()}.md`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // æ·»åŠ AIæ¶ˆæ¯æç¤º
      addAIMessage(`âœ… å·²å¯¼å‡º${questions.length}é“${params.typeName}åˆ°Markdownæ–‡ä»¶`);
    }

    // å°†ç”Ÿæˆçš„é¢˜ç›®å½•å…¥è‡³ç®€ä¾¿å½•å…¥åŒº
    function addToSimpleInput() {
      if (!currentTask || !currentTask.generatedQuestions) {
        alert('æ²¡æœ‰æ‰¾åˆ°ç”Ÿæˆçš„é¢˜ç›®æ•°æ®');
        return;
      }

      const questions = currentTask.generatedQuestions;
      const params = currentTask.generateParams;

      // æç¤ºç”¨æˆ·åŠŸèƒ½å¾…å®ç°
      addAIMessage(`âœ… å·²å‡†å¤‡å°†${questions.length}é“é¢˜ç›®å½•å…¥è‡³ç®€ä¾¿å½•å…¥åŒº\n\nğŸ“ **ä¸‹ä¸€æ­¥æ“ä½œ**ï¼š\nâ€¢ é¢˜ç›®å°†ä»¥ç®€ä¾¿å½•å…¥æ ¼å¼å±•ç¤º\nâ€¢ æ‚¨å¯ä»¥åœ¨ç®€ä¾¿å½•å…¥åŒºè¿›è¡Œæœ€åç¡®è®¤å’Œä¿®æ”¹\nâ€¢ ç¡®è®¤æ— è¯¯åå³å¯æ­£å¼å½•å…¥é¢˜åº“\n\nğŸ’¡ æ­¤åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼`);

      // è¿™é‡Œå¯ä»¥å°†é¢˜ç›®è½¬æ¢ä¸ºç®€ä¾¿å½•å…¥æ ¼å¼å¹¶è·³è½¬åˆ°ç®€ä¾¿å½•å…¥é¡µé¢
      // å®é™…å®ç°æ—¶éœ€è¦ä¸ç®€ä¾¿å½•å…¥æ¨¡å—é›†æˆ
      console.log('å‡†å¤‡å½•å…¥è‡³ç®€ä¾¿å½•å…¥åŒºçš„é¢˜ç›®:', questions);
    }

    // ========== åˆå§‹åŒ– ==========
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
      setupEventListeners();
      loadTasksFromStorage();
      setupMobileTabs();
      setupTaskPanelToggle(); // è®¾ç½®ä»»åŠ¡é¢æ¿å±•å¼€/æ”¶èµ·
    });

    function initializeApp() {
      console.log('è€ƒè¯•åŠ©æ‰‹åˆå§‹åŒ–...');

      // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
      const messageInput = document.getElementById('messageInput');
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });

      // æ‹–æ‹½ä¸Šä¼ 
      setupDragAndDrop();

      // æ£€æŸ¥æ˜¯å¦æœ‰æ¥è‡ªdashboardçš„åˆå§‹æ¶ˆæ¯
      const initialMessage = sessionStorage.getItem('aiInitialMessage');
      if (initialMessage) {
        console.log('æ£€æµ‹åˆ°æ¥è‡ªdashboardçš„åˆå§‹æ¶ˆæ¯:', initialMessage);

        // æ¸…é™¤sessionStorageä¸­çš„æ¶ˆæ¯ï¼ˆé¿å…é‡å¤å‘é€ï¼‰
        sessionStorage.removeItem('aiInitialMessage');

        // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
        setTimeout(() => {
          // å¡«å……åˆ°è¾“å…¥æ¡†
          messageInput.value = initialMessage;

          // è‡ªåŠ¨å‘é€æ¶ˆæ¯
          sendMessage();
        }, 300);
      }
    }

    // è®¾ç½®ä»»åŠ¡é¢æ¿å±•å¼€/æ”¶èµ·åŠŸèƒ½
    function setupTaskPanelToggle() {
      const taskPanel = document.getElementById('taskPanel');
      const toggleBtn = document.getElementById('toggleTaskPanel');
      const closeBtn = document.getElementById('closeTaskPanel');

      // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
      if (!taskPanel || !toggleBtn || !closeBtn) {
        console.error('ä»»åŠ¡é¢æ¿å…ƒç´ æœªæ‰¾åˆ°:', { taskPanel, toggleBtn, closeBtn });
        return;
      }

      let isTaskPanelVisible = false;

      // å±•å¼€/æ”¶èµ·ä»»åŠ¡é¢æ¿
      function toggleTaskPanel() {
        isTaskPanelVisible = !isTaskPanelVisible;

        if (isTaskPanelVisible) {
          // æ˜¾ç¤ºä»»åŠ¡é¢æ¿
          taskPanel.style.marginLeft = '0';
          taskPanel.style.opacity = '1';
          toggleBtn.title = 'éšè—å¯¹è¯åˆ—è¡¨';
        } else {
          // éšè—ä»»åŠ¡é¢æ¿
          taskPanel.style.marginLeft = '-20%';
          taskPanel.style.opacity = '0';
          toggleBtn.title = 'æ˜¾ç¤ºå¯¹è¯åˆ—è¡¨';
        }
      }

      // ç»‘å®šäº‹ä»¶
      toggleBtn.addEventListener('click', function(e) {
        e.preventDefault();
        toggleTaskPanel();
      });

      closeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        toggleTaskPanel();
      });

      console.log('ä»»åŠ¡é¢æ¿å±•å¼€/æ”¶èµ·åŠŸèƒ½å·²åˆå§‹åŒ–');
    }

    // ========== äº‹ä»¶ç›‘å¬ ==========
    function setupEventListeners() {
      // æ–°å»ºä»»åŠ¡
      const newTaskBtn = document.getElementById('newTaskBtn');
      if (newTaskBtn) {
        newTaskBtn.addEventListener('click', createNewTask);
      }

      // æ‰¹é‡åˆ é™¤
      const batchDeleteBtn = document.getElementById('batchDeleteBtn');
      const cancelBatchBtn = document.getElementById('cancelBatchBtn');
      if (batchDeleteBtn) {
        batchDeleteBtn.addEventListener('click', enterBatchDeleteMode);
      }
      if (cancelBatchBtn) {
        cancelBatchBtn.addEventListener('click', exitBatchDeleteMode);
      }

      // å‘é€æ¶ˆæ¯
      const sendBtn = document.getElementById('sendBtn');
      const messageInput = document.getElementById('messageInput');

      if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
      }

      if (messageInput) {
        messageInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
        console.log('æ¶ˆæ¯è¾“å…¥æ¡†äº‹ä»¶å·²ç»‘å®š');
      } else {
        console.error('messageInputå…ƒç´ æœªæ‰¾åˆ°');
      }

      // ä¸Šä¼ æ–‡æ¡£
      const uploadBtn = document.getElementById('uploadBtn');
      const fileInput = document.getElementById('fileInput');

      if (uploadBtn && fileInput) {
        uploadBtn.addEventListener('click', function() {
          fileInput.click();
        });
        fileInput.addEventListener('change', handleFileSelect);
      }

      // å¿«æ·æ“ä½œ
      document.querySelectorAll('.quick-action').forEach(btn => {
        btn.addEventListener('click', function() {
          const action = this.dataset.action;
          handleQuickAction(action);
        });
      });

      // ä»»åŠ¡ç­›é€‰ï¼ˆChatGPTæ¨¡å¼ä¸‹å·²ç§»é™¤ï¼‰
      // document.querySelectorAll('.filter-btn').forEach(btn => { ... });
    }

    // ========== æ‹–æ‹½ä¸Šä¼  ==========
    function setupDragAndDrop() {
      const messageInput = document.getElementById('messageInput');

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        messageInput.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        messageInput.addEventListener(eventName, function() {
          this.classList.add('border-primary-500', 'bg-primary-50');
        });
      });

      ['dragleave', 'drop'].forEach(eventName => {
        messageInput.addEventListener(eventName, function() {
          this.classList.remove('border-primary-500', 'bg-primary-50');
        });
      });

      messageInput.addEventListener('drop', function(e) {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFiles(files);
        }
      });
    }

    // ========== æ–‡æ¡£ä¸Šä¼ å¤„ç† ==========

    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    function handleFiles(files) {
      if (files.length === 0) return;

      const file = files[0]; // åªå¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶

      // éªŒè¯æ–‡ä»¶ç±»å‹
      const allowedTypes = [
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'text/plain',
        'text/markdown'
      ];

      const allowedExtensions = ['.pdf', '.doc', '.docx', '.txt', '.md'];
      const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

      if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
        alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼è¯·ä¸Šä¼  PDFã€Wordã€TXT æˆ– Markdown æ–‡ä»¶ã€‚');
        return;
      }

      // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶10MBï¼‰
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        alert('æ–‡ä»¶å¤ªå¤§ï¼è¯·ä¸Šä¼ å°äº 10MB çš„æ–‡ä»¶ã€‚');
        return;
      }

      // ä¿å­˜æ–‡æ¡£ä¿¡æ¯
      uploadedDocument = {
        name: file.name,
        size: formatFileSize(file.size),
        type: file.type || 'unknown',
        extension: fileExtension,
        file: file,
        uploadTime: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }),
        status: 'parsing', // parsing, success, error
        content: null
      };

      // å¦‚æœæ²¡æœ‰å½“å‰ä»»åŠ¡ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°å¯¹è¯
      if (!currentTask) {
        createTask('conversation', true);
      }

      // æ˜¾ç¤ºæ–‡æ¡£å¡ç‰‡
      addDocumentMessage(uploadedDocument);

      // æ¨¡æ‹Ÿè§£ææ–‡æ¡£
      setTimeout(() => {
        parseDocument(uploadedDocument);
      }, 1500);
    }

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // æ·»åŠ æ–‡æ¡£æ¶ˆæ¯åˆ°å¯¹è¯æ¡†
    function addDocumentMessage(doc) {
      const messageDiv = createDocumentMessageElement(doc);
      document.getElementById('messageContainer').appendChild(messageDiv);
      scrollToBottom();

      // ä¿å­˜åˆ°å†å²
      messages.push({
        role: 'user',
        type: 'document',
        document: doc,
        time: doc.uploadTime
      });
    }

    // åˆ›å»ºæ–‡æ¡£æ¶ˆæ¯å…ƒç´ 
    function createDocumentMessageElement(doc) {
      const div = document.createElement('div');
      div.className = 'flex items-start space-x-3 message-enter';
      div.id = `doc-${Date.now()}`;

      // è·å–æ–‡ä»¶å›¾æ ‡
      const icon = getFileIcon(doc.extension);

      div.innerHTML = `
        <div class="flex-1"></div>
        <div class="max-w-md w-full">
          <div class="document-card">
            <div class="flex items-start gap-3">
              <div class="document-icon">
                <i class="${icon}"></i>
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                  <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-medium text-gray-900 truncate">${doc.name}</h4>
                    <p class="text-xs text-gray-500 mt-1">${doc.size}</p>
                  </div>
                  <span class="document-status ${doc.status}">
                    ${doc.status === 'parsing' ? '<i class="fas fa-spinner fa-spin"></i> è§£æä¸­...' : ''}
                    ${doc.status === 'success' ? '<i class="fas fa-check-circle"></i> å·²è§£æ' : ''}
                    ${doc.status === 'error' ? '<i class="fas fa-exclamation-circle"></i> è§£æå¤±è´¥' : ''}
                  </span>
                </div>
              </div>
            </div>
            <div class="document-actions" id="doc-actions-${Date.now()}" style="display: none;">
              <button class="doc-action-btn" onclick="suggestAction('æ ¹æ®æ–‡æ¡£ç”Ÿæˆé¢˜ç›®')">
                <i class="fas fa-file-alt"></i>
                æ ¹æ®æ–‡æ¡£ç”Ÿæˆé¢˜ç›®
              </button>
              <button class="doc-action-btn" onclick="suggestAction('æ€»ç»“æ–‡æ¡£å†…å®¹')">
                <i class="fas fa-list-ul"></i>
                æ€»ç»“æ–‡æ¡£å†…å®¹
              </button>
            </div>
          </div>
          <p class="text-xs text-gray-400 mt-1 text-right">${doc.uploadTime}</p>
        </div>
        <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center flex-shrink-0">
          <i class="fas fa-user text-white text-sm"></i>
        </div>
      `;

      return div;
    }

    // è·å–æ–‡ä»¶å›¾æ ‡
    function getFileIcon(extension) {
      const icons = {
        '.pdf': 'fas fa-file-pdf',
        '.doc': 'fas fa-file-word',
        '.docx': 'fas fa-file-word',
        '.txt': 'fas fa-file-alt',
        '.md': 'fas fa-file-code'
      };
      return icons[extension] || 'fas fa-file';
    }

    // è§£ææ–‡æ¡£ï¼ˆæ¨¡æ‹Ÿï¼‰
    function parseDocument(doc) {
      // æ¨¡æ‹Ÿæ–‡æ¡£è§£æ
      const reader = new FileReader();

      reader.onload = function(e) {
        // ç®€å•æå–æ–‡æœ¬å†…å®¹ï¼ˆå®é™…åº”ç”¨ä¸­éœ€è¦æ ¹æ®æ–‡ä»¶ç±»å‹ä½¿ç”¨ä¸åŒçš„è§£æåº“ï¼‰
        let content = '';

        if (doc.extension === '.txt' || doc.extension === '.md') {
          content = e.target.result;
        } else {
          // å¯¹äº PDF å’Œ Word æ–‡æ¡£ï¼Œè¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿ
          content = `è¿™æ˜¯ä¸€ä»½${doc.extension}æ–‡æ¡£çš„å†…å®¹æ‘˜è¦...\n\n[å®é™…åº”ç”¨ä¸­éœ€è¦ä½¿ç”¨ä¸“é—¨çš„åº“æ¥è§£æPDFå’ŒWordæ–‡æ¡£]`;
        }

        // æ›´æ–°æ–‡æ¡£çŠ¶æ€
        doc.status = 'success';
        doc.content = content;

        // æ›´æ–°UI
        updateDocumentStatus(doc);

        // æ£€æŸ¥æ˜¯å¦åœ¨å¼•å¯¼æµç¨‹ä¸­
        const conversationManager = new ConversationManager(currentTask);
        const params = currentTask.generateParams;

        if (params && (params.step === 'document' || params.step === 'waiting_document' || params.step === 'mixed_document' || params.step === 'mixed_waiting_document')) {
          // åœ¨å¼•å¯¼æµç¨‹ä¸­ï¼Œè‡ªåŠ¨ç»§ç»­æµç¨‹
          params.hasDocument = true;
          params.documentName = doc.name;
          params.documentContent = doc.content;

          // æ ¹æ®ä¸åŒçš„æµç¨‹ç±»å‹ç»§ç»­
          if (params.step === 'mixed_document' || params.step === 'mixed_waiting_document') {
            // æ··åˆé¢˜å‹æµç¨‹ï¼šè¿›å…¥éš¾åº¦é€‰æ‹©æ­¥éª¤
            params.step = 'mixed_difficulty';
            setTimeout(() => {
              addAIMessage(`å¥½çš„ï¼Œæˆ‘å°†åŸºäºæ‚¨ä¸Šä¼ çš„æ–‡æ¡£ã€Š${doc.name}ã€‹ç”Ÿæˆé¢˜ç›®ã€‚\n\nâ­ **é€‰æ‹©éš¾åº¦**\n\nè¯·é—®éœ€è¦ä»€ä¹ˆéš¾åº¦çš„é¢˜ç›®ï¼Ÿ\nâ€¢ ä¸€çº§ï¼ˆç®€å•ï¼‰\nâ€¢ äºŒçº§ï¼ˆä¸­ç­‰ï¼‰\nâ€¢ ä¸‰çº§ï¼ˆå›°éš¾ï¼‰\nâ€¢ å››çº§ï¼ˆå¾ˆéš¾ï¼‰\nâ€¢ äº”çº§ï¼ˆæéš¾ï¼‰\n\nå¦‚æœä¸æŒ‡å®šéš¾åº¦ï¼Œæˆ‘å°†æ ¹æ®æ–‡æ¡£å†…å®¹è‡ªåŠ¨è°ƒæ•´éš¾åº¦ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"ã€‚`);
            }, 500);
          } else {
            // å•é¢˜å‹æµç¨‹ï¼šè¿›å…¥éš¾åº¦é€‰æ‹©æ­¥éª¤
            params.step = 'difficulty';
            setTimeout(() => {
              addAIMessage(`å¥½çš„ï¼Œæˆ‘å°†åŸºäºæ‚¨ä¸Šä¼ çš„æ–‡æ¡£ã€Š${doc.name}ã€‹ç”Ÿæˆ${params.count}é“${params.typeName}ã€‚\n\nâ­ **é€‰æ‹©éš¾åº¦**\n\nè¯·é—®éœ€è¦ä»€ä¹ˆéš¾åº¦çš„é¢˜ç›®ï¼Ÿ\nâ€¢ ä¸€çº§ï¼ˆç®€å•ï¼‰\nâ€¢ äºŒçº§ï¼ˆä¸­ç­‰ï¼‰\nâ€¢ ä¸‰çº§ï¼ˆå›°éš¾ï¼‰\nâ€¢ å››çº§ï¼ˆå¾ˆéš¾ï¼‰\nâ€¢ äº”çº§ï¼ˆæéš¾ï¼‰\n\nå¦‚æœä¸æŒ‡å®šéš¾åº¦ï¼Œæˆ‘å°†æ ¹æ®æ–‡æ¡£å†…å®¹è‡ªåŠ¨è°ƒæ•´éš¾åº¦ã€‚æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å›å¤"è·³è¿‡"å¼€å§‹ç”Ÿæˆã€‚`);
            }, 500);
          }
        } else {
          // ä¸åœ¨å¼•å¯¼æµç¨‹ä¸­ï¼Œæ˜¾ç¤ºå¿«æ·æ“ä½œæŒ‰é’®
          showDocumentActions();

          // å‘é€AIæç¤ºæ¶ˆæ¯
          setTimeout(() => {
            addAIMessage(`æˆ‘å·²ç»è§£æäº†æ‚¨ä¸Šä¼ çš„æ–‡æ¡£ã€Š${doc.name}ã€‹ã€‚\n\næ‚¨å¯ä»¥ï¼š\nâ€¢ è®©æˆ‘æ ¹æ®æ–‡æ¡£å†…å®¹ç”Ÿæˆé¢˜ç›®\nâ€¢ æ€»ç»“æ–‡æ¡£çš„ä¸»è¦å†…å®¹\n\nè¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³åšä»€ä¹ˆï¼Ÿ`);
          }, 500);
        }
      };

      reader.onerror = function() {
        doc.status = 'error';
        updateDocumentStatus(doc);
        addAIMessage(`æŠ±æ­‰ï¼Œæ–‡æ¡£è§£æå¤±è´¥ã€‚è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚`);
      };

      // è¯»å–æ–‡ä»¶
      if (doc.extension === '.txt' || doc.extension === '.md') {
        reader.readAsText(doc.file);
      } else {
        reader.readAsArrayBuffer(doc.file);
      }
    }

    // æ›´æ–°æ–‡æ¡£çŠ¶æ€
    function updateDocumentStatus(doc) {
      const statusElements = document.querySelectorAll('.document-status');
      statusElements.forEach(el => {
        if (el.closest('.document-card')) {
          el.className = `document-status ${doc.status}`;
          if (doc.status === 'success') {
            el.innerHTML = '<i class="fas fa-check-circle"></i> å·²è§£æ';
          } else if (doc.status === 'error') {
            el.innerHTML = '<i class="fas fa-exclamation-circle"></i> è§£æå¤±è´¥';
          }
        }
      });
    }

    // æ˜¾ç¤ºæ–‡æ¡£å¿«æ·æ“ä½œ
    function showDocumentActions() {
      const actionsElements = document.querySelectorAll('[id^="doc-actions-"]');
      actionsElements.forEach(el => {
        el.style.display = 'flex';
      });
    }

    // å¿«æ·æ“ä½œå»ºè®®
    function suggestAction(action) {
      const input = document.getElementById('messageInput');
      input.value = action;
      input.focus();
    }

    // å¤„ç†æ–‡ä»¶é€‰æ‹©ï¼ˆé€šè¿‡æŒ‰é’®ä¸Šä¼ ï¼‰
    function handleFileSelect(e) {
      const files = e.target.files;
      if (files.length > 0) {
        handleFiles(files);
      }
      // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶
      e.target.value = '';
    }

    // ========== ä»»åŠ¡ç®¡ç† ==========
    function createNewTask() {
      // ç›´æ¥åˆ›å»ºé€šç”¨å¯¹è¯ä»»åŠ¡
      createTask('conversation');
    }

    // åˆ›å»ºä»»åŠ¡
    function createTask(taskType, skipWelcome = false) {
      const task = createTaskTemplate(taskType);

      if (!task) {
        console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼šæœªçŸ¥çš„ä»»åŠ¡ç±»å‹', taskType);
        return;
      }

      // æ·»åŠ åˆ°ä»»åŠ¡åˆ—è¡¨
      tasks.unshift(task); // æ–°ä»»åŠ¡æ”¾åœ¨æœ€å‰é¢

      // ä¿å­˜åˆ° LocalStorage
      saveTasksToStorage();

      // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
      renderTaskList();

      // åˆ‡æ¢åˆ°è¯¥ä»»åŠ¡
      loadTask(task);

      // å¦‚æœä¸è·³è¿‡æ¬¢è¿æ¶ˆæ¯ï¼Œåˆ™å‘é€æ¬¢è¿æ¶ˆæ¯
      if (!skipWelcome) {
        const typeInfo = getTaskTypeInfo(taskType);
        let welcomeMessage = `å¥½çš„ï¼æˆ‘å°†å¸®æ‚¨${typeInfo.name}ã€‚\n\n`;

        // æ ¹æ®ä»»åŠ¡ç±»å‹æä¾›å…·ä½“å¼•å¯¼
        switch (taskType) {
          case 'generate_questions':
            welcomeMessage += 'è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ç”Ÿæˆçš„é¢˜ç›®ä¿¡æ¯ï¼š\nâ€¢ é¢˜å‹ï¼ˆå•é€‰ã€å¤šé€‰ã€åˆ¤æ–­ã€å¡«ç©ºã€ç®€ç­”ï¼‰\nâ€¢ æ•°é‡ï¼ˆä¾‹å¦‚ï¼š10é“é¢˜ï¼‰\nâ€¢ éš¾åº¦ï¼ˆå¯é€‰ï¼‰\nâ€¢ çŸ¥è¯†ç‚¹ï¼ˆå¯é€‰ï¼‰';
            break;
          case 'create_paper':
            welcomeMessage += 'è¯·å‘Šè¯‰æˆ‘è¯•å·çš„åŸºæœ¬ä¿¡æ¯ï¼š\nâ€¢ è¯•å·åç§°ï¼ˆä¾‹å¦‚ï¼šã€ŠæœŸæœ«è€ƒè¯•ã€‹ï¼‰\nâ€¢ æ€»åˆ†ï¼ˆä¾‹å¦‚ï¼š100åˆ†ï¼‰';
            break;
          case 'create_exam':
            welcomeMessage += 'è¯·å‘Šè¯‰æˆ‘è€ƒè¯•çš„åŸºæœ¬ä¿¡æ¯ï¼š\nâ€¢ è€ƒè¯•åç§°ï¼ˆä¾‹å¦‚ï¼šã€ŠæœŸæœ«è€ƒè¯•ã€‹ï¼‰\nâ€¢ è€ƒè¯•æ—¶é•¿ï¼ˆä¾‹å¦‚ï¼š120åˆ†é’Ÿï¼‰';
            break;
          case 'create_practice':
            welcomeMessage += 'è¯·å‘Šè¯‰æˆ‘åˆ·é¢˜ä»»åŠ¡çš„åŸºæœ¬ä¿¡æ¯ï¼š\nâ€¢ ä»»åŠ¡åç§°ï¼ˆä¾‹å¦‚ï¼šã€Šæ¯æ—¥ç»ƒä¹ ã€‹ï¼‰\nâ€¢ é¢˜ç›®æ•°é‡ï¼ˆä¾‹å¦‚ï¼š20é“é¢˜ï¼‰';
            break;
          default:
            welcomeMessage += 'è¯·å‘Šè¯‰æˆ‘æ‚¨çš„å…·ä½“éœ€æ±‚ï¼Œæˆ‘ä¼šä¸€æ­¥æ­¥å¼•å¯¼æ‚¨å®Œæˆã€‚';
        }

        addAIMessage(welcomeMessage);
      }

      // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºè¿›è¡Œä¸­ï¼ˆå¦‚æœçŠ¶æ€ç³»ç»Ÿè¿˜åœ¨ä½¿ç”¨ï¼‰
      // updateTaskStatus(task.id, TASK_STATUS.IN_PROGRESS);
    }

    function loadTasksFromStorage() {
      try {
        const stored = localStorage.getItem('aiAssistantTasks');
        if (!stored) {
          console.log('æš‚æ— ä»»åŠ¡æ•°æ®');
          return;
        }

        const data = JSON.parse(stored);

        // ç‰ˆæœ¬æ£€æŸ¥
        if (data.version !== STORAGE_VERSION) {
          console.warn(`æ•°æ®ç‰ˆæœ¬ä¸åŒ¹é…ï¼ˆå½“å‰: ${STORAGE_VERSION}, å­˜å‚¨: ${data.version || 'æœªçŸ¥'}ï¼‰ï¼Œæ¸…ç©ºæ—§æ•°æ®`);
          localStorage.removeItem('aiAssistantTasks');
          return;
        }

        // æ•°æ®æ ¡éªŒ
        if (Array.isArray(data.tasks)) {
          tasks = data.tasks;
          renderTaskList();
          console.log(`æˆåŠŸåŠ è½½ ${tasks.length} ä¸ªä»»åŠ¡`);
        } else {
          console.error('ä»»åŠ¡æ•°æ®æ ¼å¼é”™è¯¯');
          localStorage.removeItem('aiAssistantTasks');
        }
      } catch (error) {
        console.error('åŠ è½½ä»»åŠ¡æ•°æ®å¤±è´¥:', error);
        localStorage.removeItem('aiAssistantTasks');
      }
    }

    function saveTasksToStorage() {
      try {
        const data = {
          version: STORAGE_VERSION,
          tasks: tasks,
          lastUpdate: new Date().toISOString()
        };
        localStorage.setItem('aiAssistantTasks', JSON.stringify(data));
        console.log('ä»»åŠ¡æ•°æ®å·²ä¿å­˜');
      } catch (error) {
        console.error('ä¿å­˜ä»»åŠ¡æ•°æ®å¤±è´¥:', error);
        // å¯èƒ½æ˜¯å­˜å‚¨ç©ºé—´ä¸è¶³
        if (error.name === 'QuotaExceededError') {
          alert('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†æµè§ˆå™¨æ•°æ®');
        }
      }
    }

    // æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨ï¼‰
    // function updateTaskStatus(taskId, status) { ... }

    // æ›´æ–°ä»»åŠ¡è¿›åº¦
    function updateTaskProgress(taskId, current, total) {
      const task = tasks.find(t => t.id === taskId);
      if (task) {
        task.progress = {
          current: current,
          total: total,
          percentage: Math.round((current / total) * 100)
        };
        saveTasksToStorage();
        renderTaskList();
      }
    }

    // åˆ é™¤ä»»åŠ¡
    function deleteTask(taskId) {
      showDeleteConfirmDialog(taskId);
    }

    // æ‰¹é‡åˆ é™¤æ¨¡å¼
    let batchDeleteMode = false;
    let selectedTaskIds = new Set();

    function enterBatchDeleteMode() {
      batchDeleteMode = true;
      selectedTaskIds.clear();

      // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
      document.getElementById('batchDeleteBtn').classList.add('hidden');
      document.getElementById('cancelBatchBtn').classList.remove('hidden');

      // ä¸ºæ‰€æœ‰ä»»åŠ¡å¡ç‰‡æ·»åŠ å¤é€‰æ¡†
      document.querySelectorAll('.task-card').forEach(card => {
        const taskId = card.dataset.taskId;
        if (!card.querySelector('.task-checkbox')) {
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'task-checkbox mr-2';
          checkbox.addEventListener('change', function() {
            if (this.checked) {
              selectedTaskIds.add(taskId);
            } else {
              selectedTaskIds.delete(taskId);
            }
            updateBatchDeleteButton();
          });
          card.querySelector('.flex.items-start').insertBefore(checkbox, card.querySelector('.flex.items-start').firstChild);
        }
      });

      // æ·»åŠ ç¡®è®¤åˆ é™¤æŒ‰é’®
      if (!document.getElementById('confirmBatchDeleteBtn')) {
        const confirmBtn = document.createElement('button');
        confirmBtn.id = 'confirmBatchDeleteBtn';
        confirmBtn.className = 'hidden flex-1 px-3 py-1.5 bg-red-500 text-white rounded text-xs hover:bg-red-600 transition-colors';
        confirmBtn.innerHTML = '<i class="fas fa-trash-alt mr-1"></i>åˆ é™¤é€‰ä¸­';
        confirmBtn.addEventListener('click', confirmBatchDelete);
        document.getElementById('cancelBatchBtn').parentElement.appendChild(confirmBtn);
      }
    }

    function exitBatchDeleteMode() {
      batchDeleteMode = false;
      selectedTaskIds.clear();

      // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
      document.getElementById('batchDeleteBtn').classList.remove('hidden');
      document.getElementById('cancelBatchBtn').classList.add('hidden');
      const confirmBtn = document.getElementById('confirmBatchDeleteBtn');
      if (confirmBtn) {
        confirmBtn.classList.add('hidden');
      }

      // ç§»é™¤æ‰€æœ‰å¤é€‰æ¡†
      document.querySelectorAll('.task-checkbox').forEach(checkbox => {
        checkbox.remove();
      });
    }

    function updateBatchDeleteButton() {
      const confirmBtn = document.getElementById('confirmBatchDeleteBtn');
      if (confirmBtn) {
        if (selectedTaskIds.size > 0) {
          confirmBtn.classList.remove('hidden');
          confirmBtn.innerHTML = `<i class="fas fa-trash-alt mr-1"></i>åˆ é™¤é€‰ä¸­ (${selectedTaskIds.size})`;
        } else {
          confirmBtn.classList.add('hidden');
        }
      }
    }

    function confirmBatchDelete() {
      if (selectedTaskIds.size === 0) return;

      const dialogHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="batchDeleteConfirmDialog">
          <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4">
            <div class="p-6">
              <div class="flex items-start space-x-4">
                <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                  <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-gray-900">ç¡®è®¤æ‰¹é‡åˆ é™¤</h3>
                  <p class="text-sm text-gray-600 mt-2">
                    ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ <span class="font-medium text-red-600">${selectedTaskIds.size}</span> ä¸ªä»»åŠ¡å—ï¼Ÿ
                  </p>
                  <p class="text-sm text-red-600 mt-2">
                    <i class="fas fa-info-circle"></i> æ‰€æœ‰å¯¹è¯å†å²å°†æ— æ³•æ¢å¤
                  </p>
                </div>
              </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 rounded-b-2xl flex justify-end space-x-3">
              <button
                class="px-4 py-2 text-gray-700 hover:text-gray-900 font-medium rounded-lg hover:bg-gray-200 transition-colors"
                onclick="closeBatchDeleteConfirmDialog()"
              >
                å–æ¶ˆ
              </button>
              <button
                class="px-4 py-2 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600 transition-colors"
                onclick="executeBatchDelete()"
              >
                ç¡®è®¤åˆ é™¤
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', dialogHTML);
    }

    function closeBatchDeleteConfirmDialog() {
      const dialog = document.getElementById('batchDeleteConfirmDialog');
      if (dialog) {
        dialog.remove();
      }
    }

    function executeBatchDelete() {
      // åˆ é™¤é€‰ä¸­çš„ä»»åŠ¡
      selectedTaskIds.forEach(taskId => {
        const index = tasks.findIndex(t => t.id === taskId);
        if (index !== -1) {
          tasks.splice(index, 1);
        }
      });

      // ä¿å­˜åˆ°å­˜å‚¨
      saveTasksToStorage();

      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä»»åŠ¡ï¼Œæ¸…ç©ºå½“å‰ä»»åŠ¡
      if (currentTask && selectedTaskIds.has(currentTask.id)) {
        currentTask = null;
        clearChatMessages();
      }

      // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
      renderTaskList();

      // å…³é—­å¯¹è¯æ¡†
      closeBatchDeleteConfirmDialog();

      // é€€å‡ºæ‰¹é‡åˆ é™¤æ¨¡å¼
      exitBatchDeleteMode();
    }

    // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
    function showDeleteConfirmDialog(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;

      const dialogHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="deleteConfirmDialog">
          <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4">
            <div class="p-6">
              <div class="flex items-start space-x-4">
                <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                  <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-gray-900">ç¡®è®¤åˆ é™¤ä»»åŠ¡</h3>
                  <p class="text-sm text-gray-600 mt-2">
                    ç¡®å®šè¦åˆ é™¤ä»»åŠ¡ <span class="font-medium text-gray-900">"${task.title}"</span> å—ï¼Ÿ
                  </p>
                  <p class="text-sm text-red-600 mt-2">
                    <i class="fas fa-info-circle"></i> å¯¹è¯å†å²å°†æ— æ³•æ¢å¤
                  </p>
                </div>
              </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 rounded-b-2xl flex justify-end space-x-3">
              <button
                class="px-4 py-2 text-gray-700 hover:text-gray-900 font-medium rounded-lg hover:bg-gray-200 transition-colors"
                onclick="closeDeleteConfirmDialog()"
              >
                å–æ¶ˆ
              </button>
              <button
                class="px-4 py-2 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600 transition-colors"
                onclick="confirmDeleteTask('${taskId}')"
              >
                ç¡®è®¤åˆ é™¤
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', dialogHTML);
    }

    // å…³é—­åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
    function closeDeleteConfirmDialog() {
      const dialog = document.getElementById('deleteConfirmDialog');
      if (dialog) {
        dialog.remove();
      }
    }

    // ç¡®è®¤åˆ é™¤ä»»åŠ¡
    function confirmDeleteTask(taskId) {
      closeDeleteConfirmDialog();

      tasks = tasks.filter(t => t.id !== taskId);
      saveTasksToStorage();
      renderTaskList();

      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä»»åŠ¡ï¼Œé‡ç½®å¯¹è¯é¢æ¿
      if (currentTask && currentTask.id === taskId) {
        currentTask = null;
        resetChatPanel();
      }
    }

    // é‡ç½®å¯¹è¯é¢æ¿
    function resetChatPanel() {
      document.getElementById('chatTitle').textContent = 'è€ƒè¯•åŠ©æ‰‹';
      document.getElementById('chatSubtitle').textContent = 'é€‰æ‹©ä¸€ä¸ªä»»åŠ¡å¼€å§‹å¯¹è¯';

      // æ¸…ç©ºæ¶ˆæ¯ï¼ˆä¿ç•™æ¬¢è¿æ¶ˆæ¯ï¼‰
      const container = document.getElementById('messageContainer');
      while (container.children.length > 1) {
        container.removeChild(container.lastChild);
      }

      // éšè—å‚æ•°å¡ç‰‡
      const paramsCard = document.getElementById('paramsCard');
      if (paramsCard) {
        paramsCard.classList.add('hidden');
      }
    }

    // æ›´æ–°å‚æ•°å¡ç‰‡
    function updateParamsCard() {
      if (!currentTask) return;

      const paramsCard = document.getElementById('paramsCard');
      const paramsList = document.getElementById('paramsList');
      const paramsProgress = document.getElementById('paramsProgress');
      const paramsProgressBar = document.getElementById('paramsProgressBar');

      // æ˜¾ç¤ºå¡ç‰‡
      paramsCard.classList.remove('hidden');

      // è·å–å‚æ•°å®Œæ•´åº¦
      const manager = new ConversationManager(currentTask);
      const completeness = manager.getParamsCompleteness();

      // æ›´æ–°è¿›åº¦
      paramsProgress.textContent = `${completeness.percentage}%`;
      paramsProgressBar.style.width = `${completeness.percentage}%`;

      // æ¸²æŸ“å‚æ•°åˆ—è¡¨
      const params = currentTask.params || {};
      const paramLabels = {
        'questionType': 'é¢˜å‹',
        'questionTypeName': 'é¢˜å‹åç§°',
        'count': 'æ•°é‡',
        'difficulty': 'éš¾åº¦',
        'difficultyName': 'éš¾åº¦åç§°',
        'knowledge': 'çŸ¥è¯†ç‚¹',
        'paperName': 'è¯•å·åç§°',
        'totalScore': 'æ€»åˆ†',
        'examName': 'è€ƒè¯•åç§°',
        'duration': 'æ—¶é•¿',
        'practiceName': 'ä»»åŠ¡åç§°'
      };

      paramsList.innerHTML = '';

      Object.entries(params).forEach(([key, value]) => {
        // è·³è¿‡å†…éƒ¨å­—æ®µ
        if (key.endsWith('Name') && params[key.replace('Name', '')]) return;

        const label = paramLabels[key] || key;
        const displayValue = params[key + 'Name'] || value;

        const paramItem = document.createElement('div');
        paramItem.className = 'flex items-center justify-between text-sm';
        paramItem.innerHTML = `
          <span class="text-gray-600">${label}</span>
          <span class="font-medium text-gray-900">${displayValue}</span>
        `;
        paramsList.appendChild(paramItem);
      });

      // å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œæ˜¾ç¤ºæç¤º
      if (Object.keys(params).length === 0) {
        paramsList.innerHTML = '<p class="text-sm text-gray-400 text-center py-2">æš‚æ— å‚æ•°</p>';
      }
    }

    function renderTaskList() {
      const taskList = document.getElementById('taskList');
      const emptyState = document.getElementById('emptyState');

      if (tasks.length === 0) {
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');

      // æ¸…ç©ºç°æœ‰ä»»åŠ¡ï¼ˆä¿ç•™ç©ºçŠ¶æ€å…ƒç´ ï¼‰
      Array.from(taskList.children).forEach(child => {
        if (child.id !== 'emptyState') {
          child.remove();
        }
      });

      // æ¸²æŸ“ä»»åŠ¡å¡ç‰‡
      tasks.forEach(task => {
        const card = createTaskCard(task);
        taskList.appendChild(card);
      });
    }

    function createTaskCard(task) {
      const card = document.createElement('div');
      card.className = 'task-card p-3 bg-white border border-gray-200 rounded-lg cursor-pointer relative group';
      card.dataset.taskId = task.id;

      // é«˜äº®å½“å‰ä»»åŠ¡
      if (currentTask && currentTask.id === task.id) {
        card.classList.add('border-primary-500', 'bg-primary-50');
      }

      // const statusIcon = getStatusIcon(task.status); // ä¸å†æ˜¾ç¤ºçŠ¶æ€å›¾æ ‡
      const typeInfo = getTaskTypeInfo(task.type);
      const typeIcon = typeInfo ? typeInfo.icon : 'ğŸ’¬';

      card.innerHTML = `
        <div class="flex items-start space-x-2">
          <span class="text-lg flex-shrink-0">${typeIcon}</span>
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between">
              <h4 class="text-sm font-medium text-gray-900 truncate">${task.title}</h4>
            </div>
            <p class="text-xs text-gray-500 mt-1">${task.createTime}</p>
          </div>
        </div>
        <!-- åˆ é™¤æŒ‰é’®ï¼ˆæ‚¬åœæ˜¾ç¤ºï¼‰-->
        <button
          class="absolute top-2 right-2 w-6 h-6 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center hover:bg-red-600"
          onclick="event.stopPropagation(); deleteTask('${task.id}')"
          title="åˆ é™¤ä»»åŠ¡"
        >
          <i class="fas fa-times text-xs"></i>
        </button>
      `;

      card.addEventListener('click', function() {
        loadTask(task);
      });

      return card;
    }

    // getStatusIcon å’Œ getStatusColor å·²åœ¨å‰é¢æ³¨é‡Šï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨ï¼‰

    function loadTask(task) {
      currentTask = task;
      document.getElementById('chatTitle').textContent = task.title;
      document.getElementById('chatSubtitle').textContent = `åˆ›å»ºäº ${task.createTime}`;

      // åŠ è½½å¯¹è¯å†å²
      messages = task.messages || [];
      renderMessages();

      // æ›´æ–°å‚æ•°å¡ç‰‡ï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨ï¼‰
      // updateParamsCard();
    }

    // filterTasks å‡½æ•°å·²ç§»é™¤ï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†éœ€è¦çŠ¶æ€ç­›é€‰ï¼‰

    // ========== æ¶ˆæ¯å¤„ç† ==========
    function sendMessage() {
      const input = document.getElementById('messageInput');
      const content = input.value.trim();

      if (!content) return;

      // å¦‚æœæ²¡æœ‰å½“å‰ä»»åŠ¡ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°å¯¹è¯ï¼ˆè·³è¿‡æ¬¢è¿æ¶ˆæ¯ï¼‰
      if (!currentTask) {
        createTask('conversation', true); // ç¬¬äºŒä¸ªå‚æ•°ä¸ºtrueï¼Œè·³è¿‡æ¬¢è¿æ¶ˆæ¯
      }

      // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰ä»»åŠ¡çš„ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
      const isFirstMessage = !currentTask.messages || currentTask.messages.filter(m => m.role === 'user').length === 0;

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      addUserMessage(content);
      input.value = '';
      input.style.height = 'auto';

      // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ›´æ–°ä»»åŠ¡æ ‡é¢˜
      if (isFirstMessage) {
        const newTitle = generateTaskTitle(content);
        currentTask.title = newTitle;
        saveTasksToStorage();
        renderTaskList();

        // æ›´æ–°å¯¹è¯åŒºæ ‡é¢˜
        document.getElementById('chatTitle').textContent = newTitle;
      }

      // ç«‹å³å¤„ç†AIå“åº”ï¼ˆä¸å»¶è¿Ÿï¼‰
      setTimeout(() => {
        handleAIResponse(content);
      }, 500);
    }

    function addUserMessage(content) {
      const messageDiv = createMessageElement('user', content);
      document.getElementById('messageContainer').appendChild(messageDiv);
      scrollToBottom();

      // ä¿å­˜åˆ°å†å²
      messages.push({
        role: 'user',
        content: content,
        time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
      });
    }

    function addAIMessage(content) {
      const messageDiv = createMessageElement('ai', content);
      document.getElementById('messageContainer').appendChild(messageDiv);
      scrollToBottom();

      // ä¿å­˜åˆ°å†å²
      messages.push({
        role: 'ai',
        content: content,
        time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
      });
    }

    function createMessageElement(role, content) {
      const div = document.createElement('div');
      div.className = 'flex items-start space-x-3 message-enter';

      if (role === 'ai') {
        div.innerHTML = `
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary-500 to-info-500 flex items-center justify-center flex-shrink-0">
            <i class="fas fa-robot text-white text-sm"></i>
          </div>
          <div class="flex-1">
            <div class="bg-gray-100 rounded-lg rounded-tl-none p-4">
              <p class="text-gray-800 text-sm leading-relaxed whitespace-pre-wrap">${content}</p>
            </div>
            <p class="text-xs text-gray-400 mt-1">åˆšåˆš</p>
          </div>
        `;
      } else {
        div.innerHTML = `
          <div class="flex-1"></div>
          <div class="max-w-md">
            <div class="gradient-bg text-white rounded-lg rounded-tr-none p-4">
              <p class="text-sm leading-relaxed whitespace-pre-wrap">${content}</p>
            </div>
            <p class="text-xs text-gray-400 mt-1 text-right">åˆšåˆš</p>
          </div>
          <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center flex-shrink-0">
            <i class="fas fa-user text-white text-sm"></i>
          </div>
        `;
      }

      return div;
    }

    // åˆ›å»ºé€‰é¡¹æ¶ˆæ¯ï¼ˆAIæä¾›å¤šä¸ªé€‰é¡¹ä¾›ç”¨æˆ·é€‰æ‹©ï¼‰
    function createOptionsMessage(content, options, onSelect) {
      const div = document.createElement('div');
      div.className = 'flex items-start space-x-3 message-enter';

      const optionsHTML = options.map((option, index) => `
        <button
          class="option-btn w-full text-left px-4 py-3 border-2 border-gray-200 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-all"
          data-index="${index}"
        >
          <div class="flex items-center justify-between">
            <span class="text-sm text-gray-800">${option.label}</span>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
          </div>
          ${option.description ? `<p class="text-xs text-gray-500 mt-1">${option.description}</p>` : ''}
        </button>
      `).join('');

      div.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary-500 to-info-500 flex items-center justify-center flex-shrink-0">
          <i class="fas fa-robot text-white text-sm"></i>
        </div>
        <div class="flex-1">
          <div class="bg-gray-100 rounded-lg rounded-tl-none p-4">
            <p class="text-gray-800 text-sm leading-relaxed mb-3">${content}</p>
            <div class="space-y-2">
              ${optionsHTML}
            </div>
          </div>
          <p class="text-xs text-gray-400 mt-1">åˆšåˆš</p>
        </div>
      `;

      // ç»‘å®šé€‰é¡¹ç‚¹å‡»äº‹ä»¶
      div.querySelectorAll('.option-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.dataset.index);
          onSelect(options[index], index);
        });
      });

      return div;
    }

    // åˆ›å»ºç¡®è®¤æ¶ˆæ¯ï¼ˆAIè¯·æ±‚ç”¨æˆ·ç¡®è®¤ï¼‰
    function createConfirmMessage(content, onConfirm, onCancel) {
      const div = document.createElement('div');
      div.className = 'flex items-start space-x-3 message-enter';

      div.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary-500 to-info-500 flex items-center justify-center flex-shrink-0">
          <i class="fas fa-robot text-white text-sm"></i>
        </div>
        <div class="flex-1">
          <div class="bg-gray-100 rounded-lg rounded-tl-none p-4">
            <p class="text-gray-800 text-sm leading-relaxed mb-3">${content}</p>
            <div class="flex space-x-2">
              <button class="confirm-btn flex-1 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors text-sm font-medium">
                ç¡®è®¤
              </button>
              <button class="cancel-btn flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm font-medium">
                å–æ¶ˆ
              </button>
            </div>
          </div>
          <p class="text-xs text-gray-400 mt-1">åˆšåˆš</p>
        </div>
      `;

      // ç»‘å®šæŒ‰é’®äº‹ä»¶
      div.querySelector('.confirm-btn').addEventListener('click', onConfirm);
      div.querySelector('.cancel-btn').addEventListener('click', onCancel);

      return div;
    }

    // åˆ›å»ºè¿›åº¦æ¶ˆæ¯ï¼ˆæ˜¾ç¤ºä»»åŠ¡è¿›åº¦ï¼‰
    function createProgressMessage(content, progress) {
      const div = document.createElement('div');
      div.className = 'flex items-start space-x-3 message-enter';

      const percentage = progress.total > 0 ? Math.round((progress.current / progress.total) * 100) : 0;

      div.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary-500 to-info-500 flex items-center justify-center flex-shrink-0">
          <i class="fas fa-robot text-white text-sm"></i>
        </div>
        <div class="flex-1">
          <div class="bg-gray-100 rounded-lg rounded-tl-none p-4">
            <p class="text-gray-800 text-sm leading-relaxed mb-3">${content}</p>
            <div class="space-y-2">
              <div class="flex items-center justify-between text-xs text-gray-600">
                <span>${progress.label || 'è¿›åº¦'}</span>
                <span class="font-medium">${progress.current}/${progress.total} (${percentage}%)</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-primary-500 h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
              </div>
            </div>
          </div>
          <p class="text-xs text-gray-400 mt-1">åˆšåˆš</p>
        </div>
      `;

      return div;
    }

    function renderMessages() {
      const container = document.getElementById('messageContainer');
      // æ¸…ç©ºï¼ˆä¿ç•™æ¬¢è¿æ¶ˆæ¯ï¼‰
      while (container.children.length > 1) {
        container.removeChild(container.lastChild);
      }

      messages.forEach(msg => {
        const messageDiv = createMessageElement(msg.role, msg.content);
        container.appendChild(messageDiv);
      });

      scrollToBottom();
    }

    function scrollToBottom() {
      const container = document.getElementById('messageContainer');
      container.scrollTop = container.scrollHeight;
    }

    function handleAIResponse(userMessage) {
      // ä½¿ç”¨å¯¹è¯ç®¡ç†å™¨å¤„ç†ç”¨æˆ·è¾“å…¥
      const manager = new ConversationManager(currentTask);
      const response = manager.processUserInput(userMessage);

      // æ·»åŠ AIå“åº”
      addAIMessage(response);

      // æ›´æ–°å‚æ•°å¡ç‰‡ï¼ˆChatGPTæ¨¡å¼ä¸‹ä¸å†ä½¿ç”¨ï¼‰
      // updateParamsCard();

      // ä¿å­˜å¯¹è¯å†å²
      saveTasksToStorage();
    }

    // ========== å¿«æ·æ“ä½œ ==========
    function handleQuickAction(action) {
      const actions = {
        'generate': 'æˆ‘æƒ³ç”Ÿæˆé¢˜ç›®',
        'paper': 'å¸®æˆ‘æ™ºèƒ½ç»„å·',
        'exam': 'åˆ›å»ºä¸€åœºè€ƒè¯•',
        'practice': 'åˆ›å»ºåˆ·é¢˜ä»»åŠ¡'
      };

      const message = actions[action];
      if (message) {
        document.getElementById('messageInput').value = message;
        sendMessage();
      }
    }

    // ========== ç§»åŠ¨ç«¯Tabåˆ‡æ¢ ==========
    function setupMobileTabs() {
      const tabButtons = document.querySelectorAll('.tab-btn');
      const panels = document.querySelectorAll('.panel');

      // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
      if (tabButtons.length === 0 || panels.length === 0) {
        console.warn('ç§»åŠ¨ç«¯Tabå…ƒç´ æœªæ‰¾åˆ°ï¼Œå¯èƒ½åœ¨æ¡Œé¢ç«¯è¿è¡Œ');
        return;
      }

      tabButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          const targetPanel = this.dataset.panel;
          const targetElement = document.getElementById(targetPanel);

          // æ£€æŸ¥ç›®æ ‡é¢æ¿æ˜¯å¦å­˜åœ¨
          if (!targetElement) {
            console.error(`é¢æ¿ ${targetPanel} æœªæ‰¾åˆ°`);
            return;
          }

          // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
          tabButtons.forEach(b => b.classList.remove('active'));
          panels.forEach(p => p.classList.remove('active'));

          // æ¿€æ´»å½“å‰Tabå’Œé¢æ¿
          this.classList.add('active');
          targetElement.classList.add('active');
        });
      });
    }

    // ============================================
    // SmartParamExtractor æµ‹è¯•
    // ============================================
    function testSmartParamExtractor() {
      const extractor = new SmartParamExtractor();
      const tests = [
        {
          input: 'ç”Ÿæˆ10é“å•é€‰é¢˜',
          expected: { type: 'single', count: 10 }
        },
        {
          input: 'æ¥ç‚¹æ‰€æœ‰é¢˜å‹',
          expected: { type: 'all', count: 10 }
        },
        {
          input: '5é“ä¸­ç­‰éš¾åº¦çš„åˆ¤æ–­é¢˜',
          expected: { type: 'judge', count: 5, difficulty: 2 }
        },
        {
          input: 'ç”Ÿæˆå…³äºæ•°æ®ç»“æ„çš„ç®€å•é¢˜ç›®',
          expected: { knowledgePoint: 'æ•°æ®ç»“æ„', difficulty: 1 }
        },
        {
          input: 'æ¥ç‚¹å¤šé€‰é¢˜ï¼Œå¤šä¸€äº›',
          expected: { type: 'multiple', count: 15 }
        }
      ];

      console.log('=== SmartParamExtractor æµ‹è¯•å¼€å§‹ ===');
      let passed = 0;
      let failed = 0;

      tests.forEach((test, index) => {
        const result = extractor.extract(test.input);
        let testPassed = true;

        for (const [key, value] of Object.entries(test.expected)) {
          if (result.params[key] !== value) {
            testPassed = false;
            console.error(`æµ‹è¯• ${index + 1} å¤±è´¥:`, test.input);
            console.error(`  æœŸæœ› ${key}=${value}, å®é™… ${key}=${result.params[key]}`);
          }
        }

        if (testPassed) {
          passed++;
          console.log(`âœ“ æµ‹è¯• ${index + 1} é€šè¿‡:`, test.input);
        } else {
          failed++;
        }
      });

      console.log(`=== æµ‹è¯•å®Œæˆ: ${passed} é€šè¿‡, ${failed} å¤±è´¥ ===`);
      return { passed, failed };
    }

    // ============================================
    // UserPreferenceManager è¾…åŠ©æ–¹æ³•æµ‹è¯•
    // ============================================
    function testUserPreferenceHelperMethods() {
      console.log('\n=== UserPreferenceManager è¾…åŠ©æ–¹æ³•æµ‹è¯•å¼€å§‹ ===');
      const manager = new UserPreferenceManager();
      let passed = 0;
      let failed = 0;

      // æµ‹è¯•1: isWeekend() - å‘¨æœ«æ£€æµ‹
      console.log('\n--- æµ‹è¯• isWeekend() ---');
      const weekendTests = [
        { day: 0, expected: true, name: 'å‘¨æ—¥' },
        { day: 1, expected: false, name: 'å‘¨ä¸€' },
        { day: 5, expected: false, name: 'å‘¨äº”' },
        { day: 6, expected: true, name: 'å‘¨å…­' }
      ];

      weekendTests.forEach(test => {
        const result = manager.isWeekend(test.day);
        if (result === test.expected) {
          console.log(`âœ“ ${test.name} (${test.day}): ${result}`);
          passed++;
        } else {
          console.error(`âœ— ${test.name} (${test.day}): æœŸæœ› ${test.expected}, å®é™… ${result}`);
          failed++;
        }
      });

      // æµ‹è¯•2: getTimePattern() - æ—¶é—´æ¨¡å¼è·å–
      console.log('\n--- æµ‹è¯• getTimePattern() ---');
      const timePatternTests = [
        { date: new Date('2026-02-01'), expected: 'weekend', name: 'å‘¨å…­' },
        { date: new Date('2026-02-02'), expected: 'weekend', name: 'å‘¨æ—¥' },
        { date: new Date('2026-02-03'), expected: 'weekday', name: 'å‘¨ä¸€' },
        { date: new Date('2026-02-05'), expected: 'weekday', name: 'å‘¨ä¸‰' }
      ];

      timePatternTests.forEach(test => {
        const result = manager.getTimePattern(test.date);
        if (result === test.expected) {
          console.log(`âœ“ ${test.name}: ${result}`);
          passed++;
        } else {
          console.error(`âœ— ${test.name}: æœŸæœ› ${test.expected}, å®é™… ${result}`);
          failed++;
        }
      });

      // æµ‹è¯•3: getTrendingKnowledgePoint() - çƒ­é—¨çŸ¥è¯†ç‚¹
      console.log('\n--- æµ‹è¯• getTrendingKnowledgePoint() ---');

      // 3.1 ç©ºæ•°ç»„æµ‹è¯•
      let trending = manager.getTrendingKnowledgePoint();
      if (trending === null) {
        console.log('âœ“ ç©ºæ•°ç»„è¿”å› null');
        passed++;
      } else {
        console.error(`âœ— ç©ºæ•°ç»„: æœŸæœ› null, å®é™… ${trending}`);
        failed++;
      }

      // 3.2 æ·»åŠ æ•°æ®åæµ‹è¯•
      manager.preferences.behaviorPatterns.knowledgePointFocus.recent = [
        { knowledgePoint: 'æ•°æ®ç»“æ„', timestamp: '2026-02-01T10:00:00' },
        { knowledgePoint: 'ç®—æ³•', timestamp: '2026-02-01T11:00:00' },
        { knowledgePoint: 'æ•°æ®ç»“æ„', timestamp: '2026-02-01T12:00:00' },
        { knowledgePoint: 'æ•°æ®ç»“æ„', timestamp: '2026-02-01T13:00:00' },
        { knowledgePoint: 'ç®—æ³•', timestamp: '2026-02-01T14:00:00' }
      ];

      trending = manager.getTrendingKnowledgePoint();
      if (trending === 'æ•°æ®ç»“æ„') {
        console.log('âœ“ æ­£ç¡®è¯†åˆ«æœ€é¢‘ç¹çŸ¥è¯†ç‚¹: æ•°æ®ç»“æ„');
        passed++;
      } else {
        console.error(`âœ— æœŸæœ› "æ•°æ®ç»“æ„", å®é™… "${trending}"`);
        failed++;
      }

      // æµ‹è¯•4: updateCommonCombinations() - æ›´æ–°å¸¸ç”¨ç»„åˆ
      console.log('\n--- æµ‹è¯• updateCommonCombinations() ---');

      // 4.1 æ·»åŠ æ–°ç»„åˆ
      manager.updateCommonCombinations({ type: 'single', difficulty: 2, count: 10 });
      const combinations = manager.preferences.behaviorPatterns.commonCombinations;
      if (combinations.length === 1 && combinations[0].frequency === 1) {
        console.log('âœ“ æˆåŠŸæ·»åŠ æ–°ç»„åˆ');
        passed++;
      } else {
        console.error('âœ— æ·»åŠ æ–°ç»„åˆå¤±è´¥');
        failed++;
      }

      // 4.2 å¢åŠ å·²å­˜åœ¨ç»„åˆçš„é¢‘ç‡
      manager.updateCommonCombinations({ type: 'single', difficulty: 2, count: 10 });
      if (combinations.length === 1 && combinations[0].frequency === 2) {
        console.log('âœ“ æˆåŠŸå¢åŠ ç»„åˆé¢‘ç‡');
        passed++;
      } else {
        console.error(`âœ— å¢åŠ é¢‘ç‡å¤±è´¥: æœŸæœ› frequency=2, å®é™… ${combinations[0].frequency}`);
        failed++;
      }

      // 4.3 æ·»åŠ å¤šä¸ªç»„åˆå¹¶æµ‹è¯•æ’åº
      manager.updateCommonCombinations({ type: 'multiple', difficulty: 3, count: 5 });
      manager.updateCommonCombinations({ type: 'judge', difficulty: 1, count: 20 });
      manager.updateCommonCombinations({ type: 'judge', difficulty: 1, count: 20 });
      manager.updateCommonCombinations({ type: 'judge', difficulty: 1, count: 20 });

      if (combinations[0].type === 'judge' && combinations[0].frequency === 3) {
        console.log('âœ“ ç»„åˆæŒ‰é¢‘ç‡æ­£ç¡®æ’åº');
        passed++;
      } else {
        console.error('âœ— ç»„åˆæ’åºå¤±è´¥');
        failed++;
      }

      // 4.4 æµ‹è¯•æœ€å¤šä¿ç•™5ä¸ªç»„åˆ
      manager.updateCommonCombinations({ type: 'blank', difficulty: 2, count: 8 });
      manager.updateCommonCombinations({ type: 'shortAnswer', difficulty: 4, count: 3 });
      manager.updateCommonCombinations({ type: 'cloze', difficulty: 3, count: 12 });

      if (combinations.length <= 5) {
        console.log(`âœ“ æ­£ç¡®é™åˆ¶ç»„åˆæ•°é‡: ${combinations.length} <= 5`);
        passed++;
      } else {
        console.error(`âœ— ç»„åˆæ•°é‡è¶…é™: ${combinations.length} > 5`);
        failed++;
      }

      // æµ‹è¯•5: updateBehaviorPatterns() é‡æ„éªŒè¯
      console.log('\n--- æµ‹è¯• updateBehaviorPatterns() é‡æ„ ---');

      // é‡ç½®æ•°æ®
      manager.preferences.behaviorPatterns.knowledgePointFocus.recent = [];
      manager.preferences.behaviorPatterns.commonCombinations = [];

      // è°ƒç”¨é‡æ„åçš„æ–¹æ³•
      manager.updateBehaviorPatterns({
        type: 'single',
        difficulty: 2,
        count: 10,
        knowledgePoint: 'æ“ä½œç³»ç»Ÿ',
        timestamp: new Date('2026-02-03T10:00:00') // å‘¨ä¸€
      });

      const patterns = manager.preferences.behaviorPatterns;

      // éªŒè¯æ—¶é—´æ¨¡å¼æ›´æ–°
      if (patterns.timePatterns.weekday.samples === 1) {
        console.log('âœ“ å·¥ä½œæ—¥æ ·æœ¬æ•°æ­£ç¡®æ›´æ–°');
        passed++;
      } else {
        console.error('âœ— å·¥ä½œæ—¥æ ·æœ¬æ•°æ›´æ–°å¤±è´¥');
        failed++;
      }

      // éªŒè¯çŸ¥è¯†ç‚¹è®°å½•
      if (patterns.knowledgePointFocus.recent.length === 1 &&
          patterns.knowledgePointFocus.recent[0].knowledgePoint === 'æ“ä½œç³»ç»Ÿ') {
        console.log('âœ“ çŸ¥è¯†ç‚¹æ­£ç¡®è®°å½•');
        passed++;
      } else {
        console.error('âœ— çŸ¥è¯†ç‚¹è®°å½•å¤±è´¥');
        failed++;
      }

      // éªŒè¯trendingæ›´æ–°
      if (patterns.knowledgePointFocus.trending === 'æ“ä½œç³»ç»Ÿ') {
        console.log('âœ“ trendingçŸ¥è¯†ç‚¹æ­£ç¡®æ›´æ–°');
        passed++;
      } else {
        console.error('âœ— trendingçŸ¥è¯†ç‚¹æ›´æ–°å¤±è´¥');
        failed++;
      }

      // éªŒè¯ç»„åˆæ›´æ–°
      if (patterns.commonCombinations.length === 1 &&
          patterns.commonCombinations[0].type === 'single') {
        console.log('âœ“ å¸¸ç”¨ç»„åˆæ­£ç¡®æ›´æ–°');
        passed++;
      } else {
        console.error('âœ— å¸¸ç”¨ç»„åˆæ›´æ–°å¤±è´¥');
        failed++;
      }

      // ========== æµ‹è¯•åå¥½æŸ¥è¯¢æ–¹æ³• ==========
      console.log('\n========== æµ‹è¯•åå¥½æŸ¥è¯¢æ–¹æ³• ==========');

      // æµ‹è¯•6: getLastUsedParams() - è·å–ä¸Šæ¬¡ä½¿ç”¨çš„å‚æ•°
      console.log('\n--- æµ‹è¯• getLastUsedParams() ---');

      // 6.1 æ— å†å²è®°å½•æ—¶è¿”å› null
      manager.preferences.scenarioPreferences['generate_questions'].lastParams = null;
      let lastParams = manager.getLastUsedParams();
      if (lastParams === null) {
        console.log('âœ“ æ— å†å²è®°å½•æ—¶è¿”å› null');
        passed++;
      } else {
        console.error(`âœ— æœŸæœ› null, å®é™… ${lastParams}`);
        failed++;
      }

      // 6.2 æœ‰å†å²è®°å½•æ—¶è¿”å›å‚æ•°å¯¹è±¡
      const testParams = { type: 'single', difficulty: 3, count: 15, knowledgePoint: 'æ•°æ®åº“' };
      manager.preferences.scenarioPreferences['generate_questions'].lastParams = testParams;
      lastParams = manager.getLastUsedParams();
      if (lastParams && lastParams.type === 'single' && lastParams.difficulty === 3) {
        console.log('âœ“ æ­£ç¡®è¿”å›ä¸Šæ¬¡ä½¿ç”¨çš„å‚æ•°');
        passed++;
      } else {
        console.error('âœ— è¿”å›å‚æ•°ä¸æ­£ç¡®');
        failed++;
      }

      // æµ‹è¯•7: getMostCommonType() - è·å–æœ€å¸¸ç”¨é¢˜å‹
      console.log('\n--- æµ‹è¯• getMostCommonType() ---');

      // 7.1 æ— æ•°æ®æ—¶è¿”å› null
      manager.preferences.basicPreferences.questionType = {
        'single': { count: 0, percentage: 0 },
        'multiple': { count: 0, percentage: 0 },
        'judge': { count: 0, percentage: 0 },
        'blank': { count: 0, percentage: 0 },
        'shortAnswer': { count: 0, percentage: 0 },
        'all': { count: 0, percentage: 0 }
      };
      let mostCommonType = manager.getMostCommonType();
      if (mostCommonType === null) {
        console.log('âœ“ æ— æ•°æ®æ—¶è¿”å› null');
        passed++;
      } else {
        console.error(`âœ— æœŸæœ› null, å®é™… ${mostCommonType}`);
        failed++;
      }

      // 7.2 æœ‰æ•°æ®æ—¶è¿”å›æœ€å¸¸ç”¨é¢˜å‹
      manager.preferences.basicPreferences.questionType = {
        'single': { count: 15, percentage: 50 },
        'multiple': { count: 8, percentage: 27 },
        'judge': { count: 7, percentage: 23 },
        'blank': { count: 0, percentage: 0 },
        'shortAnswer': { count: 0, percentage: 0 },
        'all': { count: 30, percentage: 100 }
      };
      mostCommonType = manager.getMostCommonType();
      if (mostCommonType === 'single') {
        console.log('âœ“ æ­£ç¡®è¿”å›æœ€å¸¸ç”¨é¢˜å‹: single');
        passed++;
      } else {
        console.error(`âœ— æœŸæœ› "single", å®é™… "${mostCommonType}"`);
        failed++;
      }

      // æµ‹è¯•8: getMostCommonDifficulty() - è·å–æœ€å¸¸ç”¨éš¾åº¦
      console.log('\n--- æµ‹è¯• getMostCommonDifficulty() ---');

      // 8.1 æ— æ•°æ®æ—¶è¿”å› null
      manager.preferences.basicPreferences.difficulty = {
        '1': { count: 0, percentage: 0 },
        '2': { count: 0, percentage: 0 },
        '3': { count: 0, percentage: 0 },
        '4': { count: 0, percentage: 0 },
        '5': { count: 0, percentage: 0 }
      };
      let mostCommonDifficulty = manager.getMostCommonDifficulty();
      if (mostCommonDifficulty === null) {
        console.log('âœ“ æ— æ•°æ®æ—¶è¿”å› null');
        passed++;
      } else {
        console.error(`âœ— æœŸæœ› null, å®é™… ${mostCommonDifficulty}`);
        failed++;
      }

      // 8.2 æœ‰æ•°æ®æ—¶è¿”å›æœ€å¸¸ç”¨éš¾åº¦
      manager.preferences.basicPreferences.difficulty = {
        '1': { count: 5, percentage: 10 },
        '2': { count: 20, percentage: 40 },
        '3': { count: 18, percentage: 36 },
        '4': { count: 7, percentage: 14 },
        '5': { count: 0, percentage: 0 }
      };
      mostCommonDifficulty = manager.getMostCommonDifficulty();
      if (mostCommonDifficulty === 2) {
        console.log('âœ“ æ­£ç¡®è¿”å›æœ€å¸¸ç”¨éš¾åº¦: 2');
        passed++;
      } else {
        console.error(`âœ— æœŸæœ› 2, å®é™… ${mostCommonDifficulty}`);
        failed++;
      }

      // æµ‹è¯•9: getAverageQuantity() - è·å–å¹³å‡é¢˜ç›®æ•°é‡
      console.log('\n--- æµ‹è¯• getAverageQuantity() ---');

      // 9.1 æ— æ•°æ®æ—¶è¿”å›é»˜è®¤å€¼ 10
      manager.preferences.basicPreferences.quantity.average = 0;
      let avgQuantity = manager.getAverageQuantity();
      if (avgQuantity === 10) {
        console.log('âœ“ æ— æ•°æ®æ—¶è¿”å›é»˜è®¤å€¼ 10');
        passed++;
      } else {
        console.error(`âœ— æœŸæœ› 10, å®é™… ${avgQuantity}`);
        failed++;
      }

      // 9.2 æœ‰æ•°æ®æ—¶è¿”å›å¹³å‡å€¼
      manager.preferences.basicPreferences.quantity.average = 15.5;
      avgQuantity = manager.getAverageQuantity();
      if (avgQuantity === 15.5) {
        console.log('âœ“ æ­£ç¡®è¿”å›å¹³å‡æ•°é‡: 15.5');
        passed++;
      } else {
        console.error(`âœ— æœŸæœ› 15.5, å®é™… ${avgQuantity}`);
        failed++;
      }

      // æµ‹è¯•10: getRecentKnowledgePoints() - è·å–æœ€è¿‘ä½¿ç”¨çš„çŸ¥è¯†ç‚¹
      console.log('\n--- æµ‹è¯• getRecentKnowledgePoints() ---');

      // 10.1 æ— æ•°æ®æ—¶è¿”å›ç©ºæ•°ç»„
      manager.preferences.behaviorPatterns.knowledgePointFocus.recent = [];
      let recentKps = manager.getRecentKnowledgePoints();
      if (Array.isArray(recentKps) && recentKps.length === 0) {
        console.log('âœ“ æ— æ•°æ®æ—¶è¿”å›ç©ºæ•°ç»„');
        passed++;
      } else {
        console.error(`âœ— æœŸæœ›ç©ºæ•°ç»„, å®é™… ${JSON.stringify(recentKps)}`);
        failed++;
      }

      // 10.2 æœ‰æ•°æ®æ—¶è¿”å›çŸ¥è¯†ç‚¹åç§°æ•°ç»„
      manager.preferences.behaviorPatterns.knowledgePointFocus.recent = [
        { knowledgePoint: 'æ•°æ®ç»“æ„', timestamp: '2026-02-01T10:00:00' },
        { knowledgePoint: 'ç®—æ³•', timestamp: '2026-02-01T11:00:00' },
        { knowledgePoint: 'æ“ä½œç³»ç»Ÿ', timestamp: '2026-02-01T12:00:00' }
      ];
      recentKps = manager.getRecentKnowledgePoints();
      if (Array.isArray(recentKps) &&
          recentKps.length === 3 &&
          recentKps[0] === 'æ•°æ®ç»“æ„' &&
          recentKps[1] === 'ç®—æ³•' &&
          recentKps[2] === 'æ“ä½œç³»ç»Ÿ') {
        console.log('âœ“ æ­£ç¡®è¿”å›çŸ¥è¯†ç‚¹åç§°æ•°ç»„');
        passed++;
      } else {
        console.error(`âœ— è¿”å›æ•°ç»„ä¸æ­£ç¡®: ${JSON.stringify(recentKps)}`);
        failed++;
      }

      // 10.3 æµ‹è¯•ç©ºå€¼å¤„ç†
      manager.preferences.behaviorPatterns.knowledgePointFocus.recent = null;
      recentKps = manager.getRecentKnowledgePoints();
      if (Array.isArray(recentKps) && recentKps.length === 0) {
        console.log('âœ“ null å€¼æ—¶è¿”å›ç©ºæ•°ç»„');
        passed++;
      } else {
        console.error(`âœ— null å€¼å¤„ç†å¤±è´¥: ${JSON.stringify(recentKps)}`);
        failed++;
      }

      // æµ‹è¯•11: getMostCommonParams() - è·å–æœ€å¸¸ç”¨å‚æ•°ç»„åˆ
      console.log('\n--- æµ‹è¯• getMostCommonParams() ---');

      // 11.1 è®¾ç½®æµ‹è¯•æ•°æ®
      manager.preferences.basicPreferences.type.distribution = {
        'single': { count: 30, percentage: 60 },
        'multiple': { count: 20, percentage: 40 }
      };
      manager.preferences.basicPreferences.difficulty.distribution = {
        '1': { count: 10, percentage: 20 },
        '2': { count: 25, percentage: 50 },
        '3': { count: 15, percentage: 30 }
      };
      manager.preferences.basicPreferences.quantity.average = 12;
      manager.preferences.behaviorPatterns.knowledgePointFocus.recent = [
        { knowledgePoint: 'æ•°æ®ç»“æ„', timestamp: '2026-02-01T10:00:00' },
        { knowledgePoint: 'ç®—æ³•', timestamp: '2026-02-01T11:00:00' }
      ];

      const mostCommonParams = manager.getMostCommonParams();
      if (mostCommonParams.type === 'single' &&
          mostCommonParams.difficulty === 2 &&
          mostCommonParams.count === 12 &&
          mostCommonParams.knowledgePoint === 'æ•°æ®ç»“æ„') {
        console.log('âœ“ æ­£ç¡®è¿”å›æœ€å¸¸ç”¨å‚æ•°ç»„åˆ');
        passed++;
      } else {
        console.error(`âœ— å‚æ•°ç»„åˆä¸æ­£ç¡®: ${JSON.stringify(mostCommonParams)}`);
        failed++;
      }

      // 11.2 æµ‹è¯•æ— çŸ¥è¯†ç‚¹æ•°æ®æ—¶
      manager.preferences.behaviorPatterns.knowledgePointFocus.recent = [];
      const paramsNoKp = manager.getMostCommonParams();
      if (paramsNoKp.knowledgePoint === null) {
        console.log('âœ“ æ— çŸ¥è¯†ç‚¹æ•°æ®æ—¶è¿”å› null');
        passed++;
      } else {
        console.error(`âœ— æœŸæœ› null, å®é™… ${paramsNoKp.knowledgePoint}`);
        failed++;
      }

      // æµ‹è¯•12: getRecommendedParams() - æ™ºèƒ½æ¨èå‚æ•°
      console.log('\n--- æµ‹è¯• getRecommendedParams() ---');

      // 12.1 æµ‹è¯• _useHistory æ ‡å¿—
      manager.preferences.history.lastUsed = {
        type: 'multiple',
        difficulty: 3,
        count: 20,
        knowledgePoint: 'æ“ä½œç³»ç»Ÿ',
        timestamp: '2026-02-01T10:00:00'
      };
      let recommended = manager.getRecommendedParams({ _useHistory: true });
      if (recommended.type === 'multiple' &&
          recommended.difficulty === 3 &&
          recommended.count === 20 &&
          recommended.knowledgePoint === 'æ“ä½œç³»ç»Ÿ' &&
          !recommended._useHistory &&
          !recommended._usePreference) {
        console.log('âœ“ _useHistory æ ‡å¿—æ­£ç¡®è¿”å›ä¸Šæ¬¡å‚æ•°ï¼ˆæ— ç‰¹æ®Šæ ‡å¿—ï¼‰');
        passed++;
      } else {
        console.error(`âœ— _useHistory è¿”å›é”™è¯¯: ${JSON.stringify(recommended)}`);
        failed++;
      }

      // 12.2 æµ‹è¯• _usePreference æ ‡å¿—
      manager.preferences.basicPreferences.type.distribution = {
        'single': { count: 50, percentage: 100 }
      };
      manager.preferences.basicPreferences.difficulty.distribution = {
        '2': { count: 50, percentage: 100 }
      };
      manager.preferences.basicPreferences.quantity.average = 15;
      manager.preferences.behaviorPatterns.knowledgePointFocus.recent = [
        { knowledgePoint: 'æ•°æ®åº“', timestamp: '2026-02-01T10:00:00' }
      ];
      recommended = manager.getRecommendedParams({ _usePreference: true });
      if (recommended.type === 'single' &&
          recommended.difficulty === 2 &&
          recommended.count === 15 &&
          recommended.knowledgePoint === 'æ•°æ®åº“' &&
          !recommended._useHistory &&
          !recommended._usePreference) {
        console.log('âœ“ _usePreference æ ‡å¿—æ­£ç¡®è¿”å›åå¥½å‚æ•°ï¼ˆæ— ç‰¹æ®Šæ ‡å¿—ï¼‰');
        passed++;
      } else {
        console.error(`âœ— _usePreference è¿”å›é”™è¯¯: ${JSON.stringify(recommended)}`);
        failed++;
      }

      // 12.3 æµ‹è¯•æ™ºèƒ½å¡«å…… - ä»…æä¾› type
      recommended = manager.getRecommendedParams({ type: 'multiple' });
      if (recommended.type === 'multiple' &&
          recommended.difficulty === 2 &&
          recommended.count === 15 &&
          recommended.knowledgePoint === 'æ•°æ®åº“') {
        console.log('âœ“ æ™ºèƒ½å¡«å……ç¼ºå¤±å‚æ•°ï¼ˆä¿ç•™ç”¨æˆ·æä¾›çš„ typeï¼‰');
        passed++;
      } else {
        console.error(`âœ— æ™ºèƒ½å¡«å……é”™è¯¯: ${JSON.stringify(recommended)}`);
        failed++;
      }

      // 12.4 æµ‹è¯•æ™ºèƒ½å¡«å…… - ä»…æä¾› difficulty
      recommended = manager.getRecommendedParams({ difficulty: 4 });
      if (recommended.type === 'single' &&
          recommended.difficulty === 4 &&
          recommended.count === 15 &&
          recommended.knowledgePoint === 'æ•°æ®åº“') {
        console.log('âœ“ æ™ºèƒ½å¡«å……ç¼ºå¤±å‚æ•°ï¼ˆä¿ç•™ç”¨æˆ·æä¾›çš„ difficultyï¼‰');
        passed++;
      } else {
        console.error(`âœ— æ™ºèƒ½å¡«å……é”™è¯¯: ${JSON.stringify(recommended)}`);
        failed++;
      }

      // 12.5 æµ‹è¯•æ™ºèƒ½å¡«å…… - æä¾›éƒ¨åˆ†å‚æ•°
      recommended = manager.getRecommendedParams({
        type: 'judge',
        count: 25
      });
      if (recommended.type === 'judge' &&
          recommended.difficulty === 2 &&
          recommended.count === 25 &&
          recommended.knowledgePoint === 'æ•°æ®åº“') {
        console.log('âœ“ æ™ºèƒ½å¡«å……ç¼ºå¤±å‚æ•°ï¼ˆä¿ç•™ç”¨æˆ·æä¾›çš„ type å’Œ countï¼‰');
        passed++;
      } else {
        console.error(`âœ— æ™ºèƒ½å¡«å……é”™è¯¯: ${JSON.stringify(recommended)}`);
        failed++;
      }

      // 12.6 æµ‹è¯•æ™ºèƒ½å¡«å…… - ç©ºå¯¹è±¡
      recommended = manager.getRecommendedParams({});
      if (recommended.type === 'single' &&
          recommended.difficulty === 2 &&
          recommended.count === 15 &&
          recommended.knowledgePoint === 'æ•°æ®åº“') {
        console.log('âœ“ ç©ºå¯¹è±¡æ—¶å®Œå…¨ä½¿ç”¨åå¥½å‚æ•°');
        passed++;
      } else {
        console.error(`âœ— ç©ºå¯¹è±¡å¤„ç†é”™è¯¯: ${JSON.stringify(recommended)}`);
        failed++;
      }

      // 12.7 æµ‹è¯•æ™ºèƒ½å¡«å…… - æ— çŸ¥è¯†ç‚¹æ•°æ®
      manager.preferences.behaviorPatterns.knowledgePointFocus.recent = [];
      recommended = manager.getRecommendedParams({ type: 'single' });
      if (recommended.type === 'single' &&
          recommended.difficulty === 2 &&
          recommended.count === 15 &&
          !recommended.knowledgePoint) {
        console.log('âœ“ æ— çŸ¥è¯†ç‚¹æ•°æ®æ—¶ä¸å¡«å…… knowledgePoint');
        passed++;
      } else {
        console.error(`âœ— æ— çŸ¥è¯†ç‚¹å¤„ç†é”™è¯¯: ${JSON.stringify(recommended)}`);
        failed++;
      }

      // 12.8 æµ‹è¯•ç‰¹æ®Šæ ‡å¿—ç§»é™¤ - æ··åˆæ ‡å¿—
      recommended = manager.getRecommendedParams({
        type: 'single',
        _useHistory: false,
        _usePreference: false
      });
      if (recommended.type === 'single' &&
          !recommended._useHistory &&
          !recommended._usePreference) {
        console.log('âœ“ æ­£ç¡®ç§»é™¤ç‰¹æ®Šæ ‡å¿—');
        passed++;
      } else {
        console.error(`âœ— ç‰¹æ®Šæ ‡å¿—æœªç§»é™¤: ${JSON.stringify(recommended)}`);
        failed++;
      }

      // 12.9 æµ‹è¯•å®Œæ•´å‚æ•°ä¸è¦†ç›–
      recommended = manager.getRecommendedParams({
        type: 'blank',
        difficulty: 5,
        count: 30,
        knowledgePoint: 'ç½‘ç»œ'
      });
      if (recommended.type === 'blank' &&
          recommended.difficulty === 5 &&
          recommended.count === 30 &&
          recommended.knowledgePoint === 'ç½‘ç»œ') {
        console.log('âœ“ å®Œæ•´å‚æ•°ä¸è¢«è¦†ç›–');
        passed++;
      } else {
        console.error(`âœ— å‚æ•°è¢«é”™è¯¯è¦†ç›–: ${JSON.stringify(recommended)}`);
        failed++;
      }

      console.log(`\n=== æµ‹è¯•å®Œæˆ: ${passed} é€šè¿‡, ${failed} å¤±è´¥ ===`);
      return { passed, failed };
    }

    // ============================================
    // Phase 2 ç»¼åˆé›†æˆæµ‹è¯•
    // ============================================
    function testPhase2Integration() {
      console.log('\n\n========================================');
      console.log('=== Phase 2 ç»¼åˆé›†æˆæµ‹è¯•å¼€å§‹ ===');
      console.log('========================================\n');

      let passed = 0;
      let failed = 0;

      // æ¸…ç©º LocalStorageï¼Œæ¨¡æ‹Ÿå…¨æ–°ç”¨æˆ·
      localStorage.removeItem('userPreferences');

      // åˆå§‹åŒ–ç³»ç»Ÿç»„ä»¶
      const extractor = new SmartParamExtractor();
      const preferenceManager = new UserPreferenceManager();
      const conversationManager = new ConversationManager();

      // ========================================
      // æµ‹è¯•åœºæ™¯ 1: é¦–æ¬¡ä½¿ç”¨æµç¨‹ï¼ˆæ— å†å²è®°å½•ï¼‰
      // ========================================
      console.log('\n========== åœºæ™¯ 1: é¦–æ¬¡ä½¿ç”¨æµç¨‹ ==========');
      console.log('ç”¨æˆ·è¾“å…¥: "ç”Ÿæˆ10é“å•é€‰é¢˜"');

      // 1.1 æå–å‚æ•°
      const result1 = extractor.extract('ç”Ÿæˆ10é“å•é€‰é¢˜');
      if (result1.params.type === 'single' && result1.params.count === 10) {
        console.log('âœ“ å‚æ•°æå–æˆåŠŸ: type=single, count=10');
        passed++;
      } else {
        console.error('âœ— å‚æ•°æå–å¤±è´¥:', result1.params);
        failed++;
      }

      // 1.2 è·å–æ¨èå‚æ•°ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼Œåº”è¯¥è¿”å›é»˜è®¤å€¼ï¼‰
      const recommended1 = preferenceManager.getRecommendedParams(result1.params);
      if (recommended1.type === 'single' &&
          recommended1.count === 10 &&
          recommended1.difficulty === 2) { // é»˜è®¤éš¾åº¦
        console.log('âœ“ é¦–æ¬¡ä½¿ç”¨è¿”å›é»˜è®¤å‚æ•°: difficulty=2');
        passed++;
      } else {
        console.error('âœ— é¦–æ¬¡ä½¿ç”¨å‚æ•°é”™è¯¯:', recommended1);
        failed++;
      }

      // 1.3 è®°å½•ç”¨æˆ·è¡Œä¸º
      preferenceManager.recordAction('generate_questions', recommended1);
      console.log('âœ“ è®°å½•é¦–æ¬¡è¡Œä¸º');
      passed++;

      // ========================================
      // æµ‹è¯•åœºæ™¯ 2: "å’Œä¸Šæ¬¡ä¸€æ ·"æµç¨‹
      // ========================================
      console.log('\n========== åœºæ™¯ 2: "å’Œä¸Šæ¬¡ä¸€æ ·"æµç¨‹ ==========');
      console.log('ç”¨æˆ·è¾“å…¥: "å’Œä¸Šæ¬¡ä¸€æ ·"');

      // 2.1 æå–å‚æ•°ï¼ˆåº”è¯¥è¯†åˆ«å‡º _useHistory æ ‡å¿—ï¼‰
      const result2 = extractor.extract('å’Œä¸Šæ¬¡ä¸€æ ·');
      if (result2.params._useHistory === true) {
        console.log('âœ“ æ­£ç¡®è¯†åˆ«"å’Œä¸Šæ¬¡ä¸€æ ·"æ ‡å¿—');
        passed++;
      } else {
        console.error('âœ— æœªè¯†åˆ«"å’Œä¸Šæ¬¡ä¸€æ ·"æ ‡å¿—:', result2.params);
        failed++;
      }

      // 2.2 è·å–æ¨èå‚æ•°ï¼ˆåº”è¯¥è¿”å›ä¸Šæ¬¡çš„å‚æ•°ï¼‰
      const recommended2 = preferenceManager.getRecommendedParams(result2.params);
      if (recommended2.type === 'single' &&
          recommended2.count === 10 &&
          recommended2.difficulty === 2) {
        console.log('âœ“ æ­£ç¡®è¿”å›ä¸Šæ¬¡å‚æ•°: type=single, count=10, difficulty=2');
        passed++;
      } else {
        console.error('âœ— è¿”å›å‚æ•°ä¸æ­£ç¡®:', recommended2);
        failed++;
      }

      // 2.3 éªŒè¯ç‰¹æ®Šæ ‡å¿—å·²ç§»é™¤
      if (!recommended2._useHistory) {
        console.log('âœ“ ç‰¹æ®Šæ ‡å¿—å·²ç§»é™¤');
        passed++;
      } else {
        console.error('âœ— ç‰¹æ®Šæ ‡å¿—æœªç§»é™¤:', recommended2);
        failed++;
      }

      // ========================================
      // æµ‹è¯•åœºæ™¯ 3: å¤šæ¬¡ä½¿ç”¨åçš„"æŒ‰ä¹ æƒ¯æ¥"æµç¨‹
      // ========================================
      console.log('\n========== åœºæ™¯ 3: "æŒ‰ä¹ æƒ¯æ¥"æµç¨‹ ==========');

      // 3.1 æ¨¡æ‹Ÿå¤šæ¬¡ä½¿ç”¨ï¼Œå»ºç«‹åå¥½
      console.log('æ¨¡æ‹Ÿç”¨æˆ·å¤šæ¬¡ä½¿ç”¨...');
      const usagePatterns = [
        { type: 'multiple', difficulty: 3, count: 15, knowledgePoint: 'æ•°æ®ç»“æ„' },
        { type: 'multiple', difficulty: 3, count: 15, knowledgePoint: 'ç®—æ³•' },
        { type: 'multiple', difficulty: 3, count: 15, knowledgePoint: 'æ•°æ®ç»“æ„' },
        { type: 'multiple', difficulty: 3, count: 20, knowledgePoint: 'æ•°æ®ç»“æ„' },
        { type: 'multiple', difficulty: 3, count: 15, knowledgePoint: 'æ“ä½œç³»ç»Ÿ' }
      ];

      usagePatterns.forEach((params, index) => {
        preferenceManager.recordAction('generate_questions', params);
        console.log(`  è®°å½•ç¬¬ ${index + 1} æ¬¡ä½¿ç”¨: ${params.type}, ${params.knowledgePoint}`);
      });
      passed++;

      // 3.2 ç”¨æˆ·è¯´"æŒ‰ä¹ æƒ¯æ¥"
      console.log('\nç”¨æˆ·è¾“å…¥: "æŒ‰ä¹ æƒ¯æ¥"');
      const result3 = extractor.extract('æŒ‰ä¹ æƒ¯æ¥');
      if (result3.params._usePreference === true) {
        console.log('âœ“ æ­£ç¡®è¯†åˆ«"æŒ‰ä¹ æƒ¯æ¥"æ ‡å¿—');
        passed++;
      } else {
        console.error('âœ— æœªè¯†åˆ«"æŒ‰ä¹ æƒ¯æ¥"æ ‡å¿—:', result3.params);
        failed++;
      }

      // 3.3 è·å–æ¨èå‚æ•°ï¼ˆåº”è¯¥è¿”å›æœ€å¸¸ç”¨çš„ç»„åˆï¼‰
      const recommended3 = preferenceManager.getRecommendedParams(result3.params);
      if (recommended3.type === 'multiple' &&
          recommended3.difficulty === 3 &&
          recommended3.knowledgePoint === 'æ•°æ®ç»“æ„') { // æœ€é¢‘ç¹çš„çŸ¥è¯†ç‚¹
        console.log('âœ“ æ­£ç¡®è¿”å›å¸¸ç”¨å‚æ•°: type=multiple, difficulty=3, knowledgePoint=æ•°æ®ç»“æ„');
        passed++;
      } else {
        console.error('âœ— è¿”å›å‚æ•°ä¸ç¬¦åˆé¢„æœŸ:', recommended3);
        failed++;
      }

      // ========================================
      // æµ‹è¯•åœºæ™¯ 4: éƒ¨åˆ†è¾“å…¥æµç¨‹
      // ========================================
      console.log('\n========== åœºæ™¯ 4: éƒ¨åˆ†è¾“å…¥æµç¨‹ ==========');
      console.log('ç”¨æˆ·è¾“å…¥: "æ¥ç‚¹ç®€å•çš„"');

      // 4.1 æå–å‚æ•°ï¼ˆåªæœ‰éš¾åº¦ï¼‰
      const result4 = extractor.extract('æ¥ç‚¹ç®€å•çš„');
      if (result4.params.difficulty === 1 && !result4.params.type) {
        console.log('âœ“ æ­£ç¡®æå–éƒ¨åˆ†å‚æ•°: difficulty=1');
        passed++;
      } else {
        console.error('âœ— å‚æ•°æå–é”™è¯¯:', result4.params);
        failed++;
      }

      // 4.2 è·å–æ¨èå‚æ•°ï¼ˆåº”è¯¥è¡¥å…¨å…¶ä»–å‚æ•°ï¼‰
      const recommended4 = preferenceManager.getRecommendedParams(result4.params);
      if (recommended4.difficulty === 1 &&
          recommended4.type === 'multiple' && // æœ€å¸¸ç”¨é¢˜å‹
          recommended4.count > 0) {
        console.log(`âœ“ æ­£ç¡®è¡¥å…¨å‚æ•°: type=${recommended4.type}, count=${recommended4.count}`);
        passed++;
      } else {
        console.error('âœ— å‚æ•°è¡¥å…¨å¤±è´¥:', recommended4);
        failed++;
      }

      // ========================================
      // æµ‹è¯•åœºæ™¯ 5: å®Œæ•´è¾“å…¥æµç¨‹
      // ========================================
      console.log('\n========== åœºæ™¯ 5: å®Œæ•´è¾“å…¥æµç¨‹ ==========');
      console.log('ç”¨æˆ·è¾“å…¥: "ç”Ÿæˆ5é“å›°éš¾çš„åˆ¤æ–­é¢˜ï¼Œå…³äºç½‘ç»œ"');

      // 5.1 æå–å‚æ•°ï¼ˆå®Œæ•´å‚æ•°ï¼‰
      const result5 = extractor.extract('ç”Ÿæˆ5é“å›°éš¾çš„åˆ¤æ–­é¢˜ï¼Œå…³äºç½‘ç»œ');
      if (result5.params.type === 'judge' &&
          result5.params.count === 5 &&
          result5.params.difficulty === 4 &&
          result5.params.knowledgePoint === 'ç½‘ç»œ') {
        console.log('âœ“ æ­£ç¡®æå–å®Œæ•´å‚æ•°');
        passed++;
      } else {
        console.error('âœ— å‚æ•°æå–é”™è¯¯:', result5.params);
        failed++;
      }

      // 5.2 è·å–æ¨èå‚æ•°ï¼ˆä¸åº”è¯¥è¦†ç›–ç”¨æˆ·è¾“å…¥ï¼‰
      const recommended5 = preferenceManager.getRecommendedParams(result5.params);
      if (recommended5.type === 'judge' &&
          recommended5.count === 5 &&
          recommended5.difficulty === 4 &&
          recommended5.knowledgePoint === 'ç½‘ç»œ') {
        console.log('âœ“ å®Œæ•´å‚æ•°æœªè¢«è¦†ç›–');
        passed++;
      } else {
        console.error('âœ— å‚æ•°è¢«é”™è¯¯è¦†ç›–:', recommended5);
        failed++;
      }

      // ========================================
      // æµ‹è¯•åœºæ™¯ 6: å­¦ä¹ éªŒè¯ï¼ˆåå¥½æ›´æ–°ï¼‰
      // ========================================
      console.log('\n========== åœºæ™¯ 6: å­¦ä¹ éªŒè¯ ==========');

      // 6.1 æ£€æŸ¥é¢˜å‹åå¥½ç»Ÿè®¡
      const typeStats = preferenceManager.preferences.basicPreferences.questionType;
      console.log('é¢˜å‹ç»Ÿè®¡:', {
        single: typeStats.single.count,
        multiple: typeStats.multiple.count,
        judge: typeStats.judge.count
      });

      if (typeStats.multiple.count === 5) { // 5æ¬¡å¤šé€‰é¢˜
        console.log('âœ“ é¢˜å‹ç»Ÿè®¡æ­£ç¡®: multiple=5');
        passed++;
      } else {
        console.error(`âœ— é¢˜å‹ç»Ÿè®¡é”™è¯¯: æœŸæœ› multiple=5, å®é™… ${typeStats.multiple.count}`);
        failed++;
      }

      // 6.2 æ£€æŸ¥éš¾åº¦åå¥½ç»Ÿè®¡
      const difficultyStats = preferenceManager.preferences.basicPreferences.difficulty;
      if (difficultyStats['3'].count === 5) { // 5æ¬¡éš¾åº¦3
        console.log('âœ“ éš¾åº¦ç»Ÿè®¡æ­£ç¡®: difficulty[3]=5');
        passed++;
      } else {
        console.error(`âœ— éš¾åº¦ç»Ÿè®¡é”™è¯¯: æœŸæœ› difficulty[3]=5, å®é™… ${difficultyStats['3'].count}`);
        failed++;
      }

      // 6.3 æ£€æŸ¥çŸ¥è¯†ç‚¹ç„¦ç‚¹
      const kpFocus = preferenceManager.preferences.behaviorPatterns.knowledgePointFocus;
      if (kpFocus.trending === 'æ•°æ®ç»“æ„') { // æœ€é¢‘ç¹çš„çŸ¥è¯†ç‚¹
        console.log('âœ“ çŸ¥è¯†ç‚¹ç„¦ç‚¹æ­£ç¡®: trending=æ•°æ®ç»“æ„');
        passed++;
      } else {
        console.error(`âœ— çŸ¥è¯†ç‚¹ç„¦ç‚¹é”™è¯¯: æœŸæœ› trending=æ•°æ®ç»“æ„, å®é™… ${kpFocus.trending}`);
        failed++;
      }

      // 6.4 æ£€æŸ¥å¸¸ç”¨ç»„åˆ
      const combinations = preferenceManager.preferences.behaviorPatterns.commonCombinations;
      const topCombination = combinations[0];
      if (topCombination && topCombination.type === 'multiple' && topCombination.difficulty === 3) {
        console.log(`âœ“ å¸¸ç”¨ç»„åˆæ­£ç¡®: type=multiple, difficulty=3, frequency=${topCombination.frequency}`);
        passed++;
      } else {
        console.error('âœ— å¸¸ç”¨ç»„åˆé”™è¯¯:', topCombination);
        failed++;
      }

      // ========================================
      // æµ‹è¯•åœºæ™¯ 7: æŒä¹…åŒ–éªŒè¯ï¼ˆLocalStorageï¼‰
      // ========================================
      console.log('\n========== åœºæ™¯ 7: æŒä¹…åŒ–éªŒè¯ ==========');

      // 7.1 ä¿å­˜å½“å‰åå¥½
      preferenceManager.savePreferences();
      console.log('âœ“ ä¿å­˜åå¥½åˆ° LocalStorage');
      passed++;

      // 7.2 åˆ›å»ºæ–°å®ä¾‹ï¼ŒéªŒè¯æ•°æ®åŠ è½½
      const newManager = new UserPreferenceManager();
      const loadedTypeStats = newManager.preferences.basicPreferences.questionType;

      if (loadedTypeStats.multiple.count === 5) {
        console.log('âœ“ æ•°æ®æŒä¹…åŒ–æˆåŠŸ: æ–°å®ä¾‹æ­£ç¡®åŠ è½½æ•°æ®');
        passed++;
      } else {
        console.error(`âœ— æ•°æ®æŒä¹…åŒ–å¤±è´¥: æœŸæœ› multiple=5, å®é™… ${loadedTypeStats.multiple.count}`);
        failed++;
      }

      // 7.3 éªŒè¯æœ€åä½¿ç”¨çš„å‚æ•°
      const loadedLastParams = newManager.getLastUsedParams();
      if (loadedLastParams && loadedLastParams.type === 'judge') {
        console.log('âœ“ æœ€åä½¿ç”¨çš„å‚æ•°æ­£ç¡®åŠ è½½');
        passed++;
      } else {
        console.error('âœ— æœ€åä½¿ç”¨çš„å‚æ•°åŠ è½½å¤±è´¥:', loadedLastParams);
        failed++;
      }

      // ========================================
      // æµ‹è¯•åœºæ™¯ 8: ConversationManager é›†æˆ
      // ========================================
      console.log('\n========== åœºæ™¯ 8: ConversationManager é›†æˆ ==========');

      // 8.1 æµ‹è¯•å¯¹è¯æµç¨‹
      const userMessage1 = 'ç”Ÿæˆ20é“å¤šé€‰é¢˜';
      console.log(`ç”¨æˆ·: ${userMessage1}`);

      // æ¨¡æ‹Ÿ ConversationManager å¤„ç†
      const extractResult = extractor.extract(userMessage1);
      const finalParams = preferenceManager.getRecommendedParams(extractResult.params);

      if (finalParams.type === 'multiple' && finalParams.count === 20) {
        console.log('âœ“ ConversationManager æ­£ç¡®å¤„ç†ç”¨æˆ·è¾“å…¥');
        passed++;
      } else {
        console.error('âœ— ConversationManager å¤„ç†å¤±è´¥:', finalParams);
        failed++;
      }

      // 8.2 è®°å½•è¡Œä¸º
      preferenceManager.recordAction('generate_questions', finalParams);
      console.log('âœ“ è¡Œä¸ºè®°å½•æˆåŠŸ');
      passed++;

      // 8.3 æµ‹è¯•"å’Œä¸Šæ¬¡ä¸€æ ·"
      const userMessage2 = 'å’Œä¸Šæ¬¡ä¸€æ ·';
      console.log(`\nç”¨æˆ·: ${userMessage2}`);

      const extractResult2 = extractor.extract(userMessage2);
      const finalParams2 = preferenceManager.getRecommendedParams(extractResult2.params);

      if (finalParams2.type === 'multiple' && finalParams2.count === 20) {
        console.log('âœ“ "å’Œä¸Šæ¬¡ä¸€æ ·"åŠŸèƒ½æ­£å¸¸å·¥ä½œ');
        passed++;
      } else {
        console.error('âœ— "å’Œä¸Šæ¬¡ä¸€æ ·"åŠŸèƒ½å¤±è´¥:', finalParams2);
        failed++;
      }

      // ========================================
      // æµ‹è¯•åœºæ™¯ 9: è¾¹ç•Œæƒ…å†µæµ‹è¯•
      // ========================================
      console.log('\n========== åœºæ™¯ 9: è¾¹ç•Œæƒ…å†µæµ‹è¯• ==========');

      // 9.1 ç©ºè¾“å…¥
      const emptyResult = extractor.extract('');
      if (Object.keys(emptyResult.params).length === 0) {
        console.log('âœ“ ç©ºè¾“å…¥å¤„ç†æ­£ç¡®');
        passed++;
      } else {
        console.error('âœ— ç©ºè¾“å…¥å¤„ç†å¤±è´¥:', emptyResult.params);
        failed++;
      }

      // 9.2 æ— æ•ˆè¾“å…¥
      const invalidResult = extractor.extract('ä»Šå¤©å¤©æ°”çœŸå¥½');
      if (Object.keys(invalidResult.params).length === 0) {
        console.log('âœ“ æ— æ•ˆè¾“å…¥å¤„ç†æ­£ç¡®');
        passed++;
      } else {
        console.error('âœ— æ— æ•ˆè¾“å…¥å¤„ç†å¤±è´¥:', invalidResult.params);
        failed++;
      }

      // 9.3 æç«¯æ•°é‡
      const extremeResult = extractor.extract('ç”Ÿæˆ1000é“é¢˜');
      if (extremeResult.params.count === 1000) {
        console.log('âœ“ æç«¯æ•°é‡æå–æ­£ç¡®');
        passed++;
      } else {
        console.error('âœ— æç«¯æ•°é‡æå–å¤±è´¥:', extremeResult.params);
        failed++;
      }

      // 9.4 æ··åˆè¾“å…¥
      const mixedResult = extractor.extract('æ¥ç‚¹ç®€å•çš„å•é€‰é¢˜ï¼Œ10é“ï¼Œå…³äºæ•°æ®åº“');
      if (mixedResult.params.type === 'single' &&
          mixedResult.params.difficulty === 1 &&
          mixedResult.params.count === 10 &&
          mixedResult.params.knowledgePoint === 'æ•°æ®åº“') {
        console.log('âœ“ æ··åˆè¾“å…¥æå–æ­£ç¡®');
        passed++;
      } else {
        console.error('âœ— æ··åˆè¾“å…¥æå–å¤±è´¥:', mixedResult.params);
        failed++;
      }

      // ========================================
      // æµ‹è¯•åœºæ™¯ 10: æ—¶é—´æ¨¡å¼åˆ†æ
      // ========================================
      console.log('\n========== åœºæ™¯ 10: æ—¶é—´æ¨¡å¼åˆ†æ ==========');

      // 10.1 æ¨¡æ‹Ÿå·¥ä½œæ—¥ä½¿ç”¨
      const weekdayDate = new Date('2026-02-03T10:00:00'); // å‘¨ä¸€
      const weekdayParams = {
        type: 'single',
        difficulty: 2,
        count: 10,
        timestamp: weekdayDate
      };
      preferenceManager.recordAction('generate_questions', weekdayParams);

      const timePatterns = preferenceManager.preferences.behaviorPatterns.timePatterns;
      if (timePatterns.weekday.samples > 0) {
        console.log(`âœ“ å·¥ä½œæ—¥æ¨¡å¼è®°å½•æˆåŠŸ: samples=${timePatterns.weekday.samples}`);
        passed++;
      } else {
        console.error('âœ— å·¥ä½œæ—¥æ¨¡å¼è®°å½•å¤±è´¥');
        failed++;
      }

      // 10.2 æ¨¡æ‹Ÿå‘¨æœ«ä½¿ç”¨
      const weekendDate = new Date('2026-02-01T14:00:00'); // å‘¨å…­
      const weekendParams = {
        type: 'shortAnswer',
        difficulty: 4,
        count: 5,
        timestamp: weekendDate
      };
      preferenceManager.recordAction('generate_questions', weekendParams);

      if (timePatterns.weekend.samples > 0) {
        console.log(`âœ“ å‘¨æœ«æ¨¡å¼è®°å½•æˆåŠŸ: samples=${timePatterns.weekend.samples}`);
        passed++;
      } else {
        console.error('âœ— å‘¨æœ«æ¨¡å¼è®°å½•å¤±è´¥');
        failed++;
      }

      // ========================================
      // æµ‹è¯•æ€»ç»“
      // ========================================
      console.log('\n========================================');
      console.log(`=== Phase 2 ç»¼åˆé›†æˆæµ‹è¯•å®Œæˆ ===`);
      console.log(`æ€»è®¡: ${passed + failed} ä¸ªæµ‹è¯•`);
      console.log(`é€šè¿‡: ${passed} ä¸ª âœ“`);
      console.log(`å¤±è´¥: ${failed} ä¸ª âœ—`);
      console.log(`æˆåŠŸç‡: ${((passed / (passed + failed)) * 100).toFixed(2)}%`);
      console.log('========================================\n');

      return { passed, failed };
    }

    // è‡ªåŠ¨è¿è¡Œæµ‹è¯•ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
    if (window.location.search.includes('test=true')) {
      window.addEventListener('DOMContentLoaded', () => {
        testSmartParamExtractor();
        testUserPreferenceHelperMethods();
        testPhase2Integration();
      });
    }
  </script>
</body>
</html>
