<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é˜…å·ç®¡ç† - è€ƒè¯•ç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#E8FFF3',
              100: '#C3F5CD',
              500: '#00B96B',
              600: '#009E5A'
            },
            success: {
              50: '#E8FFEA',
              100: '#C3F5CD',
              500: '#00B42A',
              600: '#00A35C',
              200: '#B3E5BE'
            },
            warning: {
              50: '#FFF7E8',
              100: '#FFE7BA',
              500: '#FF7D00',
              600: '#F57C00',
              200: '#FFD79D'
            },
            error: {
              50: '#FFECE8',
              100: '#FFD4CC',
              500: '#F53F3F',
              600: '#E53935',
              200: '#FFB8B0'
            },
            info: {
              50: '#E8F7FF',
              100: '#B8E8F5',
              500: '#14C9C9',
              600: '#00ACC1',
              200: '#99DDE8'
            },
            purple: {
              50: '#F3E8FF',
              100: '#E0C5FF',
              500: '#9333EA',
              600: '#7E22CE'
            }
          }
        }
      }
    }
  </script>
  <style>
    /* Message æç¤ºç»„ä»¶æ ·å¼ */
    .message-enter {
      animation: messageSlideIn 0.3s ease-out;
    }

    .message-exit {
      animation: messageSlideOut 0.3s ease-out;
    }

    @keyframes messageSlideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes messageSlideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Message æç¤ºå®¹å™¨ -->
  <div id="messageContainer" class="fixed top-20 right-4 z-[60] flex flex-col gap-2"></div>

  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="h-16 bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
    <div class="flex items-center justify-between h-full px-6">
      <div class="flex items-center space-x-4">
        <a href="../dashboard.html" class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-primary-500 rounded flex items-center justify-center">
            <i class="fas fa-graduation-cap text-white"></i>
          </div>
          <span class="text-xl font-semibold text-gray-900">è€ƒè¯•ç³»ç»Ÿ</span>
        </a>
        <nav class="flex items-center space-x-2 text-sm text-gray-600">
          <a href="../dashboard.html" class="hover:text-primary-500">é¦–é¡µ</a>
          <i class="fas fa-chevron-right text-xs text-gray-400"></i>
          <a href="list.html" class="hover:text-primary-500">è€ƒè¯•ç®¡ç†</a>
          <i class="fas fa-chevron-right text-xs text-gray-400"></i>
          <span class="text-gray-900 font-medium">é˜…å·ç®¡ç†</span>
        </nav>
      </div>
      <div class="flex items-center space-x-3">
        <img src="https://via.placeholder.com/32" alt="å¤´åƒ" class="w-8 h-8 rounded-full">
        <span class="text-sm text-gray-700">ç®¡ç†å‘˜</span>
      </div>
    </div>
  </header>

  <!-- ä¸»å†…å®¹åŒº -->
  <main class="fixed top-16 left-0 right-0 bottom-0 flex flex-col">
    <!-- å¤´éƒ¨ä¿¡æ¯åŒºåŸŸ - ç´§å‡‘è®¾è®¡ -->
    <div class="flex-none bg-white border-b border-gray-200 px-6 pt-3">
      <div class="flex items-center justify-between">
        <!-- å·¦ä¾§ï¼šè€ƒè¯•åŸºæœ¬ä¿¡æ¯ -->
        <div class="flex items-center gap-4">
          <a href="list.html" class="text-gray-500 hover:text-gray-700 transition-colors">
            <i class="fas fa-arrow-left text-lg"></i>
          </a>
          <div class="flex items-center gap-3">
            <h1 class="text-base font-semibold text-gray-900" id="examName">åŠ è½½ä¸­...</h1>
            <span class="text-xs text-gray-500">|</span>
            <span class="text-xs text-gray-600"><i class="fas fa-hashtag mr-1"></i><span id="examCode">-</span></span>
            <span class="text-xs text-gray-600"><i class="fas fa-calendar mr-1"></i><span id="examTime">-</span></span>
            <span class="text-xs text-gray-600"><i class="fas fa-clock mr-1"></i><span id="examDuration">-</span>åˆ†é’Ÿ</span>
            <span class="px-2 py-0.5 rounded text-xs font-medium" id="examStatusBadge">-</span>
          </div>
        </div>

        <!-- å³ä¾§ï¼šç»Ÿè®¡æ•°æ® -->
        <div class="flex items-center gap-6 text-xs">
          <div class="flex items-center gap-1.5">
            <span class="text-gray-500">å·²æäº¤</span>
            <span class="text-lg font-bold text-primary-600" id="submittedCount">0</span>
          </div>
          <div class="flex items-center gap-1.5">
            <span class="text-gray-500">å·²æ‰¹é˜…</span>
            <span class="text-lg font-bold text-success-600" id="gradedCount">0</span>
          </div>
          <div class="flex items-center gap-1.5">
            <span class="text-gray-500">æœªæ‰¹é˜…</span>
            <span class="text-lg font-bold text-warning-600" id="ungradedCount">0</span>
          </div>
        </div>
      </div>

      <!-- Tab åˆ‡æ¢ -->
      <div class="flex items-center gap-4 mt-3 border-t border-gray-100 pt-3">
        <button onclick="switchMainTab('graders')" id="tabGraders" class="py-3 text-sm font-medium border-b-2 border-primary-500 text-primary-600">
          é˜…å·äººå‘˜ç®¡ç†
        </button>
        <button onclick="switchMainTab('papers')" id="tabPapers" class="py-3 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900">
          è€ƒç”Ÿé˜…å·ç®¡ç†
        </button>
      </div>
    </div>

    <!-- é˜…å·äººå‘˜ç®¡ç† -->
    <div id="gradersPanel" class="flex-1 flex flex-col min-h-0">
      <!-- æ“ä½œæ  -->
      <div class="flex-none px-6 py-4 bg-white border-b border-gray-200">
        <div class="flex items-center justify-between gap-4">
          <!-- å·¦ä¾§ï¼šæœç´¢å’Œç­›é€‰ -->
          <div class="flex items-center gap-2">
            <input
              type="text"
              id="graderSearchInput"
              placeholder="æœç´¢å§“åã€å·¥å·ã€æ‰‹æœºå·..."
              class="w-64 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
              onkeyup="searchGraders()"
            >
            <button onclick="searchGraders()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium">
              <i class="fas fa-search mr-1"></i>ç­›é€‰
            </button>
            <button onclick="resetGraderSearch()" class="px-4 py-2 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg text-sm font-medium">
              <i class="fas fa-redo mr-1"></i>é‡ç½®
            </button>
          </div>

          <!-- å³ä¾§ï¼šæ“ä½œæŒ‰é’® -->
          <div class="flex items-center gap-2">
            <button onclick="addGrader()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
              <i class="fas fa-user-plus"></i>
              æ·»åŠ é˜…å·äººå‘˜
            </button>
            <button onclick="importGraders()" class="px-4 py-2 bg-info-500 hover:bg-info-600 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
              <i class="fas fa-file-import"></i>
              æ‰¹é‡å¯¼å…¥
            </button>
            <button onclick="batchDeleteGraders()" id="batchDeleteGradersBtn" disabled class="px-4 py-2 border border-error-500 text-error-500 hover:bg-error-50 rounded-lg text-sm font-medium flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fas fa-trash"></i>
              æ‰¹é‡åˆ é™¤
            </button>
          </div>
        </div>
      </div>

      <!-- é˜…å·äººå‘˜è¡¨æ ¼ -->
      <div class="flex-1 overflow-auto px-6 pb-4 min-h-0">
        <table class="w-full border-collapse bg-white rounded-lg shadow-sm">
          <thead class="bg-gray-50 sticky top-0 z-10">
            <tr>
              <th class="px-2 py-2.5 text-left whitespace-nowrap">
                <div class="flex items-center gap-1">
                  <input type="checkbox" id="selectAllGraders" onchange="toggleAllGraders()" class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
                  <div class="relative">
                    <button onclick="toggleSelectMenuGraders(event)" class="text-gray-600 hover:text-gray-900 p-1">
                      <i class="fas fa-caret-down"></i>
                    </button>
                    <div id="selectMenuGraders" class="hidden absolute left-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg py-1 z-20 whitespace-nowrap">
                      <button onclick="selectCurrentPageGraders()" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                        <i class="fas fa-file text-gray-400 w-4"></i>
                        <span>é€‰æ‹©å½“å‰é¡µ</span>
                      </button>
                      <button onclick="selectFilteredGraders()" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                        <i class="fas fa-filter text-gray-400 w-4"></i>
                        <span>é€‰æ‹©ç­›é€‰ç»“æœ</span>
                      </button>
                      <button onclick="selectAllGraders()" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                        <i class="fas fa-list text-gray-400 w-4"></i>
                        <span>é€‰æ‹©å…¨éƒ¨æ•°æ®</span>
                      </button>
                      <div class="border-t border-gray-100 my-1"></div>
                      <button onclick="clearSelectionGraders()" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                        <i class="fas fa-times text-gray-400 w-4"></i>
                        <span>å–æ¶ˆå…¨é€‰</span>
                      </button>
                    </div>
                  </div>
                </div>
              </th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å§“å</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å·¥å·</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ‰‹æœºå·</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å·²é˜…æ•°é‡</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ·»åŠ æ—¶é—´</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase w-32">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="gradersTableBody" class="divide-y divide-gray-200">
            <!-- æ•°æ®å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
          </tbody>
        </table>
      </div>

      <!-- åˆ†é¡µ -->
      <div class="flex-none bg-white border-t border-gray-200 shadow-lg" style="min-height: 60px;">
        <div class="flex items-center justify-between px-6 py-3">
          <p class="text-sm text-gray-600">
            æ˜¾ç¤º <span id="graderPageStart">1</span>-<span id="graderPageEnd">20</span> æ¡ï¼Œå…± <span id="graderTotalItems">25</span> æ¡
          </p>
          <div class="flex items-center space-x-2">
            <button onclick="graderFirstPage()" id="graderFirstBtn" class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
              &lt;&lt;
            </button>
            <button onclick="graderPrevPage()" id="graderPrevBtn" class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
              &lt; ä¸Šä¸€é¡µ
            </button>
            <div id="graderPageNumbers" class="flex items-center space-x-1">
              <!-- é¡µç æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
              <button class="w-9 h-9 rounded text-sm font-medium bg-primary-500 text-white">1</button>
              <button class="w-9 h-9 rounded text-sm font-medium border border-gray-300 text-gray-600 hover:bg-gray-50">2</button>
            </div>
            <button onclick="graderNextPage()" id="graderNextBtn" class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
              ä¸‹ä¸€é¡µ &gt;
            </button>
            <button onclick="graderLastPage()" id="graderLastBtn" class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
              &gt;&gt;
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- è€ƒç”Ÿé˜…å·ç®¡ç† -->
    <div id="papersPanel" class="flex-1 flex-col hidden min-h-0">
      <!-- å­ Tab åˆ‡æ¢ -->
      <div class="flex items-center gap-4 bg-white border-b border-gray-200 px-6">
        <button onclick="switchPaperTab('ungraded')" id="tabUngraded" class="py-3 text-sm font-medium border-b-2 border-primary-500 text-primary-600 flex items-center gap-2">
          æœªé˜…è¯•å·
          <span class="px-2 py-0.5 bg-warning-100 text-warning-700 rounded-full text-xs font-semibold" id="ungradedBadge">0</span>
        </button>
        <button onclick="switchPaperTab('graded')" id="tabGraded" class="py-3 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 flex items-center gap-2">
          å·²é˜…è¯•å·
          <span class="px-2 py-0.5 bg-success-100 text-success-700 rounded-full text-xs font-semibold" id="gradedBadge">0</span>
        </button>
      </div>

      <!-- æœªé˜…è¯•å· -->
      <div id="ungradedPanel" class="flex-1 flex flex-col min-h-0">
        <!-- ç­›é€‰æ  -->
        <div class="flex-none px-6 py-4 bg-white border-b border-gray-200">
          <div class="flex items-center gap-2">
            <input
              type="text"
              id="ungradedSearch"
              placeholder="æœç´¢ç”¨æˆ·åã€å§“å..."
              class="w-64 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
              onkeyup="filterUngraded()"
            >
            <button onclick="filterUngraded()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium">
              <i class="fas fa-search mr-1"></i>ç­›é€‰
            </button>
            <button onclick="resetUngradedFilter()" class="px-4 py-2 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg text-sm font-medium">
              <i class="fas fa-redo mr-1"></i>é‡ç½®
            </button>
          </div>
        </div>

        <!-- æœªé˜…è¯•å·è¡¨æ ¼ -->
        <div class="flex-1 overflow-x-auto px-6 pb-4 min-h-0" id="ungradedTableContainer">
          <table class="w-full min-w-max border-collapse bg-white rounded-lg shadow-sm" id="ungradedTable" style="table-layout: auto;">
            <thead class="bg-gray-50 sticky top-0 z-10">
              <tr>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 80px;">ç…§ç‰‡</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 100px;">ç”¨æˆ·å</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 80px;">å§“å</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 110px;">æ‰‹æœºå·</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 160px;">å¼€å§‹ç­”å·æ—¶é—´</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 160px;">äº¤å·æ—¶é—´</th>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 80px;">ç”¨æ—¶</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 120px;">è¯•å·åç§°</th>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase whitespace-nowrap w-32">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="ungradedTableBody" class="divide-y divide-gray-200">
              <!-- æ•°æ®å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
          </table>
          <!-- ç©ºçŠ¶æ€æç¤º -->
          <div id="ungradedEmptyState" class="hidden flex items-center justify-center h-full">
            <div class="text-center py-16">
              <i class="fas fa-calendar-times text-5xl text-gray-300 mb-4"></i>
              <p class="text-gray-500 text-lg mb-2">è€ƒè¯•å°šæœªå¼€å§‹</p>
              <p class="text-gray-400 text-sm">è€ƒç”Ÿç­”å·æ•°æ®å°†åœ¨è€ƒè¯•å¼€å§‹åæ˜¾ç¤º</p>
            </div>
          </div>
        </div>

        <!-- åˆ†é¡µ -->
        <div class="flex-none bg-white border-t border-gray-200 shadow-lg min-h-[60px]">
          <div class="flex items-center justify-between px-6 py-3">
            <p class="text-sm text-gray-600">
              æ˜¾ç¤º <span id="ungradedPageStart">1</span>-<span id="ungradedPageEnd">20</span> æ¡ï¼Œå…± <span id="ungradedTotalItems">0</span> æ¡
            </p>
            <div class="flex items-center space-x-2">
              <button onclick="ungradedFirstPage()" id="ungradedFirstBtn" class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                &lt;&lt;
              </button>
              <button onclick="ungradedPrevPage()" id="ungradedPrevBtn" class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                &lt; ä¸Šä¸€é¡µ
              </button>
              <div id="ungradedPageNumbers" class="flex items-center space-x-1">
                <!-- é¡µç æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
              </div>
              <button onclick="ungradedNextPage()" id="ungradedNextBtn" class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                ä¸‹ä¸€é¡µ &gt;
              </button>
              <button onclick="ungradedLastPage()" id="ungradedLastBtn" class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                &gt;&gt;
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- å·²é˜…è¯•å· -->
      <div id="gradedPanel" class="flex-1 flex flex-col hidden min-h-0">
        <!-- ç­›é€‰æ  -->
        <div class="flex-none px-6 py-4 bg-white border-b border-gray-200">
          <div class="flex items-center justify-between gap-4">
            <!-- å·¦ä¾§ï¼šæœç´¢å’Œç­›é€‰ -->
            <div class="flex items-center gap-2">
              <input
                type="text"
                id="gradedSearch"
                placeholder="æœç´¢ç”¨æˆ·åã€å§“å..."
                class="w-64 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
                onkeyup="filterGraded()"
              >
              <select id="graderFilter" onchange="filterGraded()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                <option value="">å…¨éƒ¨æ‰¹é˜…äºº</option>
              </select>
              <button onclick="filterGraded()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium">
                <i class="fas fa-search mr-1"></i>ç­›é€‰
              </button>
              <button onclick="resetGradedFilter()" class="px-4 py-2 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg text-sm font-medium">
                <i class="fas fa-redo mr-1"></i>é‡ç½®
              </button>
            </div>

            <!-- å³ä¾§ï¼šå¯¼å‡ºæŒ‰é’® -->
            <div class="flex items-center gap-2">
              <button onclick="exportGradedPapersPDF()" id="exportPDFBtn" disabled class="px-4 py-2 bg-error-500 hover:bg-error-600 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-file-pdf"></i>
                å¯¼å‡ºç­”å·
              </button>
            </div>
          </div>
        </div>

        <!-- å·²é˜…è¯•å·è¡¨æ ¼ -->
        <div class="flex-1 overflow-x-auto px-6 pb-4 min-h-0" id="gradedTableContainer">
          <table class="w-full min-w-max border-collapse bg-white rounded-lg shadow-sm" id="gradedTable" style="table-layout: auto;">
            <thead class="bg-gray-50 sticky top-0 z-10">
              <tr>
                <th class="px-2 py-2.5 text-left whitespace-nowrap">
                  <div class="flex items-center gap-1">
                    <input type="checkbox" id="selectAllGradedPapers" onchange="toggleAllGradedPapers()" class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
                    <div class="relative">
                      <button onclick="toggleSelectMenuGraded(event)" class="text-gray-600 hover:text-gray-900 p-1">
                        <i class="fas fa-caret-down"></i>
                      </button>
                      <div id="selectMenuGraded" class="hidden absolute left-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg py-1 z-20 whitespace-nowrap">
                        <button onclick="selectCurrentPageGraded()" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                          <i class="fas fa-file text-gray-400 w-4"></i>
                          <span>é€‰æ‹©å½“å‰é¡µ</span>
                        </button>
                        <button onclick="selectFilteredGraded()" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                          <i class="fas fa-filter text-gray-400 w-4"></i>
                          <span>é€‰æ‹©ç­›é€‰ç»“æœ</span>
                        </button>
                        <button onclick="selectAllGraded()" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                          <i class="fas fa-list text-gray-400 w-4"></i>
                          <span>é€‰æ‹©å…¨éƒ¨æ•°æ®</span>
                        </button>
                        <div class="border-t border-gray-100 my-1"></div>
                        <button onclick="clearSelectionGraded()" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                          <i class="fas fa-times text-gray-400 w-4"></i>
                          <span>å–æ¶ˆå…¨é€‰</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </th>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 80px;">ç…§ç‰‡</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 100px;">ç”¨æˆ·å</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 80px;">å§“å</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 110px;">æ‰‹æœºå·</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 160px;">å¼€å§‹ç­”å·æ—¶é—´</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 160px;">äº¤å·æ—¶é—´</th>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 80px;">ç”¨æ—¶</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 120px;">è¯•å·åç§°</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 80px;">æ‰¹é˜…äºº</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 160px;">æ‰¹é˜…æ—¶é—´</th>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 80px;">åˆ†æ•°</th>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase whitespace-nowrap w-32">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="gradedTableBody" class="divide-y divide-gray-200">
              <!-- æ•°æ®å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
          </table>
          <!-- ç©ºçŠ¶æ€æç¤º -->
          <div id="gradedEmptyState" class="hidden flex items-center justify-center h-full">
            <div class="text-center py-16">
              <i class="fas fa-calendar-times text-5xl text-gray-300 mb-4"></i>
              <p class="text-gray-500 text-lg mb-2">è€ƒè¯•å°šæœªå¼€å§‹</p>
              <p class="text-gray-400 text-sm">è€ƒç”Ÿç­”å·æ•°æ®å°†åœ¨è€ƒè¯•å¼€å§‹åæ˜¾ç¤º</p>
            </div>
          </div>
        </div>

        <!-- åˆ†é¡µ -->
        <div class="flex-none bg-white border-t border-gray-200 shadow-lg min-h-[60px]">
          <div class="flex items-center justify-between px-6 py-3">
            <p class="text-sm text-gray-600">
              æ˜¾ç¤º <span id="gradedPageStart">1</span>-<span id="gradedPageEnd">20</span> æ¡ï¼Œå…± <span id="gradedTotalItems">0</span> æ¡
            </p>
            <div class="flex items-center space-x-2">
              <button onclick="gradedFirstPage()" id="gradedFirstBtn" class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                &lt;&lt;
              </button>
              <button onclick="gradedPrevPage()" id="gradedPrevBtn" class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                &lt; ä¸Šä¸€é¡µ
              </button>
              <div id="gradedPageNumbers" class="flex items-center space-x-1">
                <!-- é¡µç æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
              </div>
              <button onclick="gradedNextPage()" id="gradedNextBtn" class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                ä¸‹ä¸€é¡µ &gt;
              </button>
              <button onclick="gradedLastPage()" id="gradedLastBtn" class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                &gt;&gt;
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- æ·»åŠ /ç¼–è¾‘é˜…å·äººå‘˜å¼¹çª— -->
  <div id="graderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900" id="graderModalTitle">æ·»åŠ é˜…å·äººå‘˜</h3>
        <button onclick="closeGraderModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="px-6 py-4 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">å§“å <span class="text-error-500">*</span></label>
          <input type="text" id="graderName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="è¯·è¾“å…¥å§“å">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">å·¥å· <span class="text-error-500">*</span></label>
          <input type="text" id="graderJobNum" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="è¯·è¾“å…¥å·¥å·">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">æ‰‹æœºå·</label>
          <input type="text" id="graderPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ï¼ˆé€‰å¡«ï¼‰">
        </div>
      </div>
      <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200">
        <button onclick="closeGraderModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
          å–æ¶ˆ
        </button>
        <button onclick="saveGrader()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg">
          ç¡®å®š
        </button>
      </div>
    </div>
  </div>

  <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
  <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">ç¡®è®¤åˆ é™¤</h3>
        <button onclick="closeDeleteModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="px-6 py-4">
        <p class="text-gray-700" id="deleteMessage">ç¡®å®šè¦åˆ é™¤è¯¥é˜…å·äººå‘˜å—ï¼Ÿ</p>
      </div>
      <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200">
        <button onclick="closeDeleteModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
          å–æ¶ˆ
        </button>
        <button onclick="confirmDelete()" class="px-4 py-2 bg-error-500 hover:bg-error-600 text-white rounded-lg">
          ç¡®å®šåˆ é™¤
        </button>
      </div>
    </div>
  </div>

  <!-- æ‰¹é‡å¯¼å…¥å¼¹çª— -->
  <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl mx-4 max-h-[90vh] flex flex-col">
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">æ‰¹é‡å¯¼å…¥é˜…å·äººå‘˜</h3>
        <button onclick="closeImportModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="flex-1 overflow-auto px-6 py-4">
        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="mb-4">
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary-500 transition-colors">
            <input type="file" id="importFile" accept=".xlsx,.xls" class="hidden" onchange="handleFileSelect(event)">
            <label for="importFile" class="cursor-pointer">
              <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
              <p class="text-sm text-gray-600">ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
              <p class="text-xs text-gray-400 mt-1">æ”¯æŒ .xlsxã€.xls æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 5MB</p>
            </label>
          </div>
        </div>

        <!-- è¯´æ˜ä¿¡æ¯ -->
        <div class="bg-info-50 border border-info-200 rounded-lg p-4 mb-4">
          <div class="flex items-start">
            <i class="fas fa-info-circle text-info-500 mt-0.5 mr-2"></i>
            <div class="flex-1 text-sm text-info-700">
              <p class="font-medium mb-1">å¯¼å…¥è¯´æ˜ï¼š</p>
              <ul class="list-disc list-inside space-y-1 text-xs">
                <li>Excel è¡¨æ ¼éœ€åŒ…å«ï¼š<strong>å§“å</strong>ï¼ˆå¿…å¡«ï¼‰ã€<strong>å·¥å·</strong>ï¼ˆå¿…å¡«ï¼‰ã€æ‰‹æœºå·ï¼ˆé€‰å¡«ï¼‰</li>
                <li>ç¬¬ä¸€è¡Œä¸ºè¡¨å¤´ï¼Œä»ç¬¬äºŒè¡Œå¼€å§‹ä¸ºæ•°æ®</li>
                <li>æ‰‹æœºå·æ ¼å¼ï¼š1 å¼€å¤´çš„ 11 ä½æ•°å­—ï¼ˆå¡«å†™æ—¶ä¼šéªŒè¯æ ¼å¼ï¼‰</li>
                <li>å·¥å·é‡å¤çš„æ•°æ®å°†è¢«è·³è¿‡</li>
              </ul>
              <button onclick="downloadTemplate()" class="mt-2 text-info-600 hover:text-info-700 font-medium flex items-center gap-1">
                <i class="fas fa-download"></i>
                ä¸‹è½½å¯¼å…¥æ¨¡æ¿
              </button>
            </div>
          </div>
        </div>

        <!-- å·²é€‰æ–‡ä»¶ -->
        <div id="selectedFileInfo" class="hidden mb-4">
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div class="flex items-center gap-2">
              <i class="fas fa-file-excel text-success-500"></i>
              <span class="text-sm text-gray-700" id="fileName"></span>
              <span class="text-xs text-gray-500" id="fileSize"></span>
            </div>
            <button onclick="clearFile()" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- æ•°æ®é¢„è§ˆ -->
        <div id="previewSection" class="hidden">
          <div class="flex items-center justify-between mb-3">
            <h4 class="text-sm font-medium text-gray-900">æ•°æ®é¢„è§ˆ</h4>
            <span class="text-xs text-gray-500">
              å…± <span id="previewTotal" class="font-semibold text-primary-600">0</span> æ¡ï¼Œ
              æœ‰æ•ˆ <span id="previewValid" class="font-semibold text-success-600">0</span> æ¡ï¼Œ
              æ— æ•ˆ <span id="previewInvalid" class="font-semibold text-error-600">0</span> æ¡
            </span>
          </div>
          <div class="border border-gray-200 rounded-lg overflow-hidden max-h-64 overflow-y-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 sticky top-0">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">è¡Œå·</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">å§“å</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">å·¥å·</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">æ‰‹æœºå·</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">çŠ¶æ€</th>
                </tr>
              </thead>
              <tbody id="previewTableBody" class="divide-y divide-gray-200">
                <!-- æ•°æ®å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200">
        <button onclick="closeImportModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
          å–æ¶ˆ
        </button>
        <button id="confirmImportBtn" onclick="confirmImport()" disabled class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
          ç¡®è®¤å¯¼å…¥
        </button>
      </div>
    </div>
  </div>

  <!-- æŸ¥çœ‹è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div id="paperDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
      <!-- æ¨¡æ€æ¡†å¤´éƒ¨ -->
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-primary-50 to-white">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-primary-500 rounded-lg flex items-center justify-center">
            <i class="fas fa-file-alt text-white text-lg"></i>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-900">è¯•å·è¯¦æƒ…</h3>
            <p class="text-xs text-gray-500" id="paperDetailSubtitle">æŸ¥çœ‹è€ƒç”Ÿç­”å·è¯¦ç»†ä¿¡æ¯</p>
          </div>
        </div>
        <button onclick="closePaperDetailModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <!-- æ¨¡æ€æ¡†å†…å®¹ -->
      <div class="flex-1 overflow-y-auto p-6">
        <div class="space-y-6">
          <!-- è€ƒç”Ÿä¿¡æ¯ -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
              <i class="fas fa-user text-primary-500"></i>
              è€ƒç”Ÿä¿¡æ¯
            </h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div class="flex items-center gap-2">
                <span class="text-gray-500">å§“åï¼š</span>
                <span class="font-medium text-gray-900" id="detailStudentName">-</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-gray-500">ç”¨æˆ·åï¼š</span>
                <span class="font-medium text-gray-900" id="detailUsername">-</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-gray-500">æ‰‹æœºå·ï¼š</span>
                <span class="font-medium text-gray-900" id="detailPhone">-</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-gray-500">çŠ¶æ€ï¼š</span>
                <span class="font-medium" id="detailStatus">-</span>
              </div>
            </div>
          </div>

          <!-- è¯•å·ä¿¡æ¯ -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
              <i class="fas fa-file-alt text-primary-500"></i>
              è¯•å·ä¿¡æ¯
            </h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div class="flex items-center gap-2">
                <span class="text-gray-500">è¯•å·åç§°ï¼š</span>
                <span class="font-medium text-gray-900" id="detailPaperName">-</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-gray-500">å¼€å§‹ç­”å·ï¼š</span>
                <span class="font-medium text-gray-900" id="detailStartTime">-</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-gray-500">äº¤å·æ—¶é—´ï¼š</span>
                <span class="font-medium text-gray-900" id="detailSubmitTime">-</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-gray-500">ç­”å·ç”¨æ—¶ï¼š</span>
                <span class="font-medium text-gray-900" id="detailDuration">-</span>
              </div>
            </div>
          </div>

          <!-- æ‰¹é˜…ä¿¡æ¯ -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
              <i class="fas fa-check-circle text-success-500"></i>
              æ‰¹é˜…ä¿¡æ¯
            </h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div class="flex items-center gap-2">
                <span class="text-gray-500">æ‰¹é˜…äººï¼š</span>
                <span class="font-medium text-gray-900" id="detailGrader">-</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-gray-500">æ‰¹é˜…æ—¶é—´ï¼š</span>
                <span class="font-medium text-gray-900" id="detailGradeTime">-</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-gray-500">å¾—åˆ†ï¼š</span>
                <span class="font-semibold text-lg" id="detailScore">-</span>
              </div>
            </div>
          </div>

          <!-- ç›‘æ§ä¿¡æ¯ -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
              <i class="fas fa-video text-info-500"></i>
              ç›‘æ§ä¿¡æ¯
            </h4>
            <div class="grid grid-cols-3 gap-4 text-sm">
              <div class="flex items-center gap-2">
                <span class="text-gray-500">ç¦»å¼€æ¬¡æ•°ï¼š</span>
                <span class="font-medium text-gray-900" id="detailLeaveCount">-</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-gray-500">äººè„¸è¯†åˆ«ç‡ï¼š</span>
                <span class="font-medium text-gray-900" id="detailFaceRecognition">-</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-gray-500">æŠ“æ‹æ¬¡æ•°ï¼š</span>
                <span class="font-medium text-gray-900" id="detailCaptures">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- æ¨¡æ€æ¡†åº•éƒ¨ -->
      <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
        <button onclick="closePaperDetailModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">
          å…³é—­
        </button>
        <button onclick="reGradePaper()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
          <i class="fas fa-edit"></i>
          é‡æ–°æ‰¹é˜…
        </button>
      </div>
    </div>
  </div>

  <script>
    // è·å–è€ƒè¯•ID
    const urlParams = new URLSearchParams(window.location.search);
    const examId = urlParams.get('examId');

    // æ•°æ®å­˜å‚¨
    let currentExam = null;
    let currentPaper = null; // å½“å‰è¯•å·ä¿¡æ¯
    let graders = [];
    let students = [];
    let selectedGraders = new Set();
    let selectedGradedPapers = []; // å·²é˜…è¯•å·é€‰ä¸­çš„è€ƒç”Ÿ
    let currentGraderId = null;
    let deleteCallback = null;

    // åˆ†é¡µç›¸å…³
    const graderPageSize = 20;
    let graderCurrentPage = 1;
    let graderFilteredData = [];

    const ungradedPageSize = 20;
    let ungradedCurrentPage = 1;
    let ungradedFilteredData = [];

    const gradedPageSize = 20;
    let gradedCurrentPage = 1;
    let gradedFilteredData = [];

    // å½“å‰æ¿€æ´»çš„ tab
    let activeMainTab = 'graders';
    let activePaperTab = 'ungraded';

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      loadExamData();
      loadPaperData();
      loadGradersData();
      // å»¶è¿ŸåŠ è½½å­¦ç”Ÿæ•°æ®ï¼Œç¡®ä¿å…¶ä»–æ•°æ®å·²åŠ è½½
      setTimeout(() => {
        loadStudentsData();
        renderAll();
      }, 100);

      // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
      document.addEventListener('click', function(e) {
        // å…³é—­é˜…å·äººå‘˜èœå•
        const selectMenuGraders = document.getElementById('selectMenuGraders');
        if (selectMenuGraders && !selectMenuGraders.classList.contains('hidden')) {
          const isClickInsideMenu = selectMenuGraders.contains(e.target);
          const isClickOnToggle = e.target.closest('button[onclick*="toggleSelectMenuGraders"]');
          if (!isClickInsideMenu && !isClickOnToggle) {
            selectMenuGraders.classList.add('hidden');
          }
        }

        // å…³é—­å·²é˜…è¯•å·èœå•
        const selectMenuGraded = document.getElementById('selectMenuGraded');
        if (selectMenuGraded && !selectMenuGraded.classList.contains('hidden')) {
          const isClickInsideMenu = selectMenuGraded.contains(e.target);
          const isClickOnToggle = e.target.closest('button[onclick*="toggleSelectMenuGraded"]');
          if (!isClickInsideMenu && !isClickOnToggle) {
            selectMenuGraded.classList.add('hidden');
          }
        }
      });
    });

    // åŠ è½½è€ƒè¯•æ•°æ®
    function loadExamData() {
      const exams = JSON.parse(localStorage.getItem('exams') || '[]');
      currentExam = exams.find(e => e.id === examId);

      if (currentExam) {
        document.getElementById('examName').textContent = currentExam.name;
        document.getElementById('examCode').textContent = currentExam.code;

        // è€ƒè¯•æ—¶é—´
        const examTime = `${currentExam.openStartTime} ~ ${currentExam.openEndTime}`;
        document.getElementById('examTime').textContent = examTime;

        // è€ƒè¯•æ—¶é•¿
        document.getElementById('examDuration').textContent = currentExam.duration || '-';

        // è€ƒè¯•çŠ¶æ€
        const now = new Date();
        const startTime = new Date(currentExam.openStartTime);
        const endTime = new Date(currentExam.openEndTime);
        let status = '';
        let statusClass = '';
        let examStatus = ''; // ä¿å­˜è€ƒè¯•çŠ¶æ€ç”¨äºåç»­åˆ¤æ–­

        if (now < startTime) {
          status = 'æœªå¼€å§‹';
          statusClass = 'bg-gray-100 text-gray-600';
          examStatus = 'not_started';
        } else if (now >= startTime && now <= endTime) {
          status = 'è¿›è¡Œä¸­';
          statusClass = 'bg-success-100 text-success-600';
          examStatus = 'ongoing';
        } else {
          status = 'å·²ç»“æŸ';
          statusClass = 'bg-gray-200 text-gray-700';
          examStatus = 'finished';
        }

        currentExam.examStatus = examStatus; // ä¿å­˜åˆ°currentExamå¯¹è±¡

        const statusBadge = document.getElementById('examStatusBadge');
        statusBadge.textContent = status;
        statusBadge.className = `px-2 py-0.5 rounded text-xs font-medium ${statusClass}`;
      }
    }

    // åŠ è½½é˜…å·äººå‘˜æ•°æ®
    function loadGradersData() {
      const storageKey = `exam_${examId}_graders`;
      const versionKey = `exam_${examId}_graders_version`;
      const currentVersion = '2.0'; // ç‰ˆæœ¬å·ï¼Œä¿®æ”¹æ­¤å€¼å¼ºåˆ¶æ›´æ–°æ•°æ®

      const storedData = localStorage.getItem(storageKey);
      const storedVersion = localStorage.getItem(versionKey);

      // æ£€æŸ¥ç‰ˆæœ¬
      if (storedData && storedVersion === currentVersion) {
        graders = JSON.parse(storedData);
      } else {
        // ç‰ˆæœ¬ä¸åŒ¹é…æˆ–æ— æ•°æ®ï¼Œç”Ÿæˆæ–°æ•°æ®
        graders = generateMockGraders();
        localStorage.setItem(storageKey, JSON.stringify(graders));
        localStorage.setItem(versionKey, currentVersion);
      }

      // æŒ‰æ·»åŠ æ—¶é—´å€’åºæ’åˆ—
      graders.sort((a, b) => {
        return new Date(b.addTime) - new Date(a.addTime);
      });

      console.log('åŠ è½½çš„é˜…å·äººå‘˜æ•°é‡:', graders.length);
    }

    // ç”Ÿæˆæ¨¡æ‹Ÿé˜…å·äººå‘˜æ•°æ®
    function generateMockGraders() {
      const names = [
        'ç‹è€å¸ˆ', 'æè€å¸ˆ', 'å¼ è€å¸ˆ', 'åˆ˜è€å¸ˆ', 'é™ˆè€å¸ˆ',
        'æ¨è€å¸ˆ', 'é»„è€å¸ˆ', 'èµµè€å¸ˆ', 'å‘¨è€å¸ˆ', 'å´è€å¸ˆ',
        'å¾è€å¸ˆ', 'å­™è€å¸ˆ', 'é©¬è€å¸ˆ', 'æœ±è€å¸ˆ', 'èƒ¡è€å¸ˆ',
        'éƒ­è€å¸ˆ', 'æ—è€å¸ˆ', 'ä½•è€å¸ˆ', 'é«˜è€å¸ˆ', 'æ¢è€å¸ˆ',
        'éƒ‘è€å¸ˆ', 'ç½—è€å¸ˆ', 'å®‹è€å¸ˆ', 'è°¢è€å¸ˆ', 'å”è€å¸ˆ'
      ];
      const mockGraders = [];

      for (let i = 0; i < 25; i++) {
        mockGraders.push({
          id: `GR${String(i + 1).padStart(3, '0')}`,
          name: names[i],
          jobNum: `T202600${String(i + 1).padStart(2, '0')}`,
          phone: `138${String(Math.floor(Math.random() * 100000000)).padStart(8, '0')}`,
          gradedCount: Math.floor(Math.random() * 20),
          addTime: `2026-01-${String(20 + Math.floor(Math.random() * 9)).padStart(2, '0')} ${String(8 + Math.floor(Math.random() * 12)).padStart(2, '0')}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}`
        });
      }

      return mockGraders;
    }

    // åŠ è½½å­¦ç”Ÿæ•°æ®
    function loadStudentsData() {
      // ğŸ”¥ ç¬¬ä¸€æ­¥ï¼šå½»åº•æ¸…é™¤æ‰€æœ‰æ—§æ•°æ®
      console.log('[é˜…å·ç®¡ç†] ğŸ—‘ï¸  æ­£åœ¨å½»åº•æ¸…é™¤æ‰€æœ‰æ—§æ•°æ®...');
      localStorage.removeItem('examStudents');
      console.log('[é˜…å·ç®¡ç†] âœ… æ—§æ•°æ®å·²å½»åº•æ¸…é™¤');

      // ğŸ”¥ ç¬¬äºŒæ­¥ï¼šç”Ÿæˆ100æ¡æ–°çš„æ¨¡æ‹Ÿæ•°æ®
      console.log('[é˜…å·ç®¡ç†] ğŸ”„ æ­£åœ¨ç”Ÿæˆ100æ¡æ¨¡æ‹Ÿè€ƒç”Ÿæ•°æ®...');
      const newStudents = generateMockStudents();
      console.log('[é˜…å·ç®¡ç†] âœ… å·²ç”Ÿæˆ100æ¡æ¨¡æ‹Ÿæ•°æ®');

      // ğŸ”¥ ç¬¬ä¸‰æ­¥ï¼šä¿å­˜åˆ°localStorageï¼ˆæ–°æ ¼å¼ï¼šå¯¹è±¡ï¼‰
      const allStudentsData = {};
      allStudentsData[examId] = newStudents;
      localStorage.setItem('examStudents', JSON.stringify(allStudentsData));
      console.log('[é˜…å·ç®¡ç†] âœ… æ•°æ®å·²ä¿å­˜åˆ°localStorage');
      console.log('[é˜…å·ç®¡ç†] ğŸ“Š å½“å‰è€ƒè¯•ID:', examId);
      console.log('[é˜…å·ç®¡ç†] ğŸ“Š è€ƒç”Ÿæ€»æ•°:', newStudents.length);

      // ğŸ”¥ ç¬¬å››æ­¥ï¼šè¿‡æ»¤å‡ºå·²æäº¤çš„å­¦ç”Ÿï¼ˆç”¨äºé˜…å·ç®¡ç†ï¼‰
      students = newStudents.filter(s =>
        s.status === 'not_graded' ||
        s.status === 'graded' ||
        s.status === 'absent' ||
        s.status === 'violation' ||
        s.status === 'cheating' ||
        s.status === 'suspected_cheating'
      );

      // ä¸ºæ¯ä¸ªå­¦ç”Ÿæ·»åŠ è¯•å·ä¿¡æ¯å’Œæ—¶é—´ä¿¡æ¯
      students.forEach(student => {
        // è¯•å·åç§°ï¼ˆä» currentPaper è·å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨è€ƒè¯•åç§°ï¼‰
        student.paperName = currentPaper ? currentPaper.name : (currentExam ? currentExam.name + 'è¯•å·' : 'è¯•å·');

        // ç­”å·æ—¶é—´ï¼ˆå¼€å§‹ç­”é¢˜æ—¶é—´ï¼‰- å¦‚æœæœ‰ answerTime åˆ™ä½¿ç”¨ï¼Œå¦åˆ™æ ¹æ®äº¤å·æ—¶é—´å€’æ¨
        if (!student.startTime && student.answerTime) {
          // æ ¹æ®äº¤å·æ—¶é—´å’Œç”¨æ—¶å€’æ¨ç­”å·æ—¶é—´
          if (student.duration) {
            // ä» "60åˆ†é’Ÿ" æ ¼å¼ä¸­æå–æ•°å­—
            const durationMatch = student.duration.match(/\d+/);
            const durationMinutes = durationMatch ? parseInt(durationMatch[0]) : 0;

            if (durationMinutes > 0) {
              const submitDate = new Date(student.answerTime);
              submitDate.setMinutes(submitDate.getMinutes() - durationMinutes);
              student.startTime = submitDate.toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-');
            } else {
              student.startTime = student.answerTime;
            }
          } else {
            student.startTime = student.answerTime;
          }
        }

        // äº¤å·æ—¶é—´ = answerTimeï¼ˆæäº¤æ—¶é—´ï¼‰
        student.submitTime = student.answerTime || '';

        // ä¸ºå·²æ‰¹é˜…çš„å­¦ç”Ÿæ·»åŠ æ‰¹é˜…ä¿¡æ¯ï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼‰
        if (student.status === 'graded' && !student.gradeTime) {
          // æ¨¡æ‹Ÿæ‰¹é˜…äººåˆ—è¡¨
          const graders = ['å¼ è€å¸ˆ', 'æè€å¸ˆ', 'ç‹è€å¸ˆ', 'åˆ˜è€å¸ˆ', 'é™ˆè€å¸ˆ'];
          const randomGrader = graders[Math.floor(Math.random() * graders.length)];

          student.graderName = randomGrader;
          student.graderId = 'TEACHER_' + Math.floor(Math.random() * 1000);

          // æ‰¹é˜…æ—¶é—´ = äº¤å·æ—¶é—´ + 10-60åˆ†é’Ÿ
          if (student.submitTime) {
            const submitDate = new Date(student.submitTime);
            const gradeDelay = Math.floor(Math.random() * 50) + 10; // 10-60åˆ†é’Ÿ
            submitDate.setMinutes(submitDate.getMinutes() + gradeDelay);
            student.gradeTime = submitDate.toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-');
          } else {
            student.gradeTime = new Date().toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-');
          }

          // ç¡®ä¿æœ‰åˆ†æ•°
          if (!student.score && !student.highestScore) {
            student.score = 60 + Math.floor(Math.random() * 40); // 60-100åˆ†
            student.highestScore = String(student.score);
          }
        }

        // å¯¹äºå¼‚å¸¸çŠ¶æ€çš„å­¦ç”Ÿï¼Œç¡®ä¿å¾—åˆ†ä¸º0
        if (student.status === 'absent' || student.status === 'violation' ||
            student.status === 'cheating' || student.status === 'suspected_cheating') {
          student.score = 0;
          student.highestScore = '0';

          // å¦‚æœè¿˜æ²¡æœ‰æ‰¹é˜…ä¿¡æ¯ï¼Œè‡ªåŠ¨æ·»åŠ ç³»ç»Ÿæ‰¹é˜…ä¿¡æ¯
          if (!student.gradeTime) {
            student.graderId = 'SYSTEM';
            student.graderName = 'ç³»ç»Ÿ';
            student.gradeTime = student.submitTime || new Date().toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-');
          }
        }
      });

      console.log('åŠ è½½çš„ç­”å·æ•°é‡:', students.length);
      console.log('æœªæ‰¹é˜…æ•°é‡:', students.filter(s => s.status === 'not_graded').length);
      console.log('å·²æ‰¹é˜…æ•°é‡:', students.filter(s => s.status === 'graded').length);
      console.log('å¼‚å¸¸çŠ¶æ€æ•°é‡:', students.filter(s => ['absent', 'violation', 'cheating', 'suspected_cheating'].includes(s.status)).length);
    }

    // ğŸ”¥ ç”Ÿæˆ100æ¡æ¨¡æ‹Ÿè€ƒç”Ÿæ•°æ®
    function generateMockStudents() {
      const mockData = [];
      const surnames = ['å¼ ', 'æ', 'ç‹', 'åˆ˜', 'é™ˆ', 'æ¨', 'é»„', 'èµµ', 'å‘¨', 'å´', 'å¾', 'å­™', 'é©¬', 'æœ±', 'èƒ¡', 'éƒ­', 'æ—', 'ä½•', 'é«˜', 'æ¢'];
      const givenNames = ['æ˜', 'å', 'ä¼Ÿ', 'èŠ³', 'é™', 'é˜³', 'ä¸½', 'æ•', 'æ°', 'åˆš', 'ç£Š', 'å¨œ', 'è¶…', 'å©·', 'å†›', 'å¼º', 'é›ª', 'æ¶›', 'å³°', 'è‰³'];

      for (let i = 0; i < 100; i++) {
        const surname = surnames[Math.floor(Math.random() * surnames.length)];
        const givenName = givenNames[Math.floor(Math.random() * givenNames.length)];
        const name = surname + givenName;

        // çŠ¶æ€åˆ†å¸ƒï¼š40%æœªæ‰¹é˜…ï¼Œ20%å·²æ‰¹é˜…ï¼Œ10%æœªå¼€å§‹ï¼Œ10%è¿›è¡Œä¸­ï¼Œ20%å¼‚å¸¸çŠ¶æ€
        let status;
        const rand = Math.random();
        if (rand < 0.4) {
          status = 'not_graded'; // 40% æœªæ‰¹é˜…
        } else if (rand < 0.6) {
          status = 'graded'; // 20% å·²æ‰¹é˜…
        } else if (rand < 0.7) {
          status = 'not_started'; // 10% æœªå¼€å§‹
        } else if (rand < 0.8) {
          status = 'in_progress'; // 10% è¿›è¡Œä¸­
        } else if (rand < 0.85) {
          status = 'absent'; // 5% ç¼ºè€ƒ
        } else if (rand < 0.9) {
          status = 'violation'; // 5% è¿çºª
        } else if (rand < 0.95) {
          status = 'cheating'; // 5% ä½œå¼Š
        } else {
          status = 'suspected_cheating'; // 5% ç–‘ä¼¼ä½œå¼Š
        }

        const hasSubmitted = ['not_graded', 'graded', 'absent', 'violation', 'cheating', 'suspected_cheating'].includes(status);
        const attemptedCount = status === 'not_started' ? 0 : (hasSubmitted ? 1 : 0);

        // æäº¤æ—¶é—´
        const submitDay = 20 + Math.floor(Math.random() * 8);
        const submitHour = 8 + Math.floor(Math.random() * 12);
        const submitMinute = Math.floor(Math.random() * 60);
        const submitSecond = Math.floor(Math.random() * 60);
        const submitTime = hasSubmitted
          ? `2026-01-${String(submitDay).padStart(2, '0')} ${String(submitHour).padStart(2, '0')}:${String(submitMinute).padStart(2, '0')}:${String(submitSecond).padStart(2, '0')}`
          : '';

        const duration = hasSubmitted ? Math.floor(Math.random() * 60) + 60 : 0; // 60-120åˆ†é’Ÿ
        const durationText = hasSubmitted ? `${duration}åˆ†é’Ÿ` : '';

        mockData.push({
          id: `STU${String(i + 1).padStart(5, '0')}`,
          examId: examId,
          username: `student${String(i + 1).padStart(3, '0')}`,
          name: name,
          phone: i % 5 === 0 ? '' : `138${String(Math.floor(Math.random() * 100000000)).padStart(8, '0')}`,
          photo: `https://i.pravatar.cc/150?u=student${i}`,
          status: status,
          statusText: '',
          completedCount: attemptedCount,
          allowedAttempts: currentExam ? currentExam.attemptLimit : 3,
          leaveCount: hasSubmitted ? Math.floor(Math.random() * 3) : 0,
          answerTime: submitTime,
          duration: durationText,
          faceRecognition: hasSubmitted ? `${85 + Math.floor(Math.random() * 15)}%` : '',
          captures: hasSubmitted ? Math.floor(Math.random() * 20) + 10 : 0,
          highestScore: status === 'graded' ? String(60 + Math.floor(Math.random() * 40)) : (status === 'absent' || status === 'violation' || status === 'cheating' || status === 'suspected_cheating' ? '0' : ''),
          addTime: `2026-01-${String(15 + Math.floor(i / 10)).padStart(2, '0')} ${String(8 + Math.floor(i % 10)).padStart(2, '0')}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}`
        });
      }

      return mockData;
    }

    // åŠ è½½è¯•å·ä¿¡æ¯
    function loadPaperData() {
      // ä» localStorage è¯»å–è¯•å·åˆ—è¡¨
      const papers = JSON.parse(localStorage.getItem('papers') || '[]');

      // æ ¹æ®è€ƒè¯•é…ç½®çš„è¯•å·IDæŸ¥æ‰¾è¯•å·
      if (currentExam && currentExam.paperId) {
        currentPaper = papers.find(p => p.id === currentExam.paperId);
      }

      console.log('å½“å‰è¯•å·:', currentPaper);
    }

    // ç”Ÿæˆæ¨¡æ‹Ÿç­”å·æ•°æ®ï¼ˆå·²åºŸå¼ƒï¼Œæ”¹ç”¨ä»è€ƒç”Ÿç®¡ç†è¯»å–ï¼‰
    function generateMockPapers() {
      return [];
    }

    // æ¸²æŸ“æ‰€æœ‰å†…å®¹
    function renderAll() {
      renderGraders();
      renderUngraded();
      renderGraded();
      updateStatistics();
      updateHeaderStatistics();
    }

    // æ›´æ–°å¤´éƒ¨ç»Ÿè®¡æ•°æ®
    function updateHeaderStatistics() {
      const submittedCount = students.length;
      const gradedCount = students.filter(s => s.status === 'graded').length;
      const ungradedCount = students.filter(s => s.status === 'not_graded').length;

      document.getElementById('submittedCount').textContent = submittedCount;
      document.getElementById('gradedCount').textContent = gradedCount;
      document.getElementById('ungradedCount').textContent = ungradedCount;
    }

    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    function updateStatistics() {
      const ungradedCount = students.filter(s => s.status === 'not_graded').length;
      const gradedCount = students.filter(s =>
        s.status === 'graded' ||
        s.status === 'absent' ||
        s.status === 'violation' ||
        s.status === 'cheating' ||
        s.status === 'suspected_cheating'
      ).length;

      document.getElementById('ungradedBadge').textContent = ungradedCount;
      document.getElementById('gradedBadge').textContent = gradedCount;

      // æ›´æ–°æ‰¹é˜…äººç­›é€‰å™¨
      const graderFilter = document.getElementById('graderFilter');
      graderFilter.innerHTML = '<option value="">å…¨éƒ¨æ‰¹é˜…äºº</option>';
      graders.forEach(g => {
        graderFilter.innerHTML += `<option value="${g.id}">${g.name}</option>`;
      });
      // æ·»åŠ ç³»ç»Ÿé€‰é¡¹ï¼ˆç”¨äºå¼‚å¸¸çŠ¶æ€ï¼‰
      graderFilter.innerHTML += '<option value="SYSTEM">ç³»ç»Ÿ</option>';
    }

    // åˆ‡æ¢ä¸» Tab
    function switchMainTab(tab) {
      activeMainTab = tab;

      document.getElementById('tabGraders').className = tab === 'graders'
        ? 'py-2 text-sm font-medium border-b-2 border-primary-500 text-primary-600'
        : 'py-2 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900';

      document.getElementById('tabPapers').className = tab === 'papers'
        ? 'py-2 text-sm font-medium border-b-2 border-primary-500 text-primary-600'
        : 'py-2 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900';

      if (tab === 'graders') {
        document.getElementById('gradersPanel').classList.remove('hidden');
        document.getElementById('gradersPanel').classList.add('flex');
        document.getElementById('papersPanel').classList.add('hidden');
        document.getElementById('papersPanel').classList.remove('flex');
      } else {
        document.getElementById('gradersPanel').classList.add('hidden');
        document.getElementById('gradersPanel').classList.remove('flex');
        document.getElementById('papersPanel').classList.remove('hidden');
        document.getElementById('papersPanel').classList.add('flex');
      }
    }

    // åˆ‡æ¢è¯•å· Tab
    function switchPaperTab(tab) {
      activePaperTab = tab;

      document.getElementById('tabUngraded').className = tab === 'ungraded'
        ? 'py-3 text-sm font-medium border-b-2 border-primary-500 text-primary-600 flex items-center gap-2'
        : 'py-3 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 flex items-center gap-2';

      document.getElementById('tabGraded').className = tab === 'graded'
        ? 'py-3 text-sm font-medium border-b-2 border-primary-500 text-primary-600 flex items-center gap-2'
        : 'py-3 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 flex items-center gap-2';

      if (tab === 'ungraded') {
        document.getElementById('ungradedPanel').classList.remove('hidden');
        document.getElementById('ungradedPanel').classList.add('flex');
        document.getElementById('gradedPanel').classList.add('hidden');
        document.getElementById('gradedPanel').classList.remove('flex');
      } else {
        document.getElementById('ungradedPanel').classList.add('hidden');
        document.getElementById('ungradedPanel').classList.remove('flex');
        document.getElementById('gradedPanel').classList.remove('hidden');
        document.getElementById('gradedPanel').classList.add('flex');
      }
    }

    // ========== é˜…å·äººå‘˜ç®¡ç† ==========

    // æ¸²æŸ“é˜…å·äººå‘˜åˆ—è¡¨
    function renderGraders() {
      // æŒ‰æ·»åŠ æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
      graders.sort((a, b) => {
        return new Date(b.addTime) - new Date(a.addTime);
      });

      graderFilteredData = [...graders];
      graderCurrentPage = 1;
      updateGraderTable();
    }

    // æœç´¢é˜…å·äººå‘˜
    function searchGraders() {
      const searchTerm = document.getElementById('graderSearchInput').value.trim().toLowerCase();

      if (!searchTerm) {
        graderFilteredData = [...graders];
      } else {
        graderFilteredData = graders.filter(grader => {
          return grader.name.toLowerCase().includes(searchTerm) ||
                 grader.jobNum.toLowerCase().includes(searchTerm) ||
                 (grader.phone && grader.phone.includes(searchTerm));
        });
      }

      // æŒ‰æ·»åŠ æ—¶é—´å€’åºæ’åˆ—
      graderFilteredData.sort((a, b) => {
        return new Date(b.addTime) - new Date(a.addTime);
      });

      graderCurrentPage = 1;
      updateGraderTable();
    }

    // é‡ç½®æœç´¢
    function resetGraderSearch() {
      document.getElementById('graderSearchInput').value = '';
      graderFilteredData = [...graders];

      // æŒ‰æ·»åŠ æ—¶é—´å€’åºæ’åˆ—
      graderFilteredData.sort((a, b) => {
        return new Date(b.addTime) - new Date(a.addTime);
      });

      graderCurrentPage = 1;
      updateGraderTable();
    }

    function updateGraderTable() {
      const tbody = document.getElementById('gradersTableBody');
      const start = (graderCurrentPage - 1) * graderPageSize;
      const end = start + graderPageSize;
      const pageData = graderFilteredData.slice(start, end);

      console.log('æ¸²æŸ“é˜…å·äººå‘˜è¡¨æ ¼ï¼Œå½“å‰é¡µ:', graderCurrentPage, 'æ•°æ®é‡:', pageData.length);

      tbody.innerHTML = pageData.map(grader => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3">
            <input type="checkbox" class="grader-checkbox w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500"
              data-id="${grader.id}" onchange="toggleGraderSelection('${grader.id}')" ${selectedGraders.has(grader.id) ? 'checked' : ''}>
          </td>
          <td class="px-4 py-3 text-sm text-gray-900">${grader.name}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${grader.jobNum}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${grader.phone || '-'}</td>
          <td class="px-4 py-3 text-sm">
            <span class="text-primary-600 font-semibold">${grader.gradedCount}</span> ä»½
          </td>
          <td class="px-4 py-3 text-sm text-gray-600">${grader.addTime}</td>
          <td class="px-4 py-3 text-center">
            <button onclick="deleteGrader('${grader.id}')" class="text-error-600 hover:text-error-700">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');

      updateGraderPagination();
      updateSelectAllGradersCheckbox();
    }

    // é˜…å·äººå‘˜åˆ†é¡µ
    function updateGraderPagination() {
      const totalPages = Math.ceil(graderFilteredData.length / graderPageSize) || 1;
      const start = (graderCurrentPage - 1) * graderPageSize + 1;
      const end = Math.min(graderCurrentPage * graderPageSize, graderFilteredData.length);

      document.getElementById('graderPageStart').textContent = graderFilteredData.length > 0 ? start : 0;
      document.getElementById('graderPageEnd').textContent = end;
      document.getElementById('graderTotalItems').textContent = graderFilteredData.length;

      document.getElementById('graderFirstBtn').disabled = graderCurrentPage === 1;
      document.getElementById('graderPrevBtn').disabled = graderCurrentPage === 1;
      document.getElementById('graderNextBtn').disabled = graderCurrentPage === totalPages;
      document.getElementById('graderLastBtn').disabled = graderCurrentPage === totalPages;

      renderGraderPageNumbers(totalPages);
    }

    function renderGraderPageNumbers(totalPages) {
      const container = document.getElementById('graderPageNumbers');
      if (!container) {
        console.error('graderPageNumbers å®¹å™¨æœªæ‰¾åˆ°');
        return;
      }

      container.innerHTML = '';

      // å³ä½¿åªæœ‰1é¡µä¹Ÿæ˜¾ç¤ºé¡µç 
      if (totalPages < 1) totalPages = 1;

      console.log('æ¸²æŸ“é˜…å·äººå‘˜é¡µç ï¼Œæ€»é¡µæ•°:', totalPages, 'å½“å‰é¡µ:', graderCurrentPage);

      let startPage = Math.max(1, graderCurrentPage - 2);
      let endPage = Math.min(totalPages, startPage + 4);

      if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
      }

      for (let i = startPage; i <= endPage; i++) {
        const button = document.createElement('button');
        button.className = `w-9 h-9 rounded text-sm font-medium transition-colors ${
          i === graderCurrentPage ? 'bg-primary-500 text-white' : 'border border-gray-300 text-gray-600 hover:bg-gray-50'
        }`;
        button.textContent = i;
        button.onclick = () => {
          graderCurrentPage = i;
          updateGraderTable();
        };
        container.appendChild(button);
      }

      console.log('é¡µç æŒ‰é’®å·²æ·»åŠ ï¼Œæ•°é‡:', container.children.length);
    }

    function graderFirstPage() {
      graderCurrentPage = 1;
      updateGraderTable();
    }

    function graderPrevPage() {
      if (graderCurrentPage > 1) {
        graderCurrentPage--;
        updateGraderTable();
      }
    }

    function graderNextPage() {
      const totalPages = Math.ceil(graderFilteredData.length / graderPageSize);
      if (graderCurrentPage < totalPages) {
        graderCurrentPage++;
        updateGraderTable();
      }
    }

    function graderLastPage() {
      graderCurrentPage = Math.ceil(graderFilteredData.length / graderPageSize);
      updateGraderTable();
    }

    // é€‰æ‹©é˜…å·äººå‘˜
    function toggleGraderSelection(id) {
      if (selectedGraders.has(id)) {
        selectedGraders.delete(id);
      } else {
        selectedGraders.add(id);
      }
      updateBatchDeleteButton();
      updateSelectAllGradersCheckbox();
    }

    function toggleAllGraders() {
      const checkbox = document.getElementById('selectAllGraders');
      const isChecked = checkbox.checked;

      if (isChecked) {
        // å‹¾é€‰æ—¶ï¼Œé€‰æ‹©å½“å‰é¡µ
        selectCurrentPageGraders();
      } else {
        // å–æ¶ˆå‹¾é€‰æ—¶ï¼Œç§»é™¤å½“å‰é¡µæ‰€æœ‰é˜…å·äººå‘˜
        const pageData = graderFilteredData.slice((graderCurrentPage - 1) * graderPageSize, graderCurrentPage * graderPageSize);
        pageData.forEach(grader => {
          selectedGraders.delete(grader.id);
        });
        updateGraderTable();
        updateBatchDeleteButton();
      }
    }

    // é€‰æ‹©å½“å‰é¡µ
    function selectCurrentPageGraders() {
      const pageData = graderFilteredData.slice((graderCurrentPage - 1) * graderPageSize, graderCurrentPage * graderPageSize);

      // æ·»åŠ å½“å‰é¡µæ‰€æœ‰é˜…å·äººå‘˜
      pageData.forEach(grader => {
        selectedGraders.add(grader.id);
      });

      updateGraderTable();
      updateBatchDeleteButton();
      updateSelectAllGradersCheckbox();
      showMessage(`å·²é€‰æ‹©å½“å‰é¡µ ${pageData.length} åé˜…å·äººå‘˜`, 'success');

      // å…³é—­èœå•
      document.getElementById('selectMenuGraders').classList.add('hidden');
    }

    // é€‰æ‹©ç­›é€‰ç»“æœ
    function selectFilteredGraders() {
      // æ·»åŠ æ‰€æœ‰ç­›é€‰ç»“æœ
      graderFilteredData.forEach(grader => {
        selectedGraders.add(grader.id);
      });

      updateGraderTable();
      updateBatchDeleteButton();
      updateSelectAllGradersCheckbox();
      showMessage(`å·²é€‰æ‹©ç­›é€‰ç»“æœä¸­çš„ ${graderFilteredData.length} åé˜…å·äººå‘˜`, 'success');

      // å…³é—­èœå•
      document.getElementById('selectMenuGraders').classList.add('hidden');
    }

    // é€‰æ‹©å…¨éƒ¨æ•°æ®
    function selectAllGraders() {
      // æ·»åŠ æ‰€æœ‰é˜…å·äººå‘˜
      graders.forEach(grader => {
        selectedGraders.add(grader.id);
      });

      updateGraderTable();
      updateBatchDeleteButton();
      updateSelectAllGradersCheckbox();
      showMessage(`å·²é€‰æ‹©å…¨éƒ¨ ${graders.length} åé˜…å·äººå‘˜`, 'success');

      // å…³é—­èœå•
      document.getElementById('selectMenuGraders').classList.add('hidden');
    }

    // å–æ¶ˆå…¨é€‰
    function clearSelectionGraders() {
      selectedGraders.clear();
      updateGraderTable();
      updateBatchDeleteButton();
      updateSelectAllGradersCheckbox();
      showMessage('å·²å–æ¶ˆå…¨éƒ¨é€‰æ‹©', 'info');

      // å…³é—­èœå•
      document.getElementById('selectMenuGraders').classList.add('hidden');
    }

    // åˆ‡æ¢ä¸‹æ‹‰èœå•
    function toggleSelectMenuGraders(event) {
      event.stopPropagation();
      const menu = document.getElementById('selectMenuGraders');
      menu.classList.toggle('hidden');
    }

    function updateSelectAllGradersCheckbox() {
      const checkbox = document.getElementById('selectAllGraders');
      const pageData = graderFilteredData.slice((graderCurrentPage - 1) * graderPageSize, graderCurrentPage * graderPageSize);

      if (pageData.length === 0) {
        checkbox.checked = false;
        checkbox.indeterminate = false;
        return;
      }

      const selectedInPage = pageData.filter(grader => selectedGraders.has(grader.id)).length;

      if (selectedInPage === 0) {
        checkbox.checked = false;
        checkbox.indeterminate = false;
      } else if (selectedInPage === pageData.length) {
        checkbox.checked = true;
        checkbox.indeterminate = false;
      } else {
        checkbox.checked = false;
        checkbox.indeterminate = true;
      }
    }

    function updateBatchDeleteButton() {
      const btn = document.getElementById('batchDeleteGradersBtn');
      if (selectedGraders.size > 0) {
        btn.disabled = false;
        btn.className = 'px-4 py-2 border border-error-500 text-error-500 hover:bg-error-50 rounded-lg text-sm font-medium transition-colors flex items-center gap-2';
      } else {
        btn.disabled = true;
        btn.className = 'px-4 py-2 border border-gray-300 text-gray-400 rounded-lg text-sm font-medium flex items-center gap-2 cursor-not-allowed';
      }
    }

    // æ·»åŠ é˜…å·äººå‘˜
    function addGrader() {
      currentGraderId = null;
      document.getElementById('graderModalTitle').textContent = 'æ·»åŠ é˜…å·äººå‘˜';
      document.getElementById('graderName').value = '';
      document.getElementById('graderJobNum').value = '';
      document.getElementById('graderPhone').value = '';
      document.getElementById('graderModal').classList.remove('hidden');
    }

    // ç¼–è¾‘é˜…å·äººå‘˜
    function editGrader(id) {
      const grader = graders.find(g => g.id === id);
      if (grader) {
        currentGraderId = id;
        document.getElementById('graderModalTitle').textContent = 'ç¼–è¾‘é˜…å·äººå‘˜';
        document.getElementById('graderName').value = grader.name;
        document.getElementById('graderJobNum').value = grader.jobNum;
        document.getElementById('graderPhone').value = grader.phone;
        document.getElementById('graderModal').classList.remove('hidden');
      }
    }

    // ä¿å­˜é˜…å·äººå‘˜
    function saveGrader() {
      const name = document.getElementById('graderName').value.trim();
      const jobNum = document.getElementById('graderJobNum').value.trim();
      const phone = document.getElementById('graderPhone').value.trim();

      if (!name || !jobNum) {
        showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼ˆå§“åå’Œå·¥å·ä¸ºå¿…å¡«é¡¹ï¼‰', 'warning');
        return;
      }

      // æ‰‹æœºå·éå¿…å¡«ï¼Œä½†å¦‚æœå¡«å†™äº†éœ€è¦éªŒè¯æ ¼å¼
      if (phone && !/^1[3-9]\d{9}$/.test(phone)) {
        showMessage('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®', 'error');
        return;
      }

      if (currentGraderId) {
        // ç¼–è¾‘
        const grader = graders.find(g => g.id === currentGraderId);
        if (grader) {
          grader.name = name;
          grader.jobNum = jobNum;
          grader.phone = phone || '';
        }
        showMessage('é˜…å·äººå‘˜ä¿¡æ¯å·²æ›´æ–°', 'success');
      } else {
        // æ·»åŠ 
        const newId = `GR${String(graders.length + 1).padStart(3, '0')}`;
        const newGrader = {
          id: newId,
          name,
          jobNum,
          phone: phone || '',
          gradedCount: 0,
          addTime: new Date().toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-')
        };
        graders.push(newGrader);
        console.log('æ–°å¢é˜…å·äººå‘˜:', newGrader);
        console.log('å½“å‰é˜…å·äººå‘˜åˆ—è¡¨:', graders);
        showMessage('é˜…å·äººå‘˜æ·»åŠ æˆåŠŸ', 'success');
      }

      saveGradersData();
      closeGraderModal();
      renderGraders();
    }

    // åˆ é™¤é˜…å·äººå‘˜
    function deleteGrader(id) {
      const grader = graders.find(g => g.id === id);
      if (grader) {
        document.getElementById('deleteMessage').textContent = `ç¡®å®šè¦åˆ é™¤é˜…å·äººå‘˜"${grader.name}"å—ï¼Ÿ`;
        deleteCallback = () => {
          graders = graders.filter(g => g.id !== id);
          saveGradersData();
          renderGraders();
        };
        document.getElementById('deleteModal').classList.remove('hidden');
      }
    }

    // æ‰¹é‡åˆ é™¤é˜…å·äººå‘˜
    function batchDeleteGraders() {
      if (selectedGraders.size === 0) return;

      document.getElementById('deleteMessage').textContent = `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedGraders.size} ä½é˜…å·äººå‘˜å—ï¼Ÿ`;
      deleteCallback = () => {
        graders = graders.filter(g => !selectedGraders.has(g.id));
        selectedGraders.clear();
        saveGradersData();
        renderGraders();
        updateBatchDeleteButton();
      };
      document.getElementById('deleteModal').classList.remove('hidden');
    }

    // å¯¼å…¥é˜…å·äººå‘˜
    function importGraders() {
      openImportModal();
    }

    // ä¿å­˜é˜…å·äººå‘˜æ•°æ®
    function saveGradersData() {
      const storageKey = `exam_${examId}_graders`;
      localStorage.setItem(storageKey, JSON.stringify(graders));
      console.log('ä¿å­˜é˜…å·äººå‘˜æ•°æ®:', graders.length, 'ä½');
    }

    // å…³é—­å¼¹çª—
    function closeGraderModal() {
      document.getElementById('graderModal').classList.add('hidden');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.add('hidden');
      deleteCallback = null;
    }

    function confirmDelete() {
      if (deleteCallback) {
        deleteCallback();
      }
      closeDeleteModal();
    }

    // ========== æœªé˜…è¯•å·ç®¡ç† ==========

    // ç­›é€‰æœªé˜…è¯•å·
    function filterUngraded() {
      const search = document.getElementById('ungradedSearch').value.trim().toLowerCase();

      ungradedFilteredData = students.filter(s => {
        if (s.status !== 'not_graded') return false;
        if (search && !s.username.toLowerCase().includes(search) && !s.name.toLowerCase().includes(search)) return false;
        return true;
      });

      ungradedCurrentPage = 1;
      updateUngradedTable();
    }

    // é‡ç½®æœªé˜…è¯•å·ç­›é€‰
    function resetUngradedFilter() {
      document.getElementById('ungradedSearch').value = '';
      filterUngraded();
    }

    // æ¸²æŸ“æœªé˜…è¯•å·åˆ—è¡¨
    function renderUngraded() {
      ungradedFilteredData = students.filter(s => s.status === 'not_graded');
      ungradedCurrentPage = 1;
      updateUngradedTable();
    }

    function updateUngradedTable() {
      const tbody = document.getElementById('ungradedTableBody');
      const table = document.getElementById('ungradedTable');
      const emptyState = document.getElementById('ungradedEmptyState');

      // å¦‚æœè€ƒè¯•æœªå¼€å§‹ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
      if (currentExam && currentExam.examStatus === 'not_started') {
        table.classList.add('hidden');
        emptyState.classList.remove('hidden');
        document.getElementById('ungradedPageStart').textContent = '0';
        document.getElementById('ungradedPageEnd').textContent = '0';
        document.getElementById('ungradedTotalItems').textContent = '0';
        return;
      }

      // è€ƒè¯•å·²å¼€å§‹æˆ–å·²ç»“æŸï¼Œæ˜¾ç¤ºè¡¨æ ¼
      table.classList.remove('hidden');
      emptyState.classList.add('hidden');

      const start = (ungradedCurrentPage - 1) * ungradedPageSize;
      const end = start + ungradedPageSize;
      const pageData = ungradedFilteredData.slice(start, end);

      tbody.innerHTML = pageData.map(student => {
        // ç…§ç‰‡
        const photoUrl = student.photo || 'https://via.placeholder.com/40';

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤ºï¼ˆMM-DD HH:MM:SSï¼‰
        const formatTime = (time) => {
          if (!time || time === '-') return '-';
          if (time.includes && time.includes(' ')) {
            const parts = time.split(' ');
            if (parts.length === 2) {
              return parts[0].substring(5) + ' ' + parts[1]; // MM-DD HH:MM:SS
            }
          }
          return time;
        };

        return `
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-center whitespace-nowrap">
              <img src="${photoUrl}" alt="ç…§ç‰‡" class="w-10 h-10 rounded-full object-cover mx-auto border border-gray-200">
            </td>
            <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${student.username}</td>
            <td class="px-4 py-3 text-sm text-gray-900 whitespace-nowrap">${student.name}</td>
            <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${student.phone || '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${formatTime(student.startTime)}</td>
            <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${formatTime(student.submitTime)}</td>
            <td class="px-4 py-3 text-sm text-gray-600 text-center whitespace-nowrap">${student.duration || '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${student.paperName || '-'}</td>
            <td class="px-4 py-3 text-center whitespace-nowrap">
              <button onclick="gradeStudent('${student.username}')" class="px-3 py-1.5 bg-primary-500 hover:bg-primary-600 text-white rounded text-sm">
                å»æ‰¹é˜…
              </button>
            </td>
          </tr>
        `;
      }).join('');

      updateUngradedPagination();
    }

    // æœªé˜…è¯•å·åˆ†é¡µ
    function updateUngradedPagination() {
      const totalPages = Math.ceil(ungradedFilteredData.length / ungradedPageSize) || 1;
      const start = (ungradedCurrentPage - 1) * ungradedPageSize + 1;
      const end = Math.min(ungradedCurrentPage * ungradedPageSize, ungradedFilteredData.length);

      document.getElementById('ungradedPageStart').textContent = ungradedFilteredData.length > 0 ? start : 0;
      document.getElementById('ungradedPageEnd').textContent = end;
      document.getElementById('ungradedTotalItems').textContent = ungradedFilteredData.length;

      document.getElementById('ungradedFirstBtn').disabled = ungradedCurrentPage === 1;
      document.getElementById('ungradedPrevBtn').disabled = ungradedCurrentPage === 1;
      document.getElementById('ungradedNextBtn').disabled = ungradedCurrentPage === totalPages;
      document.getElementById('ungradedLastBtn').disabled = ungradedCurrentPage === totalPages;

      renderUngradedPageNumbers(totalPages);
    }

    function renderUngradedPageNumbers(totalPages) {
      const container = document.getElementById('ungradedPageNumbers');
      if (!container) return;

      container.innerHTML = '';

      // å³ä½¿åªæœ‰1é¡µä¹Ÿæ˜¾ç¤ºé¡µç 
      if (totalPages < 1) totalPages = 1;

      let startPage = Math.max(1, ungradedCurrentPage - 2);
      let endPage = Math.min(totalPages, startPage + 4);

      if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
      }

      for (let i = startPage; i <= endPage; i++) {
        const button = document.createElement('button');
        button.className = `w-9 h-9 rounded text-sm font-medium transition-colors ${
          i === ungradedCurrentPage ? 'bg-primary-500 text-white' : 'border border-gray-300 text-gray-600 hover:bg-gray-50'
        }`;
        button.textContent = i;
        button.onclick = () => {
          ungradedCurrentPage = i;
          updateUngradedTable();
        };
        container.appendChild(button);
      }
    }

    function ungradedFirstPage() {
      ungradedCurrentPage = 1;
      updateUngradedTable();
    }

    function ungradedPrevPage() {
      if (ungradedCurrentPage > 1) {
        ungradedCurrentPage--;
        updateUngradedTable();
      }
    }

    function ungradedNextPage() {
      const totalPages = Math.ceil(ungradedFilteredData.length / ungradedPageSize);
      if (ungradedCurrentPage < totalPages) {
        ungradedCurrentPage++;
        updateUngradedTable();
      }
    }

    function ungradedLastPage() {
      ungradedCurrentPage = Math.ceil(ungradedFilteredData.length / ungradedPageSize);
      updateUngradedTable();
    }

    // ä¿å­˜ç­”å·æ•°æ®
    function savePapersData() {
      // æ›´æ–°åˆ° examStudents
      const allStudentsData = JSON.parse(localStorage.getItem('examStudents') || '{}');
      if (!allStudentsData[examId]) {
        allStudentsData[examId] = [];
      }

      // æ›´æ–°ä¿®æ”¹è¿‡çš„å­¦ç”Ÿæ•°æ®
      students.forEach(student => {
        const index = allStudentsData[examId].findIndex(s => s.username === student.username);
        if (index !== -1) {
          allStudentsData[examId][index] = student;
        }
      });

      localStorage.setItem('examStudents', JSON.stringify(allStudentsData));
      console.log('ä¿å­˜ç­”å·æ•°æ®åˆ° examStudents');
    }

    // å»æ‰¹é˜…
    function gradeStudent(username) {
      // å®é™…é¡¹ç›®ä¸­è·³è½¬åˆ°æ‰¹é˜…é¡µé¢
      // window.location.href = `grade-paper.html?examId=${examId}&studentId=${username}`;

      // æ¨¡æ‹Ÿæ‰¹é˜…æ“ä½œ
      const student = students.find(s => s.username === username);
      if (!student) {
        showMessage('æœªæ‰¾åˆ°è¯¥å­¦ç”Ÿçš„ç­”å·', 'error');
        return;
      }

      // éšæœºåˆ†é…é˜…å·äººå‘˜
      const randomGrader = graders[Math.floor(Math.random() * graders.length)];
      if (!randomGrader) {
        showMessage('è¯·å…ˆæ·»åŠ é˜…å·äººå‘˜', 'warning');
        return;
      }

      // æ¨¡æ‹Ÿæ‰¹é˜…å®Œæˆ
      const now = new Date();
      const gradeTime = now.toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-');
      const score = 60 + Math.floor(Math.random() * 40); // 60-100åˆ†

      student.status = 'graded';
      student.graderId = randomGrader.id;
      student.graderName = randomGrader.name;
      student.gradeTime = gradeTime;
      student.score = score;
      student.highestScore = String(score);

      // æ›´æ–°é˜…å·äººå‘˜çš„å·²é˜…æ•°é‡
      randomGrader.gradedCount = (randomGrader.gradedCount || 0) + 1;
      saveGradersData();

      savePapersData();
      renderUngraded();
      renderGraded();
      updateStatistics();
      updateHeaderStatistics();
      showMessage(`æ‰¹é˜…å®Œæˆï¼å¾—åˆ†ï¼š${score}åˆ†`, 'success');
    }

    // ========== å·²é˜…è¯•å·ç®¡ç† ==========

    // ç­›é€‰å·²é˜…è¯•å·
    function filterGraded() {
      const grader = document.getElementById('graderFilter').value;
      const search = document.getElementById('gradedSearch').value.trim().toLowerCase();

      gradedFilteredData = students.filter(s => {
        // å·²é˜…åŒ…æ‹¬ï¼šgradedã€absentã€violationã€cheatingã€suspected_cheating
        if (s.status !== 'graded' &&
            s.status !== 'absent' &&
            s.status !== 'violation' &&
            s.status !== 'cheating' &&
            s.status !== 'suspected_cheating') return false;
        if (grader && s.graderId !== grader) return false;
        if (search && !s.username.toLowerCase().includes(search) && !s.name.toLowerCase().includes(search)) return false;
        return true;
      });

      gradedCurrentPage = 1;
      updateGradedTable();
    }

    // é‡ç½®å·²é˜…è¯•å·ç­›é€‰
    function resetGradedFilter() {
      document.getElementById('graderFilter').value = '';
      document.getElementById('gradedSearch').value = '';
      filterGraded();
    }

    // æ¸²æŸ“å·²é˜…è¯•å·åˆ—è¡¨
    function renderGraded() {
      gradedFilteredData = students.filter(s =>
        s.status === 'graded' ||
        s.status === 'absent' ||
        s.status === 'violation' ||
        s.status === 'cheating' ||
        s.status === 'suspected_cheating'
      );
      gradedCurrentPage = 1;
      updateGradedTable();
    }

    function updateGradedTable() {
      const tbody = document.getElementById('gradedTableBody');
      const table = document.getElementById('gradedTable');
      const emptyState = document.getElementById('gradedEmptyState');

      // å¦‚æœè€ƒè¯•æœªå¼€å§‹ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
      if (currentExam && currentExam.examStatus === 'not_started') {
        table.classList.add('hidden');
        emptyState.classList.remove('hidden');
        document.getElementById('gradedPageStart').textContent = '0';
        document.getElementById('gradedPageEnd').textContent = '0';
        document.getElementById('gradedTotalItems').textContent = '0';
        return;
      }

      // è€ƒè¯•å·²å¼€å§‹æˆ–å·²ç»“æŸï¼Œæ˜¾ç¤ºè¡¨æ ¼
      table.classList.remove('hidden');
      emptyState.classList.add('hidden');

      const start = (gradedCurrentPage - 1) * gradedPageSize;
      const end = start + gradedPageSize;
      const pageData = gradedFilteredData.slice(start, end);

      tbody.innerHTML = pageData.map(student => {
        // ç…§ç‰‡
        const photoUrl = student.photo || 'https://via.placeholder.com/40';

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤ºï¼ˆMM-DD HH:MM:SSï¼‰
        const formatTime = (time) => {
          if (!time || time === '-') return '-';
          if (time.includes && time.includes(' ')) {
            const parts = time.split(' ');
            if (parts.length === 2) {
              return parts[0].substring(5) + ' ' + parts[1]; // MM-DD HH:MM:SS
            }
          }
          return time;
        };

        // å¾—åˆ†æ˜¾ç¤ºï¼ˆå¼‚å¸¸çŠ¶æ€æ˜¾ç¤º0åˆ†ï¼‰
        let scoreDisplay = '';
        if (student.status === 'graded') {
          scoreDisplay = `<span class="text-primary-600 font-semibold">${student.score || student.highestScore || 0}</span>`;
        } else {
          // ç¼ºè€ƒã€è¿çºªã€ä½œå¼Šã€ç–‘ä¼¼ä½œå¼Šéƒ½æ˜¾ç¤º0åˆ†ï¼Œå¹¶æ ‡æ³¨çŠ¶æ€
          const statusText = {
            'absent': 'ç¼ºè€ƒ',
            'violation': 'è¿çºª',
            'cheating': 'ä½œå¼Š',
            'suspected_cheating': 'ç–‘ä¼¼ä½œå¼Š'
          }[student.status] || '';
          scoreDisplay = `<span class="text-error-600 font-semibold">0</span><br><span class="text-xs text-error-500">(${statusText})</span>`;
        }

        // æ£€æŸ¥æ˜¯å¦å·²é€‰ä¸­
        const isChecked = selectedGradedPapers.includes(student.username);

        return `
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 whitespace-nowrap">
              <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleGradedPaper('${student.username}')" class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
            </td>
            <td class="px-4 py-3 text-center whitespace-nowrap">
              <img src="${photoUrl}" alt="ç…§ç‰‡" class="w-10 h-10 rounded-full object-cover mx-auto border border-gray-200">
            </td>
            <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${student.username}</td>
            <td class="px-4 py-3 text-sm text-gray-900 whitespace-nowrap">${student.name}</td>
            <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${student.phone || '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${formatTime(student.startTime)}</td>
            <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${formatTime(student.submitTime)}</td>
            <td class="px-4 py-3 text-sm text-gray-600 text-center whitespace-nowrap">${student.duration || '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${student.paperName || '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${student.graderName || '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${formatTime(student.gradeTime)}</td>
            <td class="px-4 py-3 text-sm text-center whitespace-nowrap">${scoreDisplay}</td>
            <td class="px-4 py-3 text-center whitespace-nowrap">
              <button onclick="viewGradedPaper('${student.username}')" class="text-primary-600 hover:text-primary-700 text-sm">
                æŸ¥çœ‹è¯¦æƒ…
              </button>
            </td>
          </tr>
        `;
      }).join('');

      updateGradedPagination();
    }

    // å·²é˜…è¯•å·åˆ†é¡µ
    function updateGradedPagination() {
      const totalPages = Math.ceil(gradedFilteredData.length / gradedPageSize) || 1;
      const start = (gradedCurrentPage - 1) * gradedPageSize + 1;
      const end = Math.min(gradedCurrentPage * gradedPageSize, gradedFilteredData.length);

      document.getElementById('gradedPageStart').textContent = gradedFilteredData.length > 0 ? start : 0;
      document.getElementById('gradedPageEnd').textContent = end;
      document.getElementById('gradedTotalItems').textContent = gradedFilteredData.length;

      document.getElementById('gradedFirstBtn').disabled = gradedCurrentPage === 1;
      document.getElementById('gradedPrevBtn').disabled = gradedCurrentPage === 1;
      document.getElementById('gradedNextBtn').disabled = gradedCurrentPage === totalPages;
      document.getElementById('gradedLastBtn').disabled = gradedCurrentPage === totalPages;

      renderGradedPageNumbers(totalPages);
      updateSelectAllGradedCheckbox();
    }

    function renderGradedPageNumbers(totalPages) {
      const container = document.getElementById('gradedPageNumbers');
      if (!container) return;

      container.innerHTML = '';

      // å³ä½¿åªæœ‰1é¡µä¹Ÿæ˜¾ç¤ºé¡µç 
      if (totalPages < 1) totalPages = 1;

      let startPage = Math.max(1, gradedCurrentPage - 2);
      let endPage = Math.min(totalPages, startPage + 4);

      if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
      }

      for (let i = startPage; i <= endPage; i++) {
        const button = document.createElement('button');
        button.className = `w-9 h-9 rounded text-sm font-medium transition-colors ${
          i === gradedCurrentPage ? 'bg-primary-500 text-white' : 'border border-gray-300 text-gray-600 hover:bg-gray-50'
        }`;
        button.textContent = i;
        button.onclick = () => {
          gradedCurrentPage = i;
          updateGradedTable();
        };
        container.appendChild(button);
      }
    }

    function gradedFirstPage() {
      gradedCurrentPage = 1;
      updateGradedTable();
    }

    function gradedPrevPage() {
      if (gradedCurrentPage > 1) {
        gradedCurrentPage--;
        updateGradedTable();
      }
    }

    function gradedNextPage() {
      const totalPages = Math.ceil(gradedFilteredData.length / gradedPageSize);
      if (gradedCurrentPage < totalPages) {
        gradedCurrentPage++;
        updateGradedTable();
      }
    }

    function gradedLastPage() {
      gradedCurrentPage = Math.ceil(gradedFilteredData.length / gradedPageSize);
      updateGradedTable();
    }

    // ========== å·²é˜…è¯•å·å¤é€‰æ¡†åŠŸèƒ½ ==========

    // å…¨é€‰/å–æ¶ˆå…¨é€‰å·²é˜…è¯•å·
    function toggleAllGradedPapers() {
      const checkbox = document.getElementById('selectAllGradedPapers');
      const isChecked = checkbox.checked;

      if (isChecked) {
        // å‹¾é€‰æ—¶ï¼Œé€‰æ‹©å½“å‰é¡µ
        selectCurrentPageGraded();
      } else {
        // å–æ¶ˆå‹¾é€‰æ—¶ï¼Œç§»é™¤å½“å‰é¡µæ‰€æœ‰è€ƒç”Ÿ
        const pageUsernames = gradedFilteredData.slice((gradedCurrentPage - 1) * gradedPageSize, gradedCurrentPage * gradedPageSize).map(s => s.username);
        selectedGradedPapers = selectedGradedPapers.filter(username => !pageUsernames.includes(username));
        updateGradedTable();
        updateExportPDFButton();
      }
    }

    // é€‰æ‹©å½“å‰é¡µ
    function selectCurrentPageGraded() {
      const pageData = gradedFilteredData.slice((gradedCurrentPage - 1) * gradedPageSize, gradedCurrentPage * gradedPageSize);

      // æ·»åŠ å½“å‰é¡µæ‰€æœ‰è€ƒç”Ÿ
      pageData.forEach(student => {
        if (!selectedGradedPapers.includes(student.username)) {
          selectedGradedPapers.push(student.username);
        }
      });

      updateGradedTable();
      updateExportPDFButton();
      updateSelectAllGradedCheckbox();
      showMessage(`å·²é€‰æ‹©å½“å‰é¡µ ${pageData.length} ä»½è¯•å·`, 'success');

      // å…³é—­èœå•
      document.getElementById('selectMenuGraded').classList.add('hidden');
    }

    // é€‰æ‹©ç­›é€‰ç»“æœ
    function selectFilteredGraded() {
      // æ·»åŠ æ‰€æœ‰ç­›é€‰ç»“æœ
      gradedFilteredData.forEach(student => {
        if (!selectedGradedPapers.includes(student.username)) {
          selectedGradedPapers.push(student.username);
        }
      });

      updateGradedTable();
      updateExportPDFButton();
      updateSelectAllGradedCheckbox();
      showMessage(`å·²é€‰æ‹©ç­›é€‰ç»“æœä¸­çš„ ${gradedFilteredData.length} ä»½è¯•å·`, 'success');

      // å…³é—­èœå•
      document.getElementById('selectMenuGraded').classList.add('hidden');
    }

    // é€‰æ‹©å…¨éƒ¨æ•°æ®
    function selectAllGraded() {
      const gradedData = students.filter(s => s.status === 'graded');

      // æ·»åŠ æ‰€æœ‰å·²æ‰¹é˜…è¯•å·
      gradedData.forEach(student => {
        if (!selectedGradedPapers.includes(student.username)) {
          selectedGradedPapers.push(student.username);
        }
      });

      updateGradedTable();
      updateExportPDFButton();
      updateSelectAllGradedCheckbox();
      showMessage(`å·²é€‰æ‹©å…¨éƒ¨ ${gradedData.length} ä»½è¯•å·`, 'success');

      // å…³é—­èœå•
      document.getElementById('selectMenuGraded').classList.add('hidden');
    }

    // å–æ¶ˆå…¨é€‰
    function clearSelectionGraded() {
      selectedGradedPapers = [];
      updateGradedTable();
      updateExportPDFButton();
      updateSelectAllGradedCheckbox();
      showMessage('å·²å–æ¶ˆå…¨éƒ¨é€‰æ‹©', 'info');

      // å…³é—­èœå•
      document.getElementById('selectMenuGraded').classList.add('hidden');
    }

    // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
    function updateSelectAllGradedCheckbox() {
      const checkbox = document.getElementById('selectAllGradedPapers');
      const pageData = gradedFilteredData.slice((gradedCurrentPage - 1) * gradedPageSize, gradedCurrentPage * gradedPageSize);

      if (pageData.length === 0) {
        checkbox.checked = false;
        checkbox.indeterminate = false;
        return;
      }

      const selectedInPage = pageData.filter(s => selectedGradedPapers.includes(s.username)).length;

      if (selectedInPage === 0) {
        checkbox.checked = false;
        checkbox.indeterminate = false;
      } else if (selectedInPage === pageData.length) {
        checkbox.checked = true;
        checkbox.indeterminate = false;
      } else {
        checkbox.checked = false;
        checkbox.indeterminate = true;
      }
    }

    // åˆ‡æ¢ä¸‹æ‹‰èœå•
    function toggleSelectMenuGraded(event) {
      event.stopPropagation();
      const menu = document.getElementById('selectMenuGraded');
      menu.classList.toggle('hidden');
    }

    // åˆ‡æ¢å•ä¸ªå·²é˜…è¯•å·é€‰ä¸­çŠ¶æ€
    function toggleGradedPaper(username) {
      const index = selectedGradedPapers.indexOf(username);
      if (index > -1) {
        selectedGradedPapers.splice(index, 1);
      } else {
        selectedGradedPapers.push(username);
      }

      updateGradedTable();
      updateExportPDFButton();
      updateSelectAllGradedCheckbox();
    }

    // æ›´æ–°å¯¼å‡ºPDFæŒ‰é’®çŠ¶æ€
    function updateExportPDFButton() {
      const btn = document.getElementById('exportPDFBtn');
      if (selectedGradedPapers.length > 0) {
        btn.disabled = false;
        btn.title = `å·²é€‰æ‹© ${selectedGradedPapers.length} ä»½è¯•å·`;
      } else {
        btn.disabled = true;
        btn.title = 'è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„è¯•å·';
      }
    }

    // å¯¼å‡ºPDFï¼ˆåŠŸèƒ½æŒ‰é’®ï¼Œä¸å®ç°å…·ä½“åŠŸèƒ½ï¼‰
    function exportGradedPapersPDF() {
      if (selectedGradedPapers.length === 0) {
        showMessage('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„è¯•å·', 'warning');
        return;
      }

      showMessage(`å·²é€‰æ‹© ${selectedGradedPapers.length} ä»½è¯•å·ï¼Œå¯¼å‡ºPDFåŠŸèƒ½å¾…å¼€å‘...`, 'info');
    }

    // æŸ¥çœ‹å·²æ‰¹é˜…è¯•å·
    function viewGradedPaper(username) {
      const student = students.find(s => s.username === username);
      if (!student) {
        showMessage('æœªæ‰¾åˆ°è¯¥è¯•å·', 'error');
        return;
      }

      // çŠ¶æ€æ–‡æœ¬å’Œé¢œè‰²
      const statusConfig = {
        'graded': { text: 'æ­£å¸¸æ‰¹é˜…', color: 'text-success-600' },
        'absent': { text: 'ç¼ºè€ƒ', color: 'text-gray-600' },
        'violation': { text: 'è¿çºª', color: 'text-warning-600' },
        'cheating': { text: 'ä½œå¼Š', color: 'text-error-600' },
        'suspected_cheating': { text: 'ç–‘ä¼¼ä½œå¼Š', color: 'text-warning-600' }
      };
      const status = statusConfig[student.status] || { text: 'æœªçŸ¥', color: 'text-gray-600' };

      // å¡«å……æ¨¡æ€æ¡†æ•°æ®
      document.getElementById('detailStudentName').textContent = student.name;
      document.getElementById('detailUsername').textContent = student.username;
      document.getElementById('detailPhone').textContent = student.phone || '-';
      document.getElementById('detailStatus').innerHTML = `<span class="${status.color} font-semibold">${status.text}</span>`;

      document.getElementById('detailPaperName').textContent = student.paperName || '-';
      document.getElementById('detailStartTime').textContent = student.startTime || '-';
      document.getElementById('detailSubmitTime').textContent = student.submitTime || '-';
      document.getElementById('detailDuration').textContent = student.duration || '-';

      document.getElementById('detailGrader').textContent = student.graderName || '-';
      document.getElementById('detailGradeTime').textContent = student.gradeTime || '-';

      // å¾—åˆ†æ˜¾ç¤º
      const score = student.score || student.highestScore || 0;
      const scoreColor = student.status === 'graded' ? 'text-primary-600' : 'text-error-600';
      document.getElementById('detailScore').innerHTML = `<span class="${scoreColor}">${score}</span> åˆ†`;

      document.getElementById('detailLeaveCount').textContent = student.leaveCount || 0;
      document.getElementById('detailFaceRecognition').textContent = student.faceRecognition || student.faceRecognitionRate || '-';
      document.getElementById('detailCaptures').textContent = student.captures || 0;

      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      document.getElementById('paperDetailModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // å…³é—­æŸ¥çœ‹è¯¦æƒ…æ¨¡æ€æ¡†
    function closePaperDetailModal() {
      document.getElementById('paperDetailModal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    // é‡æ–°æ‰¹é˜…è¯•å·
    function reGradePaper() {
      showMessage('é‡æ–°æ‰¹é˜…åŠŸèƒ½å¾…å¼€å‘...', 'info');
    }

    // ========== Message æç¤ºç³»ç»Ÿ ==========

    function showMessage(message, type = 'info') {
      const container = document.getElementById('messageContainer');

      const colors = {
        success: 'bg-success-50 text-success-700 border-success-200',
        error: 'bg-error-50 text-error-700 border-error-200',
        warning: 'bg-warning-50 text-warning-700 border-warning-200',
        info: 'bg-info-50 text-info-700 border-info-200'
      };

      const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
      };

      const messageEl = document.createElement('div');
      messageEl.className = `${colors[type]} border px-4 py-3 rounded-lg shadow-lg flex items-start gap-3 min-w-[300px] max-w-md message-enter`;

      messageEl.innerHTML = `
        <i class="fas ${icons[type]} mt-0.5"></i>
        <div class="flex-1 text-sm">${message}</div>
        <button onclick="this.parentElement.remove()" class="text-current opacity-50 hover:opacity-100">
          <i class="fas fa-times"></i>
        </button>
      `;

      container.appendChild(messageEl);

      // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
      setTimeout(() => {
        messageEl.classList.remove('message-enter');
        messageEl.classList.add('message-exit');
        setTimeout(() => {
          messageEl.remove();
        }, 300);
      }, 3000);
    }

    // ========== æ‰¹é‡å¯¼å…¥åŠŸèƒ½ ==========

    let importData = [];
    let validImportData = [];

    // æ‰“å¼€å¯¼å…¥æ¨¡æ€æ¡†
    function openImportModal() {
      clearFile();
      document.getElementById('importModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // å…³é—­å¯¼å…¥æ¨¡æ€æ¡†
    function closeImportModal() {
      document.getElementById('importModal').classList.add('hidden');
      document.body.style.overflow = 'auto';
      clearFile();
    }

    // æ¸…é™¤æ–‡ä»¶
    function clearFile() {
      document.getElementById('importFile').value = '';
      document.getElementById('selectedFileInfo').classList.add('hidden');
      document.getElementById('previewSection').classList.add('hidden');
      document.getElementById('confirmImportBtn').disabled = true;
      importData = [];
      validImportData = [];
    }

    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ5MBï¼‰
      if (file.size > 5 * 1024 * 1024) {
        showMessage('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 5MB', 'error');
        return;
      }

      // æ£€æŸ¥æ–‡ä»¶ç±»å‹
      const fileName = file.name;
      const fileExt = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
      if (!['.xlsx', '.xls'].includes(fileExt)) {
        showMessage('åªæ”¯æŒ .xlsx æˆ– .xls æ ¼å¼çš„æ–‡ä»¶', 'error');
        return;
      }

      // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
      document.getElementById('fileName').textContent = fileName;
      document.getElementById('fileSize').textContent = formatFileSize(file.size);
      document.getElementById('selectedFileInfo').classList.remove('hidden');

      // æ¨¡æ‹Ÿè§£æExcelæ–‡ä»¶
      parseExcelFile(file);
    }

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // è§£æExcelæ–‡ä»¶ï¼ˆæ¨¡æ‹Ÿï¼‰
    function parseExcelFile(file) {
      // æ¨¡æ‹Ÿå¼‚æ­¥è§£æ
      setTimeout(() => {
        // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ï¼ˆå®é™…é¡¹ç›®ä¸­ä½¿ç”¨ SheetJS ç­‰åº“è§£æï¼‰
        const mockData = [
          { row: 2, name: 'ç‹è€å¸ˆ', jobNum: 'T2026100', phone: '13800138000', valid: true, error: '' },
          { row: 3, name: 'æè€å¸ˆ', jobNum: 'T2026101', phone: '13800138001', valid: true, error: '' },
          { row: 4, name: 'å¼ è€å¸ˆ', jobNum: 'T2026102', phone: '', valid: true, error: '' },
          { row: 5, name: '', jobNum: 'T2026103', phone: '13800138003', valid: false, error: 'å§“åä¸èƒ½ä¸ºç©º' },
          { row: 6, name: 'åˆ˜è€å¸ˆ', jobNum: '', phone: '13800138004', valid: false, error: 'å·¥å·ä¸èƒ½ä¸ºç©º' },
          { row: 7, name: 'é™ˆè€å¸ˆ', jobNum: 'T2026104', phone: '1380013800', valid: false, error: 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®' },
          { row: 8, name: 'æ¨è€å¸ˆ', jobNum: 'T2026105', phone: '13800138005', valid: true, error: '' }
        ];

        importData = mockData;
        validImportData = mockData.filter(d => d.valid);

        // æ˜¾ç¤ºé¢„è§ˆ
        renderPreview();
        showMessage('æ–‡ä»¶è§£ææˆåŠŸï¼Œè¯·æ£€æŸ¥æ•°æ®', 'success');
      }, 500);
    }

    // æ¸²æŸ“é¢„è§ˆ
    function renderPreview() {
      const tbody = document.getElementById('previewTableBody');
      const totalCount = importData.length;
      const validCount = validImportData.length;
      const invalidCount = totalCount - validCount;

      document.getElementById('previewTotal').textContent = totalCount;
      document.getElementById('previewValid').textContent = validCount;
      document.getElementById('previewInvalid').textContent = invalidCount;

      tbody.innerHTML = importData.map(item => {
        const statusClass = item.valid ? 'text-success-600' : 'text-error-600';
        const statusText = item.valid ? 'æœ‰æ•ˆ' : item.error;
        const rowClass = item.valid ? '' : 'bg-error-50';

        return `
          <tr class="${rowClass}">
            <td class="px-4 py-2 text-gray-600">${item.row}</td>
            <td class="px-4 py-2 text-gray-900">${item.name || '-'}</td>
            <td class="px-4 py-2 text-gray-900">${item.jobNum || '-'}</td>
            <td class="px-4 py-2 text-gray-600">${item.phone || '-'}</td>
            <td class="px-4 py-2 ${statusClass} text-xs">${statusText}</td>
          </tr>
        `;
      }).join('');

      document.getElementById('previewSection').classList.remove('hidden');
      document.getElementById('confirmImportBtn').disabled = validCount === 0;
    }

    // ç¡®è®¤å¯¼å…¥
    function confirmImport() {
      if (validImportData.length === 0) {
        showMessage('æ²¡æœ‰æœ‰æ•ˆæ•°æ®å¯ä»¥å¯¼å…¥', 'warning');
        return;
      }

      // æ£€æŸ¥å·¥å·é‡å¤
      const existingJobNums = new Set(graders.map(g => g.jobNum));
      const duplicates = validImportData.filter(item => existingJobNums.has(item.jobNum));

      if (duplicates.length > 0) {
        showMessage(`è·³è¿‡ ${duplicates.length} æ¡å·¥å·é‡å¤çš„æ•°æ®`, 'warning');
      }

      // å¯¼å…¥æœ‰æ•ˆä¸”ä¸é‡å¤çš„æ•°æ®
      const toImport = validImportData.filter(item => !existingJobNums.has(item.jobNum));

      if (toImport.length === 0) {
        showMessage('æ‰€æœ‰æ•°æ®çš„å·¥å·å‡å·²å­˜åœ¨ï¼Œæ— æ³•å¯¼å…¥', 'error');
        return;
      }

      const now = new Date().toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-');
      toImport.forEach(item => {
        const newId = `GR${String(graders.length + 1).padStart(3, '0')}`;
        graders.push({
          id: newId,
          name: item.name,
          jobNum: item.jobNum,
          phone: item.phone || '',
          gradedCount: 0,
          addTime: now
        });
      });

      saveGradersData();
      renderGraders();
      closeImportModal();
      showMessage(`æˆåŠŸå¯¼å…¥ ${toImport.length} æ¡æ•°æ®`, 'success');
    }

    // ä¸‹è½½å¯¼å…¥æ¨¡æ¿
    function downloadTemplate() {
      // åˆ›å»ºæ¨¡æ¿æ•°æ®
      const template = [
        ['å§“å', 'å·¥å·', 'æ‰‹æœºå·'],
        ['ç‹è€å¸ˆ', 'T2026100', '13800138000'],
        ['æè€å¸ˆ', 'T2026101', '13800138001'],
        ['å¼ è€å¸ˆ', 'T2026102', '']
      ];

      // åˆ›å»ºCSVå†…å®¹
      const csvContent = template.map(row => row.join(',')).join('\n');
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });

      // åˆ›å»ºä¸‹è½½é“¾æ¥
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'é˜…å·äººå‘˜å¯¼å…¥æ¨¡æ¿.csv';
      link.click();

      showMessage('æ¨¡æ¿ä¸‹è½½æˆåŠŸ', 'success');
    }
  </script>
</body>
</html>
