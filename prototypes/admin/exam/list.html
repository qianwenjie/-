<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>考试管理 - 考试系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#E6F9F0', 100: '#C3F0DB', 500: '#00B96B', 600: '#00A35C' },
            success: { 50: '#E8FFEA', 500: '#00B42A', 600: '#00A35C' },
            warning: { 50: '#FFF7E8', 500: '#FF7D00', 600: '#F57C00' },
            error: { 50: '#FFECE8', 500: '#F53F3F', 600: '#E53935' },
            info: { 50: '#E8F7FF', 500: '#14C9C9', 600: '#00ACC1' },
            purple: { 50: '#F3E8FF', 500: '#9333EA', 600: '#7E22CE' },
            gray: { 50: '#F9FAFB', 100: '#F3F4F6', 200: '#E5E7EB', 300: '#D1D5DB', 400: '#9CA3AF', 500: '#6B7280', 600: '#4B5563', 700: '#374151', 800: '#1F2937', 900: '#111827' }
          }
        }
      }
    }
  </script>
  <style>
    /* 卡片悬停效果 */
    .exam-card {
      transition: all 0.3s ease;
    }

    .exam-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* 消息提示样式 */
    .message-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    .message {
      min-width: 300px;
      padding: 16px 20px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="messageContainer" class="message-container"></div>

  <!-- 顶部导航 -->
  <header class="h-16 bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
    <div class="flex items-center justify-between h-full px-6">
      <div class="flex items-center space-x-4">
        <a href="../dashboard.html" class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-primary-500 rounded flex items-center justify-center">
            <i class="fas fa-graduation-cap text-white"></i>
          </div>
          <span class="text-xl font-semibold text-gray-900">考试系统</span>
        </a>
        <nav class="flex items-center space-x-2 text-sm text-gray-600">
          <a href="../dashboard.html" class="hover:text-primary-500">首页</a>
          <i class="fas fa-chevron-right text-xs text-gray-400"></i>
          <span class="text-gray-900 font-medium">考试管理</span>
        </nav>
      </div>
      <div class="flex items-center space-x-3">
        <img src="https://via.placeholder.com/32" alt="头像" class="w-8 h-8 rounded-full">
        <span class="text-sm text-gray-700">管理员</span>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="pt-16 min-h-screen">
    <div class="p-6">
      <!-- 筛选区域 -->
      <div class="bg-white rounded-lg border border-gray-200 p-3 mb-4 mt-1">
        <div class="flex items-center justify-between gap-3">
          <!-- 左侧筛选控件 -->
          <div class="flex items-center gap-3">
            <input type="text" id="searchInput" placeholder="搜索考试名称..." class="w-64 px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
            <select id="filterStatus" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
              <option value="">全部状态</option>
              <option value="pending">未开始</option>
              <option value="ongoing">进行中</option>
              <option value="finished">已结束</option>
            </select>
            <button onclick="filterExams()" class="px-4 py-1.5 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium transition-colors">
              <i class="fas fa-search mr-2"></i>筛选
            </button>
            <button onclick="resetFilter()" class="px-4 py-1.5 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg text-sm font-medium transition-colors">
              <i class="fas fa-redo mr-2"></i>重置
            </button>
          </div>
          <!-- 右侧创建按钮 -->
          <a href="create.html" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium transition-colors">
            <i class="fas fa-plus mr-2"></i>创建考试
          </a>
        </div>
      </div>

      <!-- 考试卡片列表 -->
      <div class="mb-16">
        <!-- 列表容器 -->
        <div id="examList" class="space-y-3">
        </div>
        <!-- 空状态 -->
        <div id="emptyState" class="hidden py-16 text-center bg-white rounded-lg border border-gray-200">
          <i class="fas fa-clipboard-list text-4xl text-gray-300 mb-4"></i>
          <p class="text-gray-500 mb-4">暂无考试数据</p>
          <a href="create.html" class="inline-block px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium">
            <i class="fas fa-plus mr-2"></i>创建第一场考试
          </a>
        </div>
      </div>
    </div>
  </main>

  <!-- 悬浮分页 -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-40">
    <div class="flex items-center justify-between px-6 py-3">
      <p class="text-sm text-gray-500">共 <span id="totalItems">0</span> 场考试</p>
      <div class="flex items-center space-x-2">
        <button onclick="prevPage()" class="px-3 py-1.5 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" id="prevBtn" disabled>
          <i class="fas fa-chevron-left"></i>
        </button>
        <span class="text-sm text-gray-700">第 <span id="currentPage">1</span> 页，共 <span id="totalPages">1</span> 页</span>
        <button onclick="nextPage()" class="px-3 py-1.5 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" id="nextBtn">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- 查看配置模态框 -->
  <div id="configModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
      <!-- 模态框头部 -->
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 class="text-xl font-semibold text-gray-900">考试配置详情</h2>
        <button onclick="closeConfigModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <!-- 模态框内容 -->
      <div class="flex-1 overflow-y-auto px-6 py-6">
        <div class="space-y-6" id="configContent">
          <!-- 内容将通过 JavaScript 动态填充 -->
        </div>
      </div>

      <!-- 模态框底部 -->
      <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
        <button onclick="closeConfigModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">
          关闭
        </button>
      </div>
    </div>
  </div>

  <!-- 删除确认模态框 -->
  <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
      <!-- 模态框头部 -->
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-error-50 rounded-lg flex items-center justify-center">
            <i class="fas fa-exclamation-triangle text-error-500 text-lg"></i>
          </div>
          <h2 class="text-lg font-semibold text-gray-900">确认删除</h2>
        </div>
      </div>

      <!-- 模态框内容 -->
      <div class="px-6 py-6">
        <p class="text-gray-700 text-sm leading-relaxed">
          确定要删除考试<span class="font-semibold text-gray-900" id="deleteExamName"></span>吗？
        </p>
        <p class="text-error-600 text-sm mt-2">
          <i class="fas fa-info-circle mr-1"></i>删除后将无法恢复！
        </p>
      </div>

      <!-- 模态框底部 -->
      <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
        <button onclick="closeDeleteConfirmModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">
          取消
        </button>
        <button onclick="confirmDeleteExam()" class="px-4 py-2 bg-error-500 hover:bg-error-600 text-white rounded-lg text-sm font-medium transition-colors">
          <i class="fas fa-trash mr-2"></i>确认删除
        </button>
      </div>
    </div>
  </div>

  <!-- ========== 从 create.html 复制的预览弹窗（文档模式） ========== -->
  <div id="previewModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closePreviewModal()"></div>
    <div class="absolute inset-4 bg-white rounded-lg shadow-2xl flex flex-col overflow-hidden">
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
        <div class="flex items-center space-x-3">
          <i class="fas fa-eye text-primary-500"></i>
          <span class="text-lg font-semibold text-gray-900">试卷预览</span>
          <span class="text-sm text-gray-500" id="previewPaperTitle"></span>
        </div>
        <button onclick="closePreviewModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="flex-1 flex overflow-hidden">
        <div class="flex-1 bg-gray-100 flex flex-col overflow-hidden border-r border-gray-200">
          <div class="flex-shrink-0 px-4 py-3 bg-white border-b border-gray-200">
            <div class="flex items-center space-x-2">
              <i class="fas fa-file-alt text-gray-500"></i>
              <span class="text-sm font-medium text-gray-700" id="previewFileName">试卷文件</span>
            </div>
          </div>
          <div class="flex-1 overflow-hidden" id="previewFileContainer">
            <iframe id="previewPdfFrame" class="w-full h-full hidden" frameborder="0"></iframe>
            <div id="previewWordNotice" class="hidden h-full flex items-center justify-center">
              <div class="text-center">
                <i class="fas fa-file-word text-6xl text-blue-500 mb-4"></i>
                <p class="text-gray-600">Word 文档预览</p>
                <p class="text-sm text-gray-400 mt-2" id="previewWordFileName"></p>
              </div>
            </div>
            <div id="previewNoFile" class="h-full flex items-center justify-center">
              <div class="text-center">
                <i class="fas fa-file-upload text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500">暂无试卷文件</p>
                <p class="text-sm text-gray-400 mt-2">该试卷未上传文件</p>
              </div>
            </div>
          </div>
        </div>
        <div class="w-96 bg-white flex flex-col overflow-hidden">
          <div class="flex-shrink-0 px-4 py-3 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-2">
                <i class="fas fa-clipboard-list text-gray-500"></i>
                <span class="text-sm font-medium text-gray-700">答题卡</span>
              </div>
              <div class="text-sm">
                <span class="text-gray-500">总分：</span>
                <span class="font-bold text-primary-500" id="previewTotalScore">100</span>
                <span class="text-gray-500">分</span>
              </div>
            </div>
          </div>
          <div class="flex-1 overflow-y-auto p-3" id="previewAnswerCard"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== 从 create.html 复制的预览弹窗（抽题模式） ========== -->
  <div id="extractionPreviewModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closeExtractionPreviewModal()"></div>
    <div class="absolute inset-4 bg-white rounded-lg shadow-2xl flex flex-col overflow-hidden">
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
        <div class="flex items-center space-x-3">
          <i class="fas fa-eye text-primary-500"></i>
          <span class="text-lg font-semibold text-gray-900">试卷预览</span>
          <span class="text-sm text-gray-500" id="extractionPreviewModalTitle"></span>
        </div>
        <button onclick="closeExtractionPreviewModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="flex-1 overflow-hidden flex">
        <aside id="extractionPreviewNavigation" class="w-80 bg-white border-r border-gray-200 overflow-y-auto">
          <div id="extractionPreviewNavigationContainer" class="p-6"></div>
        </aside>
        <div id="extractionPreviewScrollContainer" class="flex-1 overflow-y-auto p-8 bg-gray-50">
          <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-sm p-8">
            <div class="text-center mb-8 pb-6 border-b-2 border-gray-300">
              <h1 id="extractionPreviewPaperName" class="text-3xl font-bold text-gray-900 mb-4">试卷名称</h1>
              <div class="flex items-center justify-center space-x-8 text-sm text-gray-600">
                <div><span class="font-medium">试卷编号：</span><span id="extractionPreviewPaperCode">-</span></div>
                <div><span class="font-medium">总分：</span><span id="extractionPreviewTotalScore" class="text-primary-600 font-semibold">0</span><span>分</span></div>
              </div>
            </div>
            <div id="extractionPreviewQuestionsContainer" class="space-y-8"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .extraction-preview-nav-item {
      transition: all 0.2s;
      color: #374151;
      background-color: white;
    }
    .extraction-preview-nav-item.active {
      background-color: #00B96B;
      color: white;
      border-color: #00B96B;
    }
    .extraction-preview-nav-item:hover:not(.active) {
      background-color: #f0fdf4;
      border-color: #00B96B;
    }
  </style>

  <script>
    // 模拟考试数据（根据create.html的数据结构）
    let exams = [
      {
        id: 'E001',
        code: 'E001',
        name: '2026春季期末考试',
        openStartTime: '2026-02-01 08:00',
        openEndTime: '2026-02-01 11:00',
        duration: 120,
        attemptLimit: '1',
        paperIds: ['P001'],
        paperInfo: {
          id: 'P001',
          code: 'DOC2026001',
          name: '计算机基础期末卷',
          mode: 'document',
          questionCount: 50,
          totalScore: 100
        },
        status: 'pending', // pending, ongoing, finished
        totalStudents: 156,
        submittedCount: 0,
        gradedCount: 0,
        onlineCount: 0,
        createTime: '2026-01-20 10:00:00',
        settings: {
          enableLateLimit: true,
          lateMinutes: 15,
          enableFaceRecognition: true,
          resultPublishType: 'afterExamEnd'
        }
      },
      {
        id: 'E002',
        code: 'E002',
        name: '数据结构与算法期中测试',
        openStartTime: '2026-01-28 14:00',
        openEndTime: '2026-01-28 16:30',
        duration: 90,
        attemptLimit: '2',
        paperIds: ['P002'],
        paperInfo: {
          id: 'P002',
          code: 'FIX2026002',
          name: '数据结构固定抽题卷',
          mode: 'extraction',
          questionCount: 30,
          totalScore: 100
        },
        status: 'ongoing',
        totalStudents: 128,
        submittedCount: 85,
        gradedCount: 45,
        onlineCount: 43,
        createTime: '2026-01-22 09:00:00',
        settings: {
          enableLateLimit: true,
          lateMinutes: 10,
          enableRandomCapture: true,
          captureCount: 3,
          resultPublishType: 'immediate'
        }
      },
      {
        id: 'E003',
        code: 'E003',
        name: '操作系统原理期末考试',
        openStartTime: '2026-01-25 09:00',
        openEndTime: '2026-01-25 11:00',
        duration: 120,
        attemptLimit: '1',
        paperIds: ['P003'],
        paperInfo: {
          id: 'P003',
          code: 'RND2026003',
          name: '操作系统随机抽题卷',
          mode: 'random-extraction',
          questionCount: 40,
          totalScore: 100
        },
        status: 'finished',
        totalStudents: 142,
        submittedCount: 138,
        gradedCount: 138,
        onlineCount: 0,
        createTime: '2026-01-18 15:00:00',
        settings: {
          enableLateLimit: false,
          enableFaceRecognition: true,
          enableAIGrading: true,
          resultPublishType: 'delayAfterExamEnd',
          delayDays: 2
        }
      },
      {
        id: 'E004',
        code: 'E004',
        name: 'Python编程基础测验',
        openStartTime: '2026-02-05 10:00',
        openEndTime: '2026-02-05 12:00',
        duration: 90,
        attemptLimit: '0',
        paperIds: ['P004'],
        paperInfo: {
          id: 'P004',
          code: 'DOC2026004',
          name: 'Python编程基础卷',
          mode: 'document',
          questionCount: 35,
          totalScore: 100
        },
        status: 'pending',
        totalStudents: 89,
        submittedCount: 0,
        gradedCount: 0,
        onlineCount: 0,
        createTime: '2026-01-25 16:30:00',
        settings: {
          enableMinSubmitTime: true,
          minSubmitMinutes: 30,
          resultPublishType: 'immediate'
        }
      },
      {
        id: 'E005',
        code: 'E005',
        name: '数据库系统概论期末',
        openStartTime: '2026-01-27 14:00',
        openEndTime: '2026-01-27 17:00',
        duration: 150,
        attemptLimit: '1',
        paperIds: ['P005', 'P006'],
        paperInfo: {
          id: 'P005',
          code: 'DOC2026005',
          name: '数据库系统A卷（含B卷）',
          mode: 'document',
          questionCount: 45,
          totalScore: 100
        },
        status: 'ongoing',
        totalStudents: 175,
        submittedCount: 98,
        gradedCount: 12,
        onlineCount: 77,
        createTime: '2026-01-20 11:00:00',
        settings: {
          enableLateLimit: true,
          lateMinutes: 20,
          enableEarlyEntry: true,
          earlyMinutes: 10,
          resultPublishType: 'delayAfterSubmit',
          delayDays: 1
        }
      },
      {
        id: 'E006',
        code: 'E006',
        name: '计算机网络原理期中考试',
        openStartTime: '2026-01-22 09:00',
        openEndTime: '2026-01-22 11:00',
        duration: 100,
        attemptLimit: '1',
        paperIds: ['P007'],
        paperInfo: {
          id: 'P007',
          code: 'FIX2026007',
          name: '计算机网络固定抽题卷',
          mode: 'extraction',
          questionCount: 38,
          totalScore: 100
        },
        status: 'finished',
        totalStudents: 164,
        submittedCount: 161,
        gradedCount: 161,
        onlineCount: 0,
        createTime: '2026-01-15 14:00:00',
        settings: {
          enableFaceRecognition: true,
          enableRandomCapture: true,
          captureCount: 5,
          resultPublishType: 'afterExamEnd'
        }
      }
    ];

    let filteredExams = [...exams];
    let currentPage = 1;
    const pageSize = 20;
    let deleteTargetId = null; // 待删除的考试ID

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 从 localStorage 读取考试数据并合并
      const savedExams = JSON.parse(localStorage.getItem('exams') || '[]');
      if (savedExams.length > 0) {
        // 合并保存的考试和模拟数据
        exams = [...savedExams, ...exams];
        // 去重（如果有相同ID的考试，保留localStorage中的）
        const examMap = new Map();
        exams.forEach(exam => {
          if (!examMap.has(exam.id)) {
            examMap.set(exam.id, exam);
          }
        });
        exams = Array.from(examMap.values());
      }

      // 按创建时间倒序排列
      exams.sort((a, b) => {
        const timeA = new Date(a.createTime || '2000-01-01 00:00:00').getTime();
        const timeB = new Date(b.createTime || '2000-01-01 00:00:00').getTime();
        return timeB - timeA;
      });

      filteredExams = [...exams];
      renderList();
    });

    // 渲染考试列表
    function renderList() {
      const container = document.getElementById('examList');
      const emptyState = document.getElementById('emptyState');

      // 按创建时间倒序排列（最新的在前面）
      const sortedExams = [...filteredExams].sort((a, b) => {
        const timeA = new Date(a.createTime || '2000-01-01 00:00:00').getTime();
        const timeB = new Date(b.createTime || '2000-01-01 00:00:00').getTime();
        return timeB - timeA;
      });

      // 根据开放时间动态计算考试状态
      const now = new Date();
      sortedExams.forEach(exam => {
        const startTime = new Date(exam.openStartTime);
        const endTime = new Date(exam.openEndTime);

        if (now < startTime) {
          exam.status = 'pending'; // 未开始
        } else if (now >= startTime && now <= endTime) {
          exam.status = 'ongoing'; // 进行中
        } else {
          exam.status = 'finished'; // 已结束
        }
      });

      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageData = sortedExams.slice(start, end);

      if (filteredExams.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
      } else {
        emptyState.classList.add('hidden');
        container.innerHTML = pageData.map(exam => createExamCard(exam)).join('');
      }

      updatePagination();
      document.getElementById('totalItems').textContent = filteredExams.length;
    }

    // 创建考试卡片
    function createExamCard(exam) {
      // 状态映射
      const statusMap = {
        pending: {
          text: '未开始',
          class: 'bg-warning-500 text-white',
          bgClass: 'bg-warning-50',
          borderClass: 'border-warning-200'
        },
        ongoing: {
          text: '进行中',
          class: 'bg-success-500 text-white',
          bgClass: 'bg-success-50',
          borderClass: 'border-success-200'
        },
        finished: {
          text: '已结束',
          class: 'bg-gray-500 text-white',
          bgClass: 'bg-gray-50',
          borderClass: 'border-gray-200'
        }
      };

      const status = statusMap[exam.status] || statusMap.pending;

      // 试卷模式映射
      const modeMap = {
        'document': '文档组卷',
        'extraction': '固定抽题',
        'random-extraction': '随机抽题'
      };

      const paperMode = modeMap[exam.paperInfo.mode] || exam.paperInfo.mode;

      // 处理多个试卷的情况
      let paperDisplayName = '';
      let totalQuestionCount = 0;
      let totalPaperScore = 0;
      let hasMultiplePapers = false;

      if (exam.papers && exam.papers.length > 0) {
        // 有 papers 数组，显示所有试卷
        const paperNames = exam.papers.map(p => p.name).join('、');
        paperDisplayName = paperNames;
        hasMultiplePapers = exam.papers.length > 1;

        // 计算总题数和总分
        exam.papers.forEach(p => {
          totalQuestionCount += p.questionCount || 0;
          totalPaperScore += p.totalScore || 0;
        });
      } else if (exam.paperInfo) {
        // 向后兼容：只有 paperInfo
        paperDisplayName = exam.paperInfo.name;
        totalQuestionCount = exam.paperInfo.questionCount || 0;
        totalPaperScore = exam.paperInfo.totalScore || 0;
      }

      // 完成进度百分比
      const submitProgress = exam.totalStudents > 0 ? Math.round((exam.submittedCount / exam.totalStudents) * 100) : 0;
      const gradeProgress = exam.submittedCount > 0 ? Math.round((exam.gradedCount / exam.submittedCount) * 100) : 0;

      // 判断是否可以删除
      let canDelete = false;
      if (exam.status === 'pending') {
        canDelete = true;
      } else if (exam.status === 'ongoing') {
        canDelete = (exam.submittedCount === 0 && exam.onlineCount === 0);
      } else if (exam.status === 'finished') {
        canDelete = (exam.submittedCount === 0);
      }

      return `
        <div class="exam-card bg-white rounded-lg border border-gray-200 p-5">
          <!-- 顶部信息行 -->
          <div class="flex items-start justify-between mb-4">
            <!-- 左侧：标题和状态 -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-3 mb-2">
                <!-- 考试图标 -->
                <div class="w-7 h-7 rounded-lg ${status.bgClass} border ${status.borderClass} flex items-center justify-center flex-shrink-0">
                  <i class="fas fa-clipboard-check text-sm" style="color: ${exam.status === 'pending' ? '#FF7D00' : exam.status === 'ongoing' ? '#00B42A' : '#6B7280'}"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">${exam.name}</h3>
                <span class="px-2.5 py-0.5 rounded-full text-xs font-medium ${status.class}">
                  ${status.text}
                </span>
              </div>
              <div class="flex items-center gap-4 text-sm text-gray-500">
                <span class="flex items-center gap-1.5">
                  <i class="fas fa-hashtag"></i>
                  ${exam.code}
                </span>
                <span class="flex items-center gap-1.5">
                  <i class="fas fa-file-alt"></i>
                  ${paperDisplayName}
                </span>
                <span class="flex items-center gap-1.5">
                  <i class="fas fa-tag"></i>
                  ${paperMode}
                </span>
              </div>
            </div>

            <!-- 右侧：主要操作按钮 -->
            <div class="flex items-center gap-2 ml-4">
              ${exam.status === 'pending' ? `
                <button onclick="editExam('${exam.id}')" class="px-3 py-1.5 text-sm bg-info-500 hover:bg-info-600 text-white rounded-lg transition-colors flex items-center gap-1.5">
                  <i class="fas fa-edit"></i>
                  <span>编辑</span>
                </button>
                <button onclick="deleteExam('${exam.id}')" class="px-3 py-1.5 text-sm border border-error-500 text-error-500 hover:bg-error-50 rounded-lg transition-colors flex items-center gap-1.5">
                  <i class="fas fa-trash"></i>
                  <span>删除</span>
                </button>
              ` : ''}
              ${exam.status === 'ongoing' ? `
                <button onclick="monitorExam('${exam.id}')" class="px-3 py-1.5 text-sm bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors flex items-center gap-1.5">
                  <i class="fas fa-desktop"></i>
                  <span>监控</span>
                </button>
                ${canDelete ? `
                  <button onclick="deleteExam('${exam.id}')" class="px-3 py-1.5 text-sm border border-error-500 text-error-500 hover:bg-error-50 rounded-lg transition-colors flex items-center gap-1.5">
                    <i class="fas fa-trash"></i>
                    <span>删除</span>
                  </button>
                ` : ''}
              ` : ''}
              ${exam.status === 'finished' ? `
                <button onclick="viewResults('${exam.id}')" class="px-3 py-1.5 text-sm bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors flex items-center gap-1.5">
                  <i class="fas fa-chart-bar"></i>
                  <span>成绩管理</span>
                </button>
                ${canDelete ? `
                  <button onclick="deleteExam('${exam.id}')" class="px-3 py-1.5 text-sm border border-error-500 text-error-500 hover:bg-error-50 rounded-lg transition-colors flex items-center gap-1.5">
                    <i class="fas fa-trash"></i>
                    <span>删除</span>
                  </button>
                ` : ''}
              ` : ''}
            </div>
          </div>

          <!-- 考试信息栏 -->
          <div class="grid grid-cols-4 gap-4 mb-4 pb-4 border-b border-gray-100">
            <div>
              <div class="text-xs text-gray-500 mb-1">开放时间</div>
              <div class="text-sm font-medium text-gray-900">${exam.openStartTime}</div>
              <div class="text-xs text-gray-400">至 ${exam.openEndTime}</div>
            </div>
            <div>
              <div class="text-xs text-gray-500 mb-1">作答时长</div>
              <div class="text-sm font-medium text-gray-900">${exam.duration} 分钟</div>
              <div class="text-xs text-gray-400">
                ${exam.attemptLimit === '0' ? '不限次数' : exam.attemptLimit + ' 次'}
              </div>
            </div>
            <div>
              <div class="text-xs text-gray-500 mb-1">试卷信息</div>
              ${hasMultiplePapers ? `
                ${exam.papers.map(p => `
                  <div class="flex items-center gap-1.5 mb-0.5">
                    <span class="text-xs text-gray-600">${p.name}（${p.questionCount}题/${p.totalScore}分）</span>
                    <button onclick="event.stopPropagation(); previewPaper('${p.id}')" class="text-primary-500 hover:text-primary-600 transition-colors" title="预览${p.name}">
                      <i class="fas fa-eye text-xs"></i>
                    </button>
                  </div>
                `).join('')}
              ` : `
                <div class="flex items-center gap-1.5">
                  <span class="text-sm font-medium text-gray-900">${totalQuestionCount} 题</span>
                  <span class="text-xs text-gray-400">/ 总分 ${totalPaperScore} 分</span>
                  <button onclick="event.stopPropagation(); previewPaper('${exam.paperInfo ? exam.paperInfo.id : (exam.papers ? exam.papers[0].id : '')}')" class="text-primary-500 hover:text-primary-600 transition-colors ml-1" title="预览试卷">
                    <i class="fas fa-eye text-xs"></i>
                  </button>
                </div>
              `}
            </div>
            <div>
              <div class="text-xs text-gray-500 mb-1">考生人数</div>
              <div class="text-sm font-medium text-gray-900">${exam.totalStudents} 人</div>
              ${exam.status === 'ongoing' ? `
                <div class="text-xs text-success-600">在线 ${exam.onlineCount} 人</div>
              ` : ''}
            </div>
          </div>

          <!-- 统计信息和操作按钮 -->
          <div class="flex items-center justify-between">
            <!-- 左侧：统计信息 -->
            <div class="flex items-center gap-6">
              ${exam.status !== 'pending' ? `
                <div class="flex items-center gap-2">
                  <div class="text-sm text-gray-600">
                    <i class="fas fa-paper-plane text-info-500 mr-1"></i>
                    已提交：
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold text-info-600">${exam.submittedCount}</span>
                    <span class="text-xs text-gray-400">/ ${exam.totalStudents}</span>
                    <div class="w-24 h-2 bg-gray-100 rounded-full overflow-hidden">
                      <div class="h-full bg-info-500 rounded-full transition-all" style="width: ${submitProgress}%"></div>
                    </div>
                    <span class="text-xs text-gray-500">${submitProgress}%</span>
                  </div>
                </div>
              ` : ''}
              ${(exam.status === 'ongoing' || exam.status === 'finished') && exam.submittedCount > 0 ? `
                <div class="flex items-center gap-2">
                  <div class="text-sm text-gray-600">
                    <i class="fas fa-check-circle text-success-500 mr-1"></i>
                    已批阅：
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold text-success-600">${exam.gradedCount}</span>
                    <span class="text-xs text-gray-400">/ ${exam.submittedCount}</span>
                    <div class="w-24 h-2 bg-gray-100 rounded-full overflow-hidden">
                      <div class="h-full bg-success-500 rounded-full transition-all" style="width: ${gradeProgress}%"></div>
                    </div>
                    <span class="text-xs text-gray-500">${gradeProgress}%</span>
                  </div>
                </div>
              ` : ''}
            </div>

            <!-- 右侧：次要操作按钮 -->
            <div class="flex items-center gap-2">
              <button onclick="viewConfig('${exam.id}')" class="px-3 py-1.5 text-sm text-gray-700 hover:text-purple-600 hover:bg-purple-50 border border-gray-300 hover:border-purple-500 rounded-lg transition-colors flex items-center gap-1.5">
                <i class="fas fa-cog"></i>
                <span>查看配置</span>
              </button>
              <button onclick="manageStudents('${exam.id}')" class="px-3 py-1.5 text-sm text-gray-700 hover:text-primary-600 hover:bg-primary-50 border border-gray-300 hover:border-primary-500 rounded-lg transition-colors flex items-center gap-1.5">
                <i class="fas fa-users"></i>
                <span>考生管理</span>
              </button>
              ${exam.status === 'ongoing' || exam.status === 'finished' ? `
                <button onclick="manageGrading('${exam.id}')" class="px-3 py-1.5 text-sm text-gray-700 hover:text-warning-600 hover:bg-warning-50 border border-gray-300 hover:border-warning-500 rounded-lg transition-colors flex items-center gap-1.5">
                  <i class="fas fa-tasks"></i>
                  <span>阅卷管理</span>
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    // 分页相关
    function updatePagination() {
      const totalPages = Math.ceil(filteredExams.length / pageSize) || 1;
      document.getElementById('currentPage').textContent = currentPage;
      document.getElementById('totalPages').textContent = totalPages;

      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage === totalPages;
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderList();
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(filteredExams.length / pageSize);
      if (currentPage < totalPages) {
        currentPage++;
        renderList();
      }
    }

    // 筛选功能
    function filterExams() {
      const searchText = document.getElementById('searchInput').value.toLowerCase();
      const status = document.getElementById('filterStatus').value;

      filteredExams = exams.filter(exam => {
        const matchSearch = !searchText || exam.name.toLowerCase().includes(searchText);
        const matchStatus = !status || exam.status === status;
        return matchSearch && matchStatus;
      });

      currentPage = 1;
      renderList();
    }

    function resetFilter() {
      document.getElementById('searchInput').value = '';
      document.getElementById('filterStatus').value = '';
      filteredExams = [...exams];
      currentPage = 1;
      renderList();
    }

    // 考试操作功能
    function editExam(id) {
      const exam = exams.find(e => e.id === id);
      if (exam) {
        // 跳转到创建页面，传递考试ID进入编辑模式
        window.location.href = `create.html?id=${id}&mode=edit`;
      }
    }

    function deleteExam(id) {
      const exam = exams.find(e => e.id === id);
      if (!exam) {
        showMessage('考试不存在', 'error');
        return;
      }

      // 根据开放时间计算当前状态
      const now = new Date();
      const startTime = new Date(exam.openStartTime);
      const endTime = new Date(exam.openEndTime);
      let currentStatus = '';

      if (now < startTime) {
        currentStatus = 'pending'; // 未开始
      } else if (now >= startTime && now <= endTime) {
        currentStatus = 'ongoing'; // 进行中
      } else {
        currentStatus = 'finished'; // 已结束
      }

      // 检查删除条件
      let canDelete = false;
      let errorMessage = '';

      if (currentStatus === 'pending') {
        // 未开始：可以删除
        canDelete = true;
      } else if (currentStatus === 'ongoing') {
        // 进行中：检查是否有学生在线或已提交
        if (exam.onlineCount > 0) {
          errorMessage = `该考试正在进行中，当前有 ${exam.onlineCount} 名学生在线考试，无法删除！`;
        } else if (exam.submittedCount > 0) {
          errorMessage = `该考试已有 ${exam.submittedCount} 名学生提交试卷，无法删除！`;
        } else {
          canDelete = true;
        }
      } else if (currentStatus === 'finished') {
        // 已结束：检查是否有学生提交
        if (exam.submittedCount > 0) {
          errorMessage = `该考试已有 ${exam.submittedCount} 名学生提交试卷，无法删除！`;
        } else {
          canDelete = true;
        }
      }

      // 如果不能删除，显示错误信息
      if (!canDelete) {
        showMessage(errorMessage, 'warning');
        return;
      }

      // 显示删除确认模态框
      deleteTargetId = id;
      document.getElementById('deleteExamName').textContent = `"${exam.name}"`;
      document.getElementById('deleteConfirmModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // 关闭删除确认模态框
    function closeDeleteConfirmModal() {
      document.getElementById('deleteConfirmModal').classList.add('hidden');
      document.body.style.overflow = '';
      deleteTargetId = null;
    }

    // 确认删除考试
    function confirmDeleteExam() {
      if (!deleteTargetId) return;

      exams = exams.filter(e => e.id !== deleteTargetId);
      filteredExams = filteredExams.filter(e => e.id !== deleteTargetId);

      // 同步删除 localStorage 中的数据
      const savedExams = JSON.parse(localStorage.getItem('exams') || '[]');
      const updatedExams = savedExams.filter(e => e.id !== deleteTargetId);
      localStorage.setItem('exams', JSON.stringify(updatedExams));

      // 关闭模态框
      closeDeleteConfirmModal();

      // 刷新列表
      renderList();
      showMessage('删除成功', 'success');
    }

    function monitorExam(id) {
      const exam = exams.find(e => e.id === id);
      if (exam) {
        showMessage(`正在打开"${exam.name}"的监控面板...`, 'info');
        // 实际应用中：打开监控页面
      }
    }

    function viewResults(id) {
      const exam = exams.find(e => e.id === id);
      if (exam) {
        showMessage(`正在打开"${exam.name}"的成绩管理页面...`, 'info');
        // 实际应用中：window.location.href = `results.html?examId=${id}`;
      }
    }

    function manageStudents(id) {
      const exam = exams.find(e => e.id === id);
      if (exam) {
        showMessage(`正在打开"${exam.name}"的考生管理页面...`, 'info');
        // 实际应用中：打开考生管理页面
      }
    }

    function manageGrading(id) {
      const exam = exams.find(e => e.id === id);
      if (exam) {
        showMessage(`正在打开"${exam.name}"的阅卷管理页面...`, 'info');
        // 实际应用中：打开阅卷管理页面
      }
    }

    // 查看考试配置
    function viewConfig(id) {
      const exam = exams.find(e => e.id === id);
      if (!exam || !exam.settings) {
        showMessage('未找到考试配置信息', 'warning');
        return;
      }

      const settings = exam.settings;
      let configHTML = '';

      // 迟到设置
      configHTML += `
        <div class="bg-gray-50 rounded-lg p-4">
          <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
            <i class="fas fa-clock text-warning-500 mr-2"></i>
            迟到设置
          </h4>
          <div class="space-y-2 text-sm">
      `;

      const lateSettings = [];
      if (settings.enableLateLimit) {
        lateSettings.push(`开考后 ${settings.lateMinutes || 15} 分钟后禁止进入`);
      }
      if (settings.enableEarlyEntry) {
        lateSettings.push(`提前 ${settings.earlyMinutes || 10} 分钟可进入`);
      }

      if (lateSettings.length > 0) {
        lateSettings.forEach(text => {
          configHTML += `<div class="flex items-center"><i class="fas fa-check text-success-500 mr-2"></i><span class="text-gray-700">${text}</span></div>`;
        });
      } else {
        configHTML += `<div class="text-gray-500">未设置迟到限制</div>`;
      }

      configHTML += `</div></div>`;

      // 防作弊设置
      configHTML += `
        <div class="bg-gray-50 rounded-lg p-4">
          <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
            <i class="fas fa-shield-alt text-error-500 mr-2"></i>
            防作弊设置
          </h4>
          <div class="space-y-2 text-sm">
      `;

      const antiCheatSettings = [];
      if (settings.enableFaceRecognition) {
        antiCheatSettings.push('人脸识别验证');
      }
      if (settings.enableRandomCapture) {
        antiCheatSettings.push(`随机抓拍 ${settings.captureCount || 3} 张照片`);
      }

      if (antiCheatSettings.length > 0) {
        antiCheatSettings.forEach(text => {
          configHTML += `<div class="flex items-center"><i class="fas fa-check text-success-500 mr-2"></i><span class="text-gray-700">${text}</span></div>`;
        });
      } else {
        configHTML += `<div class="text-gray-500">未启用防作弊功能</div>`;
      }

      configHTML += `</div></div>`;

      // 交卷限制
      configHTML += `
        <div class="bg-gray-50 rounded-lg p-4">
          <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
            <i class="fas fa-paper-plane text-info-500 mr-2"></i>
            交卷限制
          </h4>
          <div class="space-y-2 text-sm">
      `;

      if (settings.enableMinSubmitTime) {
        configHTML += `<div class="flex items-center"><i class="fas fa-check text-success-500 mr-2"></i><span class="text-gray-700">作答至少 ${settings.minSubmitMinutes || 30} 分钟后才可交卷</span></div>`;
      } else {
        configHTML += `<div class="text-gray-500">无交卷时间限制</div>`;
      }

      configHTML += `</div></div>`;

      // 成绩公布设置
      configHTML += `
        <div class="bg-gray-50 rounded-lg p-4">
          <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
            <i class="fas fa-chart-line text-success-500 mr-2"></i>
            成绩公布设置
          </h4>
          <div class="space-y-3 text-sm">
      `;

      // 公布方式
      const resultTypeMap = {
        'immediate': '交卷后立即公布',
        'delayAfterSubmit': `交卷后 ${settings.delayDaysAfterSubmit || 1} 天公布`,
        'afterExamEnd': '考试结束后立即公布',
        'delayAfterExamEnd': `考试结束后 ${settings.delayDaysAfterExamEnd || 1} 天公布`
      };
      const resultTypeText = resultTypeMap[settings.resultPublishType] || '未设置';
      configHTML += `
        <div>
          <div class="text-gray-500 mb-1">公布方式：</div>
          <div class="flex items-center"><i class="fas fa-calendar-check text-primary-500 mr-2"></i><span class="text-gray-700">${resultTypeText}</span></div>
        </div>
      `;

      // 公布内容
      const resultContentMap = {
        'scoreOnly': '仅分数',
        'scoreAndCorrect': '分数及对错',
        'full': '分数、对错、答案及解析'
      };
      const resultContentText = resultContentMap[settings.resultContent] || '仅分数';
      configHTML += `
        <div>
          <div class="text-gray-500 mb-1">公布内容：</div>
          <div class="flex items-center"><i class="fas fa-list-ul text-primary-500 mr-2"></i><span class="text-gray-700">${resultContentText}</span></div>
        </div>
      `;

      configHTML += `</div></div>`;

      // AI批阅设置
      configHTML += `
        <div class="bg-gray-50 rounded-lg p-4">
          <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
            <i class="fas fa-robot text-purple-500 mr-2"></i>
            AI批阅设置
          </h4>
          <div class="space-y-2 text-sm">
      `;

      const aiSettings = [];
      if (settings.enableAIGrading) {
        aiSettings.push('AI自动批阅');
      }
      if (settings.enableAIComment) {
        aiSettings.push('AI生成评语');
      }

      if (aiSettings.length > 0) {
        aiSettings.forEach(text => {
          configHTML += `<div class="flex items-center"><i class="fas fa-check text-success-500 mr-2"></i><span class="text-gray-700">${text}</span></div>`;
        });
      } else {
        configHTML += `<div class="text-gray-500">未启用AI批阅功能</div>`;
      }

      configHTML += `</div></div>`;

      // 显示配置
      document.getElementById('configContent').innerHTML = configHTML;
      document.getElementById('configModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // 关闭配置模态框
    function closeConfigModal() {
      document.getElementById('configModal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    // 点击遮罩层关闭模态框
    document.addEventListener('click', function(e) {
      const configModal = document.getElementById('configModal');
      if (e.target === configModal) {
        closeConfigModal();
      }

      const deleteConfirmModal = document.getElementById('deleteConfirmModal');
      if (e.target === deleteConfirmModal) {
        closeDeleteConfirmModal();
      }
    });

    // ========== 从 create.html 复用的试卷预览功能 ==========

    // 从 localStorage 读取所有试卷数据
    let allPapers = JSON.parse(localStorage.getItem('allPapers') || '[]');
    let previewPaperId = null;

    // 题型配置
    const questionTypeConfig = {
      single: { name: '单选题', icon: 'fa-dot-circle', options: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'] },
      multiple: { name: '多选题', icon: 'fa-check-double', options: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'] },
      judge: { name: '判断题', icon: 'fa-check-circle', options: ['正确', '错误'] },
      blank: { name: '填空题', icon: 'fa-keyboard', options: [] },
      essay: { name: '简答题', icon: 'fa-align-left', options: [] },
      cloze: { name: '完形填空', icon: 'fa-puzzle-piece', options: [] },
      composite: { name: '复合题', icon: 'fa-layer-group', options: [] }
    };

    // 子题型配置
    const subQuestionTypes = {
      single: { name: '单选', options: ['A', 'B', 'C', 'D', 'E', 'F'] },
      multiple: { name: '多选', options: ['A', 'B', 'C', 'D', 'E', 'F'] },
      judge: { name: '判断', options: ['正确', '错误'] },
      blank: { name: '填空', options: [] },
      essay: { name: '简答', options: [] }
    };

    // 类型标准化
    function normalizeType(type) {
      const typeMap = {
        'essay': 'shortAnswer',
        'short': 'shortAnswer',
        'shortanswer': 'shortAnswer'
      };
      return typeMap[type?.toLowerCase()] || type;
    }

    // 预览试卷（主函数）
    function previewPaper(id) {
      const paper = allPapers.find(p => p.id === id);
      if (!paper) {
        showMessage('试卷不存在', 'warning');
        return;
      }

      // 抽题模式：使用弹窗预览
      if (paper.mode === 'extraction' || paper.mode === 'random') {
        // 保存当前预览的试卷ID
        previewPaperId = id;

        // 设置预览弹窗标题
        document.getElementById('extractionPreviewModalTitle').textContent = paper.name || '未命名试卷';
        document.getElementById('extractionPreviewPaperName').textContent = paper.name || '未命名试卷';
        document.getElementById('extractionPreviewPaperCode').textContent = paper.code || '暂无';

        // 判断是随机抽题还是固定抽题
        if (paper.extractionType === 'random' && paper.randomRules) {
          // 随机抽题：隐藏左侧导航栏
          document.getElementById('extractionPreviewNavigation').classList.add('hidden');

          // 显示抽题规则说明
          document.getElementById('extractionPreviewTotalScore').textContent = paper.totalScore || 100;
          renderRandomExtractionRulesPreview(paper.randomRules, paper.totalScore || 100);
        } else {
          // 固定抽题：显示左侧导航栏
          document.getElementById('extractionPreviewNavigation').classList.remove('hidden');

          // 计算并设置总分
          let totalScore = 0;
          (paper.questions || []).forEach(q => {
            totalScore += parseFloat(q.paperScore) || 0;
          });
          document.getElementById('extractionPreviewTotalScore').textContent = totalScore;

          // 渲染题目列表
          renderExtractionPreviewQuestions(paper.questions || []);
        }

        // 显示弹窗
        document.getElementById('extractionPreviewModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        return;
      }

      // 文档模式：在弹窗中预览
      // 保存当前预览的试卷ID
      previewPaperId = id;

      // 设置标题
      document.getElementById('previewPaperTitle').textContent = paper.name || paper.title || '未命名试卷';
      document.getElementById('previewTotalScore').textContent = paper.totalScore || 100;

      // 设置文件预览
      const pdfFrame = document.getElementById('previewPdfFrame');
      const wordNotice = document.getElementById('previewWordNotice');
      const noFile = document.getElementById('previewNoFile');

      // 先隐藏所有
      pdfFrame.classList.add('hidden');
      wordNotice.classList.add('hidden');
      noFile.classList.add('hidden');

      if (paper.file && paper.file.data) {
        document.getElementById('previewFileName').textContent = paper.file.name;
        const isPDF = paper.file.type === 'application/pdf';

        if (isPDF) {
          pdfFrame.src = paper.file.data;
          pdfFrame.classList.remove('hidden');
        } else {
          document.getElementById('previewWordFileName').textContent = paper.file.name;
          wordNotice.classList.remove('hidden');
        }
      } else {
        document.getElementById('previewFileName').textContent = '试卷文件';
        noFile.classList.remove('hidden');
      }

      // 渲染答题卡预览
      renderPreviewAnswerCard(paper.answerCard);

      // 显示弹窗
      document.getElementById('previewModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // 渲染预览答题卡
    function renderPreviewAnswerCard(answerCard) {
      const container = document.getElementById('previewAnswerCard');
      container.innerHTML = '';

      if (!answerCard || Object.keys(answerCard).length === 0) {
        container.innerHTML = '<div class="text-center text-gray-400 py-8"><i class="fas fa-inbox text-3xl mb-2"></i><p>暂无答题卡数据</p></div>';
        return;
      }

      const typeOrder = ['single', 'multiple', 'judge', 'blank', 'essay', 'composite'];

      typeOrder.forEach(type => {
        if (!answerCard[type]) return;

        const config = questionTypeConfig[type];
        const data = answerCard[type];
        const questions = data.questions || [];

        if (questions.length === 0) return;

        const typeSection = document.createElement('div');
        typeSection.className = 'mb-3 bg-white rounded-lg border border-gray-200';

        if (type === 'composite') {
          // 复合题预览
          const totalSubQuestions = questions.reduce((sum, q) => sum + (q.subQuestions?.length || 0), 0);
          const totalScore = questions.reduce((sum, q) => {
            return sum + (q.subQuestions?.reduce((subSum, sq) => subSum + (sq.score || 0), 0) || 0);
          }, 0);

          typeSection.innerHTML = `
            <div class="flex items-center justify-between px-3 py-2 bg-gray-50 border-b border-gray-200 rounded-t-lg">
              <div class="flex items-center space-x-1.5">
                <i class="fas ${config.icon} text-gray-600 text-xs"></i>
                <span class="font-medium text-gray-900 text-xs">${config.name}</span>
                <span class="text-xs text-gray-500">共 <span class="font-bold text-gray-900">${questions.length}</span> 大题 <span class="font-bold text-gray-900">${totalSubQuestions}</span> 小题，共 <span class="font-bold text-red-500">${totalScore}</span> 分</span>
              </div>
            </div>
            <div class="py-1">
              ${questions.map((q, qIndex) => renderPreviewCompositeQuestion(q, qIndex)).join('')}
            </div>
          `;
        } else {
          // 普通题型预览
          const questionCount = questions.length;
          const totalScore = questions.reduce((sum, q) => sum + (q.score || 0), 0);

          typeSection.innerHTML = `
            <div class="flex items-center justify-between px-3 py-2 bg-gray-50 border-b border-gray-200 rounded-t-lg">
              <div class="flex items-center space-x-1.5">
                <i class="fas ${config.icon} text-gray-600 text-xs"></i>
                <span class="font-medium text-gray-900 text-xs">${config.name}</span>
                <span class="text-xs text-gray-500">共 <span class="font-bold text-gray-900">${questionCount}</span> 题，共 <span class="font-bold text-red-500">${totalScore}</span> 分</span>
              </div>
            </div>
            <div class="space-y-0.5 py-1">
              ${questions.map((q, index) => renderPreviewQuestion(type, q, index)).join('')}
            </div>
          `;
        }

        container.appendChild(typeSection);
      });
    }

    // 渲染预览普通题目
    function renderPreviewQuestion(type, q, index) {
      const config = questionTypeConfig[type];
      let answerHtml = '';

      if (config.options.length > 0) {
        // 有选项的题型
        const answers = Array.isArray(q.answer) ? q.answer : (q.answer ? [q.answer] : []);
        let currentOptions = q.customOptions || config.options;

        answerHtml = `
          <div class="flex items-center flex-wrap gap-1 flex-1">
            ${currentOptions.map(opt => `
              <span class="px-2 py-0.5 border rounded text-xs font-medium ${answers.includes(opt) ? 'bg-blue-500 text-white border-blue-500' : 'border-gray-300 text-gray-600'}">
                ${opt}
              </span>
            `).join('')}
          </div>
        `;
      } else if (type === 'essay') {
        answerHtml = `<div class="flex-1 text-xs text-gray-400">（主观题）</div>`;
      } else {
        // 填空题
        answerHtml = `
          <div class="flex-1 px-2 py-0.5 bg-gray-100 rounded text-xs text-gray-700">
            ${q.answer || '<span class="text-gray-400">未设置答案</span>'}
          </div>
        `;
      }

      // 答案解析
      const explanationHtml = q.explanation ? `
        <div class="px-2 pb-2 ml-6">
          <div class="bg-yellow-50 border border-yellow-200 rounded p-2">
            <div class="flex items-center space-x-1 text-xs text-yellow-700 mb-1">
              <i class="fas fa-lightbulb"></i>
              <span class="font-medium">答案解析</span>
            </div>
            <div class="text-xs text-gray-700">${q.explanation}</div>
          </div>
        </div>
      ` : '';

      return `
        <div>
          <div class="flex items-start space-x-1.5 px-2 py-1 text-xs">
            <span class="font-semibold text-gray-700 min-w-[20px]">${index + 1}.</span>
            <span class="text-gray-500 min-w-[40px]">${q.score || 0}分</span>
            ${answerHtml}
          </div>
          ${explanationHtml}
        </div>
      `;
    }

    // 渲染预览复合题
    function renderPreviewCompositeQuestion(q, qIndex) {
      const totalScore = (q.subQuestions || []).reduce((sum, sq) => sum + (sq.score || 0), 0);

      return `
        <div class="border border-gray-200 rounded-lg mx-2 mb-2 bg-white">
          <div class="flex items-center justify-between px-3 py-2 bg-blue-50 border-b border-gray-200 rounded-t-lg">
            <div class="flex items-center space-x-2">
              <span class="font-semibold text-gray-900 text-sm">第 ${qIndex + 1} 大题</span>
              <span class="text-xs text-gray-500">（共 <span class="font-bold text-gray-900">${(q.subQuestions || []).length}</span> 小题，共 <span class="font-bold text-red-500">${totalScore}</span> 分）</span>
            </div>
          </div>
          <div class="p-2 space-y-1">
            ${(q.subQuestions || []).map((sq, sqIndex) => renderPreviewSubQuestion(sq, sqIndex)).join('')}
          </div>
        </div>
      `;
    }

    // 渲染预览子题目
    function renderPreviewSubQuestion(sq, sqIndex) {
      const subConfig = subQuestionTypes[sq.type] || { name: '未知', options: [] };
      let answerHtml = '';

      if (subConfig.options.length > 0) {
        // 有选项的题型
        const answers = Array.isArray(sq.answer) ? sq.answer : (sq.answer ? [sq.answer] : []);
        let currentOptions = sq.customOptions || subConfig.options;

        answerHtml = `
          <div class="flex items-center flex-wrap gap-1 flex-1">
            ${currentOptions.map(opt => `
              <span class="px-2 py-0.5 border rounded text-xs font-medium ${answers.includes(opt) ? 'bg-blue-500 text-white border-blue-500' : 'border-gray-300 text-gray-600'}">
                ${opt}
              </span>
            `).join('')}
          </div>
        `;
      } else if (sq.type === 'essay') {
        answerHtml = `<div class="flex-1 text-xs text-gray-400">（主观题）</div>`;
      } else {
        // 填空题
        answerHtml = `
          <div class="flex-1 px-2 py-0.5 bg-gray-100 rounded text-xs text-gray-700">
            ${sq.answer || '<span class="text-gray-400">未设置答案</span>'}
          </div>
        `;
      }

      // 答案解析
      const explanationHtml = sq.explanation ? `
        <div class="mt-1 ml-8">
          <div class="bg-yellow-50 border border-yellow-200 rounded p-2">
            <div class="flex items-center space-x-1 text-xs text-yellow-700 mb-1">
              <i class="fas fa-lightbulb"></i>
              <span class="font-medium">答案解析</span>
            </div>
            <div class="text-xs text-gray-700">${sq.explanation}</div>
          </div>
        </div>
      ` : '';

      return `
        <div class="bg-gray-50 rounded p-2">
          <div class="flex items-start space-x-1.5 text-xs">
            <span class="font-semibold text-gray-700 min-w-[32px]">(${sqIndex + 1})</span>
            <span class="px-1.5 py-0.5 bg-gray-200 rounded text-gray-600 text-xs">${subConfig.name}</span>
            <span class="text-gray-500 min-w-[40px]">${sq.score || 0}分</span>
            ${answerHtml}
          </div>
          ${explanationHtml}
        </div>
      `;
    }

    // 渲染随机抽题规则预览
    function renderRandomExtractionRulesPreview(randomRules, totalScore) {
      // 只替换题目容器，不破坏整个 modal 结构
      const container = document.getElementById('extractionPreviewQuestionsContainer');

      // 题型配置
      const typeConfig = {
        single: { name: '单选题', icon: 'fa-dot-circle', color: 'info' },
        multiple: { name: '多选题', icon: 'fa-check-double', color: 'purple' },
        judge: { name: '判断题', icon: 'fa-check-circle', color: 'success' },
        blank: { name: '填空题', icon: 'fa-keyboard', color: 'warning' },
        cloze: { name: '完形填空', icon: 'fa-puzzle-piece', color: 'indigo' },
        short: { name: '简答题', icon: 'fa-align-left', color: 'amber' },
        composite: { name: '复合题', icon: 'fa-layer-group', color: 'purple' }
      };

      let html = `
        <div class="flex items-center gap-3 mb-6">
          <div class="w-12 h-12 bg-purple-50 rounded-lg flex items-center justify-center">
            <i class="fas fa-random text-purple-600 text-xl"></i>
          </div>
          <div>
            <h2 class="text-xl font-bold text-gray-900">随机抽题模式</h2>
            <p class="text-sm text-gray-500 mt-1">每次考试从题库中随机抽取题目，保证试卷多样性</p>
          </div>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
          <div class="flex items-start gap-3">
            <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
            <div class="flex-1 text-sm text-blue-800">
              <div class="font-medium mb-1">预览说明</div>
                  <div>随机抽题模式的试卷在每次考试时才会随机生成，因此无法预览具体题目。下方展示的是抽题规则配置。</div>
                </div>
              </div>
            </div>

            <div class="space-y-4">
              <div class="flex items-center justify-between py-3 border-b border-gray-200">
                <span class="text-sm font-medium text-gray-700">试卷总分</span>
                <span class="text-lg font-bold text-primary-600">${totalScore} 分</span>
              </div>
      `;

      // 全局筛选条件
      if (randomRules.globalFilters) {
        const filters = randomRules.globalFilters;

        html += `
          <div class="py-3 border-b border-gray-200">
            <div class="text-sm font-medium text-gray-700 mb-2">全局筛选条件</div>
            <div class="flex flex-wrap gap-2">
        `;

        // 难度筛选
        if (filters.difficulties && filters.difficulties.length > 0) {
          const difficultyNames = {1: '一级', 2: '二级', 3: '三级', 4: '四级', 5: '五级'};
          filters.difficulties.forEach(d => {
            html += `<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">难度：${difficultyNames[d] || d}</span>`;
          });
        }

        // 知识点筛选
        if (filters.knowledgeIds && filters.knowledgeIds.length > 0) {
          html += `<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">已选 ${filters.knowledgeIds.length} 个知识点</span>`;
        }

        html += `
            </div>
          </div>
        `;
      }

      // 题型抽取规则
      html += `
        <div class="py-3">
          <div class="text-sm font-medium text-gray-700 mb-3">题型抽取规则</div>
          <div class="space-y-3">
      `;

      const typeRules = randomRules.typeRules || {};
      Object.entries(typeRules).forEach(([type, rule]) => {
        if (rule.count > 0) {
          const config = typeConfig[type] || { name: '未知题型', icon: 'fa-question', color: 'gray' };
          const scoreModeText = rule.scoreMode === 'custom' ? `自设分数：${rule.customScore}分/题` : '题库分数';
          const totalTypeScore = rule.scoreMode === 'custom' ? (rule.count * rule.customScore).toFixed(1) : '根据题库';

          // 根据题型设置颜色类（固定类名以支持Tailwind）
          let bgClass = 'bg-gray-50';
          let iconColorClass = 'text-gray-600';
          if (config.color === 'info') {
            bgClass = 'bg-blue-50';
            iconColorClass = 'text-blue-600';
          } else if (config.color === 'purple') {
            bgClass = 'bg-purple-50';
            iconColorClass = 'text-purple-600';
          } else if (config.color === 'success') {
            bgClass = 'bg-green-50';
            iconColorClass = 'text-green-600';
          } else if (config.color === 'warning') {
            bgClass = 'bg-orange-50';
            iconColorClass = 'text-orange-600';
          } else if (config.color === 'indigo') {
            bgClass = 'bg-indigo-50';
            iconColorClass = 'text-indigo-600';
          } else if (config.color === 'amber') {
            bgClass = 'bg-amber-50';
            iconColorClass = 'text-amber-600';
          }

          html += `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 ${bgClass} rounded-lg flex items-center justify-center">
                  <i class="fas ${config.icon} ${iconColorClass}"></i>
                </div>
                <div>
                  <div class="font-medium text-gray-900">${config.name}</div>
                  <div class="text-xs text-gray-500">${scoreModeText}</div>
                </div>
              </div>
              <div class="text-right">
                <div class="text-sm font-medium text-gray-900">${rule.count} 题</div>
                <div class="text-xs text-gray-500">${totalTypeScore}${rule.scoreMode === 'custom' ? ' 分' : ''}</div>
              </div>
            </div>
          `;
        }
      });

      html += `
          </div>
        </div>
      `;

      html += `
        </div>

        <div class="mt-6 flex items-center justify-center">
          <button onclick="closeExtractionPreviewModal()" class="px-6 py-2.5 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg text-sm font-medium transition-colors">
            <i class="fas fa-times mr-2"></i>关闭预览
          </button>
        </div>
      `;

      container.innerHTML = html;
    }

    // 渲染抽题预览题目
    function renderExtractionPreviewQuestions(questions) {
      const container = document.getElementById('extractionPreviewQuestionsContainer');
      const navContainer = document.getElementById('extractionPreviewNavigationContainer');

      // 按题型分组题目
      const questionsByType = {};
      questions.forEach(data => {
        const q = data.question || data;
        const normalizedType = normalizeType(q.type);
        if (!questionsByType[normalizedType]) {
          questionsByType[normalizedType] = [];
        }
        questionsByType[normalizedType].push(data);
      });

      // 题型顺序
      const typeOrder = ['single', 'multiple', 'judge', 'blank', 'cloze', 'shortAnswer', 'composite'];

      let html = '';
      let navHtml = '';
      let globalQuestionNumber = 1;
      let navQuestions = [];

      typeOrder.forEach(type => {
        if (!questionsByType[type] || questionsByType[type].length === 0) return;

        const typeConfig = questionTypeConfig[type] || { name: '未知题型' };
        const typeQuestions = questionsByType[type];

        html += `
          <div class="question-type-section">
            <h2 class="text-xl font-bold text-gray-800 mb-6 pb-2 border-b-2 border-primary-500">
              ${typeConfig.name}（共 ${typeQuestions.length} 题）
            </h2>
            <div class="space-y-6">
        `;

        typeQuestions.forEach(data => {
          const q = data.question || data;
          const score = data.paperScore || 0;
          const questionId = `extraction-preview-question-${globalQuestionNumber}`;

          navQuestions.push({
            number: globalQuestionNumber,
            type: typeConfig.name,
            id: questionId
          });

          html += `
            <div class="question-item" id="${questionId}">
              <div class="flex items-start space-x-3 mb-3">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary-500 text-white flex items-center justify-center font-semibold text-sm">
                  ${globalQuestionNumber}
                </div>
                <div class="flex-1">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-2">
                      <span class="text-sm text-gray-500">${typeConfig.name}</span>
                      ${q.knowledgePath ? `<span class="text-xs text-gray-400">· ${q.knowledgePath}</span>` : ''}
                    </div>
                    <span class="text-sm font-medium text-primary-600">${score} 分</span>
                  </div>
                  <div class="question-content text-gray-900 text-base leading-relaxed mb-3">
                    ${q.content}
                  </div>
          `;

          // 根据题型显示选项和答案
          if (type === 'single' || type === 'multiple') {
            html += '<div class="space-y-2 ml-4">';
            if (q.options && q.options.length > 0) {
              q.options.forEach(opt => {
                const isCorrect = q.correctAnswers && q.correctAnswers.includes(opt.label);
                html += `
                  <div class="flex items-start space-x-2">
                    <span class="font-medium ${isCorrect ? 'text-green-600' : 'text-gray-600'}">${opt.label}.</span>
                    <span class="${isCorrect ? 'text-green-600 font-medium' : 'text-gray-700'}">${opt.text}</span>
                  </div>
                `;
              });
            }
            html += '</div>';

            if (q.correctAnswers && q.correctAnswers.length > 0) {
              html += `
                <div class="mt-3 p-3 bg-green-50 rounded-lg">
                  <span class="text-sm font-medium text-green-700">答案：</span>
                  <span class="text-sm text-green-600">${q.correctAnswers.join('、')}</span>
                </div>
              `;
            }
          } else if (type === 'judge') {
            if (q.correctAnswers && q.correctAnswers.length > 0) {
              html += `
                <div class="mt-3 p-3 bg-green-50 rounded-lg">
                  <span class="text-sm font-medium text-green-700">答案：</span>
                  <span class="text-sm text-green-600">${q.correctAnswers[0]}</span>
                </div>
              `;
            }
          } else if (type === 'blank') {
            if (q.correctAnswers && q.correctAnswers.length > 0) {
              html += `
                <div class="mt-3 p-3 bg-green-50 rounded-lg">
                  <span class="text-sm font-medium text-green-700">答案：</span>
                  <span class="text-sm text-green-600">${q.correctAnswers.map((ans, idx) => `空${idx + 1}：${ans}`).join('；')}</span>
                </div>
              `;
            }
          } else if (type === 'cloze') {
            if (q.blanks && q.blanks.length > 0) {
              html += '<div class="space-y-3 ml-4 mt-3">';
              q.blanks.forEach((blank, blankIndex) => {
                html += `
                  <div>
                    <div class="font-medium text-gray-700 mb-2">空 ${blankIndex + 1}：</div>
                    <div class="space-y-1 ml-4">
                `;
                if (blank.options && blank.options.length > 0) {
                  blank.options.forEach(opt => {
                    const isCorrect = blank.correctAnswer === opt.label;
                    html += `
                      <div class="flex items-start space-x-2">
                        <span class="font-medium ${isCorrect ? 'text-green-600' : 'text-gray-600'}">${opt.label}.</span>
                        <span class="${isCorrect ? 'text-green-600 font-medium' : 'text-gray-700'}">${opt.text}</span>
                      </div>
                    `;
                  });
                }
                html += `
                    </div>
                    <div class="mt-2 p-2 bg-green-50 rounded text-sm">
                      <span class="font-medium text-green-700">答案：</span>
                      <span class="text-green-600">${blank.correctAnswer}</span>
                    </div>
                  </div>
                `;
              });
              html += '</div>';
            }
          } else if (type === 'shortAnswer') {
            if (q.correctAnswers && q.correctAnswers.length > 0 && q.correctAnswers[0]) {
              html += `
                <div class="mt-3 p-3 bg-green-50 rounded-lg">
                  <div class="text-sm font-medium text-green-700 mb-2">参考答案：</div>
                  <div class="text-sm text-green-600 whitespace-pre-wrap">${q.correctAnswers[0]}</div>
                </div>
              `;
            }
          } else if (type === 'composite') {
            if (q.subQuestions && q.subQuestions.length > 0) {
              html += '<div class="mt-4 space-y-4">';
              q.subQuestions.forEach((sub, subIndex) => {
                const subType = normalizeType(sub.type);
                html += `
                  <div class="ml-6 p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                      <div class="font-medium text-gray-800">${globalQuestionNumber}.${subIndex + 1} ${sub.content}</div>
                    </div>
                `;

                if (subType === 'single' || subType === 'multiple') {
                  html += '<div class="space-y-1 ml-4 mt-2">';
                  if (sub.options && sub.options.length > 0) {
                    sub.options.forEach(opt => {
                      const isCorrect = sub.correctAnswers && sub.correctAnswers.includes(opt.label);
                      html += `
                        <div class="flex items-start space-x-2">
                          <span class="font-medium ${isCorrect ? 'text-green-600' : 'text-gray-600'}">${opt.label}.</span>
                          <span class="${isCorrect ? 'text-green-600 font-medium' : 'text-gray-700'}">${opt.text}</span>
                        </div>
                      `;
                    });
                  }
                  html += '</div>';
                  if (sub.correctAnswers && sub.correctAnswers.length > 0) {
                    html += `
                      <div class="mt-2 p-2 bg-green-50 rounded text-sm">
                        <span class="font-medium text-green-700">答案：</span>
                        <span class="text-green-600">${sub.correctAnswers.join('、')}</span>
                      </div>
                    `;
                  }
                } else if (subType === 'shortAnswer') {
                  if (sub.correctAnswers && sub.correctAnswers.length > 0 && sub.correctAnswers[0]) {
                    html += `
                      <div class="mt-2 p-2 bg-green-50 rounded text-sm">
                        <div class="font-medium text-green-700 mb-1">参考答案：</div>
                        <div class="text-green-600 whitespace-pre-wrap">${sub.correctAnswers[0]}</div>
                      </div>
                    `;
                  }
                }

                html += '</div>';
              });
              html += '</div>';
            }
          }

          // 显示解析
          if (q.explanation) {
            html += `
              <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                <div class="text-sm font-medium text-blue-700 mb-2">解析：</div>
                <div class="text-sm text-blue-600 leading-relaxed">${q.explanation}</div>
              </div>
            `;
          }

          html += `
                </div>
              </div>
            </div>
          `;

          globalQuestionNumber++;
        });

        html += `
            </div>
          </div>
        `;
      });

      container.innerHTML = html || '<div class="text-center text-gray-400 py-16">暂无题目</div>';

      // 生成导航
      if (navQuestions.length > 0) {
        const navByType = {};
        const typeOrderList = [];

        navQuestions.forEach(item => {
          if (!navByType[item.type]) {
            navByType[item.type] = [];
            typeOrderList.push(item.type);
          }
          navByType[item.type].push(item);
        });

        navHtml = `
          <div class="mb-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">题目导航</h3>
            <div class="text-xs text-gray-500 mb-4">共 ${navQuestions.length} 道题</div>
          </div>
        `;

        typeOrderList.forEach(typeName => {
          const typeQuestions = navByType[typeName];
          navHtml += `
            <div class="mb-6">
              <div class="flex items-center mb-3">
                <div class="w-1 h-5 bg-primary-500 rounded mr-2"></div>
                <h4 class="text-sm font-medium text-gray-800">${typeName}</h4>
              </div>
              <div class="grid grid-cols-5 gap-2">
          `;

          typeQuestions.forEach(item => {
            navHtml += `
              <button onclick="scrollToExtractionPreviewQuestion('${item.id}')"
                      class="extraction-preview-nav-item aspect-square flex items-center justify-center text-sm font-medium border border-gray-300 rounded transition-colors"
                      data-question-id="${item.id}">
                ${item.number}
              </button>
            `;
          });

          navHtml += `
              </div>
            </div>
          `;
        });
      } else {
        navHtml = '<div class="text-center text-gray-400 py-8">暂无题目</div>';
      }

      navContainer.innerHTML = navHtml;

      // 设置滚动监听
      setupExtractionPreviewScrollTracking();
    }

    // 滚动到指定题目
    function scrollToExtractionPreviewQuestion(questionId) {
      const scrollContainer = document.getElementById('extractionPreviewScrollContainer');
      const questionElement = document.getElementById(questionId);

      if (questionElement && scrollContainer) {
        const containerTop = scrollContainer.offsetTop;
        const elementTop = questionElement.offsetTop;
        const offset = elementTop - containerTop - 100;

        scrollContainer.scrollTo({
          top: offset,
          behavior: 'smooth'
        });

        updateExtractionPreviewActiveNav(questionId);
      }
    }

    // 更新导航激活状态
    function updateExtractionPreviewActiveNav(questionId) {
      document.querySelectorAll('.extraction-preview-nav-item').forEach(item => {
        item.classList.remove('active');
      });

      const activeNav = document.querySelector(`.extraction-preview-nav-item[data-question-id="${questionId}"]`);
      if (activeNav) {
        activeNav.classList.add('active');
      }
    }

    // 设置滚动跟踪
    function setupExtractionPreviewScrollTracking() {
      const scrollContainer = document.getElementById('extractionPreviewScrollContainer');
      if (!scrollContainer) return;

      if (scrollContainer._scrollHandler) {
        scrollContainer.removeEventListener('scroll', scrollContainer._scrollHandler);
      }

      const scrollHandler = () => {
        const questions = document.querySelectorAll('#extractionPreviewQuestionsContainer .question-item');
        const scrollTop = scrollContainer.scrollTop;
        const containerTop = scrollContainer.offsetTop;

        for (let i = questions.length - 1; i >= 0; i--) {
          const question = questions[i];
          const questionTop = question.offsetTop - containerTop - 150;

          if (scrollTop >= questionTop) {
            updateExtractionPreviewActiveNav(question.id);
            break;
          }
        }
      };

      scrollContainer._scrollHandler = scrollHandler;
      scrollContainer.addEventListener('scroll', scrollHandler);
    }

    // 关闭预览弹窗
    function closePreviewModal() {
      document.getElementById('previewModal').classList.add('hidden');
      document.body.style.overflow = '';
      previewPaperId = null;

      // 清理 PDF URL
      const pdfFrame = document.getElementById('previewPdfFrame');
      if (pdfFrame.src && pdfFrame.src.startsWith('blob:')) {
        URL.revokeObjectURL(pdfFrame.src);
      }
      pdfFrame.src = '';
    }

    // 关闭抽题预览弹窗
    function closeExtractionPreviewModal() {
      document.getElementById('extractionPreviewModal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    // 消息提示
    function showMessage(message, type = 'info') {
      const container = document.getElementById('messageContainer');
      const colors = {
        success: 'bg-success-50 text-success-700 border-success-200',
        error: 'bg-error-50 text-error-700 border-error-200',
        warning: 'bg-warning-50 text-warning-700 border-warning-200',
        info: 'bg-info-50 text-info-700 border-info-200'
      };

      const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
      };

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${colors[type]} border`;
      messageDiv.innerHTML = `
        <i class="fas ${icons[type]} mr-3"></i>
        <span>${message}</span>
      `;

      container.appendChild(messageDiv);

      setTimeout(() => {
        messageDiv.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => messageDiv.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>
