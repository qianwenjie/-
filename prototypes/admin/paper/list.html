<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>试卷管理 - 考试系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#E6F9F0', 100: '#C3F0DB', 500: '#00B96B', 600: '#00A35C' },
            success: { 50: '#E8FFEA', 500: '#00B42A' },
            warning: { 50: '#FFF7E8', 500: '#FF7D00' },
            error: { 50: '#FFECE8', 500: '#F53F3F' },
            info: { 50: '#E8F7FF', 500: '#14C9C9' }
          }
        }
      }
    }
  </script>
  <style>
    .message-container {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 10px; pointer-events: none;
    }
    .message-item {
      padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex; align-items: center; gap: 10px; font-size: 14px;
      animation: messageSlideIn 0.3s ease-out; pointer-events: auto;
    }
    .message-item.success { background: #f0fdf4; border: 1px solid #86efac; color: #166534; }
    .message-item.error { background: #fef2f2; border: 1px solid #fca5a5; color: #991b1b; }
    .message-item.warning { background: #fffbeb; border: 1px solid #fcd34d; color: #92400e; }
    .message-item.info { background: #eff6ff; border: 1px solid #93c5fd; color: #1e40af; }
    @keyframes messageSlideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes messageSlideOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }

    /* 卡片悬浮效果 */
    .paper-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .paper-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
    }

    /* 试卷图标动画 */
    .paper-icon-container {
      background: linear-gradient(135deg, #F9FAFB 0%, #E5E7EB 100%);
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .paper-icon-container:hover {
      background: linear-gradient(135deg, #F3F4F6 0%, #D1D5DB 100%);
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="messageContainer" class="message-container"></div>

  <!-- 顶部导航 -->
  <header class="h-16 bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
    <div class="flex items-center justify-between h-full px-6">
      <div class="flex items-center space-x-4">
        <a href="../dashboard.html" class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-primary-500 rounded flex items-center justify-center">
            <i class="fas fa-graduation-cap text-white"></i>
          </div>
          <span class="text-xl font-semibold text-gray-900">考试系统</span>
        </a>
        <nav class="flex items-center space-x-2 text-sm text-gray-600">
          <a href="../dashboard.html" class="hover:text-primary-500">首页</a>
          <i class="fas fa-chevron-right text-xs text-gray-400"></i>
          <span class="text-gray-900 font-medium">试卷管理</span>
        </nav>
      </div>
      <div class="flex items-center space-x-3">
        <img src="https://via.placeholder.com/32" alt="头像" class="w-8 h-8 rounded-full">
        <span class="text-sm text-gray-700">管理员</span>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="pt-16 min-h-screen">
    <div class="p-6">
      <!-- 筛选区域 -->
      <div class="bg-white rounded-lg border border-gray-200 p-3 mb-4 mt-1">
        <div class="flex items-center justify-between gap-3">
          <!-- 左侧筛选控件 -->
          <div class="flex items-center gap-3">
            <input type="text" id="searchInput" placeholder="搜索试卷名称或编号..." class="w-64 px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
            <select id="filterStatus" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
              <option value="">全部状态</option>
              <option value="draft">草稿</option>
              <option value="published">已发布</option>
            </select>
            <select id="filterMode" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
              <option value="">全部模式</option>
              <option value="document">文档模式</option>
              <option value="extraction">抽题模式</option>
            </select>
            <button onclick="filterPapers()" class="px-4 py-1.5 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium transition-colors">
              <i class="fas fa-search mr-2"></i>筛选
            </button>
            <button onclick="resetFilter()" class="px-4 py-1.5 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg text-sm font-medium transition-colors">
              <i class="fas fa-redo mr-2"></i>重置
            </button>
          </div>
          <!-- 右侧新增按钮 -->
          <button onclick="openCreatePaperModal()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium transition-colors">
            <i class="fas fa-plus mr-2"></i>新增试卷
          </button>
        </div>
      </div>

      <!-- 试卷卡片列表 -->
      <div class="mb-16">
        <!-- 卡片网格 -->
        <div id="paperList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4">
        </div>
        <!-- 空状态 -->
        <div id="emptyState" class="hidden py-16 text-center bg-white rounded-lg border border-gray-200">
          <i class="fas fa-file-alt text-4xl text-gray-300 mb-4"></i>
          <p class="text-gray-500 mb-4">暂无试卷数据</p>
          <button onclick="openCreatePaperModal()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium">
            <i class="fas fa-plus mr-2"></i>创建第一份试卷
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- 悬浮分页 -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-40">
    <div class="flex items-center justify-between px-6 py-3">
      <p class="text-sm text-gray-500">共 <span id="totalItems">0</span> 份试卷</p>
      <div class="flex items-center space-x-2">
        <button onclick="prevPage()" class="px-3 py-1.5 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" id="prevBtn" disabled>
          <i class="fas fa-chevron-left"></i>
        </button>
        <span class="px-3 py-1.5 text-sm text-gray-700">第 <span id="currentPage">1</span> / <span id="totalPages">1</span> 页</span>
        <button onclick="nextPage()" class="px-3 py-1.5 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" id="nextBtn" disabled>
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- 删除确认弹窗 -->
  <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-96 max-w-[90%]">
      <div class="flex items-center space-x-3 mb-4">
        <div class="w-10 h-10 bg-error-50 rounded-full flex items-center justify-center">
          <i class="fas fa-exclamation-triangle text-error-500"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-900">确认删除</h3>
      </div>
      <p class="text-gray-600 mb-6">确定要删除试卷 "<span id="deletePaperName"></span>" 吗？此操作不可恢复。</p>
      <div class="flex justify-end space-x-3">
        <button onclick="closeDeleteModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">取消</button>
        <button onclick="confirmDelete()" class="px-4 py-2 bg-error-500 hover:bg-error-600 text-white rounded-lg text-sm font-medium">确认删除</button>
      </div>
    </div>
  </div>

  <!-- 预览弹窗 -->
  <div id="previewModal" class="fixed inset-0 z-50 hidden">
    <!-- 遮罩层 -->
    <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closePreviewModal()"></div>
    <!-- 弹窗内容 -->
    <div class="absolute inset-4 bg-white rounded-lg shadow-2xl flex flex-col overflow-hidden">
      <!-- 弹窗头部 -->
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
        <div class="flex items-center space-x-3">
          <i class="fas fa-eye text-primary-500"></i>
          <span class="text-lg font-semibold text-gray-900">试卷预览</span>
          <span class="text-sm text-gray-500" id="previewPaperTitle"></span>
        </div>
        <div class="flex items-center space-x-3">
          <button onclick="closePreviewModal(); editPaper(previewPaperId)" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium transition-colors">
            <i class="fas fa-edit mr-1"></i>编辑试卷
          </button>
          <button onclick="closePreviewModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      <!-- 弹窗主体 -->
      <div class="flex-1 flex overflow-hidden">
        <!-- 左侧：文件预览 -->
        <div class="flex-1 bg-gray-100 flex flex-col overflow-hidden border-r border-gray-200">
          <div class="flex-shrink-0 px-4 py-3 bg-white border-b border-gray-200">
            <div class="flex items-center space-x-2">
              <i class="fas fa-file-alt text-gray-500"></i>
              <span class="text-sm font-medium text-gray-700" id="previewFileName">试卷文件</span>
            </div>
          </div>
          <div class="flex-1 overflow-hidden" id="previewFileContainer">
            <!-- PDF 预览 -->
            <iframe id="previewPdfFrame" class="w-full h-full hidden" frameborder="0"></iframe>
            <!-- Word 提示 -->
            <div id="previewWordNotice" class="hidden h-full flex items-center justify-center">
              <div class="text-center">
                <i class="fas fa-file-word text-6xl text-blue-500 mb-4"></i>
                <p class="text-gray-600">Word 文档预览</p>
                <p class="text-sm text-gray-400 mt-2" id="previewWordFileName"></p>
              </div>
            </div>
            <!-- 无文件提示 -->
            <div id="previewNoFile" class="h-full flex items-center justify-center">
              <div class="text-center">
                <i class="fas fa-file-upload text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500">暂无试卷文件</p>
                <p class="text-sm text-gray-400 mt-2">该试卷未上传文件</p>
              </div>
            </div>
          </div>
        </div>
        <!-- 右侧：答题卡预览 -->
        <div class="w-96 bg-white flex flex-col overflow-hidden">
          <div class="flex-shrink-0 px-4 py-3 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-2">
                <i class="fas fa-clipboard-list text-gray-500"></i>
                <span class="text-sm font-medium text-gray-700">答题卡</span>
              </div>
              <div class="text-sm">
                <span class="text-gray-500">总分：</span>
                <span class="font-bold text-primary-500" id="previewTotalScore">100</span>
                <span class="text-gray-500">分</span>
              </div>
            </div>
          </div>
          <div class="flex-1 overflow-y-auto p-3" id="previewAnswerCard">
            <!-- 答题卡预览内容 -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Message 组件
    const Message = {
      show(text, type = 'info', duration = 3000) {
        const container = document.getElementById('messageContainer');
        const item = document.createElement('div');
        item.className = `message-item ${type}`;
        const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-circle', info: 'fa-info-circle' };
        item.innerHTML = `<i class="fas ${icons[type]}"></i><span>${text}</span>`;
        container.appendChild(item);
        setTimeout(() => { item.style.animation = 'messageSlideOut 0.3s ease-out forwards'; setTimeout(() => item.remove(), 300); }, duration);
      },
      success(text, duration) { this.show(text, 'success', duration); },
      error(text, duration) { this.show(text, 'error', duration); },
      warning(text, duration) { this.show(text, 'warning', duration); },
      info(text, duration) { this.show(text, 'info', duration); }
    };

    // 数据
    let allPapers = JSON.parse(localStorage.getItem('allPapers')) || [];
    let filteredPapers = [];
    let currentPage = 1;
    const pageSize = 20;
    let deleteTargetId = null;
    let previewPaperId = null;  // 当前预览的试卷ID

    // 数据迁移：为旧试卷计算 actualTotalScore 和设置默认 extractionType
    function migratePaperData() {
      let needUpdate = false;

      allPapers.forEach(paper => {
        // 迁移1：为抽题模式试卷设置默认 extractionType
        if ((paper.mode === 'extraction' || paper.mode === 'random') && !paper.extractionType) {
          // 如果有 randomRules 则是随机抽题，否则是固定抽题
          paper.extractionType = paper.randomRules ? 'random' : 'fixed';
          needUpdate = true;
        }

        // 迁移2：计算 actualTotalScore（如果已有则跳过）
        if (paper.actualTotalScore !== undefined) {
          return;
        }

        let actualTotalScore = 0;

        // 根据不同模式计算已设总分
        if (paper.mode === 'extraction' || paper.mode === 'random') {
          // 抽题模式：从 questions 数组计算
          if (paper.questions && Array.isArray(paper.questions)) {
            paper.questions.forEach(q => {
              actualTotalScore += parseFloat(q.paperScore) || 0;
            });
          }
        } else if (paper.mode === 'document') {
          // 文档模式：从 answerCard 计算
          if (paper.answerCard) {
            Object.entries(paper.answerCard).forEach(([type, data]) => {
              if (type === 'composite') {
                // 复合题
                if (data.questions && Array.isArray(data.questions)) {
                  data.questions.forEach(q => {
                    if (q.subQuestions && Array.isArray(q.subQuestions)) {
                      q.subQuestions.forEach(sq => {
                        actualTotalScore += parseFloat(sq.score) || 0;
                      });
                    }
                  });
                }
              } else {
                // 普通题型
                if (data.questions && Array.isArray(data.questions)) {
                  data.questions.forEach(q => {
                    actualTotalScore += parseFloat(q.score) || 0;
                  });
                }
              }
            });
          }
        }

        // 设置 actualTotalScore
        paper.actualTotalScore = actualTotalScore;
        needUpdate = true;
      });

      // 如果有更新，保存到 localStorage
      if (needUpdate) {
        localStorage.setItem('allPapers', JSON.stringify(allPapers));
      }
    }

    // 执行数据迁移
    migratePaperData();

    // 初始化示例数据
    function initDemoData() {
      // 如果试卷数量不足25份，强制重新初始化为25份演示数据
      if (allPapers.length < 25) {
        // 模拟题库中的题目ID（用于抽题模式）
        const questionBank = {
          single: Array.from({length: 200}, (_, i) => `Q${String(i + 1).padStart(4, '0')}`),
          multiple: Array.from({length: 150}, (_, i) => `Q${String(i + 201).padStart(4, '0')}`),
          judge: Array.from({length: 100}, (_, i) => `Q${String(i + 351).padStart(4, '0')}`),
          blank: Array.from({length: 80}, (_, i) => `Q${String(i + 451).padStart(4, '0')}`),
          essay: Array.from({length: 50}, (_, i) => `Q${String(i + 531).padStart(4, '0')}`)
        };

        allPapers = [
          // ========== 文档模式试卷（5份）==========
          {
            id: 'P001',
            code: 'EXAM-2026-001',
            name: '2026年计算机基础期末考试',
            title: '2026年计算机基础期末考试',
            mode: 'document',
            totalScore: 100,
            questionCount: 50,
            status: 'published',
            usageCount: 3,
            createTime: '2026-01-10 10:00',
            creator: '张老师',
            answerCard: {
              single: {
                scorePerQuestion: 2,
                questions: Array.from({length: 20}, (_, i) => ({
                  id: i + 1,
                  score: 2,
                  answer: ['A', 'B', 'C', 'D'][Math.floor(Math.random() * 4)],
                  explanation: '',
                  showExplanation: false
                }))
              },
              multiple: {
                scorePerQuestion: 3,
                questions: Array.from({length: 10}, (_, i) => ({
                  id: i + 1,
                  score: 3,
                  answer: ['AB', 'AC', 'BC', 'ABC', 'ABD'][Math.floor(Math.random() * 5)].split(''),
                  explanation: '',
                  showExplanation: false
                }))
              },
              judge: {
                scorePerQuestion: 1,
                questions: Array.from({length: 10}, (_, i) => ({
                  id: i + 1,
                  score: 1,
                  answer: Math.random() > 0.5 ? '对' : '错',
                  explanation: '',
                  showExplanation: false
                }))
              },
              blank: {
                scorePerQuestion: 2,
                questions: Array.from({length: 5}, (_, i) => ({
                  id: i + 1,
                  score: 2,
                  answer: `答案${i + 1}`,
                  explanation: '',
                  showExplanation: false
                }))
              },
              essay: {
                scorePerQuestion: 0,
                questions: Array.from({length: 5}, (_, i) => ({
                  id: i + 1,
                  score: 4,
                  explanation: '',
                  showExplanation: false
                }))
              }
            }
          },
          {
            id: 'P002',
            code: 'EXAM-2026-002',
            name: '数学期中测验卷',
            title: '数学期中测验卷',
            mode: 'document',
            totalScore: 80,
            questionCount: 30,
            status: 'draft',
            usageCount: 0,
            createTime: '2026-01-12 14:30',
            creator: '李老师',
            answerCard: {
              single: {
                scorePerQuestion: 2,
                questions: Array.from({length: 15}, (_, i) => ({
                  id: i + 1,
                  score: 2,
                  answer: ['A', 'B', 'C', 'D'][Math.floor(Math.random() * 4)],
                  explanation: '',
                  showExplanation: false
                }))
              },
              blank: {
                scorePerQuestion: 2,
                questions: Array.from({length: 10}, (_, i) => ({
                  id: i + 1,
                  score: 2,
                  answer: `${Math.floor(Math.random() * 100)}`,
                  explanation: '',
                  showExplanation: false
                }))
              },
              essay: {
                scorePerQuestion: 0,
                questions: Array.from({length: 5}, (_, i) => ({
                  id: i + 1,
                  score: 6,
                  explanation: '',
                  showExplanation: false
                }))
              }
            }
          },
          {
            id: 'P003',
            code: 'EXAM-2026-003',
            name: '英语词汇测试',
            title: '英语词汇测试',
            mode: 'document',
            totalScore: 60,
            questionCount: 40,
            status: 'published',
            usageCount: 5,
            createTime: '2026-01-08 09:00',
            creator: '王老师',
            answerCard: {
              single: {
                scorePerQuestion: 1,
                questions: Array.from({length: 30}, (_, i) => ({
                  id: i + 1,
                  score: 1,
                  answer: ['A', 'B', 'C', 'D'][Math.floor(Math.random() * 4)],
                  explanation: '',
                  showExplanation: false
                }))
              },
              judge: {
                scorePerQuestion: 1,
                questions: Array.from({length: 10}, (_, i) => ({
                  id: i + 1,
                  score: 1,
                  answer: Math.random() > 0.5 ? '对' : '错',
                  explanation: '',
                  showExplanation: false
                }))
              }
            }
          },
          {
            id: 'P004',
            code: 'EXAM-2026-004',
            name: '物理力学单元测试',
            title: '物理力学单元测试',
            mode: 'document',
            totalScore: 100,
            questionCount: 25,
            status: 'published',
            usageCount: 2,
            createTime: '2026-01-15 16:00',
            creator: '赵老师',
            answerCard: {
              single: {
                scorePerQuestion: 3,
                questions: Array.from({length: 10}, (_, i) => ({
                  id: i + 1,
                  score: 3,
                  answer: ['A', 'B', 'C', 'D'][Math.floor(Math.random() * 4)],
                  explanation: '',
                  showExplanation: false
                }))
              },
              multiple: {
                scorePerQuestion: 4,
                questions: Array.from({length: 5}, (_, i) => ({
                  id: i + 1,
                  score: 4,
                  answer: ['AB', 'AC', 'BC', 'ABC'][Math.floor(Math.random() * 4)].split(''),
                  explanation: '',
                  showExplanation: false
                }))
              },
              blank: {
                scorePerQuestion: 2,
                questions: Array.from({length: 5}, (_, i) => ({
                  id: i + 1,
                  score: 2,
                  answer: `${Math.floor(Math.random() * 100)} N`,
                  explanation: '',
                  showExplanation: false
                }))
              },
              essay: {
                scorePerQuestion: 0,
                questions: Array.from({length: 5}, (_, i) => ({
                  id: i + 1,
                  score: 10,
                  explanation: '',
                  showExplanation: false
                }))
              }
            }
          },
          {
            id: 'P005',
            code: 'EXAM-2026-005',
            name: '化学实验操作考核',
            title: '化学实验操作考核',
            mode: 'document',
            totalScore: 50,
            questionCount: 20,
            status: 'draft',
            usageCount: 0,
            createTime: '2026-01-18 11:00',
            creator: '钱老师',
            answerCard: {
              single: {
                scorePerQuestion: 2,
                questions: Array.from({length: 10}, (_, i) => ({
                  id: i + 1,
                  score: 2,
                  answer: ['A', 'B', 'C', 'D'][Math.floor(Math.random() * 4)],
                  explanation: '',
                  showExplanation: false
                }))
              },
              judge: {
                scorePerQuestion: 1,
                questions: Array.from({length: 5}, (_, i) => ({
                  id: i + 1,
                  score: 1,
                  answer: Math.random() > 0.5 ? '对' : '错',
                  explanation: '',
                  showExplanation: false
                }))
              },
              essay: {
                scorePerQuestion: 0,
                questions: Array.from({length: 5}, (_, i) => ({
                  id: i + 1,
                  score: 5,
                  explanation: '',
                  showExplanation: false
                }))
              }
            }
          },

          // ========== 固定抽题模式试卷（10份）==========
          {
            id: 'P006',
            code: 'EXAM-2026-006',
            name: '数据结构固定抽题卷',
            title: '数据结构固定抽题卷',
            mode: 'extraction',
            extractionType: 'fixed',
            totalScore: 100,
            questionCount: 30,
            status: 'published',
            usageCount: 1,
            createTime: '2026-01-20 10:30',
            creator: '张老师',
            questions: [
              ...questionBank.single.slice(0, 15).map((id, i) => ({
                questionId: id,
                questionType: 'single',
                knowledgePoint: '数据结构/线性表',
                paperScore: 2
              })),
              ...questionBank.multiple.slice(0, 5).map((id, i) => ({
                questionId: id,
                questionType: 'multiple',
                knowledgePoint: '数据结构/树',
                paperScore: 3
              })),
              ...questionBank.judge.slice(0, 5).map((id, i) => ({
                questionId: id,
                questionType: 'judge',
                knowledgePoint: '数据结构/图',
                paperScore: 2
              })),
              ...questionBank.essay.slice(0, 5).map((id, i) => ({
                questionId: id,
                questionType: 'essay',
                knowledgePoint: '数据结构/算法分析',
                paperScore: 10
              }))
            ]
          },
          {
            id: 'P007',
            code: 'EXAM-2026-007',
            name: '操作系统原理固定抽题卷',
            title: '操作系统原理固定抽题卷',
            mode: 'extraction',
            extractionType: 'fixed',
            totalScore: 100,
            questionCount: 35,
            status: 'published',
            usageCount: 2,
            createTime: '2026-01-21 09:15',
            creator: '李老师',
            questions: [
              ...questionBank.single.slice(15, 30).map((id, i) => ({
                questionId: id,
                questionType: 'single',
                knowledgePoint: '操作系统/进程管理',
                paperScore: 2
              })),
              ...questionBank.multiple.slice(5, 12).map((id, i) => ({
                questionId: id,
                questionType: 'multiple',
                knowledgePoint: '操作系统/内存管理',
                paperScore: 3
              })),
              ...questionBank.judge.slice(5, 13).map((id, i) => ({
                questionId: id,
                questionType: 'judge',
                knowledgePoint: '操作系统/文件系统',
                paperScore: 2
              })),
              ...questionBank.blank.slice(0, 5).map((id, i) => ({
                questionId: id,
                questionType: 'blank',
                knowledgePoint: '操作系统/设备管理',
                paperScore: 4
              })),
              ...questionBank.essay.slice(5, 10).map((id, i) => ({
                questionId: id,
                questionType: 'essay',
                knowledgePoint: '操作系统/综合应用',
                paperScore: 8
              }))
            ]
          },
          {
            id: 'P008',
            code: 'EXAM-2026-008',
            name: '计算机网络固定抽题卷',
            title: '计算机网络固定抽题卷',
            mode: 'extraction',
            extractionType: 'fixed',
            totalScore: 100,
            questionCount: 40,
            status: 'published',
            usageCount: 0,
            createTime: '2026-01-22 14:20',
            creator: '王老师',
            questions: [
              ...questionBank.single.slice(30, 50).map((id, i) => ({
                questionId: id,
                questionType: 'single',
                knowledgePoint: '计算机网络/网络层',
                paperScore: 2
              })),
              ...questionBank.multiple.slice(12, 20).map((id, i) => ({
                questionId: id,
                questionType: 'multiple',
                knowledgePoint: '计算机网络/传输层',
                paperScore: 3
              })),
              ...questionBank.judge.slice(13, 20).map((id, i) => ({
                questionId: id,
                questionType: 'judge',
                knowledgePoint: '计算机网络/应用层',
                paperScore: 2
              })),
              ...questionBank.essay.slice(10, 15).map((id, i) => ({
                questionId: id,
                questionType: 'essay',
                knowledgePoint: '计算机网络/协议分析',
                paperScore: 8
              }))
            ]
          },
          {
            id: 'P009',
            code: 'EXAM-2026-009',
            name: '数据库原理固定抽题卷',
            title: '数据库原理固定抽题卷',
            mode: 'extraction',
            extractionType: 'fixed',
            totalScore: 100,
            questionCount: 32,
            status: 'draft',
            usageCount: 0,
            createTime: '2026-01-23 11:30',
            creator: '赵老师',
            questions: [
              ...questionBank.single.slice(50, 68).map((id, i) => ({
                questionId: id,
                questionType: 'single',
                knowledgePoint: '数据库/SQL语言',
                paperScore: 2
              })),
              ...questionBank.multiple.slice(20, 26).map((id, i) => ({
                questionId: id,
                questionType: 'multiple',
                knowledgePoint: '数据库/事务管理',
                paperScore: 3
              })),
              ...questionBank.blank.slice(5, 10).map((id, i) => ({
                questionId: id,
                questionType: 'blank',
                knowledgePoint: '数据库/索引优化',
                paperScore: 4
              })),
              ...questionBank.essay.slice(15, 18).map((id, i) => ({
                questionId: id,
                questionType: 'essay',
                knowledgePoint: '数据库/设计规范',
                paperScore: 12
              }))
            ]
          },
          {
            id: 'P010',
            code: 'EXAM-2026-010',
            name: '软件工程固定抽题卷',
            title: '软件工程固定抽题卷',
            mode: 'extraction',
            extractionType: 'fixed',
            totalScore: 100,
            questionCount: 28,
            status: 'published',
            usageCount: 3,
            createTime: '2026-01-24 08:45',
            creator: '钱老师',
            questions: [
              ...questionBank.single.slice(68, 83).map((id, i) => ({
                questionId: id,
                questionType: 'single',
                knowledgePoint: '软件工程/需求分析',
                paperScore: 2
              })),
              ...questionBank.multiple.slice(26, 32).map((id, i) => ({
                questionId: id,
                questionType: 'multiple',
                knowledgePoint: '软件工程/设计模式',
                paperScore: 3
              })),
              ...questionBank.essay.slice(18, 25).map((id, i) => ({
                questionId: id,
                questionType: 'essay',
                knowledgePoint: '软件工程/项目管理',
                paperScore: 10
              }))
            ]
          },
          {
            id: 'P011',
            code: 'EXAM-2026-011',
            name: 'Java编程固定抽题卷',
            title: 'Java编程固定抽题卷',
            mode: 'extraction',
            extractionType: 'fixed',
            totalScore: 100,
            questionCount: 35,
            status: 'published',
            usageCount: 1,
            createTime: '2026-01-25 10:00',
            creator: '张老师',
            questions: [
              ...questionBank.single.slice(83, 103).map((id, i) => ({
                questionId: id,
                questionType: 'single',
                knowledgePoint: 'Java/面向对象',
                paperScore: 2
              })),
              ...questionBank.multiple.slice(32, 38).map((id, i) => ({
                questionId: id,
                questionType: 'multiple',
                knowledgePoint: 'Java/集合框架',
                paperScore: 3
              })),
              ...questionBank.judge.slice(20, 25).map((id, i) => ({
                questionId: id,
                questionType: 'judge',
                knowledgePoint: 'Java/异常处理',
                paperScore: 2
              })),
              ...questionBank.blank.slice(10, 15).map((id, i) => ({
                questionId: id,
                questionType: 'blank',
                knowledgePoint: 'Java/IO流',
                paperScore: 4
              }))
            ]
          },
          {
            id: 'P012',
            code: 'EXAM-2026-012',
            name: 'Python基础固定抽题卷',
            title: 'Python基础固定抽题卷',
            mode: 'extraction',
            extractionType: 'fixed',
            totalScore: 100,
            questionCount: 30,
            status: 'draft',
            usageCount: 0,
            createTime: '2026-01-26 13:30',
            creator: '李老师',
            questions: [
              ...questionBank.single.slice(103, 118).map((id, i) => ({
                questionId: id,
                questionType: 'single',
                knowledgePoint: 'Python/基础语法',
                paperScore: 2
              })),
              ...questionBank.multiple.slice(38, 43).map((id, i) => ({
                questionId: id,
                questionType: 'multiple',
                knowledgePoint: 'Python/数据类型',
                paperScore: 3
              })),
              ...questionBank.blank.slice(15, 20).map((id, i) => ({
                questionId: id,
                questionType: 'blank',
                knowledgePoint: 'Python/函数',
                paperScore: 4
              })),
              ...questionBank.essay.slice(25, 30).map((id, i) => ({
                questionId: id,
                questionType: 'essay',
                knowledgePoint: 'Python/面向对象',
                paperScore: 10
              }))
            ]
          },
          {
            id: 'P013',
            code: 'EXAM-2026-013',
            name: '前端开发固定抽题卷',
            title: '前端开发固定抽题卷',
            mode: 'extraction',
            extractionType: 'fixed',
            totalScore: 100,
            questionCount: 38,
            status: 'published',
            usageCount: 2,
            createTime: '2026-01-27 09:20',
            creator: '王老师',
            questions: [
              ...questionBank.single.slice(118, 138).map((id, i) => ({
                questionId: id,
                questionType: 'single',
                knowledgePoint: '前端/HTML+CSS',
                paperScore: 2
              })),
              ...questionBank.multiple.slice(43, 50).map((id, i) => ({
                questionId: id,
                questionType: 'multiple',
                knowledgePoint: '前端/JavaScript',
                paperScore: 3
              })),
              ...questionBank.judge.slice(25, 30).map((id, i) => ({
                questionId: id,
                questionType: 'judge',
                knowledgePoint: '前端/DOM操作',
                paperScore: 2
              })),
              ...questionBank.essay.slice(30, 36).map((id, i) => ({
                questionId: id,
                questionType: 'essay',
                knowledgePoint: '前端/Vue框架',
                paperScore: 7
              }))
            ]
          },
          {
            id: 'P014',
            code: 'EXAM-2026-014',
            name: '算法设计固定抽题卷',
            title: '算法设计固定抽题卷',
            mode: 'extraction',
            extractionType: 'fixed',
            totalScore: 100,
            questionCount: 25,
            status: 'published',
            usageCount: 4,
            createTime: '2026-01-27 16:10',
            creator: '赵老师',
            questions: [
              ...questionBank.single.slice(138, 148).map((id, i) => ({
                questionId: id,
                questionType: 'single',
                knowledgePoint: '算法/排序算法',
                paperScore: 2
              })),
              ...questionBank.multiple.slice(50, 55).map((id, i) => ({
                questionId: id,
                questionType: 'multiple',
                knowledgePoint: '算法/查找算法',
                paperScore: 4
              })),
              ...questionBank.blank.slice(20, 25).map((id, i) => ({
                questionId: id,
                questionType: 'blank',
                knowledgePoint: '算法/动态规划',
                paperScore: 6
              })),
              ...questionBank.essay.slice(36, 41).map((id, i) => ({
                questionId: id,
                questionType: 'essay',
                knowledgePoint: '算法/复杂度分析',
                paperScore: 10
              }))
            ]
          },
          {
            id: 'P015',
            code: 'EXAM-2026-015',
            name: '人工智能基础固定抽题卷',
            title: '人工智能基础固定抽题卷',
            mode: 'extraction',
            extractionType: 'fixed',
            totalScore: 100,
            questionCount: 33,
            status: 'draft',
            usageCount: 0,
            createTime: '2026-01-28 11:00',
            creator: '钱老师',
            questions: [
              ...questionBank.single.slice(148, 168).map((id, i) => ({
                questionId: id,
                questionType: 'single',
                knowledgePoint: '人工智能/机器学习',
                paperScore: 2
              })),
              ...questionBank.multiple.slice(55, 60).map((id, i) => ({
                questionId: id,
                questionType: 'multiple',
                knowledgePoint: '人工智能/神经网络',
                paperScore: 3
              })),
              ...questionBank.judge.slice(30, 35).map((id, i) => ({
                questionId: id,
                questionType: 'judge',
                knowledgePoint: '人工智能/深度学习',
                paperScore: 2
              })),
              ...questionBank.essay.slice(41, 44).map((id, i) => ({
                questionId: id,
                questionType: 'essay',
                knowledgePoint: '人工智能/应用案例',
                paperScore: 12
              }))
            ]
          },

          // ========== 随机抽题模式试卷（10份）==========
          {
            id: 'P016',
            code: 'EXAM-2026-016',
            name: '数据结构随机抽题卷',
            title: '数据结构随机抽题卷',
            mode: 'extraction',
            extractionType: 'random',
            totalScore: 100,
            questionCount: 30,
            status: 'published',
            usageCount: 5,
            createTime: '2026-01-20 15:00',
            creator: '张老师',
            questions: [
              { questionType: 'single', count: 15, scorePerQuestion: 2, knowledgePoint: '数据结构/线性表' },
              { questionType: 'multiple', count: 5, scorePerQuestion: 3, knowledgePoint: '数据结构/树' },
              { questionType: 'judge', count: 5, scorePerQuestion: 2, knowledgePoint: '数据结构/图' },
              { questionType: 'essay', count: 5, scorePerQuestion: 10, knowledgePoint: '数据结构/算法分析' }
            ]
          },
          {
            id: 'P017',
            code: 'EXAM-2026-017',
            name: '操作系统原理随机抽题卷',
            title: '操作系统原理随机抽题卷',
            mode: 'extraction',
            extractionType: 'random',
            totalScore: 100,
            questionCount: 35,
            status: 'published',
            usageCount: 3,
            createTime: '2026-01-21 13:45',
            creator: '李老师',
            questions: [
              { questionType: 'single', count: 15, scorePerQuestion: 2, knowledgePoint: '操作系统/进程管理' },
              { questionType: 'multiple', count: 7, scorePerQuestion: 3, knowledgePoint: '操作系统/内存管理' },
              { questionType: 'judge', count: 8, scorePerQuestion: 2, knowledgePoint: '操作系统/文件系统' },
              { questionType: 'essay', count: 5, scorePerQuestion: 8, knowledgePoint: '操作系统/综合应用' }
            ]
          },
          {
            id: 'P018',
            code: 'EXAM-2026-018',
            name: '计算机网络随机抽题卷',
            title: '计算机网络随机抽题卷',
            mode: 'extraction',
            extractionType: 'random',
            totalScore: 100,
            questionCount: 40,
            status: 'published',
            usageCount: 2,
            createTime: '2026-01-22 16:30',
            creator: '王老师',
            questions: [
              { questionType: 'single', count: 20, scorePerQuestion: 2, knowledgePoint: '计算机网络/网络层' },
              { questionType: 'multiple', count: 8, scorePerQuestion: 3, knowledgePoint: '计算机网络/传输层' },
              { questionType: 'judge', count: 7, scorePerQuestion: 2, knowledgePoint: '计算机网络/应用层' },
              { questionType: 'essay', count: 5, scorePerQuestion: 8, knowledgePoint: '计算机网络/协议分析' }
            ]
          },
          {
            id: 'P019',
            code: 'EXAM-2026-019',
            name: '数据库原理随机抽题卷',
            title: '数据库原理随机抽题卷',
            mode: 'extraction',
            extractionType: 'random',
            totalScore: 100,
            questionCount: 32,
            status: 'draft',
            usageCount: 0,
            createTime: '2026-01-23 14:15',
            creator: '赵老师',
            questions: [
              { questionType: 'single', count: 18, scorePerQuestion: 2, knowledgePoint: '数据库/SQL语言' },
              { questionType: 'multiple', count: 6, scorePerQuestion: 3, knowledgePoint: '数据库/事务管理' },
              { questionType: 'blank', count: 5, scorePerQuestion: 4, knowledgePoint: '数据库/索引优化' },
              { questionType: 'essay', count: 3, scorePerQuestion: 12, knowledgePoint: '数据库/设计规范' }
            ]
          },
          {
            id: 'P020',
            code: 'EXAM-2026-020',
            name: '软件工程随机抽题卷',
            title: '软件工程随机抽题卷',
            mode: 'extraction',
            extractionType: 'random',
            totalScore: 100,
            questionCount: 28,
            status: 'published',
            usageCount: 6,
            createTime: '2026-01-24 10:20',
            creator: '钱老师',
            questions: [
              { questionType: 'single', count: 15, scorePerQuestion: 2, knowledgePoint: '软件工程/需求分析' },
              { questionType: 'multiple', count: 6, scorePerQuestion: 3, knowledgePoint: '软件工程/设计模式' },
              { questionType: 'essay', count: 7, scorePerQuestion: 10, knowledgePoint: '软件工程/项目管理' }
            ]
          },
          {
            id: 'P021',
            code: 'EXAM-2026-021',
            name: 'Java编程随机抽题卷',
            title: 'Java编程随机抽题卷',
            mode: 'extraction',
            extractionType: 'random',
            totalScore: 100,
            questionCount: 35,
            status: 'published',
            usageCount: 4,
            createTime: '2026-01-25 12:45',
            creator: '张老师',
            questions: [
              { questionType: 'single', count: 20, scorePerQuestion: 2, knowledgePoint: 'Java/面向对象' },
              { questionType: 'multiple', count: 6, scorePerQuestion: 3, knowledgePoint: 'Java/集合框架' },
              { questionType: 'judge', count: 5, scorePerQuestion: 2, knowledgePoint: 'Java/异常处理' },
              { questionType: 'blank', count: 4, scorePerQuestion: 5, knowledgePoint: 'Java/IO流' }
            ]
          },
          {
            id: 'P022',
            code: 'EXAM-2026-022',
            name: 'Python基础随机抽题卷',
            title: 'Python基础随机抽题卷',
            mode: 'extraction',
            extractionType: 'random',
            totalScore: 100,
            questionCount: 30,
            status: 'draft',
            usageCount: 0,
            createTime: '2026-01-26 15:00',
            creator: '李老师',
            questions: [
              { questionType: 'single', count: 15, scorePerQuestion: 2, knowledgePoint: 'Python/基础语法' },
              { questionType: 'multiple', count: 5, scorePerQuestion: 3, knowledgePoint: 'Python/数据类型' },
              { questionType: 'blank', count: 5, scorePerQuestion: 4, knowledgePoint: 'Python/函数' },
              { questionType: 'essay', count: 5, scorePerQuestion: 9, knowledgePoint: 'Python/面向对象' }
            ]
          },
          {
            id: 'P023',
            code: 'EXAM-2026-023',
            name: '前端开发随机抽题卷',
            title: '前端开发随机抽题卷',
            mode: 'extraction',
            extractionType: 'random',
            totalScore: 100,
            questionCount: 38,
            status: 'published',
            usageCount: 7,
            createTime: '2026-01-27 11:10',
            creator: '王老师',
            questions: [
              { questionType: 'single', count: 20, scorePerQuestion: 2, knowledgePoint: '前端/HTML+CSS' },
              { questionType: 'multiple', count: 7, scorePerQuestion: 3, knowledgePoint: '前端/JavaScript' },
              { questionType: 'judge', count: 5, scorePerQuestion: 2, knowledgePoint: '前端/DOM操作' },
              { questionType: 'essay', count: 6, scorePerQuestion: 7, knowledgePoint: '前端/Vue框架' }
            ]
          },
          {
            id: 'P024',
            code: 'EXAM-2026-024',
            name: '算法设计随机抽题卷',
            title: '算法设计随机抽题卷',
            mode: 'extraction',
            extractionType: 'random',
            totalScore: 100,
            questionCount: 25,
            status: 'published',
            usageCount: 8,
            createTime: '2026-01-27 17:30',
            creator: '赵老师',
            questions: [
              { questionType: 'single', count: 10, scorePerQuestion: 2, knowledgePoint: '算法/排序算法' },
              { questionType: 'multiple', count: 5, scorePerQuestion: 4, knowledgePoint: '算法/查找算法' },
              { questionType: 'blank', count: 5, scorePerQuestion: 6, knowledgePoint: '算法/动态规划' },
              { questionType: 'essay', count: 5, scorePerQuestion: 10, knowledgePoint: '算法/复杂度分析' }
            ]
          },
          {
            id: 'P025',
            code: 'EXAM-2026-025',
            name: '人工智能基础随机抽题卷',
            title: '人工智能基础随机抽题卷',
            mode: 'extraction',
            extractionType: 'random',
            totalScore: 100,
            questionCount: 33,
            status: 'draft',
            usageCount: 0,
            createTime: '2026-01-28 13:20',
            creator: '钱老师',
            questions: [
              { questionType: 'single', count: 20, scorePerQuestion: 2, knowledgePoint: '人工智能/机器学习' },
              { questionType: 'multiple', count: 5, scorePerQuestion: 3, knowledgePoint: '人工智能/神经网络' },
              { questionType: 'judge', count: 5, scorePerQuestion: 2, knowledgePoint: '人工智能/深度学习' },
              { questionType: 'essay', count: 3, scorePerQuestion: 12, knowledgePoint: '人工智能/应用案例' }
            ]
          }
        ];
        localStorage.setItem('allPapers', JSON.stringify(allPapers));
      }
    }

    // 筛选
    function filterPapers() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const status = document.getElementById('filterStatus').value;
      const mode = document.getElementById('filterMode').value;
      filteredPapers = allPapers.filter(p => {
        const matchSearch = !search || p.name.toLowerCase().includes(search) || p.code.toLowerCase().includes(search);
        const matchStatus = !status || p.status === status;
        const matchMode = !mode || p.mode === mode;
        return matchSearch && matchStatus && matchMode;
      });
      // 按创建时间倒序排列
      filteredPapers.sort((a, b) => {
        const timeA = new Date(a.createTime || '2000-01-01 00:00:00').getTime();
        const timeB = new Date(b.createTime || '2000-01-01 00:00:00').getTime();
        return timeB - timeA;
      });
      currentPage = 1;
      renderList();
    }

    function resetFilter() {
      document.getElementById('searchInput').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterMode').value = '';
      filteredPapers = [...allPapers];
      // 按创建时间倒序排列
      filteredPapers.sort((a, b) => {
        const timeA = new Date(a.createTime || '2000-01-01 00:00:00').getTime();
        const timeB = new Date(b.createTime || '2000-01-01 00:00:00').getTime();
        return timeB - timeA;
      });
      currentPage = 1;
      renderList();
    }

    // 渲染列表
    function renderList() {
      const container = document.getElementById('paperList');
      const emptyState = document.getElementById('emptyState');
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageData = filteredPapers.slice(start, end);

      if (filteredPapers.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
      } else {
        emptyState.classList.add('hidden');
        container.innerHTML = pageData.map(p => createPaperCard(p)).join('');
      }
      updatePagination();
      document.getElementById('totalItems').textContent = filteredPapers.length;
    }

    function createPaperCard(paper) {
      const isExtraction = paper.mode === 'extraction' || paper.mode === 'random';

      // 组卷模式显示
      let modeText, modeClass;
      if (paper.mode === 'document') {
        modeText = '文档模式';
        modeClass = 'bg-blue-50 text-blue-600';
      } else if (isExtraction) {
        // 区分固定抽题和随机抽题
        if (paper.extractionType === 'random') {
          modeText = '随机抽题';
          modeClass = 'bg-purple-50 text-purple-600';
        } else {
          modeText = '固定抽题';
          modeClass = 'bg-indigo-50 text-indigo-600';
        }
      } else {
        modeText = '抽题模式';
        modeClass = 'bg-purple-50 text-purple-600';
      }

      const statusText = paper.status === 'published' ? '已发布' : '草稿';
      const statusClass = paper.status === 'published' ? 'text-primary-600' : 'text-gray-500';
      const statusIcon = paper.status === 'published' ? '●' : '●';

      // 删除逻辑：草稿可删除；已发布且使用次数为0可删除；已发布且使用次数>0不可删除
      const canDelete = paper.status === 'draft' || (paper.status === 'published' && (paper.usageCount || 0) === 0);
      const deleteTitle = canDelete ? '删除' : '已发布且被使用，无法删除';

      return `
        <div class="paper-card bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
          <!-- 卡片上半部分：渐变背景区域 -->
          <div class="paper-icon-container" onclick="previewPaper('${paper.id}')">
            <!-- 模式标签 -->
            <div class="px-4 pt-4">
              <span class="inline-block px-2 py-1 rounded text-xs font-medium ${modeClass}">${modeText}</span>
            </div>

            <!-- 图标区域 -->
            <div class="flex items-center justify-center py-12">
            <div class="relative">
              <!-- 扁平化试卷图标 -->
              <svg class="w-24 h-24" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <!-- 渐变定义 -->
                  <linearGradient id="mainDocGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#FFFFFF;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#F0FDF4;stop-opacity:1" />
                  </linearGradient>
                  <linearGradient id="headerGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#10B981;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#34D399;stop-opacity:1" />
                  </linearGradient>
                  <linearGradient id="badgeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#FBBF24;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#F59E0B;stop-opacity:1" />
                  </linearGradient>
                  <!-- 阴影滤镜 -->
                  <filter id="paperShadow" x="-20%" y="-20%" width="140%" height="140%">
                    <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
                    <feOffset dx="0" dy="4" result="offsetblur"/>
                    <feComponentTransfer>
                      <feFuncA type="linear" slope="0.15"/>
                    </feComponentTransfer>
                    <feMerge>
                      <feMergeNode/>
                      <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                  </filter>
                </defs>

                <!-- 文档主体 -->
                <g filter="url(#paperShadow)">
                  <rect x="25" y="20" width="70" height="85" rx="6" fill="url(#mainDocGradient)" stroke="#E5E7EB" stroke-width="1"/>

                  <!-- 顶部绿色标题栏 -->
                  <rect x="25" y="20" width="70" height="20" rx="6" fill="url(#headerGradient)"/>
                  <rect x="25" y="30" width="70" height="10" fill="url(#headerGradient)"/>

                  <!-- 标题栏装饰线 -->
                  <line x1="32" y1="28" x2="52" y2="28" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" opacity="0.9"/>
                  <line x1="32" y1="33" x2="45" y2="33" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round" opacity="0.7"/>

                  <!-- 文档内容 - 题目列表样式 -->
                  <!-- 题目1 -->
                  <circle cx="34" cy="52" r="3" fill="#10B981" opacity="0.3"/>
                  <line x1="42" y1="52" x2="80" y2="52" stroke="#D1D5DB" stroke-width="2" stroke-linecap="round"/>

                  <!-- 题目2 -->
                  <circle cx="34" cy="62" r="3" fill="#10B981" opacity="0.3"/>
                  <line x1="42" y1="62" x2="85" y2="62" stroke="#D1D5DB" stroke-width="2" stroke-linecap="round"/>

                  <!-- 题目3 -->
                  <circle cx="34" cy="72" r="3" fill="#10B981" opacity="0.3"/>
                  <line x1="42" y1="72" x2="75" y2="72" stroke="#D1D5DB" stroke-width="2" stroke-linecap="round"/>

                  <!-- 题目4 -->
                  <circle cx="34" cy="82" r="3" fill="#10B981" opacity="0.3"/>
                  <line x1="42" y1="82" x2="82" y2="82" stroke="#D1D5DB" stroke-width="2" stroke-linecap="round"/>

                  <!-- 题目5 -->
                  <circle cx="34" cy="92" r="3" fill="#10B981" opacity="0.3"/>
                  <line x1="42" y1="92" x2="78" y2="92" stroke="#D1D5DB" stroke-width="2" stroke-linecap="round"/>
                </g>

                <!-- 右上角徽章 -->
                <g filter="url(#paperShadow)">
                  <circle cx="85" cy="30" r="12" fill="url(#badgeGradient)"/>
                  <path d="M 80 30 L 83 33 L 90 25" stroke="#FFFFFF" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                </g>

                <!-- 文档折角效果 -->
                <path d="M 85 20 L 85 30 L 95 30 Z" fill="#D1FAE5" opacity="0.5"/>
                <path d="M 85 30 L 95 30 L 95 26 Q 95 20 89 20 L 85 20" fill="#DCFCE7" opacity="0.3"/>

              </svg>
            </div>
            </div>
          </div>

          <!-- 卡片底部：标题和信息 -->
          <div class="px-4 pb-4 border-t border-gray-100">
            <!-- 标题 -->
            <h3 class="mt-3 font-medium text-gray-900 truncate" title="${paper.name}">${paper.name}</h3>

            <!-- 信息行 -->
            <div class="mt-3 flex items-center justify-between text-xs text-gray-500">
              <div class="flex items-center space-x-3">
                <!-- 创建时间 -->
                <span>${paper.createTime}</span>
                <!-- 使用次数 -->
                <span>${paper.usageCount || 0}次</span>
              </div>
              <!-- 状态 -->
              <div class="flex items-center space-x-1 ${statusClass}">
                <span>${statusIcon}</span>
                <span>${statusText}</span>
              </div>
            </div>

            <!-- 操作按钮行 -->
            <div class="mt-3 flex items-center justify-between pt-3 border-t border-gray-100">
              <div class="flex items-center space-x-1">
                <button onclick="event.stopPropagation(); previewPaper('${paper.id}')" class="p-1.5 text-gray-400 hover:text-primary-500 hover:bg-primary-50 rounded transition-colors" title="预览">
                  <i class="fas fa-eye text-sm"></i>
                </button>
                <button onclick="event.stopPropagation(); editPaper('${paper.id}')" class="p-1.5 text-gray-400 hover:text-info-500 hover:bg-info-50 rounded transition-colors" title="编辑">
                  <i class="fas fa-edit text-sm"></i>
                </button>
                <button onclick="event.stopPropagation(); copyPaper('${paper.id}')" class="p-1.5 text-gray-400 hover:text-warning-500 hover:bg-warning-50 rounded transition-colors" title="复制">
                  <i class="fas fa-copy text-sm"></i>
                </button>
                <button onclick="event.stopPropagation(); deletePaper('${paper.id}')" class="p-1.5 text-gray-400 hover:text-error-500 hover:bg-error-50 rounded transition-colors ${canDelete ? '' : 'opacity-30 cursor-not-allowed'}" title="${deleteTitle}" ${canDelete ? '' : 'disabled'}>
                  <i class="fas fa-trash text-sm"></i>
                </button>
              </div>
              <!-- 题目和分数 -->
              <div class="text-xs text-gray-500">
                <span>${paper.questionCount}题</span>
                <span class="mx-1">/</span>
                <span>${paper.totalScore}分</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // 分页
    function updatePagination() {
      const totalPages = Math.ceil(filteredPapers.length / pageSize) || 1;
      document.getElementById('currentPage').textContent = currentPage;
      document.getElementById('totalPages').textContent = totalPages;
      document.getElementById('prevBtn').disabled = currentPage <= 1;
      document.getElementById('nextBtn').disabled = currentPage >= totalPages;
    }

    function prevPage() { if (currentPage > 1) { currentPage--; renderList(); } }
    function nextPage() { const totalPages = Math.ceil(filteredPapers.length / pageSize); if (currentPage < totalPages) { currentPage++; renderList(); } }

    // 题型配置
    const questionTypeConfig = {
      single: { name: '单选题', icon: 'fa-dot-circle', options: ['A', 'B', 'C', 'D'] },
      multiple: { name: '多选题', icon: 'fa-check-double', options: ['A', 'B', 'C', 'D'] },
      judge: { name: '判断题', icon: 'fa-check-circle', options: ['对', '错'] },
      blank: { name: '填空题', icon: 'fa-keyboard', options: [] },
      cloze: { name: '完形填空', icon: 'fa-puzzle-piece', options: [] },
      shortAnswer: { name: '简答题', icon: 'fa-align-left', options: [] },
      essay: { name: '简答题', icon: 'fa-align-left', options: [] },
      composite: { name: '复合题', icon: 'fa-layer-group', options: [] }
    };

    // 子题型配置
    const subQuestionTypes = {
      single: { name: '单选', options: ['A', 'B', 'C', 'D'] },
      multiple: { name: '多选', options: ['A', 'B', 'C', 'D'] },
      judge: { name: '判断', options: ['对', '错'] },
      blank: { name: '填空', options: [] },
      essay: { name: '简答', options: [] }
    };

    // 操作函数
    function previewPaper(id) {
      const paper = allPapers.find(p => p.id === id);
      if (!paper) {
        Message.error('试卷不存在');
        return;
      }

      // 抽题模式：使用弹窗预览
      if (paper.mode === 'extraction' || paper.mode === 'random') {
        // 保存当前预览的试卷ID
        previewPaperId = id;

        // 设置预览弹窗标题
        document.getElementById('extractionPreviewModalTitle').textContent = paper.name || '未命名试卷';
        document.getElementById('extractionPreviewPaperName').textContent = paper.name || '未命名试卷';
        document.getElementById('extractionPreviewPaperCode').textContent = paper.code || '暂无';

        // 判断是随机抽题还是固定抽题
        if (paper.extractionType === 'random' && paper.randomRules) {
          // 随机抽题：隐藏左侧导航栏
          document.getElementById('extractionPreviewNavigation').classList.add('hidden');

          // 显示抽题规则说明
          document.getElementById('extractionPreviewTotalScore').textContent = paper.totalScore || 100;
          renderRandomExtractionRulesPreview(paper.randomRules, paper.totalScore || 100);
        } else {
          // 固定抽题：显示左侧导航栏
          document.getElementById('extractionPreviewNavigation').classList.remove('hidden');

          // 计算并设置总分
          let totalScore = 0;
          (paper.questions || []).forEach(q => {
            totalScore += parseFloat(q.paperScore) || 0;
          });
          document.getElementById('extractionPreviewTotalScore').textContent = totalScore;

          // 渲染题目列表
          renderExtractionPreviewQuestions(paper.questions || []);
        }

        // 显示弹窗
        document.getElementById('extractionPreviewModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        return;
      }

      // 文档模式：在弹窗中预览
      // 保存当前预览的试卷ID
      previewPaperId = id;

      // 设置标题
      document.getElementById('previewPaperTitle').textContent = paper.name || paper.title || '未命名试卷';
      document.getElementById('previewTotalScore').textContent = paper.totalScore || 100;

      // 设置文件预览
      const pdfFrame = document.getElementById('previewPdfFrame');
      const wordNotice = document.getElementById('previewWordNotice');
      const noFile = document.getElementById('previewNoFile');

      // 先隐藏所有
      pdfFrame.classList.add('hidden');
      wordNotice.classList.add('hidden');
      noFile.classList.add('hidden');

      if (paper.file && paper.file.data) {
        document.getElementById('previewFileName').textContent = paper.file.name;
        const isPDF = paper.file.type === 'application/pdf';

        if (isPDF) {
          pdfFrame.src = paper.file.data;
          pdfFrame.classList.remove('hidden');
        } else {
          document.getElementById('previewWordFileName').textContent = paper.file.name;
          wordNotice.classList.remove('hidden');
        }
      } else {
        document.getElementById('previewFileName').textContent = '试卷文件';
        noFile.classList.remove('hidden');
      }

      // 渲染答题卡预览
      renderPreviewAnswerCard(paper.answerCard);

      // 显示弹窗
      document.getElementById('previewModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // 渲染预览答题卡
    function renderPreviewAnswerCard(answerCard) {
      const container = document.getElementById('previewAnswerCard');
      container.innerHTML = '';

      if (!answerCard || Object.keys(answerCard).length === 0) {
        container.innerHTML = '<div class="text-center text-gray-400 py-8"><i class="fas fa-inbox text-3xl mb-2"></i><p>暂无答题卡数据</p></div>';
        return;
      }

      const typeOrder = ['single', 'multiple', 'judge', 'blank', 'essay', 'composite'];

      typeOrder.forEach(type => {
        if (!answerCard[type]) return;

        const config = questionTypeConfig[type];
        const data = answerCard[type];
        const questions = data.questions || [];

        if (questions.length === 0) return;

        const typeSection = document.createElement('div');
        typeSection.className = 'mb-3 bg-white rounded-lg border border-gray-200';

        if (type === 'composite') {
          // 复合题预览
          const totalSubQuestions = questions.reduce((sum, q) => sum + (q.subQuestions?.length || 0), 0);
          const totalScore = questions.reduce((sum, q) => {
            return sum + (q.subQuestions?.reduce((subSum, sq) => subSum + (sq.score || 0), 0) || 0);
          }, 0);

          typeSection.innerHTML = `
            <div class="flex items-center justify-between px-3 py-2 bg-gray-50 border-b border-gray-200 rounded-t-lg">
              <div class="flex items-center space-x-1.5">
                <i class="fas ${config.icon} text-gray-600 text-xs"></i>
                <span class="font-medium text-gray-900 text-xs">${config.name}</span>
                <span class="text-xs text-gray-500">共 <span class="font-bold text-gray-900">${questions.length}</span> 大题 <span class="font-bold text-gray-900">${totalSubQuestions}</span> 小题，共 <span class="font-bold text-red-500">${totalScore}</span> 分</span>
              </div>
            </div>
            <div class="py-1">
              ${questions.map((q, qIndex) => renderPreviewCompositeQuestion(q, qIndex)).join('')}
            </div>
          `;
        } else {
          // 普通题型预览
          const questionCount = questions.length;
          const totalScore = questions.reduce((sum, q) => sum + (q.score || 0), 0);

          typeSection.innerHTML = `
            <div class="flex items-center justify-between px-3 py-2 bg-gray-50 border-b border-gray-200 rounded-t-lg">
              <div class="flex items-center space-x-1.5">
                <i class="fas ${config.icon} text-gray-600 text-xs"></i>
                <span class="font-medium text-gray-900 text-xs">${config.name}</span>
                <span class="text-xs text-gray-500">共 <span class="font-bold text-gray-900">${questionCount}</span> 题，共 <span class="font-bold text-red-500">${totalScore}</span> 分</span>
              </div>
            </div>
            <div class="space-y-0.5 py-1">
              ${questions.map((q, index) => renderPreviewQuestion(type, q, index)).join('')}
            </div>
          `;
        }

        container.appendChild(typeSection);
      });
    }

    // 渲染预览普通题目
    function renderPreviewQuestion(type, q, index) {
      const config = questionTypeConfig[type];
      let answerHtml = '';

      if (config.options.length > 0) {
        // 有选项的题型
        const answers = Array.isArray(q.answer) ? q.answer : (q.answer ? [q.answer] : []);
        let currentOptions = q.customOptions || config.options;

        answerHtml = `
          <div class="flex items-center flex-wrap gap-1 flex-1">
            ${currentOptions.map(opt => `
              <span class="px-2 py-0.5 border rounded text-xs font-medium ${answers.includes(opt) ? 'bg-blue-500 text-white border-blue-500' : 'border-gray-300 text-gray-600'}">
                ${opt}
              </span>
            `).join('')}
          </div>
        `;
      } else if (type === 'essay') {
        answerHtml = `<div class="flex-1 text-xs text-gray-400">（主观题）</div>`;
      } else {
        // 填空题
        answerHtml = `
          <div class="flex-1 px-2 py-0.5 bg-gray-100 rounded text-xs text-gray-700">
            ${q.answer || '<span class="text-gray-400">未设置答案</span>'}
          </div>
        `;
      }

      // 答案解析
      const explanationHtml = q.explanation ? `
        <div class="px-2 pb-2 ml-6">
          <div class="bg-yellow-50 border border-yellow-200 rounded p-2">
            <div class="flex items-center space-x-1 text-xs text-yellow-700 mb-1">
              <i class="fas fa-lightbulb"></i>
              <span class="font-medium">答案解析</span>
            </div>
            <div class="text-xs text-gray-700">${q.explanation}</div>
          </div>
        </div>
      ` : '';

      return `
        <div>
          <div class="flex items-start space-x-1.5 px-2 py-1 text-xs">
            <span class="font-semibold text-gray-700 min-w-[20px]">${index + 1}.</span>
            <span class="text-gray-500 min-w-[40px]">${q.score || 0}分</span>
            ${answerHtml}
          </div>
          ${explanationHtml}
        </div>
      `;
    }

    // 渲染预览复合题
    function renderPreviewCompositeQuestion(q, qIndex) {
      const totalScore = (q.subQuestions || []).reduce((sum, sq) => sum + (sq.score || 0), 0);

      return `
        <div class="border border-gray-200 rounded-lg mx-2 mb-2 bg-white">
          <div class="flex items-center justify-between px-3 py-2 bg-blue-50 border-b border-gray-200 rounded-t-lg">
            <div class="flex items-center space-x-2">
              <span class="font-semibold text-gray-900 text-sm">第 ${qIndex + 1} 大题</span>
              <span class="text-xs text-gray-500">（共 <span class="font-bold text-gray-900">${(q.subQuestions || []).length}</span> 小题，共 <span class="font-bold text-red-500">${totalScore}</span> 分）</span>
            </div>
          </div>
          <div class="p-2 space-y-1">
            ${(q.subQuestions || []).map((sq, sqIndex) => renderPreviewSubQuestion(sq, sqIndex)).join('')}
          </div>
        </div>
      `;
    }

    // 渲染预览子题目
    function renderPreviewSubQuestion(sq, sqIndex) {
      const subConfig = subQuestionTypes[sq.type] || { name: '未知', options: [] };
      let answerHtml = '';

      if (subConfig.options.length > 0) {
        // 有选项的题型
        const answers = Array.isArray(sq.answer) ? sq.answer : (sq.answer ? [sq.answer] : []);
        let currentOptions = sq.customOptions || subConfig.options;

        answerHtml = `
          <div class="flex items-center flex-wrap gap-1 flex-1">
            ${currentOptions.map(opt => `
              <span class="px-2 py-0.5 border rounded text-xs font-medium ${answers.includes(opt) ? 'bg-blue-500 text-white border-blue-500' : 'border-gray-300 text-gray-600'}">
                ${opt}
              </span>
            `).join('')}
          </div>
        `;
      } else if (sq.type === 'essay') {
        answerHtml = `<div class="flex-1 text-xs text-gray-400">（主观题）</div>`;
      } else {
        // 填空题
        answerHtml = `
          <div class="flex-1 px-2 py-0.5 bg-gray-100 rounded text-xs text-gray-700">
            ${sq.answer || '<span class="text-gray-400">未设置答案</span>'}
          </div>
        `;
      }

      // 答案解析
      const explanationHtml = sq.explanation ? `
        <div class="mt-1 ml-8">
          <div class="bg-yellow-50 border border-yellow-200 rounded p-2">
            <div class="flex items-center space-x-1 text-xs text-yellow-700 mb-1">
              <i class="fas fa-lightbulb"></i>
              <span class="font-medium">答案解析</span>
            </div>
            <div class="text-xs text-gray-700">${sq.explanation}</div>
          </div>
        </div>
      ` : '';

      return `
        <div class="bg-gray-50 rounded p-2">
          <div class="flex items-start space-x-1.5 text-xs">
            <span class="font-semibold text-gray-700 min-w-[32px]">(${sqIndex + 1})</span>
            <span class="px-1.5 py-0.5 bg-gray-200 rounded text-gray-600 text-xs">${subConfig.name}</span>
            <span class="text-gray-500 min-w-[40px]">${sq.score || 0}分</span>
            ${answerHtml}
          </div>
          ${explanationHtml}
        </div>
      `;
    }

    // 关闭预览弹窗
    function closePreviewModal() {
      document.getElementById('previewModal').classList.add('hidden');
      document.body.style.overflow = '';
      previewPaperId = null;

      // 清理 PDF URL
      const pdfFrame = document.getElementById('previewPdfFrame');
      if (pdfFrame.src && pdfFrame.src.startsWith('blob:')) {
        URL.revokeObjectURL(pdfFrame.src);
      }
      pdfFrame.src = '';
    }

    function editPaper(id) {
      const paper = allPapers.find(p => p.id === id);
      if (paper) {
        if (paper.mode === 'document') {
          // 文档模式跳转到 document.html
          window.location.href = `document.html?id=${id}`;
        } else if (paper.mode === 'extraction' || paper.mode === 'random') {
          // 抽题模式：根据 extractionType 跳转到不同页面
          if (paper.extractionType === 'random') {
            // 随机抽题 → random-extraction.html
            window.location.href = `random-extraction.html?id=${id}`;
          } else {
            // 固定抽题 → extraction.html
            localStorage.setItem('currentPaper', JSON.stringify(paper));
            window.location.href = `extraction.html?id=${id}`;
          }
        } else {
          // 其他模式暂未实现
          Message.warning('该模式暂未实现');
        }
      }
    }
    function copyPaper(id) {
      const paper = allPapers.find(p => p.id === id);
      if (paper) {
        const newPaper = { ...paper, id: 'P' + Date.now(), code: 'EXAM-' + Date.now(), name: paper.name + ' (副本)', status: 'draft', usageCount: 0, createTime: new Date().toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-') };
        allPapers.unshift(newPaper);
        localStorage.setItem('allPapers', JSON.stringify(allPapers));
        // 按创建时间倒序排列
        allPapers.sort((a, b) => {
          const timeA = new Date(a.createTime || '2000-01-01 00:00:00').getTime();
          const timeB = new Date(b.createTime || '2000-01-01 00:00:00').getTime();
          return timeB - timeA;
        });
        filteredPapers = [...allPapers];
        renderList();
        Message.success('试卷复制成功');
      }
    }

    function deletePaper(id) {
      const paper = allPapers.find(p => p.id === id);
      if (!paper) return;

      // 删除逻辑：草稿可删除；已发布且使用次数为0可删除；已发布且使用次数>0不可删除
      if (paper.status === 'published' && (paper.usageCount || 0) > 0) {
        Message.warning('该试卷已发布且被使用，无法删除');
        return;
      }

      deleteTargetId = id;
      document.getElementById('deletePaperName').textContent = paper.name || paper.title || '';
      document.getElementById('deleteModal').classList.remove('hidden');
      document.getElementById('deleteModal').classList.add('flex');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.add('hidden');
      document.getElementById('deleteModal').classList.remove('flex');
      deleteTargetId = null;
    }

    function confirmDelete() {
      if (deleteTargetId) {
        allPapers = allPapers.filter(p => p.id !== deleteTargetId);
        localStorage.setItem('allPapers', JSON.stringify(allPapers));
        filteredPapers = filteredPapers.filter(p => p.id !== deleteTargetId);
        renderList();
        Message.success('试卷删除成功');
        closeDeleteModal();
      }
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      initDemoData();
      // 按创建时间倒序排列（最新的在最前面）
      allPapers.sort((a, b) => {
        const timeA = new Date(a.createTime || '2000-01-01 00:00:00').getTime();
        const timeB = new Date(b.createTime || '2000-01-01 00:00:00').getTime();
        return timeB - timeA;
      });
      filteredPapers = [...allPapers];
      renderList();

      // 支持从 URL 参数自动预览试卷（供考试模块调用）
      const urlParams = new URLSearchParams(window.location.search);
      const autoPreviewId = urlParams.get('autoPreview');
      if (autoPreviewId) {
        // 延迟执行预览，确保页面完全加载
        setTimeout(() => {
          previewPaper(autoPreviewId);
        }, 300);
      }
    });

    // ========== 创建试卷弹窗相关函数 ==========

    // 生成试卷编号（格式：EXAM + YYYYMMDD + 序号）
    function generatePaperCode() {
      const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
      const papers = JSON.parse(localStorage.getItem('allPapers') || '[]');
      const todayPapers = papers.filter(p => p.code && p.code.startsWith('EXAM' + today));
      const seq = (todayPapers.length + 1).toString().padStart(3, '0');
      return `EXAM${today}${seq}`;
    }

    // 打开创建试卷弹窗
    function openCreatePaperModal() {
      // 生成试卷编号
      document.getElementById('modalPaperCode').value = generatePaperCode();
      // 清空试卷名称
      document.getElementById('modalPaperName').value = '';
      // 重置总分
      document.getElementById('modalTotalScore').value = '100';
      // 默认选中文档模式
      document.querySelector('input[name="paperMode"][value="document"]').checked = true;
      // 显示弹窗
      document.getElementById('createPaperModal').classList.remove('hidden');
    }

    // 关闭创建试卷弹窗
    function closeCreatePaperModal() {
      document.getElementById('createPaperModal').classList.add('hidden');
    }

    // 验证表单
    function validatePaperForm() {
      const name = document.getElementById('modalPaperName').value.trim();
      const code = document.getElementById('modalPaperCode').value.trim();
      const totalScore = parseInt(document.getElementById('modalTotalScore').value);
      const mode = document.querySelector('input[name="paperMode"]:checked')?.value;

      // 验证试卷名称
      if (!name) {
        Message.warning('请输入试卷名称');
        return false;
      }

      // 验证试卷编号
      if (!code) {
        Message.warning('请输入试卷编号');
        return false;
      }

      // 验证编号唯一性
      const papers = JSON.parse(localStorage.getItem('allPapers') || '[]');
      if (papers.some(p => p.code === code)) {
        Message.error('试卷编号已存在，请使用其他编号');
        return false;
      }

      // 验证试卷总分
      if (!totalScore || totalScore <= 0) {
        Message.warning('请输入试卷总分，且总分必须大于0');
        return false;
      }

      // 验证组卷模式
      if (!mode) {
        Message.warning('请选择组卷模式');
        return false;
      }

      return true;
    }

    // 确认创建试卷
    function confirmCreatePaper() {
      // 验证表单
      if (!validatePaperForm()) {
        return;
      }

      const name = document.getElementById('modalPaperName').value.trim();
      const code = document.getElementById('modalPaperCode').value.trim();
      const totalScore = parseInt(document.getElementById('modalTotalScore').value);
      const mode = document.querySelector('input[name="paperMode"]:checked').value;

      // 获取抽题子模式
      let extractionType = 'fixed';
      if (mode === 'extraction') {
        const extractionTypeRadio = document.querySelector('input[name="extractionType"]:checked');
        extractionType = extractionTypeRadio ? extractionTypeRadio.value : 'fixed';
      }

      // 生成唯一ID
      const paperId = 'P' + Date.now() + Math.random().toString(36).substr(2, 9);

      // 创建试卷数据
      const paperData = {
        id: paperId,
        name: name,
        code: code,
        totalScore: totalScore,
        mode: mode === 'extraction' ? 'extraction' : mode,
        extractionType: extractionType,
        status: 'draft',
        createTime: new Date().toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-'),
        usageCount: 0
      };

      // 保存到 LocalStorage（用于对应页面读取）
      localStorage.setItem('currentPaper', JSON.stringify(paperData));

      // 关闭弹窗
      closeCreatePaperModal();

      // 跳转到对应页面
      if (mode === 'document') {
        window.location.href = 'document.html';
      } else if (mode === 'extraction') {
        if (extractionType === 'random') {
          window.location.href = 'random-extraction.html';
        } else {
          window.location.href = 'extraction.html';
        }
      } else {
        // 其他模式暂未实现
        Message.warning('该模式暂未实现');
      }
    }

    // 切换抽题模式子选项展开/收起
    function toggleExtractionOptions() {
      const subOptions = document.getElementById('extractionSubOptions');
      const expandIcon = document.getElementById('extractionExpandIcon');
      const extractionRadio = document.querySelector('input[name="paperMode"][value="extraction"]');
      const container = document.getElementById('extractionModeContainer');

      // 选中抽题模式
      extractionRadio.checked = true;

      // 切换展开状态
      subOptions.classList.toggle('hidden');
      expandIcon.classList.toggle('rotate-180');

      // 更新容器边框颜色
      if (!subOptions.classList.contains('hidden')) {
        container.classList.add('border-primary-500');
      } else {
        container.classList.remove('border-primary-500');
      }
    }

    // 点击遮罩层关闭弹窗
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('createPaperModal');
      if (e.target === modal) {
        closeCreatePaperModal();
      }
    });

    // ========== 抽题模式预览相关函数 ==========

    // 类型标准化
    function normalizeType(type) {
      const typeMap = {
        'essay': 'shortAnswer',
        'short': 'shortAnswer',
        'shortanswer': 'shortAnswer'
      };
      return typeMap[type?.toLowerCase()] || type;
    }

    // 关闭抽题预览弹窗
    function closeExtractionPreviewModal() {
      document.getElementById('extractionPreviewModal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    // 编辑抽题试卷
    function editExtractionPaper() {
      if (!previewPaperId) return;

      const paper = allPapers.find(p => p.id === previewPaperId);
      if (paper) {
        // 根据抽题类型跳转到不同页面
        if (paper.extractionType === 'random') {
          // 随机抽题 → random-extraction.html
          window.location.href = `random-extraction.html?id=${previewPaperId}`;
        } else {
          // 固定抽题 → extraction.html
          localStorage.setItem('currentPaper', JSON.stringify(paper));
          window.location.href = `extraction.html?id=${previewPaperId}`;
        }
      }
    }

    // 渲染随机抽题规则预览
    function renderRandomExtractionRulesPreview(randomRules, totalScore) {
      // 只替换题目容器，不破坏整个 modal 结构
      const container = document.getElementById('extractionPreviewQuestionsContainer');

      // 题型配置
      const typeConfig = {
        single: { name: '单选题', icon: 'fa-dot-circle', color: 'info' },
        multiple: { name: '多选题', icon: 'fa-check-double', color: 'purple' },
        judge: { name: '判断题', icon: 'fa-check-circle', color: 'success' },
        blank: { name: '填空题', icon: 'fa-keyboard', color: 'warning' },
        cloze: { name: '完形填空', icon: 'fa-puzzle-piece', color: 'indigo' },
        short: { name: '简答题', icon: 'fa-align-left', color: 'amber' },
        composite: { name: '复合题', icon: 'fa-layer-group', color: 'purple' }
      };

      let html = `
        <div class="flex items-center gap-3 mb-6">
          <div class="w-12 h-12 bg-purple-50 rounded-lg flex items-center justify-center">
            <i class="fas fa-random text-purple-600 text-xl"></i>
          </div>
          <div>
            <h2 class="text-xl font-bold text-gray-900">随机抽题模式</h2>
            <p class="text-sm text-gray-500 mt-1">每次考试从题库中随机抽取题目，保证试卷多样性</p>
          </div>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
          <div class="flex items-start gap-3">
            <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
            <div class="flex-1 text-sm text-blue-800">
              <div class="font-medium mb-1">预览说明</div>
                  <div>随机抽题模式的试卷在每次考试时才会随机生成，因此无法预览具体题目。下方展示的是抽题规则配置。如需查看实际抽取效果，请点击"编辑试卷"按钮进入编辑页面，使用"抽一份看看"功能。</div>
                </div>
              </div>
            </div>

            <div class="space-y-4">
              <div class="flex items-center justify-between py-3 border-b border-gray-200">
                <span class="text-sm font-medium text-gray-700">试卷总分</span>
                <span class="text-lg font-bold text-primary-600">${totalScore} 分</span>
              </div>
      `;

      // 全局筛选条件
      if (randomRules.globalFilters) {
        const filters = randomRules.globalFilters;

        html += `
          <div class="py-3 border-b border-gray-200">
            <div class="text-sm font-medium text-gray-700 mb-2">全局筛选条件</div>
            <div class="flex flex-wrap gap-2">
        `;

        // 难度筛选
        if (filters.difficulties && filters.difficulties.length > 0) {
          const difficultyNames = {1: '一级', 2: '二级', 3: '三级', 4: '四级', 5: '五级'};
          filters.difficulties.forEach(d => {
            html += `<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">难度：${difficultyNames[d] || d}</span>`;
          });
        }

        // 知识点筛选
        if (filters.knowledgeIds && filters.knowledgeIds.length > 0) {
          html += `<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">已选 ${filters.knowledgeIds.length} 个知识点</span>`;
        }

        html += `
            </div>
          </div>
        `;
      }

      // 题型抽取规则
      html += `
        <div class="py-3">
          <div class="text-sm font-medium text-gray-700 mb-3">题型抽取规则</div>
          <div class="space-y-3">
      `;

      const typeRules = randomRules.typeRules || {};
      Object.entries(typeRules).forEach(([type, rule]) => {
        if (rule.count > 0) {
          const config = typeConfig[type] || { name: '未知题型', icon: 'fa-question', color: 'gray' };
          const scoreModeText = rule.scoreMode === 'custom' ? `自设分数：${rule.customScore}分/题` : '题库分数';
          const totalTypeScore = rule.scoreMode === 'custom' ? (rule.count * rule.customScore).toFixed(1) : '根据题库';

          // 根据题型设置颜色类（固定类名以支持Tailwind）
          let bgClass = 'bg-gray-50';
          let iconColorClass = 'text-gray-600';
          if (config.color === 'info') {
            bgClass = 'bg-blue-50';
            iconColorClass = 'text-blue-600';
          } else if (config.color === 'purple') {
            bgClass = 'bg-purple-50';
            iconColorClass = 'text-purple-600';
          } else if (config.color === 'success') {
            bgClass = 'bg-green-50';
            iconColorClass = 'text-green-600';
          } else if (config.color === 'warning') {
            bgClass = 'bg-orange-50';
            iconColorClass = 'text-orange-600';
          } else if (config.color === 'indigo') {
            bgClass = 'bg-indigo-50';
            iconColorClass = 'text-indigo-600';
          } else if (config.color === 'amber') {
            bgClass = 'bg-amber-50';
            iconColorClass = 'text-amber-600';
          }

          html += `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 ${bgClass} rounded-lg flex items-center justify-center">
                  <i class="fas ${config.icon} ${iconColorClass}"></i>
                </div>
                <div>
                  <div class="font-medium text-gray-900">${config.name}</div>
                  <div class="text-xs text-gray-500">${scoreModeText}</div>
                </div>
              </div>
              <div class="text-right">
                <div class="text-sm font-medium text-gray-900">${rule.count} 题</div>
                <div class="text-xs text-gray-500">${totalTypeScore}${rule.scoreMode === 'custom' ? ' 分' : ''}</div>
              </div>
            </div>
          `;
        }
      });

      html += `
          </div>
        </div>
      `;

      html += `
        </div>

        <div class="mt-6 flex items-center justify-center gap-3">
          <button onclick="editExtractionPaper()" class="px-6 py-2.5 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium transition-colors">
            <i class="fas fa-edit mr-2"></i>编辑试卷
          </button>
          <button onclick="closeExtractionPreviewModal()" class="px-6 py-2.5 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg text-sm font-medium transition-colors">
            <i class="fas fa-times mr-2"></i>关闭预览
          </button>
        </div>
      `;

      container.innerHTML = html;
    }

    // 渲染抽题预览题目
    function renderExtractionPreviewQuestions(questions) {
      const container = document.getElementById('extractionPreviewQuestionsContainer');
      const navContainer = document.getElementById('extractionPreviewNavigationContainer');

      // 按题型分组题目
      const questionsByType = {};
      questions.forEach(data => {
        const q = data.question || data;
        const normalizedType = normalizeType(q.type);
        if (!questionsByType[normalizedType]) {
          questionsByType[normalizedType] = [];
        }
        questionsByType[normalizedType].push(data);
      });

      // 题型顺序
      const typeOrder = ['single', 'multiple', 'judge', 'blank', 'cloze', 'shortAnswer', 'composite'];

      let html = '';
      let navHtml = '';
      let globalQuestionNumber = 1;
      let navQuestions = [];

      typeOrder.forEach(type => {
        if (!questionsByType[type] || questionsByType[type].length === 0) return;

        const typeConfig = questionTypeConfig[type] || { name: '未知题型' };
        const typeQuestions = questionsByType[type];

        html += `
          <div class="question-type-section">
            <h2 class="text-xl font-bold text-gray-800 mb-6 pb-2 border-b-2 border-primary-500">
              ${typeConfig.name}（共 ${typeQuestions.length} 题）
            </h2>
            <div class="space-y-6">
        `;

        typeQuestions.forEach(data => {
          const q = data.question || data;
          const score = data.paperScore || 0;
          const questionId = `extraction-preview-question-${globalQuestionNumber}`;

          navQuestions.push({
            number: globalQuestionNumber,
            type: typeConfig.name,
            id: questionId
          });

          html += `
            <div class="question-item" id="${questionId}">
              <div class="flex items-start space-x-3 mb-3">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary-500 text-white flex items-center justify-center font-semibold text-sm">
                  ${globalQuestionNumber}
                </div>
                <div class="flex-1">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-2">
                      <span class="text-sm text-gray-500">${typeConfig.name}</span>
                      ${q.knowledgePath ? `<span class="text-xs text-gray-400">· ${q.knowledgePath}</span>` : ''}
                    </div>
                    <span class="text-sm font-medium text-primary-600">${score} 分</span>
                  </div>
                  <div class="question-content text-gray-900 text-base leading-relaxed mb-3">
                    ${q.content}
                  </div>
          `;

          // 根据题型显示选项和答案
          if (type === 'single' || type === 'multiple') {
            html += '<div class="space-y-2 ml-4">';
            if (q.options && q.options.length > 0) {
              q.options.forEach(opt => {
                const isCorrect = q.correctAnswers && q.correctAnswers.includes(opt.label);
                html += `
                  <div class="flex items-start space-x-2">
                    <span class="font-medium ${isCorrect ? 'text-green-600' : 'text-gray-600'}">${opt.label}.</span>
                    <span class="${isCorrect ? 'text-green-600 font-medium' : 'text-gray-700'}">${opt.text}</span>
                  </div>
                `;
              });
            }
            html += '</div>';

            if (q.correctAnswers && q.correctAnswers.length > 0) {
              html += `
                <div class="mt-3 p-3 bg-green-50 rounded-lg">
                  <span class="text-sm font-medium text-green-700">答案：</span>
                  <span class="text-sm text-green-600">${q.correctAnswers.join('、')}</span>
                </div>
              `;
            }
          } else if (type === 'judge') {
            if (q.correctAnswers && q.correctAnswers.length > 0) {
              html += `
                <div class="mt-3 p-3 bg-green-50 rounded-lg">
                  <span class="text-sm font-medium text-green-700">答案：</span>
                  <span class="text-sm text-green-600">${q.correctAnswers[0]}</span>
                </div>
              `;
            }
          } else if (type === 'blank') {
            if (q.correctAnswers && q.correctAnswers.length > 0) {
              html += `
                <div class="mt-3 p-3 bg-green-50 rounded-lg">
                  <span class="text-sm font-medium text-green-700">答案：</span>
                  <span class="text-sm text-green-600">${q.correctAnswers.map((ans, idx) => `空${idx + 1}：${ans}`).join('；')}</span>
                </div>
              `;
            }
          } else if (type === 'cloze') {
            if (q.blanks && q.blanks.length > 0) {
              html += '<div class="space-y-3 ml-4 mt-3">';
              q.blanks.forEach((blank, blankIndex) => {
                html += `
                  <div>
                    <div class="font-medium text-gray-700 mb-2">空 ${blankIndex + 1}：</div>
                    <div class="space-y-1 ml-4">
                `;
                if (blank.options && blank.options.length > 0) {
                  blank.options.forEach(opt => {
                    const isCorrect = blank.correctAnswer === opt.label;
                    html += `
                      <div class="flex items-start space-x-2">
                        <span class="font-medium ${isCorrect ? 'text-green-600' : 'text-gray-600'}">${opt.label}.</span>
                        <span class="${isCorrect ? 'text-green-600 font-medium' : 'text-gray-700'}">${opt.text}</span>
                      </div>
                    `;
                  });
                }
                html += `
                    </div>
                    <div class="mt-2 p-2 bg-green-50 rounded text-sm">
                      <span class="font-medium text-green-700">答案：</span>
                      <span class="text-green-600">${blank.correctAnswer}</span>
                    </div>
                  </div>
                `;
              });
              html += '</div>';
            }
          } else if (type === 'shortAnswer') {
            if (q.correctAnswers && q.correctAnswers.length > 0 && q.correctAnswers[0]) {
              html += `
                <div class="mt-3 p-3 bg-green-50 rounded-lg">
                  <div class="text-sm font-medium text-green-700 mb-2">参考答案：</div>
                  <div class="text-sm text-green-600 whitespace-pre-wrap">${q.correctAnswers[0]}</div>
                </div>
              `;
            }
          } else if (type === 'composite') {
            if (q.subQuestions && q.subQuestions.length > 0) {
              html += '<div class="mt-4 space-y-4">';
              q.subQuestions.forEach((sub, subIndex) => {
                const subType = normalizeType(sub.type);
                html += `
                  <div class="ml-6 p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                      <div class="font-medium text-gray-800">${globalQuestionNumber}.${subIndex + 1} ${sub.content}</div>
                    </div>
                `;

                if (subType === 'single' || subType === 'multiple') {
                  html += '<div class="space-y-1 ml-4 mt-2">';
                  if (sub.options && sub.options.length > 0) {
                    sub.options.forEach(opt => {
                      const isCorrect = sub.correctAnswers && sub.correctAnswers.includes(opt.label);
                      html += `
                        <div class="flex items-start space-x-2">
                          <span class="font-medium ${isCorrect ? 'text-green-600' : 'text-gray-600'}">${opt.label}.</span>
                          <span class="${isCorrect ? 'text-green-600 font-medium' : 'text-gray-700'}">${opt.text}</span>
                        </div>
                      `;
                    });
                  }
                  html += '</div>';
                  if (sub.correctAnswers && sub.correctAnswers.length > 0) {
                    html += `
                      <div class="mt-2 p-2 bg-green-50 rounded text-sm">
                        <span class="font-medium text-green-700">答案：</span>
                        <span class="text-green-600">${sub.correctAnswers.join('、')}</span>
                      </div>
                    `;
                  }
                } else if (subType === 'shortAnswer') {
                  if (sub.correctAnswers && sub.correctAnswers.length > 0 && sub.correctAnswers[0]) {
                    html += `
                      <div class="mt-2 p-2 bg-green-50 rounded text-sm">
                        <div class="font-medium text-green-700 mb-1">参考答案：</div>
                        <div class="text-green-600 whitespace-pre-wrap">${sub.correctAnswers[0]}</div>
                      </div>
                    `;
                  }
                }

                html += '</div>';
              });
              html += '</div>';
            }
          }

          // 显示解析
          if (q.explanation) {
            html += `
              <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                <div class="text-sm font-medium text-blue-700 mb-2">解析：</div>
                <div class="text-sm text-blue-600 leading-relaxed">${q.explanation}</div>
              </div>
            `;
          }

          html += `
                </div>
              </div>
            </div>
          `;

          globalQuestionNumber++;
        });

        html += `
            </div>
          </div>
        `;
      });

      container.innerHTML = html || '<div class="text-center text-gray-400 py-16">暂无题目</div>';

      // 生成导航
      if (navQuestions.length > 0) {
        const navByType = {};
        const typeOrderList = [];

        navQuestions.forEach(item => {
          if (!navByType[item.type]) {
            navByType[item.type] = [];
            typeOrderList.push(item.type);
          }
          navByType[item.type].push(item);
        });

        navHtml = `
          <div class="mb-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">题目导航</h3>
            <div class="text-xs text-gray-500 mb-4">共 ${navQuestions.length} 道题</div>
          </div>
        `;

        typeOrderList.forEach(typeName => {
          const typeQuestions = navByType[typeName];
          navHtml += `
            <div class="mb-6">
              <div class="flex items-center mb-3">
                <div class="w-1 h-5 bg-primary-500 rounded mr-2"></div>
                <h4 class="text-sm font-medium text-gray-800">${typeName}</h4>
              </div>
              <div class="grid grid-cols-5 gap-2">
          `;

          typeQuestions.forEach(item => {
            navHtml += `
              <button onclick="scrollToExtractionPreviewQuestion('${item.id}')"
                      class="extraction-preview-nav-item aspect-square flex items-center justify-center text-sm font-medium border border-gray-300 rounded transition-colors"
                      data-question-id="${item.id}">
                ${item.number}
              </button>
            `;
          });

          navHtml += `
              </div>
            </div>
          `;
        });
      } else {
        navHtml = '<div class="text-center text-gray-400 py-8">暂无题目</div>';
      }

      navContainer.innerHTML = navHtml;

      // 设置滚动监听
      setupExtractionPreviewScrollTracking();
    }

    // 滚动到指定题目
    function scrollToExtractionPreviewQuestion(questionId) {
      const scrollContainer = document.getElementById('extractionPreviewScrollContainer');
      const questionElement = document.getElementById(questionId);

      if (questionElement && scrollContainer) {
        const containerTop = scrollContainer.offsetTop;
        const elementTop = questionElement.offsetTop;
        const offset = elementTop - containerTop - 100;

        scrollContainer.scrollTo({
          top: offset,
          behavior: 'smooth'
        });

        updateExtractionPreviewActiveNav(questionId);
      }
    }

    // 更新导航激活状态
    function updateExtractionPreviewActiveNav(questionId) {
      document.querySelectorAll('.extraction-preview-nav-item').forEach(item => {
        item.classList.remove('active');
      });

      const activeNav = document.querySelector(`.extraction-preview-nav-item[data-question-id="${questionId}"]`);
      if (activeNav) {
        activeNav.classList.add('active');
      }
    }

    // 设置滚动跟踪
    function setupExtractionPreviewScrollTracking() {
      const scrollContainer = document.getElementById('extractionPreviewScrollContainer');
      if (!scrollContainer) return;

      if (scrollContainer._scrollHandler) {
        scrollContainer.removeEventListener('scroll', scrollContainer._scrollHandler);
      }

      const scrollHandler = () => {
        const questions = document.querySelectorAll('#extractionPreviewQuestionsContainer .question-item');
        const scrollTop = scrollContainer.scrollTop;
        const containerTop = scrollContainer.offsetTop;

        for (let i = questions.length - 1; i >= 0; i--) {
          const question = questions[i];
          const questionTop = question.offsetTop - containerTop - 150;

          if (scrollTop >= questionTop) {
            updateExtractionPreviewActiveNav(question.id);
            break;
          }
        }
      };

      scrollContainer._scrollHandler = scrollHandler;
      scrollContainer.addEventListener('scroll', scrollHandler);
    }
  </script>

  <!-- 创建试卷弹窗 -->
  <div id="createPaperModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-[500px] max-h-[90vh] overflow-y-auto">
      <!-- 标题 -->
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">创建试卷</h3>
      </div>

      <!-- 表单 -->
      <div class="px-6 py-4 space-y-4">
        <!-- 试卷名称 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            试卷名称 <span class="text-red-500">*</span>
          </label>
          <input type="text" id="modalPaperName" placeholder="请输入试卷名称"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
        </div>

        <!-- 试卷编号 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            试卷编号 <span class="text-red-500">*</span>
          </label>
          <input type="text" id="modalPaperCode" placeholder="自动生成或手动输入"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
          <p class="mt-1 text-xs text-gray-500">系统已自动生成编号，您也可以手动修改</p>
        </div>

        <!-- 试卷总分 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            试卷总分 <span class="text-red-500">*</span>
          </label>
          <input type="number" id="modalTotalScore" value="100" min="1"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
        </div>

        <!-- 组卷模式 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            组卷模式 <span class="text-red-500">*</span>
          </label>
          <div class="space-y-2">
            <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
              <input type="radio" name="paperMode" value="document" checked
                class="w-4 h-4 text-primary-500 focus:ring-primary-500">
              <div class="ml-3">
                <div class="text-sm font-medium text-gray-900">文档模式</div>
                <div class="text-xs text-gray-500">上传 PDF/Word 文档，设置答题卡</div>
              </div>
            </label>
            <!-- 抽题模式（可展开） -->
            <div class="border border-gray-300 rounded-lg overflow-hidden" id="extractionModeContainer">
              <!-- 主选项 -->
              <div class="flex items-center p-3 cursor-pointer hover:bg-gray-50 transition-colors"
                   onclick="toggleExtractionOptions()">
                <input type="radio" name="paperMode" value="extraction"
                  class="w-4 h-4 text-primary-500 focus:ring-primary-500">
                <div class="ml-3 flex-1">
                  <div class="text-sm font-medium text-gray-900">抽题模式</div>
                  <div class="text-xs text-gray-500">从题库中按规则抽取题目组卷</div>
                </div>
                <i id="extractionExpandIcon" class="fas fa-chevron-down text-gray-400 transition-transform duration-200"></i>
              </div>
              <!-- 子选项（默认隐藏） -->
              <div id="extractionSubOptions" class="hidden border-t border-gray-200 bg-gray-50">
                <!-- 固定抽题 -->
                <label class="flex items-center p-3 pl-10 cursor-pointer hover:bg-gray-100 transition-colors">
                  <input type="radio" name="extractionType" value="fixed" checked
                    class="w-4 h-4 text-primary-500 focus:ring-primary-500">
                  <div class="ml-3">
                    <div class="text-sm font-medium text-gray-700">固定抽题</div>
                    <div class="text-xs text-gray-500">手动选择具体题目</div>
                  </div>
                </label>
                <!-- 随机抽题 -->
                <label class="flex items-center p-3 pl-10 cursor-pointer hover:bg-gray-100 transition-colors">
                  <input type="radio" name="extractionType" value="random"
                    class="w-4 h-4 text-primary-500 focus:ring-primary-500">
                  <div class="ml-3">
                    <div class="text-sm font-medium text-gray-700">随机抽题</div>
                    <div class="text-xs text-gray-500">按规则从题库随机抽取</div>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 按钮 -->
      <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
        <button onclick="closeCreatePaperModal()"
          class="px-4 py-2 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg text-sm font-medium transition-colors">
          取消
        </button>
        <button onclick="confirmCreatePaper()"
          class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium transition-colors">
          确定
        </button>
      </div>
    </div>
  </div>

  <!-- 抽题模式预览弹窗 -->
  <div id="extractionPreviewModal" class="fixed inset-0 z-50 hidden">
    <!-- 遮罩层 -->
    <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closeExtractionPreviewModal()"></div>
    <!-- 弹窗内容 -->
    <div class="absolute inset-4 bg-white rounded-lg shadow-2xl flex flex-col overflow-hidden">
      <!-- 弹窗头部 -->
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
        <div class="flex items-center space-x-3">
          <i class="fas fa-eye text-primary-500"></i>
          <span class="text-lg font-semibold text-gray-900">试卷预览</span>
          <span class="text-sm text-gray-500" id="extractionPreviewModalTitle"></span>
        </div>
        <div class="flex items-center space-x-3">
          <button onclick="editExtractionPaper()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium transition-colors">
            <i class="fas fa-edit mr-2"></i>编辑试卷
          </button>
          <button onclick="closeExtractionPreviewModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      <!-- 弹窗主体 -->
      <div class="flex-1 overflow-hidden flex">
        <!-- 左侧快速导航 -->
        <aside id="extractionPreviewNavigation" class="w-80 bg-white border-r border-gray-200 overflow-y-auto">
          <div id="extractionPreviewNavigationContainer" class="p-6">
            <!-- 导航将通过JavaScript动态生成 -->
          </div>
        </aside>
        <!-- 试卷内容区 -->
        <div id="extractionPreviewContent" class="flex-1 overflow-y-auto p-8 bg-gray-50">
          <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-sm p-8">
            <!-- 试卷头部 -->
            <div class="text-center mb-8 pb-6 border-b-2 border-gray-300">
              <h1 id="extractionPreviewPaperName" class="text-3xl font-bold text-gray-900 mb-4">试卷名称</h1>
              <div class="flex items-center justify-center space-x-8 text-sm text-gray-600">
                <div>
                  <span class="font-medium">试卷编号：</span>
                  <span id="extractionPreviewPaperCode">-</span>
                </div>
                <div>
                  <span class="font-medium">总分：</span>
                  <span id="extractionPreviewTotalScore" class="text-primary-600 font-semibold">0</span>
                  <span>分</span>
                </div>
              </div>
            </div>
            <!-- 题目列表 -->
            <div id="extractionPreviewQuestionsContainer" class="space-y-8">
              <!-- 题目将通过JavaScript动态生成 -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* 抽题预览导航激活状态 */
    .extraction-preview-nav-item {
      transition: all 0.2s;
      color: #374151;
      background-color: white;
    }
    .extraction-preview-nav-item.active {
      background-color: #00B96B;
      color: white;
      border-color: #00B96B;
    }
    .extraction-preview-nav-item:hover:not(.active) {
      background-color: #f0fdf4;
      border-color: #00B96B;
    }
  </style>

</body>
</html>