<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>试卷预览</title>
  <script src="https://unpkg.com/tailwindcss-cdn@3.4.1/tailwindcss.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#E6F9F0', 500: '#00B96B', 600: '#00A35C' }
          }
        }
      }
    }
  </script>
  <style>
    .answer-option {
      transition: all 0.2s;
      cursor: pointer;
      position: relative;
    }
    .answer-option:hover {
      border-color: #1890ff;
      background-color: #e6f7ff;
    }
    .answer-option.selected {
      background-color: #1890ff;
      color: white;
      border-color: #1890ff;
    }
    .answer-option.selected::before {
      content: '✓';
      position: absolute;
      top: -6px;
      right: -6px;
      width: 16px;
      height: 16px;
      background-color: #52c41a;
      color: white;
      border-radius: 50%;
      font-size: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- 文档模式预览容器 -->
  <div id="documentPreview" class="hidden h-screen flex">
    <!-- 左侧PDF显示区 -->
    <div class="flex-1 bg-gray-100 relative">
      <iframe id="pdfFrame" class="w-full h-full border-0"></iframe>
      <div id="noPdfMessage" class="hidden absolute inset-0 flex items-center justify-center bg-gray-100">
        <div class="text-center text-gray-500">
          <i class="fas fa-file-pdf text-6xl mb-4"></i>
          <p>暂无PDF文档</p>
        </div>
      </div>
    </div>

    <!-- 右侧答题卡 -->
    <div class="w-96 bg-white border-l border-gray-200 flex flex-col">
      <!-- 答题卡头部 -->
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-clipboard-list text-primary-500 mr-2"></i>答题卡
          </h3>
          <span class="text-sm text-gray-600">
            总分：<span id="docTotalScore" class="font-bold text-primary-600">100</span> 分
          </span>
        </div>
        <div class="text-sm text-gray-600">
          单选题 <span id="docSingleCount" class="font-semibold">5</span> 题，共 <span id="docSingleScore" class="font-semibold text-red-500">100</span> 分
        </div>
      </div>

      <!-- 答题卡内容 -->
      <div class="flex-1 overflow-y-auto px-6 py-4">
        <div id="documentAnswerCard"></div>
      </div>
    </div>
  </div>

  <!-- 抽题模式预览容器 -->
  <div id="extractionPreview" class="hidden h-screen overflow-y-auto">
    <div class="max-w-5xl mx-auto p-8">
      <!-- 试卷头部 -->
      <div class="bg-white rounded-lg shadow-sm p-8 mb-6">
        <div class="text-center pb-6 border-b-2 border-gray-300">
          <h1 id="extractionPaperName" class="text-3xl font-bold text-gray-900 mb-4">试卷名称</h1>
          <div class="flex items-center justify-center space-x-8 text-sm text-gray-600">
            <div>
              <span class="font-medium">试卷编号：</span>
              <span id="extractionPaperCode">-</span>
            </div>
            <div>
              <span class="font-medium">总分：</span>
              <span id="extractionTotalScore" class="text-primary-600 font-bold">100</span>
              <span>分</span>
            </div>
            <div>
              <span class="font-medium">题目数量：</span>
              <span id="extractionQuestionCount" class="text-primary-600 font-bold">0</span>
              <span>道</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 题目列表 -->
      <div id="extractionQuestionsContainer" class="space-y-6">
        <!-- 题目将通过JavaScript动态生成 -->
      </div>
    </div>
  </div>

  <script>
    // 题型配置
    const questionTypeConfig = {
      'single': { name: '单选题', icon: 'fa-check-circle' },
      'multiple': { name: '多选题', icon: 'fa-check-double' },
      'judge': { name: '判断题', icon: 'fa-balance-scale' },
      'blank': { name: '填空题', icon: 'fa-keyboard' },
      'shortAnswer': { name: '简答题', icon: 'fa-align-left' },
      'essay': { name: '简答题', icon: 'fa-align-left' },
      'cloze': { name: '完形填空', icon: 'fa-spell-check' },
      'composite': { name: '复合题', icon: 'fa-layer-group' }
    };

    // 页面加载时初始化
    window.addEventListener('DOMContentLoaded', function() {
      const previewData = JSON.parse(localStorage.getItem('previewPaper') || '{}');

      console.log('预览数据：', previewData);

      if (!previewData || !previewData.paperId) {
        document.body.innerHTML = '<div class="flex items-center justify-center h-screen"><p class="text-gray-500">未找到试卷数据</p></div>';
        return;
      }

      // 根据试卷模式显示不同内容
      if (previewData.mode === 'document') {
        showDocumentPreview(previewData);
      } else {
        showExtractionPreview(previewData);
      }
    });

    // 显示文档模式预览
    function showDocumentPreview(data) {
      console.log('显示文档模式预览，数据：', data);

      document.getElementById('documentPreview').classList.remove('hidden');

      // 加载PDF - 支持多种格式
      let pdfUrl = null;

      // 1. 检查 file 对象（document.html格式）
      if (data.file && typeof data.file === 'object' && data.file.data) {
        pdfUrl = data.file.data; // Base64格式
        console.log('使用file.data (Base64)');
      }
      // 2. 检查 file 字符串（直接URL）
      else if (data.file && typeof data.file === 'string') {
        pdfUrl = data.file;
        console.log('使用file字符串');
      }
      // 3. 检查 documentUrl
      else if (data.documentUrl) {
        pdfUrl = data.documentUrl;
        console.log('使用documentUrl');
      }

      console.log('最终PDF地址：', pdfUrl ? pdfUrl.substring(0, 100) : 'null');

      if (pdfUrl && (pdfUrl.startsWith('http') || pdfUrl.startsWith('blob:') || pdfUrl.startsWith('data:'))) {
        // HTTP/HTTPS/Blob/Data URL 都可以加载
        document.getElementById('pdfFrame').src = pdfUrl;
      } else {
        // 本地文件路径或无效URL，显示提示信息
        document.getElementById('noPdfMessage').classList.remove('hidden');
        if (pdfUrl) {
          document.getElementById('noPdfMessage').innerHTML = `
            <div class="text-center text-gray-500">
              <i class="fas fa-exclamation-triangle text-6xl mb-4 text-yellow-500"></i>
              <p class="mb-2">无法加载PDF文档</p>
              <p class="text-sm">本地文件路径无法在预览中显示</p>
              <p class="text-xs text-gray-400 mt-2 max-w-md break-all">文件路径：${pdfUrl.substring(0, 80)}...</p>
            </div>
          `;
        }
      }

      // 处理答题卡数据 - 支持两种格式
      let questions = [];

      console.log('原始data.questions:', data.questions);
      console.log('原始data.answerCard:', data.answerCard);

      // 1. 尝试从 questions 数组获取（list.html格式）
      if (data.questions && Array.isArray(data.questions) && data.questions.length > 0) {
        questions = data.questions;
        console.log('使用questions数组，长度：', questions.length);
      }
      // 2. 尝试从 answerCard 对象获取（document.html格式）
      else if (data.answerCard && typeof data.answerCard === 'object') {
        console.log('answerCard类型检测通过，开始解析...');
        const questionTypes = Object.keys(data.answerCard);
        console.log('answerCard包含的题型：', questionTypes);

        // answerCard 格式: { single: { questions: [...] }, multiple: {...}, ... }
        questionTypes.forEach(type => {
          const typeData = data.answerCard[type];
          console.log(`题型 ${type} 的数据：`, typeData);

          if (typeData && typeData.questions && Array.isArray(typeData.questions)) {
            console.log(`题型 ${type} 有 ${typeData.questions.length} 道题`);

            // 为每道题添加类型信息
            const questionsWithType = typeData.questions.map(q => ({
              ...q,
              type: type,
              questionNumber: q.id || q.questionNumber
            }));

            questions = questions.concat(questionsWithType);
          }
        });

        console.log('从answerCard转换，总题目数量：', questions.length);
      }

      console.log('最终题目列表：', questions);

      if (questions.length === 0) {
        document.getElementById('documentAnswerCard').innerHTML = '<p class="text-gray-500 text-center">暂无题目数据</p>';
        document.getElementById('docTotalScore').textContent = data.totalScore || 0;
        document.getElementById('docSingleCount').textContent = 0;
        document.getElementById('docSingleScore').textContent = 0;
        return;
      }

      // 统计单选题
      const singleQuestions = questions.filter(q => {
        const type = q.type || q.question?.type;
        return type === 'single';
      });
      const singleScore = singleQuestions.reduce((sum, q) => {
        const score = q.score || q.paperScore || q.question?.score || 0;
        return sum + parseFloat(score);
      }, 0);

      document.getElementById('docTotalScore').textContent = data.totalScore || 0;
      document.getElementById('docSingleCount').textContent = singleQuestions.length || questions.length;
      document.getElementById('docSingleScore').textContent = singleScore;

      // 渲染答题卡
      const answerCardHtml = questions.map((q, index) => {
        const questionNum = q.questionNumber || q.id || (index + 1);
        const score = q.score || q.paperScore || 0;

        // 处理正确答案
        let correctAnswer = '';
        if (q.correctAnswer) {
          correctAnswer = q.correctAnswer;
        } else if (q.answer) {
          correctAnswer = q.answer;
        } else if (q.question && q.question.correctAnswers && q.question.correctAnswers.length > 0) {
          correctAnswer = q.question.correctAnswers[0];
        }

        console.log(`题目 ${questionNum}: 分数=${score}, 答案=${correctAnswer}, 原始数据=`, q);

        return `
          <div>
            <div class="flex items-start space-x-1.5 px-2 py-1 hover:bg-gray-50 text-xs">
              <span class="font-semibold text-gray-700 min-w-[20px] pt-0.5">${questionNum}.</span>
              <span class="text-gray-500 pt-0.5">${score}分</span>
              <div class="flex items-center flex-wrap gap-1 flex-1">
                ${['A', 'B', 'C', 'D'].map(option => {
                  const isCorrect = correctAnswer === option || correctAnswer === option.toLowerCase();
                  return `
                    <button class="answer-option px-2 py-0.5 border border-gray-300 rounded text-xs font-medium ${isCorrect ? 'selected' : ''}" title="${isCorrect ? '正确答案' : ''}">
                      ${option}
                    </button>
                  `;
                }).join('')}
              </div>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('documentAnswerCard').innerHTML = answerCardHtml;
    }

    // 显示抽题模式预览
    function showExtractionPreview(data) {
      document.getElementById('extractionPreview').classList.remove('hidden');

      // 显示试卷信息
      document.getElementById('extractionPaperName').textContent = data.name || '未命名试卷';
      document.getElementById('extractionPaperCode').textContent = data.code || data.paperId;
      document.getElementById('extractionTotalScore').textContent = data.totalScore || 0;
      document.getElementById('extractionQuestionCount').textContent = (data.questions || []).length;

      // 按题型分组
      const questions = data.questions || [];
      const groupedQuestions = {};

      questions.forEach(item => {
        const type = item.question?.type || item.type || 'unknown';
        if (!groupedQuestions[type]) {
          groupedQuestions[type] = [];
        }
        groupedQuestions[type].push(item);
      });

      // 渲染题目
      let html = '';
      let questionNumber = 1;

      Object.keys(groupedQuestions).forEach(type => {
        const typeConfig = questionTypeConfig[type] || { name: '未知题型', icon: 'fa-question' };
        const typeQuestions = groupedQuestions[type];

        html += `
          <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">
              <i class="fas ${typeConfig.icon} text-primary-500 mr-2"></i>
              ${typeConfig.name}
            </h3>
            <div class="space-y-6">
        `;

        typeQuestions.forEach(item => {
          const question = item.question || item;
          const score = item.paperScore || question.score || 0;

          html += `
            <div class="question-item">
              <div class="flex items-start mb-3">
                <span class="inline-block w-8 h-8 bg-primary-50 text-primary-600 rounded-full flex items-center justify-center font-semibold text-sm mr-3 flex-shrink-0">
                  ${questionNumber}
                </span>
                <div class="flex-1">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-500">${typeConfig.name}</span>
                    <span class="text-sm font-medium text-primary-600">${score}分</span>
                  </div>
                  <div class="text-gray-900 mb-3">${question.content || '题目内容'}</div>
          `;

          // 显示选项（选择题）
          if (question.options && question.options.length > 0) {
            html += '<div class="space-y-2 ml-11">';
            question.options.forEach(opt => {
              html += `
                <div class="flex items-center p-2 rounded hover:bg-gray-50">
                  <span class="font-medium text-gray-700 mr-2">${opt.label}.</span>
                  <span class="text-gray-600">${opt.text}</span>
                </div>
              `;
            });
            html += '</div>';
          }

          // 显示答案
          if (question.correctAnswers && question.correctAnswers.length > 0) {
            html += `
              <div class="ml-11 mt-3 p-3 bg-green-50 rounded-lg">
                <span class="text-sm font-medium text-green-700">答案：${question.correctAnswers.join('、')}</span>
              </div>
            `;
          }

          // 显示解析
          if (question.explanation) {
            html += `
              <div class="ml-11 mt-2 p-3 bg-blue-50 rounded-lg">
                <span class="text-sm text-blue-700"><strong>解析：</strong>${question.explanation}</span>
              </div>
            `;
          }

          html += `
                </div>
              </div>
            </div>
          `;

          questionNumber++;
        });

        html += `
            </div>
          </div>
        `;
      });

      document.getElementById('extractionQuestionsContainer').innerHTML = html || '<p class="text-gray-500 text-center py-12">暂无题目</p>';
    }
  </script>
</body>
</html>
