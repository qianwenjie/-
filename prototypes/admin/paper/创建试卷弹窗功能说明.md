# 创建试卷弹窗功能说明

## 功能概述

在试卷列表页添加创建试卷弹窗，用户点击"新增试卷"按钮后弹出表单，填写试卷基本信息并选择组卷模式，确认后跳转到对应的组卷页面。

## 完整流程

```
试卷列表页 (list.html)
    ↓ 点击"新增试卷"按钮
弹出创建试卷弹窗
    ├── 试卷名称：[输入框]
    ├── 试卷编号：[自动生成，可修改]
    ├── 试卷总分：[默认100]
    └── 组卷模式：○ 文档模式  ○ 抽题模式
    ↓ 点击"确定"
验证表单数据
    ├── 验证失败 → 显示错误提示
    └── 验证成功 → 继续
    ↓
保存数据到 LocalStorage (currentPaper)
    ↓
根据组卷模式跳转
    ├── 文档模式 → document.html
    └── 抽题模式 → 提示"功能开发中"
    ↓
文档组卷页 (document.html)
    ↓ 加载 LocalStorage 数据
初始化试卷信息
    ├── 试卷名称
    ├── 试卷总分
    └── 生成唯一 ID
    ↓
用户操作
    ├── 上传文件
    ├── 设置答题卡
    └── 添加答案解析
    ↓
保存草稿或发布试卷
    ↓
返回试卷列表页
```

## 功能实现

### 1. 弹窗 HTML 结构

**位置**：`list.html` 的 `</body>` 标签前

**结构**：
```html
<div id="createPaperModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-xl w-[500px]">
    <!-- 标题 -->
    <div class="px-6 py-4 border-b">
      <h3>创建试卷</h3>
    </div>

    <!-- 表单 -->
    <div class="px-6 py-4 space-y-4">
      <!-- 试卷名称 -->
      <input type="text" id="modalPaperName">

      <!-- 试卷编号 -->
      <input type="text" id="modalPaperCode">

      <!-- 试卷总分 -->
      <input type="number" id="modalTotalScore" value="100">

      <!-- 组卷模式 -->
      <input type="radio" name="paperMode" value="document" checked>
      <input type="radio" name="paperMode" value="random">
    </div>

    <!-- 按钮 -->
    <div class="px-6 py-4 border-t">
      <button onclick="closeCreatePaperModal()">取消</button>
      <button onclick="confirmCreatePaper()">确定</button>
    </div>
  </div>
</div>
```

**设计特点**：
- 遮罩层：半透明黑色背景，z-index: 50
- 弹窗宽度：500px，最大高度 90vh
- 表单字段：4个必填字段，带红色星号标记
- 组卷模式：卡片式单选，带说明文字
- 响应式：支持滚动，适配小屏幕

### 2. JavaScript 函数

#### 2.1 生成试卷编号

```javascript
function generatePaperCode() {
  const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
  const papers = JSON.parse(localStorage.getItem('papers') || '[]');
  const todayPapers = papers.filter(p => p.code && p.code.startsWith('EXAM' + today));
  const seq = (todayPapers.length + 1).toString().padStart(3, '0');
  return `EXAM${today}${seq}`;
}
```

**编号格式**：`EXAM + YYYYMMDD + 序号`
- 示例：`EXAM20260122001`
- 优点：易读、有序、可按日期筛选
- 唯一性：同一天的试卷按序号递增

#### 2.2 打开弹窗

```javascript
function openCreatePaperModal() {
  // 生成试卷编号
  document.getElementById('modalPaperCode').value = generatePaperCode();
  // 清空试卷名称
  document.getElementById('modalPaperName').value = '';
  // 重置总分
  document.getElementById('modalTotalScore').value = '100';
  // 默认选中文档模式
  document.querySelector('input[name="paperMode"][value="document"]').checked = true;
  // 显示弹窗
  document.getElementById('createPaperModal').classList.remove('hidden');
}
```

**初始化逻辑**：
1. 自动生成试卷编号
2. 清空试卷名称（避免残留）
3. 重置总分为 100
4. 默认选中文档模式
5. 显示弹窗

#### 2.3 关闭弹窗

```javascript
function closeCreatePaperModal() {
  document.getElementById('createPaperModal').classList.add('hidden');
}

// 点击遮罩层关闭
document.addEventListener('click', function(e) {
  const modal = document.getElementById('createPaperModal');
  if (e.target === modal) {
    closeCreatePaperModal();
  }
});
```

**关闭方式**：
1. 点击"取消"按钮
2. 点击遮罩层（弹窗外部）
3. 按 ESC 键（可选，未实现）

#### 2.4 验证表单

```javascript
function validatePaperForm() {
  const name = document.getElementById('modalPaperName').value.trim();
  const code = document.getElementById('modalPaperCode').value.trim();
  const totalScore = parseInt(document.getElementById('modalTotalScore').value);
  const mode = document.querySelector('input[name="paperMode"]:checked')?.value;

  // 验证试卷名称
  if (!name) {
    showMessage('请输入试卷名称', 'error');
    return false;
  }

  // 验证试卷编号
  if (!code) {
    showMessage('请输入试卷编号', 'error');
    return false;
  }

  // 验证编号唯一性
  const papers = JSON.parse(localStorage.getItem('papers') || '[]');
  if (papers.some(p => p.code === code)) {
    showMessage('试卷编号已存在，请使用其他编号', 'error');
    return false;
  }

  // 验证试卷总分
  if (!totalScore || totalScore <= 0) {
    showMessage('试卷总分必须大于0', 'error');
    return false;
  }

  // 验证组卷模式
  if (!mode) {
    showMessage('请选择组卷模式', 'error');
    return false;
  }

  return true;
}
```

**验证规则**：
1. **试卷名称**：不能为空
2. **试卷编号**：不能为空、必须唯一
3. **试卷总分**：必须 > 0
4. **组卷模式**：必须选择一个

**错误提示**：
- 使用 `showMessage()` 函数显示错误信息
- 错误类型：error（红色）
- 显示位置：页面顶部中央

#### 2.5 确认创建

```javascript
function confirmCreatePaper() {
  // 验证表单
  if (!validatePaperForm()) {
    return;
  }

  const name = document.getElementById('modalPaperName').value.trim();
  const code = document.getElementById('modalPaperCode').value.trim();
  const totalScore = parseInt(document.getElementById('modalTotalScore').value);
  const mode = document.querySelector('input[name="paperMode"]:checked').value;

  // 检查抽题模式
  if (mode === 'random') {
    showMessage('抽题模式功能开发中，敬请期待', 'warning');
    return;
  }

  // 生成唯一ID
  const paperId = 'P' + Date.now() + Math.random().toString(36).substr(2, 9);

  // 创建试卷数据
  const paperData = {
    id: paperId,
    name: name,
    code: code,
    totalScore: totalScore,
    mode: mode,
    status: 'draft',
    createTime: new Date().toISOString()
  };

  // 保存到 LocalStorage
  localStorage.setItem('currentPaper', JSON.stringify(paperData));

  // 关闭弹窗
  closeCreatePaperModal();

  // 跳转到对应页面
  if (mode === 'document') {
    window.location.href = 'document.html';
  }
}
```

**执行流程**：
1. 验证表单数据
2. 检查抽题模式（暂未实现）
3. 生成唯一 ID
4. 创建试卷数据对象
5. 保存到 LocalStorage
6. 关闭弹窗
7. 跳转到组卷页面

### 3. 数据结构

#### 3.1 临时数据（currentPaper）

```javascript
{
  id: 'P1737532800000abc123',
  name: '期末考试',
  code: 'EXAM20260122001',
  totalScore: 100,
  mode: 'document',
  status: 'draft',
  createTime: '2026-01-22T10:00:00.000Z'
}
```

**存储位置**：`localStorage.currentPaper`
**用途**：传递给 document.html 初始化数据
**生命周期**：document.html 加载后可清理

#### 3.2 试卷列表数据（papers）

```javascript
[
  {
    id: 'P1737532800000abc123',
    name: '期末考试',
    code: 'EXAM20260122001',
    totalScore: 100,
    mode: 'document',
    status: 'draft',  // draft | published
    createTime: '2026-01-22T10:00:00.000Z',
    updateTime: '2026-01-22T10:30:00.000Z',
    publishTime: null,
    file: { /* 文件信息 */ },
    answerCard: { /* 答题卡数据 */ }
  }
]
```

**存储位置**：`localStorage.papers`
**用途**：存储所有试卷数据
**更新时机**：
- document.html 保存草稿时
- document.html 发布试卷时

### 4. 与 document.html 的数据传递

#### 4.1 list.html → document.html

```javascript
// list.html: 保存数据
localStorage.setItem('currentPaper', JSON.stringify(paperData));
window.location.href = 'document.html';
```

#### 4.2 document.html 读取数据

```javascript
// document.html: 读取数据
window.onload = function() {
  const currentPaper = localStorage.getItem('currentPaper');
  if (currentPaper) {
    const data = JSON.parse(currentPaper);
    paperData = {
      ...paperData,
      id: data.id,
      title: data.name,
      totalScore: data.totalScore,
      createTime: data.createTime
    };
    // 初始化页面
    document.getElementById('paperTitle').value = paperData.title;
    document.getElementById('totalScore').value = paperData.totalScore;
  }
};
```

#### 4.3 document.html → list.html

```javascript
// document.html: 保存到 papers
function saveDraft() {
  const papers = JSON.parse(localStorage.getItem('papers') || '[]');
  const index = papers.findIndex(p => p.id === paperData.id);

  if (index > -1) {
    papers[index] = paperData;
  } else {
    papers.push(paperData);
  }

  localStorage.setItem('papers', JSON.stringify(papers));
}

// 发布后跳转
function publishPaper() {
  paperData.status = 'published';
  saveDraft();
  window.location.href = 'list.html';
}
```

## 技术实现

### KISS 原则
1. **简单的弹窗实现**：使用 Tailwind CSS，无需第三方库
2. **简单的数据传递**：使用 LocalStorage，无需 URL 参数
3. **简单的验证逻辑**：直接验证，无需复杂的表单库

### DRY 原则
1. **统一的消息提示**：复用 `showMessage()` 函数
2. **统一的数据结构**：list.html 和 document.html 使用相同的数据格式
3. **统一的 ID 生成**：使用相同的 ID 生成算法

### YAGNI 原则
1. **不实现抽题模式**：仅提示"功能开发中"
2. **不实现复杂的表单验证**：仅验证必填项和唯一性
3. **不实现表单自动保存**：用户主动点击确定才保存

### SOLID 原则
1. **单一职责**：
   - `openCreatePaperModal()` 只负责打开弹窗
   - `validatePaperForm()` 只负责验证表单
   - `confirmCreatePaper()` 只负责创建试卷

2. **开闭原则**：
   - 新增组卷模式无需修改现有代码
   - 只需在弹窗中添加新的单选项

## 使用说明

### 创建试卷
1. 在试卷列表页点击"新增试卷"按钮
2. 弹出创建试卷弹窗
3. 填写试卷信息：
   - 试卷名称：手动输入（必填）
   - 试卷编号：自动生成，可修改（必填）
   - 试卷总分：默认100，可修改（必填）
   - 组卷模式：选择文档模式或抽题模式（必填）
4. 点击"确定"按钮
5. 系统验证表单数据
6. 验证通过后跳转到组卷页面

### 取消创建
1. 点击"取消"按钮
2. 或点击弹窗外部（遮罩层）
3. 弹窗关闭，不保存任何数据

### 编号规则
- 格式：`EXAM + YYYYMMDD + 序号`
- 示例：`EXAM20260122001`（2026年1月22日第1个试卷）
- 自动递增：同一天创建的试卷序号自动递增
- 可修改：用户可以手动修改编号

### 验证规则
- **试卷名称**：不能为空
- **试卷编号**：不能为空、不能重复
- **试卷总分**：必须大于0
- **组卷模式**：必须选择一个

### 错误提示
- 验证失败时，页面顶部显示红色错误提示
- 提示内容：具体的错误原因
- 自动消失：3秒后自动消失

## 测试建议

### 功能测试
1. ✅ 点击"新增试卷"按钮，弹窗正常显示
2. ✅ 试卷编号自动生成，格式正确
3. ✅ 填写完整信息，点击"确定"，跳转到 document.html
4. ✅ document.html 正确加载试卷信息
5. ✅ 点击"取消"按钮，弹窗关闭
6. ✅ 点击遮罩层，弹窗关闭

### 验证测试
1. ⚠️ 不填写试卷名称，点击"确定"，显示错误提示
2. ⚠️ 不填写试卷编号，点击"确定"，显示错误提示
3. ⚠️ 填写重复的试卷编号，点击"确定"，显示错误提示
4. ⚠️ 填写负数总分，点击"确定"，显示错误提示
5. ⚠️ 选择抽题模式，点击"确定"，显示"功能开发中"提示

### 边界测试
1. ⏳ 试卷名称超长（100+字符）
2. ⏳ 试卷编号包含特殊字符
3. ⏳ 试卷总分为小数
4. ⏳ 试卷总分超大（10000+）
5. ⏳ 快速连续点击"确定"按钮

### 兼容性测试
1. ⏳ Chrome 浏览器
2. ⏳ Firefox 浏览器
3. ⏳ Safari 浏览器
4. ⏳ Edge 浏览器
5. ⏳ 移动端浏览器

## 文件修改记录

**修改文件**：`/Users/echo/Desktop/考试系统设计/prototypes/admin/paper/list.html`

**修改内容**：
1. 修改"新增试卷"按钮（行 77）：
   - 从：`onclick="window.location.href='add.html'"`
   - 到：`onclick="openCreatePaperModal()"`

2. 添加弹窗 HTML（行 525-603）：
   - 遮罩层和弹窗容器
   - 表单字段（4个）
   - 确定和取消按钮

3. 添加 JavaScript 函数（行 398-522）：
   - `generatePaperCode()` - 生成试卷编号
   - `openCreatePaperModal()` - 打开弹窗
   - `closeCreatePaperModal()` - 关闭弹窗
   - `validatePaperForm()` - 验证表单
   - `confirmCreatePaper()` - 确认创建
   - 遮罩层点击事件监听

**代码统计**：
- 新增 HTML：约 80 行
- 新增 JavaScript：约 125 行
- 总计：约 205 行

## 已知问题

1. **抽题模式未实现**：选择抽题模式会提示"功能开发中"
2. **编号唯一性验证**：仅在当前浏览器的 LocalStorage 中验证
3. **表单未自动保存**：关闭弹窗后数据丢失
4. **无 ESC 键关闭**：未实现按 ESC 键关闭弹窗
5. **无加载动画**：跳转时无加载提示

## 后续优化方向

### P1（重要功能）
1. ⏳ 实现抽题模式组卷功能
2. ⏳ 添加 ESC 键关闭弹窗
3. ⏳ 添加跳转加载动画
4. ⏳ 优化表单验证（实时验证）

### P2（增强功能）
5. ⏳ 表单自动保存（草稿）
6. ⏳ 支持更多字段（考试时长、及格分数等）
7. ⏳ 支持模板选择（快速创建）
8. ⏳ 支持批量创建试卷
9. ⏳ 支持从现有试卷复制创建
10. ⏳ 支持试卷预设（常用配置）

## 总结

创建试卷弹窗功能已完成，实现了完整的试卷创建流程：

**核心功能**：
- ✅ 弹窗显示和关闭
- ✅ 表单字段输入和验证
- ✅ 试卷编号自动生成
- ✅ 数据保存到 LocalStorage
- ✅ 跳转到文档组卷页面

**技术特点**：
- 简洁的 HTML 结构
- 清晰的 JavaScript 逻辑
- 完善的表单验证
- 友好的错误提示
- 流畅的用户体验

**完整流程**：
```
试卷列表页 → 创建弹窗 → 填写表单 → 验证数据 → 保存数据 → 跳转组卷页 → 完成创建
```

至此，文档组卷功能的完整流程已全部实现！🎉
