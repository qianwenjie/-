# 文档组卷功能说明

## 功能概述

文档组卷功能允许教师上传 PDF/Word 格式的试卷文档，并为试卷设置答题卡（题号、分值、正确答案、答案解析），支持草稿保存和发布。

## 核心功能

### 1. ✅ 压缩答题卡设置区域

**优化内容**：
- 右侧宽度：从 384px (w-96) 压缩到 320px (w-80)
- 题型按钮：3列网格布局，图标和文字垂直排列
- 题目卡片：紧凑单行布局，减小内边距和字体
- 题型卡片：减小间距和内边距
- 底部统计：简化显示，分两行展示

**效果对比**：
```
优化前：每道题占用约 60px 高度，一屏显示 6-7 道题
优化后：每道题占用约 35px 高度，一屏显示 10-12 道题
```

**布局示例**：
```
┌─────────────────────────────────┐
│ 单选题                    每题 2 分 │
├─────────────────────────────────┤
│ 1. [2]分 [A][B][C][D] [💬][×]   │
│ 2. [2]分 [A][B][C][D] [💬][×]   │
│ 3. [2]分 [A][B][C][D] [💬][×]   │
└─────────────────────────────────┘
```

### 2. ✅ 去除上传文件检查

**修改内容**：
- 允许先设置答题卡，后上传文件
- 允许先上传文件，后设置答题卡
- 允许同时进行

**验证逻辑调整**：
```javascript
// 修改前：添加题型时检查
function addQuestionType(type) {
  if (!uploadedFile) {
    alert('请先上传试卷文件');
    return;
  }
  // ...
}

// 修改后：发布时检查
function publishPaper() {
  if (!uploadedFile) {
    alert('请先上传试卷文件');
    return;
  }
  if (Object.keys(paperData.answerCard).length === 0) {
    alert('请先设置答题卡');
    return;
  }
  // ...
}
```

**用户场景**：
1. **场景A**：先上传文件，再设置答题卡 ✅
2. **场景B**：先设置答题卡，再上传文件 ✅
3. **场景C**：同时进行 ✅

### 3. ✅ 答案解析功能

**数据结构**：
```javascript
{
  id: 1,
  score: 2,
  answer: 'A',
  explanation: '这是答案解析...',  // 新增
  showExplanation: false           // 新增：控制展开/折叠
}
```

**UI 设计**：
- 每道题右侧有解析按钮（💬图标）
- 点击按钮展开/折叠解析输入框
- 有解析内容时，按钮显示蓝色
- 解析输入框支持多行文本

**交互流程**：
```
1. 点击解析按钮 → 展开输入框
2. 输入解析内容 → 自动保存
3. 再次点击按钮 → 折叠输入框
```

**视觉效果**：
```
┌─────────────────────────────────┐
│ 1. [2]分 [✓A][B][C][D] [💬][×]  │  ← 点击💬展开
├─────────────────────────────────┤
│ [输入答案解析...]                │  ← 解析输入框
└─────────────────────────────────┘
```

### 4. ✅ PDF 文件预览

**实现方式**：
- 使用 iframe 嵌入 PDF 文件
- 通过 `URL.createObjectURL()` 创建 Blob URL
- 支持浏览器原生 PDF 查看器功能

**支持情况**：
- ✅ PDF 文件：完整预览支持
- ⏳ Word 文件：显示提示信息，暂不支持预览

**代码实现**：
```javascript
function handleFileUpload(event) {
  const file = event.target.files[0];
  const isPDF = file.type === 'application/pdf';

  if (isPDF) {
    const fileURL = URL.createObjectURL(file);
    document.getElementById('pdfFrame').src = fileURL;
    document.getElementById('pdfPreview').classList.remove('hidden');
  } else {
    document.getElementById('wordNotice').classList.remove('hidden');
  }
}
```

**清理机制**：
```javascript
function removeFile() {
  const pdfFrame = document.getElementById('pdfFrame');
  if (pdfFrame.src) {
    URL.revokeObjectURL(pdfFrame.src);  // 释放内存
    pdfFrame.src = '';
  }
}
```

### 5. ✅ 草稿保存和发布功能

**数据结构**：
```javascript
{
  id: 'P1737532800000abc123',
  title: '期末考试',
  totalScore: 100,
  file: { name: 'exam.pdf', size: 1024000, type: 'application/pdf' },
  answerCard: { /* 答题卡数据 */ },
  status: 'draft',  // draft | published
  createTime: '2026-01-22T10:00:00.000Z',
  updateTime: '2026-01-22T10:30:00.000Z',
  publishTime: null
}
```

**保存机制**：
1. **手动保存**：点击"保存答题卡"按钮
2. **自动保存**：每30秒自动保存草稿
3. **关闭保存**：页面关闭前自动保存

**发布流程**：
```
1. 验证文件已上传
2. 验证答题卡已设置
3. 用户确认发布
4. 更新状态为 published
5. 记录发布时间
6. 保存到 LocalStorage
7. 跳转到试卷列表
```

**状态管理**：
- **草稿 (draft)**：可编辑、可删除、自动保存
- **已发布 (published)**：只读、不可编辑、不可删除

**数据持久化**：
```javascript
// 保存到 LocalStorage
localStorage.setItem('papers', JSON.stringify(papers));

// 加载数据
const papers = JSON.parse(localStorage.getItem('papers') || '[]');
```

## 页面流程

### 新建试卷流程
```
试卷列表页 (list.html)
    ↓ 点击"创建试卷"
弹窗（填写基本信息）
    ├── 试卷名称
    ├── 试卷编号
    ├── 试卷总分
    └── 组卷模式：文档模式
    ↓ 点击"确定"
保存基本信息到 LocalStorage (currentPaper)
    ↓
跳转到文档组卷页 (document.html)
    ↓
加载基本信息
    ├── 生成唯一 ID
    ├── 设置创建时间
    └── 初始化数据结构
    ↓
用户操作
    ├── 上传文件（可选）
    ├── 设置答题卡（可选）
    └── 设置答案解析（可选）
    ↓
自动保存草稿（每30秒）
    ↓
点击"发布试卷"
    ├── 验证文件和答题卡
    ├── 更新状态为 published
    └── 保存到 LocalStorage (papers)
    ↓
跳转到试卷列表页
    └── 显示已发布试卷
```

### 编辑草稿流程
```
试卷列表页 (list.html)
    ↓ 点击草稿试卷
跳转到文档组卷页 (document.html?id=xxx)
    ↓
加载试卷数据
    ├── 从 LocalStorage 读取
    ├── 恢复试卷信息
    ├── 恢复答题卡数据
    └── 显示文件信息（无法预览）
    ↓
用户编辑
    ├── 修改答题卡
    ├── 修改答案解析
    └── 重新上传文件（可选）
    ↓
自动保存草稿
    ↓
点击"发布试卷"
    └── 同新建流程
```

## 数据传递方案

### 方案1：URL 参数传递（当前实现）
```javascript
// 新建模式
window.location.href = 'document.html';

// 编辑模式
window.location.href = 'document.html?id=P1737532800000abc123';

// 接收参数
const urlParams = new URLSearchParams(window.location.search);
const paperId = urlParams.get('id');
```

### 方案2：LocalStorage 临时存储
```javascript
// 保存基本信息
localStorage.setItem('currentPaper', JSON.stringify({
  id: 'P1737532800000abc123',
  name: '期末考试',
  totalScore: 100,
  createTime: '2026-01-22T10:00:00.000Z'
}));

// 读取基本信息
const currentPaper = localStorage.getItem('currentPaper');
if (currentPaper) {
  const data = JSON.parse(currentPaper);
  // 使用数据初始化页面
}
```

## 技术实现

### KISS 原则体现
1. **简化答案显示**：去除冗余的"答案：X"文字
2. **简化文件预览**：使用 iframe 而非复杂的 PDF.js
3. **简化数据存储**：使用 LocalStorage 而非复杂的后端

### DRY 原则体现
1. **统一题型渲染**：选项类题型（单选/多选/判断）共用渲染逻辑
2. **统一保存逻辑**：手动保存、自动保存、关闭保存共用 `saveDraft()` 函数
3. **统一验证逻辑**：发布和预览共用文件和答题卡验证

### YAGNI 原则体现
1. **不实现 Word 预览**：原型阶段不需要，仅提示
2. **不实现权限控制**：原型阶段不需要
3. **不实现复杂的版本管理**：仅区分草稿和已发布

### SOLID 原则体现
1. **单一职责**：
   - `handleFileUpload()` 只负责文件上传
   - `saveDraft()` 只负责保存草稿
   - `publishPaper()` 只负责发布试卷

2. **开闭原则**：
   - 题型配置通过 `questionTypeConfig` 对象扩展
   - 新增题型无需修改渲染逻辑

## 使用说明

### 创建试卷
1. 在试卷列表页点击"创建试卷"
2. 填写试卷名称、编号、总分
3. 选择"文档模式"
4. 点击"确定"进入文档组卷页

### 上传文件
1. 点击"上传word或pdf文件"按钮
2. 选择 PDF 或 Word 文件（≤10MB）
3. PDF 文件自动预览，Word 文件显示提示

### 设置答题卡
1. 点击题型按钮（单选/多选/判断/填空/简答/复合）
2. 系统自动创建4道题（默认每题2分）
3. 设置每题分值（支持小数）
4. 选择正确答案（点击选项按钮）
5. 添加答案解析（点击💬按钮）

### 保存和发布
- **保存草稿**：点击"保存答题卡"按钮或等待自动保存
- **预览试卷**：点击"预览试卷"按钮（开发中）
- **发布试卷**：点击"发布试卷"按钮，确认后发布

### 编辑草稿
1. 在试卷列表页找到草稿试卷
2. 点击试卷进入编辑页面
3. 修改答题卡或重新上传文件
4. 保存或发布

## 注意事项

### 文件预览限制
- ✅ PDF 文件：完整预览支持
- ⏳ Word 文件：仅显示文件信息，不支持预览
- ⚠️ 文件大小限制：10MB

### 数据持久化限制
- 使用 LocalStorage 存储（5-10MB 限制）
- 文件内容不存储，仅存储文件信息
- 跨浏览器/设备数据不同步
- 清除浏览器数据会丢失所有数据

### 草稿自动保存
- 每30秒自动保存一次
- 页面关闭前自动保存
- 仅保存草稿状态的试卷
- 已发布试卷不再自动保存

### 发布后限制
- 发布后状态变为 published
- 已发布试卷不可编辑
- 已发布试卷不可删除
- 需要重新创建新试卷

## 后续优化方向

### P1（重要功能）
1. ✅ 在试卷列表页添加创建试卷弹窗
2. ⏳ 实现试卷预览功能
3. ⏳ 支持 Word 文件预览（后端转换）
4. ⏳ 优化文件上传体验（进度条、拖拽上传）

### P2（增强功能）
5. ⏳ 支持批量设置答案
6. ⏳ 支持从 Excel 导入答案
7. ⏳ 支持答案随机化
8. ⏳ 支持题目预览（显示题目内容）
9. ⏳ 支持复合题的子题目设置
10. ⏳ 支持题型折叠/展开

## 文件修改记录

**修改文件**：`/Users/echo/Desktop/考试系统设计/prototypes/admin/paper/document.html`

**修改内容**：
1. 压缩答题卡设置区域（行 151-215）
2. 去除上传文件检查（行 309-321）
3. 添加答案解析功能（行 285-288, 371-402, 469-479）
4. 实现 PDF 文件预览（行 116-155, 238-307）
5. 实现草稿保存和发布（行 219-321, 641-692）

**新增功能**：
- 页面加载时初始化数据
- 自动保存草稿（每30秒）
- 页面关闭前保存草稿
- 发布试卷并跳转

**代码统计**：
- 总行数：约 696 行
- HTML：约 215 行
- JavaScript：约 475 行
- CSS：约 6 行（内联样式）

## 测试建议

### 功能测试
1. ✅ 上传 PDF 文件并预览
2. ✅ 上传 Word 文件并显示提示
3. ✅ 先设置答题卡，后上传文件
4. ✅ 先上传文件，后设置答题卡
5. ✅ 添加/删除题型
6. ✅ 添加/删除题目
7. ✅ 设置答案和分值
8. ✅ 添加答案解析
9. ✅ 保存草稿
10. ✅ 发布试卷

### 边界测试
1. ⚠️ 上传超过 10MB 的文件
2. ⚠️ 上传不支持的文件格式
3. ⚠️ 不上传文件直接发布
4. ⚠️ 不设置答题卡直接发布
5. ⚠️ 设置负数分值
6. ⚠️ 设置超过试卷总分的分值

### 性能测试
1. ⏳ 上传大文件（接近 10MB）
2. ⏳ 添加大量题目（100+）
3. ⏳ 长时间编辑（测试自动保存）
4. ⏳ 频繁切换题型

## 已知问题

1. **文件预览性能**：大 PDF 文件可能加载缓慢
2. **Word 文件不支持预览**：需要后端转换
3. **LocalStorage 限制**：大量试卷可能超出存储限制
4. **文件内容不持久化**：刷新页面后无法预览已上传的文件
5. **跨浏览器数据不同步**：不同浏览器看到的数据不同

## 总结

文档组卷功能已完成核心功能开发，包括：
- ✅ 压缩答题卡设置区域（提升空间利用率）
- ✅ 去除上传文件检查（提升操作灵活性）
- ✅ 添加答案解析功能（提升试卷质量）
- ✅ 实现 PDF 文件预览（提升用户体验）
- ✅ 实现草稿保存和发布（保障数据安全）

下一步需要在试卷列表页添加创建试卷弹窗，完成整个页面流程的闭环。
