<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>创建刷题 - 考试系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#E6F9F0', 100: '#B2E9D0', 500: '#00B96B', 600: '#00A35C', 700: '#008C4F' },
            success: { 50: '#E8FFEA', 100: '#AFF0B5', 200: '#7BE188', 500: '#00B42A', 600: '#009A29' },
            warning: { 50: '#FFF7E8', 100: '#FFE4BA', 200: '#FFCF8B', 500: '#FF7D00', 600: '#E86F00' },
            error: { 50: '#FFECE8', 100: '#FDCDC5', 200: '#FBACA3', 500: '#F53F3F', 600: '#CB2634' },
            info: { 50: '#E8F7FF', 100: '#C2E7FF', 200: '#94D4FF', 500: '#14C9C9', 600: '#0FC6C2' },
            gray: { 50: '#F7F8FA', 100: '#F2F3F5', 200: '#E5E6EB', 300: '#C9CDD4', 400: '#A9AEB8', 500: '#86909C', 600: '#6B7785', 700: '#4E5969', 800: '#272E3B', 900: '#1D2129' }
          }
        }
      }
    }
  </script>
  <style>
    .date-input input[type="datetime-local"] {
      border: 1px solid #E5E6EB;
      border-radius: 0.5rem;
      padding: 0.625rem 0.75rem;
      font-size: 0.875rem;
    }

    .date-input input[type="datetime-local"]:focus {
      outline: none;
      border-color: #00B96B;
      box-shadow: 0 0 0 3px rgba(0, 185, 107, 0.1);
    }

    /* 知识点树样式 */
    .knowledge-tree {
      max-height: 400px;
      overflow-y: auto;
    }

    .knowledge-item {
      cursor: pointer;
      transition: background-color 0.15s;
    }

    .knowledge-item:hover {
      background-color: #F7F8FA;
    }

    .knowledge-item.selected {
      background-color: #E6F9F0;
    }

    /* 拖拽样式 */
    .sortable-ghost {
      opacity: 0.4;
      background: #E6F9F0;
    }

    .sortable-drag {
      opacity: 1;
    }

    .drag-handle {
      cursor: move;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="h-16 bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
      <div class="flex items-center justify-between h-full px-6">
        <div class="flex items-center space-x-6">
          <a href="../dashboard.html" class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-primary-500 rounded-lg flex items-center justify-center">
              <i class="fas fa-book text-white text-lg"></i>
            </div>
            <span class="text-xl font-semibold text-gray-900">考试系统</span>
          </a>
          <div class="flex items-center space-x-2 text-sm">
            <a href="../dashboard.html" class="text-gray-600 hover:text-primary-500">首页</a>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
            <a href="list.html" class="text-gray-600 hover:text-primary-500">刷题管理</a>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
            <span class="text-gray-900" id="pageTitle">创建刷题</span>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=admin" alt="用户头像" class="w-8 h-8 rounded-full">
          <span class="text-sm text-gray-700">管理员</span>
        </div>
      </div>
    </header>

    <main class="pt-16">
      <div class="p-6 max-w-[1200px] mx-auto">
        <!-- 进度指示器 -->
        <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center space-x-2">
              <div class="w-8 h-8 rounded-full bg-primary-500 text-white flex items-center justify-center text-sm font-medium">1</div>
              <span class="text-sm font-medium text-gray-900">基础信息</span>
            </div>
            <div class="flex-1 h-0.5 bg-gray-200 mx-4"></div>
            <div class="flex items-center space-x-2">
              <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-medium">2</div>
              <span class="text-sm text-gray-500">题目配置</span>
            </div>
            <div class="flex-1 h-0.5 bg-gray-200 mx-4"></div>
            <div class="flex items-center space-x-2">
              <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-medium">3</div>
              <span class="text-sm text-gray-500">其他设置</span>
            </div>
          </div>
        </div>

        <form id="practiceForm">
          <!-- 第一步：基础信息 -->
          <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
              <i class="fas fa-info-circle text-primary-500 mr-2"></i>
              基础信息
            </h2>

            <div class="space-y-6">
              <!-- 刷题名称 -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  刷题名称 <span class="text-error-500">*</span>
                </label>
                <input type="text" id="practiceName" maxlength="50" placeholder="请输入刷题名称（限50字）" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" required>
                <div class="flex items-center justify-between mt-1">
                  <span class="text-xs text-gray-500">例如：计算机基础专项练习</span>
                  <span class="text-xs text-gray-400"><span id="nameLength">0</span>/50</span>
                </div>
              </div>

              <!-- 刷题编号 -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">刷题编号</label>
                <input type="text" id="practiceCode" readonly class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm bg-gray-50 text-gray-600" placeholder="保存后自动生成">
                <p class="text-xs text-gray-500 mt-1">编号将在保存后自动生成</p>
              </div>

              <!-- 开放时间 -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="date-input">
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    开始时间 <span class="text-error-500">*</span>
                  </label>
                  <input type="datetime-local" id="startTime" class="w-full" required>
                </div>
                <div class="date-input">
                  <label class="block text-sm font-medium text-gray-700 mb-2">结束时间</label>
                  <input type="datetime-local" id="endTime" class="w-full">
                  <p class="text-xs text-gray-500 mt-1">不设置则不限时</p>
                </div>
              </div>
            </div>
          </div>

          <!-- 第二步：题目配置 -->
          <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
              <i class="fas fa-list-check text-primary-500 mr-2"></i>
              题目配置
            </h2>

            <div class="space-y-6">
              <!-- 知识点选择 -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  知识点范围 <span class="text-error-500">*</span>
                </label>
                <div class="border border-gray-300 rounded-lg p-4 knowledge-tree" id="knowledgeTree">
                  <!-- 知识点树由 JavaScript 生成 -->
                </div>
                <div id="selectedKnowledgeDisplay" class="mt-2 flex flex-wrap gap-2">
                  <!-- 已选知识点标签 -->
                </div>
              </div>

              <!-- 题型抽取 -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">
                  题型抽取 <span class="text-error-500">*</span>
                </label>
                <div class="bg-info-50 border border-info-200 rounded-lg p-3 mb-3">
                  <div class="flex items-start">
                    <i class="fas fa-info-circle text-info-500 mt-0.5 mr-2"></i>
                    <p class="text-sm text-info-700">根据所选知识点范围内实际存在的题型自动判断可选题型，可拖拽调整题型顺序</p>
                  </div>
                </div>
                <div id="questionTypesList" class="space-y-3">
                  <!-- 题型列表由 JavaScript 生成 -->
                </div>
              </div>

              <!-- 难度范围 -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">难度范围</label>
                <div class="flex items-center space-x-4">
                  <label class="flex items-center">
                    <input type="checkbox" value="1" class="difficulty-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" checked>
                    <span class="ml-2 text-sm text-gray-700">一级</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" value="2" class="difficulty-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" checked>
                    <span class="ml-2 text-sm text-gray-700">二级</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" value="3" class="difficulty-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" checked>
                    <span class="ml-2 text-sm text-gray-700">三级</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" value="4" class="difficulty-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" checked>
                    <span class="ml-2 text-sm text-gray-700">四级</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" value="5" class="difficulty-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" checked>
                    <span class="ml-2 text-sm text-gray-700">五级</span>
                  </label>
                </div>
              </div>

              <!-- 题目数量 -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">题目数量</label>
                <div class="flex items-center space-x-4">
                  <label class="flex items-center">
                    <input type="radio" name="questionCountType" value="limited" class="text-primary-500 focus:ring-primary-500" checked>
                    <span class="ml-2 text-sm text-gray-700">限制数量</span>
                  </label>
                  <input type="number" id="questionCount" min="1" value="20" class="w-32 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                  <span class="text-sm text-gray-600">题</span>
                  <label class="flex items-center ml-8">
                    <input type="radio" name="questionCountType" value="unlimited" class="text-primary-500 focus:ring-primary-500">
                    <span class="ml-2 text-sm text-gray-700">不限数量</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- 第三步：其他设置 -->
          <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
              <i class="fas fa-cog text-primary-500 mr-2"></i>
              其他设置
            </h2>

            <div class="space-y-6">
              <!-- 通过标准 -->
              <div>
                <label class="flex items-center mb-3">
                  <input type="checkbox" id="enablePassStandard" class="rounded border-gray-300 text-primary-500 focus:ring-primary-500">
                  <span class="ml-2 text-sm font-medium text-gray-700">启用通过标准</span>
                </label>
                <div id="passStandardConfig" class="ml-6 hidden">
                  <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">掌握比例达到</span>
                    <input type="number" id="passThreshold" min="1" max="100" value="60" class="w-24 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                    <span class="text-sm text-gray-600">% 视为通过</span>
                  </div>
                  <p class="text-xs text-gray-500 mt-2">学生答对题目的百分比达到此标准才算通过</p>
                </div>
              </div>

              <!-- 答案显示 -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">
                  答案显示时机 <span class="text-error-500">*</span>
                </label>
                <div class="space-y-2">
                  <label class="flex items-center">
                    <input type="radio" name="answerDisplay" value="immediate" class="text-primary-500 focus:ring-primary-500" checked>
                    <span class="ml-2 text-sm text-gray-700">答题后立即显示</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="answerDisplay" value="after_all" class="text-primary-500 focus:ring-primary-500">
                    <span class="ml-2 text-sm text-gray-700">全部完成后显示</span>
                  </label>
                </div>
              </div>

              <!-- 解析显示 -->
              <div>
                <label class="flex items-center">
                  <input type="checkbox" id="showExplanation" class="rounded border-gray-300 text-primary-500 focus:ring-primary-500" checked>
                  <span class="ml-2 text-sm font-medium text-gray-700">显示题目解析</span>
                </label>
              </div>
            </div>
          </div>

          <!-- 操作按钮 -->
          <div class="flex items-center justify-between">
            <button type="button" onclick="goBack()" class="px-6 py-2.5 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
              <i class="fas fa-arrow-left mr-2"></i>返回列表
            </button>
            <div class="flex items-center space-x-3">
              <button type="button" onclick="saveDraft()" class="px-6 py-2.5 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
                <i class="fas fa-save mr-2"></i>保存草稿
              </button>
              <button type="button" onclick="publishPractice()" class="px-6 py-2.5 bg-primary-500 text-white rounded-lg text-sm font-medium hover:bg-primary-600">
                <i class="fas fa-paper-plane mr-2"></i>发布
              </button>
            </div>
          </div>
        </form>
      </div>
    </main>
  </div>

  <script>
    // 全局变量
    let knowledgeData = [];
    let selectedKnowledgeIds = new Set();
    let questionTypesConfig = [];
    let sortableInstance = null;

    // 初始化
    function init() {
      loadKnowledgeData();
      renderKnowledgeTree();
      setupEventListeners();
      updateQuestionTypes();

      // 检查是否是编辑模式
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id');
      if (id) {
        document.getElementById('pageTitle').textContent = '编辑刷题';
        loadPracticeData(id);
      }
    }

    // 加载知识点数据（模拟）
    function loadKnowledgeData() {
      knowledgeData = [
        {
          id: 'kp001',
          name: '计算机基础',
          children: [
            { id: 'kp001_01', name: '计算机组成原理', questionCount: 45 },
            { id: 'kp001_02', name: '操作系统', questionCount: 38 },
            { id: 'kp001_03', name: '计算机网络', questionCount: 52 }
          ]
        },
        {
          id: 'kp002',
          name: '编程语言',
          children: [
            { id: 'kp002_01', name: 'C语言', questionCount: 67 },
            { id: 'kp002_02', name: 'Java', questionCount: 89 },
            { id: 'kp002_03', name: 'Python', questionCount: 76 }
          ]
        },
        {
          id: 'kp003',
          name: '数据结构与算法',
          children: [
            { id: 'kp003_01', name: '线性表', questionCount: 34 },
            { id: 'kp003_02', name: '树与二叉树', questionCount: 41 },
            { id: 'kp003_03', name: '图', questionCount: 28 },
            { id: 'kp003_04', name: '排序算法', questionCount: 36 }
          ]
        },
        {
          id: 'kp004',
          name: '数据库',
          children: [
            { id: 'kp004_01', name: 'SQL语言', questionCount: 55 },
            { id: 'kp004_02', name: '数据库设计', questionCount: 32 },
            { id: 'kp004_03', name: '事务与并发', questionCount: 27 }
          ]
        }
      ];
    }

    // 渲染知识点树
    function renderKnowledgeTree() {
      const treeContainer = document.getElementById('knowledgeTree');
      treeContainer.innerHTML = knowledgeData.map(category => `
        <div class="mb-2">
          <div class="knowledge-item px-3 py-2 rounded flex items-center justify-between" data-id="${category.id}" onclick="toggleKnowledge('${category.id}', true)">
            <div class="flex items-center">
              <i class="fas fa-folder text-warning-500 mr-2"></i>
              <span class="text-sm font-medium text-gray-900">${category.name}</span>
            </div>
            <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
          </div>
          <div class="ml-6 mt-1">
            ${category.children.map(child => `
              <div class="knowledge-item px-3 py-2 rounded flex items-center justify-between" data-id="${child.id}" onclick="toggleKnowledge('${child.id}', false)">
                <div class="flex items-center">
                  <i class="fas fa-file-alt text-info-500 mr-2 text-xs"></i>
                  <span class="text-sm text-gray-700">${child.name}</span>
                </div>
                <span class="text-xs text-gray-400">${child.questionCount} 题</span>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    // 切换知识点选择
    function toggleKnowledge(id, isCategory) {
      const element = document.querySelector(`[data-id="${id}"]`);

      if (isCategory) {
        // 选择分类：选择该分类下所有子节点
        const category = knowledgeData.find(c => c.id === id);
        if (!category) return;

        const allSelected = category.children.every(child => selectedKnowledgeIds.has(child.id));

        if (allSelected) {
          // 全部取消
          category.children.forEach(child => {
            selectedKnowledgeIds.delete(child.id);
            document.querySelector(`[data-id="${child.id}"]`).classList.remove('selected');
          });
        } else {
          // 全部选中
          category.children.forEach(child => {
            selectedKnowledgeIds.add(child.id);
            document.querySelector(`[data-id="${child.id}"]`).classList.add('selected');
          });
        }
      } else {
        // 选择单个知识点
        if (selectedKnowledgeIds.has(id)) {
          selectedKnowledgeIds.delete(id);
          element.classList.remove('selected');
        } else {
          selectedKnowledgeIds.add(id);
          element.classList.add('selected');
        }
      }

      updateSelectedKnowledgeDisplay();
      updateQuestionTypes();
    }

    // 更新已选知识点显示
    function updateSelectedKnowledgeDisplay() {
      const container = document.getElementById('selectedKnowledgeDisplay');

      if (selectedKnowledgeIds.size === 0) {
        container.innerHTML = '<span class="text-sm text-gray-400">请选择知识点范围</span>';
        return;
      }

      const selected = [];
      knowledgeData.forEach(category => {
        category.children.forEach(child => {
          if (selectedKnowledgeIds.has(child.id)) {
            selected.push({ id: child.id, name: child.name });
          }
        });
      });

      container.innerHTML = selected.map(item => `
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-primary-50 text-primary-700">
          ${item.name}
          <button onclick="removeKnowledge('${item.id}')" class="ml-2 text-primary-500 hover:text-primary-700">
            <i class="fas fa-times text-xs"></i>
          </button>
        </span>
      `).join('');
    }

    // 移除知识点
    function removeKnowledge(id) {
      selectedKnowledgeIds.delete(id);
      document.querySelector(`[data-id="${id}"]`).classList.remove('selected');
      updateSelectedKnowledgeDisplay();
      updateQuestionTypes();
    }

    // 更新题型列表（根据选中的知识点自动判断可选题型）
    function updateQuestionTypes() {
      if (selectedKnowledgeIds.size === 0) {
        document.getElementById('questionTypesList').innerHTML = '<p class="text-sm text-gray-400">请先选择知识点范围</p>';
        return;
      }

      // 模拟：根据知识点判断可用题型（实际应该从后端获取）
      const availableTypes = [
        { id: 'single', name: '单选题', icon: 'fa-dot-circle', color: 'info', count: 45 },
        { id: 'multiple', name: '多选题', icon: 'fa-check-double', color: 'purple', count: 32 },
        { id: 'judge', name: '判断题', icon: 'fa-check-circle', color: 'indigo', count: 28 },
        { id: 'blank', name: '填空题', icon: 'fa-keyboard', color: 'warning', count: 21 },
        { id: 'short', name: '简答题', icon: 'fa-align-left', color: 'amber', count: 15 }
      ];

      questionTypesConfig = availableTypes.map(type => ({
        ...type,
        enabled: true,
        count: 5
      }));

      renderQuestionTypes();
      initSortable();
    }

    // 渲染题型列表
    function renderQuestionTypes() {
      const colorMap = {
        info: { bg: 'bg-info-50', text: 'text-info-600', border: 'border-info-200' },
        purple: { bg: 'bg-purple-50', text: 'text-purple-600', border: 'border-purple-200' },
        indigo: { bg: 'bg-indigo-50', text: 'text-indigo-600', border: 'border-indigo-200' },
        warning: { bg: 'bg-warning-50', text: 'text-warning-600', border: 'border-warning-200' },
        amber: { bg: 'bg-amber-50', text: 'text-amber-600', border: 'border-amber-200' }
      };

      const container = document.getElementById('questionTypesList');
      container.innerHTML = questionTypesConfig.map((type, index) => {
        const colors = colorMap[type.color] || colorMap.info;
        return `
          <div class="flex items-center border border-gray-200 rounded-lg p-4 ${type.enabled ? 'bg-white' : 'bg-gray-50'}" data-type-id="${type.id}">
            <div class="drag-handle mr-4 text-gray-400 cursor-move">
              <i class="fas fa-grip-vertical"></i>
            </div>
            <div class="flex-1 flex items-center">
              <label class="flex items-center flex-1">
                <input type="checkbox" ${type.enabled ? 'checked' : ''} onchange="toggleQuestionType(${index})" class="rounded border-gray-300 text-primary-500 focus:ring-primary-500">
                <div class="ml-3 flex items-center">
                  <div class="w-8 h-8 ${colors.bg} rounded flex items-center justify-center mr-3">
                    <i class="fas ${type.icon} ${colors.text}"></i>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-900">${type.name}</div>
                    <div class="text-xs text-gray-500">题库可用 ${type.count} 题</div>
                  </div>
                </div>
              </label>
              <div class="flex items-center space-x-3 ml-6">
                <span class="text-sm text-gray-600">抽取</span>
                <input type="number" min="1" max="${type.count}" value="${type.count}" ${!type.enabled ? 'disabled' : ''} onchange="updateTypeCount(${index}, this.value)" class="w-20 border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:bg-gray-100 disabled:text-gray-400">
                <span class="text-sm text-gray-600">题</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // 初始化拖拽排序
    function initSortable() {
      const container = document.getElementById('questionTypesList');
      if (sortableInstance) {
        sortableInstance.destroy();
      }
      sortableInstance = new Sortable(container, {
        animation: 150,
        handle: '.drag-handle',
        ghostClass: 'sortable-ghost',
        dragClass: 'sortable-drag',
        onEnd: function(evt) {
          // 更新数组顺序
          const item = questionTypesConfig.splice(evt.oldIndex, 1)[0];
          questionTypesConfig.splice(evt.newIndex, 0, item);
        }
      });
    }

    // 切换题型启用状态
    function toggleQuestionType(index) {
      questionTypesConfig[index].enabled = !questionTypesConfig[index].enabled;
      renderQuestionTypes();
      initSortable();
    }

    // 更新题型数量
    function updateTypeCount(index, value) {
      questionTypesConfig[index].count = parseInt(value) || 1;
    }

    // 设置事件监听
    function setupEventListeners() {
      // 名称字数统计
      document.getElementById('practiceName').addEventListener('input', function() {
        document.getElementById('nameLength').textContent = this.value.length;
      });

      // 通过标准开关
      document.getElementById('enablePassStandard').addEventListener('change', function() {
        document.getElementById('passStandardConfig').classList.toggle('hidden', !this.checked);
      });

      // 题目数量类型切换
      document.querySelectorAll('input[name="questionCountType"]').forEach(radio => {
        radio.addEventListener('change', function() {
          document.getElementById('questionCount').disabled = this.value === 'unlimited';
        });
      });
    }

    // 表单验证
    function validateForm() {
      const name = document.getElementById('practiceName').value.trim();
      if (!name) {
        showToast('请输入刷题名称', 'error');
        return false;
      }

      const startTime = document.getElementById('startTime').value;
      if (!startTime) {
        showToast('请选择开始时间', 'error');
        return false;
      }

      const endTime = document.getElementById('endTime').value;
      if (endTime && new Date(endTime) <= new Date(startTime)) {
        showToast('结束时间必须晚于开始时间', 'error');
        return false;
      }

      if (selectedKnowledgeIds.size === 0) {
        showToast('请选择知识点范围', 'error');
        return false;
      }

      const enabledTypes = questionTypesConfig.filter(t => t.enabled);
      if (enabledTypes.length === 0) {
        showToast('请至少选择一种题型', 'error');
        return false;
      }

      return true;
    }

    // 保存草稿
    function saveDraft() {
      if (!validateForm()) return;

      const data = collectFormData();
      data.status = 'draft';

      console.log('保存草稿:', data);
      showToast('草稿保存成功', 'success');

      setTimeout(() => {
        window.location.href = 'list.html';
      }, 1500);
    }

    // 发布刷题
    function publishPractice() {
      if (!validateForm()) return;

      const data = collectFormData();
      data.status = 'published';

      console.log('发布刷题:', data);
      showToast('发布成功', 'success');

      setTimeout(() => {
        window.location.href = 'list.html';
      }, 1500);
    }

    // 收集表单数据
    function collectFormData() {
      const questionCountType = document.querySelector('input[name="questionCountType"]:checked').value;

      return {
        name: document.getElementById('practiceName').value.trim(),
        startTime: document.getElementById('startTime').value,
        endTime: document.getElementById('endTime').value || null,
        knowledgeIds: Array.from(selectedKnowledgeIds),
        questionTypes: questionTypesConfig.filter(t => t.enabled).map((t, index) => ({
          type: t.id,
          count: t.count,
          order: index + 1
        })),
        difficulties: Array.from(document.querySelectorAll('.difficulty-checkbox:checked')).map(cb => parseInt(cb.value)),
        questionCount: questionCountType === 'unlimited' ? null : parseInt(document.getElementById('questionCount').value),
        enablePassStandard: document.getElementById('enablePassStandard').checked,
        passThreshold: document.getElementById('enablePassStandard').checked ? parseInt(document.getElementById('passThreshold').value) : null,
        answerDisplay: document.querySelector('input[name="answerDisplay"]:checked').value,
        showExplanation: document.getElementById('showExplanation').checked
      };
    }

    // 加载刷题数据（编辑模式）
    function loadPracticeData(id) {
      // 模拟加载数据
      console.log('加载刷题数据:', id);

      // 示例数据填充
      document.getElementById('practiceName').value = '计算机基础专项练习';
      document.getElementById('practiceCode').value = 'PT0001';

      // 更多数据加载...
    }

    // 返回列表
    function goBack() {
      if (confirm('确定要返回吗？未保存的内容将丢失。')) {
        window.location.href = 'list.html';
      }
    }

    // Toast 提示
    function showToast(message, type = 'success') {
      const bgColor = type === 'success' ? 'bg-success-500' : 'bg-error-500';
      const toast = document.createElement('div');
      toast.className = `fixed top-20 right-6 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-2`;
      toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // 页面加载完成后初始化
    window.onload = init;
  </script>
</body>
</html>
