<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>刷题统计 - 考试系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#E6F9F0', 100: '#B2E9D0', 500: '#00B96B', 600: '#00A35C', 700: '#008C4F' },
            success: { 50: '#E8FFEA', 100: '#AFF0B5', 200: '#7BE188', 500: '#00B42A', 600: '#009A29' },
            warning: { 50: '#FFF7E8', 100: '#FFE4BA', 200: '#FFCF8B', 500: '#FF7D00', 600: '#E86F00' },
            error: { 50: '#FFECE8', 100: '#FDCDC5', 200: '#FBACA3', 500: '#F53F3F', 600: '#CB2634' },
            info: { 50: '#E8F7FF', 100: '#C2E7FF', 200: '#94D4FF', 500: '#14C9C9', 600: '#0FC6C2' },
            gray: { 50: '#F7F8FA', 100: '#F2F3F5', 200: '#E5E6EB', 300: '#C9CDD4', 400: '#A9AEB8', 500: '#86909C', 600: '#6B7785', 700: '#4E5969', 800: '#272E3B', 900: '#1D2129' }
          }
        }
      }
    }
  </script>
  <style>
    .stat-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .date-range-input input[type="date"] {
      border: 1px solid #E5E6EB;
      border-radius: 0.375rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
    }

    .date-range-input input[type="date"]:focus {
      outline: none;
      border-color: #00B96B;
      box-shadow: 0 0 0 3px rgba(0, 185, 107, 0.1);
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="h-16 bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
      <div class="flex items-center justify-between h-full px-6">
        <div class="flex items-center space-x-6">
          <a href="../dashboard.html" class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-primary-500 rounded-lg flex items-center justify-center">
              <i class="fas fa-book text-white text-lg"></i>
            </div>
            <span class="text-xl font-semibold text-gray-900">考试系统</span>
          </a>
          <div class="flex items-center space-x-2 text-sm">
            <a href="../dashboard.html" class="text-gray-600 hover:text-primary-500">首页</a>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
            <a href="list.html" class="text-gray-600 hover:text-primary-500">刷题管理</a>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
            <span class="text-gray-900">刷题统计</span>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=admin" alt="用户头像" class="w-8 h-8 rounded-full">
          <span class="text-sm text-gray-700">管理员</span>
        </div>
      </div>
    </header>

    <main class="pt-16">
      <div class="max-w-[1600px] mx-auto">
        <!-- 任务信息栏 -->
        <div class="bg-white border-b border-gray-200 px-6 py-3">
          <div class="flex items-center justify-between">
            <!-- 左侧：任务详情 -->
            <div class="flex items-center gap-4">
              <a href="list.html" class="text-gray-500 hover:text-gray-700 transition-colors">
                <i class="fas fa-arrow-left text-lg"></i>
              </a>
              <div class="flex items-center gap-3">
                <h1 class="text-base font-semibold text-gray-900" id="practiceName">刷题任务</h1>
                <span class="px-2 py-0.5 rounded text-xs font-medium" id="questionModeBadge">-</span>
                <span class="text-xs text-gray-500">|</span>
                <span class="text-xs text-gray-600"><i class="fas fa-hashtag mr-1"></i><span id="practiceCode">-</span></span>
                <span class="text-xs text-gray-600"><i class="fas fa-calendar mr-1"></i><span id="practiceTime">-</span></span>
                <span class="px-2 py-0.5 rounded text-xs font-medium" id="practiceStatusBadge">-</span>
              </div>
            </div>
          </div>
        </div>

        <div class="p-6">

        <!-- 关键指标卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
          <div class="stat-card bg-white rounded-lg border border-gray-200 p-5">
            <div class="flex items-center justify-between mb-3">
              <span class="text-sm text-gray-600">参与人数</span>
              <div class="w-10 h-10 bg-info-50 rounded-lg flex items-center justify-center">
                <i class="fas fa-users text-info-500"></i>
              </div>
            </div>
            <p class="text-3xl font-bold text-gray-900" id="totalParticipants">0</p>
            <p class="text-xs text-gray-500 mt-1">总人数 <span id="totalStudents">0</span></p>
          </div>

          <div class="stat-card bg-white rounded-lg border border-gray-200 p-5">
            <div class="flex items-center justify-between mb-3">
              <span class="text-sm text-gray-600">平均进度</span>
              <div class="w-10 h-10 bg-primary-50 rounded-lg flex items-center justify-center">
                <i class="fas fa-tasks text-primary-500"></i>
              </div>
            </div>
            <p class="text-3xl font-bold text-primary-600" id="avgProgress">0%</p>
            <p class="text-xs text-gray-500 mt-1">完成度</p>
          </div>

          <div class="stat-card bg-white rounded-lg border border-gray-200 p-5">
            <div class="flex items-center justify-between mb-3">
              <span class="text-sm text-gray-600">完成人数</span>
              <div class="w-10 h-10 bg-success-50 rounded-lg flex items-center justify-center">
                <i class="fas fa-check-circle text-success-500"></i>
              </div>
            </div>
            <p class="text-3xl font-bold text-success-600" id="completedCount">0</p>
            <p class="text-xs text-gray-500 mt-1">完成率 <span id="completionRate">0%</span></p>
          </div>

          <div class="stat-card bg-white rounded-lg border border-gray-200 p-5">
            <div class="flex items-center justify-between mb-3">
              <span class="text-sm text-gray-600">平均正确率</span>
              <div class="w-10 h-10 bg-warning-50 rounded-lg flex items-center justify-center">
                <i class="fas fa-chart-line text-warning-500"></i>
              </div>
            </div>
            <p class="text-3xl font-bold text-warning-600" id="avgAccuracy">0%</p>
            <p class="text-xs text-gray-500 mt-1">整体表现</p>
          </div>

          <div class="stat-card bg-white rounded-lg border border-gray-200 p-5">
            <div class="flex items-center justify-between mb-3">
              <span class="text-sm text-gray-600">掌握人数</span>
              <div class="w-10 h-10 bg-purple-50 rounded-lg flex items-center justify-center">
                <i class="fas fa-medal text-purple-500"></i>
              </div>
            </div>
            <p class="text-3xl font-bold text-purple-600" id="masteredCount">0</p>
            <p class="text-xs text-gray-500 mt-1">正确率≥80%</p>
          </div>
        </div>

        <!-- 1. 任务进度情况 -->
        <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-chart-pie text-primary-500 mr-2"></i>
            任务进度情况
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 进度分布图 -->
            <div>
              <h3 class="text-sm font-medium text-gray-700 mb-3">进度分布</h3>
              <div id="progressChart" style="width: 100%; height: 300px;"></div>
            </div>
            <!-- 完成状态统计 -->
            <div>
              <h3 class="text-sm font-medium text-gray-700 mb-3">完成状态统计</h3>
              <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                  <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-error-500"></div>
                    <span class="text-sm text-gray-700">未开始</span>
                  </div>
                  <div class="text-right">
                    <span class="text-lg font-semibold text-gray-900" id="notStartedCount">0</span>
                    <span class="text-xs text-gray-500 ml-1">人</span>
                  </div>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                  <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-warning-500"></div>
                    <span class="text-sm text-gray-700">进行中</span>
                  </div>
                  <div class="text-right">
                    <span class="text-lg font-semibold text-gray-900" id="inProgressCount">0</span>
                    <span class="text-xs text-gray-500 ml-1">人</span>
                  </div>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                  <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-success-500"></div>
                    <span class="text-sm text-gray-700">已完成</span>
                  </div>
                  <div class="text-right">
                    <span class="text-lg font-semibold text-gray-900" id="completedCount2">0</span>
                    <span class="text-xs text-gray-500 ml-1">人</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 2. 知识点掌握度排行 -->
        <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-trophy text-warning-500 mr-2"></i>
            知识点掌握度排行
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 掌握度分布图 -->
            <div>
              <h3 class="text-sm font-medium text-gray-700 mb-3">掌握度分布</h3>
              <div id="masteryChart" style="width: 100%; height: 300px;"></div>
            </div>
            <!-- 知识点排行榜 -->
            <div>
              <h3 class="text-sm font-medium text-gray-700 mb-3">知识点正确率排名</h3>
              <div class="overflow-y-auto" style="max-height: 300px;">
                <table class="w-full text-sm">
                  <thead class="bg-gray-50 sticky top-0">
                    <tr>
                      <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">排名</th>
                      <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">知识点</th>
                      <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">正确率</th>
                    </tr>
                  </thead>
                  <tbody id="knowledgeRankBody" class="divide-y divide-gray-200">
                    <!-- 动态填充 -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- 3. 学生完成情况 -->
        <div class="bg-white rounded-lg border border-gray-200 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-list text-info-500 mr-2"></i>
            学生完成情况
          </h2>

          <!-- 搜索筛选栏 -->
          <div class="flex items-center justify-between mb-4 pb-4 border-b border-gray-200">
            <!-- 左侧：搜索和筛选 -->
            <div class="flex items-center gap-2">
              <div class="relative">
                <input type="text" id="searchInput" placeholder="搜索姓名、用户名、手机号..." class="w-56 pl-9 pr-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500" onkeyup="handleSearch(event)">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
              </div>
              <select id="filterStatus" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500" onchange="filterStudentList()">
                <option value="">全部状态</option>
                <option value="未开始">未开始</option>
                <option value="进行中">进行中</option>
                <option value="已完成">已完成</option>
              </select>
              <select id="filterMastery" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500" onchange="filterStudentList()">
                <option value="">全部掌握度</option>
                <option value="掌握">掌握</option>
                <option value="一般">一般</option>
                <option value="薄弱">薄弱</option>
              </select>
              <button onclick="filterStudentList()" class="px-4 py-1.5 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium">
                <i class="fas fa-search mr-2"></i>筛选
              </button>
              <button onclick="resetFilter()" class="px-4 py-1.5 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg text-sm font-medium">
                <i class="fas fa-redo mr-2"></i>重置
              </button>
            </div>
            <!-- 右侧：导出按钮 -->
            <div>
              <button onclick="exportStudentList()" class="px-4 py-1.5 bg-success-500 hover:bg-success-600 text-white rounded-lg text-sm font-medium">
                <i class="fas fa-download mr-2"></i>导出
              </button>
            </div>
          </div>

          <!-- 学生列表 -->
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">照片</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">姓名</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">用户名</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">手机号</th>
                  <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">状态</th>
                  <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">刷题次数</th>
                  <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">完成进度</th>
                  <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">正确率</th>
                  <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">知识点掌握度</th>
                  <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">最后刷题时间</th>
                </tr>
              </thead>
              <tbody id="studentListBody" class="divide-y divide-gray-200">
                <!-- 动态填充 -->
              </tbody>
            </table>
          </div>

          <!-- 分页 -->
          <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-200">
            <div class="text-sm text-gray-700">
              显示 <span id="pageStart">0</span> - <span id="pageEnd">0</span>，共 <span id="pageTotal">0</span> 条
            </div>
            <div class="flex items-center gap-2">
              <button onclick="prevPage()" id="prevBtn" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-chevron-left"></i>
              </button>
              <span class="text-sm text-gray-700">第 <span id="currentPageNum">1</span> 页，共 <span id="totalPages">1</span> 页</span>
              <button onclick="nextPage()" id="nextBtn" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // 全局变量
    let allStudents = [];
    let filteredStudents = [];
    let currentPage = 1;
    const pageSize = 20;

    // 图表实例
    let progressChart = null;
    let masteryChart = null;

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      loadPracticeInfo();
      generateMockData();
      initCharts();  // 先初始化图表
      loadStudentsData();  // 再加载数据
    });

    // 加载刷题信息
    function loadPracticeInfo() {
      // 从URL获取任务ID
      const urlParams = new URLSearchParams(window.location.search);
      const practiceId = urlParams.get('id');

      if (!practiceId) {
        console.error('未找到任务ID');
        showMessage('未找到任务信息', 'error');
        return;
      }

      // 从localStorage加载任务数据
      try {
        const stored = localStorage.getItem('practices');
        if (!stored) {
          console.error('未找到任务列表数据');
          showMessage('未找到任务列表数据', 'error');
          return;
        }

        const practices = JSON.parse(stored);
        const practice = practices.find(p => p.id === practiceId);

        if (!practice) {
          console.error('未找到指定任务:', practiceId);
          showMessage('未找到指定任务', 'error');
          return;
        }

        // 填充任务信息
        document.getElementById('practiceName').textContent = practice.name;
        document.getElementById('practiceCode').textContent = practice.code;

        // 设置时间范围（兼容旧格式：只有日期 vs 新格式：日期+时间）
        const formatTimeDisplay = (timeStr) => {
          if (!timeStr) return '';
          // 如果已经包含时间部分（格式：YYYY-MM-DD HH:MM），直接返回
          if (timeStr.includes(':')) {
            return timeStr;
          }
          // 如果只有日期部分（格式：YYYY-MM-DD），补充默认时间 08:00
          return `${timeStr} 08:00`;
        };

        const startTimeDisplay = formatTimeDisplay(practice.startTime);
        const endTimeDisplay = practice.endTime ? formatTimeDisplay(practice.endTime) : null;

        const timeRange = endTimeDisplay
          ? `${startTimeDisplay} ~ ${endTimeDisplay}`
          : `${startTimeDisplay} ~ 不限`;
        document.getElementById('practiceTime').textContent = timeRange;

        // 设置题目模式徽章
        const modeBadge = document.getElementById('questionModeBadge');
        if (practice.questionMode === 'fixed') {
          modeBadge.textContent = '固定抽题';
          modeBadge.className = 'px-2 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-700';
        } else {
          modeBadge.textContent = '随机抽题';
          modeBadge.className = 'px-2 py-0.5 rounded text-xs font-medium bg-purple-50 text-purple-700';
        }

        // 设置状态徽章
        const statusBadge = document.getElementById('practiceStatusBadge');
        const statusMap = {
          'not_started': { text: '未开始', class: 'bg-warning-500 text-white' },
          'ongoing': { text: '进行中', class: 'bg-success-500 text-white' },
          'ended': { text: '已结束', class: 'bg-gray-500 text-white' }
        };
        const status = statusMap[practice.status] || statusMap['not_started'];
        statusBadge.textContent = status.text;
        statusBadge.className = `px-2 py-0.5 rounded text-xs font-medium ${status.class}`;

        console.log('任务信息加载成功:', practice);
      } catch (e) {
        console.error('加载任务信息失败:', e);
        showMessage('加载任务信息失败', 'error');
      }
    }

    // 生成模拟数据
    function generateMockData() {
      const names = [
        '张三', '李四', '王五', '赵六', '钱七', '孙八', '周九', '吴十',
        '郑小明', '王小红', '李明', '陈静', '刘洋', '黄磊', '杨帆', '朱莉',
        '徐文', '何丽', '高峰', '林娜', '罗伟', '梁艳', '宋军', '唐敏'
      ];

      const totalQuestions = 100; // 总题数

      for (let i = 0; i < 156; i++) {
        const practiceCount = Math.floor(Math.random() * totalQuestions);
        const masteredCount = Math.max(0, practiceCount - Math.floor(Math.random() * practiceCount * 0.3));
        const progress = totalQuestions > 0 ? Math.round((practiceCount / totalQuestions) * 100) : 0;
        const masteryRate = practiceCount > 0 ? Math.round((masteredCount / practiceCount) * 100) : 0;

        let status = 'not_started';
        if (practiceCount === 0) {
          status = 'not_started';
        } else if (masteryRate >= 100) {
          status = 'mastered';
        } else {
          status = 'in_progress';
        }

        // 随机最后刷题时间
        const daysSinceLastPractice = status === 'not_started' ? null : Math.floor(Math.random() * 7);
        const lastPracticeTime = daysSinceLastPractice !== null
          ? new Date(Date.now() - daysSinceLastPractice * 24 * 60 * 60 * 1000)
          : null;

        allStudents.push({
          id: `S${String(i + 1).padStart(4, '0')}`,
          username: `user${String(i + 1).padStart(3, '0')}`,
          name: names[i % names.length] + (i >= names.length ? (Math.floor(i / names.length) + 1) : ''),
          phone: `138${String(Math.floor(Math.random() * 100000000)).padStart(8, '0')}`,
          status: status,
          practiceCount: practiceCount,
          progress: progress,
          masteredCount: masteredCount,
          masteryRate: masteryRate,
          lastPracticeTime: lastPracticeTime
        });
      }
    }

    // 更新总览统计
    function updateOverviewStats() {
      const totalStudents = allStudents.length;
      const participatedStudents = allStudents.filter(s => s.status !== 'not_started').length;
      const completedStudents = allStudents.filter(s => s.status === 'mastered').length;
      const inProgressStudents = allStudents.filter(s => s.status === 'in_progress').length;
      const masteredStudents = allStudents.filter(s => s.masteryRate >= 80).length;

      const avgProgress = participatedStudents > 0
        ? Math.round(allStudents.reduce((sum, s) => sum + s.progress, 0) / totalStudents)
        : 0;

      const avgAccuracy = participatedStudents > 0
        ? Math.round(allStudents.filter(s => s.status !== 'not_started').reduce((sum, s) => sum + s.masteryRate, 0) / participatedStudents)
        : 0;

      const completionRate = totalStudents > 0
        ? Math.round((completedStudents / totalStudents) * 100)
        : 0;

      // 更新卡片数据
      document.getElementById('totalParticipants').textContent = participatedStudents;
      document.getElementById('totalStudents').textContent = totalStudents;
      document.getElementById('avgProgress').textContent = avgProgress + '%';
      document.getElementById('completedCount').textContent = completedStudents;
      document.getElementById('completionRate').textContent = completionRate + '%';
      document.getElementById('avgAccuracy').textContent = avgAccuracy + '%';
      document.getElementById('masteredCount').textContent = masteredStudents;

      // 更新状态统计
      document.getElementById('notStartedCount').textContent = allStudents.filter(s => s.status === 'not_started').length;
      document.getElementById('inProgressCount').textContent = inProgressStudents;
      document.getElementById('completedCount2').textContent = completedStudents;
    }

    // 加载学生数据
    function loadStudentsData() {
      filteredStudents = [...allStudents];
      updateStatistics();
      updateCharts();
      renderStudentList();
    }

    // 更新统计数据
    function updateStatistics() {
      updateOverviewStats();
    }

    // 初始化图表
    function initCharts() {
      const progressChartDom = document.getElementById('progressChart');
      const masteryChartDom = document.getElementById('masteryChart');

      if (progressChartDom && masteryChartDom) {
        progressChart = echarts.init(progressChartDom);
        masteryChart = echarts.init(masteryChartDom);
      } else {
        console.error('图表DOM元素未找到');
      }
    }

    // 更新图表
    function updateCharts() {
      updateProgressChart();
      updateMasteryChart();
      updateKnowledgeRank();
    }

    // 更新进度分布图
    function updateProgressChart() {
      if (!progressChart) {
        console.warn('进度图表未初始化');
        return;
      }

      const progressRanges = {
        '0%': 0,
        '1-20%': 0,
        '21-40%': 0,
        '41-60%': 0,
        '61-80%': 0,
        '81-99%': 0,
        '100%': 0
      };

      allStudents.forEach(s => {
        if (s.progress === 0) progressRanges['0%']++;
        else if (s.progress <= 20) progressRanges['1-20%']++;
        else if (s.progress <= 40) progressRanges['21-40%']++;
        else if (s.progress <= 60) progressRanges['41-60%']++;
        else if (s.progress <= 80) progressRanges['61-80%']++;
        else if (s.progress < 100) progressRanges['81-99%']++;
        else progressRanges['100%']++;
      });

      const option = {
        tooltip: {
          trigger: 'item',
          formatter: '{b}: {c}人 ({d}%)'
        },
        legend: {
          orient: 'vertical',
          right: 10,
          top: 'center'
        },
        series: [{
          type: 'pie',
          radius: ['40%', '70%'],
          avoidLabelOverlap: false,
          itemStyle: {
            borderRadius: 10,
            borderColor: '#fff',
            borderWidth: 2
          },
          label: {
            show: true,
            formatter: '{b}: {c}人'
          },
          emphasis: {
            label: {
              show: true,
              fontSize: 14,
              fontWeight: 'bold'
            }
          },
          data: Object.keys(progressRanges).map(key => ({
            value: progressRanges[key],
            name: key
          }))
        }]
      };

      progressChart.setOption(option);
    }

    // 更新掌握度分布图
    function updateMasteryChart() {
      if (!masteryChart) {
        console.warn('掌握度图表未初始化');
        return;
      }

      const masteryLevels = {
        '掌握 (≥80%)': 0,
        '一般 (60-79%)': 0,
        '薄弱 (<60%)': 0,
        '未开始': 0
      };

      allStudents.forEach(s => {
        if (s.status === 'not_started') {
          masteryLevels['未开始']++;
        } else if (s.masteryRate >= 80) {
          masteryLevels['掌握 (≥80%)']++;
        } else if (s.masteryRate >= 60) {
          masteryLevels['一般 (60-79%)']++;
        } else {
          masteryLevels['薄弱 (<60%)']++;
        }
      });

      const option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          }
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: Object.keys(masteryLevels),
          axisLabel: {
            interval: 0,
            rotate: 0
          }
        },
        yAxis: {
          type: 'value'
        },
        series: [{
          type: 'bar',
          data: Object.values(masteryLevels),
          itemStyle: {
            color: function(params) {
              const colors = ['#00B42A', '#FF7D00', '#F53F3F', '#C9CDD4'];
              return colors[params.dataIndex];
            },
            borderRadius: [8, 8, 0, 0]
          },
          label: {
            show: true,
            position: 'top',
            formatter: '{c}人'
          }
        }]
      };

      masteryChart.setOption(option);
    }

    // 更新知识点排行
    function updateKnowledgeRank() {
      // 从localStorage加载知识点树
      let knowledgeTree = JSON.parse(localStorage.getItem('knowledgeTree') || '[]');

      // 如果localStorage中没有数据，使用默认知识点
      if (knowledgeTree.length === 0) {
        knowledgeTree = [
          { id: 'kp001', name: '计算机基础', children: [] },
          { id: 'kp002', name: '数据结构', children: [] },
          { id: 'kp003', name: '算法设计', children: [] },
          { id: 'kp004', name: '操作系统', children: [] },
          { id: 'kp005', name: '计算机网络', children: [] },
          { id: 'kp006', name: '数据库原理', children: [] },
          { id: 'kp007', name: '软件工程', children: [] },
          { id: 'kp008', name: '编程语言', children: [] },
          { id: 'kp009', name: 'Web开发', children: [] },
          { id: 'kp010', name: '移动开发', children: [] }
        ];
      }

      // 提取所有知识点
      const knowledgeList = [];
      function extractKnowledge(nodes) {
        nodes.forEach(node => {
          knowledgeList.push({ id: node.id, name: node.name });
          if (node.children && node.children.length > 0) {
            extractKnowledge(node.children);
          }
        });
      }
      extractKnowledge(knowledgeTree);

      // 确保至少有10个知识点用于排名
      if (knowledgeList.length === 0) {
        // 如果还是没有数据，添加默认知识点
        for (let i = 1; i <= 10; i++) {
          knowledgeList.push({ id: `kp${i}`, name: `知识点${i}` });
        }
      }

      // 模拟知识点正确率（实际应该从学生答题数据计算）
      const knowledgeRank = knowledgeList.map(kp => ({
        id: kp.id,
        name: kp.name,
        accuracy: Math.floor(Math.random() * 40) + 60  // 60-100的随机值
      })).sort((a, b) => b.accuracy - a.accuracy).slice(0, 10);

      // 渲染排行榜
      const tbody = document.getElementById('knowledgeRankBody');
      if (!tbody) {
        console.error('找不到knowledgeRankBody元素');
        return;
      }

      tbody.innerHTML = knowledgeRank.map((kp, index) => {
        const rankClass = index < 3 ? 'text-warning-600 font-bold' : 'text-gray-600';
        const accuracyClass = kp.accuracy >= 80 ? 'text-success-600' : kp.accuracy >= 60 ? 'text-warning-600' : 'text-error-600';

        return `
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-2 ${rankClass}">#${index + 1}</td>
            <td class="px-3 py-2 text-gray-900">${kp.name}</td>
            <td class="px-3 py-2 text-right ${accuracyClass} font-medium">${kp.accuracy}%</td>
          </tr>
        `;
      }).join('');
    }

    // 渲染学生列表
    function renderStudentList() {
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageData = filteredStudents.slice(start, end);

      const tbody = document.getElementById('studentListBody');
      tbody.innerHTML = pageData.map(student => {
        const statusMap = {
          'not_started': { text: '未开始', class: 'bg-error-50 text-error-700 border border-error-200' },
          'in_progress': { text: '进行中', class: 'bg-warning-50 text-warning-700 border border-warning-200' },
          'mastered': { text: '已完成', class: 'bg-success-50 text-success-700 border border-success-200' }
        };
        const statusStyle = statusMap[student.status] || statusMap['not_started'];

        let masteryHtml = '<span class="text-gray-400 text-xs">-</span>';
        if (student.status !== 'not_started') {
          let masteryLevel, masteryClass, masteryIcon;
          if (student.masteryRate >= 80) {
            masteryLevel = '掌握';
            masteryClass = 'bg-success-50 text-success-600 border-2 border-success-300';
            masteryIcon = 'fa-solid fa-medal';
          } else if (student.masteryRate >= 60) {
            masteryLevel = '一般';
            masteryClass = 'bg-warning-50 text-warning-600 border-2 border-warning-300';
            masteryIcon = 'fa-solid fa-circle';
          } else {
            masteryLevel = '薄弱';
            masteryClass = 'bg-error-50 text-error-600 border-2 border-error-300';
            masteryIcon = 'fa-solid fa-triangle-exclamation';
          }
          masteryHtml = `<span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium ${masteryClass}">
            <i class="${masteryIcon}"></i>
            <span>${masteryLevel}</span>
          </span>`;
        }

        const progressHtml = student.status === 'not_started'
          ? '<span class="text-gray-400 text-xs">-</span>'
          : `<div class="flex items-center gap-2">
              <div class="flex-1 bg-gray-200 rounded-full h-2 max-w-[80px]">
                <div class="bg-primary-500 h-2 rounded-full" style="width: ${student.progress}%"></div>
              </div>
              <span class="text-xs text-gray-600">${student.progress}%</span>
            </div>`;

        const accuracyHtml = student.status === 'not_started'
          ? '<span class="text-gray-400 text-xs">-</span>'
          : `<span class="text-sm font-medium ${student.masteryRate >= 80 ? 'text-success-600' : student.masteryRate >= 60 ? 'text-warning-600' : 'text-error-600'}">${student.masteryRate}%</span>`;

        const lastTimeHtml = student.lastPracticeTime
          ? new Date(student.lastPracticeTime).toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
          : '<span class="text-gray-400 text-xs">-</span>';

        // 生成随机头像
        const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${student.username}`;

        return `
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3">
              <img src="${avatarUrl}" alt="${student.name}" class="w-8 h-8 rounded-full">
            </td>
            <td class="px-4 py-3 text-sm font-medium text-gray-900">${student.name}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${student.username}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${student.phone}</td>
            <td class="px-4 py-3 text-center">
              <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-medium ${statusStyle.class}">
                ${statusStyle.text}
              </span>
            </td>
            <td class="px-4 py-3 text-center text-sm text-gray-900">${student.practiceCount}</td>
            <td class="px-4 py-3 text-center">${progressHtml}</td>
            <td class="px-4 py-3 text-center">${accuracyHtml}</td>
            <td class="px-4 py-3 text-center">${masteryHtml}</td>
            <td class="px-4 py-3 text-center text-xs text-gray-500">${lastTimeHtml}</td>
          </tr>
        `;
      }).join('');

      // 更新分页信息
      const totalPages = Math.ceil(filteredStudents.length / pageSize);
      const actualEnd = Math.min(end, filteredStudents.length);

      document.getElementById('pageStart').textContent = filteredStudents.length > 0 ? start + 1 : 0;
      document.getElementById('pageEnd').textContent = actualEnd;
      document.getElementById('pageTotal').textContent = filteredStudents.length;
      document.getElementById('currentPageNum').textContent = currentPage;
      document.getElementById('totalPages').textContent = totalPages || 1;

      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
    }

    // 分页控制
    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderStudentList();
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(filteredStudents.length / pageSize);
      if (currentPage < totalPages) {
        currentPage++;
        renderStudentList();
      }
    }

    // 渲染掌握情况图表
    function renderMasteryChart() {
      const chartDom = document.getElementById('masteryChart');
      masteryChart = echarts.init(chartDom);

      // 统计各等级人数
      const distribution = [
        { level: '未通过 (0-59%)', min: 0, max: 59, count: 0, color: '#F53F3F' },
        { level: '通过 (60-100%)', min: 60, max: 100, count: 0, color: '#00B42A' }
      ];

      allStudents.forEach(student => {
        if (student.status === 'not_started') return;

        for (let i = 0; i < distribution.length; i++) {
          if (student.masteryRate >= distribution[i].min && student.masteryRate <= distribution[i].max) {
            distribution[i].count++;
            break;
          }
        }
      });

      const option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          },
          formatter: function(params) {
            const data = params[0];
            const total = allStudents.filter(s => s.status !== 'not_started').length;
            const percent = total > 0 ? ((data.value / total) * 100).toFixed(1) : 0;
            return `${data.name}<br/>人数: ${data.value} (${percent}%)`;
          }
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          top: '10%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: distribution.map(d => d.level),
          axisLabel: {
            fontSize: 12,
            color: '#4E5969'
          }
        },
        yAxis: {
          type: 'value',
          name: '人数',
          axisLabel: {
            fontSize: 12,
            color: '#4E5969'
          }
        },
        series: [
          {
            name: '人数',
            type: 'bar',
            data: distribution.map(d => ({
              value: d.count,
              itemStyle: { color: d.color }
            })),
            barWidth: '40%',
            label: {
              show: true,
              position: 'top',
              fontSize: 12,
              color: '#1D2129'
            }
          }
        ]
      };

      masteryChart.setOption(option);

      // 生成智能诊断
      generateDiagnosis(distribution);

      // 渲染表格数据
      renderMasteryTable(distribution);
    }

    // 生成智能诊断结论
    function generateDiagnosis(distribution) {
      const total = allStudents.filter(s => s.status !== 'not_started').length;
      const passCount = distribution.find(d => d.min === 60).count;
      const failCount = distribution.find(d => d.min === 0).count;

      const passPercent = total > 0 ? ((passCount / total) * 100).toFixed(1) : 0;

      let diagnosis = `本次刷题共有 ${total} 名学生参与。`;

      if (passPercent >= 80) {
        diagnosis += `通过人数 ${passCount} 人，占比 ${passPercent}%，整体掌握情况优秀。`;
      } else if (passPercent >= 60) {
        diagnosis += `通过人数 ${passCount} 人，占比 ${passPercent}%，整体掌握情况良好。`;
      } else if (passPercent >= 40) {
        diagnosis += `通过人数 ${passCount} 人，占比 ${passPercent}%，整体掌握情况一般，建议关注未通过学生。`;
      } else {
        diagnosis += `通过人数 ${passCount} 人，占比 ${passPercent}%，整体掌握情况较差，需重点关注。`;
      }

      if (failCount > 0) {
        diagnosis += ` 未通过人数 ${failCount} 人，需要加强学习。`;
      }

      document.getElementById('diagnosisText').textContent = diagnosis;
    }

    // 渲染掌握情况表格
    function renderMasteryTable(distribution) {
      const tbody = document.getElementById('masteryTableBody');
      const total = allStudents.filter(s => s.status !== 'not_started').length;

      tbody.innerHTML = distribution.map(d => {
        const percent = total > 0 ? ((d.count / total) * 100).toFixed(1) : 0;
        return `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 text-sm font-medium text-gray-900">${d.level}</td>
            <td class="px-6 py-4 text-sm text-gray-600">${d.min}% - ${d.max}%</td>
            <td class="px-6 py-4 text-sm text-gray-900">${d.count} 人</td>
            <td class="px-6 py-4 text-sm text-gray-600">${percent}%</td>
          </tr>
        `;
      }).join('');
    }

    // 切换视图
    function switchView(view) {
      if (view === 'chart') {
        document.getElementById('chartView').classList.remove('hidden');
        document.getElementById('tableView').classList.add('hidden');
        document.getElementById('chartViewBtn').classList.add('bg-white', 'text-gray-900', 'shadow-sm');
        document.getElementById('chartViewBtn').classList.remove('text-gray-600');
        document.getElementById('tableViewBtn').classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
        document.getElementById('tableViewBtn').classList.add('text-gray-600');

        // 重新渲染图表（解决切换后尺寸问题）
        setTimeout(() => {
          if (masteryChart) masteryChart.resize();
        }, 100);
      } else {
        document.getElementById('chartView').classList.add('hidden');
        document.getElementById('tableView').classList.remove('hidden');
        document.getElementById('tableViewBtn').classList.add('bg-white', 'text-gray-900', 'shadow-sm');
        document.getElementById('tableViewBtn').classList.remove('text-gray-600');
        document.getElementById('chartViewBtn').classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
        document.getElementById('chartViewBtn').classList.add('text-gray-600');
      }
    }

    // 下载图表
    function downloadChart() {
      if (!masteryChart) return;
      const url = masteryChart.getDataURL({
        type: 'png',
        pixelRatio: 2,
        backgroundColor: '#fff'
      });
      const link = document.createElement('a');
      link.download = '掌握情况分布.png';
      link.href = url;
      link.click();
      showToast('图表下载成功', 'success');
    }

    // 应用学生筛选
    function applyStudentFilters() {
      const search = document.getElementById('studentSearch').value.trim().toLowerCase();
      const status = document.getElementById('statusFilter').value;
      const startDate = document.getElementById('startDateFilter').value;
      const endDate = document.getElementById('endDateFilter').value;

      filteredStudents = allStudents.filter(student => {
        // 搜索筛选
        if (search) {
          const searchText = `${student.username} ${student.name}`.toLowerCase();
          if (!searchText.includes(search)) return false;
        }

        // 状态筛选
        if (status && student.status !== status) return false;

        // 时间范围筛选
        if (student.lastPracticeTime) {
          const practiceDate = formatDate(student.lastPracticeTime);
          if (startDate && practiceDate < startDate) return false;
          if (endDate && practiceDate > endDate) return false;
        } else {
          // 未开始的学生没有刷题时间，时间筛选时排除
          if (startDate || endDate) return false;
        }

        return true;
      });

      currentStudentPage = 1;
      renderStudentTable();
    }

    // 重置学生筛选
    function resetStudentFilters() {
      document.getElementById('studentSearch').value = '';
      document.getElementById('statusFilter').value = '';
      document.getElementById('startDateFilter').value = '';
      document.getElementById('endDateFilter').value = '';
      applyStudentFilters();
    }

    // 新的筛选函数（适配第3层头部的筛选器）
    function filterStudentList() {
      const search = document.getElementById('searchInput').value.trim().toLowerCase();
      const status = document.getElementById('filterStatus').value;
      const mastery = document.getElementById('filterMastery').value;

      filteredStudents = allStudents.filter(student => {
        // 搜索筛选（姓名、用户名、手机号）
        if (search) {
          const searchText = `${student.name} ${student.username} ${student.phone || ''}`.toLowerCase();
          if (!searchText.includes(search)) return false;
        }

        // 状态筛选
        if (status) {
          const statusMap = {
            '未开始': 'not_started',
            '进行中': 'in_progress',
            '已完成': 'mastered'
          };
          if (student.status !== statusMap[status]) return false;
        }

        // 掌握度筛选
        if (mastery) {
          let studentMastery = '';
          if (student.masteryRate >= 80) studentMastery = '掌握';
          else if (student.masteryRate >= 60) studentMastery = '一般';
          else if (student.masteryRate > 0) studentMastery = '薄弱';

          if (studentMastery !== mastery) return false;
        }

        return true;
      });

      currentStudentPage = 1;
      renderStudentTable();
    }

    // 处理搜索（回车键触发）
    function handleSearch(event) {
      if (event.key === 'Enter') {
        filterStudentList();
      }
    }

    // 重置筛选
    function resetFilter() {
      document.getElementById('searchInput').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterMastery').value = '';
      filterStudentList();
    }

    // 渲染学生表格
    function renderStudentTable() {
      const tbody = document.getElementById('studentTableBody');

      if (filteredStudents.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-12 text-center text-sm text-gray-500">暂无数据</td></tr>';
        updateStudentPagination();
        return;
      }

      const start = (currentStudentPage - 1) * studentPageSize;
      const end = Math.min(start + studentPageSize, filteredStudents.length);
      const pageData = filteredStudents.slice(start, end);

      tbody.innerHTML = pageData.map(student => createStudentRow(student)).join('');

      updateStudentPagination();
      updateSelectedCount();
    }

    // 创建学生表格行
    function createStudentRow(student) {
      const statusConfig = {
        not_started: { text: '未开始', class: 'bg-gray-100 text-gray-600' },
        in_progress: { text: '刷题中', class: 'bg-info-50 text-info-600' },
        mastered: { text: '全部掌握', class: 'bg-success-50 text-success-600' }
      };

      const status = statusConfig[student.status] || statusConfig.not_started;
      const isChecked = selectedStudentIds.has(student.id);

      return `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4">
            <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleStudentSelection('${student.id}')" class="rounded border-gray-300 text-primary-500 focus:ring-primary-500">
          </td>
          <td class="px-6 py-4 text-sm text-gray-900">${student.username}</td>
          <td class="px-6 py-4 text-sm text-gray-900">${student.name}</td>
          <td class="px-6 py-4">
            <span class="px-2.5 py-0.5 rounded-full text-xs font-medium ${status.class}">
              ${status.text}
            </span>
          </td>
          <td class="px-6 py-4 text-sm text-gray-900">${student.practiceCount} 题</td>
          <td class="px-6 py-4 text-sm">
            <div class="flex items-center">
              <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2">
                <div class="bg-primary-500 h-2 rounded-full" style="width: ${student.progress}%"></div>
              </div>
              <span class="text-gray-900">${student.progress}%</span>
            </div>
          </td>
          <td class="px-6 py-4 text-sm text-gray-900">${student.masteredCount} 题</td>
          <td class="px-6 py-4 text-sm">
            <span class="${student.masteryRate >= 60 ? 'text-success-600 font-medium' : 'text-gray-900'}">${student.masteryRate}%</span>
          </td>
          <td class="px-6 py-4 text-sm text-gray-600">${student.lastPracticeTime ? formatDateTime(student.lastPracticeTime) : '--'}</td>
        </tr>
      `;
    }

    // 切换学生选择
    function toggleStudentSelection(id) {
      if (selectedStudentIds.has(id)) {
        selectedStudentIds.delete(id);
      } else {
        selectedStudentIds.add(id);
      }
      updateSelectedCount();
    }

    // 全选/取消全选
    function toggleSelectAll() {
      const checkbox = document.getElementById('selectAll');
      const start = (currentStudentPage - 1) * studentPageSize;
      const end = Math.min(start + studentPageSize, filteredStudents.length);
      const pageData = filteredStudents.slice(start, end);

      if (checkbox.checked) {
        pageData.forEach(student => selectedStudentIds.add(student.id));
      } else {
        pageData.forEach(student => selectedStudentIds.delete(student.id));
      }

      renderStudentTable();
    }

    // 更新选中数量
    function updateSelectedCount() {
      document.getElementById('selectedCount').textContent = selectedStudentIds.size;
    }

    // 排序
    function sortBy(field) {
      if (sortField === field) {
        sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        sortField = field;
        sortOrder = 'asc';
      }

      filteredStudents.sort((a, b) => {
        let aVal = a[field];
        let bVal = b[field];

        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }

        if (sortOrder === 'asc') {
          return aVal > bVal ? 1 : -1;
        } else {
          return aVal < bVal ? 1 : -1;
        }
      });

      currentStudentPage = 1;
      renderStudentTable();
    }

    // 更新学生分页
    function updateStudentPagination() {
      const totalPages = Math.ceil(filteredStudents.length / studentPageSize);

      document.getElementById('totalStudentCount').textContent = filteredStudents.length;

      document.getElementById('prevStudentPageBtn').disabled = currentStudentPage === 1;
      document.getElementById('nextStudentPageBtn').disabled = currentStudentPage === totalPages;

      const pageNumbers = document.getElementById('studentPageNumbers');
      pageNumbers.innerHTML = '';

      const maxPages = 5;
      let startPage = Math.max(1, currentStudentPage - Math.floor(maxPages / 2));
      let endPage = Math.min(totalPages, startPage + maxPages - 1);

      if (endPage - startPage < maxPages - 1) {
        startPage = Math.max(1, endPage - maxPages + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = `px-3 py-1 rounded text-sm ${i === currentStudentPage ? 'bg-primary-500 text-white' : 'border border-gray-300 text-gray-700 hover:bg-gray-50'}`;
        btn.onclick = () => goToStudentPage(i);
        pageNumbers.appendChild(btn);
      }
    }

    // 学生翻页
    function prevStudentPage() {
      if (currentStudentPage > 1) {
        currentStudentPage--;
        renderStudentTable();
      }
    }

    function nextStudentPage() {
      const totalPages = Math.ceil(filteredStudents.length / studentPageSize);
      if (currentStudentPage < totalPages) {
        currentStudentPage++;
        renderStudentTable();
      }
    }

    function goToStudentPage(page) {
      currentStudentPage = page;
      renderStudentTable();
    }

    // 刷新数据
    function refreshData() {
      loadStudentsData();
      showMessage('数据已刷新', 'success');
    }

    // 导出学生列表
    function exportStudentList() {
      if (filteredStudents.length === 0) {
        showMessage('没有数据可导出', 'error');
        return;
      }

      // 准备CSV数据
      const headers = ['姓名', '用户名', '手机号', '状态', '刷题次数', '完成进度', '正确率', '知识点掌握度', '最后刷题时间'];
      const csvContent = [
        headers.join(','),
        ...filteredStudents.map(student => {
          const statusMap = {
            'not_started': '未开始',
            'in_progress': '进行中',
            'mastered': '已完成'
          };

          let masteryLevel = '-';
          if (student.status !== 'not_started') {
            if (student.masteryRate >= 80) masteryLevel = '掌握';
            else if (student.masteryRate >= 60) masteryLevel = '一般';
            else masteryLevel = '薄弱';
          }

          const lastTime = student.lastPracticeTime
            ? new Date(student.lastPracticeTime).toLocaleString('zh-CN')
            : '-';

          return [
            student.name,
            student.username,
            student.phone,
            statusMap[student.status] || '未开始',
            student.practiceCount,
            `${student.progress}%`,
            `${student.masteryRate}%`,
            masteryLevel,
            lastTime
          ].join(',');
        })
      ].join('\n');

      // 添加BOM以支持Excel正确显示中文
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);

      // 获取当前任务名称作为文件名
      const practiceName = document.getElementById('practiceName').textContent || '刷题任务';
      const timestamp = new Date().toLocaleDateString('zh-CN').replace(/\//g, '-');

      link.setAttribute('href', url);
      link.setAttribute('download', `${practiceName}_学生完成情况_${timestamp}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showMessage(`成功导出 ${filteredStudents.length} 条数据`, 'success');
    }

    // 显示消息
    function showMessage(message, type) {
      const colors = {
        success: 'bg-success-50 text-success-700 border-success-200',
        error: 'bg-error-50 text-error-700 border-error-200',
        info: 'bg-info-50 text-info-700 border-info-200'
      };

      const colorClass = colors[type] || colors.info;

      const toast = document.createElement('div');
      toast.className = `fixed top-20 right-6 ${colorClass} border px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2`;
      toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span class="text-sm font-medium">${message}</span>
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // 窗口大小改变时重新渲染图表
    window.addEventListener('resize', () => {
      if (progressChart) progressChart.resize();
      if (masteryChart) masteryChart.resize();
    });
  </script>
</body>
</html>
