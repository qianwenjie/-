<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>考生管理 - 考试系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#E6F9F0', 100: '#C3F0DB', 200: '#A3E7C7', 500: '#00B96B', 600: '#00A35C', 700: '#008C4F' },
            success: { 50: '#E8FFEA', 100: '#C3F5CD', 200: '#9FE8B3', 500: '#00B42A', 600: '#00A35C', 700: '#008C4F' },
            warning: { 50: '#FFF7E8', 100: '#FFE7BA', 200: '#FFD89B', 500: '#FF7D00', 600: '#F57C00', 700: '#E86F00' },
            error: { 50: '#FFECE8', 100: '#FFD4CC', 200: '#FFBFB3', 500: '#F53F3F', 600: '#E53935', 700: '#CB2634' },
            info: { 50: '#E8F7FF', 100: '#B8E8F5', 200: '#94D4E8', 500: '#14C9C9', 600: '#00ACC1', 700: '#0097A7' },
            purple: { 50: '#F3E8FF', 100: '#E0C5FF', 200: '#D0AEFF', 500: '#9333EA', 600: '#7E22CE', 700: '#6B1BB0' },
            gray: { 50: '#F9FAFB', 100: '#F3F4F6', 200: '#E5E7EB', 300: '#D1D5DB', 400: '#9CA3AF', 500: '#6B7280', 600: '#4B5563', 700: '#374151', 800: '#1F2937', 900: '#111827' }
          }
        }
      }
    }
  </script>
  <style>
    /* 消息提示样式 */
    .message-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    .message {
      min-width: 300px;
      padding: 16px 20px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="messageContainer" class="message-container"></div>

  <!-- 顶部导航 -->
  <header class="h-16 bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
    <div class="flex items-center justify-between h-full px-6">
      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-primary-500 rounded flex items-center justify-center">
            <i class="fas fa-graduation-cap text-white"></i>
          </div>
          <span class="text-xl font-semibold text-gray-900">考试系统</span>
        </div>
        <nav class="flex items-center space-x-2 text-sm text-gray-600">
          <a href="../dashboard.html" class="hover:text-primary-500">首页</a>
          <i class="fas fa-chevron-right text-xs text-gray-400"></i>
          <a href="list.html" class="hover:text-primary-500">刷题管理</a>
          <i class="fas fa-chevron-right text-xs text-gray-400"></i>
          <span class="text-gray-900 font-medium">考生管理</span>
        </nav>
      </div>
      <div class="flex items-center space-x-3">
        <img src="https://via.placeholder.com/32" alt="头像" class="w-8 h-8 rounded-full">
        <span class="text-sm text-gray-700">管理员</span>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="fixed top-16 left-0 right-0 bottom-0 flex flex-col">
    <!-- 头部信息区域 -->
    <div class="flex-none bg-white border-b border-gray-200 px-6 py-3">
      <div class="flex items-center justify-between mb-3">
        <!-- 左侧：刷题任务基本信息 -->
        <div class="flex items-center gap-4">
          <a href="list.html" class="text-gray-500 hover:text-gray-700 transition-colors">
            <i class="fas fa-arrow-left text-lg"></i>
          </a>
          <div class="flex items-center gap-3">
            <h1 class="text-base font-semibold text-gray-900" id="practiceName">刷题任务</h1>
            <span class="px-2 py-0.5 rounded text-xs font-medium" id="questionModeBadge">-</span>
            <span class="text-xs text-gray-500">|</span>
            <span class="text-xs text-gray-600"><i class="fas fa-hashtag mr-1"></i><span id="practiceCode">-</span></span>
            <span class="text-xs text-gray-600"><i class="fas fa-calendar mr-1"></i><span id="practiceTime">-</span></span>
            <span class="px-2 py-0.5 rounded text-xs font-medium" id="practiceStatusBadge">-</span>
          </div>
        </div>

        <!-- 右侧：统计数据 -->
        <div class="flex items-center gap-6 text-xs">
          <div class="flex items-center gap-1.5">
            <span class="text-gray-500">总考生数</span>
            <span class="text-lg font-bold text-primary-600" id="totalStudents">0</span>
          </div>
          <div class="flex items-center gap-1.5">
            <span class="text-gray-500">已完成</span>
            <span class="text-lg font-bold text-success-600" id="completedCount">0</span>
          </div>
          <div class="flex items-center gap-1.5">
            <span class="text-gray-500">进行中</span>
            <span class="text-lg font-bold text-info-600" id="inProgressCount">0</span>
          </div>
        </div>
      </div>

      <!-- 筛选和操作区域 -->
      <div class="flex items-center justify-between gap-3 pt-3 border-t border-gray-100">
        <!-- 左侧筛选 -->
        <div class="flex items-center gap-2">
          <input type="text" id="searchInput" placeholder="搜索姓名、用户名、手机号..." class="w-56 px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500" onkeyup="handleSearch(event)">
          <select id="filterStatus" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500" onchange="filterStudents()">
            <option value="">全部状态</option>
            <option value="未开始">未开始</option>
            <option value="进行中">进行中</option>
            <option value="已完成">已完成</option>
          </select>
          <select id="filterMastery" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500" onchange="filterStudents()">
            <option value="">全部掌握度</option>
            <option value="掌握">掌握</option>
            <option value="一般">一般</option>
            <option value="薄弱">薄弱</option>
          </select>
          <button onclick="filterStudents()" class="px-4 py-1.5 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium">
            <i class="fas fa-search mr-2"></i>筛选
          </button>
          <button onclick="resetFilter()" class="px-4 py-1.5 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg text-sm font-medium">
            <i class="fas fa-redo mr-2"></i>重置
          </button>
        </div>
        <!-- 右侧操作 -->
        <div class="flex items-center gap-2">
          <button onclick="openAddStudentModal()" class="px-4 py-1.5 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium">
            <i class="fas fa-user-plus mr-2"></i>添加考生
          </button>
          <button onclick="openImportModal()" class="px-4 py-1.5 bg-info-500 hover:bg-info-600 text-white rounded-lg text-sm font-medium">
            <i class="fas fa-file-import mr-2"></i>批量导入
          </button>
          <button onclick="batchDeleteStudents()" class="px-4 py-1.5 border border-error-500 text-error-500 hover:bg-error-50 rounded-lg text-sm font-medium" id="batchDeleteBtn" disabled>
            <i class="fas fa-trash mr-2"></i>批量删除
          </button>
        </div>
      </div>
    </div>

    <!-- 表格容器（可滚动） -->
    <div class="flex-1 px-6 min-h-0 flex flex-col">
      <div class="flex-1 bg-white rounded-lg border border-gray-200 overflow-x-auto">
        <table class="w-full min-w-max">
          <thead class="bg-gray-50 border-b border-gray-200 sticky top-0 z-10">
            <tr>
              <th class="px-2 py-2.5 text-left whitespace-nowrap">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)">
              </th>
              <th class="px-2 py-2.5 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap">状态</th>
              <th class="px-2 py-2.5 text-center text-xs font-medium text-gray-500 uppercase whitespace-nowrap">照片</th>
              <th class="px-2 py-2.5 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 100px;">用户名</th>
              <th class="px-2 py-2.5 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 80px;">姓名</th>
              <th class="px-2 py-2.5 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" style="min-width: 110px;">手机号</th>
              <th class="px-2 py-2.5 text-center text-xs font-medium text-gray-500 uppercase whitespace-nowrap">刷题次数</th>
              <th class="px-2 py-2.5 text-center text-xs font-medium text-gray-500 uppercase whitespace-nowrap">正确率</th>
              <th class="px-2 py-2.5 text-center text-xs font-medium text-gray-500 uppercase whitespace-nowrap">知识点掌握度</th>
              <th class="px-2 py-2.5 text-center text-xs font-medium text-gray-500 uppercase whitespace-nowrap">操作</th>
            </tr>
          </thead>
          <tbody id="studentList" class="divide-y divide-gray-200">
            <!-- 数据动态填充 -->
          </tbody>
        </table>

        <!-- 空状态 -->
        <div id="emptyState" class="hidden py-16 text-center">
          <i class="fas fa-user-friends text-4xl text-gray-300 mb-4"></i>
          <p class="text-gray-500 mb-4">暂无考生数据</p>
          <button onclick="openAddStudentModal()" class="inline-block px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium">
            <i class="fas fa-user-plus mr-2"></i>添加第一位考生
          </button>
        </div>
      </div>
    </div>

    <!-- 悬浮分页 -->
    <div class="flex-none bg-white border-t border-gray-200 shadow-lg">
      <div class="flex items-center justify-between px-6 py-3">
        <p class="text-sm text-gray-600">显示 <span id="pageStart">1</span>-<span id="pageEnd">20</span> 条，共 <span id="totalItems">0</span> 条</p>
        <div class="flex items-center space-x-2">
          <button onclick="firstPage()" class="w-9 h-9 border border-gray-300 rounded text-sm text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" id="firstBtn" disabled>
            <i class="fas fa-angle-double-left"></i>
          </button>
          <button onclick="prevPage()" class="px-3 h-9 border border-gray-300 rounded text-sm text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" id="prevBtn" disabled>
            <i class="fas fa-chevron-left mr-1"></i>上一页
          </button>
          <div id="pageNumbers" class="flex items-center space-x-2"></div>
          <button onclick="nextPage()" class="px-3 h-9 border border-gray-300 rounded text-sm text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" id="nextBtn">
            下一页<i class="fas fa-chevron-right ml-1"></i>
          </button>
          <button onclick="lastPage()" class="w-9 h-9 border border-gray-300 rounded text-sm text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" id="lastBtn">
            <i class="fas fa-angle-double-right"></i>
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- 添加考生模态框 -->
  <div id="addStudentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">添加考生</h2>
        <button onclick="closeAddStudentModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="px-6 py-6">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">用户名 <span class="text-error-500">*</span></label>
            <input type="text" id="addUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="请输入用户名">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">考生姓名 <span class="text-error-500">*</span></label>
            <input type="text" id="addName" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="请输入考生姓名">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">手机号</label>
            <input type="tel" id="addPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="请输入手机号（选填）">
          </div>
        </div>
      </div>
      <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
        <button onclick="closeAddStudentModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium">取消</button>
        <button onclick="confirmAddStudent()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium">
          <i class="fas fa-check mr-2"></i>确认添加
        </button>
      </div>
    </div>
  </div>

  <!-- 批量导入模态框 -->
  <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">批量导入考生</h2>
        <button onclick="closeImportModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="flex-1 overflow-auto px-6 py-4">
        <div class="mb-4">
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary-500 transition-colors">
            <input type="file" id="importFile" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleFileSelect(event)">
            <label for="importFile" class="cursor-pointer">
              <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
              <p class="text-sm text-gray-600">点击上传或拖拽文件到此处</p>
              <p class="text-xs text-gray-400 mt-1">支持 .xlsx、.xls、.csv 格式</p>
            </label>
          </div>
        </div>
        <div class="bg-info-50 border border-info-200 rounded-lg p-4">
          <div class="flex items-start">
            <i class="fas fa-info-circle text-info-500 mt-0.5 mr-2"></i>
            <div class="flex-1 text-sm text-info-700">
              <p class="font-medium mb-1">导入说明：</p>
              <ul class="list-disc list-inside space-y-1 text-xs">
                <li>Excel 表格需包含：<strong>用户名</strong>（必填）、<strong>考生姓名</strong>（必填）、手机号（选填）</li>
                <li>第一行为表头，从第二行开始为数据</li>
                <li>用户名重复的数据将被跳过</li>
              </ul>
              <button onclick="downloadTemplate()" class="mt-2 text-info-600 hover:text-info-700 font-medium flex items-center gap-1">
                <i class="fas fa-download"></i>下载导入模板
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
        <button onclick="closeImportModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium">取消</button>
        <button id="confirmImportBtn" onclick="confirmImport()" disabled class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="fas fa-file-import mr-2"></i>确认导入
        </button>
      </div>
    </div>
  </div>

  <!-- 删除确认模态框 -->
  <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-error-50 rounded-lg flex items-center justify-center">
            <i class="fas fa-exclamation-triangle text-error-500 text-lg"></i>
          </div>
          <h2 class="text-lg font-semibold text-gray-900">确认删除</h2>
        </div>
      </div>
      <div class="px-6 py-6">
        <p class="text-gray-700 text-sm" id="deleteMessage">确定要删除吗？</p>
        <p class="text-error-600 text-sm mt-2">
          <i class="fas fa-info-circle mr-1"></i>删除后将无法恢复！
        </p>
      </div>
      <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
        <button onclick="closeDeleteConfirmModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium">取消</button>
        <button onclick="confirmDelete()" class="px-4 py-2 bg-error-500 hover:bg-error-600 text-white rounded-lg text-sm font-medium">
          <i class="fas fa-trash mr-2"></i>确认删除
        </button>
      </div>
    </div>
  </div>

  <script>
    // 从URL获取刷题任务ID
    const urlParams = new URLSearchParams(window.location.search);
    const practiceId = urlParams.get('id');

    // 考生数据
    let students = [];
    let filteredStudents = [];
    let currentPage = 1;
    const pageSize = 20;
    let selectedStudentIds = [];
    let deleteTarget = null;
    let currentPractice = null;

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
      loadPracticeData();
      loadStudentsData();
    });

    // 加载刷题任务数据
    function loadPracticeData() {
      const practices = JSON.parse(localStorage.getItem('practices') || '[]');
      currentPractice = practices.find(p => p.id === practiceId);

      if (!currentPractice) {
        showMessage('刷题任务不存在，即将返回列表', 'error');
        setTimeout(() => {
          window.location.href = 'list.html';
        }, 2000);
        return;
      }

      // 填充刷题任务信息
      document.getElementById('practiceName').textContent = currentPractice.name;
      document.getElementById('practiceCode').textContent = currentPractice.code;
      document.getElementById('practiceTime').textContent = `${currentPractice.startTime} ~ ${currentPractice.endTime || '不限'}`;

      // 抽题方式徽章
      const questionMode = currentPractice.questionMode || 'fixed';
      const modeBadge = document.getElementById('questionModeBadge');
      if (questionMode === 'fixed') {
        modeBadge.textContent = '固定抽题';
        modeBadge.className = 'px-2 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-700';
      } else {
        modeBadge.textContent = '随机抽题';
        modeBadge.className = 'px-2 py-0.5 rounded text-xs font-medium bg-purple-50 text-purple-700';
      }

      // 状态徽章（使用数据中的status字段）
      const statusMap = {
        'not_started': { text: '未开始', class: 'bg-warning-500 text-white' },
        'ongoing': { text: '进行中', class: 'bg-success-500 text-white' },
        'ended': { text: '已结束', class: 'bg-gray-500 text-white' }
      };

      const status = statusMap[currentPractice.status] || statusMap['not_started'];
      const badge = document.getElementById('practiceStatusBadge');
      badge.textContent = status.text;
      badge.className = `px-2 py-0.5 rounded text-xs font-medium ${status.class}`;
    }

    // 加载考生数据
    function loadStudentsData() {
      const stored = localStorage.getItem('practiceStudents');
      if (stored) {
        students = JSON.parse(stored);
      } else {
        generateMockData();
      }

      filteredStudents = [...students];
      updateStatistics();
      renderList();
    }

    // 生成模拟数据
    function generateMockData() {
      const surnames = ['张', '李', '王', '刘', '陈', '杨', '赵', '黄', '周', '吴'];
      const names = ['明', '华', '伟', '芳', '静', '阳', '丽', '敏', '杰', '刚'];

      students = [];
      for (let i = 0; i < 30; i++) {
        // 调整状态分布：40%进行中，30%已完成，30%未开始
        // 这样当任务结束时间过期后，会有更多逾期未完成的学生
        let status;
        const rand = Math.random();
        if (rand < 0.4) {
          status = '进行中';  // 40%
        } else if (rand < 0.7) {
          status = '已完成';  // 30%
        } else {
          status = '未开始';  // 30%
        }

        const practiceCount = status === '未开始' ? 0 : (status === '进行中' ? Math.floor(Math.random() * 10) + 1 : Math.floor(Math.random() * 20) + 10);
        const accuracy = status === '未开始' ? 0 : (status === '进行中' ? Math.floor(Math.random() * 40) + 40 : Math.floor(Math.random() * 30) + 60);

        students.push({
          id: 'S' + Date.now() + '_' + i,
          username: 'student' + String(i + 1).padStart(3, '0'),
          name: surnames[Math.floor(Math.random() * surnames.length)] + names[Math.floor(Math.random() * names.length)],
          phone: i % 3 === 0 ? '' : '138' + String(Math.floor(Math.random() * 100000000)).padStart(8, '0'),
          photo: `https://i.pravatar.cc/150?u=student${i}`,
          status: status,
          practiceCount: practiceCount,
          accuracy: accuracy
        });
      }

      localStorage.setItem('practiceStudents', JSON.stringify(students));
    }

    // 更新统计数据
    function updateStatistics() {
      document.getElementById('totalStudents').textContent = students.length;
      document.getElementById('completedCount').textContent = students.filter(s => s.status === '已完成').length;
      document.getElementById('inProgressCount').textContent = students.filter(s => s.status === '进行中').length;
    }

    // 渲染列表
    function renderList() {
      const container = document.getElementById('studentList');
      const emptyState = document.getElementById('emptyState');

      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageData = filteredStudents.slice(start, end);

      if (filteredStudents.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
      } else {
        emptyState.classList.add('hidden');
        container.innerHTML = pageData.map(s => createStudentRow(s)).join('');
      }

      updatePagination();
      document.getElementById('totalItems').textContent = filteredStudents.length;
      updateBatchDeleteButton();
    }

    // 创建考生行
    function createStudentRow(student) {
      // 判断是否逾期未完成
      let displayStatus = student.status;
      if (currentPractice.endTime && student.status === '进行中') {
        const now = new Date();
        const endTime = new Date(currentPractice.endTime);
        if (now > endTime) {
          displayStatus = '逾期未完成';
        }
      }

      const statusMap = {
        '未开始': { text: '未开始', class: 'bg-gray-100 text-gray-600' },
        '进行中': { text: '进行中', class: 'bg-info-100 text-info-600' },
        '已完成': { text: '已完成', class: 'bg-success-100 text-success-600' },
        '逾期未完成': { text: '逾期未完成', class: 'bg-error-100 text-error-600' }
      };

      const status = statusMap[displayStatus] || statusMap['未开始'];
      const isChecked = selectedStudentIds.includes(student.id);
      const photoUrl = student.photo || 'https://via.placeholder.com/40';

      // 知识点掌握度（图标+文字徽章）
      let masteryHtml = '<span class="text-gray-400 text-xs">-</span>';
      if (student.accuracy > 0) {
        let masteryLevel, masteryClass, masteryIcon;
        if (student.accuracy >= 80) {
          masteryLevel = '掌握';
          masteryClass = 'bg-success-50 text-success-700 border border-success-200';
          masteryIcon = 'fa-solid fa-medal';  // 奖牌图标
        } else if (student.accuracy >= 60) {
          masteryLevel = '一般';
          masteryClass = 'bg-warning-50 text-warning-700 border border-warning-200';
          masteryIcon = 'fa-solid fa-circle-half-stroke';  // 半圆图标
        } else {
          masteryLevel = '薄弱';
          masteryClass = 'bg-error-50 text-error-700 border border-error-200';
          masteryIcon = 'fa-solid fa-triangle-exclamation';  // 警告图标
        }
        masteryHtml = `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium ${masteryClass}">
          <i class="${masteryIcon} text-xs"></i>
          <span>${masteryLevel}</span>
        </span>`;
      }

      return `
        <tr class="hover:bg-gray-50">
          <td class="px-2 py-2.5 whitespace-nowrap">
            <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleSelectStudent('${student.id}', this.checked)">
          </td>
          <td class="px-2 py-2.5 whitespace-nowrap">
            <span class="px-2 py-1 rounded text-xs font-medium ${status.class}">${status.text}</span>
          </td>
          <td class="px-2 py-2.5 text-center whitespace-nowrap">
            <img src="${photoUrl}" alt="照片" class="w-10 h-10 rounded-full object-cover mx-auto border border-gray-200">
          </td>
          <td class="px-2 py-2.5 text-sm text-gray-900 whitespace-nowrap">${student.username}</td>
          <td class="px-2 py-2.5 text-sm font-medium text-gray-900 whitespace-nowrap">${student.name}</td>
          <td class="px-2 py-2.5 text-sm text-gray-600 whitespace-nowrap">${student.phone || '-'}</td>
          <td class="px-2 py-2.5 text-center text-sm text-gray-900 whitespace-nowrap">${student.practiceCount}</td>
          <td class="px-2 py-2.5 text-center whitespace-nowrap">
            ${student.accuracy > 0
              ? `<span class="text-sm font-semibold ${student.accuracy >= 60 ? 'text-success-600' : 'text-error-600'}">${student.accuracy}%</span>`
              : '<span class="text-sm text-gray-400">-</span>'
            }
          </td>
          <td class="px-2 py-2.5 text-center whitespace-nowrap">${masteryHtml}</td>
          <td class="px-2 py-2.5 text-center whitespace-nowrap">
            <div class="flex items-center justify-center gap-1.5">
              <button onclick="deleteStudent('${student.id}')" class="text-error-600 hover:text-error-700 text-sm" title="删除">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    }

    // 分页相关
    function updatePagination() {
      const totalPages = Math.ceil(filteredStudents.length / pageSize) || 1;
      const start = (currentPage - 1) * pageSize + 1;
      const end = Math.min(currentPage * pageSize, filteredStudents.length);

      document.getElementById('pageStart').textContent = filteredStudents.length > 0 ? start : 0;
      document.getElementById('pageEnd').textContent = end;

      document.getElementById('firstBtn').disabled = currentPage === 1;
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage === totalPages;
      document.getElementById('lastBtn').disabled = currentPage === totalPages;

      renderPageNumbers(totalPages);
    }

    function renderPageNumbers(totalPages) {
      const container = document.getElementById('pageNumbers');
      container.innerHTML = '';

      let startPage = 1, endPage = totalPages;
      if (totalPages > 5) {
        if (currentPage <= 3) {
          startPage = 1;
          endPage = 5;
        } else if (currentPage >= totalPages - 2) {
          startPage = totalPages - 4;
          endPage = totalPages;
        } else {
          startPage = currentPage - 2;
          endPage = currentPage + 2;
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        const button = document.createElement('button');
        button.className = `w-9 h-9 rounded text-sm font-medium ${
          i === currentPage ? 'bg-primary-500 text-white' : 'border border-gray-300 text-gray-600 hover:bg-gray-50'
        }`;
        button.textContent = i;
        button.onclick = () => goToPage(i);
        container.appendChild(button);
      }
    }

    function goToPage(page) {
      const totalPages = Math.ceil(filteredStudents.length / pageSize);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderList();
      }
    }

    function firstPage() {
      if (currentPage > 1) {
        currentPage = 1;
        renderList();
      }
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderList();
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(filteredStudents.length / pageSize);
      if (currentPage < totalPages) {
        currentPage++;
        renderList();
      }
    }

    function lastPage() {
      const totalPages = Math.ceil(filteredStudents.length / pageSize);
      if (currentPage < totalPages) {
        currentPage = totalPages;
        renderList();
      }
    }

    // 筛选功能
    function handleSearch(event) {
      if (event && event.key && event.key !== 'Enter') return;
      filterStudents();
    }

    function filterStudents() {
      const searchText = document.getElementById('searchInput').value.toLowerCase();
      const status = document.getElementById('filterStatus').value;
      const mastery = document.getElementById('filterMastery').value;

      filteredStudents = students.filter(student => {
        const matchSearch = !searchText ||
          student.name.toLowerCase().includes(searchText) ||
          student.username.toLowerCase().includes(searchText) ||
          student.phone.includes(searchText);

        const matchStatus = !status || student.status === status;

        // 掌握度匹配
        let matchMastery = true;
        if (mastery) {
          const studentMastery = student.accuracy >= 80 ? '掌握' : student.accuracy >= 60 ? '一般' : student.accuracy > 0 ? '薄弱' : '';
          matchMastery = studentMastery === mastery;
        }

        return matchSearch && matchStatus && matchMastery;
      });

      currentPage = 1;
      renderList();
    }

    function resetFilter() {
      document.getElementById('searchInput').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterMastery').value = '';
      filteredStudents = [...students];
      currentPage = 1;
      renderList();
    }

    // 选择功能
    function toggleSelectAll(checked) {
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageData = filteredStudents.slice(start, end);

      if (checked) {
        pageData.forEach(student => {
          if (!selectedStudentIds.includes(student.id)) {
            selectedStudentIds.push(student.id);
          }
        });
      } else {
        pageData.forEach(student => {
          selectedStudentIds = selectedStudentIds.filter(id => id !== student.id);
        });
      }

      renderList();
    }

    function toggleSelectStudent(id, checked) {
      if (checked) {
        if (!selectedStudentIds.includes(id)) {
          selectedStudentIds.push(id);
        }
      } else {
        selectedStudentIds = selectedStudentIds.filter(sid => sid !== id);
      }

      updateBatchDeleteButton();
      updateSelectAllCheckbox();
    }

    function updateSelectAllCheckbox() {
      const selectAllCheckbox = document.getElementById('selectAll');
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageData = filteredStudents.slice(start, end);
      const allIds = pageData.map(s => s.id);
      selectAllCheckbox.checked = allIds.length > 0 && allIds.every(id => selectedStudentIds.includes(id));
    }

    function updateBatchDeleteButton() {
      const btn = document.getElementById('batchDeleteBtn');
      btn.disabled = selectedStudentIds.length === 0;
    }

    // 添加考生
    function openAddStudentModal() {
      document.getElementById('addUsername').value = '';
      document.getElementById('addName').value = '';
      document.getElementById('addPhone').value = '';
      document.getElementById('addStudentModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeAddStudentModal() {
      document.getElementById('addStudentModal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    function confirmAddStudent() {
      const username = document.getElementById('addUsername').value.trim();
      const name = document.getElementById('addName').value.trim();
      const phone = document.getElementById('addPhone').value.trim();

      if (!username) {
        showMessage('请输入用户名', 'warning');
        return;
      }
      if (!name) {
        showMessage('请输入考生姓名', 'warning');
        return;
      }
      if (phone && !/^1[3-9]\d{9}$/.test(phone)) {
        showMessage('手机号格式不正确', 'warning');
        return;
      }

      if (students.some(s => s.username === username)) {
        showMessage('该用户名已存在', 'warning');
        return;
      }

      students.unshift({
        id: 'S' + Date.now(),
        username: username,
        name: name,
        phone: phone,
        photo: 'https://i.pravatar.cc/150?img=' + (Math.floor(Math.random() * 70) + 1),
        status: '未开始',
        practiceCount: 0,
        accuracy: 0
      });

      saveStudentsData();
      filteredStudents = [...students];
      currentPage = 1;
      updateStatistics();
      renderList();
      closeAddStudentModal();
      showMessage('添加成功', 'success');
    }

    // 批量导入
    function openImportModal() {
      document.getElementById('importModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeImportModal() {
      document.getElementById('importModal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        document.getElementById('confirmImportBtn').disabled = false;
      }
    }

    function downloadTemplate() {
      const template = [
        ['用户名', '考生姓名', '手机号'],
        ['student001', '张三', '13800138001'],
        ['student002', '李四', '13800138002']
      ];

      const csvContent = template.map(row => row.join(',')).join('\n');
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = '考生批量导入模板.csv';
      link.click();

      showMessage('模板下载成功', 'success');
    }

    function confirmImport() {
      showMessage('导入功能开发中', 'info');
      closeImportModal();
    }

    // 删除功能
    function deleteStudent(id) {
      const student = students.find(s => s.id === id);
      if (!student) return;

      deleteTarget = { type: 'single', id: id };
      document.getElementById('deleteMessage').textContent = `确定要删除考生"${student.name}"吗？`;
      document.getElementById('deleteConfirmModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function batchDeleteStudents() {
      if (selectedStudentIds.length === 0) return;

      deleteTarget = { type: 'batch', ids: [...selectedStudentIds] };
      document.getElementById('deleteMessage').textContent = `确定要删除选中的 ${selectedStudentIds.length} 名考生吗？`;
      document.getElementById('deleteConfirmModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeDeleteConfirmModal() {
      document.getElementById('deleteConfirmModal').classList.add('hidden');
      document.body.style.overflow = '';
      deleteTarget = null;
    }

    function confirmDelete() {
      if (!deleteTarget) return;

      if (deleteTarget.type === 'single') {
        students = students.filter(s => s.id !== deleteTarget.id);
        showMessage('删除成功', 'success');
      } else if (deleteTarget.type === 'batch') {
        students = students.filter(s => !deleteTarget.ids.includes(s.id));
        selectedStudentIds = [];
        showMessage(`成功删除 ${deleteTarget.ids.length} 名考生`, 'success');
      }

      saveStudentsData();
      filteredStudents = [...students];
      updateStatistics();
      renderList();
      closeDeleteConfirmModal();
    }

    // 查看考生
    // 保存数据
    function saveStudentsData() {
      localStorage.setItem('practiceStudents', JSON.stringify(students));
    }

    // 消息提示
    function showMessage(message, type = 'info') {
      const container = document.getElementById('messageContainer');
      const colors = {
        success: 'bg-success-50 text-success-700 border-success-200',
        error: 'bg-error-50 text-error-700 border-error-200',
        warning: 'bg-warning-50 text-warning-700 border-warning-200',
        info: 'bg-info-50 text-info-700 border-info-200'
      };

      const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
      };

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${colors[type]} border`;
      messageDiv.innerHTML = `
        <i class="fas ${icons[type]} mr-3"></i>
        <span>${message}</span>
      `;

      container.appendChild(messageDiv);

      setTimeout(() => {
        messageDiv.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => messageDiv.remove(), 300);
      }, 3000);
    }

    // 点击遮罩层关闭模态框
    document.addEventListener('click', function(e) {
      const modals = ['addStudentModal', 'importModal', 'deleteConfirmModal'];
      modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (e.target === modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      });
    });
  </script>
</body>
</html>
