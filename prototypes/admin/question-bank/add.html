<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新增题目 - 考试系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#E6F9F0', 500: '#00B96B', 600: '#00A35C' },
            success: { 50: '#E8FFEA', 500: '#00B42A' },
            warning: { 50: '#FFF7E8', 500: '#FF7D00' },
            error: { 50: '#FFECE8', 500: '#F53F3F' },
            info: { 50: '#E8F7FF', 500: '#14C9C9' },
            indigo: { 50: '#E8E7FF', 500: '#6366F1' },
            purple: { 50: '#FAF5FF', 500: '#A855F7' }
          }
        }
      }
    }
  </script>
  <style>
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    .question-type-item {
      transition: all 0.2s ease;
    }

    .question-type-item input[type="radio"]:checked + label {
      background-color: #E6F9F0;
      color: #00B96B;
      border-left: 3px solid #00B96B;
    }

    .question-type-item:hover label {
      background-color: #F9FAFB;
    }

    .editor-toolbar {
      border: 1px solid #e5e7eb;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      background: #fff;
      padding: 8px 12px;
    }

    .editor-content {
      border: 1px solid #e5e7eb;
      border-radius: 0 0 8px 8px;
      min-height: 150px;
      padding: 12px;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
    }

    .editor-content:focus {
      outline: none;
      border-color: #00B96B;
    }

    .option-item {
      transition: all 0.2s ease;
    }

    .option-item:hover {
      background-color: #F9FAFB;
    }

    .simple-input {
      display: block;
    }

    .rich-editor {
      display: none;
    }

    .option-item.rich-mode .simple-input {
      display: none;
    }

    .option-item.rich-mode .rich-editor {
      display: block;
    }
  </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">
  <!-- 顶部导航栏 -->
  <header class="h-16 bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
    <div class="flex items-center justify-between h-full px-6">
      <div class="flex items-center space-x-4">
        <div class="w-8 h-8 bg-primary-500 rounded flex items-center justify-center">
          <i class="fas fa-graduation-cap text-white"></i>
        </div>
        <div class="flex items-center">
          <span class="text-xl font-semibold text-gray-900">考试系统</span>
          <span class="text-sm text-gray-500 mx-2">/</span>
          <a href="list.html" class="text-sm text-gray-500 hover:text-primary-500 transition-colors">题库管理</a>
          <span class="text-sm text-gray-500 mx-2">/</span>
          <span class="text-sm text-gray-900 font-medium">新增题目</span>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <button class="text-gray-600 hover:text-gray-900">
          <i class="fas fa-bell"></i>
        </button>
        <div class="flex items-center space-x-2">
          <img src="https://via.placeholder.com/32" alt="用户头像" class="w-8 h-8 rounded-full">
          <span class="text-sm text-gray-700">管理员</span>
        </div>
      </div>
    </div>
  </header>

  <!-- 主要内容区域 -->
  <main class="pt-16 h-screen flex">
    <!-- 左侧题型列表 -->
    <aside class="w-64 bg-white border-r border-gray-200 overflow-y-auto custom-scrollbar">
      <div class="p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">试题题型</h2>

        <div class="space-y-1">
          <!-- 基础题型 -->
          <div class="mb-4">
            <div class="text-xs font-medium text-gray-500 mb-2 px-3">基础题型</div>
            <div id="basicQuestionTypes">
              <!-- 基础题型将通过 JavaScript 动态生成 -->
            </div>
          </div>

          <!-- 复合题型 -->
          <div>
            <div class="text-xs font-medium text-gray-500 mb-2 px-3">复合题型</div>
            <div id="compositeQuestionTypes">
              <!-- 复合题型将通过 JavaScript 动态生成 -->
            </div>
          </div>

          <!-- 自定义题型 -->
          <div id="customQuestionTypesSection" class="hidden border-t border-gray-200 pt-4 mt-4">
            <div class="text-xs font-medium text-gray-500 mb-2 px-3">自定义题型</div>
            <div id="customQuestionTypes">
              <!-- 自定义题型将通过 JavaScript 动态生成 -->
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- 右侧内容区域 -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- 头部操作栏 -->
      <div class="bg-white border-b border-gray-200 px-6 py-4">
        <div class="flex items-center justify-between">
          <h1 class="text-xl font-semibold text-gray-900">新增试题</h1>
          <div class="flex items-center space-x-3">
            <button onclick="goBack()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
              取消
            </button>
            <button onclick="saveQuestion()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium shadow-sm">
              <i class="fas fa-check mr-2"></i>保存题目
            </button>
          </div>
        </div>
      </div>

      <!-- 表单内容区域 -->
      <div class="flex-1 overflow-y-auto custom-scrollbar bg-gray-50">
        <form id="questionForm" class="max-w-5xl mx-auto p-6 space-y-6">
          <!-- 基本信息 -->
          <div id="basicInfo" class="hidden">
            <div class="flex items-center space-x-4 mb-4">
              <!-- 难度选择 -->
              <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700">难度：</label>
                <select id="difficulty" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                  <option value="">请选择</option>
                  <option value="1">一级</option>
                  <option value="2">二级</option>
                  <option value="3">三级</option>
                  <option value="4">四级</option>
                  <option value="5">五级</option>
                </select>
              </div>

              <!-- 知识点选择 -->
              <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700">知识点：</label>
                <select id="knowledgePoint" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                  <option value="">请选择</option>
                  <optgroup label="计算机基础">
                    <option value="11">计算机系统</option>
                    <option value="12">操作系统</option>
                    <option value="13">数据结构</option>
                  </optgroup>
                  <optgroup label="编程语言">
                    <option value="21">Python基础</option>
                    <option value="22">Java基础</option>
                    <option value="23">JavaScript</option>
                  </optgroup>
                  <optgroup label="数据库">
                    <option value="31">SQL语法</option>
                    <option value="32">数据库设计</option>
                  </optgroup>
                  <optgroup label="网络技术">
                    <option value="41">网络协议</option>
                    <option value="42">网络安全</option>
                  </optgroup>
                </select>
              </div>

              <!-- 分值 -->
              <div class="flex items-center space-x-2 ml-auto">
                <label class="text-sm font-medium text-gray-700">分值：</label>
                <input type="number" id="score" min="0" max="100" value="5" class="w-16 px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                <span class="text-sm text-gray-500">分</span>
              </div>
            </div>

            <!-- 题干输入 -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                试题题干 <span class="text-error-500">*</span>
              </label>

              <!-- 富文本编辑器工具栏 -->
              <div class="editor-toolbar flex items-center space-x-1 flex-wrap gap-y-2">
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="粗体">
                  <i class="fas fa-bold"></i>
                </button>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="左对齐">
                  <i class="fas fa-align-left"></i>
                </button>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="居中">
                  <i class="fas fa-align-center"></i>
                </button>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="右对齐">
                  <i class="fas fa-align-right"></i>
                </button>
                <div class="w-px h-6 bg-gray-300"></div>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="斜体">
                  <i class="fas fa-italic"></i>
                </button>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="下划线">
                  <i class="fas fa-underline"></i>
                </button>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="删除线">
                  <i class="fas fa-strikethrough"></i>
                </button>
                <div class="w-px h-6 bg-gray-300"></div>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="无序列表">
                  <i class="fas fa-list-ul"></i>
                </button>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="有序列表">
                  <i class="fas fa-list-ol"></i>
                </button>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="表格">
                  <i class="fas fa-table"></i>
                </button>
                <div class="w-px h-6 bg-gray-300"></div>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="插入链接">
                  <i class="fas fa-link"></i>
                </button>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="插入图片">
                  <i class="fas fa-image"></i>
                </button>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="代码块">
                  <i class="fas fa-code"></i>
                </button>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="上传附件">
                  <i class="fas fa-paperclip"></i>
                </button>
              </div>

              <textarea id="questionContent" class="editor-content w-full" placeholder="请输入题目内容..."></textarea>
            </div>

            <!-- 答案选项区域 -->
            <div id="answersArea">
              <!-- 选择题选项 -->
              <div id="optionsArea" class="hidden">
                <div class="flex items-center justify-between mb-3">
                  <label class="text-sm font-medium text-gray-700">
                    答案选项 <span class="text-error-500">*</span>
                  </label>
                  <button type="button" onclick="addOption()" class="text-sm text-primary-500 hover:text-primary-600">
                    <i class="fas fa-plus-circle mr-1"></i>添加选项
                  </button>
                </div>
                <div id="optionsList" class="space-y-2">
                  <!-- 选项会通过 JavaScript 动态生成 -->
                </div>
              </div>

              <!-- 判断题选项 -->
              <div id="judgeOptions" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                  正确答案 <span class="text-error-500">*</span>
                </label>
                <div class="flex space-x-6">
                  <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="judgeAnswer" value="true" class="w-4 h-4 text-primary-500">
                    <span class="text-sm text-gray-700">正确</span>
                  </label>
                  <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="judgeAnswer" value="false" class="w-4 h-4 text-primary-500">
                    <span class="text-sm text-gray-700">错误</span>
                  </label>
                </div>
              </div>

              <!-- 填空题答案 -->
              <div id="blankAnswers" class="hidden">
                <div class="flex items-center justify-between mb-3">
                  <label class="text-sm font-medium text-gray-700">
                    参考答案 <span class="text-error-500">*</span>
                    <span class="text-xs text-gray-500 ml-2">设置分数后会自动累加到题目总分</span>
                  </label>
                  <button type="button" onclick="addBlank()" class="text-sm text-primary-500 hover:text-primary-600">
                    <i class="fas fa-plus-circle mr-1"></i>添加填空
                  </button>
                </div>
                <div id="blankAnswersList" class="grid grid-cols-4 gap-3">
                  <!-- 填空答案会通过 JavaScript 动态生成 -->
                </div>
              </div>

              <!-- 完形填空答案 -->
              <div id="clozeAnswers" class="hidden">
                <div class="flex items-center justify-between mb-3">
                  <label class="text-sm font-medium text-gray-700">
                    填空选项设置 <span class="text-error-500">*</span>
                  </label>
                  <button type="button" onclick="addClozeItem()" class="text-sm text-primary-500 hover:text-primary-600">
                    <i class="fas fa-plus-circle mr-1"></i>添加填空
                  </button>
                </div>
                <div id="clozeItemsList" class="space-y-4">
                  <!-- 完形填空项会通过 JavaScript 动态生成 -->
                </div>
                <!-- 底部添加按钮 -->
                <div class="mt-4 text-center">
                  <button type="button" onclick="addClozeItem()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium transition-colors">
                    <i class="fas fa-plus-circle mr-2"></i>添加填空
                  </button>
                </div>
              </div>

              <!-- 主观题参考答案 -->
              <div id="subjectiveAnswer" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  参考答案
                </label>
                <textarea id="referenceAnswer" rows="4" placeholder="请输入参考答案..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none"></textarea>
              </div>

              <!-- 复合题型答案 -->
              <div id="compositeAnswers" class="hidden">
                <!-- 子题目标签页导航 -->
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-gray-700">子题目列表</span>
                    <div id="subQuestionTabs" class="flex items-center gap-2 ml-3">
                      <!-- 圆形序号标签会动态生成 -->
                    </div>
                  </div>
                  <button type="button" onclick="addSubQuestion()" class="text-sm text-primary-500 hover:text-primary-600">
                    <i class="fas fa-plus-circle mr-1"></i>添加子题目
                  </button>
                </div>

                <!-- 子题目内容区域 -->
                <div id="subQuestionsContent">
                  <!-- 子题目内容会动态生成 -->
                </div>
              </div>
            </div>

            <!-- 答案解析 - 仅非复合题型显示 -->
            <div id="explanationArea" class="mt-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                答案解析（可选）
              </label>
              <!-- 富文本编辑器工具栏 -->
              <div class="editor-toolbar flex items-center space-x-1 flex-wrap gap-y-2">
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="粗体">
                  <i class="fas fa-bold"></i>
                </button>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="斜体">
                  <i class="fas fa-italic"></i>
                </button>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="下划线">
                  <i class="fas fa-underline"></i>
                </button>
                <div class="w-px h-6 bg-gray-300"></div>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="无序列表">
                  <i class="fas fa-list-ul"></i>
                </button>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="有序列表">
                  <i class="fas fa-list-ol"></i>
                </button>
                <div class="w-px h-6 bg-gray-300"></div>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="插入图片">
                  <i class="fas fa-image"></i>
                </button>
                <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="插入链接">
                  <i class="fas fa-link"></i>
                </button>
              </div>
              <textarea id="explanation" class="editor-content w-full" rows="3" placeholder="请输入答案解析..."></textarea>
            </div>

            <!-- 标签 -->
            <div class="mt-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                标签
              </label>
              <div class="flex items-center space-x-2 mb-2">
                <input type="text" id="tagInput" placeholder="输入标签后按回车添加" onkeypress="handleTagInput(event)" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                <button type="button" onclick="addTag()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm">
                  <i class="fas fa-plus mr-1"></i>添加
                </button>
              </div>
              <div id="tagsList" class="flex flex-wrap gap-2">
                <!-- 标签会通过 JavaScript 动态生成 -->
              </div>
            </div>
          </div>

          <!-- 未选择题型提示 -->
          <div id="emptyState" class="flex flex-col items-center justify-center py-20">
            <i class="fas fa-hand-pointer text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">请从左侧选择一个题型开始创建题目</p>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    // ==================== 全局变量 ====================
    let tags = [];
    let optionCount = 0;
    let blankCount = 0;
    let clozeItemCount = 0;  // 完形填空项计数
    let subQuestionCount = 0;  // 子题目计数
    let currentCompositeType = null;  // 当前选中的复合题型

    // ==================== 工具函数 ====================

    // 格式化本地时间为 YYYY-MM-DD HH:MM:SS 格式
    function formatLocalDateTime(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    // ==================== 页面初始化 ====================

    // 默认题型定义
    const defaultQuestionTypes = [
      { id: 'single', name: '单选题', icon: 'fa-dot-circle', color: 'info', isDefault: true },
      { id: 'multiple', name: '多选题', icon: 'fa-check-double', color: 'success', isDefault: true },
      { id: 'judge', name: '判断题', icon: 'fa-check-circle', color: 'success', isDefault: true },
      { id: 'blank', name: '填空题', icon: 'fa-keyboard', color: 'warning', isDefault: true },
      { id: 'cloze', name: '完形填空', icon: 'fa-layer-group', color: 'indigo', isDefault: true },
      { id: 'shortAnswer', name: '简答题', icon: 'fa-align-left', color: 'teal', isDefault: true },
      {
        id: 'materialAnalysis',
        name: '材料分析',
        icon: 'fa-list-alt',
        color: 'purple',
        isDefault: true,
        isComposite: true,
        hasMaterial: true,
        subTypes: ['single', 'multiple', 'judge', 'blank', 'shortAnswer']  // 子题型：单选、多选、判断、填空、简答
      }
    ];

    // 从 localStorage 加载题型配置
    function loadQuestionTypesConfig() {
      let modifiedDefaultTypes = {};
      let customQuestionTypes = [];

      const saved = localStorage.getItem('questionTypesConfig');
      if (saved) {
        try {
          const config = JSON.parse(saved);
          modifiedDefaultTypes = config.modifiedDefaultTypes || {};
          customQuestionTypes = config.customQuestionTypes || [];
        } catch (e) {
          console.error('加载题型配置失败:', e);
        }
      }

      return { modifiedDefaultTypes, customQuestionTypes };
    }

    // 获取题型（考虑修改后的版本）
    function getQuestionType(type, modifiedDefaultTypes) {
      if (type.isDefault && modifiedDefaultTypes[type.id]) {
        return { ...type, ...modifiedDefaultTypes[type.id] };
      }
      return type;
    }

    // 渲染题型列表
    function renderQuestionTypes() {
      const { modifiedDefaultTypes, customQuestionTypes } = loadQuestionTypesConfig();

      // 渲染基础题型
      const basicContainer = document.getElementById('basicQuestionTypes');
      basicContainer.innerHTML = '';

      defaultQuestionTypes.filter(t => !t.isComposite).forEach(type => {
        const displayType = getQuestionType(type, modifiedDefaultTypes);
        const item = createQuestionTypeItem(displayType);
        basicContainer.appendChild(item);
      });

      // 渲染复合题型（包括默认和自定义）
      const compositeContainer = document.getElementById('compositeQuestionTypes');
      compositeContainer.innerHTML = '';

      // 默认复合题型
      defaultQuestionTypes.filter(t => t.isComposite).forEach(type => {
        const displayType = getQuestionType(type, modifiedDefaultTypes);
        const item = createQuestionTypeItem(displayType);
        compositeContainer.appendChild(item);
      });

      // 自定义复合题型
      if (customQuestionTypes && customQuestionTypes.length > 0) {
        customQuestionTypes.filter(t => t.isComposite).forEach(type => {
          const item = createQuestionTypeItem(type);
          compositeContainer.appendChild(item);
        });

        // 自定义基础题型（如果有的话，渲染到自定义区域）
        const customBasicTypes = customQuestionTypes.filter(t => !t.isComposite);
        if (customBasicTypes.length > 0) {
          const customContainer = document.getElementById('customQuestionTypes');
          const customSection = document.getElementById('customQuestionTypesSection');

          customContainer.innerHTML = '';
          customSection.classList.remove('hidden');

          customBasicTypes.forEach(type => {
            const item = createQuestionTypeItem(type);
            customContainer.appendChild(item);
          });
        }
      }
    }

    // 创建题型选项
    function createQuestionTypeItem(type) {
      const div = document.createElement('div');
      div.className = 'question-type-item';

      const input = document.createElement('input');
      input.type = 'radio';
      input.name = 'questionType';
      input.id = `type-${type.id}`;
      input.value = type.id;
      input.className = 'hidden';
      input.onchange = handleTypeChange;

      const label = document.createElement('label');
      label.htmlFor = `type-${type.id}`;
      label.className = 'flex items-center space-x-3 px-3 py-2.5 rounded-lg text-sm cursor-pointer';

      const icon = document.createElement('i');
      icon.className = `fas ${type.icon} w-4 text-${type.color}-500`;

      const span = document.createElement('span');
      span.textContent = type.name;

      label.appendChild(icon);
      label.appendChild(span);

      div.appendChild(input);
      div.appendChild(label);

      return div;
    }

    // 页面加载时显示空状态并渲染题型
    window.addEventListener('DOMContentLoaded', function() {
      console.log('=== 页面加载开始 ===');
      console.log('defaultQuestionTypes 数组:', defaultQuestionTypes);
      console.log('数组长度:', defaultQuestionTypes.length);

      document.getElementById('emptyState').style.display = 'flex';

      // 渲染题型列表
      console.log('开始渲染题型列表...');
      renderQuestionTypes();
      console.log('题型列表渲染完成');

      // 检查渲染结果
      const basicContainer = document.getElementById('basicQuestionTypes');
      const compositeContainer = document.getElementById('compositeQuestionTypes');
      console.log('基础题型容器子元素数量:', basicContainer ? basicContainer.children.length : 'null');
      console.log('复合题型容器子元素数量:', compositeContainer ? compositeContainer.children.length : 'null');
      console.log('=== 页面加载完成 ===');
    });

    // ==================== 题型切换 ====================
    function handleTypeChange() {
      const typeInputs = document.querySelectorAll('input[name="questionType"]');
      let selectedType = '';

      typeInputs.forEach(input => {
        if (input.checked) {
          selectedType = input.value;
        }
      });

      if (!selectedType) return;

      // 显示基本信息区域，隐藏空状态
      document.getElementById('basicInfo').classList.remove('hidden');
      document.getElementById('emptyState').style.display = 'none';

      // 隐藏所有答案区域
      document.getElementById('optionsArea').classList.add('hidden');
      document.getElementById('judgeOptions').classList.add('hidden');
      document.getElementById('blankAnswers').classList.add('hidden');
      document.getElementById('clozeAnswers').classList.add('hidden');
      document.getElementById('subjectiveAnswer').classList.add('hidden');
      document.getElementById('compositeAnswers').classList.add('hidden');

      // 检查是否为复合题型
      const { modifiedDefaultTypes, customQuestionTypes } = loadQuestionTypesConfig();
      const allTypes = [...defaultQuestionTypes, ...(customQuestionTypes || [])];
      const typeConfig = allTypes.find(t => t.id === selectedType);
      let displayType = typeConfig;
      if (typeConfig && typeConfig.isDefault && modifiedDefaultTypes[typeConfig.id]) {
        displayType = { ...typeConfig, ...modifiedDefaultTypes[typeConfig.id] };
      }

      // 获取实际的题型类型（自定义题型使用 baseType，默认题型使用 selectedType）
      const actualType = displayType?.baseType || selectedType;

      // 根据题型显示对应区域
      if (displayType && displayType.isComposite) {
        // 复合题型
        currentCompositeType = displayType;
        document.getElementById('compositeAnswers').classList.remove('hidden');
        document.getElementById('explanationArea').classList.add('hidden'); // 隐藏答案解析
        initCompositeAnswers();
      } else if (actualType === 'single' || actualType === 'multiple') {
        document.getElementById('optionsArea').classList.remove('hidden');
        document.getElementById('explanationArea').classList.remove('hidden'); // 显示答案解析
        initOptions(actualType);
      } else if (actualType === 'judge') {
        document.getElementById('judgeOptions').classList.remove('hidden');
        document.getElementById('explanationArea').classList.remove('hidden'); // 显示答案解析
      } else if (actualType === 'blank') {
        document.getElementById('blankAnswers').classList.remove('hidden');
        document.getElementById('explanationArea').classList.remove('hidden'); // 显示答案解析
        initBlanks();
      } else if (actualType === 'cloze') {
        document.getElementById('clozeAnswers').classList.remove('hidden');
        document.getElementById('explanationArea').classList.remove('hidden'); // 显示答案解析
        initClozeItems();
      } else {
        document.getElementById('subjectiveAnswer').classList.remove('hidden');
        document.getElementById('explanationArea').classList.remove('hidden'); // 显示答案解析
      }
    }

    // ==================== 选项管理 ====================
    function initOptions(type) {
      optionCount = 4;
      const optionsList = document.getElementById('optionsList');
      optionsList.innerHTML = '';

      const labels = ['A', 'B', 'C', 'D'];
      const inputType = type === 'single' ? 'radio' : 'checkbox';

      for (let i = 0; i < optionCount; i++) {
        addOptionItem(labels[i], inputType, i);
      }
    }

    function addOptionItem(label, inputType, index) {
      const optionsList = document.getElementById('optionsList');
      const div = document.createElement('div');
      div.className = 'option-item flex items-center space-x-3 p-3 border border-gray-200 rounded-lg';

      div.innerHTML = `
        <input type="${inputType}" name="correctAnswer" value="${label}" class="w-4 h-4 text-primary-500 focus:ring-primary-500" title="设为正确答案">
        <span class="text-sm font-medium text-gray-700 w-16">选项 ${label}</span>
        <div class="flex-1">
          <!-- 纯文本输入 -->
          <input type="text" placeholder="请输入选项内容" class="simple-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">

          <!-- 富文本编辑器 -->
          <div class="rich-editor">
            <div class="editor-toolbar flex items-center space-x-1 mb-1" style="padding: 4px 8px; border-radius: 4px 4px 0 0;">
              <button type="button" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded text-xs" title="粗体">
                <i class="fas fa-bold"></i>
              </button>
              <button type="button" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded text-xs" title="斜体">
                <i class="fas fa-italic"></i>
              </button>
              <button type="button" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded text-xs" title="下划线">
                <i class="fas fa-underline"></i>
              </button>
              <button type="button" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded text-xs" title="插入图片">
                <i class="fas fa-image"></i>
              </button>
            </div>
            <textarea placeholder="请输入选项内容" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-b-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none" style="border-top: none; border-radius: 0 0 4px 4px;"></textarea>
          </div>
        </div>
        <button type="button" onclick="toggleOptionMode(this)" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-primary-500 hover:bg-primary-50 rounded transition-colors" title="切换富文本模式">
          <i class="fas fa-expand-alt"></i>
        </button>
        ${index >= 2 ? `<button type="button" onclick="removeOption(this)" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-error-500 hover:bg-error-50 rounded transition-colors">
          <i class="fas fa-times"></i>
        </button>` : '<div class="w-8"></div>'}
      `;

      optionsList.appendChild(div);
    }

    function toggleOptionMode(btn) {
      const optionItem = btn.closest('.option-item');
      optionItem.classList.toggle('rich-mode');

      const icon = btn.querySelector('i');
      if (optionItem.classList.contains('rich-mode')) {
        icon.className = 'fas fa-compress-alt';
        btn.title = '切换纯文本模式';
      } else {
        icon.className = 'fas fa-expand-alt';
        btn.title = '切换富文本模式';
      }
    }

    function addOption() {
      if (optionCount >= 8) {
        alert('最多支持8个选项');
        return;
      }
      const labels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
      const typeInputs = document.querySelectorAll('input[name="questionType"]');
      let type = 'single';
      typeInputs.forEach(input => {
        if (input.checked) type = input.value;
      });
      const inputType = type === 'single' ? 'radio' : 'checkbox';
      addOptionItem(labels[optionCount], inputType, optionCount);
      optionCount++;
    }

    function removeOption(btn) {
      btn.closest('.option-item').remove();
      optionCount--;
      // 重新编号
      const options = document.querySelectorAll('.option-item');
      const labels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
      options.forEach((opt, index) => {
        opt.querySelector('.font-medium').textContent = `选项 ${labels[index]}`;
        opt.querySelector('input[type="radio"], input[type="checkbox"]').value = labels[index];
      });
    }

    // ==================== 填空题管理 ====================
    function initBlanks() {
      blankCount = 3;
      const blankAnswersList = document.getElementById('blankAnswersList');
      blankAnswersList.innerHTML = '';
      // 默认添加3个填空
      for (let i = 1; i <= 3; i++) {
        addBlankItem(i);
      }
    }

    function addBlankItem(index) {
      const blankAnswersList = document.getElementById('blankAnswersList');
      const div = document.createElement('div');
      div.className = 'border border-gray-200 rounded-lg p-3 bg-gray-50 hover:border-primary-300 transition-colors';
      div.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs font-semibold text-gray-700">第 ${index} 空</span>
          <button type="button" onclick="removeBlank(this)" class="w-5 h-5 flex items-center justify-center text-gray-400 hover:text-error-500 hover:bg-error-50 rounded transition-colors">
            <i class="fas fa-times text-xs"></i>
          </button>
        </div>
        <input type="text" placeholder="答案" class="blank-answer w-full px-2 py-1.5 mb-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent">
        <div class="flex items-center space-x-1">
          <span class="text-xs text-gray-500">分数:</span>
          <input type="number" placeholder="分" min="0" step="0.5" class="blank-score flex-1 px-2 py-1 border border-gray-300 rounded text-xs focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent" oninput="updateTotalScoreFromBlanks()">
        </div>
      `;
      blankAnswersList.appendChild(div);
    }

    function addBlank() {
      if (blankCount >= 20) {
        alert('最多支持20个填空');
        return;
      }
      blankCount++;
      addBlankItem(blankCount);
    }

    function removeBlank(btn) {
      const blanks = document.querySelectorAll('#blankAnswersList > div');
      if (blanks.length <= 1) {
        alert('至少保留一个填空');
        return;
      }

      btn.closest('div').remove();
      blankCount--;

      // 重新编号
      const remainingBlanks = document.querySelectorAll('#blankAnswersList > div');
      remainingBlanks.forEach((blank, index) => {
        blank.querySelector('.font-semibold').textContent = `第 ${index + 1} 空`;
      });

      // 重新计算总分
      updateTotalScoreFromBlanks();
    }

    // 根据填空分数更新题目总分
    function updateTotalScoreFromBlanks() {
      let totalScore = 0;
      const blankScores = document.querySelectorAll('.blank-score');

      blankScores.forEach(input => {
        const score = parseFloat(input.value);
        if (!isNaN(score) && score > 0) {
          totalScore += score;
        }
      });

      // 如果有设置分数，更新题目总分
      const scoreInput = document.getElementById('score');
      if (totalScore > 0) {
        scoreInput.value = totalScore;

        // 添加视觉反馈：高亮显示总分已更新
        scoreInput.classList.add('ring-2', 'ring-primary-500', 'bg-primary-50');
        setTimeout(() => {
          scoreInput.classList.remove('ring-2', 'ring-primary-500', 'bg-primary-50');
        }, 600);
      }
    }

    // ==================== 完形填空管理 ====================
    function initClozeItems() {
      clozeItemCount = 0;
      document.getElementById('clozeItemsList').innerHTML = '';
    }

    function addClozeItem() {
      clozeItemCount++;
      const clozeItemsList = document.getElementById('clozeItemsList');
      const clozeItemDiv = document.createElement('div');
      clozeItemDiv.className = 'cloze-item border border-gray-200 rounded-lg p-4 bg-gray-50';
      clozeItemDiv.dataset.index = clozeItemCount;

      clozeItemDiv.innerHTML = `
        <div class="flex items-start justify-between mb-4">
          <div class="flex items-center space-x-2">
            <button type="button" class="w-8 h-8 flex items-center justify-center bg-primary-500 hover:bg-primary-600 text-white rounded text-sm font-medium">
              ${clozeItemCount}
            </button>
            <span class="text-sm font-medium text-gray-700">填空 ${clozeItemCount}</span>
          </div>
          <button type="button" onclick="removeClozeItem(this)" class="text-gray-400 hover:text-error-500">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- 选项输入 -->
        <div class="mb-4">
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-medium text-gray-700">选项</label>
            <button type="button" onclick="addClozeOption(this)" class="text-xs text-primary-500 hover:text-primary-600 flex items-center gap-1">
              <i class="fas fa-plus-circle"></i>
              <span>添加选项</span>
            </button>
          </div>
          <div class="cloze-options-container flex items-start gap-3 flex-wrap">
            ${generateClozeOptionsHorizontal(4, clozeItemCount)}
          </div>
        </div>

        <!-- 答案选择 -->
        <div>
          <label class="text-sm font-medium text-gray-700 block mb-2">答案</label>
          <div class="cloze-answers-list flex items-center gap-3 flex-wrap">
            ${generateClozeAnswersCircle(4, clozeItemCount)}
          </div>
        </div>
      `;

      clozeItemsList.appendChild(clozeItemDiv);

      // 初始化删除按钮状态
      updateDeleteButtons(clozeItemDiv);
    }

    function generateClozeOptionsHorizontal(count, itemIndex) {
      const labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
      let html = '';
      for (let i = 0; i < count; i++) {
        html += `
          <div class="cloze-option-item flex-shrink-0">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-sm font-semibold text-gray-700">${labels[i]}</span>
            </div>
            <div class="relative">
              <input type="text" placeholder="添加选项" class="cloze-option w-40 px-3 py-2 pr-8 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
            </div>
          </div>
        `;
      }
      return html;
    }

    function generateClozeAnswersCircle(count, itemIndex) {
      const labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
      let html = '';
      for (let i = 0; i < count; i++) {
        html += `
          <label class="cloze-answer-item cursor-pointer">
            <input type="radio" name="cloze_answer_${itemIndex}" value="${labels[i]}" class="hidden peer">
            <div class="w-10 h-10 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-600 font-medium peer-checked:border-primary-500 peer-checked:bg-primary-500 peer-checked:text-white hover:border-primary-400 transition-colors">
              ${labels[i]}
            </div>
          </label>
        `;
      }
      return html;
    }

    function addClozeOption(btn) {
      const clozeItem = btn.closest('.cloze-item');
      const itemIndex = clozeItem.dataset.index;
      const optionsContainer = clozeItem.querySelector('.cloze-options-container');
      const answersList = clozeItem.querySelector('.cloze-answers-list');
      const currentCount = clozeItem.querySelectorAll('.cloze-option-item').length;

      if (currentCount >= 26) {
        alert('最多支持26个选项');
        return;
      }

      const labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
      const label = labels[currentCount];

      // 添加选项输入
      const optionDiv = document.createElement('div');
      optionDiv.className = 'cloze-option-item flex-shrink-0';
      optionDiv.innerHTML = `
        <div class="flex items-center gap-2 mb-1">
          <span class="text-sm font-semibold text-gray-700">${label}</span>
        </div>
        <div class="relative">
          <input type="text" placeholder="添加选项" class="cloze-option w-40 px-3 py-2 pr-8 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
        </div>
      `;

      // 添加到容器末尾
      optionsContainer.appendChild(optionDiv);

      // 添加答案选项
      const answerLabel = document.createElement('label');
      answerLabel.className = 'cloze-answer-item cursor-pointer';
      answerLabel.innerHTML = `
        <input type="radio" name="cloze_answer_${itemIndex}" value="${label}" class="hidden peer">
        <div class="w-10 h-10 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-600 font-medium peer-checked:border-primary-500 peer-checked:bg-primary-500 peer-checked:text-white hover:border-primary-400 transition-colors">
          ${label}
        </div>
      `;
      answersList.appendChild(answerLabel);

      // 更新删除按钮
      updateDeleteButtons(clozeItem);

      // 滚动到新添加的选项
      optionDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'end' });
    }

    function updateDeleteButtons(clozeItem) {
      const optionItems = clozeItem.querySelectorAll('.cloze-option-item');

      optionItems.forEach((item, index) => {
        // 移除现有的删除按钮
        const existingBtn = item.querySelector('.delete-option-btn');
        if (existingBtn) {
          existingBtn.remove();
        }

        // 如果选项数量大于2，且不是前2个，添加删除按钮
        if (optionItems.length > 2 && index >= 2) {
          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'delete-option-btn absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-error-500 transition-colors';
          deleteBtn.innerHTML = '<i class="fas fa-times text-xs"></i>';
          deleteBtn.onclick = function() { removeClozeOptionNew(this); };

          const inputWrapper = item.querySelector('.relative');
          inputWrapper.appendChild(deleteBtn);
        }
      });
    }

    function removeClozeOptionNew(btn) {
      const clozeItem = btn.closest('.cloze-item');
      const itemIndex = clozeItem.dataset.index;
      const optionItem = btn.closest('.cloze-option-item');
      const optionItems = clozeItem.querySelectorAll('.cloze-option-item');
      const optionIndex = Array.from(optionItems).indexOf(optionItem);

      // 删除选项
      optionItem.remove();

      // 删除对应的答案选项
      const answerItems = clozeItem.querySelectorAll('.cloze-answer-item');
      if (answerItems[optionIndex]) {
        answerItems[optionIndex].remove();
      }

      // 重新编号选项和答案
      const labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
      const remainingOptions = clozeItem.querySelectorAll('.cloze-option-item');
      const remainingAnswers = clozeItem.querySelectorAll('.cloze-answer-item');

      remainingOptions.forEach((option, index) => {
        const label = labels[index];
        // 更新字母标签
        const labelSpan = option.querySelector('span');
        labelSpan.textContent = label;
      });

      remainingAnswers.forEach((answer, index) => {
        const label = labels[index];
        const radio = answer.querySelector('input');
        const div = answer.querySelector('div');
        radio.value = label;
        div.textContent = label;
      });

      // 更新删除按钮
      updateDeleteButtons(clozeItem);
    }

    function removeClozeItem(btn) {
      const clozeItem = btn.closest('.cloze-item');
      clozeItem.remove();

      // 更新填空编号
      const clozeItems = document.querySelectorAll('.cloze-item');
      clozeItems.forEach((item, index) => {
        const number = index + 1;
        item.dataset.index = number;
        item.querySelector('button.bg-primary-500').textContent = number;
        item.querySelector('span.text-sm').textContent = `填空 ${number}`;

        // 更新答案radio的name属性
        const radios = item.querySelectorAll('input[type="radio"]');
        radios.forEach(radio => {
          radio.name = `cloze_answer_${number}`;
        });
      });

      clozeItemCount = clozeItems.length;
    }

    // ==================== 复合题型管理 ====================
    let currentSubQuestionIndex = 0; // 当前显示的子题目索引

    function initCompositeAnswers() {
      subQuestionCount = 0;
      currentSubQuestionIndex = 0;
      document.getElementById('subQuestionTabs').innerHTML = '';
      document.getElementById('subQuestionsContent').innerHTML = '';
    }

    function addSubQuestion() {
      if (!currentCompositeType || !currentCompositeType.subTypes) {
        alert('当前复合题型配置错误');
        return;
      }

      subQuestionCount++;
      const index = subQuestionCount;

      // 添加标签
      const tabsContainer = document.getElementById('subQuestionTabs');
      const tab = document.createElement('button');
      tab.type = 'button';
      tab.className = 'sub-question-tab w-10 h-10 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-600 hover:border-primary-500 hover:text-primary-500 transition-colors';
      tab.dataset.index = index;
      tab.onclick = function() { switchSubQuestion(index); };
      tab.innerHTML = index;
      tabsContainer.appendChild(tab);

      // 获取题型配置
      const { modifiedDefaultTypes } = loadQuestionTypesConfig();
      const allowedTypes = currentCompositeType.subTypes.map(typeId => {
        const baseType = defaultQuestionTypes.find(t => t.id === typeId);
        if (baseType && baseType.isDefault && modifiedDefaultTypes[typeId]) {
          return { ...baseType, ...modifiedDefaultTypes[typeId] };
        }
        return baseType;
      }).filter(t => t);

      // 判断是否只有一个题型
      const isSingleType = allowedTypes.length === 1;
      const singleType = isSingleType ? allowedTypes[0] : null;

      // 构建题型选择选项
      const typeOptions = allowedTypes.map(t =>
        `<option value="${t.id}">${t.name}</option>`
      ).join('');

      // 创建子题目内容
      const contentContainer = document.getElementById('subQuestionsContent');
      const contentDiv = document.createElement('div');
      contentDiv.className = 'sub-question-content hidden';
      contentDiv.dataset.index = index;

      contentDiv.innerHTML = `
        <!-- 子题目类型信息 -->
        <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-200">
          <div class="flex items-center gap-3">
            <span class="text-sm font-medium text-gray-700">${isSingleType ? singleType.name : '请选择题型'}</span>
            ${isSingleType ? `
              <input type="hidden" class="sub-question-type" value="${singleType.id}">
            ` : `
              <select class="sub-question-type px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" onchange="handleSubQuestionTypeChange(this)">
                <option value="">请选择题型</option>
                ${typeOptions}
              </select>
            `}
          </div>
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
              <label class="text-xs text-gray-600">分数</label>
              <input type="number" class="sub-question-score w-20 px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="分数" min="0" step="0.5" oninput="updateTotalScoreFromSubQuestions()">
            </div>
            <button type="button" onclick="removeSubQuestion(${index})" class="text-gray-400 hover:text-error-500">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- 子题目题干 -->
        <div class="sub-question-stem mb-4 ${isSingleType ? '' : 'hidden'}">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            子题干 <span class="text-error-500">*</span>
          </label>
          <!-- 富文本编辑器工具栏 -->
          <div class="editor-toolbar flex items-center space-x-1 flex-wrap gap-y-2">
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="粗体">
              <i class="fas fa-bold"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="左对齐">
              <i class="fas fa-align-left"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="居中">
              <i class="fas fa-align-center"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="右对齐">
              <i class="fas fa-align-right"></i>
            </button>
            <div class="w-px h-6 bg-gray-300"></div>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="斜体">
              <i class="fas fa-italic"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="下划线">
              <i class="fas fa-underline"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="删除线">
              <i class="fas fa-strikethrough"></i>
            </button>
            <div class="w-px h-6 bg-gray-300"></div>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="无序列表">
              <i class="fas fa-list-ul"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="有序列表">
              <i class="fas fa-list-ol"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="表格">
              <i class="fas fa-table"></i>
            </button>
            <div class="w-px h-6 bg-gray-300"></div>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="插入链接">
              <i class="fas fa-link"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="插入图片">
              <i class="fas fa-image"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="代码块">
              <i class="fas fa-code"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="上传附件">
              <i class="fas fa-paperclip"></i>
            </button>
          </div>
          <textarea class="sub-question-stem-input editor-content w-full" rows="4" placeholder="请输入题干内容..."></textarea>
        </div>

        <!-- 答案区域容器 -->
        <div class="sub-question-answers mb-4 ${isSingleType ? '' : 'hidden'}">
        </div>

        <!-- 未选择题型提示 -->
        ${isSingleType ? '' : '<div class="sub-question-select-hint text-center py-8 text-gray-400"><i class="fas fa-hand-pointer text-3xl mb-2"></i><p class="text-sm">请先选择题型</p></div>'}

        <!-- 答案解析 -->
        <div class="sub-question-explanation-section ${isSingleType ? '' : 'hidden'}">
          <label class="block text-sm font-medium text-gray-700 mb-2">答案解析（可选）</label>
          <div class="editor-toolbar flex items-center space-x-1 flex-wrap gap-y-2">
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="粗体">
              <i class="fas fa-bold"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="左对齐">
              <i class="fas fa-align-left"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="居中">
              <i class="fas fa-align-center"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="右对齐">
              <i class="fas fa-align-right"></i>
            </button>
            <div class="w-px h-6 bg-gray-300"></div>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="斜体">
              <i class="fas fa-italic"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="下划线">
              <i class="fas fa-underline"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="删除线">
              <i class="fas fa-strikethrough"></i>
            </button>
            <div class="w-px h-6 bg-gray-300"></div>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="无序列表">
              <i class="fas fa-list-ul"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="有序列表">
              <i class="fas fa-list-ol"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="表格">
              <i class="fas fa-table"></i>
            </button>
            <div class="w-px h-6 bg-gray-300"></div>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="插入链接">
              <i class="fas fa-link"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="插入图片">
              <i class="fas fa-image"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="代码块">
              <i class="fas fa-code"></i>
            </button>
            <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="上传附件">
              <i class="fas fa-paperclip"></i>
            </button>
          </div>
          <textarea class="sub-question-explanation editor-content w-full" rows="3" placeholder="请输入答案解析..."></textarea>
        </div>
      `;

      // 如果只有一个题型，自动渲染答案区域
      if (isSingleType) {
        contentContainer.appendChild(contentDiv);
        const answersContainer = contentDiv.querySelector('.sub-question-answers');
        const typeValue = singleType.id;

        if (typeValue === 'single' || typeValue === 'multiple') {
          renderSubQuestionOptions(answersContainer, typeValue);
        } else if (typeValue === 'judge') {
          renderSubQuestionJudge(answersContainer);
        } else if (typeValue === 'blank') {
          renderSubQuestionBlanks(answersContainer);
        } else if (typeValue === 'cloze') {
          renderSubQuestionCloze(answersContainer);
        } else if (typeValue === 'shortAnswer') {
          renderSubQuestionShortAnswer(answersContainer);
        }
      } else {
        contentContainer.appendChild(contentDiv);
      }

      // 切换到新添加的子题目
      switchSubQuestion(index);
    }

    function switchSubQuestion(index) {
      currentSubQuestionIndex = index;

      // 更新标签样式
      document.querySelectorAll('.sub-question-tab').forEach(tab => {
        if (parseInt(tab.dataset.index) === index) {
          tab.className = 'sub-question-tab w-10 h-10 flex items-center justify-center rounded-full border-2 border-primary-500 bg-primary-500 text-white font-medium transition-colors';
        } else {
          tab.className = 'sub-question-tab w-10 h-10 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-600 hover:border-primary-500 hover:text-primary-500 transition-colors';
        }
      });

      // 显示对应内容
      document.querySelectorAll('.sub-question-content').forEach(content => {
        if (parseInt(content.dataset.index) === index) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      });
    }

    function removeSubQuestion(index) {
      if (!confirm('确定要删除这个子题目吗？')) {
        return;
      }

      // 删除标签
      const tab = document.querySelector(`.sub-question-tab[data-index="${index}"]`);
      if (tab) tab.remove();

      // 删除内容
      const content = document.querySelector(`.sub-question-content[data-index="${index}"]`);
      if (content) content.remove();

      // 重新编号
      const tabs = document.querySelectorAll('.sub-question-tab');
      tabs.forEach((tab, i) => {
        const oldIndex = tab.dataset.index;
        const newIndex = i + 1;
        tab.dataset.index = newIndex;
        tab.textContent = newIndex;
        tab.onclick = function() { switchSubQuestion(newIndex); };

        // 更新对应的内容索引
        const content = document.querySelector(`.sub-question-content[data-index="${oldIndex}"]`);
        if (content) {
          content.dataset.index = newIndex;
          // 更新删除按钮的 onclick
          const deleteBtn = content.querySelector('button[onclick*="removeSubQuestion"]');
          if (deleteBtn) {
            deleteBtn.onclick = function() { removeSubQuestion(newIndex); };
          }
        }
      });

      subQuestionCount = tabs.length;

      // 如果删除后还有子题目，切换到第一个
      if (subQuestionCount > 0) {
        switchSubQuestion(1);
      } else {
        // 如果没有子题目了，清空内容
        document.getElementById('subQuestionsContent').innerHTML = '';
      }
    }
    function handleSubQuestionTypeChange(select) {
      const subQuestionContent = select.closest('.sub-question-content');
      const answersContainer = subQuestionContent.querySelector('.sub-question-answers');
      const stemSection = subQuestionContent.querySelector('.sub-question-stem');
      const explanationSection = subQuestionContent.querySelector('.sub-question-explanation-section');
      const selectHint = subQuestionContent.querySelector('.sub-question-select-hint');
      const selectedType = select.value;

      if (!selectedType) {
        // 未选择题型，隐藏所有编辑区域
        answersContainer.innerHTML = '';
        answersContainer.classList.add('hidden');
        if (stemSection) stemSection.classList.add('hidden');
        if (explanationSection) explanationSection.classList.add('hidden');
        if (selectHint) selectHint.classList.remove('hidden');
        return;
      }

      // 已选择题型，显示所有编辑区域
      if (selectHint) selectHint.classList.add('hidden');
      if (stemSection) stemSection.classList.remove('hidden');
      if (explanationSection) explanationSection.classList.remove('hidden');
      answersContainer.classList.remove('hidden');

      // 根据题型渲染对应的答案输入区域
      if (selectedType === 'single' || selectedType === 'multiple') {
        renderSubQuestionOptions(answersContainer, selectedType);
      } else if (selectedType === 'judge') {
        renderSubQuestionJudge(answersContainer);
      } else if (selectedType === 'blank') {
        renderSubQuestionBlanks(answersContainer);
      } else if (selectedType === 'cloze') {
        renderSubQuestionCloze(answersContainer);
      } else if (selectedType === 'shortAnswer') {
        renderSubQuestionShortAnswer(answersContainer);
      }
    }

    function renderSubQuestionOptions(container, type) {
      const inputType = type === 'single' ? 'radio' : 'checkbox';
      const uniqueId = Date.now();

      container.innerHTML = `
        <label class="block text-sm font-medium text-gray-700 mb-2">
          答案选项 <span class="text-error-500">*</span>
        </label>
        <div class="space-y-2">
          ${['A', 'B', 'C', 'D'].map((label, index) => `
            <div class="option-item flex items-center space-x-3 p-3 border border-gray-200 rounded-lg">
              <input type="${inputType}" name="subq_answer_${uniqueId}" value="${label}" class="w-4 h-4 text-primary-500" title="设为正确答案">
              <span class="text-sm font-medium text-gray-600 w-8">选项${label}</span>
              <div class="flex-1">
                <!-- 纯文本输入（默认显示）-->
                <input type="text" placeholder="请输入选项内容" class="simple-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">

                <!-- 富文本编辑器（默认隐藏）-->
                <div class="rich-editor">
                  <div class="editor-toolbar flex items-center space-x-1 mb-1" style="padding: 4px 8px; border-radius: 4px 4px 0 0;">
                    <button type="button" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded text-xs" title="粗体">
                      <i class="fas fa-bold"></i>
                    </button>
                    <button type="button" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded text-xs" title="斜体">
                      <i class="fas fa-italic"></i>
                    </button>
                    <button type="button" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded text-xs" title="下划线">
                      <i class="fas fa-underline"></i>
                    </button>
                    <button type="button" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded text-xs" title="插入图片">
                      <i class="fas fa-image"></i>
                    </button>
                  </div>
                  <textarea placeholder="请输入选项内容" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-b-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none" style="border-top: none; border-radius: 0 0 4px 4px;"></textarea>
                </div>
              </div>
              <button type="button" onclick="toggleOptionMode(this)" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-primary-500 hover:bg-primary-50 rounded transition-colors" title="切换富文本模式">
                <i class="fas fa-expand-alt"></i>
              </button>
              ${index >= 2 ? `<button type="button" onclick="this.closest('.option-item').remove()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-error-500 hover:bg-error-50 rounded transition-colors"><i class="fas fa-times"></i></button>` : '<div class="w-8"></div>'}
            </div>
          `).join('')}
        </div>
        <button type="button" onclick="addSubQuestionOption(this)" class="mt-2 text-sm text-primary-500 hover:text-primary-600">
          <i class="fas fa-plus-circle mr-1"></i>添加选项
        </button>
      `;
    }

    function renderSubQuestionJudge(container) {
      const uniqueId = Date.now();
      container.innerHTML = `
        <label class="block text-sm font-medium text-gray-700 mb-2">答案 <span class="text-error-500">*</span></label>
        <div class="flex items-center space-x-4">
          <label class="flex items-center space-x-2 cursor-pointer">
            <input type="radio" name="subq_judge_${uniqueId}" value="true" class="w-4 h-4 text-primary-500">
            <span class="text-sm text-gray-700">正确</span>
          </label>
          <label class="flex items-center space-x-2 cursor-pointer">
            <input type="radio" name="subq_judge_${uniqueId}" value="false" class="w-4 h-4 text-primary-500">
            <span class="text-sm text-gray-700">错误</span>
          </label>
        </div>
      `;
    }

    function renderSubQuestionBlanks(container) {
      container.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <label class="text-sm font-medium text-gray-700">填空答案 <span class="text-error-500">*</span></label>
          <button type="button" onclick="addSubQuestionBlank(this)" class="text-sm text-primary-500 hover:text-primary-600">
            <i class="fas fa-plus-circle mr-1"></i>添加填空
          </button>
        </div>
        <div class="sub-question-blanks-list space-y-2">
          <div class="border border-gray-200 rounded-lg p-3 bg-gray-50 hover:border-primary-300 transition-colors">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-semibold text-gray-700">第 1 空</span>
              <button type="button" onclick="removeSubQuestionBlank(this)" class="w-5 h-5 flex items-center justify-center text-gray-400 hover:text-error-500 hover:bg-error-50 rounded transition-colors">
                <i class="fas fa-times text-xs"></i>
              </button>
            </div>
            <div class="flex items-center gap-2">
              <input type="text" placeholder="答案" class="sub-question-blank-answer flex-1 px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent">
              <div class="flex items-center gap-1 flex-shrink-0">
                <span class="text-xs text-gray-500 whitespace-nowrap">分数:</span>
                <input type="number" placeholder="分" min="0" step="0.5" class="sub-question-blank-score w-16 px-2 py-1.5 border border-gray-300 rounded text-xs focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent" oninput="updateTotalScoreFromSubQuestionBlanks(this)">
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderSubQuestionShortAnswer(container) {
      container.innerHTML = `
        <label class="block text-sm font-medium text-gray-700 mb-2">参考答案 <span class="text-error-500">*</span></label>
        <div class="editor-toolbar flex items-center space-x-1 flex-wrap gap-y-2 mb-2">
          <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="粗体">
            <i class="fas fa-bold"></i>
          </button>
          <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="斜体">
            <i class="fas fa-italic"></i>
          </button>
          <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="下划线">
            <i class="fas fa-underline"></i>
          </button>
          <button type="button" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded" title="插入图片">
            <i class="fas fa-image"></i>
          </button>
        </div>
        <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none" rows="4" placeholder="请输入参考答案..."></textarea>
      `;
    }

    function renderSubQuestionCloze(container) {
      container.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <label class="text-sm font-medium text-gray-700">完形填空项 <span class="text-error-500">*</span></label>
          <button type="button" onclick="addSubQuestionClozeItem(this)" class="text-sm text-primary-500 hover:text-primary-600">
            <i class="fas fa-plus-circle mr-1"></i>添加填空项
          </button>
        </div>
        <div class="sub-question-cloze-list space-y-2">
          <div class="border border-gray-200 rounded-lg p-3 bg-gray-50 hover:border-primary-300 transition-colors">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-semibold text-gray-700">第 1 项</span>
              <button type="button" onclick="removeSubQuestionClozeItem(this)" class="w-5 h-5 flex items-center justify-center text-gray-400 hover:text-error-500 hover:bg-error-50 rounded transition-colors">
                <i class="fas fa-times text-xs"></i>
              </button>
            </div>
            <div class="space-y-2">
              <input type="text" placeholder="选项A" class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent">
              <input type="text" placeholder="选项B" class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent">
              <input type="text" placeholder="选项C" class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent">
              <input type="text" placeholder="选项D" class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent">
              <div class="flex items-center gap-2 pt-1">
                <label class="text-xs text-gray-600">正确答案:</label>
                <select class="flex-1 px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent">
                  <option value="">请选择</option>
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                  <option value="D">D</option>
                </select>
                <div class="flex items-center gap-1">
                  <span class="text-xs text-gray-500 whitespace-nowrap">分数:</span>
                  <input type="number" placeholder="分" min="0" step="0.5" class="sub-question-cloze-score w-16 px-2 py-1.5 border border-gray-300 rounded text-xs focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent" oninput="updateTotalScoreFromSubQuestionCloze(this)">
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function addSubQuestionOption(btn) {
      const container = btn.closest('.sub-question-answers');
      const optionsContainer = container.querySelector('.space-y-2');
      const currentCount = optionsContainer.querySelectorAll('.option-item').length;
      const labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

      if (currentCount >= 26) {
        alert('最多支持26个选项');
        return;
      }

      const label = labels[currentCount];
      const isMultiple = optionsContainer.querySelector('input[type="checkbox"]') !== null;
      const inputType = isMultiple ? 'checkbox' : 'radio';
      const uniqueId = container.querySelector('input[type="radio"], input[type="checkbox"]')?.name || `subq_answer_${Date.now()}`;

      const optionDiv = document.createElement('div');
      optionDiv.className = 'option-item flex items-center space-x-3 p-3 border border-gray-200 rounded-lg';
      optionDiv.innerHTML = `
        <input type="${inputType}" name="${uniqueId}" value="${label}" class="w-4 h-4 text-primary-500" title="设为正确答案">
        <span class="text-sm font-medium text-gray-600 w-8">选项${label}</span>
        <div class="flex-1">
          <!-- 纯文本输入（默认显示）-->
          <input type="text" placeholder="请输入选项内容" class="simple-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">

          <!-- 富文本编辑器（默认隐藏）-->
          <div class="rich-editor">
            <div class="editor-toolbar flex items-center space-x-1 mb-1" style="padding: 4px 8px; border-radius: 4px 4px 0 0;">
              <button type="button" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded text-xs" title="粗体">
                <i class="fas fa-bold"></i>
              </button>
              <button type="button" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded text-xs" title="斜体">
                <i class="fas fa-italic"></i>
              </button>
              <button type="button" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded text-xs" title="下划线">
                <i class="fas fa-underline"></i>
              </button>
              <button type="button" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded text-xs" title="插入图片">
                <i class="fas fa-image"></i>
              </button>
            </div>
            <textarea placeholder="请输入选项内容" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-b-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none" style="border-top: none; border-radius: 0 0 4px 4px;"></textarea>
          </div>
        </div>
        <button type="button" onclick="toggleOptionMode(this)" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-primary-500 hover:bg-primary-50 rounded transition-colors" title="切换富文本模式">
          <i class="fas fa-expand-alt"></i>
        </button>
        <button type="button" onclick="this.closest('.option-item').remove()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-error-500 hover:bg-error-50 rounded transition-colors">
          <i class="fas fa-times"></i>
        </button>
      `;

      optionsContainer.appendChild(optionDiv);
    }

    function addSubQuestionBlank(btn) {
      const container = btn.closest('.sub-question-answers');
      const blanksList = container.querySelector('.sub-question-blanks-list');
      const currentCount = blanksList.children.length;

      const blankDiv = document.createElement('div');
      blankDiv.className = 'border border-gray-200 rounded-lg p-3 bg-gray-50 hover:border-primary-300 transition-colors';
      blankDiv.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs font-semibold text-gray-700">第 ${currentCount + 1} 空</span>
          <button type="button" onclick="removeSubQuestionBlank(this)" class="w-5 h-5 flex items-center justify-center text-gray-400 hover:text-error-500 hover:bg-error-50 rounded transition-colors">
            <i class="fas fa-times text-xs"></i>
          </button>
        </div>
        <div class="flex items-center gap-2">
          <input type="text" placeholder="答案" class="sub-question-blank-answer flex-1 px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent">
          <div class="flex items-center gap-1 flex-shrink-0">
            <span class="text-xs text-gray-500 whitespace-nowrap">分数:</span>
            <input type="number" placeholder="分" min="0" step="0.5" class="sub-question-blank-score w-16 px-2 py-1.5 border border-gray-300 rounded text-xs focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent" oninput="updateTotalScoreFromSubQuestionBlanks(this)">
          </div>
        </div>
      `;

      blanksList.appendChild(blankDiv);
    }

    // 根据子题目填空分数更新子题目总分
    function updateTotalScoreFromSubQuestionBlanks(input) {
      // 找到当前子题目的容器
      const subQuestionContent = input.closest('.sub-question-content');

      // 找到当前子题目的所有填空分数输入框
      const blankScores = subQuestionContent.querySelectorAll('.sub-question-blank-score');

      // 累加分数
      let totalScore = 0;
      blankScores.forEach(scoreInput => {
        const score = parseFloat(scoreInput.value);
        if (!isNaN(score) && score > 0) {
          totalScore += score;
        }
      });

      // 更新当前子题目的分数输入框
      const subQuestionScore = subQuestionContent.querySelector('.sub-question-score');
      if (subQuestionScore && totalScore > 0) {
        subQuestionScore.value = totalScore;

        // 添加视觉反馈：高亮显示总分已更新
        subQuestionScore.classList.add('ring-2', 'ring-primary-500', 'bg-primary-50');
        setTimeout(() => {
          subQuestionScore.classList.remove('ring-2', 'ring-primary-500', 'bg-primary-50');
        }, 600);
      }

      // 触发子题目分数的累加（更新主题目总分）
      updateTotalScoreFromSubQuestions();
    }

    // 删除子题目填空
    function removeSubQuestionBlank(btn) {
      const subQuestionContent = btn.closest('.sub-question-content');
      const blanksList = subQuestionContent.querySelector('.sub-question-blanks-list');
      const blanks = blanksList.children;

      // 至少保留1个填空
      if (blanks.length <= 1) {
        alert('至少保留一个填空');
        return;
      }

      // 删除当前填空
      btn.closest('.border').remove();

      // 重新编号
      Array.from(blanksList.children).forEach((blank, index) => {
        blank.querySelector('.font-semibold').textContent = `第 ${index + 1} 空`;
      });

      // 重新计算总分
      const firstScoreInput = blanksList.querySelector('.sub-question-blank-score');
      if (firstScoreInput) {
        updateTotalScoreFromSubQuestionBlanks(firstScoreInput);
      }
    }

    // 添加完形填空项
    function addSubQuestionClozeItem(btn) {
      const container = btn.closest('.sub-question-answers');
      const clozeList = container.querySelector('.sub-question-cloze-list');
      const currentCount = clozeList.children.length;

      const clozeDiv = document.createElement('div');
      clozeDiv.className = 'border border-gray-200 rounded-lg p-3 bg-gray-50 hover:border-primary-300 transition-colors';
      clozeDiv.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs font-semibold text-gray-700">第 ${currentCount + 1} 项</span>
          <button type="button" onclick="removeSubQuestionClozeItem(this)" class="w-5 h-5 flex items-center justify-center text-gray-400 hover:text-error-500 hover:bg-error-50 rounded transition-colors">
            <i class="fas fa-times text-xs"></i>
          </button>
        </div>
        <div class="space-y-2">
          <input type="text" placeholder="选项A" class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent">
          <input type="text" placeholder="选项B" class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent">
          <input type="text" placeholder="选项C" class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent">
          <input type="text" placeholder="选项D" class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent">
          <div class="flex items-center gap-2 pt-1">
            <label class="text-xs text-gray-600">正确答案:</label>
            <select class="flex-1 px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent">
              <option value="">请选择</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
            <div class="flex items-center gap-1">
              <span class="text-xs text-gray-500 whitespace-nowrap">分数:</span>
              <input type="number" placeholder="分" min="0" step="0.5" class="sub-question-cloze-score w-16 px-2 py-1.5 border border-gray-300 rounded text-xs focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-transparent" oninput="updateTotalScoreFromSubQuestionCloze(this)">
            </div>
          </div>
        </div>
      `;

      clozeList.appendChild(clozeDiv);
    }

    // 删除完形填空项
    function removeSubQuestionClozeItem(btn) {
      const subQuestionContent = btn.closest('.sub-question-content');
      const clozeList = subQuestionContent.querySelector('.sub-question-cloze-list');
      const items = clozeList.children;

      // 至少保留1项
      if (items.length <= 1) {
        alert('至少保留一项');
        return;
      }

      // 删除当前项
      btn.closest('.border').remove();

      // 重新编号
      Array.from(clozeList.children).forEach((item, index) => {
        item.querySelector('.font-semibold').textContent = `第 ${index + 1} 项`;
      });

      // 重新计算总分
      const firstScoreInput = clozeList.querySelector('.sub-question-cloze-score');
      if (firstScoreInput) {
        updateTotalScoreFromSubQuestionCloze(firstScoreInput);
      }
    }

    // 根据完形填空项分数更新子题目总分
    function updateTotalScoreFromSubQuestionCloze(input) {
      // 找到当前子题目的容器
      const subQuestionContent = input.closest('.sub-question-content');

      // 找到当前子题目的所有完形填空项分数输入框
      const clozeScores = subQuestionContent.querySelectorAll('.sub-question-cloze-score');

      // 累加分数
      let totalScore = 0;
      clozeScores.forEach(scoreInput => {
        const score = parseFloat(scoreInput.value);
        if (!isNaN(score) && score > 0) {
          totalScore += score;
        }
      });

      // 更新当前子题目的分数输入框
      const subQuestionScore = subQuestionContent.querySelector('.sub-question-score');
      if (subQuestionScore && totalScore > 0) {
        subQuestionScore.value = totalScore;

        // 添加视觉反馈：高亮显示总分已更新
        subQuestionScore.classList.add('ring-2', 'ring-primary-500', 'bg-primary-50');
        setTimeout(() => {
          subQuestionScore.classList.remove('ring-2', 'ring-primary-500', 'bg-primary-50');
        }, 600);
      }

      // 触发子题目分数的累加（更新主题目总分）
      updateTotalScoreFromSubQuestions();
    }

    function updateTotalScoreFromSubQuestions() {
      let totalScore = 0;
      const subQuestionScores = document.querySelectorAll('.sub-question-score');

      subQuestionScores.forEach(input => {
        const score = parseFloat(input.value);
        if (!isNaN(score) && score > 0) {
          totalScore += score;
        }
      });

      const scoreInput = document.getElementById('score');
      if (totalScore > 0) {
        scoreInput.value = totalScore;

        // 添加视觉反馈：高亮显示总分已更新
        scoreInput.classList.add('ring-2', 'ring-primary-500', 'bg-primary-50');
        setTimeout(() => {
          scoreInput.classList.remove('ring-2', 'ring-primary-500', 'bg-primary-50');
        }, 600);
      }
    }

    // ==================== 标签管理 ====================
    function handleTagInput(event) {
      if (event.key === 'Enter' || event.keyCode === 13) {
        event.preventDefault();
        addTag();
      }
    }

    function addTag() {
      const input = document.getElementById('tagInput');
      const tag = input.value.trim();

      if (!tag) return;

      if (tags.includes(tag)) {
        alert('标签已存在');
        return;
      }

      if (tags.length >= 10) {
        alert('最多支持10个标签');
        return;
      }

      tags.push(tag);
      renderTags();
      input.value = '';
    }

    function removeTag(tag) {
      tags = tags.filter(t => t !== tag);
      renderTags();
    }

    function renderTags() {
      const tagsList = document.getElementById('tagsList');
      tagsList.innerHTML = tags.map(tag => `
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-700">
          #${tag}
          <button type="button" onclick="removeTag('${tag}')" class="ml-2 text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </span>
      `).join('');
    }

    // ==================== 表单操作 ====================
    function goBack() {
      if (confirm('确定要离开吗？未保存的内容将丢失。')) {
        window.location.href = 'list.html';
      }
    }

    function saveQuestion() {
      // 验证题型是否选择
      const typeInputs = document.querySelectorAll('input[name="questionType"]');
      let selectedType = '';
      let typeName = '';

      typeInputs.forEach(input => {
        if (input.checked) {
          selectedType = input.value;
          typeName = input.nextElementSibling.textContent.trim();
        }
      });

      if (!selectedType) {
        alert('请先选择题型');
        return;
      }

      // 验证必填项
      const difficulty = document.getElementById('difficulty').value;
      const knowledge = document.getElementById('knowledgePoint').value;
      const content = document.getElementById('questionContent').value.trim();

      if (!difficulty) {
        alert('请选择难度');
        return;
      }
      if (!knowledge) {
        alert('请选择知识点');
        return;
      }
      if (!content) {
        alert('请输入题目内容');
        return;
      }

      // 验证复合题型的子题目
      const { modifiedDefaultTypes, customQuestionTypes } = loadQuestionTypesConfig();
      const allTypes = [...defaultQuestionTypes, ...(customQuestionTypes || [])];
      const selectedTypeConfig = allTypes.find(t => t.id === selectedType);
      let displayType = selectedTypeConfig;
      if (selectedTypeConfig && selectedTypeConfig.isDefault && modifiedDefaultTypes[selectedTypeConfig.id]) {
        displayType = { ...selectedTypeConfig, ...modifiedDefaultTypes[selectedTypeConfig.id] };
      }

      if (displayType && displayType.isComposite) {
        // 复合题型必须至少有一个子题目
        const subQuestionTabs = document.querySelectorAll('.sub-question-tab');
        if (subQuestionTabs.length === 0) {
          alert('复合题型至少需要添加一个子题目');
          return;
        }
      }

      // 获取实际的题型类型（自定义题型使用 baseType，默认题型使用 selectedType）
      const actualType = displayType?.baseType || selectedType;

      // 获取知识点路径
      const knowledgeSelect = document.getElementById('knowledgePoint');
      const selectedOption = knowledgeSelect.options[knowledgeSelect.selectedIndex];
      const knowledgePath = selectedOption.parentElement.label + ' / ' + selectedOption.text;

      // 收集表单数据
      const formData = {
        id: 'Q' + String(Date.now()).slice(-3),
        type: selectedType,
        typeName: typeName,
        difficulty: parseInt(difficulty),
        difficultyName: ['一级', '二级', '三级', '四级', '五级'][parseInt(difficulty) - 1],
        knowledgeId: knowledge,
        knowledgePath: knowledgePath,
        content: content,
        tags: tags,
        score: document.getElementById('score').value,
        explanation: document.getElementById('explanation').value,
        createTime: formatLocalDateTime(new Date()),
        author: '管理员',
        useCount: 0,
        isComposite: displayType && displayType.isComposite,
        subCount: 0
      };

      // 根据题型收集答案
      if (actualType === 'single' || actualType === 'multiple') {
        const options = [];
        const correctAnswers = [];
        document.querySelectorAll('.option-item').forEach(opt => {
          const isRichMode = opt.classList.contains('rich-mode');
          const text = isRichMode
            ? opt.querySelector('textarea').value.trim()
            : opt.querySelector('input[type="text"]').value.trim();
          const isCorrect = opt.querySelector('input[type="radio"], input[type="checkbox"]').checked;
          const label = opt.querySelector('.font-medium').textContent.replace('选项 ', '').trim();

          if (text) {
            options.push({ label, text });
            if (isCorrect) correctAnswers.push(label);
          }
        });

        if (options.length < 2) {
          alert('至少需要2个选项');
          return;
        }
        if (correctAnswers.length === 0) {
          alert('请设置正确答案');
          return;
        }

        formData.options = options;
        formData.correctAnswers = correctAnswers;
      } else if (actualType === 'judge') {
        const answer = document.querySelector('input[name="judgeAnswer"]:checked');
        if (!answer) {
          alert('请选择正确答案');
          return;
        }
        formData.correctAnswer = answer.value;
      } else if (actualType === 'blank') {
        const blanks = [];
        const blankItems = document.querySelectorAll('#blankAnswersList > div');

        blankItems.forEach((item, index) => {
          const answer = item.querySelector('.blank-answer').value.trim();
          const score = item.querySelector('.blank-score').value.trim();

          if (answer) {
            blanks.push({
              index: index + 1,
              answer: answer,
              score: score ? parseFloat(score) : 0
            });
          }
        });

        if (blanks.length === 0) {
          alert('请至少输入一个填空答案');
          return;
        }

        formData.blanks = blanks;
      } else if (displayType && displayType.isComposite) {
        // 复合题型：收集子题目数据
        formData.subQuestions = [];
        const subQuestionContents = document.querySelectorAll('.sub-question-content');

        if (subQuestionContents.length === 0) {
          alert('复合题型至少需要添加一个子题目');
          return;
        }

        let hasError = false;
        subQuestionContents.forEach((content, index) => {
          if (hasError) return;

          const subType = content.querySelector('.sub-question-type').value;
          const subStem = content.querySelector('.sub-question-stem-input')?.value.trim() || '';
          const subScore = content.querySelector('.sub-question-score').value;
          const subExplanation = content.querySelector('.sub-question-explanation')?.value.trim() || '';

          if (!subType) {
            alert(`第 ${index + 1} 道子题目未选择题型`);
            hasError = true;
            return;
          }

          if (!subStem) {
            alert(`第 ${index + 1} 道子题目未输入题干`);
            hasError = true;
            return;
          }

          const subQuestion = {
            id: index + 1,
            type: subType,
            content: subStem,
            score: parseFloat(subScore) || 0,
            explanation: subExplanation
          };

          // 根据子题目类型收集答案
          if (subType === 'single' || subType === 'multiple') {
            const options = [];
            const correctAnswers = [];
            const answersContainer = content.querySelector('.sub-question-answers');

            answersContainer.querySelectorAll('.option-item').forEach(opt => {
              const label = opt.querySelector('input[type="radio"], input[type="checkbox"]')?.value || '';
              const isRichMode = opt.classList.contains('rich-mode');
              const text = isRichMode
                ? opt.querySelector('textarea')?.value.trim() || ''
                : opt.querySelector('.simple-input')?.value.trim() || '';
              const isCorrect = opt.querySelector('input[type="radio"], input[type="checkbox"]')?.checked || false;

              if (text) {
                options.push({ label, text });
                if (isCorrect) correctAnswers.push(label);
              }
            });

            if (options.length < 2) {
              alert(`第 ${index + 1} 道子题目至少需要2个选项`);
              hasError = true;
              return;
            }
            if (correctAnswers.length === 0) {
              alert(`第 ${index + 1} 道子题目请设置正确答案`);
              hasError = true;
              return;
            }

            subQuestion.options = options;
            subQuestion.correctAnswers = correctAnswers;
          } else if (subType === 'judge') {
            const answer = content.querySelector('input[name^="subq_judge_"]:checked');
            if (!answer) {
              alert(`第 ${index + 1} 道子题目请选择正确答案`);
              hasError = true;
              return;
            }
            subQuestion.correctAnswer = answer.value;
          } else if (subType === 'blank') {
            const blanks = [];
            const blanksList = content.querySelector('.sub-question-blanks-list');
            const blankItems = blanksList?.querySelectorAll('.border.border-gray-200') || [];

            blankItems.forEach((item, blankIndex) => {
              const answer = item.querySelector('.blank-answer')?.value.trim() || '';
              const score = item.querySelector('.blank-score')?.value.trim() || '';

              if (answer) {
                blanks.push({
                  index: blankIndex + 1,
                  answer: answer,
                  score: score ? parseFloat(score) : 0
                });
              }
            });

            if (blanks.length === 0) {
              alert(`第 ${index + 1} 道子题目请至少输入一个填空答案`);
              hasError = true;
              return;
            }

            subQuestion.blanks = blanks;
          } else {
            // 简答题等主观题
            const referenceAnswer = content.querySelector('.sub-question-answers textarea')?.value.trim() || '';
            subQuestion.referenceAnswer = referenceAnswer;
          }

          formData.subQuestions.push(subQuestion);
        });

        if (hasError) {
          return;
        }

        // 更新子题目数量和总分
        formData.subCount = formData.subQuestions.length;
        formData.totalScore = formData.subQuestions.reduce((sum, sq) => sum + sq.score, 0);
      } else {
        formData.referenceAnswer = document.getElementById('referenceAnswer').value;
      }

      // 题型图标和颜色映射
      const typeConfigMap = {
        'single': { icon: 'fa-dot-circle', color: 'info' },
        'multiple': { icon: 'fa-check-square', color: 'success' },
        'judge': { icon: 'fa-check-circle', color: 'success' },
        'blank': { icon: 'fa-keyboard', color: 'warning' },
        'shortAnswer': { icon: 'fa-align-left', color: 'primary' },
        'essay': { icon: 'fa-file-alt', color: 'primary' },
        'calculation': { icon: 'fa-calculator', color: 'indigo' },
        'cloze': { icon: 'fa-layer-group', color: 'indigo' },
        'reading': { icon: 'fa-book-open', color: 'purple' },
        'materialAnalysis': { icon: 'fa-list-alt', color: 'purple' }
      };

      // 优先使用自定义题型的 icon 和 color，否则使用映射表
      if (displayType && displayType.icon && displayType.color) {
        formData.typeIcon = displayType.icon;
        formData.typeColor = displayType.color;
      } else {
        const config = typeConfigMap[actualType] || typeConfigMap[selectedType] || { icon: 'fa-file-alt', color: 'gray' };
        formData.typeIcon = config.icon;
        formData.typeColor = config.color;
      }

      // 保存到 localStorage
      let questions = JSON.parse(localStorage.getItem('examQuestions') || '[]');
      questions.push(formData);
      localStorage.setItem('examQuestions', JSON.stringify(questions));

      // 显示成功提示
      const goToList = confirm('题目保存成功！\n\n是否返回题目列表查看？\n点击"取消"继续添加下一道题目。');

      if (goToList) {
        // 如果在iframe中，通知父页面刷新列表
        if (window.parent && window.parent !== window) {
          try {
            if (window.parent.navigateToPage) {
              window.parent.navigateToPage('list.html');
            }
          } catch (e) {
            window.location.href = 'list.html';
          }
        } else {
          window.location.href = 'list.html';
        }
      } else {
        // 清空表单，准备下一道题目
        resetForm();
      }
    }

    // 重置表单
    function resetForm() {
      // 清空题目内容
      document.getElementById('questionContent').value = '';

      // 清空难度选择
      document.getElementById('difficulty').value = '';

      // 清空知识点选择
      document.getElementById('knowledgePoint').value = '';

      // 清空分值
      document.getElementById('score').value = '';

      // 清空答案解析
      document.getElementById('explanation').value = '';

      // 清空标签
      tags = [];
      renderTags();
      document.getElementById('tagInput').value = '';

      // 清空选项（单选/多选题）
      document.querySelectorAll('.option-item input[type="text"]').forEach(input => {
        input.value = '';
      });
      document.querySelectorAll('.option-item textarea').forEach(textarea => {
        textarea.value = '';
      });
      document.querySelectorAll('.option-item input[type="radio"], .option-item input[type="checkbox"]').forEach(input => {
        input.checked = false;
      });

      // 重置富文本模式为纯文本模式
      document.querySelectorAll('.option-item.rich-mode').forEach(item => {
        item.classList.remove('rich-mode');
      });
      document.querySelectorAll('.option-item button i.fa-compress-alt').forEach(icon => {
        icon.className = 'fas fa-expand-alt';
        icon.parentElement.title = '切换富文本模式';
      });

      // 清空判断题答案
      document.querySelectorAll('input[name="judgeAnswer"]').forEach(input => {
        input.checked = false;
      });

      // 清空填空题答案和分数
      blankCount = 0;
      document.getElementById('blankAnswersList').innerHTML = '';

      // 滚动到顶部
      document.getElementById('contentContainer').scrollTop = 0;
    }
  </script>
</body>
</html>
