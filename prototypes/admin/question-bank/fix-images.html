<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>修复题目图片 - 考试系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-50 p-8">
  <div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-8">
      <h1 class="text-2xl font-bold text-gray-900 mb-4">
        <i class="fas fa-tools text-primary-500 mr-2"></i>
        修复题目图片
      </h1>

      <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
        <p class="text-sm text-blue-900">
          <i class="fas fa-info-circle mr-2"></i>
          此工具将把题目中的占位符图片URL替换为本地SVG文件引用
        </p>
      </div>

      <div id="status" class="mb-6"></div>

      <div class="space-y-4">
        <button onclick="analyzeQuestions()" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium">
          <i class="fas fa-search mr-2"></i>
          1. 分析题目图片
        </button>

        <button onclick="fixImages()" class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium" id="fixBtn" disabled>
          <i class="fas fa-magic mr-2"></i>
          2. 修复图片引用
        </button>

        <button onclick="goToList()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium">
          <i class="fas fa-list mr-2"></i>
          返回题目列表
        </button>
      </div>

      <div id="log" class="mt-6 bg-gray-900 text-gray-100 p-4 rounded-lg font-mono text-sm max-h-96 overflow-y-auto hidden"></div>
    </div>
  </div>

  <script>
    // 图片映射表：占位符关键词 -> SVG文件路径
    const imageMap = {
      'Hash': './images/hash-table.svg',
      'Binary': './images/binary-tree.svg',
      'Stack': './images/stack-operations.svg',
      'Graph': './images/graph-structure.svg',
      'Tree': './images/binary-tree.svg',
      'Sorting': './images/sorting-process.svg',
      'Social': './images/social-network.svg'
    };

    let questionsWithImages = [];

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      logDiv.classList.remove('hidden');

      const colors = {
        'info': 'text-blue-400',
        'success': 'text-green-400',
        'warning': 'text-yellow-400',
        'error': 'text-red-400'
      };

      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<div class="${colors[type]}">[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      const colors = {
        'info': 'bg-blue-50 border-blue-500 text-blue-900',
        'success': 'bg-green-50 border-green-500 text-green-900',
        'warning': 'bg-yellow-50 border-yellow-500 text-yellow-900',
        'error': 'bg-red-50 border-red-500 text-red-900'
      };

      statusDiv.innerHTML = `
        <div class="${colors[type]} border-l-4 p-4">
          <p class="text-sm">${message}</p>
        </div>
      `;
    }

    function analyzeQuestions() {
      log('开始分析题目...', 'info');

      try {
        const questionsJson = localStorage.getItem('allQuestions');
        if (!questionsJson) {
          showStatus('未找到题目数据', 'error');
          log('错误：localStorage中没有allQuestions', 'error');
          return;
        }

        const questions = JSON.parse(questionsJson);
        log(`总共 ${questions.length} 道题目`, 'info');

        // 查找包含placeholder图片的题目
        questionsWithImages = [];

        questions.forEach(q => {
          const hasPlaceholderInContent = q.content && (
            q.content.includes('via.placeholder.com') ||
            q.content.includes('placeholder.com')
          );

          const hasPlaceholderInOptions = q.options && q.options.some(opt =>
            opt.text && (opt.text.includes('via.placeholder.com') || opt.text.includes('placeholder.com'))
          );

          if (hasPlaceholderInContent || hasPlaceholderInOptions) {
            questionsWithImages.push(q);
          }
        });

        log(`找到 ${questionsWithImages.length} 道题目包含占位符图片`, 'success');

        if (questionsWithImages.length > 0) {
          questionsWithImages.forEach(q => {
            log(`  - ${q.id}: ${q.typeName} - ${q.content.substring(0, 50)}...`);
          });

          showStatus(`找到 ${questionsWithImages.length} 道题目需要修复`, 'warning');
          document.getElementById('fixBtn').disabled = false;
        } else {
          showStatus('所有题目的图片都正常，无需修复', 'success');
        }

      } catch (error) {
        log(`分析失败: ${error.message}`, 'error');
        showStatus('分析失败，请查看日志', 'error');
      }
    }

    function fixImages() {
      if (questionsWithImages.length === 0) {
        showStatus('没有需要修复的题目', 'info');
        return;
      }

      if (!confirm(`确定要修复 ${questionsWithImages.length} 道题目的图片吗？`)) {
        return;
      }

      log('开始修复图片...', 'info');

      try {
        const questionsJson = localStorage.getItem('allQuestions');
        const allQuestions = JSON.parse(questionsJson);

        let fixedCount = 0;

        allQuestions.forEach(q => {
          let needUpdate = false;

          // 修复content中的图片
          if (q.content && (q.content.includes('via.placeholder.com') || q.content.includes('placeholder.com'))) {
            q.content = replaceImageUrls(q.content);
            needUpdate = true;
          }

          // 修复options中的图片
          if (q.options) {
            q.options.forEach(opt => {
              if (opt.text && (opt.text.includes('via.placeholder.com') || opt.text.includes('placeholder.com'))) {
                opt.text = replaceImageUrls(opt.text);
                needUpdate = true;
              }
            });
          }

          // 修复复合题子题
          if (q.subQuestions) {
            q.subQuestions.forEach(sub => {
              if (sub.content && (sub.content.includes('via.placeholder.com') || sub.content.includes('placeholder.com'))) {
                sub.content = replaceImageUrls(sub.content);
                needUpdate = true;
              }
              if (sub.options) {
                sub.options.forEach(opt => {
                  if (opt.text && (opt.text.includes('via.placeholder.com') || opt.text.includes('placeholder.com'))) {
                    opt.text = replaceImageUrls(opt.text);
                    needUpdate = true;
                  }
                });
              }
            });
          }

          if (needUpdate) {
            fixedCount++;
            log(`修复题目: ${q.id}`, 'success');
          }
        });

        // 保存修复后的数据
        localStorage.setItem('allQuestions', JSON.stringify(allQuestions));

        log(`修复完成！共修复 ${fixedCount} 道题目`, 'success');
        showStatus(`修复成功！共修复 ${fixedCount} 道题目`, 'success');

        // 3秒后跳转到列表页
        setTimeout(() => {
          if (confirm('修复完成！是否跳转到题目列表查看？')) {
            window.location.href = 'list.html';
          }
        }, 2000);

      } catch (error) {
        log(`修复失败: ${error.message}`, 'error');
        showStatus('修复失败，请查看日志', 'error');
      }
    }

    function replaceImageUrls(html) {
      // 匹配所有img标签
      return html.replace(/<img[^>]*src=["']([^"']*placeholder[^"']*)["'][^>]*>/gi, (match, url) => {
        // 从URL中提取关键词
        let svgPath = null;

        for (const [keyword, path] of Object.entries(imageMap)) {
          if (url.includes(keyword)) {
            svgPath = path;
            break;
          }
        }

        if (svgPath) {
          // 提取原有的其他属性（如alt, style等）
          const altMatch = match.match(/alt=["']([^"']*)["']/i);
          const alt = altMatch ? altMatch[1] : '图片';

          return `<img src="${svgPath}" alt="${alt}" style="max-width: 400px; height: auto; display: inline-block; vertical-align: middle; margin: 8px 0;" />`;
        }

        // 如果没有匹配到，使用默认图片
        return `<img src="./images/binary-tree.svg" alt="图片" style="max-width: 400px; height: auto; display: inline-block; vertical-align: middle; margin: 8px 0;" />`;
      });
    }

    function goToList() {
      window.location.href = 'list.html';
    }

    // 页面加载时自动分析
    window.addEventListener('DOMContentLoaded', () => {
      log('页面加载完成', 'info');
      log('点击"分析题目图片"按钮开始分析', 'info');
    });
  </script>
</body>
</html>
