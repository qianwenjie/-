<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>题目列表 - 考试系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- KaTeX CSS for formula rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <!-- KaTeX JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#E6F9F0', 500: '#00B96B', 600: '#00A35C' },
            success: { 50: '#E8FFEA', 500: '#00B42A' },
            warning: { 50: '#FFF7E8', 500: '#FF7D00' },
            error: { 50: '#FFECE8', 500: '#F53F3F' },
            info: { 50: '#E8F7FF', 500: '#14C9C9' },
            indigo: { 50: '#E8E7FF', 500: '#6366F1' },
            purple: { 50: '#FAF5FF', 500: '#A855F7' }
          }
        }
      }
    }
  </script>
  <style>
    /* 苹果风格卡片 */
    .apple-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .apple-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    /* 知识点树样式 */
    .tree-item {
      transition: all 0.2s;
    }
    .tree-item:hover {
      background-color: #F9FAFB;
    }
    .tree-item.active {
      background-color: #E6F9F0;
      color: #00B96B;
      font-weight: 500;
    }

    /* 滚动条样式 */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }

    /* 题目内容样式 */
    .question-content {
      line-height: 1.75;
    }
    .question-content img {
      max-width: 100%;
      height: auto;
      margin: 12px 0;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      display: block;
    }
    .question-content br {
      display: block;
      margin: 4px 0;
      content: "";
    }

    /* 侧滑面板样式 */
    .preview-drawer {
      position: fixed;
      top: 0;
      right: -600px;
      width: 600px;
      height: 100vh;
      background: white;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .preview-drawer.active {
      right: 0;
    }
    .preview-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
      z-index: 99;
    }
    .preview-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .option-label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #f3f4f6;
      color: #6b7280;
      font-size: 14px;
      font-weight: 500;
      margin-right: 8px;
      flex-shrink: 0;
    }
    .option-label.correct {
      background: #d1fae5;
      color: #065f46;
    }
    .preview-drawer::-webkit-scrollbar {
      width: 6px;
    }
    .preview-drawer::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    .preview-drawer::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }

    /* AI出题按钮样式 - 科技感渐变 */
    .ai-generate-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      background-size: 200% 200%;
      animation: gradientShift 3s ease infinite;
      position: relative;
      overflow: hidden;
    }
    .ai-generate-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    .ai-generate-btn:hover {
      background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 50%, #ed64a6 100%);
    }
    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    .ai-sparkle {
      animation: sparkle 1.5s ease-in-out infinite;
    }
    @keyframes sparkle {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.2); }
    }

    /* AI出题模态框样式 */
    .ai-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .ai-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .ai-modal {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 1100px;
      max-height: 85vh;
      overflow: hidden;
      transform: scale(0.9);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
      display: flex;
      flex-direction: column;
    }
    .ai-modal-overlay.active .ai-modal {
      transform: scale(1);
      opacity: 1;
    }
    .ai-tab-btn {
      padding: 10px 24px;
      font-size: 14px;
      color: #6b7280;
      border: 1px solid #e5e7eb;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    .ai-tab-btn:first-child {
      border-radius: 8px 0 0 8px;
    }
    .ai-tab-btn:last-child {
      border-radius: 0 8px 8px 0;
    }
    .ai-tab-btn:not(:last-child) {
      border-right: none;
    }
    .ai-tab-btn.active {
      background: #EBF5FF;
      color: #2563eb;
      border-color: #2563eb;
      font-weight: 500;
    }
    .ai-tab-btn:hover:not(.active) {
      background: #f9fafb;
    }
    .ai-number-input {
      width: 70px;
      padding: 6px 8px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      text-align: center;
      font-size: 14px;
    }
    .ai-number-input:focus {
      outline: none;
      border-color: #2563eb;
      ring: 2px solid #2563eb;
    }
    .ai-generate-submit-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 28px;
      border-radius: 8px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
      border: none;
      cursor: pointer;
    }
    .ai-generate-submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .ai-generate-submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .ai-result-area {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      min-height: 400px;
      max-height: 500px;
      overflow-y: auto;
    }
    .ai-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      gap: 16px;
    }
    .ai-loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e5e7eb;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .ai-loading-text {
      color: #6b7280;
      font-size: 14px;
    }
    .ai-loading-dots::after {
      content: '';
      animation: dots 1.5s steps(4, end) infinite;
    }
    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }
    .file-upload-zone {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }
    .file-upload-zone:hover {
      border-color: #2563eb;
      background: #f0f7ff;
    }
    .file-upload-zone.dragover {
      border-color: #2563eb;
      background: #EBF5FF;
    }

    /* Message 消息提示样式 */
    .message-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      pointer-events: none;
    }
    .message-item {
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      animation: messageSlideIn 0.3s ease-out;
      pointer-events: auto;
    }
    .message-item.success {
      background: #f0fdf4;
      border: 1px solid #86efac;
      color: #166534;
    }
    .message-item.error {
      background: #fef2f2;
      border: 1px solid #fca5a5;
      color: #991b1b;
    }
    .message-item.warning {
      background: #fffbeb;
      border: 1px solid #fcd34d;
      color: #92400e;
    }
    .message-item.info {
      background: #eff6ff;
      border: 1px solid #93c5fd;
      color: #1e40af;
    }
    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes messageSlideOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }
  </style>
  <!-- iframe嵌入检测脚本 -->
  <script>
  (function() {
    function isInIframe() {
      try { return window.self !== window.top; } catch (e) { return true; }
    }
    if (isInIframe() || window.location.search.includes("embedded=true")) {
      document.write('<style>header{display:none!important}aside{display:none!important}.pt-16{padding-top:0!important}.ml-64{margin-left:0!important}button[onclick*="history.back"]{display:none!important}</style>');
    }
  })();
  </script>
</head>
<body class="bg-gray-50">
  <!-- Message 消息提示容器 -->
  <div id="messageContainer" class="message-container"></div>

  <!-- 顶部导航栏 -->
  <header class="h-16 bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
    <div class="flex items-center justify-between h-full px-6">
      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-2">
          <div class="w-8 h-8 bg-primary-500 rounded flex items-center justify-center">
            <i class="fas fa-graduation-cap text-white"></i>
          </div>
          <span class="text-xl font-semibold text-gray-900">考试系统</span>
        </div>
        <nav class="hidden md:flex items-center space-x-2 text-sm text-gray-600">
          <a href="../dashboard.html" class="hover:text-primary-500">首页</a>
          <i class="fas fa-chevron-right text-xs text-gray-400"></i>
          <span class="text-gray-900 font-medium">题库管理</span>
        </nav>
      </div>
      <div class="flex items-center space-x-4">
        <img src="https://via.placeholder.com/32" alt="用户" class="w-8 h-8 rounded-full">
        <span class="text-sm text-gray-700 font-medium">管理员</span>
      </div>
    </div>
  </header>

  <div class="pt-16 flex h-screen">
    <!-- 左侧知识点树 -->
    <aside class="w-80 min-w-[320px] max-w-[320px] bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
      <!-- 搜索栏 -->
      <div class="p-4 border-b border-gray-200">
        <div class="relative mb-3">
          <input type="text" id="searchInput" placeholder="搜索知识点..." oninput="searchKnowledge(this.value)"
                 class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
          <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
          <button id="clearSearchBtn" onclick="clearSearch()" class="hidden absolute right-3 top-2 w-6 h-6 flex items-center justify-center text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition-colors">
            <i class="fas fa-times text-xs"></i>
          </button>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="addRootDirectory()" class="flex-1 bg-primary-500 hover:bg-primary-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors whitespace-nowrap">
            <i class="fas fa-folder-plus mr-1.5"></i>添加目录
          </button>
          <button onclick="addRootKnowledgePoint()" class="flex-1 bg-success-500 hover:bg-success-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors whitespace-nowrap">
            <i class="fas fa-book mr-1.5"></i>添加知识点
          </button>
        </div>
      </div>

      <!-- 知识点树 -->
      <div id="knowledgeTree" class="flex-1 overflow-y-auto custom-scrollbar p-4">
        <div class="space-y-1">
          <!-- 全部题目 -->
          <div class="tree-item active px-3 py-2 rounded-lg cursor-pointer flex items-center justify-between" onclick="selectAllQuestions(this)">
            <div class="flex items-center space-x-2">
              <i class="fas fa-folder text-primary-500"></i>
              <span class="text-sm">全部题目</span>
            </div>
            <span class="text-xs text-gray-500" id="totalQuestionsInTree">128</span>
          </div>

          <!-- 动态渲染的知识点树 -->
          <div id="knowledgeTreeContainer" class="mt-4 space-y-1">
            <!-- 将通过JavaScript动态渲染 -->
          </div>
        </div>
      </div>
    </aside>

    <!-- 右侧主内容区 -->
    <main class="flex-1 flex flex-col bg-gray-50">
      <!-- 工具栏 -->
      <div class="bg-white border-b border-gray-200 px-6 py-4">
        <!-- 第一行：标题和操作 -->
        <div class="flex items-center justify-between mb-4">
          <div>
            <h1 class="text-xl font-semibold text-gray-900" id="pageTitle">全部题目</h1>
            <p class="mt-1 text-sm text-gray-500">共 <span id="totalQuestions">128</span> 道题目</p>
          </div>
          <div class="flex items-center space-x-3">
            <button onclick="window.location.href='duplicate-check.html'" class="px-4 py-2.5 border border-amber-500 text-amber-600 rounded-lg text-sm font-medium hover:bg-amber-50 transition-colors flex items-center space-x-2">
              <i class="fas fa-copy"></i>
              <span>题目查重</span>
            </button>
            <button onclick="openQuestionTypeSettings()" class="px-4 py-2.5 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
              <i class="fas fa-cog mr-2"></i>
              题型设置
            </button>
            <button onclick="window.location.href='export.html'" class="px-4 py-2.5 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors flex items-center space-x-2">
              <i class="fas fa-file-export"></i>
              <span>题目导出</span>
            </button>
            <button onclick="window.location.href='add-simple.html'" class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2.5 rounded-lg font-medium text-sm flex items-center space-x-2 shadow-sm">
              <i class="fas fa-keyboard"></i>
              <span>简便录入</span>
            </button>
            <!-- AI出题按钮 - 科技感渐变样式 -->
            <button onclick="window.location.href='ai-generate.html'" class="ai-generate-btn px-4 py-2.5 rounded-lg font-medium text-sm flex items-center space-x-2 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>AI 出题</span>
              <span class="ai-sparkle">✨</span>
            </button>
            <button onclick="addNewQuestion()" class="px-4 py-2.5 border border-primary-500 text-primary-500 rounded-lg font-medium text-sm flex items-center space-x-2 hover:bg-primary-50 transition-colors">
              <i class="fas fa-plus"></i>
              <span>新增题目</span>
            </button>
          </div>
        </div>

        <!-- 筛选栏（一行） -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <!-- 全局搜索 -->
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600 whitespace-nowrap font-medium">搜索:</label>
            <div class="relative">
              <input type="text" id="globalSearchInput" placeholder="搜索题目内容..."
                     oninput="debouncedSearch()" onkeypress="handleEnterKey(event)"
                     class="w-48 pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
              <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
            </div>
          </div>

          <!-- 题型筛选（多选下拉） -->
          <div class="flex items-center gap-2 relative">
            <label class="text-sm text-gray-600 whitespace-nowrap font-medium">题型:</label>
            <div class="relative">
              <button type="button" id="questionTypeDropdownBtn" onclick="toggleQuestionTypeDropdown()"
                      class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white min-w-[140px] flex items-center justify-between hover:bg-gray-50 transition-colors">
                <span id="questionTypeLabel" class="text-gray-700">全部题型</span>
                <i class="fas fa-chevron-down text-gray-400 ml-2 text-xs"></i>
              </button>
              <div id="questionTypeDropdown" class="hidden absolute z-20 mt-1 w-56 bg-white border border-gray-200 rounded-lg shadow-lg">
                <div class="p-2 max-h-64 overflow-y-auto custom-scrollbar">
                  <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer transition-colors">
                    <input type="checkbox" value="single" class="question-type-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" onchange="updateQuestionTypeSelection()">
                    <span class="ml-2 text-sm text-gray-700">单选题</span>
                  </label>
                  <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer transition-colors">
                    <input type="checkbox" value="multiple" class="question-type-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" onchange="updateQuestionTypeSelection()">
                    <span class="ml-2 text-sm text-gray-700">多选题</span>
                  </label>
                  <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer transition-colors">
                    <input type="checkbox" value="judge" class="question-type-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" onchange="updateQuestionTypeSelection()">
                    <span class="ml-2 text-sm text-gray-700">判断题</span>
                  </label>
                  <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer transition-colors">
                    <input type="checkbox" value="blank" class="question-type-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" onchange="updateQuestionTypeSelection()">
                    <span class="ml-2 text-sm text-gray-700">填空题</span>
                  </label>
                  <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer transition-colors">
                    <input type="checkbox" value="shortAnswer" class="question-type-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" onchange="updateQuestionTypeSelection()">
                    <span class="ml-2 text-sm text-gray-700">简答题</span>
                  </label>
                  <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer transition-colors">
                    <input type="checkbox" value="cloze" class="question-type-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" onchange="updateQuestionTypeSelection()">
                    <span class="ml-2 text-sm text-gray-700">完形填空</span>
                  </label>
                  <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer transition-colors">
                    <input type="checkbox" value="composite" class="question-type-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" onchange="updateQuestionTypeSelection()">
                    <span class="ml-2 text-sm text-gray-700">复合题</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- 难度筛选（多选下拉） -->
          <div class="flex items-center gap-2 relative">
            <label class="text-sm text-gray-600 whitespace-nowrap font-medium">难度:</label>
            <div class="relative">
              <button type="button" id="difficultyDropdownBtn" onclick="toggleDifficultyDropdown()"
                      class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white min-w-[120px] flex items-center justify-between hover:bg-gray-50 transition-colors">
                <span id="difficultyLabel" class="text-gray-700">全部难度</span>
                <i class="fas fa-chevron-down text-gray-400 ml-2 text-xs"></i>
              </button>
              <div id="difficultyDropdown" class="hidden absolute z-20 mt-1 w-40 bg-white border border-gray-200 rounded-lg shadow-lg">
                <div class="p-2">
                  <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer transition-colors">
                    <input type="checkbox" value="1" class="difficulty-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" onchange="updateDifficultySelection()">
                    <span class="ml-2 text-sm text-gray-700">一级</span>
                  </label>
                  <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer transition-colors">
                    <input type="checkbox" value="2" class="difficulty-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" onchange="updateDifficultySelection()">
                    <span class="ml-2 text-sm text-gray-700">二级</span>
                  </label>
                  <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer transition-colors">
                    <input type="checkbox" value="3" class="difficulty-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" onchange="updateDifficultySelection()">
                    <span class="ml-2 text-sm text-gray-700">三级</span>
                  </label>
                  <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer transition-colors">
                    <input type="checkbox" value="4" class="difficulty-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" onchange="updateDifficultySelection()">
                    <span class="ml-2 text-sm text-gray-700">四级</span>
                  </label>
                  <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer transition-colors">
                    <input type="checkbox" value="5" class="difficulty-checkbox rounded border-gray-300 text-primary-500 focus:ring-primary-500" onchange="updateDifficultySelection()">
                    <span class="ml-2 text-sm text-gray-700">五级</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- 标签搜索 -->
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600 whitespace-nowrap font-medium">标签:</label>
            <input type="text" id="filterTag" placeholder="输入标签..."
                   oninput="debouncedSearch()" onkeypress="handleEnterKey(event)"
                   class="w-36 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white">
          </div>

          <!-- 筛选和重置按钮 -->
          <button onclick="applyFilters()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium transition-colors whitespace-nowrap">
            筛选
          </button>
          <button onclick="clearAllFilters()" class="px-4 py-2 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg text-sm font-medium transition-colors whitespace-nowrap">
            重置
          </button>
          </div>

          <!-- 批量操作下拉菜单（右侧） -->
          <div class="relative">
            <button onclick="toggleBatchMenu()" id="batchMenuBtn" class="px-4 py-2 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg text-sm font-medium transition-colors whitespace-nowrap flex items-center space-x-2">
              <i class="fas fa-tasks"></i>
              <span>批量操作</span>
              <i class="fas fa-chevron-down text-xs"></i>
            </button>
            <div id="batchMenu" class="hidden absolute right-0 mt-1 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-30">
              <div class="py-1">
                <button onclick="startBatchMode('delete')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2">
                  <i class="fas fa-trash text-red-500 w-4"></i>
                  <span>批量删除</span>
                </button>
                <button onclick="startBatchMode('knowledge')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2">
                  <i class="fas fa-folder text-primary-500 w-4"></i>
                  <span>批量修改知识点</span>
                </button>
                <button onclick="startBatchMode('difficulty')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2">
                  <i class="fas fa-signal text-warning-500 w-4"></i>
                  <span>批量修改难度</span>
                </button>
                <button onclick="startBatchMode('tags')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2">
                  <i class="fas fa-tags text-info-500 w-4"></i>
                  <span>批量设置标签</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 批量操作工具栏（选择模式时显示） -->
      <div id="batchToolbar" class="hidden bg-indigo-50 border-b border-indigo-200 px-6 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" class="w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
              <span class="text-sm text-gray-700 font-medium">全选当前页</span>
            </label>
            <span class="text-sm text-gray-600">已选择 <span id="selectedCount" class="font-semibold text-indigo-600">0</span> 道题目</span>
            <span id="batchModeLabel" class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-xs font-medium"></span>
          </div>
          <div class="flex items-center space-x-3">
            <button onclick="executeBatchAction()" id="executeBatchBtn" disabled class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-lg text-sm font-medium transition-colors">
              <i class="fas fa-check mr-1.5"></i>确认操作
            </button>
            <button onclick="cancelBatchMode()" class="px-4 py-2 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg text-sm font-medium transition-colors">
              取消
            </button>
          </div>
        </div>
      </div>

      <!-- 题目列表 -->
      <div id="questionListContainer" class="flex-1 overflow-y-auto custom-scrollbar p-6 pb-24">
        <div id="questionList" class="max-w-6xl mx-auto space-y-4">
          <!-- 题目将通过JavaScript动态渲染 -->
        </div>

        <!-- 空状态提示 -->
        <div id="emptyState" class="hidden max-w-6xl mx-auto text-center py-20">
          <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
          <p class="text-gray-500 text-lg">暂无题目</p>
          <p class="text-gray-400 text-sm mt-2">请调整筛选条件或新增题目</p>
        </div>

        <!-- 分页控件 -->
        <div id="paginationContainer" class="hidden fixed bottom-0 left-80 right-0 bg-white border-t border-gray-200 px-6 py-4 z-40">
          <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="text-sm text-gray-600">
              显示 <span id="pageStart">1</span>-<span id="pageEnd">20</span> 条，共 <span id="pageTotal">0</span> 条
            </div>
            <div class="flex items-center space-x-2">
              <button onclick="goToFirstPage()" id="firstPageBtn" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
                <i class="fas fa-angle-double-left"></i>
              </button>
              <button onclick="changePage(currentPage - 1)" id="prevPageBtn" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
                <i class="fas fa-angle-left mr-1"></i>上一页
              </button>
              <div id="pageNumbers" class="flex items-center space-x-1">
                <!-- 页码将通过JavaScript动态渲染 -->
              </div>
              <button onclick="changePage(currentPage + 1)" id="nextPageBtn" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                下一页<i class="fas fa-angle-right ml-1"></i>
              </button>
              <button onclick="goToLastPage()" id="lastPageBtn" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                <i class="fas fa-angle-double-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- 题目预览侧滑面板 -->
  <div id="previewOverlay" class="preview-overlay" onclick="closePreview()"></div>
  <div id="previewDrawer" class="preview-drawer">
    <!-- 面板头部 -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
      <h2 class="text-lg font-semibold text-gray-900">题目详情</h2>
      <button onclick="closePreview()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-200 rounded-lg transition-colors">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- 面板内容 -->
    <div id="previewContent" class="flex-1 overflow-y-auto p-6">
      <div class="text-center py-20 text-gray-400">
        <i class="fas fa-circle-notch fa-spin text-3xl mb-3"></i>
        <p>加载中...</p>
      </div>
    </div>

    <!-- 面板底部操作栏 -->
    <div class="flex items-center justify-between px-6 py-4 border-t border-gray-200 bg-gray-50">
      <button onclick="closePreview()" class="px-4 py-2 border border-gray-300 hover:bg-gray-100 text-gray-700 rounded-lg text-sm font-medium transition-colors">
        关闭
      </button>
      <div class="flex items-center space-x-2">
        <button onclick="editCurrentQuestion()" class="px-4 py-2 bg-info-500 hover:bg-info-600 text-white rounded-lg text-sm font-medium transition-colors">
          <i class="fas fa-edit mr-1.5"></i>编辑
        </button>
        <button onclick="deleteCurrentQuestion()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition-colors">
          <i class="fas fa-trash mr-1.5"></i>删除
        </button>
      </div>
    </div>
  </div>

  <!-- 移动知识点位置弹窗 -->
  <div id="moveModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 w-96 shadow-2xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900">移动知识点</h3>
        <button onclick="closeMoveModal()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">目标位置</label>
        <select id="moveTargetSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
          <option value="root">根目录</option>
          <!-- 动态填充其他知识点 -->
        </select>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">排序位置</label>
        <input type="number" id="movePositionInput" min="1" value="1"
               class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
               placeholder="输入位置序号（从1开始）">
      </div>
      <div class="flex items-center space-x-3">
        <button onclick="closeMoveModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium text-sm transition-colors">
          取消
        </button>
        <button onclick="confirmMove()" class="flex-1 bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors">
          确定移动
        </button>
      </div>
    </div>
  </div>

  <!-- 题型设置弹窗 -->
  <div id="questionTypeSettingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] shadow-2xl flex flex-col">
      <!-- 弹窗头部 -->
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
        <div>
          <h3 class="text-lg font-semibold text-gray-900">题型设置</h3>
          <p class="text-sm text-gray-500 mt-1">自定义题型，满足不同出题需求</p>
        </div>
        <button onclick="closeQuestionTypeSettings()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- 弹窗内容 -->
      <div class="flex-1 overflow-y-auto p-6">
        <!-- 默认题型 -->
        <div class="mb-6">
          <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
            <i class="fas fa-cube text-primary-500 mr-2"></i>
            默认题型
          </h4>
          <div id="defaultQuestionTypes" class="space-y-2">
            <!-- 动态渲染 -->
          </div>
        </div>

        <!-- 自定义题型 -->
        <div>
          <div class="flex items-center justify-between mb-3">
            <h4 class="text-sm font-semibold text-gray-900 flex items-center">
              <i class="fas fa-puzzle-piece text-success-500 mr-2"></i>
              自定义题型
            </h4>
            <button onclick="openAddCustomType()" class="px-3 py-1.5 bg-success-500 hover:bg-success-600 text-white rounded-lg text-xs font-medium transition-colors">
              <i class="fas fa-plus mr-1"></i>
              添加自定义题型
            </button>
          </div>
          <div id="customQuestionTypes" class="space-y-2">
            <!-- 动态渲染 -->
          </div>
          <div id="emptyCustomTypes" class="hidden text-center py-12 text-gray-400">
            <i class="fas fa-inbox text-4xl mb-3"></i>
            <p class="text-sm">暂无自定义题型</p>
            <p class="text-xs mt-1">点击上方按钮添加</p>
          </div>
        </div>
      </div>

      <!-- 弹窗底部 -->
      <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
        <div class="flex items-center justify-end">
          <button onclick="closeQuestionTypeSettings()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium text-sm transition-colors">
            关闭
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 添加/编辑自定义题型弹窗 -->
  <div id="addCustomTypeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]">
    <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl">
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900" id="customTypeModalTitle">添加自定义题型</h3>
        <button onclick="closeAddCustomType()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="p-6 space-y-4">
        <!-- 选择基础题型 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            基础题型 <span class="text-error-500">*</span>
          </label>
          <select id="baseQuestionType" onchange="updateCompositeOptions()" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
            <option value="">请选择</option>
            <option value="single">单选题</option>
            <option value="multiple">多选题</option>
            <option value="judge">判断题</option>
            <option value="blank">填空题</option>
            <option value="shortAnswer">简答题</option>
            <option value="composite">复合题型</option>
          </select>
        </div>

        <!-- 自定义名称 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            自定义名称 <span class="text-error-500">*</span>
          </label>
          <!-- 原始名称提示（仅编辑内置题型时显示） -->
          <div id="originalNameHint" class="hidden mb-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-start space-x-2">
              <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
              <div class="flex-1">
                <p class="text-sm text-blue-700">
                  <span class="font-medium">原始名称：</span><span id="originalNameDisplay" class="font-semibold"></span>
                </p>
                <p class="text-xs text-blue-600 mt-1">提示：删除自定义名称即可恢复为原始名称</p>
              </div>
            </div>
          </div>
          <input type="text" id="customTypeName" placeholder="例如：情境选择题、案例分析题"
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
          <p class="text-xs text-gray-500 mt-1">建议使用易于识别的名称</p>
        </div>

        <!-- 复合方式（仅复合题型显示） -->
        <div id="compositeOptionsContainer" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            复合方式 <span class="text-error-500">*</span>
          </label>
          <div class="border border-gray-300 rounded-lg p-4 space-y-3">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-700">包含材料/背景</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="hasMaterial" class="sr-only peer" checked>
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-500"></div>
              </label>
            </div>

            <div>
              <label class="block text-xs text-gray-600 mb-2">子题型组合</label>
              <div class="space-y-2">
                <label class="flex items-center space-x-2">
                  <input type="checkbox" value="single" class="composite-subtype rounded border-gray-300 text-primary-500 focus:ring-primary-500">
                  <span class="text-sm text-gray-700">单选题</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" value="multiple" class="composite-subtype rounded border-gray-300 text-primary-500 focus:ring-primary-500">
                  <span class="text-sm text-gray-700">多选题</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" value="judge" class="composite-subtype rounded border-gray-300 text-primary-500 focus:ring-primary-500">
                  <span class="text-sm text-gray-700">判断题</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" value="blank" class="composite-subtype rounded border-gray-300 text-primary-500 focus:ring-primary-500">
                  <span class="text-sm text-gray-700">填空题</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" value="shortAnswer" class="composite-subtype rounded border-gray-300 text-primary-500 focus:ring-primary-500">
                  <span class="text-sm text-gray-700">简答题</span>
                </label>
              </div>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-1">选择该复合题型包含的子题型</p>
        </div>

        <!-- 描述（可选） -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            描述（可选）
          </label>
          <textarea id="customTypeDescription" rows="3" placeholder="简要说明该题型的特点和使用场景"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 resize-none"></textarea>
        </div>
      </div>

      <div class="flex items-center justify-end space-x-3 px-6 py-4 border-t border-gray-200 bg-gray-50">
        <button onclick="closeAddCustomType()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium text-sm transition-colors">
          取消
        </button>
        <button onclick="saveCustomType()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium text-sm transition-colors">
          保存
        </button>
      </div>
    </div>
  </div>

  <!-- 批量修改知识点弹窗 -->
  <div id="batchKnowledgeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl">
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">批量修改知识点</h3>
        <button onclick="closeBatchKnowledgeModal()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-6">
        <p class="text-sm text-gray-600 mb-4">将选中的 <span id="batchKnowledgeCount" class="font-semibold text-indigo-600">0</span> 道题目的知识点修改为：</p>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">选择知识点</label>
          <select id="batchKnowledgeSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
            <option value="">请选择知识点</option>
          </select>
        </div>
      </div>
      <div class="flex items-center justify-end space-x-3 px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
        <button onclick="closeBatchKnowledgeModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium text-sm transition-colors">取消</button>
        <button onclick="confirmBatchKnowledge()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium text-sm transition-colors">确认修改</button>
      </div>
    </div>
  </div>

  <!-- 批量修改难度弹窗 -->
  <div id="batchDifficultyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl">
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">批量修改难度</h3>
        <button onclick="closeBatchDifficultyModal()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-6">
        <p class="text-sm text-gray-600 mb-4">将选中的 <span id="batchDifficultyCount" class="font-semibold text-indigo-600">0</span> 道题目的难度修改为：</p>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">选择难度</label>
          <div class="flex flex-wrap gap-2">
            <label class="flex items-center px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
              <input type="radio" name="batchDifficulty" value="1" class="mr-2 text-primary-500 focus:ring-primary-500">
              <span class="text-sm">一级</span>
            </label>
            <label class="flex items-center px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
              <input type="radio" name="batchDifficulty" value="2" class="mr-2 text-primary-500 focus:ring-primary-500">
              <span class="text-sm">二级</span>
            </label>
            <label class="flex items-center px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
              <input type="radio" name="batchDifficulty" value="3" class="mr-2 text-primary-500 focus:ring-primary-500">
              <span class="text-sm">三级</span>
            </label>
            <label class="flex items-center px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
              <input type="radio" name="batchDifficulty" value="4" class="mr-2 text-primary-500 focus:ring-primary-500">
              <span class="text-sm">四级</span>
            </label>
            <label class="flex items-center px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
              <input type="radio" name="batchDifficulty" value="5" class="mr-2 text-primary-500 focus:ring-primary-500">
              <span class="text-sm">五级</span>
            </label>
          </div>
        </div>
      </div>
      <div class="flex items-center justify-end space-x-3 px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
        <button onclick="closeBatchDifficultyModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium text-sm transition-colors">取消</button>
        <button onclick="confirmBatchDifficulty()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium text-sm transition-colors">确认修改</button>
      </div>
    </div>
  </div>

  <!-- 批量设置标签弹窗 -->
  <div id="batchTagsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl">
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">批量设置标签</h3>
        <button onclick="closeBatchTagsModal()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-6">
        <p class="text-sm text-gray-600 mb-4">为选中的 <span id="batchTagsCount" class="font-semibold text-indigo-600">0</span> 道题目设置标签：</p>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">操作方式</label>
          <div class="flex gap-4 mb-4">
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="tagMode" value="add" checked class="mr-2 text-primary-500 focus:ring-primary-500">
              <span class="text-sm">追加标签</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="tagMode" value="replace" class="mr-2 text-primary-500 focus:ring-primary-500">
              <span class="text-sm">替换标签</span>
            </label>
          </div>
          <label class="block text-sm font-medium text-gray-700 mb-2">输入标签（多个标签用逗号分隔）</label>
          <input type="text" id="batchTagsInput" placeholder="例如：重点,必考,基础" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
          <p class="text-xs text-gray-500 mt-1">提示：多个标签请用中文逗号或英文逗号分隔</p>
        </div>
      </div>
      <div class="flex items-center justify-end space-x-3 px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
        <button onclick="closeBatchTagsModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium text-sm transition-colors">取消</button>
        <button onclick="confirmBatchTags()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium text-sm transition-colors">确认设置</button>
      </div>
    </div>
  </div>

  <!-- 批量删除确认弹窗 -->
  <div id="batchDeleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl">
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">确认批量删除</h3>
        <button onclick="closeBatchDeleteModal()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-6">
        <div class="flex items-center justify-center mb-4">
          <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center">
            <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
          </div>
        </div>
        <p class="text-center text-gray-700 mb-2">确定要删除选中的 <span id="batchDeleteCount" class="font-semibold text-red-600">0</span> 道题目吗？</p>
        <p class="text-center text-sm text-gray-500">此操作不可恢复，请谨慎操作</p>
      </div>
      <div class="flex items-center justify-end space-x-3 px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
        <button onclick="closeBatchDeleteModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium text-sm transition-colors">取消</button>
        <button onclick="confirmBatchDelete()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium text-sm transition-colors">确认删除</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== Message 消息提示 ====================
    const Message = {
      show(text, type = 'info', duration = 3000) {
        const container = document.getElementById('messageContainer');
        const item = document.createElement('div');
        item.className = `message-item ${type}`;

        const icons = {
          success: 'fa-check-circle',
          error: 'fa-times-circle',
          warning: 'fa-exclamation-circle',
          info: 'fa-info-circle'
        };

        item.innerHTML = `
          <i class="fas ${icons[type]}"></i>
          <span>${text}</span>
        `;

        container.appendChild(item);

        setTimeout(() => {
          item.style.animation = 'messageSlideOut 0.3s ease-out forwards';
          setTimeout(() => item.remove(), 300);
        }, duration);
      },
      success(text, duration) { this.show(text, 'success', duration); },
      error(text, duration) { this.show(text, 'error', duration); },
      warning(text, duration) { this.show(text, 'warning', duration); },
      info(text, duration) { this.show(text, 'info', duration); }
    };

    // ==================== 知识点树数据结构 ====================
    // type: 'directory' 表示目录（可以包含子目录或知识点）
    // type: 'knowledge' 表示知识点（叶子节点，不能再包含子节点）
    let knowledgeTree = [
      {
        id: 1,
        name: '计算机基础',
        type: 'directory',
        count: 45,
        collapsed: false,
        children: [
          { id: 11, name: '计算机系统', type: 'knowledge', count: 15, children: [] },
          { id: 12, name: '操作系统', type: 'knowledge', count: 18, children: [] },
          { id: 13, name: '数据结构', type: 'knowledge', count: 12, children: [] }
        ]
      },
      {
        id: 2,
        name: '编程语言',
        type: 'directory',
        count: 38,
        collapsed: true,
        children: [
          { id: 21, name: 'Python基础', type: 'knowledge', count: 20, children: [] },
          { id: 22, name: 'Java基础', type: 'knowledge', count: 18, children: [] }
        ]
      },
      {
        id: 3,
        name: '数据库',
        type: 'directory',
        count: 25,
        collapsed: true,
        children: [
          { id: 31, name: 'SQL语法', type: 'knowledge', count: 15, children: [] },
          { id: 32, name: '数据库设计', type: 'knowledge', count: 10, children: [] }
        ]
      },
      {
        id: 4,
        name: '网络技术',
        type: 'directory',
        count: 20,
        collapsed: true,
        children: [
          { id: 41, name: '网络协议', type: 'knowledge', count: 12, children: [] },
          { id: 42, name: '网络安全', type: 'knowledge', count: 8, children: [] }
        ]
      }
    ];

    // ==================== 题目数据（70道，每种题型10道） ====================
    let allQuestions = [
      // ==================== 单选题（10道，含1道图片题Q009、1道公式题Q010）====================
      {
        id: 'Q001', type: 'single', typeName: '单选题', typeIcon: 'fa-dot-circle', typeColor: 'info',
        difficulty: 2, difficultyName: '二级', knowledgeId: '11', knowledgePath: '计算机基础 / 计算机系统',
        content: '下列关于计算机系统的描述，<strong>正确</strong>的是？',
        tags: ['系统结构', '基础'], createTime: '2026-01-15 14:30', author: '张老师', useCount: 12,
        score: '2', explanation: '计算机系统由硬件和软件两部分组成，硬件是物理设备，软件是程序和数据。',
        options: [
          { label: 'A', text: '计算机只由硬件组成' },
          { label: 'B', text: '计算机系统由硬件和软件组成' },
          { label: 'C', text: '软件不是计算机系统的一部分' },
          { label: 'D', text: '操作系统属于硬件' }
        ],
        correctAnswers: ['B']
      },
      {
        id: 'Q002', type: 'single', typeName: '单选题', typeIcon: 'fa-dot-circle', typeColor: 'info',
        difficulty: 1, difficultyName: '一级', knowledgeId: '12', knowledgePath: '计算机基础 / 操作系统',
        content: '以下哪个不是操作系统的功能？',
        tags: ['操作系统'], createTime: '2026-01-15 10:20', author: '张老师', useCount: 18,
        score: '2', explanation: '操作系统的主要功能包括进程管理、内存管理、文件管理、设备管理等。编译程序是应用软件。',
        options: [
          { label: 'A', text: '进程管理' },
          { label: 'B', text: '内存管理' },
          { label: 'C', text: '编译程序' },
          { label: 'D', text: '文件管理' }
        ],
        correctAnswers: ['C']
      },
      {
        id: 'Q003', type: 'single', typeName: '单选题', typeIcon: 'fa-dot-circle', typeColor: 'info',
        difficulty: 2, difficultyName: '二级', knowledgeId: '21', knowledgePath: '编程语言 / Python基础',
        content: 'Python中哪个数据类型是不可变的？',
        tags: ['Python', '数据类型'], createTime: '2026-01-16 09:15', author: '李老师', useCount: 5,
        score: '2', explanation: '元组(tuple)是Python中的不可变数据类型，一旦创建就不能修改。',
        options: [
          { label: 'A', text: '列表(list)' },
          { label: 'B', text: '字典(dict)' },
          { label: 'C', text: '元组(tuple)' },
          { label: 'D', text: '集合(set)' }
        ],
        correctAnswers: ['C']
      },
      {
        id: 'Q004', type: 'single', typeName: '单选题', typeIcon: 'fa-dot-circle', typeColor: 'info',
        difficulty: 3, difficultyName: '三级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '二叉搜索树的中序遍历结果是什么顺序？',
        tags: ['数据结构', '二叉树'], createTime: '2026-01-16 14:10', author: '赵老师', useCount: 7,
        score: '2', explanation: '二叉搜索树的中序遍历会按照升序输出所有节点。',
        options: [
          { label: 'A', text: '随机顺序' },
          { label: 'B', text: '升序' },
          { label: 'C', text: '降序' },
          { label: 'D', text: '层序' }
        ],
        correctAnswers: ['B']
      },
      {
        id: 'Q005', type: 'single', typeName: '单选题', typeIcon: 'fa-dot-circle', typeColor: 'info',
        difficulty: 2, difficultyName: '二级', knowledgeId: '31', knowledgePath: '数据库 / SQL语法',
        content: 'SQL中用于删除表中所有数据但保留表结构的语句是？',
        tags: ['SQL', '删除'], createTime: '2026-01-17 10:15', author: '王老师', useCount: 10,
        score: '2', explanation: 'TRUNCATE TABLE删除所有数据但保留表结构，DROP TABLE会删除整个表。',
        options: [
          { label: 'A', text: 'DELETE TABLE' },
          { label: 'B', text: 'DROP TABLE' },
          { label: 'C', text: 'TRUNCATE TABLE' },
          { label: 'D', text: 'REMOVE TABLE' }
        ],
        correctAnswers: ['C']
      },
      {
        id: 'Q006', type: 'single', typeName: '单选题', typeIcon: 'fa-dot-circle', typeColor: 'info',
        difficulty: 2, difficultyName: '二级', knowledgeId: '41', knowledgePath: '网络技术 / 网络协议',
        content: 'HTTP协议默认使用的端口号是？',
        tags: ['HTTP', '端口'], createTime: '2026-01-17 15:50', author: '周老师', useCount: 9,
        score: '2', explanation: 'HTTP默认端口80，HTTPS默认端口443。',
        options: [
          { label: 'A', text: '21' },
          { label: 'B', text: '22' },
          { label: 'C', text: '80' },
          { label: 'D', text: '443' }
        ],
        correctAnswers: ['C']
      },
      {
        id: 'Q007', type: 'single', typeName: '单选题', typeIcon: 'fa-dot-circle', typeColor: 'info',
        difficulty: 2, difficultyName: '二级', knowledgeId: '22', knowledgePath: '编程语言 / Java基础',
        content: 'Java中的垃圾回收机制主要针对什么内存区域？',
        tags: ['Java', 'GC'], createTime: '2026-01-18 13:10', author: '孙老师', useCount: 6,
        score: '2', explanation: 'Java垃圾回收主要针对堆内存中不再使用的对象。',
        options: [
          { label: 'A', text: '栈内存' },
          { label: 'B', text: '堆内存' },
          { label: 'C', text: '方法区' },
          { label: 'D', text: '程序计数器' }
        ],
        correctAnswers: ['B']
      },
      {
        id: 'Q008', type: 'single', typeName: '单选题', typeIcon: 'fa-dot-circle', typeColor: 'info',
        difficulty: 2, difficultyName: '二级', knowledgeId: '42', knowledgePath: '网络技术 / 网络安全',
        content: '以下哪种加密算法是非对称加密？',
        tags: ['网络安全', '加密'], createTime: '2026-01-18 15:50', author: '周老师', useCount: 9,
        score: '2', explanation: 'RSA是非对称加密算法，使用公钥和私钥进行加解密。AES、DES是对称加密，MD5是哈希算法。',
        options: [
          { label: 'A', text: 'AES' },
          { label: 'B', text: 'DES' },
          { label: 'C', text: 'RSA' },
          { label: 'D', text: 'MD5' }
        ],
        correctAnswers: ['C']
      },
      {
        id: 'Q009', type: 'single', typeName: '单选题', typeIcon: 'fa-dot-circle', typeColor: 'info',
        difficulty: 3, difficultyName: '三级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '【图片题】观察下图所示的二叉树结构：<br><br><img src="https://via.placeholder.com/400x250/e0f2fe/0369a1?text=Binary+Tree%0A++++A%0A+++/+%5C%0A++B+++C%0A+/+%5C+++%5C%0AD+++E+++F" alt="二叉树结构图" style="max-width:100%;border-radius:8px;border:1px solid #e5e7eb;"><br><br>该二叉树的前序遍历结果是？',
        tags: ['二叉树', '遍历', '图片题'], createTime: '2026-01-20 09:00', author: '张老师', useCount: 3,
        score: '3', explanation: '前序遍历顺序为：根节点 → 左子树 → 右子树。从A开始，先访问A，然后访问左子树B及其子节点D、E，最后访问右子树C及其子节点F。',
        options: [
          { label: 'A', text: 'A, B, D, E, C, F' },
          { label: 'B', text: 'D, B, E, A, C, F' },
          { label: 'C', text: 'D, E, B, F, C, A' },
          { label: 'D', text: 'A, B, C, D, E, F' }
        ],
        correctAnswers: ['A']
      },
      {
        id: 'Q010', type: 'single', typeName: '单选题', typeIcon: 'fa-dot-circle', typeColor: 'info',
        difficulty: 3, difficultyName: '三级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '【公式题】已知一个完全二叉树有 n 个节点，则该树的高度 h 为？<br><br>提示：完全二叉树高度公式为 <code>h = ⌊log₂n⌋ + 1</code>',
        tags: ['二叉树', '公式题'], createTime: '2026-01-20 10:00', author: '赵老师', useCount: 4,
        score: '3', explanation: '完全二叉树的高度计算公式：h = ⌊log₂n⌋ + 1，其中 ⌊x⌋ 表示向下取整。例如 n=10 时，h = ⌊log₂10⌋ + 1 = 3 + 1 = 4。',
        options: [
          { label: 'A', text: '⌊log₂n⌋' },
          { label: 'B', text: '⌊log₂n⌋ + 1' },
          { label: 'C', text: '⌈log₂n⌉' },
          { label: 'D', text: 'log₂(n+1)' }
        ],
        correctAnswers: ['B']
      },
      // ==================== 多选题（10道）====================
      {
        id: 'Q011', type: 'multiple', typeName: '多选题', typeIcon: 'fa-check-double', typeColor: 'success',
        difficulty: 2, difficultyName: '二级', knowledgeId: '21', knowledgePath: '编程语言 / Python基础',
        content: '以下哪些是Python的特点？',
        tags: ['Python', '特性'], createTime: '2026-01-15 10:20', author: '李老师', useCount: 8,
        score: '3', explanation: 'Python是一种解释型、面向对象、动态类型的高级编程语言。',
        options: [
          { label: 'A', text: '解释型语言' },
          { label: 'B', text: '面向对象' },
          { label: 'C', text: '静态类型' },
          { label: 'D', text: '语法简洁' }
        ],
        correctAnswers: ['A', 'B', 'D']
      },
      {
        id: 'Q012', type: 'multiple', typeName: '多选题', typeIcon: 'fa-check-double', typeColor: 'success',
        difficulty: 3, difficultyName: '三级', knowledgeId: '31', knowledgePath: '数据库 / SQL语法',
        content: '以下哪些是SQL的聚合函数？',
        tags: ['SQL', '聚合函数'], createTime: '2026-01-16 10:20', author: '王老师', useCount: 9,
        score: '3', explanation: 'SQL聚合函数包括COUNT、SUM、AVG、MAX、MIN等。',
        options: [
          { label: 'A', text: 'COUNT' },
          { label: 'B', text: 'SUM' },
          { label: 'C', text: 'SELECT' },
          { label: 'D', text: 'AVG' }
        ],
        correctAnswers: ['A', 'B', 'D']
      },
      {
        id: 'Q013', type: 'multiple', typeName: '多选题', typeIcon: 'fa-check-double', typeColor: 'success',
        difficulty: 2, difficultyName: '二级', knowledgeId: '41', knowledgePath: '网络技术 / 网络协议',
        content: '以下哪些属于应用层协议？',
        tags: ['网络协议', '应用层'], createTime: '2026-01-16 15:25', author: '周老师', useCount: 13,
        score: '3', explanation: 'HTTP、FTP、SMTP都是应用层协议，TCP是传输层协议。',
        options: [
          { label: 'A', text: 'HTTP' },
          { label: 'B', text: 'FTP' },
          { label: 'C', text: 'TCP' },
          { label: 'D', text: 'SMTP' }
        ],
        correctAnswers: ['A', 'B', 'D']
      },
      {
        id: 'Q014', type: 'multiple', typeName: '多选题', typeIcon: 'fa-check-double', typeColor: 'success',
        difficulty: 3, difficultyName: '三级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '以下哪些是线性数据结构？',
        tags: ['数据结构', '线性结构'], createTime: '2026-01-17 13:20', author: '赵老师', useCount: 6,
        score: '3', explanation: '数组、链表、栈、队列都是线性数据结构，二叉树是非线性结构。',
        options: [
          { label: 'A', text: '数组' },
          { label: 'B', text: '链表' },
          { label: 'C', text: '二叉树' },
          { label: 'D', text: '栈' }
        ],
        correctAnswers: ['A', 'B', 'D']
      },
      {
        id: 'Q015', type: 'multiple', typeName: '多选题', typeIcon: 'fa-check-double', typeColor: 'success',
        difficulty: 3, difficultyName: '三级', knowledgeId: '22', knowledgePath: '编程语言 / Java基础',
        content: 'Java中的访问修饰符有哪些？',
        tags: ['Java', '访问控制'], createTime: '2026-01-18 10:25', author: '孙老师', useCount: 8,
        score: '3', explanation: 'Java有四种访问修饰符：public、protected、default、private。static不是访问修饰符。',
        options: [
          { label: 'A', text: 'public' },
          { label: 'B', text: 'protected' },
          { label: 'C', text: 'private' },
          { label: 'D', text: 'static' }
        ],
        correctAnswers: ['A', 'B', 'C']
      },
      {
        id: 'Q016', type: 'multiple', typeName: '多选题', typeIcon: 'fa-check-double', typeColor: 'success',
        difficulty: 3, difficultyName: '三级', knowledgeId: '12', knowledgePath: '计算机基础 / 操作系统',
        content: '以下哪些是操作系统的主要功能？',
        tags: ['操作系统', '功能'], createTime: '2026-01-19 15:40', author: '张老师', useCount: 8,
        score: '3', explanation: '操作系统的主要功能包括进程管理、内存管理、文件管理、设备管理。',
        options: [
          { label: 'A', text: '进程管理' },
          { label: 'B', text: '内存管理' },
          { label: 'C', text: '编译程序' },
          { label: 'D', text: '文件管理' }
        ],
        correctAnswers: ['A', 'B', 'D']
      },
      {
        id: 'Q017', type: 'multiple', typeName: '多选题', typeIcon: 'fa-check-double', typeColor: 'success',
        difficulty: 3, difficultyName: '三级', knowledgeId: '21', knowledgePath: '编程语言 / Python基础',
        content: 'Python中以下哪些是可迭代对象？',
        tags: ['Python', '迭代'], createTime: '2026-01-19 09:00', author: '李老师', useCount: 7,
        score: '3', explanation: '列表、字符串、字典都是可迭代对象，整数不是。',
        options: [
          { label: 'A', text: '列表' },
          { label: 'B', text: '字符串' },
          { label: 'C', text: '整数' },
          { label: 'D', text: '字典' }
        ],
        correctAnswers: ['A', 'B', 'D']
      },
      {
        id: 'Q018', type: 'multiple', typeName: '多选题', typeIcon: 'fa-check-double', typeColor: 'success',
        difficulty: 3, difficultyName: '三级', knowledgeId: '41', knowledgePath: '网络技术 / 网络协议',
        content: '以下哪些是传输层协议？',
        tags: ['网络协议', '传输层'], createTime: '2026-01-19 20:30', author: '周老师', useCount: 7,
        score: '3', explanation: 'TCP和UDP是传输层协议，HTTP和FTP是应用层协议。',
        options: [
          { label: 'A', text: 'TCP' },
          { label: 'B', text: 'UDP' },
          { label: 'C', text: 'HTTP' },
          { label: 'D', text: 'FTP' }
        ],
        correctAnswers: ['A', 'B']
      },
      {
        id: 'Q019', type: 'multiple', typeName: '多选题', typeIcon: 'fa-check-double', typeColor: 'success',
        difficulty: 4, difficultyName: '四级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '【图片题】根据下图所示的图结构，正确的描述有哪些？<br><br><img src="https://via.placeholder.com/400x200/dcfce7/166534?text=Graph+Structure%0AA--B--C%0A|++|++|%0AD--E--F" alt="图结构" style="max-width:100%;border-radius:8px;border:1px solid #e5e7eb;">',
        tags: ['图论', '图片题'], createTime: '2026-01-20 09:30', author: '李老师', useCount: 5,
        score: '4', explanation: '图的分析需要考虑连通性、度数和路径。',
        options: [
          { label: 'A', text: '该图是连通图' },
          { label: 'B', text: '该图是有向图' },
          { label: 'C', text: '节点B的度为3' },
          { label: 'D', text: '该图包含环' }
        ],
        correctAnswers: ['A', 'C', 'D']
      },
      {
        id: 'Q020', type: 'multiple', typeName: '多选题', typeIcon: 'fa-check-double', typeColor: 'success',
        difficulty: 3, difficultyName: '三级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '【公式题】关于排序算法的时间复杂度，以下说法正确的有？<br><br>快速排序平均：<code>O(n log n)</code><br>冒泡排序：<code>O(n²)</code><br>归并排序：<code>O(n log n)</code>',
        tags: ['排序', '复杂度', '公式题'], createTime: '2026-01-20 10:30', author: '赵老师', useCount: 6,
        score: '3', explanation: '不同排序算法有不同的时间复杂度特性。',
        options: [
          { label: 'A', text: '快速排序最坏情况是O(n²)' },
          { label: 'B', text: '归并排序是稳定排序' },
          { label: 'C', text: '冒泡排序最好情况是O(n)' },
          { label: 'D', text: '堆排序空间复杂度是O(n)' }
        ],
        correctAnswers: ['A', 'B', 'C']
      },
      // ==================== 判断题（10道）====================
      {
        id: 'Q021', type: 'judge', typeName: '判断题', typeIcon: 'fa-check', typeColor: 'warning',
        difficulty: 1, difficultyName: '一级', knowledgeId: '41', knowledgePath: '网络技术 / 网络协议',
        content: 'HTTP协议是无状态协议。',
        tags: ['HTTP', '协议'], createTime: '2026-01-13 11:15', author: '周老师', useCount: 20,
        score: '1', explanation: 'HTTP协议本身是无状态的，服务器不会保存客户端的状态信息。',
        correctAnswer: 'true'
      },
      {
        id: 'Q022', type: 'judge', typeName: '判断题', typeIcon: 'fa-check', typeColor: 'warning',
        difficulty: 1, difficultyName: '一级', knowledgeId: '11', knowledgePath: '计算机基础 / 计算机系统',
        content: 'CPU是计算机的核心部件，负责执行指令和处理数据。',
        tags: ['CPU', '硬件'], createTime: '2026-01-16 11:30', author: '张老师', useCount: 14,
        score: '1', explanation: 'CPU（中央处理器）是计算机的核心，负责执行程序指令和处理数据。',
        correctAnswer: 'true'
      },
      {
        id: 'Q023', type: 'judge', typeName: '判断题', typeIcon: 'fa-check', typeColor: 'warning',
        difficulty: 1, difficultyName: '一级', knowledgeId: '21', knowledgePath: '编程语言 / Python基础',
        content: 'Python是一种解释型编程语言。',
        tags: ['Python', '语言特性'], createTime: '2026-01-16 16:40', author: '李老师', useCount: 16,
        score: '1', explanation: 'Python是解释型语言，代码在运行时由解释器逐行执行。',
        correctAnswer: 'true'
      },
      {
        id: 'Q024', type: 'judge', typeName: '判断题', typeIcon: 'fa-check', typeColor: 'warning',
        difficulty: 1, difficultyName: '一级', knowledgeId: '31', knowledgePath: '数据库 / SQL语法',
        content: 'SELECT语句中WHERE子句用于分组。',
        tags: ['SQL', '查询'], createTime: '2026-01-17 14:40', author: '王老师', useCount: 15,
        score: '1', explanation: 'WHERE子句用于过滤条件，GROUP BY子句用于分组。',
        correctAnswer: 'false'
      },
      {
        id: 'Q025', type: 'judge', typeName: '判断题', typeIcon: 'fa-check', typeColor: 'warning',
        difficulty: 1, difficultyName: '一级', knowledgeId: '22', knowledgePath: '编程语言 / Java基础',
        content: 'JavaScript是一种单线程语言。',
        tags: ['JavaScript', '特性'], createTime: '2026-01-18 13:15', author: '李老师', useCount: 17,
        score: '1', explanation: 'JavaScript是单线程语言，但通过事件循环机制可以实现异步操作。',
        correctAnswer: 'true'
      },
      {
        id: 'Q026', type: 'judge', typeName: '判断题', typeIcon: 'fa-check', typeColor: 'warning',
        difficulty: 1, difficultyName: '一级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '链表是一种顺序存储的数据结构。',
        tags: ['数据结构', '链表'], createTime: '2026-01-19 10:20', author: '赵老师', useCount: 12,
        score: '1', explanation: '链表是链式存储结构，不是顺序存储。数组才是顺序存储。',
        correctAnswer: 'false'
      },
      {
        id: 'Q027', type: 'judge', typeName: '判断题', typeIcon: 'fa-check', typeColor: 'warning',
        difficulty: 1, difficultyName: '一级', knowledgeId: '32', knowledgePath: '数据库 / 数据库设计',
        content: 'NoSQL数据库不支持事务处理。',
        tags: ['数据库', 'NoSQL'], createTime: '2026-01-19 16:55', author: '王老师', useCount: 14,
        score: '1', explanation: '部分NoSQL数据库支持事务处理，如MongoDB 4.0+支持多文档事务。',
        correctAnswer: 'false'
      },
      {
        id: 'Q028', type: 'judge', typeName: '判断题', typeIcon: 'fa-check', typeColor: 'warning',
        difficulty: 2, difficultyName: '二级', knowledgeId: '42', knowledgePath: '网络技术 / 网络安全',
        content: 'HTTPS使用SSL/TLS协议进行加密传输。',
        tags: ['HTTPS', '加密'], createTime: '2026-01-20 09:00', author: '周老师', useCount: 10,
        score: '1', explanation: 'HTTPS = HTTP + SSL/TLS，通过加密保证数据传输安全。',
        correctAnswer: 'true'
      },
      {
        id: 'Q029', type: 'judge', typeName: '判断题', typeIcon: 'fa-check', typeColor: 'warning',
        difficulty: 2, difficultyName: '二级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '【图片题】下图展示的是一棵平衡二叉树。<br><br><img src="https://via.placeholder.com/300x200/fef3c7/d97706?text=Binary+Tree%0A++++5%0A+++/+%5C%0A++3+++8%0A+/+%5C%0A1+++4" alt="二叉树" style="max-width:100%;border-radius:8px;border:1px solid #e5e7eb;">',
        tags: ['二叉树', '图片题'], createTime: '2026-01-20 10:00', author: '赵老师', useCount: 5,
        score: '1', explanation: '该树左右子树高度差不超过1，是平衡二叉树（AVL树）。',
        correctAnswer: 'true'
      },
      {
        id: 'Q030', type: 'judge', typeName: '判断题', typeIcon: 'fa-check', typeColor: 'warning',
        difficulty: 2, difficultyName: '二级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '【公式题】二分查找的时间复杂度为 <code>O(log n)</code>，其中 n 为数组长度。',
        tags: ['查找', '复杂度', '公式题'], createTime: '2026-01-20 11:00', author: '赵老师', useCount: 8,
        score: '1', explanation: '二分查找每次将搜索范围减半，时间复杂度为 O(log₂n)。',
        correctAnswer: 'true'
      },
      // ==================== 填空题（10道）====================
      {
        id: 'Q031', type: 'blank', typeName: '填空题', typeIcon: 'fa-pen', typeColor: 'primary',
        difficulty: 2, difficultyName: '二级', knowledgeId: '31', knowledgePath: '数据库 / SQL语法',
        content: 'SQL中用于查询数据的关键字是_____。',
        tags: ['SQL', '查询'], createTime: '2026-01-14 09:30', author: '王老师', useCount: 15,
        score: '2', explanation: 'SELECT是SQL中最基本的查询语句。',
        blanks: [{ index: 1, answer: 'SELECT', score: 2 }]
      },
      {
        id: 'Q032', type: 'blank', typeName: '填空题', typeIcon: 'fa-pen', typeColor: 'primary',
        difficulty: 2, difficultyName: '二级', knowledgeId: '22', knowledgePath: '编程语言 / Java基础',
        content: 'Java中的_____关键字用于定义常量。',
        tags: ['Java', '关键字'], createTime: '2026-01-16 13:45', author: '孙老师', useCount: 11,
        score: '2', explanation: 'final关键字用于定义常量，被final修饰的变量不能被重新赋值。',
        blanks: [{ index: 1, answer: 'final', score: 2 }]
      },
      {
        id: 'Q033', type: 'blank', typeName: '填空题', typeIcon: 'fa-pen', typeColor: 'primary',
        difficulty: 2, difficultyName: '二级', knowledgeId: '11', knowledgePath: '计算机基础 / 计算机系统',
        content: '计算机的五大基本组成部分包括：运算器、控制器、存储器、_____和输出设备。',
        tags: ['计算机系统', '组成'], createTime: '2026-01-18 09:10', author: '张老师', useCount: 11,
        score: '2', explanation: '计算机五大部件：运算器、控制器、存储器、输入设备、输出设备。',
        blanks: [{ index: 1, answer: '输入设备', score: 2 }]
      },
      {
        id: 'Q034', type: 'blank', typeName: '填空题', typeIcon: 'fa-pen', typeColor: 'primary',
        difficulty: 2, difficultyName: '二级', knowledgeId: '41', knowledgePath: '网络技术 / 网络协议',
        content: 'TCP/IP模型中，负责端到端通信的是_____层。',
        tags: ['网络协议', 'TCP/IP'], createTime: '2026-01-18 15:45', author: '周老师', useCount: 13,
        score: '2', explanation: '传输层负责端到端的通信，主要协议有TCP和UDP。',
        blanks: [{ index: 1, answer: '传输', score: 2 }]
      },
      {
        id: 'Q035', type: 'blank', typeName: '填空题', typeIcon: 'fa-pen', typeColor: 'primary',
        difficulty: 2, difficultyName: '二级', knowledgeId: '21', knowledgePath: '编程语言 / Python基础',
        content: 'Python中使用_____函数可以获取列表的长度。',
        tags: ['Python', '列表'], createTime: '2026-01-19 19:15', author: '李老师', useCount: 10,
        score: '2', explanation: 'len()函数用于获取序列的长度。',
        blanks: [{ index: 1, answer: 'len', score: 2 }]
      },
      {
        id: 'Q036', type: 'blank', typeName: '填空题', typeIcon: 'fa-pen', typeColor: 'primary',
        difficulty: 2, difficultyName: '二级', knowledgeId: '42', knowledgePath: '网络技术 / 网络安全',
        content: '_____是一种用于验证用户身份的安全机制。',
        tags: ['网络安全', '认证'], createTime: '2026-01-19 14:25', author: '周老师', useCount: 11,
        score: '2', explanation: '身份认证是验证用户身份的安全机制。',
        blanks: [{ index: 1, answer: '身份认证', score: 2 }]
      },
      {
        id: 'Q037', type: 'blank', typeName: '填空题', typeIcon: 'fa-pen', typeColor: 'primary',
        difficulty: 2, difficultyName: '二级', knowledgeId: '12', knowledgePath: '计算机基础 / 操作系统',
        content: '操作系统中，_____是资源分配的基本单位，_____是CPU调度的基本单位。',
        tags: ['操作系统', '进程', '线程'], createTime: '2026-01-20 08:30', author: '张老师', useCount: 9,
        score: '4', explanation: '进程是资源分配的基本单位，线程是CPU调度的基本单位。',
        blanks: [
          { index: 1, answer: '进程', score: 2 },
          { index: 2, answer: '线程', score: 2 }
        ]
      },
      {
        id: 'Q038', type: 'blank', typeName: '填空题', typeIcon: 'fa-pen', typeColor: 'primary',
        difficulty: 3, difficultyName: '三级', knowledgeId: '32', knowledgePath: '数据库 / 数据库设计',
        content: '数据库事务的四大特性是：原子性、_____、隔离性和持久性。',
        tags: ['数据库', '事务', 'ACID'], createTime: '2026-01-20 09:15', author: '王老师', useCount: 7,
        score: '2', explanation: 'ACID：原子性(Atomicity)、一致性(Consistency)、隔离性(Isolation)、持久性(Durability)。',
        blanks: [{ index: 1, answer: '一致性', score: 2 }]
      },
      {
        id: 'Q039', type: 'blank', typeName: '填空题', typeIcon: 'fa-pen', typeColor: 'primary',
        difficulty: 3, difficultyName: '三级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '【图片题】观察下图的栈操作过程，最终栈顶元素是_____。<br><br><img src="https://via.placeholder.com/350x200/e0e7ff/4338ca?text=Stack+Operations%0Apush(1)+push(2)+push(3)%0Apop()+push(4)" alt="栈操作" style="max-width:100%;border-radius:8px;border:1px solid #e5e7eb;">',
        tags: ['栈', '图片题'], createTime: '2026-01-20 10:00', author: '赵老师', useCount: 4,
        score: '2', explanation: 'push(1),push(2),push(3)后栈为[1,2,3]，pop()后为[1,2]，push(4)后为[1,2,4]，栈顶是4。',
        blanks: [{ index: 1, answer: '4', score: 2 }]
      },
      {
        id: 'Q040', type: 'blank', typeName: '填空题', typeIcon: 'fa-pen', typeColor: 'primary',
        difficulty: 3, difficultyName: '三级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '【公式题】已知数组长度为n，使用二分查找最多需要比较_____次。<br><br>公式：<code>最大比较次数 = ⌊log₂n⌋ + 1</code>',
        tags: ['查找', '公式题'], createTime: '2026-01-20 11:00', author: '赵老师', useCount: 6,
        score: '2', explanation: '二分查找最大比较次数为 ⌊log₂n⌋ + 1。',
        blanks: [{ index: 1, answer: '⌊log₂n⌋ + 1', score: 2 }]
      },
      // ==================== 简答题（10道）====================
      {
        id: 'Q041', type: 'short', typeName: '简答题', typeIcon: 'fa-align-left', typeColor: 'purple',
        difficulty: 3, difficultyName: '三级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '请简述栈和队列的区别。',
        tags: ['数据结构', '栈', '队列'], createTime: '2026-01-13 16:20', author: '赵老师', useCount: 10,
        score: '5', explanation: '栈和队列都是线性数据结构，但操作方式不同。',
        referenceAnswer: '栈是后进先出（LIFO）的数据结构，只能在栈顶进行插入和删除操作；队列是先进先出（FIFO）的数据结构，在队尾插入，在队头删除。'
      },
      {
        id: 'Q042', type: 'short', typeName: '简答题', typeIcon: 'fa-align-left', typeColor: 'purple',
        difficulty: 3, difficultyName: '三级', knowledgeId: '32', knowledgePath: '数据库 / 数据库设计',
        content: '请简述数据库三大范式的主要内容。',
        tags: ['数据库设计', '范式'], createTime: '2026-01-17 09:00', author: '王老师', useCount: 8,
        score: '5', explanation: '数据库范式是设计关系型数据库的规范。',
        referenceAnswer: '第一范式(1NF)：属性不可再分；第二范式(2NF)：在1NF基础上，非主属性完全依赖于主键；第三范式(3NF)：在2NF基础上，非主属性不传递依赖于主键。'
      },
      {
        id: 'Q043', type: 'short', typeName: '简答题', typeIcon: 'fa-align-left', typeColor: 'purple',
        difficulty: 4, difficultyName: '四级', knowledgeId: '12', knowledgePath: '计算机基础 / 操作系统',
        content: '请解释操作系统中的死锁及其产生的四个必要条件。',
        tags: ['操作系统', '死锁'], createTime: '2026-01-18 11:40', author: '张老师', useCount: 5,
        score: '6', explanation: '死锁是操作系统中的重要概念。',
        referenceAnswer: '死锁是指两个或多个进程在执行过程中，因争夺资源而造成的一种互相等待的现象。四个必要条件：1.互斥条件；2.请求与保持条件；3.不可剥夺条件；4.循环等待条件。'
      },
      {
        id: 'Q044', type: 'short', typeName: '简答题', typeIcon: 'fa-align-left', typeColor: 'purple',
        difficulty: 3, difficultyName: '三级', knowledgeId: '31', knowledgePath: '数据库 / SQL语法',
        content: '请说明SQL中JOIN的几种类型及其区别。',
        tags: ['SQL', 'JOIN'], createTime: '2026-01-19 11:35', author: '王老师', useCount: 9,
        score: '5', explanation: 'JOIN是SQL中用于连接多个表的操作。',
        referenceAnswer: 'INNER JOIN：返回两表匹配的行；LEFT JOIN：返回左表所有行，右表匹配的行；RIGHT JOIN：返回右表所有行，左表匹配的行；FULL JOIN：返回两表所有行。'
      },
      {
        id: 'Q045', type: 'short', typeName: '简答题', typeIcon: 'fa-align-left', typeColor: 'purple',
        difficulty: 4, difficultyName: '四级', knowledgeId: '22', knowledgePath: '编程语言 / Java基础',
        content: '请解释JavaScript中的事件循环机制。',
        tags: ['JavaScript', '事件循环'], createTime: '2026-01-19 17:20', author: '李老师', useCount: 4,
        score: '6', explanation: '事件循环是JavaScript实现异步的核心机制。',
        referenceAnswer: '事件循环是JavaScript的执行机制。主线程执行同步代码，异步任务放入任务队列。主线程空闲时，从任务队列取出任务执行。宏任务包括setTimeout等，微任务包括Promise.then等，微任务优先于宏任务执行。'
      },
      {
        id: 'Q046', type: 'short', typeName: '简答题', typeIcon: 'fa-align-left', typeColor: 'purple',
        difficulty: 3, difficultyName: '三级', knowledgeId: '41', knowledgePath: '网络技术 / 网络协议',
        content: '请简述TCP三次握手的过程。',
        tags: ['TCP', '握手'], createTime: '2026-01-20 08:00', author: '周老师', useCount: 12,
        score: '5', explanation: 'TCP三次握手是建立可靠连接的过程。',
        referenceAnswer: '1. 客户端发送SYN包，进入SYN_SENT状态；2. 服务器收到SYN包，发送SYN+ACK包，进入SYN_RCVD状态；3. 客户端收到SYN+ACK包，发送ACK包，双方进入ESTABLISHED状态，连接建立。'
      },
      {
        id: 'Q047', type: 'short', typeName: '简答题', typeIcon: 'fa-align-left', typeColor: 'purple',
        difficulty: 3, difficultyName: '三级', knowledgeId: '21', knowledgePath: '编程语言 / Python基础',
        content: '请解释Python中的装饰器及其用途。',
        tags: ['Python', '装饰器'], createTime: '2026-01-20 09:30', author: '李老师', useCount: 6,
        score: '5', explanation: '装饰器是Python的高级特性。',
        referenceAnswer: '装饰器是一种设计模式，用于在不修改原函数代码的情况下扩展函数功能。它本质上是一个接受函数作为参数并返回新函数的高阶函数。常用于日志记录、性能测试、权限验证等场景。'
      },
      {
        id: 'Q048', type: 'short', typeName: '简答题', typeIcon: 'fa-align-left', typeColor: 'purple',
        difficulty: 3, difficultyName: '三级', knowledgeId: '42', knowledgePath: '网络技术 / 网络安全',
        content: '请简述SQL注入攻击的原理及防范措施。',
        tags: ['网络安全', 'SQL注入'], createTime: '2026-01-20 10:15', author: '周老师', useCount: 8,
        score: '5', explanation: 'SQL注入是常见的Web安全漏洞。',
        referenceAnswer: '原理：攻击者通过在输入中插入恶意SQL代码，使应用程序执行非预期的数据库操作。防范措施：1.使用参数化查询；2.输入验证和过滤；3.最小权限原则；4.使用ORM框架；5.定期安全审计。'
      },
      {
        id: 'Q049', type: 'short', typeName: '简答题', typeIcon: 'fa-align-left', typeColor: 'purple',
        difficulty: 4, difficultyName: '四级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '【图片题】观察下图所示的哈希表结构，请分析哈希冲突的解决方法。<br><br><img src="https://via.placeholder.com/400x200/fef3c7/d97706?text=Hash+Table%0ABucket+0:+10+->+20%0ABucket+1:+11%0ABucket+2:+empty" alt="哈希表" style="max-width:100%;border-radius:8px;border:1px solid #e5e7eb;">',
        tags: ['哈希表', '图片题'], createTime: '2026-01-20 11:00', author: '赵老师', useCount: 4,
        score: '6', explanation: '哈希冲突是哈希表设计中的核心问题。',
        referenceAnswer: '图中使用链地址法解决冲突。当多个键映射到同一桶时，使用链表存储。其他方法包括：1.开放地址法（线性探测、二次探测）；2.再哈希法；3.建立公共溢出区。链地址法优点是删除方便，缺点是需要额外空间存储指针。'
      },
      {
        id: 'Q050', type: 'short', typeName: '简答题', typeIcon: 'fa-align-left', typeColor: 'purple',
        difficulty: 4, difficultyName: '四级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '【公式题】请分析快速排序算法的时间复杂度。<br><br>递推公式：<code>T(n) = 2T(n/2) + O(n)</code>',
        tags: ['排序', '复杂度', '公式题'], createTime: '2026-01-20 11:30', author: '赵老师', useCount: 5,
        score: '6', explanation: '快速排序是重要的排序算法。',
        referenceAnswer: '最好情况：每次划分均匀，T(n)=2T(n/2)+O(n)，由主定理得O(n log n)。最坏情况：每次划分极不均匀（已排序数组），T(n)=T(n-1)+O(n)，得O(n²)。平均情况：O(n log n)。空间复杂度：O(log n)到O(n)。'
      },
      // ==================== 完形填空（10道）====================
      {
        id: 'Q051', type: 'cloze', typeName: '完形填空', typeIcon: 'fa-layer-group', typeColor: 'indigo',
        difficulty: 3, difficultyName: '三级', knowledgeId: '22', knowledgePath: '编程语言 / Java基础',
        content: 'Java面向对象编程特性包括_____、_____和_____。封装是将数据和操作数据的方法绑定在一起；继承允许子类继承父类的属性和方法；多态则是指同一个方法调用可以有不同的执行结果。',
        tags: ['Java', '面向对象'], isComposite: true, subCount: 3,
        createTime: '2026-01-14 16:45', author: '孙老师', useCount: 7,
        score: '6', explanation: 'Java面向对象三大特性是封装、继承、多态。',
        blanks: [
          { index: 1, answer: '封装', score: 2 },
          { index: 2, answer: '继承', score: 2 },
          { index: 3, answer: '多态', score: 2 }
        ]
      },
      {
        id: 'Q052', type: 'cloze', typeName: '完形填空', typeIcon: 'fa-layer-group', typeColor: 'indigo',
        difficulty: 3, difficultyName: '三级', knowledgeId: '41', knowledgePath: '网络技术 / 网络协议',
        content: 'OSI七层模型从下到上依次是：物理层、_____层、网络层、_____层、会话层、表示层和应用层。',
        tags: ['网络协议', 'OSI'], isComposite: true, subCount: 2,
        createTime: '2026-01-15 10:00', author: '周老师', useCount: 10,
        score: '4', explanation: 'OSI七层模型是网络通信的标准参考模型。',
        blanks: [
          { index: 1, answer: '数据链路', score: 2 },
          { index: 2, answer: '传输', score: 2 }
        ]
      },
      {
        id: 'Q053', type: 'cloze', typeName: '完形填空', typeIcon: 'fa-layer-group', typeColor: 'indigo',
        difficulty: 2, difficultyName: '二级', knowledgeId: '21', knowledgePath: '编程语言 / Python基础',
        content: 'Python中的基本数据类型包括：整数(_____)、浮点数(_____)、字符串(_____)和布尔值(bool)。',
        tags: ['Python', '数据类型'], isComposite: true, subCount: 3,
        createTime: '2026-01-16 09:30', author: '李老师', useCount: 8,
        score: '6', explanation: 'Python的基本数据类型是编程基础。',
        blanks: [
          { index: 1, answer: 'int', score: 2 },
          { index: 2, answer: 'float', score: 2 },
          { index: 3, answer: 'str', score: 2 }
        ]
      },
      {
        id: 'Q054', type: 'cloze', typeName: '完形填空', typeIcon: 'fa-layer-group', typeColor: 'indigo',
        difficulty: 3, difficultyName: '三级', knowledgeId: '31', knowledgePath: '数据库 / SQL语法',
        content: 'SQL语句的基本结构：_____用于查询数据，_____用于插入数据，_____用于更新数据，DELETE用于删除数据。',
        tags: ['SQL', '基础'], isComposite: true, subCount: 3,
        createTime: '2026-01-17 14:00', author: '王老师', useCount: 12,
        score: '6', explanation: 'SQL的四大基本操作：SELECT、INSERT、UPDATE、DELETE。',
        blanks: [
          { index: 1, answer: 'SELECT', score: 2 },
          { index: 2, answer: 'INSERT', score: 2 },
          { index: 3, answer: 'UPDATE', score: 2 }
        ]
      },
      {
        id: 'Q055', type: 'cloze', typeName: '完形填空', typeIcon: 'fa-layer-group', typeColor: 'indigo',
        difficulty: 3, difficultyName: '三级', knowledgeId: '12', knowledgePath: '计算机基础 / 操作系统',
        content: '进程的三种基本状态是：_____态、_____态和_____态。进程在这三种状态之间转换。',
        tags: ['操作系统', '进程'], isComposite: true, subCount: 3,
        createTime: '2026-01-18 11:00', author: '张老师', useCount: 9,
        score: '6', explanation: '进程的三种基本状态：就绪、运行、阻塞。',
        blanks: [
          { index: 1, answer: '就绪', score: 2 },
          { index: 2, answer: '运行', score: 2 },
          { index: 3, answer: '阻塞', score: 2 }
        ]
      },
      {
        id: 'Q056', type: 'cloze', typeName: '完形填空', typeIcon: 'fa-layer-group', typeColor: 'indigo',
        difficulty: 3, difficultyName: '三级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '常见的排序算法包括：_____排序、_____排序、快速排序、归并排序等。其中冒泡排序的时间复杂度为O(n²)。',
        tags: ['排序', '算法'], isComposite: true, subCount: 2,
        createTime: '2026-01-19 10:30', author: '赵老师', useCount: 7,
        score: '4', explanation: '排序算法是数据结构的重要内容。',
        blanks: [
          { index: 1, answer: '冒泡', score: 2 },
          { index: 2, answer: '选择', score: 2 }
        ]
      },
      {
        id: 'Q057', type: 'cloze', typeName: '完形填空', typeIcon: 'fa-layer-group', typeColor: 'indigo',
        difficulty: 3, difficultyName: '三级', knowledgeId: '42', knowledgePath: '网络技术 / 网络安全',
        content: '常见的网络攻击类型包括：_____攻击、_____攻击、SQL注入攻击等。防范措施包括使用防火墙、加密传输等。',
        tags: ['网络安全', '攻击'], isComposite: true, subCount: 2,
        createTime: '2026-01-19 15:00', author: '周老师', useCount: 6,
        score: '4', explanation: '了解网络攻击类型有助于做好安全防护。',
        blanks: [
          { index: 1, answer: 'DDoS', score: 2 },
          { index: 2, answer: 'XSS', score: 2 }
        ]
      },
      {
        id: 'Q058', type: 'cloze', typeName: '完形填空', typeIcon: 'fa-layer-group', typeColor: 'indigo',
        difficulty: 2, difficultyName: '二级', knowledgeId: '32', knowledgePath: '数据库 / 数据库设计',
        content: '数据库的完整性约束包括：_____完整性、_____完整性和用户定义完整性。',
        tags: ['数据库', '完整性'], isComposite: true, subCount: 2,
        createTime: '2026-01-20 08:00', author: '王老师', useCount: 5,
        score: '4', explanation: '数据库完整性是保证数据正确性的重要机制。',
        blanks: [
          { index: 1, answer: '实体', score: 2 },
          { index: 2, answer: '参照', score: 2 }
        ]
      },
      {
        id: 'Q059', type: 'cloze', typeName: '完形填空', typeIcon: 'fa-layer-group', typeColor: 'indigo',
        difficulty: 3, difficultyName: '三级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '【图片题】观察下图的二叉树，其前序遍历结果是：_____、B、D、E、_____、F。<br><br><img src="https://via.placeholder.com/300x180/e0f2fe/0369a1?text=Tree:+A-B-C%0AB:D,E++C:F" alt="二叉树" style="max-width:100%;border-radius:8px;border:1px solid #e5e7eb;">',
        tags: ['二叉树', '图片题'], isComposite: true, subCount: 2,
        createTime: '2026-01-20 09:30', author: '赵老师', useCount: 4,
        score: '4', explanation: '前序遍历：根-左-右。',
        blanks: [
          { index: 1, answer: 'A', score: 2 },
          { index: 2, answer: 'C', score: 2 }
        ]
      },
      {
        id: 'Q060', type: 'cloze', typeName: '完形填空', typeIcon: 'fa-layer-group', typeColor: 'indigo',
        difficulty: 3, difficultyName: '三级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '【公式题】斐波那契数列的递推公式为：F(n) = F(_____) + F(_____)，其中F(0)=0，F(1)=1。',
        tags: ['递归', '公式题'], isComposite: true, subCount: 2,
        createTime: '2026-01-20 10:30', author: '赵老师', useCount: 5,
        score: '4', explanation: '斐波那契数列：0,1,1,2,3,5,8,13...',
        blanks: [
          { index: 1, answer: 'n-1', score: 2 },
          { index: 2, answer: 'n-2', score: 2 }
        ]
      },
      // ==================== 复合题（10道，含1道图片题Q069、1道公式题Q070）====================
      {
        id: 'Q061', type: 'composite', typeName: '复合题', typeIcon: 'fa-list-alt', typeColor: 'purple',
        difficulty: 4, difficultyName: '四级', knowledgeId: '32', knowledgePath: '数据库 / 数据库设计',
        content: '某公司数据库设计方案：用户表包含30个字段，包括姓名、身份证号、电话、地址、邮箱等信息。订单表包含订单编号、用户ID、订单时间、订单金额、商品详情、收货地址、支付方式等。请分析该设计是否符合数据库范式要求，并指出存在的问题及优化建议。',
        tags: ['数据库设计', '范式'], isComposite: true, subCount: 3,
        createTime: '2026-01-14 09:30', author: '王老师', useCount: 6,
        score: '15', explanation: '数据库设计应遵循范式要求，避免数据冗余。',
        subQuestions: [
          { id: 1, type: 'single', content: '该设计违反了第几范式？', score: 3, options: [{ label: 'A', text: '第一范式' }, { label: 'B', text: '第二范式' }, { label: 'C', text: '第三范式' }, { label: 'D', text: '都不违反' }], correctAnswers: ['C'], explanation: '收货地址在订单表中重复存储，违反第三范式。' },
          { id: 2, type: 'short', content: '请指出用户表设计存在的问题。', score: 5, referenceAnswer: '用户表字段过多，应该进行垂直拆分，将常用字段和不常用字段分开存储。', explanation: '' },
          { id: 3, type: 'short', content: '请给出优化建议。', score: 7, referenceAnswer: '1. 将用户表拆分为基本信息表和扩展信息表；2. 将收货地址单独建表，通过外键关联；3. 商品详情应该关联商品表而不是直接存储。', explanation: '' }
        ]
      },
      {
        id: 'Q062', type: 'composite', typeName: '复合题', typeIcon: 'fa-list-alt', typeColor: 'purple',
        difficulty: 3, difficultyName: '三级', knowledgeId: '12', knowledgePath: '计算机基础 / 操作系统',
        content: '阅读以下关于进程调度的材料，回答问题。<br><br>某操作系统采用时间片轮转调度算法，时间片大小为20ms。当前就绪队列中有三个进程P1、P2、P3，它们的到达时间和服务时间如下表所示。',
        tags: ['操作系统', '进程调度'], isComposite: true, subCount: 3,
        createTime: '2026-01-15 10:00', author: '张老师', useCount: 8,
        score: '12', explanation: '时间片轮转是常用的进程调度算法。',
        subQuestions: [
          { id: 1, type: 'single', content: '时间片轮转调度算法属于哪种类型？', score: 3, options: [{ label: 'A', text: '非抢占式调度' }, { label: 'B', text: '抢占式调度' }, { label: 'C', text: '优先级调度' }, { label: 'D', text: '批处理调度' }], correctAnswers: ['B'], explanation: '时间片轮转是抢占式调度，时间片用完后进程被强制切换。' },
          { id: 2, type: 'blank', content: '如果时间片过小，会导致_____开销增大。', blanks: [{ index: 1, answer: '上下文切换', score: 3 }], explanation: '时间片过小会频繁切换进程，增加上下文切换开销。' },
          { id: 3, type: 'short', content: '请分析时间片大小对系统性能的影响。', score: 6, referenceAnswer: '时间片过大：退化为FCFS，响应时间长；时间片过小：上下文切换频繁，系统开销大；合适的时间片：平衡响应时间和系统开销。', explanation: '' }
        ]
      },
      {
        id: 'Q063', type: 'composite', typeName: '复合题', typeIcon: 'fa-list-alt', typeColor: 'purple',
        difficulty: 3, difficultyName: '三级', knowledgeId: '21', knowledgePath: '编程语言 / Python基础',
        content: '阅读以下Python代码片段，回答问题。<br><br><pre>def process_data(data):\n    result = []\n    for item in data:\n        if item > 0:\n            result.append(item * 2)\n    return result</pre>',
        tags: ['Python', '函数'], isComposite: true, subCount: 3,
        createTime: '2026-01-16 09:15', author: '李老师', useCount: 5,
        score: '10', explanation: '理解Python函数和列表操作。',
        subQuestions: [
          { id: 1, type: 'single', content: '该函数的返回值类型是？', score: 2, options: [{ label: 'A', text: '整数' }, { label: 'B', text: '字符串' }, { label: 'C', text: '列表' }, { label: 'D', text: '字典' }], correctAnswers: ['C'], explanation: '函数返回result，是一个列表。' },
          { id: 2, type: 'blank', content: '如果输入data=[1,-2,3,-4,5]，输出结果的长度是_____。', blanks: [{ index: 1, answer: '3', score: 3 }], explanation: '只有正数1,3,5会被处理，所以长度为3。' },
          { id: 3, type: 'short', content: '请用列表推导式重写该函数。', score: 5, referenceAnswer: 'def process_data(data):\n    return [item * 2 for item in data if item > 0]', explanation: '' }
        ]
      },
      {
        id: 'Q064', type: 'composite', typeName: '复合题', typeIcon: 'fa-list-alt', typeColor: 'purple',
        difficulty: 3, difficultyName: '三级', knowledgeId: '31', knowledgePath: '数据库 / SQL语法',
        content: '阅读以下SQL查询需求，回答问题。<br><br>有一个学生成绩表scores，包含字段：student_id, course_id, score。需要查询每个学生的平均成绩，并按平均成绩降序排列。',
        tags: ['SQL', '聚合查询'], isComposite: true, subCount: 3,
        createTime: '2026-01-16 10:20', author: '王老师', useCount: 9,
        score: '12', explanation: 'SQL聚合查询是数据库操作的重要内容。',
        subQuestions: [
          { id: 1, type: 'single', content: '计算平均成绩应使用哪个聚合函数？', score: 2, options: [{ label: 'A', text: 'COUNT' }, { label: 'B', text: 'SUM' }, { label: 'C', text: 'AVG' }, { label: 'D', text: 'MAX' }], correctAnswers: ['C'], explanation: 'AVG函数用于计算平均值。' },
          { id: 2, type: 'blank', content: '按学生分组应使用_____子句。', blanks: [{ index: 1, answer: 'GROUP BY', score: 3 }], explanation: 'GROUP BY用于分组聚合。' },
          { id: 3, type: 'short', content: '请写出完整的SQL查询语句。', score: 7, referenceAnswer: 'SELECT student_id, AVG(score) as avg_score FROM scores GROUP BY student_id ORDER BY avg_score DESC;', explanation: '' }
        ]
      },
      {
        id: 'Q065', type: 'composite', typeName: '复合题', typeIcon: 'fa-list-alt', typeColor: 'purple',
        difficulty: 3, difficultyName: '三级', knowledgeId: '41', knowledgePath: '网络技术 / 网络协议',
        content: '阅读以下关于HTTP协议的材料，回答问题。<br><br>HTTP是超文本传输协议，是Web应用的基础。HTTP/1.1引入了持久连接，HTTP/2引入了多路复用，HTTP/3基于QUIC协议。',
        tags: ['HTTP', '网络协议'], isComposite: true, subCount: 3,
        createTime: '2026-01-17 14:00', author: '周老师', useCount: 7,
        score: '10', explanation: 'HTTP协议是Web开发的基础知识。',
        subQuestions: [
          { id: 1, type: 'single', content: 'HTTP协议默认使用的端口号是？', score: 2, options: [{ label: 'A', text: '21' }, { label: 'B', text: '22' }, { label: 'C', text: '80' }, { label: 'D', text: '443' }], correctAnswers: ['C'], explanation: 'HTTP默认端口80，HTTPS默认端口443。' },
          { id: 2, type: 'multiple', content: '以下哪些是HTTP请求方法？', score: 4, options: [{ label: 'A', text: 'GET' }, { label: 'B', text: 'POST' }, { label: 'C', text: 'SELECT' }, { label: 'D', text: 'DELETE' }], correctAnswers: ['A', 'B', 'D'], explanation: 'SELECT是SQL关键字，不是HTTP方法。' },
          { id: 3, type: 'short', content: '请简述HTTP/2相比HTTP/1.1的主要改进。', score: 4, referenceAnswer: '1. 多路复用：单个连接可并行处理多个请求；2. 头部压缩：减少传输数据量；3. 服务器推送：主动推送资源；4. 二进制分帧：提高解析效率。', explanation: '' }
        ]
      },
      {
        id: 'Q066', type: 'composite', typeName: '复合题', typeIcon: 'fa-list-alt', typeColor: 'purple',
        difficulty: 4, difficultyName: '四级', knowledgeId: '22', knowledgePath: '编程语言 / Java基础',
        content: '阅读以下Java代码，分析其中的设计模式和面向对象特性。<br><br><pre>public interface Shape {\n    double area();\n}\n\npublic class Circle implements Shape {\n    private double radius;\n    public Circle(double r) { this.radius = r; }\n    public double area() { return Math.PI * radius * radius; }\n}</pre>',
        tags: ['Java', '面向对象'], isComposite: true, subCount: 3,
        createTime: '2026-01-18 10:00', author: '孙老师', useCount: 6,
        score: '12', explanation: 'Java面向对象编程的核心概念。',
        subQuestions: [
          { id: 1, type: 'single', content: 'Shape是什么类型？', score: 3, options: [{ label: 'A', text: '抽象类' }, { label: 'B', text: '接口' }, { label: 'C', text: '普通类' }, { label: 'D', text: '枚举' }], correctAnswers: ['B'], explanation: 'interface关键字定义接口。' },
          { id: 2, type: 'blank', content: 'Circle类通过_____关键字实现Shape接口。', blanks: [{ index: 1, answer: 'implements', score: 3 }], explanation: 'implements用于实现接口。' },
          { id: 3, type: 'short', content: '请说明这种设计体现了哪些面向对象原则。', score: 6, referenceAnswer: '1. 接口隔离原则：Shape接口只定义必要的方法；2. 依赖倒置原则：依赖抽象而非具体实现；3. 开闭原则：可以添加新的Shape实现而不修改现有代码。', explanation: '' }
        ]
      },
      {
        id: 'Q067', type: 'composite', typeName: '复合题', typeIcon: 'fa-list-alt', typeColor: 'purple',
        difficulty: 4, difficultyName: '四级', knowledgeId: '42', knowledgePath: '网络技术 / 网络安全',
        content: '阅读以下关于Web安全的材料，回答问题。<br><br>某网站存在安全漏洞，攻击者可以在评论区输入恶意脚本，当其他用户浏览该页面时，脚本会在用户浏览器中执行。',
        tags: ['网络安全', 'XSS'], isComposite: true, subCount: 3,
        createTime: '2026-01-19 15:00', author: '周老师', useCount: 5,
        score: '12', explanation: 'Web安全是开发者必须掌握的知识。',
        subQuestions: [
          { id: 1, type: 'single', content: '这种攻击方式称为？', score: 3, options: [{ label: 'A', text: 'SQL注入' }, { label: 'B', text: 'XSS攻击' }, { label: 'C', text: 'CSRF攻击' }, { label: 'D', text: 'DDoS攻击' }], correctAnswers: ['B'], explanation: 'XSS（跨站脚本攻击）是在网页中注入恶意脚本。' },
          { id: 2, type: 'multiple', content: '以下哪些是防范XSS的有效措施？', score: 4, options: [{ label: 'A', text: '输入过滤' }, { label: 'B', text: '输出编码' }, { label: 'C', text: '使用HTTPS' }, { label: 'D', text: 'CSP策略' }], correctAnswers: ['A', 'B', 'D'], explanation: 'HTTPS主要防止中间人攻击，对XSS防护有限。' },
          { id: 3, type: 'short', content: '请说明存储型XSS和反射型XSS的区别。', score: 5, referenceAnswer: '存储型XSS：恶意脚本存储在服务器数据库中，每次访问页面都会执行；反射型XSS：恶意脚本通过URL参数传递，只在点击特定链接时执行。存储型危害更大，影响范围更广。', explanation: '' }
        ]
      },
      {
        id: 'Q068', type: 'composite', typeName: '复合题', typeIcon: 'fa-list-alt', typeColor: 'purple',
        difficulty: 4, difficultyName: '四级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '阅读以下关于排序算法的材料，回答问题。<br><br>快速排序是一种高效的排序算法，采用分治策略。选择一个基准元素，将数组分为两部分，左边小于基准，右边大于基准，然后递归排序。',
        tags: ['排序', '算法'], isComposite: true, subCount: 3,
        createTime: '2026-01-20 08:00', author: '赵老师', useCount: 8,
        score: '12', explanation: '快速排序是重要的排序算法。',
        subQuestions: [
          { id: 1, type: 'single', content: '快速排序的平均时间复杂度是？', score: 3, options: [{ label: 'A', text: 'O(n)' }, { label: 'B', text: 'O(n log n)' }, { label: 'C', text: 'O(n²)' }, { label: 'D', text: 'O(log n)' }], correctAnswers: ['B'], explanation: '快速排序平均时间复杂度为O(n log n)。' },
          { id: 2, type: 'blank', content: '快速排序最坏情况发生在数组已经_____时。', blanks: [{ index: 1, answer: '有序', score: 3 }], explanation: '数组有序时，每次划分极不均匀，退化为O(n²)。' },
          { id: 3, type: 'short', content: '请说明如何优化快速排序以避免最坏情况。', score: 6, referenceAnswer: '1. 随机选择基准：避免固定选择第一个或最后一个元素；2. 三数取中：取首、中、尾三个元素的中值作为基准；3. 小数组使用插入排序：当子数组较小时切换到插入排序。', explanation: '' }
        ]
      },
      {
        id: 'Q069', type: 'composite', typeName: '复合题', typeIcon: 'fa-list-alt', typeColor: 'purple',
        difficulty: 4, difficultyName: '四级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '【图片题】观察下图所示的二叉搜索树，回答问题。<br><br><img src="https://via.placeholder.com/400x250/e0f2fe/0369a1?text=BST%0A++++8%0A+++/+%5C%0A++3+++10%0A+/+%5C++++%5C%0A1+++6+++14" alt="二叉搜索树" style="max-width:100%;border-radius:8px;border:1px solid #e5e7eb;">',
        tags: ['二叉树', '图片题'], isComposite: true, subCount: 3,
        createTime: '2026-01-20 09:00', author: '赵老师', useCount: 4,
        score: '12', explanation: '二叉搜索树是重要的数据结构。',
        subQuestions: [
          { id: 1, type: 'single', content: '该树的中序遍历结果是？', score: 3, options: [{ label: 'A', text: '8,3,1,6,10,14' }, { label: 'B', text: '1,3,6,8,10,14' }, { label: 'C', text: '1,6,3,14,10,8' }, { label: 'D', text: '8,3,10,1,6,14' }], correctAnswers: ['B'], explanation: '二叉搜索树的中序遍历结果是升序序列。' },
          { id: 2, type: 'blank', content: '在该树中查找元素6需要比较_____次。', blanks: [{ index: 1, answer: '3', score: 3 }], explanation: '查找路径：8→3→6，共比较3次。' },
          { id: 3, type: 'short', content: '请说明如何在该树中插入元素5。', score: 6, referenceAnswer: '插入步骤：1. 从根节点8开始，5<8，向左走到3；2. 5>3，向右走到6；3. 5<6，向左，发现左子树为空；4. 将5作为6的左子节点插入。最终5成为节点6的左孩子。', explanation: '' }
        ]
      },
      {
        id: 'Q070', type: 'composite', typeName: '复合题', typeIcon: 'fa-list-alt', typeColor: 'purple',
        difficulty: 5, difficultyName: '五级', knowledgeId: '13', knowledgePath: '计算机基础 / 数据结构',
        content: '【公式题】分析以下递归算法的时间复杂度。<br><br><pre>def fib(n):\n    if n <= 1:\n        return n\n    return fib(n-1) + fib(n-2)</pre><br><br>递推关系式：<code>T(n) = T(n-1) + T(n-2) + O(1)</code>',
        tags: ['递归', '复杂度', '公式题'], isComposite: true, subCount: 3,
        createTime: '2026-01-20 10:00', author: '赵老师', useCount: 5,
        score: '15', explanation: '递归算法的复杂度分析是重要技能。',
        subQuestions: [
          { id: 1, type: 'single', content: '该算法的时间复杂度是？', score: 4, options: [{ label: 'A', text: 'O(n)' }, { label: 'B', text: 'O(n log n)' }, { label: 'C', text: 'O(2ⁿ)' }, { label: 'D', text: 'O(n²)' }], correctAnswers: ['C'], explanation: '递归树呈指数增长，时间复杂度为O(2ⁿ)。' },
          { id: 2, type: 'blank', content: '使用动态规划优化后，时间复杂度可降为O(_____)。', blanks: [{ index: 1, answer: 'n', score: 4 }], explanation: '动态规划避免重复计算，时间复杂度为O(n)。' },
          { id: 3, type: 'short', content: '请用动态规划重写该算法，并分析空间复杂度。', score: 7, referenceAnswer: 'def fib_dp(n):\n    if n <= 1: return n\n    dp = [0] * (n+1)\n    dp[1] = 1\n    for i in range(2, n+1):\n        dp[i] = dp[i-1] + dp[i-2]\n    return dp[n]\n\n空间复杂度O(n)。进一步优化只保留前两个值，空间复杂度可降为O(1)。', explanation: '' }
        ]
      }
    ];

    let filteredQuestions = [...allQuestions];

    // 分页变量
    let currentPage = 1;
    const pageSize = 20;

    let nextId = 100; // 用于生成新节点的ID
    let draggedNode = null; // 被拖拽的节点
    let draggedNodeParent = null; // 被拖拽节点的父节点
    let moveTargetNode = null; // 移动目标节点

    // ==================== 渲染函数 ====================

    // 渲染整个知识点树
    function renderKnowledgeTree() {
      const container = document.getElementById('knowledgeTreeContainer');
      container.innerHTML = '';

      // 如果有搜索关键词，过滤节点
      const nodesToRender = searchKeyword
        ? knowledgeTree.filter(node => matchesSearch(node, searchKeyword))
        : knowledgeTree;

      nodesToRender.forEach((node, index) => {
        container.appendChild(createNodeElement(node, null, index));
      });

      // 如果搜索后没有结果，显示提示
      if (nodesToRender.length === 0 && searchKeyword) {
        const noResult = document.createElement('div');
        noResult.className = 'text-center text-gray-400 py-8';
        noResult.innerHTML = '<i class="fas fa-search text-2xl mb-2"></i><p class="text-sm">未找到匹配的知识点</p>';
        container.appendChild(noResult);
      }
    }

    // 创建节点元素（递归）
    function createNodeElement(node, parentNode, index) {
      const wrapper = document.createElement('div');
      wrapper.className = 'knowledge-node-wrapper';
      wrapper.dataset.nodeId = node.id;

      // 主节点
      const nodeDiv = document.createElement('div');
      nodeDiv.className = 'tree-item px-3 py-2 rounded-lg cursor-pointer flex items-center justify-between group relative';
      nodeDiv.draggable = true;
      nodeDiv.dataset.nodeId = node.id;

      // 设置拖拽事件
      nodeDiv.addEventListener('dragstart', (e) => handleDragStart(e, node, parentNode));
      nodeDiv.addEventListener('dragover', (e) => handleDragOver(e));
      nodeDiv.addEventListener('drop', (e) => handleDrop(e, node));
      nodeDiv.addEventListener('dragend', () => handleDragEnd());

      // 点击节点筛选题目
      nodeDiv.addEventListener('click', function() {
        selectKnowledgeNode(node.id, node.name);
        nodeDiv.classList.add('active');
      });

      // 左侧内容
      const leftDiv = document.createElement('div');
      leftDiv.className = 'flex items-center space-x-2 flex-1 min-w-0';

      // 如果有子节点，显示展开/收起图标
      if (node.children && node.children.length > 0) {
        const chevron = document.createElement('i');
        // 搜索时自动展开，显示向下箭头
        const isExpanded = searchKeyword ? true : !node.collapsed;
        chevron.className = `fas ${isExpanded ? 'fa-chevron-down' : 'fa-chevron-right'} text-xs text-gray-400 transition-transform`;
        chevron.onclick = (e) => {
          e.stopPropagation();
          // 搜索模式下不允许折叠
          if (!searchKeyword) {
            toggleNode(node.id);
          }
        };
        leftDiv.appendChild(chevron);
      } else {
        // 空白占位
        const spacer = document.createElement('span');
        spacer.style.width = '12px';
        leftDiv.appendChild(spacer);
      }

      // 图标：目录用文件夹，知识点用书本
      const icon = document.createElement('i');
      const colors = ['text-warning-500', 'text-info-500', 'text-success-500', 'text-error-500', 'text-purple-500'];
      if (node.type === 'knowledge') {
        // 知识点用书本图标
        icon.className = `fas fa-book text-primary-500`;
      } else {
        // 目录用文件夹图标
        icon.className = `fas fa-folder ${colors[index % colors.length]}`;
      }
      leftDiv.appendChild(icon);

      // 名称（可编辑）
      const nameSpan = document.createElement('span');
      nameSpan.className = 'text-sm node-name truncate';

      // 如果有搜索关键词，高亮显示
      if (searchKeyword && node.name.toLowerCase().includes(searchKeyword)) {
        const regex = new RegExp(`(${searchKeyword})`, 'gi');
        const highlightedName = node.name.replace(regex, '<mark class="bg-yellow-200 text-gray-900">$1</mark>');
        nameSpan.innerHTML = highlightedName;
      } else {
        nameSpan.textContent = node.name;
      }

      nameSpan.dataset.nodeId = node.id;
      leftDiv.appendChild(nameSpan);

      // 编辑输入框（隐藏）
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'hidden text-sm px-2 py-1 border border-primary-500 rounded focus:outline-none focus:ring-1 focus:ring-primary-500 node-input';
      input.value = node.name;
      input.dataset.nodeId = node.id;
      input.addEventListener('blur', () => finishEditing(node.id));
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          finishEditing(node.id);
        } else if (e.key === 'Escape') {
          cancelEditing(node.id);
        }
      });
      leftDiv.appendChild(input);

      nodeDiv.appendChild(leftDiv);

      // 右侧操作按钮
      const rightDiv = document.createElement('div');
      rightDiv.className = 'flex items-center space-x-2 flex-shrink-0';

      // 题目数量（悬停时隐藏）
      const countSpan = document.createElement('span');
      countSpan.className = 'text-xs text-gray-500 group-hover:hidden';
      countSpan.textContent = node.count || 0;
      rightDiv.appendChild(countSpan);

      // 操作按钮组（悬停显示，使用绝对定位避免撑开宽度）
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'hidden group-hover:flex items-center space-x-1 absolute right-2 top-1/2 -translate-y-1/2 bg-white pl-2';
      actionsDiv.onclick = (e) => e.stopPropagation();

      // 如果是目录节点，显示添加子目录和添加知识点按钮
      if (node.type === 'directory') {
        // 添加子目录
        const addDirBtn = createActionButton('fa-folder-plus', 'success', '添加子目录', () => addChildDirectory(node.id));
        actionsDiv.appendChild(addDirBtn);

        // 添加知识点
        const addKnowledgeBtn = createActionButton('fa-plus', 'success', '添加知识点', () => addChildKnowledge(node.id));
        actionsDiv.appendChild(addKnowledgeBtn);
      }
      // 知识点节点不显示添加按钮

      // 编辑
      const editBtn = createActionButton('fa-edit', 'info', '编辑', () => startEditing(node.id));
      actionsDiv.appendChild(editBtn);

      // 移动
      const moveBtn = createActionButton('fa-arrows-alt', 'warning', '移动位置', () => openMoveModal(node.id, parentNode));
      actionsDiv.appendChild(moveBtn);

      // 删除
      const deleteBtn = createActionButton('fa-trash', 'error', '删除', () => deleteNode(node.id, parentNode));
      actionsDiv.appendChild(deleteBtn);

      rightDiv.appendChild(actionsDiv);
      nodeDiv.appendChild(rightDiv);

      wrapper.appendChild(nodeDiv);

      // 子节点（递归）
      if (node.children && node.children.length > 0) {
        // 搜索模式下，过滤子节点并自动展开
        const shouldExpand = searchKeyword ? true : !node.collapsed;
        const childrenToRender = searchKeyword
          ? node.children.filter(child => matchesSearch(child, searchKeyword))
          : node.children;

        if (childrenToRender.length > 0 && shouldExpand) {
          const childrenContainer = document.createElement('div');
          childrenContainer.className = 'ml-6 mt-1 space-y-1';
          childrenToRender.forEach((child, childIndex) => {
            childrenContainer.appendChild(createNodeElement(child, node, childIndex));
          });
          wrapper.appendChild(childrenContainer);
        }
      }

      return wrapper;
    }

    // 创建操作按钮
    function createActionButton(icon, color, title, onclick) {
      const btn = document.createElement('button');
      btn.className = `w-6 h-6 flex items-center justify-center text-gray-400 hover:text-${color}-600 hover:bg-${color}-50 rounded transition-colors`;
      btn.title = title;
      btn.onclick = (e) => {
        e.stopPropagation();
        onclick();
      };

      const iconEl = document.createElement('i');
      iconEl.className = `fas ${icon} text-xs`;
      btn.appendChild(iconEl);

      return btn;
    }

    // ==================== 数据持久化 ====================

    // 保存知识点树到 localStorage
    function saveKnowledgeTreeToStorage() {
      try {
        localStorage.setItem('knowledgePoints', JSON.stringify(knowledgeTree));
        console.log('知识点树已保存到 localStorage');
      } catch (e) {
        console.error('保存知识点树失败:', e);
      }
    }

    // 从 localStorage 加载知识点树
    function loadKnowledgeTreeFromStorage() {
      try {
        const saved = localStorage.getItem('knowledgePoints');
        if (saved) {
          knowledgeTree = JSON.parse(saved);
          console.log('从 localStorage 加载知识点树:', knowledgeTree);

          // 更新 nextId，确保不会产生重复ID
          let maxId = 0;
          function findMaxId(nodes) {
            nodes.forEach(node => {
              if (node.id > maxId) maxId = node.id;
              if (node.children && node.children.length > 0) {
                findMaxId(node.children);
              }
            });
          }
          findMaxId(knowledgeTree);
          nextId = maxId + 1;
        } else {
          console.log('localStorage 中没有知识点数据，使用默认数据');
          // 首次加载时保存默认数据
          saveKnowledgeTreeToStorage();
        }
      } catch (e) {
        console.error('加载知识点树失败:', e);
      }
    }

    // ==================== 节点操作 ====================

    // 切换展开/收起
    function toggleNode(nodeId) {
      const node = findNode(nodeId);
      if (node) {
        node.collapsed = !node.collapsed;
        renderKnowledgeTree();
      }
    }

    // 添加根目录
    function addRootDirectory() {
      const newNode = {
        id: nextId++,
        name: '',
        type: 'directory',  // 根节点目录
        count: 0,
        collapsed: false,
        children: [],
        isNew: true
      };
      knowledgeTree.push(newNode);
      saveKnowledgeTreeToStorage(); // 保存到 localStorage
      renderKnowledgeTree();

      // 自动进入编辑状态
      setTimeout(() => startEditing(newNode.id), 50);
    }

    // 添加根知识点
    function addRootKnowledgePoint() {
      const newNode = {
        id: nextId++,
        name: '',
        type: 'knowledge',  // 根节点知识点
        count: 0,
        children: [],  // 知识点没有子节点
        isNew: true
      };
      knowledgeTree.push(newNode);
      saveKnowledgeTreeToStorage(); // 保存到 localStorage
      renderKnowledgeTree();

      // 自动进入编辑状态
      setTimeout(() => startEditing(newNode.id), 50);
    }

    // 兼容旧代码
    function addRootKnowledge() {
      addRootDirectory();
    }

    // 添加子目录
    function addChildDirectory(parentId) {
      const parent = findNode(parentId);
      if (parent) {
        if (!parent.children) {
          parent.children = [];
        }
        const newNode = {
          id: nextId++,
          name: '',
          type: 'directory',
          count: 0,
          collapsed: false,
          children: [],
          isNew: true
        };
        parent.children.push(newNode);
        parent.collapsed = false; // 展开父节点
        saveKnowledgeTreeToStorage(); // 保存到 localStorage
        renderKnowledgeTree();

        // 自动进入编辑状态
        setTimeout(() => startEditing(newNode.id), 50);
      }
    }

    // 添加知识点（叶子节点）
    function addChildKnowledge(parentId) {
      const parent = findNode(parentId);
      if (parent) {
        if (!parent.children) {
          parent.children = [];
        }
        const newNode = {
          id: nextId++,
          name: '',
          type: 'knowledge',  // 知识点类型
          count: 0,
          children: [],  // 知识点不能有子节点
          isNew: true
        };
        parent.children.push(newNode);
        parent.collapsed = false; // 展开父节点
        saveKnowledgeTreeToStorage(); // 保存到 localStorage
        renderKnowledgeTree();

        // 自动进入编辑状态
        setTimeout(() => startEditing(newNode.id), 50);
      }
    }

    // 添加子知识点（兼容旧代码，实际调用 addChildKnowledge）
    function addChildNode(parentId) {
      addChildKnowledge(parentId);
    }

    // 开始编辑
    function startEditing(nodeId) {
      const nameSpan = document.querySelector(`.node-name[data-node-id="${nodeId}"]`);
      const input = document.querySelector(`.node-input[data-node-id="${nodeId}"]`);

      if (nameSpan && input) {
        nameSpan.classList.add('hidden');
        input.classList.remove('hidden');
        input.focus();
        input.select();
      }
    }

    // 完成编辑
    function finishEditing(nodeId) {
      const input = document.querySelector(`.node-input[data-node-id="${nodeId}"]`);
      const nameSpan = document.querySelector(`.node-name[data-node-id="${nodeId}"]`);

      if (input && nameSpan) {
        const newName = input.value.trim();
        if (newName) {
          const node = findNode(nodeId);
          if (node) {
            node.name = newName;
            node.isNew = false;
            nameSpan.textContent = newName;
            saveKnowledgeTreeToStorage(); // 保存到 localStorage
          }
        } else if (findNode(nodeId)?.isNew) {
          // 如果是新建节点且名称为空，删除它
          deleteNodeById(nodeId);
          renderKnowledgeTree();
          return;
        }

        input.classList.add('hidden');
        nameSpan.classList.remove('hidden');
      }
    }

    // 取消编辑
    function cancelEditing(nodeId) {
      const node = findNode(nodeId);
      if (node?.isNew) {
        // 新建节点取消时删除
        deleteNodeById(nodeId);
        renderKnowledgeTree();
      } else {
        const input = document.querySelector(`.node-input[data-node-id="${nodeId}"]`);
        const nameSpan = document.querySelector(`.node-name[data-node-id="${nodeId}"]`);

        if (input && nameSpan && node) {
          input.value = node.name;
          input.classList.add('hidden');
          nameSpan.classList.remove('hidden');
        }
      }
    }

    // 删除节点
    function deleteNode(nodeId, parentNode) {
      const node = findNode(nodeId);
      if (!node) return;

      if (confirm(`确定要删除"${node.name}"知识点吗？\n\n删除后，该知识点下的子知识点和题目将移至"未分类"。`)) {
        deleteNodeById(nodeId);
        renderKnowledgeTree();
      }
    }

    // 根据ID删除节点（递归）
    function deleteNodeById(nodeId) {
      // 从根级别删除
      const rootIndex = knowledgeTree.findIndex(n => n.id === nodeId);
      if (rootIndex !== -1) {
        knowledgeTree.splice(rootIndex, 1);
        saveKnowledgeTreeToStorage(); // 保存到 localStorage
        return true;
      }

      // 递归查找并删除
      function deleteFromChildren(nodes) {
        for (let node of nodes) {
          if (node.children) {
            const index = node.children.findIndex(n => n.id === nodeId);
            if (index !== -1) {
              node.children.splice(index, 1);
              return true;
            }
            if (deleteFromChildren(node.children)) {
              return true;
            }
          }
        }
        return false;
      }

      const result = deleteFromChildren(knowledgeTree);
      if (result) {
        saveKnowledgeTreeToStorage(); // 保存到 localStorage
      }
      return result;
    }

    // 查找节点（递归）
    function findNode(nodeId, nodes = knowledgeTree) {
      for (let node of nodes) {
        if (node.id === nodeId) return node;
        if (node.children) {
          const found = findNode(nodeId, node.children);
          if (found) return found;
        }
      }
      return null;
    }

    // ==================== 拖拽功能 ====================

    function handleDragStart(e, node, parentNode) {
      draggedNode = node;
      draggedNodeParent = parentNode;
      e.currentTarget.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      e.currentTarget.style.background = '#E6F9F0';
    }

    function handleDrop(e, targetNode) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.style.background = '';

      if (!draggedNode || draggedNode.id === targetNode.id) return;

      // 删除原位置的节点
      deleteNodeById(draggedNode.id);

      // 添加到新位置
      if (!targetNode.children) {
        targetNode.children = [];
      }
      targetNode.children.push(draggedNode);
      targetNode.collapsed = false;

      saveKnowledgeTreeToStorage(); // 保存到 localStorage
      renderKnowledgeTree();
    }

    function handleDragEnd() {
      document.querySelectorAll('.tree-item').forEach(el => {
        el.style.opacity = '';
        el.style.background = '';
      });
      draggedNode = null;
      draggedNodeParent = null;
    }

    // ==================== 移动位置功能 ====================

    function openMoveModal(nodeId, parentNode) {
      moveTargetNode = { id: nodeId, parent: parentNode };

      // 填充目标位置下拉框
      const select = document.getElementById('moveTargetSelect');
      select.innerHTML = '<option value="root">根目录</option>';

      function addOptions(nodes, prefix = '') {
        nodes.forEach(node => {
          if (node.id !== nodeId) { // 不能移动到自己
            const option = document.createElement('option');
            option.value = node.id;
            option.textContent = prefix + node.name;
            select.appendChild(option);

            if (node.children && node.children.length > 0) {
              addOptions(node.children, prefix + '　');
            }
          }
        });
      }

      addOptions(knowledgeTree);

      document.getElementById('moveModal').classList.remove('hidden');
    }

    function closeMoveModal() {
      document.getElementById('moveModal').classList.add('hidden');
      moveTargetNode = null;
    }

    function confirmMove() {
      const targetValue = document.getElementById('moveTargetSelect').value;
      const position = parseInt(document.getElementById('movePositionInput').value) - 1;

      if (!moveTargetNode) return;

      const node = findNode(moveTargetNode.id);
      if (!node) return;

      // 删除原位置
      deleteNodeById(node.id);

      // 插入到新位置
      if (targetValue === 'root') {
        knowledgeTree.splice(Math.max(0, Math.min(position, knowledgeTree.length)), 0, node);
      } else {
        const targetNode = findNode(parseInt(targetValue));
        if (targetNode) {
          if (!targetNode.children) {
            targetNode.children = [];
          }
          targetNode.children.splice(Math.max(0, Math.min(position, targetNode.children.length)), 0, node);
          targetNode.collapsed = false;
        }
      }

      saveKnowledgeTreeToStorage(); // 保存到 localStorage
      closeMoveModal();
      renderKnowledgeTree();
    }

    // ESC键关闭弹窗
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeMoveModal();
      }
    });

    // ==================== 其他功能 ====================

    // 搜索知识点
    let searchKeyword = '';

    function searchKnowledge(keyword) {
      searchKeyword = keyword.trim().toLowerCase();
      renderKnowledgeTree();

      // 显示/隐藏清空按钮
      const clearBtn = document.getElementById('clearSearchBtn');
      if (searchKeyword) {
        clearBtn.classList.remove('hidden');
      } else {
        clearBtn.classList.add('hidden');
      }
    }

    // 清空搜索
    function clearSearch() {
      document.getElementById('searchInput').value = '';
      searchKnowledge('');
    }

    // ==================== 题目筛选功能 ====================

    // 当前筛选条件
    let currentFilters = {
      search: '',
      knowledge: '',
      questionTypes: [],  // 多选
      difficulties: [],   // 多选
      tag: ''
    };

    // 防抖函数
    let searchDebounceTimer = null;
    function debounce(func, delay) {
      return function(...args) {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // 即时搜索处理函数
    function handleInstantSearch() {
      applyFilters();
    }

    // 创建防抖的即时搜索函数（300ms延迟）
    const debouncedSearch = debounce(handleInstantSearch, 300);

    // 处理回车键搜索
    function handleEnterKey(event) {
      if (event.key === 'Enter' || event.keyCode === 13) {
        event.preventDefault(); // 阻止表单默认提交行为
        clearTimeout(searchDebounceTimer); // 取消防抖延迟
        applyFilters(); // 立即执行搜索
      }
    }

    // 点击外部关闭下拉框
    document.addEventListener('click', function(e) {
      const qtBtn = document.getElementById('questionTypeDropdownBtn');
      const qtDropdown = document.getElementById('questionTypeDropdown');
      const diffBtn = document.getElementById('difficultyDropdownBtn');
      const diffDropdown = document.getElementById('difficultyDropdown');

      if (!qtBtn?.contains(e.target) && !qtDropdown?.contains(e.target)) {
        qtDropdown?.classList.add('hidden');
      }
      if (!diffBtn?.contains(e.target) && !diffDropdown?.contains(e.target)) {
        diffDropdown?.classList.add('hidden');
      }
    });

    // 切换题型下拉框
    function toggleQuestionTypeDropdown() {
      document.getElementById('questionTypeDropdown').classList.toggle('hidden');
      document.getElementById('difficultyDropdown').classList.add('hidden');
    }

    // 切换难度下拉框
    function toggleDifficultyDropdown() {
      document.getElementById('difficultyDropdown').classList.toggle('hidden');
      document.getElementById('questionTypeDropdown').classList.add('hidden');
    }

    // 更新题型选择显示
    function updateQuestionTypeSelection() {
      const checkboxes = document.querySelectorAll('.question-type-checkbox');
      const selected = Array.from(checkboxes).filter(cb => cb.checked);
      const label = document.getElementById('questionTypeLabel');

      if (selected.length === 0) {
        label.textContent = '全部题型';
      } else if (selected.length === 1) {
        label.textContent = selected[0].nextElementSibling.textContent;
      } else {
        label.textContent = `已选${selected.length}项`;
      }
    }

    // 更新难度选择显示
    function updateDifficultySelection() {
      const checkboxes = document.querySelectorAll('.difficulty-checkbox');
      const selected = Array.from(checkboxes).filter(cb => cb.checked);
      const label = document.getElementById('difficultyLabel');

      if (selected.length === 0) {
        label.textContent = '全部难度';
      } else if (selected.length === 1) {
        label.textContent = selected[0].nextElementSibling.textContent;
      } else {
        label.textContent = `已选${selected.length}项`;
      }
    }

    // 获取节点及其所有子节点的ID列表
    function getAllNodeIds(nodeId) {
      if (!nodeId) return [];

      const node = findNode(parseInt(nodeId));
      if (!node) return [nodeId];

      const ids = [nodeId];

      function collectChildIds(node) {
        if (node.children && node.children.length > 0) {
          node.children.forEach(child => {
            ids.push(child.id.toString());
            collectChildIds(child);
          });
        }
      }

      collectChildIds(node);
      return ids;
    }

    // 更新知识点树的题目数量
    function updateKnowledgeTreeCounts() {
      const countMap = {};

      allQuestions.forEach(q => {
        const knowledgeId = q.knowledgeId;
        if (knowledgeId) {
          countMap[knowledgeId] = (countMap[knowledgeId] || 0) + 1;
        }
      });

      function updateNodeCounts(node) {
        let totalCount = 0;

        if (node.children && node.children.length > 0) {
          node.children.forEach(child => {
            updateNodeCounts(child);
            totalCount += child.count;
          });
        } else {
          totalCount = countMap[node.id.toString()] || 0;
        }

        node.count = totalCount;
      }

      knowledgeTree.forEach(node => updateNodeCounts(node));

      // 更新总题目数
      const total = allQuestions.length;
      const totalElement = document.getElementById('totalQuestionsInTree');
      if (totalElement) {
        totalElement.textContent = total;
      }
    }

    // 应用筛选
    function applyFilters() {
      // 重置到第一页
      currentPage = 1;

      currentFilters.search = document.getElementById('globalSearchInput').value.trim().toLowerCase();
      currentFilters.tag = document.getElementById('filterTag').value.trim().toLowerCase();

      const qtCheckboxes = document.querySelectorAll('.question-type-checkbox:checked');
      currentFilters.questionTypes = Array.from(qtCheckboxes).map(cb => cb.value);

      const diffCheckboxes = document.querySelectorAll('.difficulty-checkbox:checked');
      currentFilters.difficulties = Array.from(diffCheckboxes).map(cb => cb.value);

      // 获取当前知识点及其所有子节点的ID列表
      const knowledgeIds = currentFilters.knowledge ? getAllNodeIds(currentFilters.knowledge) : [];

      filteredQuestions = allQuestions.filter(question => {
        if (currentFilters.search && !question.content.toLowerCase().includes(currentFilters.search)) {
          return false;
        }
        // 知识点筛选：匹配节点及其所有子节点
        if (currentFilters.knowledge && !knowledgeIds.includes(question.knowledgeId)) {
          return false;
        }
        if (currentFilters.questionTypes.length > 0 && !currentFilters.questionTypes.includes(question.type)) {
          return false;
        }
        if (currentFilters.difficulties.length > 0 && !currentFilters.difficulties.includes(question.difficulty.toString())) {
          return false;
        }
        if (currentFilters.tag && !question.tags.some(tag => tag.toLowerCase().includes(currentFilters.tag))) {
          return false;
        }
        return true;
      });

      renderQuestions();
      document.getElementById('questionTypeDropdown').classList.add('hidden');
      document.getElementById('difficultyDropdown').classList.add('hidden');
    }

    // 清空所有筛选
    function clearAllFilters() {
      currentFilters = {
        search: '',
        knowledge: '',
        questionTypes: [],
        difficulties: [],
        tag: ''
      };

      document.getElementById('globalSearchInput').value = '';
      document.getElementById('filterTag').value = '';

      document.querySelectorAll('.question-type-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('questionTypeLabel').textContent = '全部题型';

      document.querySelectorAll('.difficulty-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('difficultyLabel').textContent = '全部难度';

      // 重置知识点树选中状态
      document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('active'));
      document.querySelector('.tree-item')?.classList.add('active');
      document.getElementById('pageTitle').textContent = '全部题目';

      applyFilters();
    }

    // 渲染题目列表
    function renderQuestions() {
      const container = document.getElementById('questionList');
      const emptyState = document.getElementById('emptyState');
      const paginationContainer = document.getElementById('paginationContainer');

      // 按创建时间倒序排序（最新的在前面）
      filteredQuestions.sort((a, b) => {
        return b.createTime.localeCompare(a.createTime);
      });

      document.getElementById('totalQuestions').textContent = filteredQuestions.length;

      if (filteredQuestions.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        paginationContainer.classList.add('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      container.innerHTML = '';

      // 计算分页
      const totalPages = Math.ceil(filteredQuestions.length / pageSize);
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, filteredQuestions.length);
      const currentQuestions = filteredQuestions.slice(startIndex, endIndex);

      // 渲染当前页的题目
      currentQuestions.forEach(question => {
        container.appendChild(createQuestionCard(question));
      });

      // 显示并渲染分页控件
      if (filteredQuestions.length > 0) {
        paginationContainer.classList.remove('hidden');
        renderPagination(totalPages, startIndex, endIndex, filteredQuestions.length);
      } else {
        paginationContainer.classList.add('hidden');
      }
    }

    // 创建题目卡片
    function createQuestionCard(q) {
      const card = document.createElement('div');
      card.className = 'apple-card bg-white rounded-2xl p-6 shadow-sm border border-gray-100 cursor-pointer';
      card.setAttribute('data-question-id', q.id);

      // 调试日志：仅对简便录入的题目输出
      if (q.author === '简便录入') {
        console.log('[渲染卡片] 简便录入题目:', q.id);
        console.log('  - knowledgeIds:', q.knowledgeIds);
        console.log('  - knowledgePath:', q.knowledgePath);
      }

      // 生成标签HTML
      const tagsHtml = q.tags && q.tags.length > 0
        ? q.tags.map(tag => `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-gray-100 text-gray-700">#${tag}</span>`).join(' ')
        : '';

      // 批量选择模式下的勾选框
      const checkboxHtml = isBatchMode ? `
        <div class="flex items-center mr-4 batch-checkbox-container">
          <input type="checkbox"
                 class="batch-question-checkbox w-5 h-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer"
                 data-question-id="${q.id}"
                 onchange="toggleQuestionSelection('${q.id}')"
                 onclick="event.stopPropagation()"
                 ${selectedQuestions.has(q.id) ? 'checked' : ''}>
        </div>
      ` : '';

      card.innerHTML = `
        <div class="flex items-start justify-between">
          ${checkboxHtml}
          <div class="flex-1 cursor-pointer" onclick="${isBatchMode ? `toggleQuestionSelection('${q.id}')` : `viewQuestion('${q.id}')`}">
            <div class="flex items-center space-x-3 mb-3">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${q.typeColor}-50 text-${q.typeColor}-700">
                <i class="fas ${q.typeIcon} mr-1.5"></i>${q.typeName}
              </span>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-warning-50 text-warning-700">
                ${q.difficultyName}
              </span>
              ${q.isComposite ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700">
                <i class="fas fa-list-ol mr-1"></i>${q.subCount} 道子题
              </span>` : ''}
            </div>
            <div class="text-gray-900 text-base leading-relaxed mb-3 question-content" data-question-content></div>
            <div class="flex items-center gap-3 mb-2">
              ${tagsHtml}
            </div>
            <div class="flex items-center space-x-4 text-xs text-gray-500">
              <span class="flex items-center">
                <i class="fas fa-folder text-gray-400 mr-1.5"></i>${q.knowledgePath}
              </span>
              <span class="flex items-center">
                <i class="fas fa-layer-group text-gray-400 mr-1.5"></i>组卷 ${q.useCount} 次
              </span>
            </div>
          </div>
          <div class="flex flex-col items-end space-y-2 ml-6 ${isBatchMode ? 'hidden' : ''}">
            <button onclick="viewQuestion('${q.id}')" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-primary-500 hover:bg-primary-50 rounded-lg transition-colors" title="查看详情">
              <i class="fas fa-eye"></i>
            </button>
            <button onclick="editQuestion('${q.id}')" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-info-500 hover:bg-info-50 rounded-lg transition-colors" title="编辑题目">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="deleteQuestion('${q.id}', '${q.content.replace(/<[^>]*>/g, '').substring(0, 20)}...')" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-error-500 hover:bg-error-50 rounded-lg transition-colors" title="删除题目">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `;

      // 单独设置题目内容的innerHTML，以支持HTML渲染（图片、公式等）
      const contentDiv = card.querySelector('[data-question-content]');
      if (contentDiv) {
        contentDiv.innerHTML = q.content || '';
      }

      // 批量模式下，选中的卡片添加高亮样式
      if (isBatchMode && selectedQuestions.has(q.id)) {
        card.classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-50');
      }

      return card;
    }

    // ==================== 分页功能 ====================

    // 渲染分页控件
    function renderPagination(totalPages, startIndex, endIndex, total) {
      // 更新显示信息
      document.getElementById('pageStart').textContent = startIndex + 1;
      document.getElementById('pageEnd').textContent = endIndex;
      document.getElementById('pageTotal').textContent = total;

      // 更新按钮状态
      const firstPageBtn = document.getElementById('firstPageBtn');
      const prevPageBtn = document.getElementById('prevPageBtn');
      const nextPageBtn = document.getElementById('nextPageBtn');
      const lastPageBtn = document.getElementById('lastPageBtn');

      firstPageBtn.disabled = currentPage === 1;
      prevPageBtn.disabled = currentPage === 1;
      nextPageBtn.disabled = currentPage === totalPages;
      lastPageBtn.disabled = currentPage === totalPages;

      // 渲染页码
      const pageNumbers = document.getElementById('pageNumbers');
      pageNumbers.innerHTML = '';

      // 计算显示的页码范围
      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, currentPage + 2);

      // 确保始终显示5个页码（如果总页数>=5）
      if (endPage - startPage < 4) {
        if (currentPage < 3) {
          endPage = Math.min(5, totalPages);
        } else {
          startPage = Math.max(1, endPage - 4);
        }
      }

      // 第一页
      if (startPage > 1) {
        const btn = createPageButton(1, false);
        pageNumbers.appendChild(btn);

        if (startPage > 2) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'px-2 text-gray-500';
          ellipsis.textContent = '...';
          pageNumbers.appendChild(ellipsis);
        }
      }

      // 中间页码
      for (let i = startPage; i <= endPage; i++) {
        const btn = createPageButton(i, i === currentPage);
        pageNumbers.appendChild(btn);
      }

      // 最后一页
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'px-2 text-gray-500';
          ellipsis.textContent = '...';
          pageNumbers.appendChild(ellipsis);
        }

        const btn = createPageButton(totalPages, false);
        pageNumbers.appendChild(btn);
      }
    }

    // 创建页码按钮
    function createPageButton(pageNum, isActive) {
      const btn = document.createElement('button');
      btn.onclick = () => changePage(pageNum);
      btn.className = isActive
        ? 'px-3 py-1.5 bg-primary-500 text-white rounded-lg text-sm font-medium'
        : 'px-3 py-1.5 border border-gray-300 rounded-lg text-sm text-gray-600 hover:bg-gray-50 transition-colors';
      btn.textContent = pageNum;
      return btn;
    }

    // 切换页码
    function changePage(page) {
      const totalPages = Math.ceil(filteredQuestions.length / pageSize);
      if (page < 1 || page > totalPages) return;

      currentPage = page;
      renderQuestions();

      // 滚动到顶部
      document.getElementById('questionListContainer').scrollTop = 0;
    }

    // 跳转到第一页
    function goToFirstPage() {
      changePage(1);
    }

    // 跳转到最后一页
    function goToLastPage() {
      const totalPages = Math.ceil(filteredQuestions.length / pageSize);
      changePage(totalPages);
    }

    // ==================== 知识点筛选 ====================

    // 点击知识点节点筛选
    function selectKnowledgeNode(nodeId, nodeName) {
      document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('active'));

      currentFilters.knowledge = nodeId.toString();

      document.getElementById('pageTitle').textContent = nodeId ? nodeName : '全部题目';

      applyFilters();
    }

    // 检查节点或其子节点是否匹配搜索关键词
    function matchesSearch(node, keyword) {
      if (!keyword) return true;

      // 检查当前节点
      if (node.name.toLowerCase().includes(keyword)) {
        return true;
      }

      // 检查子节点
      if (node.children && node.children.length > 0) {
        return node.children.some(child => matchesSearch(child, keyword));
      }

      return false;
    }

    // 选择全部题目
    function selectAllQuestions(element) {
      selectKnowledgeNode('', '全部题目');
      element.classList.add('active');
    }

    // ==================== 题型设置功能 ====================

    // 默认题型（原始定义）- 只保留单选、多选、判断、填空和复合题型
    const defaultQuestionTypes = [
      { id: 'single', name: '单选题', icon: 'fa-dot-circle', color: 'info', isDefault: true },
      { id: 'multiple', name: '多选题', icon: 'fa-check-double', color: 'success', isDefault: true },
      { id: 'judge', name: '判断题', icon: 'fa-check-circle', color: 'success', isDefault: true },
      { id: 'blank', name: '填空题', icon: 'fa-keyboard', color: 'warning', isDefault: true },
      { id: 'cloze', name: '完形填空', icon: 'fa-layer-group', color: 'indigo', isDefault: true },
      { id: 'shortAnswer', name: '简答题', icon: 'fa-align-left', color: 'teal', isDefault: true },
      {
        id: 'composite',
        name: '复合题',
        icon: 'fa-list-alt',
        color: 'purple',
        isDefault: true,
        isComposite: true,
        hasMaterial: true,
        subTypes: ['single', 'multiple', 'judge', 'blank', 'shortAnswer']  // 只包含需要的基础题型
      }
    ];

    // 对默认题型的修改（用于存储重命名等修改）
    let modifiedDefaultTypes = {};

    // 自定义题型数据
    let customQuestionTypes = [];
    let nextCustomTypeId = 1000;
    let editingQuestionType = null; // 正在编辑的题型（可能是默认或自定义）

    // 从 localStorage 加载题型配置
    function loadQuestionTypesFromStorage() {
      const saved = localStorage.getItem('questionTypesConfig');
      if (saved) {
        try {
          const config = JSON.parse(saved);
          if (config.modifiedDefaultTypes) {
            modifiedDefaultTypes = config.modifiedDefaultTypes;
          }
          if (config.customQuestionTypes) {
            customQuestionTypes = config.customQuestionTypes;
          }
          if (config.nextCustomTypeId) {
            nextCustomTypeId = config.nextCustomTypeId;
          }
        } catch (e) {
          console.error('加载题型配置失败:', e);
        }
      }
    }

    // 保存题型配置到 localStorage
    function saveQuestionTypesToStorage() {
      const config = {
        modifiedDefaultTypes: modifiedDefaultTypes,
        customQuestionTypes: customQuestionTypes,
        nextCustomTypeId: nextCustomTypeId
      };
      localStorage.setItem('questionTypesConfig', JSON.stringify(config));
    }

    // 获取题型（考虑修改后的版本）
    function getQuestionType(type) {
      if (type.isDefault && modifiedDefaultTypes[type.id]) {
        // 返回修改后的版本，但保留原始名称
        const modified = { ...type, ...modifiedDefaultTypes[type.id] };
        // 如果有自定义名称，使用自定义名称；否则使用原始名称
        if (modified.customName) {
          modified.name = modified.customName;
        }
        // 保留原始名称供恢复使用
        modified.originalName = type.name;
        return modified;
      }
      return type;
    }

    // 打开题型设置弹窗
    function openQuestionTypeSettings() {
      renderDefaultQuestionTypes();
      renderCustomQuestionTypes();
      document.getElementById('questionTypeSettingsModal').classList.remove('hidden');
    }

    // 关闭题型设置弹窗
    function closeQuestionTypeSettings() {
      document.getElementById('questionTypeSettingsModal').classList.add('hidden');
    }

    // 渲染默认题型列表
    function renderDefaultQuestionTypes() {
      const container = document.getElementById('defaultQuestionTypes');
      container.innerHTML = '';

      defaultQuestionTypes.forEach(type => {
        // 传递原始的 type，让 createQuestionTypeItem 内部处理显示名称
        const item = createQuestionTypeItem(type, true); // 第二个参数表示是默认题型
        container.appendChild(item);
      });
    }

    // 渲染自定义题型列表
    function renderCustomQuestionTypes() {
      const container = document.getElementById('customQuestionTypes');
      const emptyTip = document.getElementById('emptyCustomTypes');

      if (customQuestionTypes.length === 0) {
        container.classList.add('hidden');
        emptyTip.classList.remove('hidden');
      } else {
        container.classList.remove('hidden');
        emptyTip.classList.add('hidden');
        container.innerHTML = '';

        customQuestionTypes.forEach(type => {
          const item = createQuestionTypeItem(type, false); // 自定义题型
          container.appendChild(item);
        });
      }
    }

    // 创建题型列表项
    function createQuestionTypeItem(type, isDefaultType) {
      // 如果是默认题型，获取显示版本（包含自定义名称）
      const displayType = isDefaultType ? getQuestionType(type) : type;

      const div = document.createElement('div');
      div.className = 'flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:border-primary-300 hover:bg-primary-50 transition-all group';

      // 左侧：图标和名称
      const leftDiv = document.createElement('div');
      leftDiv.className = 'flex items-center space-x-3';

      const iconDiv = document.createElement('div');
      iconDiv.className = `w-10 h-10 rounded-lg bg-${displayType.color}-50 flex items-center justify-center`;
      iconDiv.innerHTML = `<i class="fas ${displayType.icon} text-${displayType.color}-500"></i>`;
      leftDiv.appendChild(iconDiv);

      const infoDiv = document.createElement('div');
      const nameSpan = document.createElement('div');
      nameSpan.className = 'font-medium text-gray-900';
      nameSpan.textContent = displayType.name; // 显示名称（可能是自定义名称）
      infoDiv.appendChild(nameSpan);

      if (displayType.baseType) {
        const baseSpan = document.createElement('div');
        baseSpan.className = 'text-xs text-gray-500 mt-0.5';
        baseSpan.textContent = `基于：${getBaseTypeName(displayType.baseType)}`;
        infoDiv.appendChild(baseSpan);
      }

      if (displayType.description) {
        const descSpan = document.createElement('div');
        descSpan.className = 'text-xs text-gray-500 mt-0.5';
        descSpan.textContent = displayType.description;
        infoDiv.appendChild(descSpan);
      }

      leftDiv.appendChild(infoDiv);
      div.appendChild(leftDiv);

      // 右侧：标签和操作
      const rightDiv = document.createElement('div');
      rightDiv.className = 'flex items-center space-x-3';

      // 默认题型标签
      if (displayType.isDefault) {
        const badge = document.createElement('span');
        badge.className = 'px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded';
        badge.textContent = '内置';
        rightDiv.appendChild(badge);
      }

      // 复合题型标签
      if (displayType.isComposite) {
        const badge = document.createElement('span');
        badge.className = 'px-2 py-1 bg-purple-100 text-purple-600 text-xs rounded';
        badge.textContent = '复合';
        rightDiv.appendChild(badge);
      }

      // 操作按钮（所有题型都可以编辑）
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'hidden group-hover:flex items-center space-x-2';

      // 编辑按钮
      const editBtn = document.createElement('button');
      editBtn.className = 'w-8 h-8 flex items-center justify-center text-gray-400 hover:text-info-600 hover:bg-info-50 rounded transition-colors';
      editBtn.title = '编辑';
      editBtn.innerHTML = '<i class="fas fa-edit text-sm"></i>';
      editBtn.onclick = (e) => {
        e.stopPropagation();
        // 传递原始的 type，不是 displayType
        editQuestionType(type);
      };
      actionsDiv.appendChild(editBtn);

      // 删除按钮（仅自定义题型）
      if (!type.isDefault) {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'w-8 h-8 flex items-center justify-center text-gray-400 hover:text-error-600 hover:bg-error-50 rounded transition-colors';
        deleteBtn.title = '删除';
        deleteBtn.innerHTML = '<i class="fas fa-trash text-sm"></i>';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteCustomType(type);
        };
        actionsDiv.appendChild(deleteBtn);
      }

      rightDiv.appendChild(actionsDiv);

      div.appendChild(rightDiv);
      return div;
    }

    // 获取基础题型名称
    function getBaseTypeName(typeId) {
      const type = defaultQuestionTypes.find(t => t.id === typeId);
      if (!type) return typeId;
      const displayType = getQuestionType(type);
      return displayType.name;
    }

    // 打开添加自定义题型弹窗
    function openAddCustomType() {
      editingQuestionType = null;
      document.getElementById('customTypeModalTitle').textContent = '添加自定义题型';

      // 隐藏原始名称提示
      document.getElementById('originalNameHint').classList.add('hidden');

      // 重置基础题型选择（移除 composite 选项，因为内置已包含复合题型）
      const baseTypeSelect = document.getElementById('baseQuestionType');
      baseTypeSelect.innerHTML = `
        <option value="">请选择</option>
        <option value="single">单选题</option>
        <option value="multiple">多选题</option>
        <option value="judge">判断题</option>
        <option value="blank">填空题</option>
        <option value="cloze">完形填空</option>
        <option value="shortAnswer">简答题</option>
        <option value="composite">复合题型（自定义组合）</option>
      `;
      baseTypeSelect.value = '';

      document.getElementById('customTypeName').value = '';
      document.getElementById('customTypeDescription').value = '';
      document.getElementById('compositeOptionsContainer').classList.add('hidden');
      document.querySelectorAll('.composite-subtype').forEach(cb => cb.checked = false);
      document.getElementById('hasMaterial').checked = true;
      document.getElementById('addCustomTypeModal').classList.remove('hidden');
    }

    // 关闭添加自定义题型弹窗
    function closeAddCustomType() {
      document.getElementById('addCustomTypeModal').classList.add('hidden');
      editingQuestionType = null;
      // 恢复基础题型选择框的可用状态
      document.getElementById('baseQuestionType').disabled = false;
    }

    // 更新复合选项显示
    function updateCompositeOptions() {
      const baseType = document.getElementById('baseQuestionType').value;
      const container = document.getElementById('compositeOptionsContainer');

      if (baseType === 'composite') {
        container.classList.remove('hidden');
      } else {
        container.classList.add('hidden');
      }
    }

    // 保存题型（内置或自定义）
    function saveCustomType() {
      const baseType = document.getElementById('baseQuestionType').value;
      const name = document.getElementById('customTypeName').value.trim();
      const description = document.getElementById('customTypeDescription').value.trim();

      // 判断是否是编辑内置题型
      if (editingQuestionType && editingQuestionType.isDefault) {
        // 编辑内置题型，名称可以为空（表示恢复原始名称）

        // 保存对内置题型的修改
        const modifications = {
          description: description
        };

        // 只有当自定义名称不为空且与原始名称不同时，才保存customName
        if (name && name !== editingQuestionType.name) {
          modifications.customName = name;
        }

        // 如果是复合题型，保存复合配置
        if (editingQuestionType.isComposite) {
          const checkedSubtypes = Array.from(document.querySelectorAll('.composite-subtype:checked'));
          if (checkedSubtypes.length === 0) {
            Message.warning('请至少选择一个子题型');
            return;
          }
          modifications.hasMaterial = document.getElementById('hasMaterial').checked;
          modifications.subTypes = checkedSubtypes.map(cb => cb.value);
        }

        // 存储修改
        modifiedDefaultTypes[editingQuestionType.id] = modifications;

        // 保存到 localStorage
        saveQuestionTypesToStorage();

        // 更新UI
        renderDefaultQuestionTypes();
        updateQuestionTypeFilter();
        closeAddCustomType();
        return;
      }

      // 以下是自定义题型的处理，名称必填
      if (!name) {
        Message.warning('请输入名称');
        return;
      }
      if (!baseType) {
        Message.warning('请选择基础题型');
        return;
      }

      // 复合题型验证
      if (baseType === 'composite') {
        const checkedSubtypes = Array.from(document.querySelectorAll('.composite-subtype:checked'));
        if (checkedSubtypes.length === 0) {
          Message.warning('请至少选择一个子题型');
          return;
        }
      }

      // 构建题型对象
      const customType = {
        id: editingQuestionType ? editingQuestionType.id : `custom_${nextCustomTypeId++}`,
        name: name,
        baseType: baseType,
        description: description,
        icon: baseType === 'composite' ? 'fa-layer-group' : defaultQuestionTypes.find(t => t.id === baseType)?.icon || 'fa-file-alt',
        color: baseType === 'composite' ? 'purple' : defaultQuestionTypes.find(t => t.id === baseType)?.color || 'gray',
        isComposite: baseType === 'composite',
        isDefault: false
      };

      if (baseType === 'composite') {
        customType.hasMaterial = document.getElementById('hasMaterial').checked;
        customType.subTypes = Array.from(document.querySelectorAll('.composite-subtype:checked')).map(cb => cb.value);
      }

      // 添加或更新
      if (editingQuestionType && !editingQuestionType.isDefault) {
        const index = customQuestionTypes.findIndex(t => t.id === editingQuestionType.id);
        if (index !== -1) {
          customQuestionTypes[index] = customType;
        }
      } else {
        customQuestionTypes.push(customType);
      }

      // 保存到 localStorage
      saveQuestionTypesToStorage();

      // 更新UI
      renderCustomQuestionTypes();
      updateQuestionTypeFilter();
      closeAddCustomType();
    }

    // 编辑题型（内置或自定义）
    function editQuestionType(type) {
      editingQuestionType = type;

      if (type.isDefault) {
        // 编辑内置题型
        // 直接使用 type.name 作为原始名称（因为 type 来自 defaultQuestionTypes，未被修改）
        const originalName = type.name;
        document.getElementById('customTypeModalTitle').textContent = `编辑题型：${originalName}`;

        // 内置题型不显示基础题型选择，直接显示原始类型名称
        const baseTypeSelect = document.getElementById('baseQuestionType');
        if (type.isComposite) {
          baseTypeSelect.innerHTML = `<option value="composite" selected>复合题型</option>`;
          baseTypeSelect.disabled = true;
        } else {
          baseTypeSelect.innerHTML = `<option value="${type.id}" selected>${originalName}</option>`;
          baseTypeSelect.disabled = true;
        }

        // 显示原始名称提示
        const originalNameHint = document.getElementById('originalNameHint');
        const originalNameDisplay = document.getElementById('originalNameDisplay');
        originalNameHint.classList.remove('hidden');
        originalNameDisplay.textContent = originalName;

        // 从 modifiedDefaultTypes 获取自定义名称（如果有）
        const customName = modifiedDefaultTypes[type.id]?.customName || '';
        document.getElementById('customTypeName').value = customName;
        document.getElementById('customTypeDescription').value = modifiedDefaultTypes[type.id]?.description || '';

        if (type.isComposite) {
          document.getElementById('compositeOptionsContainer').classList.remove('hidden');
          const savedMaterial = modifiedDefaultTypes[type.id]?.hasMaterial;
          const savedSubTypes = modifiedDefaultTypes[type.id]?.subTypes;
          document.getElementById('hasMaterial').checked = savedMaterial !== undefined ? savedMaterial : (type.hasMaterial !== false);
          document.querySelectorAll('.composite-subtype').forEach(cb => {
            cb.checked = savedSubTypes ? savedSubTypes.includes(cb.value) : (type.subTypes && type.subTypes.includes(cb.value));
          });
        } else {
          document.getElementById('compositeOptionsContainer').classList.add('hidden');
        }
      } else {
        // 编辑自定义题型
        document.getElementById('customTypeModalTitle').textContent = '编辑自定义题型';

        // 隐藏原始名称提示
        document.getElementById('originalNameHint').classList.add('hidden');

        const baseTypeSelect = document.getElementById('baseQuestionType');
        baseTypeSelect.innerHTML = `
          <option value="">请选择</option>
          <option value="single">单选题</option>
          <option value="multiple">多选题</option>
          <option value="judge">判断题</option>
          <option value="blank">填空题</option>
          <option value="cloze">完形填空</option>
          <option value="shortAnswer">简答题</option>
          <option value="composite">复合题型（自定义组合）</option>
        `;
        baseTypeSelect.disabled = false;
        baseTypeSelect.value = type.baseType;

        document.getElementById('customTypeName').value = type.name;
        document.getElementById('customTypeDescription').value = type.description || '';

        if (type.isComposite) {
          document.getElementById('compositeOptionsContainer').classList.remove('hidden');
          document.getElementById('hasMaterial').checked = type.hasMaterial !== false;
          document.querySelectorAll('.composite-subtype').forEach(cb => {
            cb.checked = type.subTypes && type.subTypes.includes(cb.value);
          });
        } else {
          document.getElementById('compositeOptionsContainer').classList.add('hidden');
        }
      }

      document.getElementById('addCustomTypeModal').classList.remove('hidden');
    }

    // 删除自定义题型
    function deleteCustomType(type) {
      if (confirm(`确定要删除自定义题型"${type.name}"吗？\n\n删除后不可恢复！`)) {
        customQuestionTypes = customQuestionTypes.filter(t => t.id !== type.id);

        // 保存到 localStorage
        saveQuestionTypesToStorage();

        renderCustomQuestionTypes();
        updateQuestionTypeFilter();
      }
    }

    // 更新题型筛选下拉框（当自定义题型变化时调用）
    function updateQuestionTypeFilter() {
      const select = document.getElementById('filterQuestionType');
      if (!select) return;

      // 保存当前选中的值
      const currentValues = Array.from(select.selectedOptions).map(opt => opt.value);

      // 清空并重建选项
      select.innerHTML = '';

      // 添加"全部"选项
      const allOption = document.createElement('option');
      allOption.value = '';
      allOption.textContent = '全部题型';
      allOption.selected = currentValues.includes('') || currentValues.length === 0;
      select.appendChild(allOption);

      // 添加基础题型
      defaultQuestionTypes.filter(t => !t.isComposite).forEach(type => {
        const displayType = getQuestionType(type);
        const option = document.createElement('option');
        option.value = type.id;
        option.textContent = displayType.name;
        option.selected = currentValues.includes(type.id);
        select.appendChild(option);
      });

      // 添加复合题型
      defaultQuestionTypes.filter(t => t.isComposite).forEach(type => {
        const displayType = getQuestionType(type);
        const option = document.createElement('option');
        option.value = type.id;
        option.textContent = displayType.name;
        option.selected = currentValues.includes(type.id);
        select.appendChild(option);
      });

      // 添加自定义题型
      customQuestionTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type.id;
        option.textContent = type.name;
        option.selected = currentValues.includes(type.id);
        select.appendChild(option);
      });
    }

    // ==================== 题目操作函数 ====================

    // 新增题目
    function addNewQuestion() {
      window.location.href = 'add.html';
    }

    // 查看题目详情
    let currentPreviewQuestion = null;

    function viewQuestion(questionId) {
      // 查找题目数据
      const question = allQuestions.find(q => q.id === questionId);
      if (!question) {
        Message.error('未找到题目数据');
        return;
      }

      currentPreviewQuestion = question;

      // 渲染题目预览内容
      renderQuestionPreview(question);

      // 显示侧滑面板
      setTimeout(() => {
        document.getElementById('previewOverlay').classList.add('active');
        document.getElementById('previewDrawer').classList.add('active');
        document.body.style.overflow = 'hidden';
      }, 10);
    }

    // 关闭预览面板
    function closePreview() {
      document.getElementById('previewOverlay').classList.remove('active');
      document.getElementById('previewDrawer').classList.remove('active');
      document.body.style.overflow = '';
      currentPreviewQuestion = null;
    }

    // 渲染题目预览内容
    function renderQuestionPreview(q) {
      const content = document.getElementById('previewContent');

      // 生成题型标签
      const typeTag = `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-${q.typeColor}-50 text-${q.typeColor}-700">
        <i class="fas ${q.typeIcon} mr-1.5"></i>${q.typeName}
      </span>`;

      // 生成难度标签
      const difficultyTag = `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-warning-50 text-warning-700">
        ${q.difficultyName}
      </span>`;

      // 生成标签列表
      const tagsHtml = q.tags && q.tags.length > 0
        ? q.tags.map(tag => `<span class="inline-flex items-center px-2 py-1 rounded text-xs bg-gray-100 text-gray-700">#${tag}</span>`).join(' ')
        : '<span class="text-gray-400 text-sm">无标签</span>';

      // 根据题型生成内容
      let questionContent = '';

      if (q.type === 'cloze') {
        // 完形填空（特殊处理）
        questionContent = renderClozeQuestion(q);
      } else if (q.isComposite && q.type !== 'cloze') {
        // 复合题型（排除完形填空）
        questionContent = renderCompositeQuestion(q);
      } else if (q.type === 'single' || q.type === 'multiple') {
        // 选择题
        questionContent = renderChoiceQuestion(q);
      } else if (q.type === 'judge') {
        // 判断题
        questionContent = renderJudgeQuestion(q);
      } else if (q.type === 'blank' || q.type === 'cloze') {
        // 填空题、完形填空
        questionContent = renderBlankQuestion(q);
      } else if (q.type === 'shortAnswer' || q.type === 'essay' || q.type === 'calculation') {
        // 简答题、论述题、计算题等主观题
        questionContent = renderShortQuestion(q);
      } else {
        // 其他题型（名词解释、汉译英等）
        questionContent = renderShortQuestion(q);
      }

      content.innerHTML = `
        <div class="space-y-6">
          <!-- 基本信息 -->
          <div class="flex items-center gap-3 flex-wrap">
            ${typeTag}
            ${difficultyTag}
            ${q.isComposite ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">
              <i class="fas fa-list-ol mr-1"></i>${q.subCount} 道子题
            </span>` : ''}
          </div>

          ${questionContent}

          <!-- 附加信息 -->
          <div class="pt-6 border-t border-gray-200 space-y-3">
            <div class="flex items-start">
              <span class="text-sm font-medium text-gray-500 w-20 flex-shrink-0">知识点：</span>
              <span class="text-sm text-gray-900">${q.knowledgePath}</span>
            </div>
            <div class="flex items-start">
              <span class="text-sm font-medium text-gray-500 w-20 flex-shrink-0">标签：</span>
              <div class="flex items-center gap-2 flex-wrap">${tagsHtml}</div>
            </div>
            <div class="flex items-center">
              <span class="text-sm font-medium text-gray-500 w-20 flex-shrink-0">默认分值：</span>
              <span class="text-sm text-gray-900">${q.score ? q.score + ' 分' : '--'}</span>
            </div>
            <div class="flex items-center">
              <span class="text-sm font-medium text-gray-500 w-20 flex-shrink-0">创建时间：</span>
              <span class="text-sm text-gray-600">${q.createTime}</span>
            </div>
            <div class="flex items-center">
              <span class="text-sm font-medium text-gray-500 w-20 flex-shrink-0">创建者：</span>
              <span class="text-sm text-gray-600">${q.author}</span>
            </div>
            <div class="flex items-center">
              <span class="text-sm font-medium text-gray-500 w-20 flex-shrink-0">使用次数：</span>
              <span class="text-sm text-gray-600">组卷 ${q.useCount} 次</span>
            </div>
          </div>
        </div>
      `;
    }

    // 渲染选择题
    function renderChoiceQuestion(q) {
      const optionsHtml = q.options.map(opt => {
        const isCorrect = q.correctAnswers.includes(opt.label);
        return `
          <div class="flex items-start py-2">
            <span class="option-label ${isCorrect ? 'correct' : ''}">${opt.label}</span>
            <span class="text-gray-900">${opt.text}</span>
          </div>
        `;
      }).join('');

      return `
        <div class="space-y-4">
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">题干</div>
            <div class="question-content text-gray-900 text-base leading-relaxed">${q.content}</div>
          </div>
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">选项</div>
            <div class="space-y-1">${optionsHtml}</div>
          </div>
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">正确答案</div>
            <div class="inline-flex items-center px-3 py-1.5 bg-green-50 text-green-700 rounded-lg font-medium">
              ${q.correctAnswers.join('、')}
            </div>
          </div>
          ${q.explanation ? `
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">答案解析</div>
            <div class="question-content text-gray-700 text-sm leading-relaxed bg-blue-50 p-4 rounded-lg">${q.explanation}</div>
          </div>
          ` : ''}
        </div>
      `;
    }

    // 渲染判断题
    function renderJudgeQuestion(q) {
      return `
        <div class="space-y-4">
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">题干</div>
            <div class="question-content text-gray-900 text-base leading-relaxed">${q.content}</div>
          </div>
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">正确答案</div>
            <div class="inline-flex items-center px-3 py-1.5 bg-green-50 text-green-700 rounded-lg font-medium">
              ${q.correctAnswer ? '正确' : '错误'}
            </div>
          </div>
          ${q.explanation ? `
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">答案解析</div>
            <div class="question-content text-gray-700 text-sm leading-relaxed bg-blue-50 p-4 rounded-lg">${q.explanation}</div>
          </div>
          ` : ''}
        </div>
      `;
    }

    // 渲染填空题
    function renderBlankQuestion(q) {
      if (!q.blanks || q.blanks.length === 0) {
        return `
          <div class="space-y-4">
            <div>
              <div class="text-sm font-medium text-gray-500 mb-2">题干</div>
              <div class="question-content text-gray-900 text-base leading-relaxed">${q.content}</div>
            </div>
            <div>
              <div class="text-sm font-medium text-gray-500 mb-2">参考答案</div>
              <div class="text-sm text-gray-400">暂无填空答案</div>
            </div>
            ${q.explanation ? `
            <div>
              <div class="text-sm font-medium text-gray-500 mb-2">答案解析</div>
              <div class="question-content text-gray-700 text-sm leading-relaxed bg-blue-50 p-4 rounded-lg">${q.explanation}</div>
            </div>
            ` : ''}
          </div>
        `;
      }

      const blanksHtml = q.blanks.map((blank, index) => `
        <div class="flex items-center py-2">
          <span class="text-sm font-medium text-gray-500 w-20">空 ${blank.index}：</span>
          <span class="inline-flex items-center px-3 py-1.5 bg-green-50 text-green-700 rounded-lg font-medium">${blank.answer}</span>
          <span class="text-sm text-gray-500 ml-3">(${blank.score ? blank.score + ' 分' : '--'})</span>
        </div>
      `).join('');

      return `
        <div class="space-y-4">
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">题干</div>
            <div class="question-content text-gray-900 text-base leading-relaxed">${q.content}</div>
          </div>
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">参考答案</div>
            <div class="space-y-1">${blanksHtml}</div>
          </div>
          ${q.explanation ? `
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">答案解析</div>
            <div class="question-content text-gray-700 text-sm leading-relaxed bg-blue-50 p-4 rounded-lg">${q.explanation}</div>
          </div>
          ` : ''}
        </div>
      `;
    }

    // 渲染简答题
    function renderShortQuestion(q) {
      return `
        <div class="space-y-4">
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">题干</div>
            <div class="question-content text-gray-900 text-base leading-relaxed">${q.content}</div>
          </div>
          ${q.referenceAnswer ? `
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">参考答案</div>
            <div class="question-content text-gray-700 text-sm leading-relaxed bg-green-50 p-4 rounded-lg whitespace-pre-line">${q.referenceAnswer}</div>
          </div>
          ` : ''}
          ${q.explanation ? `
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">答案解析</div>
            <div class="question-content text-gray-700 text-sm leading-relaxed bg-blue-50 p-4 rounded-lg">${q.explanation}</div>
          </div>
          ` : ''}
        </div>
      `;
    }

    // 渲染完形填空
    function renderClozeQuestion(q) {
      // 检查是否有完形填空子题
      if (!q.clozeSubQuestions || !Array.isArray(q.clozeSubQuestions) || q.clozeSubQuestions.length === 0) {
        // 兼容旧格式：使用 blanks 字段
        return renderBlankQuestion(q);
      }

      const subQuestionsHtml = q.clozeSubQuestions.map((subQ, index) => {
        if (!subQ.options || subQ.options.length === 0) {
          return `
            <div class="border-l-2 border-gray-300 pl-4 py-2">
              <div class="text-sm font-medium text-gray-700 mb-1">${subQ.index}）选项数据缺失</div>
            </div>
          `;
        }

        const optionsHtml = subQ.options.map(opt => {
          const isCorrect = opt.label === subQ.correctAnswer;
          return `
            <div class="flex items-start py-2">
              <span class="option-label ${isCorrect ? 'correct' : ''}">${opt.label}</span>
              <span class="text-gray-900">${opt.text}</span>
            </div>
          `;
        }).join('');

        return `
          <div class="border-l-2 border-indigo-300 pl-4 py-3 mb-3">
            <div class="text-sm font-medium text-gray-700 mb-2">${subQ.index}）</div>
            <div class="space-y-1">${optionsHtml}</div>
          </div>
        `;
      }).join('');

      return `
        <div class="space-y-4">
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">题干</div>
            <div class="question-content text-gray-900 text-base leading-relaxed">${q.content}</div>
          </div>
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">选项与答案（共 ${q.clozeSubQuestions.length} 个空）</div>
            <div>${subQuestionsHtml}</div>
          </div>
          ${q.explanation ? `
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">答案解析</div>
            <div class="question-content text-gray-700 text-sm leading-relaxed bg-blue-50 p-4 rounded-lg">${q.explanation}</div>
          </div>
          ` : ''}
        </div>
      `;
    }

    // 渲染复合题
    function renderCompositeQuestion(q) {
      // 检查 subQuestions 是否存在
      if (!q.subQuestions || !Array.isArray(q.subQuestions) || q.subQuestions.length === 0) {
        console.error('复合题缺少 subQuestions 字段:', q);
        return `
          <div class="text-center text-error-500 py-8">
            <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
            <p>题目数据异常：缺少子题目信息</p>
          </div>
        `;
      }

      const subQuestionsHtml = q.subQuestions.map((sub, index) => {
        let subContent = '';

        // 检查子题数据完整性
        if (!sub || !sub.content) {
          return `
            <div class="border-l-2 border-error-300 pl-4 py-2">
              <div class="text-sm text-error-600">第 ${index + 1} 题数据异常</div>
            </div>
          `;
        }

        if (sub.type === 'single' || sub.type === 'multiple') {
          // 选择题子题
          if (!sub.options || !Array.isArray(sub.options)) {
            subContent = `<div class="text-xs text-error-600 mt-2">选项数据异常</div>`;
          } else {
            const optionsHtml = sub.options.map(opt => {
              const isCorrect = sub.correctAnswers && sub.correctAnswers.includes(opt.label);
              return `
                <div class="flex items-start py-1">
                  <span class="option-label ${isCorrect ? 'correct' : ''}">${opt.label}</span>
                  <span class="text-gray-800 text-sm">${opt.text}</span>
                </div>
              `;
            }).join('');
            subContent = `
              <div class="mt-2 space-y-2">
                ${optionsHtml}
                <div class="mt-2">
                  <span class="text-xs font-medium text-gray-500">答案：</span>
                  <span class="inline-flex items-center px-2 py-0.5 bg-green-50 text-green-700 rounded text-xs font-medium">
                    ${sub.correctAnswers ? sub.correctAnswers.join('、') : '无'}
                  </span>
                  <span class="text-xs text-gray-500 ml-2">(${sub.score ? sub.score + ' 分' : '--'})</span>
                </div>
              </div>
            `;
          }
        } else if (sub.type === 'judge') {
          // 判断题子题
          const answerText = sub.correctAnswer === 'true' ? '正确' : '错误';
          subContent = `
            <div class="mt-2">
              <div class="text-xs font-medium text-gray-500 mb-1">答案：</div>
              <div class="inline-flex items-center px-2 py-1 bg-green-50 text-green-700 rounded text-sm font-medium">${answerText}</div>
              <span class="text-xs text-gray-500 ml-2">(${sub.score ? sub.score + ' 分' : '--'})</span>
            </div>
          `;
        } else if (sub.type === 'blank') {
          // 填空题子题
          if (sub.blanks && Array.isArray(sub.blanks)) {
            const blanksHtml = sub.blanks.map(blank => `
              <div class="inline-flex items-center px-2 py-1 bg-green-50 text-green-700 rounded text-sm mr-2">
                空${blank.index}: ${blank.answer}
              </div>
            `).join('');
            subContent = `
              <div class="mt-2">
                <div class="text-xs font-medium text-gray-500 mb-1">答案：</div>
                ${blanksHtml}
                <span class="text-xs text-gray-500 ml-2">(${sub.score ? sub.score + ' 分' : '--'})</span>
              </div>
            `;
          } else {
            subContent = `
              <div class="mt-2">
                <div class="text-xs font-medium text-gray-500 mb-1">参考答案：</div>
                <div class="text-sm text-gray-700 bg-green-50 p-2 rounded">${sub.answer || '无'}</div>
                <span class="text-xs text-gray-500 mt-1 inline-block">(${sub.score ? sub.score + ' 分' : '--'})</span>
              </div>
            `;
          }
        } else {
          // 其他题型（简答等）
          subContent = `
            <div class="mt-2">
              <div class="text-xs font-medium text-gray-500 mb-1">参考答案：</div>
              <div class="text-sm text-gray-700 bg-green-50 p-2 rounded">${sub.answer || sub.referenceAnswer || '无'}</div>
              <span class="text-xs text-gray-500 mt-1 inline-block">(${sub.score ? sub.score + ' 分' : '--'})</span>
            </div>
          `;
        }

        return `
          <div class="border-l-2 border-gray-300 pl-4 py-2">
            <div class="text-sm font-medium text-gray-700 mb-1">
              ${index + 1}）${sub.content}
            </div>
            ${subContent}
          </div>
        `;
      }).join('');

      return `
        <div class="space-y-4">
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">材料</div>
            <div class="question-content text-gray-900 text-base leading-relaxed bg-amber-50 p-4 rounded-lg">${q.content}</div>
          </div>
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">子题目 (共 ${q.subCount || q.subQuestions.length} 道)</div>
            <div class="space-y-3">${subQuestionsHtml}</div>
          </div>
          ${q.explanation ? `
          <div>
            <div class="text-sm font-medium text-gray-500 mb-2">答案解析</div>
            <div class="question-content text-gray-700 text-sm leading-relaxed bg-blue-50 p-4 rounded-lg">${q.explanation}</div>
          </div>
          ` : ''}
        </div>
      `;
    }

    // 编辑当前预览的题目
    function editCurrentQuestion() {
      if (currentPreviewQuestion) {
        const questionId = currentPreviewQuestion.id; // 先保存ID
        closePreview();
        editQuestion(questionId);
      }
    }

    // 删除当前预览的题目
    function deleteCurrentQuestion() {
      if (currentPreviewQuestion) {
        const questionId = currentPreviewQuestion.id; // 先保存ID
        const questionTitle = currentPreviewQuestion.content.replace(/<[^>]*>/g, '').substring(0, 30);
        closePreview();
        deleteQuestion(questionId, questionTitle);
      }
    }

    // 编辑题目
    function editQuestion(questionId) {
      window.location.href = `add.html?id=${questionId}`;
    }

    // 删除题目
    function deleteQuestion(questionId, questionTitle) {
      if (confirm(`确定要删除这道题目吗？\n\n题目编号：${questionId}\n题目内容：${questionTitle}\n\n删除后不可恢复！`)) {
        // 从 allQuestions 数组中删除
        const index = allQuestions.findIndex(q => q.id === questionId);
        if (index > -1) {
          allQuestions.splice(index, 1);
        }

        // 保存到 localStorage
        localStorage.setItem('allQuestions', JSON.stringify(allQuestions));

        // 从 filteredQuestions 数组中删除
        const filteredIndex = filteredQuestions.findIndex(q => q.id === questionId);
        if (filteredIndex > -1) {
          filteredQuestions.splice(filteredIndex, 1);
        }

        // 刷新页面显示
        updateKnowledgeTreeCounts();
        renderQuestions();

        // 显示成功提示
        Message.success(`题目 ${questionId} 已成功删除！`);
      }
    }

    // ==================== AI出题功能 ====================

    // AI出题状态
    let aiGenerateState = {
      currentTab: 'material',
      selectedFile: null,
      selectedKnowledge: null,
      isGenerating: false,
      generatedQuestions: []
    };

    // 打开AI出题模态框
    function openAIGenerateModal() {
      document.getElementById('aiGenerateOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
      // 初始化知识点下拉
      renderAIKnowledgeTree();
      // 绑定材料输入字数统计
      const materialInput = document.getElementById('aiMaterialInput');
      materialInput.addEventListener('input', updateMaterialCharCount);
      // 初始化文件拖拽
      initFileUploadZone();
    }

    // 关闭AI出题模态框
    function closeAIGenerateModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('aiGenerateOverlay').classList.remove('active');
      document.body.style.overflow = '';
      // 重置状态
      resetAIGenerateState();
    }

    // 重置AI出题状态
    function resetAIGenerateState() {
      aiGenerateState = {
        currentTab: 'material',
        selectedFile: null,
        selectedKnowledge: null,
        isGenerating: false,
        generatedQuestions: []
      };
      // 重置表单
      document.getElementById('aiMaterialInput').value = '';
      document.getElementById('materialCharCount').textContent = '0';
      document.querySelectorAll('.ai-number-input').forEach(input => input.value = '');
      document.getElementById('aiResultArea').innerHTML = '<div class="flex items-center justify-center h-full text-gray-400"><span>AI出题结果将在此显示</span></div>';
      document.getElementById('aiResultSummary').textContent = '';
      document.getElementById('aiResultActions').classList.add('hidden');
      clearSelectedFile();
    }

    // 切换Tab
    function switchAITab(tab) {
      aiGenerateState.currentTab = tab;
      // 更新Tab按钮状态
      document.querySelectorAll('.ai-tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      // 显示对应内容
      document.querySelectorAll('.ai-tab-panel').forEach(panel => {
        panel.classList.add('hidden');
      });
      document.getElementById(tab + 'Tab').classList.remove('hidden');
    }

    // 更新材料字数统计
    function updateMaterialCharCount() {
      const input = document.getElementById('aiMaterialInput');
      const count = input.value.length;
      document.getElementById('materialCharCount').textContent = count;
      if (count > 6000) {
        input.value = input.value.substring(0, 6000);
        document.getElementById('materialCharCount').textContent = '6000';
      }
    }

    // 初始化文件上传区域
    function initFileUploadZone() {
      const zone = document.getElementById('fileUploadZone');
      if (!zone) return;

      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
      });

      zone.addEventListener('dragleave', () => {
        zone.classList.remove('dragover');
      });

      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileUpload(files[0]);
        }
      });

      zone.addEventListener('click', () => {
        document.getElementById('fileInput').click();
      });
    }

    // 处理文件选择
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        handleFileUpload(file);
      }
    }

    // 处理文件上传
    function handleFileUpload(file) {
      const allowedTypes = ['.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx'];
      const ext = '.' + file.name.split('.').pop().toLowerCase();

      if (!allowedTypes.includes(ext)) {
        Message.warning('不支持的文件格式，请上传 doc、docx、xls、xlsx、ppt、pptx 格式的文件');
        return;
      }

      if (file.size > 40 * 1024 * 1024) {
        Message.warning('文件大小不能超过40MB');
        return;
      }

      aiGenerateState.selectedFile = file;
      document.getElementById('selectedFileName').textContent = file.name;
      document.getElementById('selectedFileInfo').classList.remove('hidden');
      document.getElementById('fileUploadZone').classList.add('hidden');
    }

    // 清除选中的文件
    function clearSelectedFile() {
      aiGenerateState.selectedFile = null;
      document.getElementById('selectedFileInfo').classList.add('hidden');
      document.getElementById('fileUploadZone').classList.remove('hidden');
      document.getElementById('fileInput').value = '';
    }

    // 渲染AI出题知识点树
    function renderAIKnowledgeTree() {
      const container = document.getElementById('aiKnowledgeTreeContainer');
      if (!container) return;

      const renderNode = (node, level = 0) => {
        const paddingLeft = level * 16;
        let html = `
          <div class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer transition-colors"
               style="padding-left: ${paddingLeft}px"
               onclick="selectAIKnowledge('${node.id}', '${node.name}')">
            <span class="text-sm text-gray-700">${node.name}</span>
          </div>
        `;
        if (node.children && node.children.length > 0) {
          node.children.forEach(child => {
            html += renderNode(child, level + 1);
          });
        }
        return html;
      };

      let html = `
        <div class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer transition-colors"
             onclick="selectAIKnowledge('', '请选择知识点（可选）')">
          <span class="text-sm text-gray-500">不限知识点</span>
        </div>
      `;
      knowledgeTree.forEach(node => {
        html += renderNode(node);
      });
      container.innerHTML = html;
    }

    // 切换知识点下拉
    function toggleAIKnowledgeDropdown() {
      const dropdown = document.getElementById('aiKnowledgeDropdown');
      dropdown.classList.toggle('hidden');
    }

    // 选择知识点
    function selectAIKnowledge(id, name) {
      aiGenerateState.selectedKnowledge = id ? { id, name } : null;
      document.getElementById('aiKnowledgeLabel').textContent = name;
      document.getElementById('aiKnowledgeLabel').className = id ? 'text-gray-700' : 'text-gray-500';
      document.getElementById('aiKnowledgeDropdown').classList.add('hidden');
    }

    // 点击外部关闭知识点下拉
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('aiKnowledgeDropdown');
      const btn = document.getElementById('aiKnowledgeDropdownBtn');
      if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
    });

    // 开始AI出题
    function startAIGenerate() {
      // 验证输入
      const tab = aiGenerateState.currentTab;
      if (tab === 'material') {
        const material = document.getElementById('aiMaterialInput').value.trim();
        if (!material) {
          Message.warning('请输入学习材料内容');
          return;
        }
      } else if (tab === 'file') {
        if (!aiGenerateState.selectedFile) {
          Message.warning('请上传文件');
          return;
        }
      } else if (tab === 'video') {
        const course = document.getElementById('videoCourseSelect').value;
        if (!course) {
          Message.warning('请选择课程');
          return;
        }
      }

      // 获取题型数量
      const counts = {
        single: parseInt(document.getElementById('aiSingleCount').value) || 0,
        multiple: parseInt(document.getElementById('aiMultipleCount').value) || 0,
        judge: parseInt(document.getElementById('aiJudgeCount').value) || 0,
        blank: parseInt(document.getElementById('aiBlankCount').value) || 0,
        shortAnswer: parseInt(document.getElementById('aiShortAnswerCount').value) || 0,
        composite: parseInt(document.getElementById('aiCompositeCount').value) || 0
      };

      const totalCount = Object.values(counts).reduce((a, b) => a + b, 0);
      if (totalCount === 0) {
        Message.warning('请至少设置一种题型的数量');
        return;
      }
      if (totalCount > 50) {
        Message.warning('每次最多出50道题');
        return;
      }

      // 显示加载状态
      showAILoading();

      // 模拟AI出题（延迟2-4秒）
      const delay = 2000 + Math.random() * 2000;
      setTimeout(() => {
        generateMockQuestions(counts);
      }, delay);
    }

    // 显示加载状态
    function showAILoading() {
      aiGenerateState.isGenerating = true;
      document.getElementById('aiGenerateSubmitBtn').disabled = true;
      document.getElementById('aiResultArea').innerHTML = `
        <div class="ai-loading">
          <div class="ai-loading-spinner"></div>
          <div class="ai-loading-text">
            <span>AI正在分析材料并生成题目</span>
            <span class="ai-loading-dots"></span>
          </div>
        </div>
      `;
    }

    // 生成模拟题目
    function generateMockQuestions(counts) {
      const questions = [];
      let questionIndex = 1;

      // 获取材料内容（用于生成相关题目）
      const material = document.getElementById('aiMaterialInput').value.trim() || '建筑工程基础知识';

      // 单选题
      for (let i = 0; i < counts.single; i++) {
        questions.push({
          type: '单选题',
          content: `${questionIndex}.根据材料内容，以下关于建筑结构的说法正确的是？`,
          options: ['A. 基础是建筑物最下部的承重构件', 'B. 墙体只起围护作用', 'C. 屋顶不需要防水处理', 'D. 楼梯不属于建筑基本组成'],
          answer: 'A'
        });
        questionIndex++;
      }

      // 多选题
      for (let i = 0; i < counts.multiple; i++) {
        questions.push({
          type: '多选题',
          content: `${questionIndex}.以下哪些属于建筑的附属构件？`,
          options: ['A. 阳台', 'B. 墙', 'C. 雨篷', 'D. 散水'],
          answer: 'ACD'
        });
        questionIndex++;
      }

      // 判断题
      for (let i = 0; i < counts.judge; i++) {
        questions.push({
          type: '判断题',
          content: `${questionIndex}.建筑物的基础是将荷载传递给地基的"根基"。`,
          answer: '正确'
        });
        questionIndex++;
      }

      // 填空题
      for (let i = 0; i < counts.blank; i++) {
        questions.push({
          type: '填空题',
          content: `${questionIndex}.建筑由基础、墙或柱、楼地层、楼梯、____、门窗六大基本部分组成。`,
          answer: '屋顶'
        });
        questionIndex++;
      }

      // 简答题
      for (let i = 0; i < counts.shortAnswer; i++) {
        questions.push({
          type: '简答题',
          content: `${questionIndex}.请简述建筑基础的作用和重要性。`,
          answer: '建筑基础是建筑物最下部的承重构件，其主要作用是将建筑物的全部荷载传递给地基。基础的重要性体现在：1）承担建筑物全部重量；2）保证建筑物的稳定性；3）防止地基不均匀沉降；4）是建筑物安全的根本保障。'
        });
        questionIndex++;
      }

      // 复合题
      for (let i = 0; i < counts.composite; i++) {
        questions.push({
          type: '复合题',
          content: `【复合题】\n阅读以下材料，回答问题：\n\n某建筑工程项目在施工过程中，发现地基土质较软，需要进行地基处理。项目部决定采用换填法进行处理，将软弱土层挖除，换填砂石等材料。\n\n(1) 换填法适用于哪些情况？\n(2) 换填材料的选择应考虑哪些因素？`,
          answer: '(1) 换填法适用于：浅层软弱地基、局部软弱土层、不均匀地基等情况。\n(2) 换填材料选择应考虑：材料的强度、压缩性、透水性、来源便利性、经济性等因素。'
        });
        questionIndex++;
      }

      aiGenerateState.generatedQuestions = questions;
      aiGenerateState.isGenerating = false;
      document.getElementById('aiGenerateSubmitBtn').disabled = false;

      // 显示结果
      displayAIResults(questions, counts);
    }

    // 显示AI出题结果
    function displayAIResults(questions, counts) {
      // 更新结果摘要
      const summaryParts = [];
      if (counts.single > 0) summaryParts.push(`单选题 <span class="text-blue-500 font-medium">${counts.single}</span> 道`);
      if (counts.multiple > 0) summaryParts.push(`多选题 <span class="text-blue-500 font-medium">${counts.multiple}</span> 道`);
      if (counts.judge > 0) summaryParts.push(`判断题 <span class="text-blue-500 font-medium">${counts.judge}</span> 道`);
      if (counts.blank > 0) summaryParts.push(`填空题 <span class="text-blue-500 font-medium">${counts.blank}</span> 道`);
      if (counts.shortAnswer > 0) summaryParts.push(`简答题 <span class="text-blue-500 font-medium">${counts.shortAnswer}</span> 道`);
      if (counts.composite > 0) summaryParts.push(`复合题 <span class="text-blue-500 font-medium">${counts.composite}</span> 道`);
      document.getElementById('aiResultSummary').innerHTML = summaryParts.join('，');

      // 显示操作按钮
      document.getElementById('aiResultActions').classList.remove('hidden');

      // 渲染题目列表
      let html = '<div class="space-y-4 text-sm">';

      // 按题型分组显示
      const typeGroups = {};
      questions.forEach(q => {
        if (!typeGroups[q.type]) typeGroups[q.type] = [];
        typeGroups[q.type].push(q);
      });

      for (const [type, qs] of Object.entries(typeGroups)) {
        html += `<div class="font-medium text-gray-700 mt-4 first:mt-0">【${type}】</div>`;
        qs.forEach(q => {
          html += `<div class="bg-white p-3 rounded-lg border border-gray-200">`;
          html += `<div class="text-gray-800 whitespace-pre-wrap">${q.content}</div>`;
          if (q.options) {
            html += `<div class="mt-2 space-y-1">`;
            q.options.forEach(opt => {
              html += `<div class="text-gray-600">${opt}</div>`;
            });
            html += `</div>`;
          }
          html += `<div class="mt-2 text-gray-500">参考答案：${q.answer}</div>`;
          html += `</div>`;
        });
      }

      html += '</div>';
      document.getElementById('aiResultArea').innerHTML = html;
    }

    // 一键复制结果
    function copyAIResult() {
      const questions = aiGenerateState.generatedQuestions;
      if (questions.length === 0) return;

      let text = '';
      questions.forEach(q => {
        text += `【${q.type}】\n`;
        text += `${q.content}\n`;
        if (q.options) {
          q.options.forEach(opt => {
            text += `${opt}\n`;
          });
        }
        text += `参考答案：${q.answer}\n\n`;
      });

      navigator.clipboard.writeText(text).then(() => {
        Message.success('已复制到剪贴板');
      }).catch(() => {
        Message.error('复制失败，请手动复制');
      });
    }

    // 全部录入到简便录入
    function importAllToSimple() {
      const questions = aiGenerateState.generatedQuestions;
      if (questions.length === 0) return;

      // 将题目转换为简便录入格式
      let simpleText = '';
      questions.forEach(q => {
        simpleText += `【${q.type}】\n`;
        simpleText += `${q.content}\n`;
        if (q.options) {
          q.options.forEach(opt => {
            simpleText += `${opt}\n`;
          });
        }
        simpleText += `答案：${q.answer}\n\n`;
      });

      // 保存到 localStorage，供简便录入页面读取
      localStorage.setItem('aiGeneratedQuestions', simpleText);

      // 如果选择了知识点，也保存
      if (aiGenerateState.selectedKnowledge) {
        localStorage.setItem('aiSelectedKnowledge', JSON.stringify(aiGenerateState.selectedKnowledge));
      }

      // 跳转到简便录入页面
      window.location.href = 'add-simple.html?from=ai';
    }

    // ==================== AI出题功能结束 ====================

    // ==================== 批量操作功能 ====================

    // 批量操作状态
    let isBatchMode = false;
    let batchActionType = ''; // 'delete', 'knowledge', 'difficulty', 'tags'
    let selectedQuestions = new Set();

    // 批量操作类型标签映射
    const batchModeLabels = {
      'delete': '批量删除',
      'knowledge': '批量修改知识点',
      'difficulty': '批量修改难度',
      'tags': '批量设置标签'
    };

    // 切换批量操作菜单
    function toggleBatchMenu() {
      const menu = document.getElementById('batchMenu');
      menu.classList.toggle('hidden');
    }

    // 点击其他地方关闭批量菜单
    document.addEventListener('click', function(e) {
      const menu = document.getElementById('batchMenu');
      const btn = document.getElementById('batchMenuBtn');
      if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
        menu.classList.add('hidden');
      }
    });

    // 开始批量操作模式
    function startBatchMode(actionType) {
      isBatchMode = true;
      batchActionType = actionType;
      selectedQuestions.clear();

      // 隐藏批量菜单
      document.getElementById('batchMenu').classList.add('hidden');

      // 显示批量工具栏
      document.getElementById('batchToolbar').classList.remove('hidden');
      document.getElementById('batchModeLabel').textContent = batchModeLabels[actionType];

      // 更新选中计数
      updateSelectedCount();

      // 重新渲染题目列表（显示勾选框）
      renderQuestions();
    }

    // 取消批量操作模式
    function cancelBatchMode() {
      isBatchMode = false;
      batchActionType = '';
      selectedQuestions.clear();

      // 隐藏批量工具栏
      document.getElementById('batchToolbar').classList.add('hidden');

      // 重置全选复选框
      document.getElementById('selectAllCheckbox').checked = false;

      // 重新渲染题目列表（隐藏勾选框）
      renderQuestions();
    }

    // 切换单个题目选择
    function toggleQuestionSelection(questionId) {
      if (selectedQuestions.has(questionId)) {
        selectedQuestions.delete(questionId);
      } else {
        selectedQuestions.add(questionId);
      }

      // 更新卡片样式
      const card = document.querySelector(`[data-question-id="${questionId}"]`);
      if (card) {
        const checkbox = card.querySelector('.batch-question-checkbox');
        if (checkbox) {
          checkbox.checked = selectedQuestions.has(questionId);
        }
        if (selectedQuestions.has(questionId)) {
          card.classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-50');
        } else {
          card.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50');
        }
      }

      updateSelectedCount();
      updateSelectAllCheckbox();
    }

    // 全选/取消全选当前页
    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      const isChecked = selectAllCheckbox.checked;

      // 获取当前页的题目ID
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, filteredQuestions.length);
      const currentPageQuestions = filteredQuestions.slice(startIndex, endIndex);

      currentPageQuestions.forEach(q => {
        if (isChecked) {
          selectedQuestions.add(q.id);
        } else {
          selectedQuestions.delete(q.id);
        }
      });

      // 更新所有卡片的勾选状态和样式
      document.querySelectorAll('.apple-card[data-question-id]').forEach(card => {
        const qId = card.getAttribute('data-question-id');
        const checkbox = card.querySelector('.batch-question-checkbox');
        if (checkbox) {
          checkbox.checked = selectedQuestions.has(qId);
        }
        if (selectedQuestions.has(qId)) {
          card.classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-50');
        } else {
          card.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50');
        }
      });

      updateSelectedCount();
    }

    // 更新全选复选框状态
    function updateSelectAllCheckbox() {
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, filteredQuestions.length);
      const currentPageQuestions = filteredQuestions.slice(startIndex, endIndex);

      const allSelected = currentPageQuestions.length > 0 &&
        currentPageQuestions.every(q => selectedQuestions.has(q.id));

      document.getElementById('selectAllCheckbox').checked = allSelected;
    }

    // 更新选中计数
    function updateSelectedCount() {
      document.getElementById('selectedCount').textContent = selectedQuestions.size;
      document.getElementById('executeBatchBtn').disabled = selectedQuestions.size === 0;
    }

    // 执行批量操作
    function executeBatchAction() {
      if (selectedQuestions.size === 0) {
        Message.warning('请先选择要操作的题目');
        return;
      }

      switch (batchActionType) {
        case 'delete':
          openBatchDeleteModal();
          break;
        case 'knowledge':
          openBatchKnowledgeModal();
          break;
        case 'difficulty':
          openBatchDifficultyModal();
          break;
        case 'tags':
          openBatchTagsModal();
          break;
      }
    }

    // ==================== 批量删除 ====================

    function openBatchDeleteModal() {
      document.getElementById('batchDeleteCount').textContent = selectedQuestions.size;
      document.getElementById('batchDeleteModal').classList.remove('hidden');
    }

    function closeBatchDeleteModal() {
      document.getElementById('batchDeleteModal').classList.add('hidden');
    }

    function confirmBatchDelete() {
      // 保存选中数量（在清空前）
      const count = selectedQuestions.size;

      // 从 allQuestions 中删除选中的题目
      allQuestions = allQuestions.filter(q => !selectedQuestions.has(q.id));

      // 保存到 localStorage
      localStorage.setItem('allQuestions', JSON.stringify(allQuestions));

      // 更新 filteredQuestions
      filteredQuestions = filteredQuestions.filter(q => !selectedQuestions.has(q.id));

      // 关闭弹窗
      closeBatchDeleteModal();

      // 退出批量模式
      cancelBatchMode();

      // 更新知识点树计数
      updateKnowledgeTreeCounts();
      renderKnowledgeTree();

      // 重新渲染
      renderQuestions();

      Message.success(`成功删除 ${count} 道题目`);
    }

    // ==================== 批量修改知识点 ====================

    function openBatchKnowledgeModal() {
      document.getElementById('batchKnowledgeCount').textContent = selectedQuestions.size;

      // 填充知识点选择下拉框
      const select = document.getElementById('batchKnowledgeSelect');
      select.innerHTML = '<option value="">请选择知识点</option>';

      function addKnowledgeOptions(nodes, prefix = '') {
        nodes.forEach(node => {
          if (node.type === 'knowledge') {
            const option = document.createElement('option');
            option.value = node.id;
            option.textContent = prefix + node.name;
            select.appendChild(option);
          }
          if (node.children && node.children.length > 0) {
            addKnowledgeOptions(node.children, prefix + node.name + ' / ');
          }
        });
      }

      addKnowledgeOptions(knowledgeTree);

      document.getElementById('batchKnowledgeModal').classList.remove('hidden');
    }

    function closeBatchKnowledgeModal() {
      document.getElementById('batchKnowledgeModal').classList.add('hidden');
    }

    function confirmBatchKnowledge() {
      const select = document.getElementById('batchKnowledgeSelect');
      const knowledgeId = select.value;

      if (!knowledgeId) {
        Message.warning('请选择知识点');
        return;
      }

      // 保存选中数量（在清空前）
      const count = selectedQuestions.size;

      // 获取知识点路径
      const knowledgePath = getKnowledgePath(knowledgeId);

      // 更新选中题目的知识点
      allQuestions.forEach(q => {
        if (selectedQuestions.has(q.id)) {
          q.knowledgeId = knowledgeId;
          q.knowledgeIds = [knowledgeId];
          q.knowledgePath = knowledgePath;
        }
      });

      // 保存到 localStorage
      localStorage.setItem('allQuestions', JSON.stringify(allQuestions));

      // 更新 filteredQuestions
      filteredQuestions.forEach(q => {
        if (selectedQuestions.has(q.id)) {
          q.knowledgeId = knowledgeId;
          q.knowledgeIds = [knowledgeId];
          q.knowledgePath = knowledgePath;
        }
      });

      // 关闭弹窗
      closeBatchKnowledgeModal();

      // 退出批量模式
      cancelBatchMode();

      // 更新知识点树计数
      updateKnowledgeTreeCounts();
      renderKnowledgeTree();

      // 重新渲染
      renderQuestions();

      Message.success(`成功修改 ${count} 道题目的知识点`);
    }

    // 获取知识点路径
    function getKnowledgePath(knowledgeId) {
      function findPath(nodes, targetId, path = []) {
        for (const node of nodes) {
          const currentPath = [...path, node.name];
          if (String(node.id) === String(targetId)) {
            return currentPath.join(' / ');
          }
          if (node.children && node.children.length > 0) {
            const result = findPath(node.children, targetId, currentPath);
            if (result) return result;
          }
        }
        return null;
      }
      return findPath(knowledgeTree, knowledgeId) || '未分类';
    }

    // ==================== 批量修改难度 ====================

    function openBatchDifficultyModal() {
      document.getElementById('batchDifficultyCount').textContent = selectedQuestions.size;
      // 清除之前的选择
      document.querySelectorAll('input[name="batchDifficulty"]').forEach(radio => {
        radio.checked = false;
      });
      document.getElementById('batchDifficultyModal').classList.remove('hidden');
    }

    function closeBatchDifficultyModal() {
      document.getElementById('batchDifficultyModal').classList.add('hidden');
    }

    function confirmBatchDifficulty() {
      const selectedRadio = document.querySelector('input[name="batchDifficulty"]:checked');

      if (!selectedRadio) {
        Message.warning('请选择难度');
        return;
      }

      // 保存选中数量（在清空前）
      const count = selectedQuestions.size;

      const difficulty = parseInt(selectedRadio.value);
      const difficultyNames = { 1: '一级', 2: '二级', 3: '三级', 4: '四级', 5: '五级' };
      const difficultyName = difficultyNames[difficulty];

      // 更新选中题目的难度
      allQuestions.forEach(q => {
        if (selectedQuestions.has(q.id)) {
          q.difficulty = difficulty;
          q.difficultyName = difficultyName;
        }
      });

      // 保存到 localStorage
      localStorage.setItem('allQuestions', JSON.stringify(allQuestions));

      // 更新 filteredQuestions
      filteredQuestions.forEach(q => {
        if (selectedQuestions.has(q.id)) {
          q.difficulty = difficulty;
          q.difficultyName = difficultyName;
        }
      });

      // 关闭弹窗
      closeBatchDifficultyModal();

      // 退出批量模式
      cancelBatchMode();

      // 重新渲染
      renderQuestions();

      Message.success(`成功修改 ${count} 道题目的难度为 ${difficultyName}`);
    }

    // ==================== 批量设置标签 ====================

    function openBatchTagsModal() {
      document.getElementById('batchTagsCount').textContent = selectedQuestions.size;
      document.getElementById('batchTagsInput').value = '';
      document.querySelector('input[name="tagMode"][value="add"]').checked = true;
      document.getElementById('batchTagsModal').classList.remove('hidden');
    }

    function closeBatchTagsModal() {
      document.getElementById('batchTagsModal').classList.add('hidden');
    }

    function confirmBatchTags() {
      const tagsInput = document.getElementById('batchTagsInput').value.trim();
      const tagMode = document.querySelector('input[name="tagMode"]:checked').value;

      if (!tagsInput) {
        Message.warning('请输入标签');
        return;
      }

      // 解析标签（支持中英文逗号分隔）
      const newTags = tagsInput.split(/[,，]/).map(t => t.trim()).filter(t => t);

      // 保存计数（在 cancelBatchMode 清空前）
      const count = selectedQuestions.size;
      const modeText = tagMode === 'replace' ? '替换' : '追加';

      // 更新选中题目的标签
      allQuestions.forEach(q => {
        if (selectedQuestions.has(q.id)) {
          if (tagMode === 'replace') {
            q.tags = newTags;
          } else {
            // 追加模式：合并并去重
            const existingTags = q.tags || [];
            q.tags = [...new Set([...existingTags, ...newTags])];
          }
        }
      });

      // 保存到 localStorage
      localStorage.setItem('allQuestions', JSON.stringify(allQuestions));

      // 更新 filteredQuestions
      filteredQuestions.forEach(q => {
        if (selectedQuestions.has(q.id)) {
          if (tagMode === 'replace') {
            q.tags = newTags;
          } else {
            const existingTags = q.tags || [];
            q.tags = [...new Set([...existingTags, ...newTags])];
          }
        }
      });

      // 关闭弹窗
      closeBatchTagsModal();

      // 退出批量模式
      cancelBatchMode();

      // 重新渲染
      renderQuestions();

      Message.success(`成功为 ${count} 道题目${modeText}标签`);
    }

    // ==================== 批量操作功能结束 ====================

    // 页面加载完成后初始化
    window.addEventListener('DOMContentLoaded', function() {
      // 加载知识点树
      loadKnowledgeTreeFromStorage();

      // 加载题型配置
      loadQuestionTypesFromStorage();

      // 从 localStorage 读取已保存的题目
      let savedQuestions = JSON.parse(localStorage.getItem('allQuestions') || '[]');

      console.log('===== list.html 加载题目 =====');
      console.log('从localStorage读取题目数量:', savedQuestions.length);
      if (savedQuestions.length > 0) {
        const lastQuestion = savedQuestions[savedQuestions.length - 1];
        console.log('最后一个题目:', lastQuestion);
        console.log('  - ID:', lastQuestion.id);
        console.log('  - 题型:', lastQuestion.type, lastQuestion.typeName);
        console.log('  - 作者:', lastQuestion.author);
        console.log('  - knowledgeIds:', lastQuestion.knowledgeIds);
        console.log('  - knowledgePath:', lastQuestion.knowledgePath);
      }
      console.log('==============================');

      // 检查内置题目是否已保存到 localStorage
      // 通过检查是否存在 Q001 来判断
      const hasBuiltInQuestions = savedQuestions.some(q => q.id === 'Q001');

      if (!hasBuiltInQuestions) {
        // 首次加载：将内置题目保存到 localStorage
        // 内置题目放在前面，用户添加的题目放在后面
        const mergedQuestions = [...allQuestions, ...savedQuestions];
        localStorage.setItem('allQuestions', JSON.stringify(mergedQuestions));
        savedQuestions = mergedQuestions;
      }

      // 使用 localStorage 中的数据作为数据源
      allQuestions = savedQuestions;

      // 重新初始化 filteredQuestions
      filteredQuestions = [...allQuestions];

      updateKnowledgeTreeCounts();  // 先更新题目数量
      renderKnowledgeTree();
      renderQuestions();
    });
  </script>

  <!-- AI出题模态框 -->
  <div id="aiGenerateOverlay" class="ai-modal-overlay" onclick="closeAIGenerateModal(event)">
    <div class="ai-modal" onclick="event.stopPropagation()">
      <!-- 模态框头部 -->
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">AI出题</h2>
        <button onclick="closeAIGenerateModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <!-- 模态框内容 -->
      <div class="flex flex-1 overflow-hidden">
        <!-- 左侧：输入区域 -->
        <div class="w-1/2 p-6 border-r border-gray-200 overflow-y-auto custom-scrollbar">
          <!-- Tab 切换 -->
          <div class="flex mb-6">
            <button class="ai-tab-btn active" data-tab="material" onclick="switchAITab('material')">根据材料出题</button>
            <button class="ai-tab-btn" data-tab="file" onclick="switchAITab('file')">上传文件出题</button>
            <button class="ai-tab-btn" data-tab="video" onclick="switchAITab('video')">根据课程视频出题
              <i class="fas fa-question-circle text-gray-400 ml-1" title="选择已上传的课程视频，AI将根据视频内容生成题目"></i>
            </button>
          </div>

          <!-- 数据保护提示 -->
          <div class="flex items-start gap-2 mb-4 text-sm text-gray-500">
            <span class="text-amber-500 mt-0.5">●</span>
            <span>我们会依据相关法律法规保护您的材料数据，重要数据还请谨慎使用，以免数据泄露</span>
          </div>

          <!-- Tab 内容区域 -->
          <div id="aiTabContent">
            <!-- 根据材料出题 -->
            <div id="materialTab" class="ai-tab-panel">
              <textarea id="aiMaterialInput"
                        class="w-full h-48 p-4 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                        placeholder="请输入学习材料内容，AI将根据材料内容生成题目..."></textarea>
              <div class="text-right text-xs text-gray-400 mt-1">
                <span id="materialCharCount">0</span>/6000
              </div>
            </div>

            <!-- 上传文件出题 -->
            <div id="fileTab" class="ai-tab-panel hidden">
              <div id="fileUploadZone" class="file-upload-zone">
                <div class="flex flex-col items-center">
                  <div class="w-20 h-20 mb-4 relative">
                    <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="15" y="20" width="50" height="45" rx="4" fill="#E0EDFF"/>
                      <rect x="20" y="15" width="40" height="40" rx="4" fill="#3B82F6"/>
                      <path d="M40 25V45M30 35L40 25L50 35" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <div class="absolute -right-1 -bottom-1 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                      <i class="fas fa-plus text-blue-500"></i>
                    </div>
                  </div>
                  <p class="text-gray-600 mb-2">
                    支持拖拽 或 粘贴 (Ctrl+V) 文件到此处，或
                    <span class="text-blue-500 cursor-pointer hover:underline" onclick="document.getElementById('fileInput').click()">点击上传</span>
                  </p>
                  <p class="text-xs text-gray-400">支持格式：doc、docx、xls、xlsx、ppt、pptx</p>
                  <p class="text-xs text-gray-400">文件大小不超过40MB，文件内字数不超过5万字</p>
                </div>
                <input type="file" id="fileInput" class="hidden" accept=".doc,.docx,.xls,.xlsx,.ppt,.pptx" onchange="handleFileSelect(event)">
              </div>
              <div id="selectedFileInfo" class="hidden mt-4 p-3 bg-blue-50 rounded-lg flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <i class="fas fa-file-alt text-blue-500"></i>
                  <span id="selectedFileName" class="text-sm text-gray-700"></span>
                </div>
                <button onclick="clearSelectedFile()" class="text-gray-400 hover:text-red-500">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>

            <!-- 根据课程视频出题 -->
            <div id="videoTab" class="ai-tab-panel hidden">
              <div class="flex items-center gap-3 mb-4">
                <label class="text-sm text-gray-600 whitespace-nowrap">课程</label>
                <select id="videoCourseSelect" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">请选择</option>
                  <option value="course1">建筑工程基础 - 第一章</option>
                  <option value="course2">建筑工程基础 - 第二章</option>
                  <option value="course3">结构力学入门</option>
                </select>
              </div>
            </div>
          </div>

          <!-- 知识点选择 -->
          <div class="mt-4 mb-4">
            <div class="flex items-center gap-3">
              <label class="text-sm text-gray-600 whitespace-nowrap">知识点</label>
              <div class="relative flex-1">
                <button type="button" id="aiKnowledgeDropdownBtn" onclick="toggleAIKnowledgeDropdown()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white flex items-center justify-between hover:bg-gray-50 transition-colors">
                  <span id="aiKnowledgeLabel" class="text-gray-500">请选择知识点（可选）</span>
                  <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                </button>
                <div id="aiKnowledgeDropdown" class="hidden absolute z-30 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg max-h-64 overflow-y-auto custom-scrollbar">
                  <div class="p-2" id="aiKnowledgeTreeContainer">
                    <!-- 知识点树将通过JS渲染 -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 题型数量设置 -->
          <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-600 whitespace-nowrap">单选题</label>
              <input type="number" id="aiSingleCount" class="ai-number-input" min="0" max="20" placeholder="数量">
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-600 whitespace-nowrap">多选题</label>
              <input type="number" id="aiMultipleCount" class="ai-number-input" min="0" max="20" placeholder="数量">
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-600 whitespace-nowrap">判断题</label>
              <input type="number" id="aiJudgeCount" class="ai-number-input" min="0" max="20" placeholder="数量">
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-600 whitespace-nowrap">填空题</label>
              <input type="number" id="aiBlankCount" class="ai-number-input" min="0" max="20" placeholder="数量">
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-600 whitespace-nowrap">简答题</label>
              <input type="number" id="aiShortAnswerCount" class="ai-number-input" min="0" max="20" placeholder="数量">
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-600 whitespace-nowrap">复合题</label>
              <input type="number" id="aiCompositeCount" class="ai-number-input" min="0" max="10" placeholder="数量">
            </div>
          </div>

          <!-- 使用须知 -->
          <div class="bg-amber-50 rounded-lg p-3 mb-6">
            <div class="flex items-start gap-2 text-sm">
              <i class="fas fa-exclamation-circle text-amber-500 mt-0.5"></i>
              <div class="text-gray-600">
                <p class="font-medium text-gray-700 mb-1">使用须知：</p>
                <p>1. 每次最多出50道题。</p>
                <p>2. 注意：偶有AI返回的数据不完整是正常情况，受限于AI模型能力，请自行确认AI出题结果是否存在谬误。</p>
              </div>
            </div>
          </div>

          <!-- 开始出题按钮 -->
          <button id="aiGenerateSubmitBtn" onclick="startAIGenerate()" class="ai-generate-submit-btn">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>开始出题</span>
          </button>
        </div>

        <!-- 右侧：结果区域 -->
        <div class="w-1/2 p-6 flex flex-col">
          <!-- 结果头部 -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <span class="text-gray-700 font-medium">AI出题结果：</span>
              <span id="aiResultSummary" class="text-sm text-gray-500"></span>
            </div>
            <div id="aiResultActions" class="hidden flex items-center gap-3">
              <button onclick="importAllToSimple()" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">
                全部录入
              </button>
              <button onclick="copyAIResult()" class="flex items-center gap-1 text-gray-500 hover:text-gray-700 text-sm">
                <i class="far fa-copy"></i>
                <span>一键复制</span>
              </button>
            </div>
          </div>

          <!-- 结果内容区域 -->
          <div id="aiResultArea" class="ai-result-area flex-1 p-4">
            <div class="flex items-center justify-center h-full text-gray-400">
              <span>AI出题结果将在此显示</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
