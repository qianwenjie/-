<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>测试数量提取功能</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-case {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-input {
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    .test-result {
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .success {
      background: #e6f9f0;
      border-left: 4px solid #00B96B;
    }
    .error {
      background: #ffece8;
      border-left: 4px solid #F53F3F;
    }
    pre {
      background: #f9fafb;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    h1 {
      color: #00B96B;
    }
  </style>
</head>
<body>
  <h1>Task 3 - 数量提取功能测试</h1>
  <div id="testResults"></div>

  <script>
    // 复制SmartParamExtractor类
    class SmartParamExtractor {
      constructor() {
        this.synonyms = {
          type: {
            'single': ['单选', '单选题', '选择题', '单项选择', '单选题目'],
            'multiple': ['多选', '多选题', '多项选择', '多选题目'],
            'judge': ['判断', '判断题', '对错题', '是非题'],
            'fill': ['填空', '填空题', '填写题'],
            'essay': ['简答', '简答题', '问答题', '主观题'],
            'all': ['所有', '全部', '所有题型', '全部题型', '混合', '随机题型', '各种题型', '任意题型']
          },
          quantity: {
            '多': ['多点', '多来点', '多一些', '多几道', '多个'],
            '少': ['少点', '少来点', '几道', '少一些', '少个']
          }
        };
        this.patterns = {};
      }

      // 提取题型
      extractType(input) {
        const lowerInput = input.toLowerCase();

        // 遍历所有题型及其同义词
        for (const [typeKey, synonymList] of Object.entries(this.synonyms.type)) {
          for (const synonym of synonymList) {
            if (lowerInput.includes(synonym)) {
              // 获取题型中文名
              const typeNames = {
                'single': '单选题',
                'multiple': '多选题',
                'judge': '判断题',
                'fill': '填空题',
                'essay': '简答题',
                'all': '所有题型'
              };

              return {
                value: typeKey,
                name: typeNames[typeKey],
                confidence: 1.0  // 精确匹配，高置信度
              };
            }
          }
        }

        return null;
      }

      // 提取数量
      extractCount(input) {
        // 1. 精确数字匹配（如"10道"、"5个"、"20题"）
        const exactMatch = input.match(/(\d+)\s*[道个题]/);
        if (exactMatch) {
          return {
            value: parseInt(exactMatch[1]),
            confidence: 1.0  // 精确匹配
          };
        }

        // 2. 纯数字匹配（如"10"、"5"）
        const numberMatch = input.match(/\b(\d+)\b/);
        if (numberMatch) {
          const num = parseInt(numberMatch[1]);
          // 合理范围内的数字（1-100）
          if (num >= 1 && num <= 100) {
            return {
              value: num,
              confidence: 0.8  // 推断，中高置信度
            };
          }
        }

        // 3. 模糊表达（"多点"、"少点"）
        const lowerInput = input.toLowerCase();
        if (this.synonyms.quantity['多'].some(syn => lowerInput.includes(syn))) {
          return {
            value: 15,  // 默认"多"为15道
            confidence: 0.5  // 模糊表达，中置信度
          };
        }
        if (this.synonyms.quantity['少'].some(syn => lowerInput.includes(syn))) {
          return {
            value: 5,  // 默认"少"为5道
            confidence: 0.5
          };
        }

        return null;
      }

      // 主提取方法
      extract(input, context = {}) {
        const params = {};
        const confidence = {};
        const ambiguous = [];

        // 1. 题型识别
        const typeResult = this.extractType(input);
        if (typeResult) {
          params.type = typeResult.value;
          params.typeName = typeResult.name;
          confidence.type = typeResult.confidence;
        }

        // 2. 数量识别
        const countResult = this.extractCount(input);
        if (countResult) {
          params.count = countResult.value;
          confidence.count = countResult.confidence;
        }

        return { params, confidence, ambiguous };
      }
    }

    // 测试用例
    const testCases = [
      {
        input: '生成10道题',
        expected: { count: 10, confidence: 1.0 },
        description: '精确数字匹配 - "10道"'
      },
      {
        input: '来5个单选题',
        expected: { count: 5, confidence: 1.0 },
        description: '精确数字匹配 - "5个"'
      },
      {
        input: '20题判断题',
        expected: { count: 20, confidence: 1.0 },
        description: '精确数字匹配 - "20题"'
      },
      {
        input: '生成单选题 5',
        expected: { count: 5, confidence: 0.8 },
        description: '纯数字推断 - "5"'
      },
      {
        input: '10',
        expected: { count: 10, confidence: 0.8 },
        description: '纯数字推断 - "10"'
      },
      {
        input: '来点多的',
        expected: { count: 15, confidence: 0.5 },
        description: '模糊表达 - "多的"'
      },
      {
        input: '多来点单选题',
        expected: { count: 15, confidence: 0.5 },
        description: '模糊表达 - "多来点"'
      },
      {
        input: '少点就行',
        expected: { count: 5, confidence: 0.5 },
        description: '模糊表达 - "少点"'
      },
      {
        input: '几道题就够了',
        expected: { count: 5, confidence: 0.5 },
        description: '模糊表达 - "几道"'
      },
      {
        input: '生成单选题',
        expected: { count: null },
        description: '无数量信息'
      }
    ];

    // 运行测试
    const extractor = new SmartParamExtractor();
    const resultsContainer = document.getElementById('testResults');

    testCases.forEach((testCase, index) => {
      const result = extractor.extract(testCase.input);
      const actualCount = result.params.count || null;
      const actualConfidence = result.confidence.count || null;

      const passed = actualCount === testCase.expected.count &&
                     (testCase.expected.confidence === undefined ||
                      actualConfidence === testCase.expected.confidence);

      const testDiv = document.createElement('div');
      testDiv.className = 'test-case';
      testDiv.innerHTML = `
        <div class="test-input">测试 ${index + 1}: ${testCase.description}</div>
        <div>输入: "${testCase.input}"</div>
        <div class="test-result ${passed ? 'success' : 'error'}">
          <strong>${passed ? '✅ 通过' : '❌ 失败'}</strong>
          <pre>期望: count=${testCase.expected.count}, confidence=${testCase.expected.confidence || 'N/A'}
实际: count=${actualCount}, confidence=${actualConfidence || 'N/A'}
完整结果: ${JSON.stringify(result, null, 2)}</pre>
        </div>
      `;
      resultsContainer.appendChild(testDiv);
    });

    // 统计结果
    const passedCount = testCases.filter((testCase, index) => {
      const result = extractor.extract(testCase.input);
      const actualCount = result.params.count || null;
      const actualConfidence = result.confidence.count || null;
      return actualCount === testCase.expected.count &&
             (testCase.expected.confidence === undefined ||
              actualConfidence === testCase.expected.confidence);
    }).length;

    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'test-case';
    summaryDiv.innerHTML = `
      <h2>测试总结</h2>
      <div class="test-result ${passedCount === testCases.length ? 'success' : 'error'}">
        <strong>通过率: ${passedCount}/${testCases.length} (${Math.round(passedCount/testCases.length*100)}%)</strong>
      </div>
    `;
    resultsContainer.insertBefore(summaryDiv, resultsContainer.firstChild);
  </script>
</body>
</html>
